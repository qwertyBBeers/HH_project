/*
	jQuery TextAreaResizer plugin
	Created on 17th January 2008 by Ryan O'Dell
	Version 1.0.4
*/(function($){var textarea,staticOffset;var iLastMousePos=0;var iMin=32;var grip;$.fn.TextAreaResizer=function(){return this.each(function(){textarea=$(this).addClass('processed'),staticOffset=null;$(this).wrap('<div class="resizable-textarea"><span></span></div>').parent().append($('<div class="grippie"></div>').bind("mousedown",{el:this},startDrag));var grippie=$('div.grippie',$(this).parent())[0];grippie.style.marginRight=(grippie.offsetWidth-$(this)[0].offsetWidth)+'px'})};function startDrag(e){textarea=$(e.data.el);textarea.blur();iLastMousePos=mousePosition(e).y;staticOffset=textarea.height()-iLastMousePos;textarea.css('opacity',0.25);$(document).mousemove(performDrag).mouseup(endDrag);return false}function performDrag(e){var iThisMousePos=mousePosition(e).y;var iMousePos=staticOffset+iThisMousePos;if(iLastMousePos>=(iThisMousePos)){iMousePos-=5}iLastMousePos=iThisMousePos;iMousePos=Math.max(iMin,iMousePos);textarea.height(iMousePos+'px');if(iMousePos<iMin){endDrag(e)}return false}function endDrag(e){$(document).unbind('mousemove',performDrag).unbind('mouseup',endDrag);textarea.css('opacity',1);textarea.focus();textarea=null;staticOffset=null;iLastMousePos=0}function mousePosition(e){return{x:e.clientX+document.documentElement.scrollLeft,y:e.clientY+document.documentElement.scrollTop}}})(jQuery);
/*
 *	TypeWatch 2.0 - Original by Denny Ferrassoli / Refactored by Charles Christolini
 *  Copyright(c) 2007 Denny Ferrassoli - DennyDotNet.com
 *  Coprright(c) 2008 Charles Christolini - BinaryPie.com
 *  Dual licensed under the MIT and GPL licenses:
 *  http://www.opensource.org/licenses/mit-license.php
 *  http://www.gnu.org/licenses/gpl.html
*/(function(jQuery){jQuery.fn.typeWatch=function(o){var options=jQuery.extend({wait:750,callback:function(){},highlight:true,captureLength:2},o);function checkElement(timer,override){var elTxt=jQuery(timer.el).val();if((elTxt.length>options.captureLength&&elTxt.toUpperCase()!=timer.text)||(override&&elTxt.length>options.captureLength)){timer.text=elTxt.toUpperCase();timer.cb(elTxt)}};function watchElement(elem){if(elem.type.toUpperCase()=="TEXT"||elem.nodeName.toUpperCase()=="TEXTAREA"){var timer={timer:null,text:jQuery(elem).val().toUpperCase(),cb:options.callback,el:elem,wait:options.wait};if(options.highlight){jQuery(elem).focus(function(){this.select()})}var startWatch=function(evt){var timerWait=timer.wait;var overrideBool=false;if(evt.keyCode==13&&this.type.toUpperCase()=="TEXT"){timerWait=1;overrideBool=true}var timerCallbackFx=function(){checkElement(timer,overrideBool)};clearTimeout(timer.timer);timer.timer=setTimeout(timerCallbackFx,timerWait)};jQuery(elem).keydown(startWatch)}};return this.each(function(index){watchElement(this)})}})(jQuery);
/*
Ajax upload
*/jQuery.extend({createUploadIframe:function(d,b){var a="jUploadFrame"+d;if(window.ActiveXObject){var c=document.createElement('<iframe id="'+a+'" name="'+a+'" />');if(typeof b=="boolean"){c.src="javascript:false"}else{if(typeof b=="string"){c.src=b}}}else{var c=document.createElement("iframe");c.id=a;c.name=a}c.style.position="absolute";c.style.top="-1000px";c.style.left="-1000px";document.body.appendChild(c);return c},createUploadForm:function(g,b){var e="jUploadForm"+g;var a="jUploadFile"+g;var d=$('<form  action="" method="POST" name="'+e+'" id="'+e+'" enctype="multipart/form-data"></form>');var c=$("#"+b);var f=$(c).clone();$(c).attr("id",a);$(c).before(f);$(c).appendTo(d);$(d).css("position","absolute");$(d).css("top","-1200px");$(d).css("left","-1200px");$(d).appendTo("body");return d},ajaxFileUpload:function(k){k=jQuery.extend({},jQuery.ajaxSettings,k);var a=new Date().getTime();var b=jQuery.createUploadForm(a,k.fileElementId);var i=jQuery.createUploadIframe(a,k.secureuri);var h="jUploadFrame"+a;var j="jUploadForm"+a;if(k.global&&!jQuery.active++){jQuery.event.trigger("ajaxStart")}var c=false;var f={};if(k.global){jQuery.event.trigger("ajaxSend",[f,k])}var d=function(l){var p=document.getElementById(h);try{if(p.contentWindow){f.responseText=p.contentWindow.document.body?p.contentWindow.document.body.innerText:null;f.responseXML=p.contentWindow.document.XMLDocument?p.contentWindow.document.XMLDocument:p.contentWindow.document}else{if(p.contentDocument){f.responseText=p.contentDocument.document.body?p.contentDocument.document.body.textContent||document.body.innerText:null;f.responseXML=p.contentDocument.document.XMLDocument?p.contentDocument.document.XMLDocument:p.contentDocument.document}}}catch(o){jQuery.handleError(k,f,null,o)}if(f||l=="timeout"){c=true;var m;try{m=l!="timeout"?"success":"error";if(m!="error"){var n=jQuery.uploadHttpData(f,k.dataType);if(k.success){k.success(n,m)}if(k.global){jQuery.event.trigger("ajaxSuccess",[f,k])}}else{jQuery.handleError(k,f,m)}}catch(o){m="error";jQuery.handleError(k,f,m,o)}if(k.global){jQuery.event.trigger("ajaxComplete",[f,k])}if(k.global&&!--jQuery.active){jQuery.event.trigger("ajaxStop")}if(k.complete){k.complete(f,m)}jQuery(p).unbind();setTimeout(function(){try{$(p).remove();$(b).remove()}catch(q){jQuery.handleError(k,f,null,q)}},100);f=null}};if(k.timeout>0){setTimeout(function(){if(!c){d("timeout")}},k.timeout)}try{var b=$("#"+j);$(b).attr("action",k.url);$(b).attr("method","POST");$(b).attr("target",h);if(b.encoding){b.encoding="multipart/form-data"}else{b.enctype="multipart/form-data"}$(b).submit()}catch(g){jQuery.handleError(k,f,null,g)}if(window.attachEvent){document.getElementById(h).attachEvent("onload",d)}else{document.getElementById(h).addEventListener("load",d,false)}return{abort:function(){}}},uploadHttpData:function(r,type){var data=!type;data=type=="xml"||data?r.responseXML:r.responseText;if(type=="script"){jQuery.globalEval(data)}if(type=="json"){eval("data = "+data)}if(type=="html"){jQuery("<div>").html(data).evalScripts()}return data}});
/**
 * Upload call. Used only once in the wmd file upload
 * this is used in the wmd file uploader and the
 * askbots image and attachment upload plugins
 * @todo refactor this code to "new style"
 */
function ajaxFileUpload(options) {

    var spinner = options['spinner'];
    var uploadInputId = options['uploadInputId'];
    var urlInput = $(options['urlInput']);
    var startUploadHandler = options['startUploadHandler'];

    spinner.ajaxStart(function(){
        $(this).show();
    }).ajaxComplete(function(){
        $(this).hide();
    });

    /* important!!! upload input must be loaded by id
     * because ajaxFileUpload monkey-patches the upload form */
    $('#' + uploadInputId).ajaxStart(function(){
        $(this).hide();
    }).ajaxComplete(function(){
        $(this).show();
    });

    //var localFilePath = upload_input.val();
    $.ajaxFileUpload({
        url: askbot['urls']['upload'],
        secureuri: false,
        fileElementId: uploadInputId,
        dataType: 'xml',
        success: function (data, status) {

            var fileURL = $(data).find('file_url').text();
            /*
            * hopefully a fix for the "fakepath" issue
            * https://www.mediawiki.org/wiki/Special:Code/MediaWiki/83225
            */
            fileURL = fileURL.replace(/\w:.*\\(.*)$/,'$1');
            var error = $(data).find('error').text();
            if(error != ''){
                alert(error);
            } else {
                urlInput.attr('value', fileURL);
            }

            /* re-install this as the upload extension
             * will remove the handler to prevent double uploading
             * this hack is a manipulation around the
             * ajaxFileUpload jQuery plugin. */
            $('#' + uploadInputId).unbind('change').change(startUploadHandler);
        },
        error: function (data, status, e) {
            if (startUploadHandler){
                /* re-install this as the upload extension
                * will remove the handler to prevent double uploading */
                $('#' + uploadInputId).unbind('change').change(startUploadHandler);
            }
        }
    });
    return false;
};

/* ===================================================
 * bootstrap-transition.js v2.0.2
 * http://twitter.github.com/bootstrap/javascript.html#transitions
 * ===================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ========================================================== */

!function( $ ) {

  $(function () {

    "use strict"

    /* CSS TRANSITION SUPPORT (https://gist.github.com/373874)
     * ======================================================= */

    $.support.transition = (function () {
      var thisBody = document.body || document.documentElement
        , thisStyle = thisBody.style
        , support = thisStyle.transition !== undefined || thisStyle.WebkitTransition !== undefined || thisStyle.MozTransition !== undefined || thisStyle.MsTransition !== undefined || thisStyle.OTransition !== undefined

      return support && {
        end: (function () {
          var transitionEnd = "TransitionEnd"
          if ( $.browser.webkit ) {
          	transitionEnd = "webkitTransitionEnd"
          } else if ( $.browser.mozilla ) {
          	transitionEnd = "transitionend"
          } else if ( $.browser.opera ) {
          	transitionEnd = "oTransitionEnd"
          }
          return transitionEnd
        }())
      }
    })()

  })

}( window.jQuery );
/* =========================================================
 * bootstrap-modal.js v2.0.2
 * http://twitter.github.com/bootstrap/javascript.html#modals
 * =========================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ========================================================= */


!function( $ ){

  "use strict"

 /* MODAL CLASS DEFINITION
  * ====================== */

  var Modal = function ( content, options ) {
    this.options = options
    this.$element = $(content)
      .delegate('[data-dismiss="modal"]', 'click.dismiss.modal', $.proxy(this.hide, this))
  }

  Modal.prototype = {

      constructor: Modal

    , toggle: function () {
        return this[!this.isShown ? 'show' : 'hide']()
      }

    , show: function () {
        var that = this

        if (this.isShown) return

        $('body').addClass('modal-open')

        this.isShown = true
        this.$element.trigger('show')

        escape.call(this)
        backdrop.call(this, function () {
          var transition = $.support.transition && that.$element.hasClass('fade')

          !that.$element.parent().length && that.$element.appendTo(document.body) //don't move modals dom position

          that.$element
            .show()

          if (transition) {
            that.$element[0].offsetWidth // force reflow
          }

          that.$element.addClass('in')

          transition ?
            that.$element.one($.support.transition.end, function () { that.$element.trigger('shown') }) :
            that.$element.trigger('shown')

        })
      }

    , hide: function ( e ) {
        e && e.preventDefault()

        if (!this.isShown) return

        var that = this
        this.isShown = false

        $('body').removeClass('modal-open')

        escape.call(this)

        this.$element
          .trigger('hide')
          .removeClass('in')

        $.support.transition && this.$element.hasClass('fade') ?
          hideWithTransition.call(this) :
          hideModal.call(this)
      }

  }


 /* MODAL PRIVATE METHODS
  * ===================== */

  function hideWithTransition() {
    var that = this
      , timeout = setTimeout(function () {
          that.$element.off($.support.transition.end)
          hideModal.call(that)
        }, 500)

    this.$element.one($.support.transition.end, function () {
      clearTimeout(timeout)
      hideModal.call(that)
    })
  }

  function hideModal( that ) {
    this.$element
      .hide()
      .trigger('hidden')

    backdrop.call(this)
  }

  function backdrop( callback ) {
    var that = this
      , animate = this.$element.hasClass('fade') ? 'fade' : ''

    if (this.isShown && this.options.backdrop) {
      var doAnimate = $.support.transition && animate

      this.$backdrop = $('<div class="modal-backdrop ' + animate + '" />')
        .appendTo(document.body)

      if (this.options.backdrop != 'static') {
        this.$backdrop.click($.proxy(this.hide, this))
      }

      if (doAnimate) this.$backdrop[0].offsetWidth // force reflow

      this.$backdrop.addClass('in')

      doAnimate ?
        this.$backdrop.one($.support.transition.end, callback) :
        callback()

    } else if (!this.isShown && this.$backdrop) {
      this.$backdrop.removeClass('in')

      $.support.transition && this.$element.hasClass('fade')?
        this.$backdrop.one($.support.transition.end, $.proxy(removeBackdrop, this)) :
        removeBackdrop.call(this)

    } else if (callback) {
      callback()
    }
  }

  function removeBackdrop() {
    this.$backdrop.remove()
    this.$backdrop = null
  }

  function escape() {
    var that = this
    if (this.isShown && this.options.keyboard) {
      $(document).on('keyup.dismiss.modal', function ( e ) {
        e.which == 27 && that.hide()
      })
    } else if (!this.isShown) {
      $(document).off('keyup.dismiss.modal')
    }
  }


 /* MODAL PLUGIN DEFINITION
  * ======================= */

  $.fn.modal = function ( option ) {
    return this.each(function () {
      var $this = $(this)
        , data = $this.data('modal')
        , options = $.extend({}, $.fn.modal.defaults, $this.data(), typeof option == 'object' && option)
      if (!data) $this.data('modal', (data = new Modal(this, options)))
      if (typeof option == 'string') data[option]()
      else if (options.show) data.show()
    })
  }

  $.fn.modal.defaults = {
      backdrop: true
    , keyboard: true
    , show: true
  }

  $.fn.modal.Constructor = Modal


 /* MODAL DATA-API
  * ============== */

  $(function () {
    $('body').on('click.modal.data-api', '[data-toggle="modal"]', function ( e ) {
      var $this = $(this), href
        , $target = $($this.attr('data-target') || (href = $this.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '')) //strip for ie7
        , option = $target.data('modal') ? 'toggle' : $.extend({}, $target.data(), $this.data())

      e.preventDefault()
      $target.modal(option)
    })
  })

}( window.jQuery );
/* ============================================================
 * bootstrap-dropdown.js v2.0.2
 * http://twitter.github.com/bootstrap/javascript.html#dropdowns
 * ============================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ============================================================ */


!function( $ ){

  "use strict"

 /* DROPDOWN CLASS DEFINITION
  * ========================= */

  var toggle = '[data-toggle="dropdown"]'
    , Dropdown = function ( element ) {
        var $el = $(element).on('click.dropdown.data-api', this.toggle)
        $('html').on('click.dropdown.data-api', function () {
          $el.parent().removeClass('open')
        })
      }

  Dropdown.prototype = {

    constructor: Dropdown

  , toggle: function ( e ) {
      var $this = $(this)
        , selector = $this.attr('data-target')
        , $parent
        , isActive

      if (!selector) {
        selector = $this.attr('href')
        selector = selector && selector.replace(/.*(?=#[^\s]*$)/, '') //strip for ie7
      }

      $parent = $(selector)
      $parent.length || ($parent = $this.parent())

      isActive = $parent.hasClass('open')

      clearMenus()
      !isActive && $parent.toggleClass('open')

      return false
    }

  }

  function clearMenus() {
    $(toggle).parent().removeClass('open')
  }


  /* DROPDOWN PLUGIN DEFINITION
   * ========================== */

  $.fn.dropdown = function ( option ) {
    return this.each(function () {
      var $this = $(this)
        , data = $this.data('dropdown')
      if (!data) $this.data('dropdown', (data = new Dropdown(this)))
      if (typeof option == 'string') data[option].call($this)
    })
  }

  $.fn.dropdown.Constructor = Dropdown


  /* APPLY TO STANDARD DROPDOWN ELEMENTS
   * =================================== */

  $(function () {
    $('html').on('click.dropdown.data-api', clearMenus)
    $('body').on('click.dropdown.data-api', toggle, Dropdown.prototype.toggle)
  })

}( window.jQuery );
/* =============================================================
 * bootstrap-scrollspy.js v2.0.2
 * http://twitter.github.com/bootstrap/javascript.html#scrollspy
 * =============================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ============================================================== */

!function ( $ ) {

  "use strict"

  /* SCROLLSPY CLASS DEFINITION
   * ========================== */

  function ScrollSpy( element, options) {
    var process = $.proxy(this.process, this)
      , $element = $(element).is('body') ? $(window) : $(element)
      , href
    this.options = $.extend({}, $.fn.scrollspy.defaults, options)
    this.$scrollElement = $element.on('scroll.scroll.data-api', process)
    this.selector = (this.options.target
      || ((href = $(element).attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '')) //strip for ie7
      || '') + ' .nav li > a'
    this.$body = $('body').on('click.scroll.data-api', this.selector, process)
    this.refresh()
    this.process()
  }

  ScrollSpy.prototype = {

      constructor: ScrollSpy

    , refresh: function () {
        this.targets = this.$body
          .find(this.selector)
          .map(function () {
            var href = $(this).attr('href')
            return /^#\w/.test(href) && $(href).length ? href : null
          })

        this.offsets = $.map(this.targets, function (id) {
          return $(id).position().top
        })
      }

    , process: function () {
        var scrollTop = this.$scrollElement.scrollTop() + this.options.offset
          , offsets = this.offsets
          , targets = this.targets
          , activeTarget = this.activeTarget
          , i

        for (i = offsets.length; i--;) {
          activeTarget != targets[i]
            && scrollTop >= offsets[i]
            && (!offsets[i + 1] || scrollTop <= offsets[i + 1])
            && this.activate( targets[i] )
        }
      }

    , activate: function (target) {
        var active

        this.activeTarget = target

        this.$body
          .find(this.selector).parent('.active')
          .removeClass('active')

        active = this.$body
          .find(this.selector + '[href="' + target + '"]')
          .parent('li')
          .addClass('active')

        if ( active.parent('.dropdown-menu') )  {
          active.closest('li.dropdown').addClass('active')
        }
      }

  }


 /* SCROLLSPY PLUGIN DEFINITION
  * =========================== */

  $.fn.scrollspy = function ( option ) {
    return this.each(function () {
      var $this = $(this)
        , data = $this.data('scrollspy')
        , options = typeof option == 'object' && option
      if (!data) $this.data('scrollspy', (data = new ScrollSpy(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  $.fn.scrollspy.Constructor = ScrollSpy

  $.fn.scrollspy.defaults = {
    offset: 10
  }


 /* SCROLLSPY DATA-API
  * ================== */

  $(function () {
    $('[data-spy="scroll"]').each(function () {
      var $spy = $(this)
      $spy.scrollspy($spy.data())
    })
  })

}( window.jQuery );
/* ========================================================
 * bootstrap-tab.js v2.0.2
 * http://twitter.github.com/bootstrap/javascript.html#tabs
 * ========================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ======================================================== */


!function( $ ){

  "use strict"

 /* TAB CLASS DEFINITION
  * ==================== */

  var Tab = function ( element ) {
    this.element = $(element)
  }

  Tab.prototype = {

    constructor: Tab

  , show: function () {
      var $this = this.element
        , $ul = $this.closest('ul:not(.dropdown-menu)')
        , selector = $this.attr('data-target')
        , previous
        , $target

      if (!selector) {
        selector = $this.attr('href')
        selector = selector && selector.replace(/.*(?=#[^\s]*$)/, '') //strip for ie7
      }

      if ( $this.parent('li').hasClass('active') ) return

      previous = $ul.find('.active a').last()[0]

      $this.trigger({
        type: 'show'
      , relatedTarget: previous
      })

      $target = $(selector)

      this.activate($this.parent('li'), $ul)
      this.activate($target, $target.parent(), function () {
        $this.trigger({
          type: 'shown'
        , relatedTarget: previous
        })
      })
    }

  , activate: function ( element, container, callback) {
      var $active = container.find('> .active')
        , transition = callback
            && $.support.transition
            && $active.hasClass('fade')

      function next() {
        $active
          .removeClass('active')
          .find('> .dropdown-menu > .active')
          .removeClass('active')

        element.addClass('active')

        if (transition) {
          element[0].offsetWidth // reflow for transition
          element.addClass('in')
        } else {
          element.removeClass('fade')
        }

        if ( element.parent('.dropdown-menu') ) {
          element.closest('li.dropdown').addClass('active')
        }

        callback && callback()
      }

      transition ?
        $active.one($.support.transition.end, next) :
        next()

      $active.removeClass('in')
    }
  }


 /* TAB PLUGIN DEFINITION
  * ===================== */

  $.fn.tab = function ( option ) {
    return this.each(function () {
      var $this = $(this)
        , data = $this.data('tab')
      if (!data) $this.data('tab', (data = new Tab(this)))
      if (typeof option == 'string') data[option]()
    })
  }

  $.fn.tab.Constructor = Tab


 /* TAB DATA-API
  * ============ */

  $(function () {
    $('body').on('click.tab.data-api', '[data-toggle="tab"], [data-toggle="pill"]', function (e) {
      e.preventDefault()
      $(this).tab('show')
    })
  })

}( window.jQuery );
/* ===========================================================
 * bootstrap-tooltip.js v2.0.2
 * http://twitter.github.com/bootstrap/javascript.html#tooltips
 * Inspired by the original jQuery.tipsy by Jason Frame
 * ===========================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ========================================================== */

!function( $ ) {

  "use strict"

 /* TOOLTIP PUBLIC CLASS DEFINITION
  * =============================== */

  var Tooltip = function ( element, options ) {
    this.init('tooltip', element, options)
  }

  Tooltip.prototype = {

    constructor: Tooltip

  , init: function ( type, element, options ) {
      var eventIn
        , eventOut

      this.type = type
      this.$element = $(element)
      this.options = this.getOptions(options)
      this.enabled = true

      if (this.options.trigger != 'manual') {
        eventIn  = this.options.trigger == 'hover' ? 'mouseenter' : 'focus'
        eventOut = this.options.trigger == 'hover' ? 'mouseleave' : 'blur'
        this.$element.on(eventIn, this.options.selector, $.proxy(this.enter, this))
        this.$element.on(eventOut, this.options.selector, $.proxy(this.leave, this))
      }

      this.options.selector ?
        (this._options = $.extend({}, this.options, { trigger: 'manual', selector: '' })) :
        this.fixTitle()
    }

  , getOptions: function ( options ) {
      options = $.extend({}, $.fn[this.type].defaults, options, this.$element.data())

      if (options.delay && typeof options.delay == 'number') {
        options.delay = {
          show: options.delay
        , hide: options.delay
        }
      }

      return options
    }

  , enter: function ( e ) {
      var self = $(e.currentTarget)[this.type](this._options).data(this.type)

      if (!self.options.delay || !self.options.delay.show) {
        self.show()
      } else {
        self.hoverState = 'in'
        setTimeout(function() {
          if (self.hoverState == 'in') {
            self.show()
          }
        }, self.options.delay.show)
      }
    }

  , leave: function ( e ) {
      var self = $(e.currentTarget)[this.type](this._options).data(this.type)

      if (!self.options.delay || !self.options.delay.hide) {
        self.hide()
      } else {
        self.hoverState = 'out'
        setTimeout(function() {
          if (self.hoverState == 'out') {
            self.hide()
          }
        }, self.options.delay.hide)
      }
    }

  , show: function () {
      var $tip
        , inside
        , pos
        , actualWidth
        , actualHeight
        , placement
        , tp

      if (this.hasContent() && this.enabled) {
        $tip = this.tip()
        this.setContent()

        if (this.options.animation) {
          $tip.addClass('fade')
        }

        placement = typeof this.options.placement == 'function' ?
          this.options.placement.call(this, $tip[0], this.$element[0]) :
          this.options.placement

        inside = /in/.test(placement)

        $tip
          .remove()
          .css({ top: 0, left: 0, display: 'block' })
          .appendTo(inside ? this.$element : document.body)

        pos = this.getPosition(inside)

        actualWidth = $tip[0].offsetWidth
        actualHeight = $tip[0].offsetHeight

        switch (inside ? placement.split(' ')[1] : placement) {
          case 'bottom':
            tp = {top: pos.top + pos.height, left: pos.left + pos.width / 2 - actualWidth / 2}
            break
          case 'top':
            tp = {top: pos.top - actualHeight, left: pos.left + pos.width / 2 - actualWidth / 2}
            break
          case 'left':
            tp = {top: pos.top + pos.height / 2 - actualHeight / 2, left: pos.left - actualWidth}
            break
          case 'right':
            tp = {top: pos.top + pos.height / 2 - actualHeight / 2, left: pos.left + pos.width}
            break
        }

        $tip
          .css(tp)
          .addClass(placement)
          .addClass('in')
      }
    }

  , setContent: function () {
      var $tip = this.tip()
      $tip.find('.tooltip-inner').html(this.getTitle())
      $tip.removeClass('fade in top bottom left right')
    }

  , hide: function () {
      var that = this
        , $tip = this.tip()

      $tip.removeClass('in')

      function removeWithAnimation() {
        var timeout = setTimeout(function () {
          $tip.off($.support.transition.end).remove()
        }, 500)

        $tip.one($.support.transition.end, function () {
          clearTimeout(timeout)
          $tip.remove()
        })
      }

      $.support.transition && this.$tip.hasClass('fade') ?
        removeWithAnimation() :
        $tip.remove()
    }

  , fixTitle: function () {
      var $e = this.$element
      if ($e.attr('title') || typeof($e.attr('data-original-title')) != 'string') {
        $e.attr('data-original-title', $e.attr('title') || '').removeAttr('title')
      }
    }

  , hasContent: function () {
      return this.getTitle()
    }

  , getPosition: function (inside) {
      return $.extend({}, (inside ? {top: 0, left: 0} : this.$element.offset()), {
        width: this.$element[0].offsetWidth
      , height: this.$element[0].offsetHeight
      })
    }

  , getTitle: function () {
      var title
        , $e = this.$element
        , o = this.options

      title = $e.attr('data-original-title')
        || (typeof o.title == 'function' ? o.title.call($e[0]) :  o.title)

      title = (title || '').toString().replace(/(^\s*|\s*$)/, "")

      return title
    }

  , tip: function () {
      return this.$tip = this.$tip || $(this.options.template)
    }

  , validate: function () {
      if (!this.$element[0].parentNode) {
        this.hide()
        this.$element = null
        this.options = null
      }
    }

  , enable: function () {
      this.enabled = true
    }

  , disable: function () {
      this.enabled = false
    }

  , toggleEnabled: function () {
      this.enabled = !this.enabled
    }

  , toggle: function () {
      this[this.tip().hasClass('in') ? 'hide' : 'show']()
    }

  }


 /* TOOLTIP PLUGIN DEFINITION
  * ========================= */

  $.fn.tooltip = function ( option ) {
    return this.each(function () {
      var $this = $(this)
        , data = $this.data('tooltip')
        , options = typeof option == 'object' && option
      if (!data) $this.data('tooltip', (data = new Tooltip(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  $.fn.tooltip.Constructor = Tooltip

  $.fn.tooltip.defaults = {
    animation: true
  , delay: 0
  , selector: false
  , placement: 'top'
  , trigger: 'hover'
  , title: ''
  , template: '<div class="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>'
  }

}( window.jQuery );
/* ===========================================================
 * bootstrap-popover.js v2.0.2
 * http://twitter.github.com/bootstrap/javascript.html#popovers
 * ===========================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =========================================================== */


!function( $ ) {

 "use strict"

  var Popover = function ( element, options ) {
    this.init('popover', element, options)
  }

  /* NOTE: POPOVER EXTENDS BOOTSTRAP-TOOLTIP.js
     ========================================== */

  Popover.prototype = $.extend({}, $.fn.tooltip.Constructor.prototype, {

    constructor: Popover

  , setContent: function () {
      var $tip = this.tip()
        , title = this.getTitle()
        , content = this.getContent()

      $tip.find('.popover-title')[ $.type(title) == 'object' ? 'append' : 'html' ](title)
      $tip.find('.popover-content > *')[ $.type(content) == 'object' ? 'append' : 'html' ](content)

      $tip.removeClass('fade top bottom left right in')
    }

  , hasContent: function () {
      return this.getTitle() || this.getContent()
    }

  , getContent: function () {
      var content
        , $e = this.$element
        , o = this.options

      content = $e.attr('data-content')
        || (typeof o.content == 'function' ? o.content.call($e[0]) :  o.content)

      content = content.toString().replace(/(^\s*|\s*$)/, "")

      return content
    }

  , tip: function() {
      if (!this.$tip) {
        this.$tip = $(this.options.template)
      }
      return this.$tip
    }

  })


 /* POPOVER PLUGIN DEFINITION
  * ======================= */

  $.fn.popover = function ( option ) {
    return this.each(function () {
      var $this = $(this)
        , data = $this.data('popover')
        , options = typeof option == 'object' && option
      if (!data) $this.data('popover', (data = new Popover(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  $.fn.popover.Constructor = Popover

  $.fn.popover.defaults = $.extend({} , $.fn.tooltip.defaults, {
    placement: 'right'
  , content: ''
  , template: '<div class="popover"><div class="arrow"></div><div class="popover-inner"><h3 class="popover-title"></h3><div class="popover-content"><p></p></div></div></div>'
  })

}( window.jQuery );
/* ==========================================================
 * bootstrap-alert.js v2.0.2
 * http://twitter.github.com/bootstrap/javascript.html#alerts
 * ==========================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ========================================================== */


!function( $ ){

  "use strict"

 /* ALERT CLASS DEFINITION
  * ====================== */

  var dismiss = '[data-dismiss="alert"]'
    , Alert = function ( el ) {
        $(el).on('click', dismiss, this.close)
      }

  Alert.prototype = {

    constructor: Alert

  , close: function ( e ) {
      var $this = $(this)
        , selector = $this.attr('data-target')
        , $parent

      if (!selector) {
        selector = $this.attr('href')
        selector = selector && selector.replace(/.*(?=#[^\s]*$)/, '') //strip for ie7
      }

      $parent = $(selector)
      $parent.trigger('close')

      e && e.preventDefault()

      $parent.length || ($parent = $this.hasClass('alert') ? $this : $this.parent())

      $parent
        .trigger('close')
        .removeClass('in')

      function removeElement() {
        $parent
          .trigger('closed')
          .remove()
      }

      $.support.transition && $parent.hasClass('fade') ?
        $parent.on($.support.transition.end, removeElement) :
        removeElement()
    }

  }


 /* ALERT PLUGIN DEFINITION
  * ======================= */

  $.fn.alert = function ( option ) {
    return this.each(function () {
      var $this = $(this)
        , data = $this.data('alert')
      if (!data) $this.data('alert', (data = new Alert(this)))
      if (typeof option == 'string') data[option].call($this)
    })
  }

  $.fn.alert.Constructor = Alert


 /* ALERT DATA-API
  * ============== */

  $(function () {
    $('body').on('click.alert.data-api', dismiss, Alert.prototype.close)
  })

}( window.jQuery );
/* ============================================================
 * bootstrap-button.js v2.0.2
 * http://twitter.github.com/bootstrap/javascript.html#buttons
 * ============================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ============================================================ */

!function( $ ){

  "use strict"

 /* BUTTON PUBLIC CLASS DEFINITION
  * ============================== */

  var Button = function ( element, options ) {
    this.$element = $(element)
    this.options = $.extend({}, $.fn.button.defaults, options)
  }

  Button.prototype = {

      constructor: Button

    , setState: function ( state ) {
        var d = 'disabled'
          , $el = this.$element
          , data = $el.data()
          , val = $el.is('input') ? 'val' : 'html'

        state = state + 'Text'
        data.resetText || $el.data('resetText', $el[val]())

        $el[val](data[state] || this.options[state])

        // push to event loop to allow forms to submit
        setTimeout(function () {
          state == 'loadingText' ?
            $el.addClass(d).attr(d, d) :
            $el.removeClass(d).removeAttr(d)
        }, 0)
      }

    , toggle: function () {
        var $parent = this.$element.parent('[data-toggle="buttons-radio"]')

        $parent && $parent
          .find('.active')
          .removeClass('active')

        this.$element.toggleClass('active')
      }

  }


 /* BUTTON PLUGIN DEFINITION
  * ======================== */

  $.fn.button = function ( option ) {
    return this.each(function () {
      var $this = $(this)
        , data = $this.data('button')
        , options = typeof option == 'object' && option
      if (!data) $this.data('button', (data = new Button(this, options)))
      if (option == 'toggle') data.toggle()
      else if (option) data.setState(option)
    })
  }

  $.fn.button.defaults = {
    loadingText: 'loading...'
  }

  $.fn.button.Constructor = Button


 /* BUTTON DATA-API
  * =============== */

  $(function () {
    $('body').on('click.button.data-api', '[data-toggle^=button]', function ( e ) {
      var $btn = $(e.target)
      if (!$btn.hasClass('btn')) $btn = $btn.closest('.btn')
      $btn.button('toggle')
    })
  })

}( window.jQuery );
/* =============================================================
 * bootstrap-collapse.js v2.0.2
 * http://twitter.github.com/bootstrap/javascript.html#collapse
 * =============================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ============================================================ */

!function( $ ){

  "use strict"

  var Collapse = function ( element, options ) {
  	this.$element = $(element)
    this.options = $.extend({}, $.fn.collapse.defaults, options)

    if (this.options["parent"]) {
      this.$parent = $(this.options["parent"])
    }

    this.options.toggle && this.toggle()
  }

  Collapse.prototype = {

    constructor: Collapse

  , dimension: function () {
      var hasWidth = this.$element.hasClass('width')
      return hasWidth ? 'width' : 'height'
    }

  , show: function () {
      var dimension = this.dimension()
        , scroll = $.camelCase(['scroll', dimension].join('-'))
        , actives = this.$parent && this.$parent.find('.in')
        , hasData

      if (actives && actives.length) {
        hasData = actives.data('collapse')
        actives.collapse('hide')
        hasData || actives.data('collapse', null)
      }

      this.$element[dimension](0)
      this.transition('addClass', 'show', 'shown')
      this.$element[dimension](this.$element[0][scroll])

    }

  , hide: function () {
      var dimension = this.dimension()
      this.reset(this.$element[dimension]())
      this.transition('removeClass', 'hide', 'hidden')
      this.$element[dimension](0)
    }

  , reset: function ( size ) {
      var dimension = this.dimension()

      this.$element
        .removeClass('collapse')
        [dimension](size || 'auto')
        [0].offsetWidth

      this.$element[size ? 'addClass' : 'removeClass']('collapse')

      return this
    }

  , transition: function ( method, startEvent, completeEvent ) {
      var that = this
        , complete = function () {
            if (startEvent == 'show') that.reset()
            that.$element.trigger(completeEvent)
          }

      this.$element
        .trigger(startEvent)
        [method]('in')

      $.support.transition && this.$element.hasClass('collapse') ?
        this.$element.one($.support.transition.end, complete) :
        complete()
  	}

  , toggle: function () {
      this[this.$element.hasClass('in') ? 'hide' : 'show']()
  	}

  }

  /* COLLAPSIBLE PLUGIN DEFINITION
  * ============================== */

  $.fn.collapse = function ( option ) {
    return this.each(function () {
      var $this = $(this)
        , data = $this.data('collapse')
        , options = typeof option == 'object' && option
      if (!data) $this.data('collapse', (data = new Collapse(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  $.fn.collapse.defaults = {
    toggle: true
  }

  $.fn.collapse.Constructor = Collapse


 /* COLLAPSIBLE DATA-API
  * ==================== */

  $(function () {
    $('body').on('click.collapse.data-api', '[data-toggle=collapse]', function ( e ) {
      var $this = $(this), href
        , target = $this.attr('data-target')
          || e.preventDefault()
          || (href = $this.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '') //strip for ie7
        , option = $(target).data('collapse') ? 'toggle' : $this.data()
      $(target).collapse(option)
    })
  })

}( window.jQuery );
/* ==========================================================
 * bootstrap-carousel.js v2.0.2
 * http://twitter.github.com/bootstrap/javascript.html#carousel
 * ==========================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ========================================================== */


!function( $ ){

  "use strict"

 /* CAROUSEL CLASS DEFINITION
  * ========================= */

  var Carousel = function (element, options) {
    this.$element = $(element)
    this.options = $.extend({}, $.fn.carousel.defaults, options)
    this.options.slide && this.slide(this.options.slide)
    this.options.pause == 'hover' && this.$element
      .on('mouseenter', $.proxy(this.pause, this))
      .on('mouseleave', $.proxy(this.cycle, this))
  }

  Carousel.prototype = {

    cycle: function () {
      this.interval = setInterval($.proxy(this.next, this), this.options.interval)
      return this
    }

  , to: function (pos) {
      var $active = this.$element.find('.active')
        , children = $active.parent().children()
        , activePos = children.index($active)
        , that = this

      if (pos > (children.length - 1) || pos < 0) return

      if (this.sliding) {
        return this.$element.one('slid', function () {
          that.to(pos)
        })
      }

      if (activePos == pos) {
        return this.pause().cycle()
      }

      return this.slide(pos > activePos ? 'next' : 'prev', $(children[pos]))
    }

  , pause: function () {
      clearInterval(this.interval)
      this.interval = null
      return this
    }

  , next: function () {
      if (this.sliding) return
      return this.slide('next')
    }

  , prev: function () {
      if (this.sliding) return
      return this.slide('prev')
    }

  , slide: function (type, next) {
      var $active = this.$element.find('.active')
        , $next = next || $active[type]()
        , isCycling = this.interval
        , direction = type == 'next' ? 'left' : 'right'
        , fallback  = type == 'next' ? 'first' : 'last'
        , that = this

      this.sliding = true

      isCycling && this.pause()

      $next = $next.length ? $next : this.$element.find('.item')[fallback]()

      if ($next.hasClass('active')) return

      if (!$.support.transition && this.$element.hasClass('slide')) {
        this.$element.trigger('slide')
        $active.removeClass('active')
        $next.addClass('active')
        this.sliding = false
        this.$element.trigger('slid')
      } else {
        $next.addClass(type)
        $next[0].offsetWidth // force reflow
        $active.addClass(direction)
        $next.addClass(direction)
        this.$element.trigger('slide')
        this.$element.one($.support.transition.end, function () {
          $next.removeClass([type, direction].join(' ')).addClass('active')
          $active.removeClass(['active', direction].join(' '))
          that.sliding = false
          setTimeout(function () { that.$element.trigger('slid') }, 0)
        })
      }

      isCycling && this.cycle()

      return this
    }

  }


 /* CAROUSEL PLUGIN DEFINITION
  * ========================== */

  $.fn.carousel = function ( option ) {
    return this.each(function () {
      var $this = $(this)
        , data = $this.data('carousel')
        , options = typeof option == 'object' && option
      if (!data) $this.data('carousel', (data = new Carousel(this, options)))
      if (typeof option == 'number') data.to(option)
      else if (typeof option == 'string' || (option = options.slide)) data[option]()
      else data.cycle()
    })
  }

  $.fn.carousel.defaults = {
    interval: 5000
  , pause: 'hover'
  }

  $.fn.carousel.Constructor = Carousel


 /* CAROUSEL DATA-API
  * ================= */

  $(function () {
    $('body').on('click.carousel.data-api', '[data-slide]', function ( e ) {
      var $this = $(this), href
        , $target = $($this.attr('data-target') || (href = $this.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '')) //strip for ie7
        , options = !$target.data('modal') && $.extend({}, $target.data(), $this.data())
      $target.carousel(options)
      e.preventDefault()
    })
  })

}( window.jQuery );
/* =============================================================
 * bootstrap-typeahead.js v2.0.2
 * http://twitter.github.com/bootstrap/javascript.html#typeahead
 * =============================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ============================================================ */

!function( $ ){

  "use strict"

  var Typeahead = function ( element, options ) {
    this.$element = $(element)
    this.options = $.extend({}, $.fn.typeahead.defaults, options)
    this.matcher = this.options.matcher || this.matcher
    this.sorter = this.options.sorter || this.sorter
    this.highlighter = this.options.highlighter || this.highlighter
    this.$menu = $(this.options.menu).appendTo('body')
    this.source = this.options.source
    this.shown = false
    this.listen()
  }

  Typeahead.prototype = {

    constructor: Typeahead

  , select: function () {
      var val = this.$menu.find('.active').attr('data-value')
      this.$element.val(val)
      this.$element.change();
      return this.hide()
    }

  , show: function () {
      var pos = $.extend({}, this.$element.offset(), {
        height: this.$element[0].offsetHeight
      })

      this.$menu.css({
        top: pos.top + pos.height
      , left: pos.left
      })

      this.$menu.show()
      this.shown = true
      return this
    }

  , hide: function () {
      this.$menu.hide()
      this.shown = false
      return this
    }

  , lookup: function (event) {
      var that = this
        , items
        , q

      this.query = this.$element.val()

      if (!this.query) {
        return this.shown ? this.hide() : this
      }

      items = $.grep(this.source, function (item) {
        if (that.matcher(item)) return item
      })

      items = this.sorter(items)

      if (!items.length) {
        return this.shown ? this.hide() : this
      }

      return this.render(items.slice(0, this.options.items)).show()
    }

  , matcher: function (item) {
      return ~item.toLowerCase().indexOf(this.query.toLowerCase())
    }

  , sorter: function (items) {
      var beginswith = []
        , caseSensitive = []
        , caseInsensitive = []
        , item

      while (item = items.shift()) {
        if (!item.toLowerCase().indexOf(this.query.toLowerCase())) beginswith.push(item)
        else if (~item.indexOf(this.query)) caseSensitive.push(item)
        else caseInsensitive.push(item)
      }

      return beginswith.concat(caseSensitive, caseInsensitive)
    }

  , highlighter: function (item) {
      return item.replace(new RegExp('(' + this.query + ')', 'ig'), function ($1, match) {
        return '<strong>' + match + '</strong>'
      })
    }

  , render: function (items) {
      var that = this

      items = $(items).map(function (i, item) {
        i = $(that.options.item).attr('data-value', item)
        i.find('a').html(that.highlighter(item))
        return i[0]
      })

      items.first().addClass('active')
      this.$menu.html(items)
      return this
    }

  , next: function (event) {
      var active = this.$menu.find('.active').removeClass('active')
        , next = active.next()

      if (!next.length) {
        next = $(this.$menu.find('li')[0])
      }

      next.addClass('active')
    }

  , prev: function (event) {
      var active = this.$menu.find('.active').removeClass('active')
        , prev = active.prev()

      if (!prev.length) {
        prev = this.$menu.find('li').last()
      }

      prev.addClass('active')
    }

  , listen: function () {
      this.$element
        .on('blur',     $.proxy(this.blur, this))
        .on('keypress', $.proxy(this.keypress, this))
        .on('keyup',    $.proxy(this.keyup, this))

      if ($.browser.webkit || $.browser.msie) {
        this.$element.on('keydown', $.proxy(this.keypress, this))
      }

      this.$menu
        .on('click', $.proxy(this.click, this))
        .on('mouseenter', 'li', $.proxy(this.mouseenter, this))
    }

  , keyup: function (e) {
      switch(e.keyCode) {
        case 40: // down arrow
        case 38: // up arrow
          break

        case 9: // tab
        case 13: // enter
          if (!this.shown) return
          this.select()
          break

        case 27: // escape
          if (!this.shown) return
          this.hide()
          break

        default:
          this.lookup()
      }

      e.stopPropagation()
      e.preventDefault()
  }

  , keypress: function (e) {
      if (!this.shown) return

      switch(e.keyCode) {
        case 9: // tab
        case 13: // enter
        case 27: // escape
          e.preventDefault()
          break

        case 38: // up arrow
          e.preventDefault()
          this.prev()
          break

        case 40: // down arrow
          e.preventDefault()
          this.next()
          break
      }

      e.stopPropagation()
    }

  , blur: function (e) {
      var that = this
      setTimeout(function () { that.hide() }, 150)
    }

  , click: function (e) {
      e.stopPropagation()
      e.preventDefault()
      this.select()
    }

  , mouseenter: function (e) {
      this.$menu.find('.active').removeClass('active')
      $(e.currentTarget).addClass('active')
    }

  }


  /* TYPEAHEAD PLUGIN DEFINITION
   * =========================== */

  $.fn.typeahead = function ( option ) {
    return this.each(function () {
      var $this = $(this)
        , data = $this.data('typeahead')
        , options = typeof option == 'object' && option
      if (!data) $this.data('typeahead', (data = new Typeahead(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  $.fn.typeahead.defaults = {
    source: []
  , items: 8
  , menu: '<ul class="typeahead dropdown-menu"></ul>'
  , item: '<li><a href="#"></a></li>'
  }

  $.fn.typeahead.Constructor = Typeahead


 /* TYPEAHEAD DATA-API
  * ================== */

  $(function () {
    $('body').on('focus.typeahead.data-api', '[data-provide="typeahead"]', function (e) {
      var $this = $(this)
      if ($this.data('typeahead')) return
      e.preventDefault()
      $this.typeahead($this.data())
    })
  })

}( window.jQuery );
var Markdown;

if (typeof exports === "object" && typeof require === "function") // we're in a CommonJS (e.g. Node.js) module
    Markdown = exports;
else
    Markdown = {};
    
// The following text is included for historical reasons, but should
// be taken with a pinch of salt; it's not all true anymore.

//
// Wherever possible, Showdown is a straight, line-by-line port
// of the Perl version of Markdown.
//
// This is not a normal parser design; it's basically just a
// series of string substitutions.  It's hard to read and
// maintain this way,  but keeping Showdown close to the original
// design makes it easier to port new features.
//
// More importantly, Showdown behaves like markdown.pl in most
// edge cases.  So web applications can do client-side preview
// in Javascript, and then build identical HTML on the server.
//
// This port needs the new RegExp functionality of ECMA 262,
// 3rd Edition (i.e. Javascript 1.5).  Most modern web browsers
// should do fine.  Even with the new regular expression features,
// We do a lot of work to emulate Perl's regex functionality.
// The tricky changes in this file mostly have the "attacklab:"
// label.  Major or self-explanatory changes don't.
//
// Smart diff tools like Araxis Merge will be able to match up
// this file with markdown.pl in a useful way.  A little tweaking
// helps: in a copy of markdown.pl, replace "#" with "//" and
// replace "$text" with "text".  Be sure to ignore whitespace
// and line endings.
//


//
// Usage:
//
//   var text = "Markdown *rocks*.";
//
//   var converter = new Markdown.Converter();
//   var html = converter.makeHtml(text);
//
//   alert(html);
//
// Note: move the sample code to the bottom of this
// file before uncommenting it.
//

(function () {

    function identity(x) { return x; }
    function returnFalse(x) { return false; }

    function HookCollection() { }

    HookCollection.prototype = {

        chain: function (hookname, func) {
            var original = this[hookname];
            if (!original)
                throw new Error("unknown hook " + hookname);

            if (original === identity)
                this[hookname] = func;
            else
                this[hookname] = function (text) {
                    var args = Array.prototype.slice.call(arguments, 0);
                    args[0] = original.apply(null, args);
                    return func.apply(null, args);
                };
        },
        set: function (hookname, func) {
            if (!this[hookname])
                throw new Error("unknown hook " + hookname);
            this[hookname] = func;
        },
        addNoop: function (hookname) {
            this[hookname] = identity;
        },
        addFalse: function (hookname) {
            this[hookname] = returnFalse;
        }
    };

    Markdown.HookCollection = HookCollection;

    // g_urls and g_titles allow arbitrary user-entered strings as keys. This
    // caused an exception (and hence stopped the rendering) when the user entered
    // e.g. [push] or [__proto__]. Adding a prefix to the actual key prevents this
    // (since no builtin property starts with "s_"). See
    // http://meta.stackoverflow.com/questions/64655/strange-wmd-bug
    // (granted, switching from Array() to Object() alone would have left only __proto__
    // to be a problem)
    function SaveHash() { }
    SaveHash.prototype = {
        set: function (key, value) {
            this["s_" + key] = value;
        },
        get: function (key) {
            return this["s_" + key];
        }
    };

    Markdown.Converter = function () {
        var pluginHooks = this.hooks = new HookCollection();
        
        // given a URL that was encountered by itself (without markup), should return the link text that's to be given to this link
        pluginHooks.addNoop("plainLinkText");
        
        // called with the orignal text as given to makeHtml. The result of this plugin hook is the actual markdown source that will be cooked
        pluginHooks.addNoop("preConversion");
        
        // called with the text once all normalizations have been completed (tabs to spaces, line endings, etc.), but before any conversions have
        pluginHooks.addNoop("postNormalization");
        
        // Called with the text before / after creating block elements like code blocks and lists. Note that this is called recursively
        // with inner content, e.g. it's called with the full text, and then only with the content of a blockquote. The inner
        // call will receive outdented text.
        pluginHooks.addNoop("preBlockGamut");
        pluginHooks.addNoop("postBlockGamut");
        
        // called with the text of a single block element before / after the span-level conversions (bold, code spans, etc.) have been made
        pluginHooks.addNoop("preSpanGamut");
        pluginHooks.addNoop("postSpanGamut");
        
        // called with the final cooked HTML code. The result of this plugin hook is the actual output of makeHtml
        pluginHooks.addNoop("postConversion");

        //
        // Private state of the converter instance:
        //

        // Global hashes, used by various utility routines
        var g_urls;
        var g_titles;
        var g_html_blocks;

        // Used to track when we're inside an ordered or unordered list
        // (see _ProcessListItems() for details):
        var g_list_level;

        this.makeHtml = function (text) {

            //
            // Main function. The order in which other subs are called here is
            // essential. Link and image substitutions need to happen before
            // _EscapeSpecialCharsWithinTagAttributes(), so that any *'s or _'s in the <a>
            // and <img> tags get encoded.
            //

            // This will only happen if makeHtml on the same converter instance is called from a plugin hook.
            // Don't do that.
            if (g_urls)
                throw new Error("Recursive call to converter.makeHtml");
        
            // Create the private state objects.
            g_urls = new SaveHash();
            g_titles = new SaveHash();
            g_html_blocks = [];
            g_list_level = 0;

            text = pluginHooks.preConversion(text);

            // attacklab: Replace ~ with ~T
            // This lets us use tilde as an escape char to avoid md5 hashes
            // The choice of character is arbitray; anything that isn't
            // magic in Markdown will work.
            text = text.replace(/~/g, "~T");

            // attacklab: Replace $ with ~D
            // RegExp interprets $ as a special character
            // when it's in a replacement string
            text = text.replace(/\$/g, "~D");

            // Standardize line endings
            text = text.replace(/\r\n/g, "\n"); // DOS to Unix
            text = text.replace(/\r/g, "\n"); // Mac to Unix

            // Make sure text begins and ends with a couple of newlines:
            text = "\n\n" + text + "\n\n";

            // Convert all tabs to spaces.
            text = _Detab(text);

            // Strip any lines consisting only of spaces and tabs.
            // This makes subsequent regexen easier to write, because we can
            // match consecutive blank lines with /\n+/ instead of something
            // contorted like /[ \t]*\n+/ .
            text = text.replace(/^[ \t]+$/mg, "");
            
            text = pluginHooks.postNormalization(text);

            // Turn block-level HTML blocks into hash entries
            text = _HashHTMLBlocks(text);

            // Strip link definitions, store in hashes.
            text = _StripLinkDefinitions(text);

            text = _RunBlockGamut(text);

            text = _UnescapeSpecialChars(text);

            // attacklab: Restore dollar signs
            text = text.replace(/~D/g, "$$");

            // attacklab: Restore tildes
            text = text.replace(/~T/g, "~");

            text = pluginHooks.postConversion(text);

            g_html_blocks = g_titles = g_urls = null;

            return text;
        };

        function _StripLinkDefinitions(text) {
            //
            // Strips link definitions from text, stores the URLs and titles in
            // hash references.
            //

            // Link defs are in the form: ^[id]: url "optional title"

            /*
            text = text.replace(/
                ^[ ]{0,3}\[(.+)\]:  // id = $1  attacklab: g_tab_width - 1
                [ \t]*
                \n?                 // maybe *one* newline
                [ \t]*
                <?(\S+?)>?          // url = $2
                (?=\s|$)            // lookahead for whitespace instead of the lookbehind removed below
                [ \t]*
                \n?                 // maybe one newline
                [ \t]*
                (                   // (potential) title = $3
                    (\n*)           // any lines skipped = $4 attacklab: lookbehind removed
                    [ \t]+
                    ["(]
                    (.+?)           // title = $5
                    [")]
                    [ \t]*
                )?                  // title is optional
                (?:\n+|$)
            /gm, function(){...});
            */

            text = text.replace(/^[ ]{0,3}\[(.+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?(?=\s|$)[ \t]*\n?[ \t]*((\n*)["(](.+?)[")][ \t]*)?(?:\n+)/gm,
                function (wholeMatch, m1, m2, m3, m4, m5) {
                    m1 = m1.toLowerCase();
                    g_urls.set(m1, _EncodeAmpsAndAngles(m2));  // Link IDs are case-insensitive
                    if (m4) {
                        // Oops, found blank lines, so it's not a title.
                        // Put back the parenthetical statement we stole.
                        return m3;
                    } else if (m5) {
                        g_titles.set(m1, m5.replace(/"/g, "&quot;"));
                    }

                    // Completely remove the definition from the text
                    return "";
                }
            );

            return text;
        }

        function _HashHTMLBlocks(text) {

            // Hashify HTML blocks:
            // We only want to do this for block-level HTML tags, such as headers,
            // lists, and tables. That's because we still want to wrap <p>s around
            // "paragraphs" that are wrapped in non-block-level tags, such as anchors,
            // phrase emphasis, and spans. The list of tags we're looking for is
            // hard-coded:
            var block_tags_a = "p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del"
            var block_tags_b = "p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math"

            // First, look for nested blocks, e.g.:
            //   <div>
            //     <div>
            //     tags for inner block must be indented.
            //     </div>
            //   </div>
            //
            // The outermost tags must start at the left margin for this to match, and
            // the inner nested divs must be indented.
            // We need to do this before the next, more liberal match, because the next
            // match will start at the first `<div>` and stop at the first `</div>`.

            // attacklab: This regex can be expensive when it fails.

            /*
            text = text.replace(/
                (                       // save in $1
                    ^                   // start of line  (with /m)
                    <($block_tags_a)    // start tag = $2
                    \b                  // word break
                                        // attacklab: hack around khtml/pcre bug...
                    [^\r]*?\n           // any number of lines, minimally matching
                    </\2>               // the matching end tag
                    [ \t]*              // trailing spaces/tabs
                    (?=\n+)             // followed by a newline
                )                       // attacklab: there are sentinel newlines at end of document
            /gm,function(){...}};
            */
            text = text.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del)\b[^\r]*?\n<\/\2>[ \t]*(?=\n+))/gm, hashElement);

            //
            // Now match more liberally, simply from `\n<tag>` to `</tag>\n`
            //

            /*
            text = text.replace(/
                (                       // save in $1
                    ^                   // start of line  (with /m)
                    <($block_tags_b)    // start tag = $2
                    \b                  // word break
                                        // attacklab: hack around khtml/pcre bug...
                    [^\r]*?             // any number of lines, minimally matching
                    .*</\2>             // the matching end tag
                    [ \t]*              // trailing spaces/tabs
                    (?=\n+)             // followed by a newline
                )                       // attacklab: there are sentinel newlines at end of document
            /gm,function(){...}};
            */
            text = text.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math)\b[^\r]*?.*<\/\2>[ \t]*(?=\n+)\n)/gm, hashElement);

            // Special case just for <hr />. It was easier to make a special case than
            // to make the other regex more complicated.  

            /*
            text = text.replace(/
                \n                  // Starting after a blank line
                [ ]{0,3}
                (                   // save in $1
                    (<(hr)          // start tag = $2
                        \b          // word break
                        ([^<>])*?
                    \/?>)           // the matching end tag
                    [ \t]*
                    (?=\n{2,})      // followed by a blank line
                )
            /g,hashElement);
            */
            text = text.replace(/\n[ ]{0,3}((<(hr)\b([^<>])*?\/?>)[ \t]*(?=\n{2,}))/g, hashElement);

            // Special case for standalone HTML comments:

            /*
            text = text.replace(/
                \n\n                                            // Starting after a blank line
                [ ]{0,3}                                        // attacklab: g_tab_width - 1
                (                                               // save in $1
                    <!
                    (--(?:|(?:[^>-]|-[^>])(?:[^-]|-[^-])*)--)   // see http://www.w3.org/TR/html-markup/syntax.html#comments and http://meta.stackoverflow.com/q/95256
                    >
                    [ \t]*
                    (?=\n{2,})                                  // followed by a blank line
                )
            /g,hashElement);
            */
            text = text.replace(/\n\n[ ]{0,3}(<!(--(?:|(?:[^>-]|-[^>])(?:[^-]|-[^-])*)--)>[ \t]*(?=\n{2,}))/g, hashElement);

            // PHP and ASP-style processor instructions (<?...?> and <%...%>)

            /*
            text = text.replace(/
                (?:
                    \n\n            // Starting after a blank line
                )
                (                   // save in $1
                    [ ]{0,3}        // attacklab: g_tab_width - 1
                    (?:
                        <([?%])     // $2
                        [^\r]*?
                        \2>
                    )
                    [ \t]*
                    (?=\n{2,})      // followed by a blank line
                )
            /g,hashElement);
            */
            text = text.replace(/(?:\n\n)([ ]{0,3}(?:<([?%])[^\r]*?\2>)[ \t]*(?=\n{2,}))/g, hashElement);

            return text;
        }

        function hashElement(wholeMatch, m1) {
            var blockText = m1;

            // Undo double lines
            blockText = blockText.replace(/^\n+/, "");

            // strip trailing blank lines
            blockText = blockText.replace(/\n+$/g, "");

            // Replace the element text with a marker ("~KxK" where x is its key)
            blockText = "\n\n~K" + (g_html_blocks.push(blockText) - 1) + "K\n\n";

            return blockText;
        }
        
        var blockGamutHookCallback = function (t) { return _RunBlockGamut(t); }

        function _RunBlockGamut(text, doNotUnhash) {
            //
            // These are all the transformations that form block-level
            // tags like paragraphs, headers, and list items.
            //
            
            text = pluginHooks.preBlockGamut(text, blockGamutHookCallback);
            
            text = _DoHeaders(text);

            // Do Horizontal Rules:
            var replacement = "<hr />\n";
            text = text.replace(/^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$/gm, replacement);
            text = text.replace(/^[ ]{0,2}([ ]?-[ ]?){3,}[ \t]*$/gm, replacement);
            text = text.replace(/^[ ]{0,2}([ ]?_[ ]?){3,}[ \t]*$/gm, replacement);

            text = _DoLists(text);
            text = _DoCodeBlocks(text);
            text = _DoBlockQuotes(text);
            
            text = pluginHooks.postBlockGamut(text, blockGamutHookCallback);

            // We already ran _HashHTMLBlocks() before, in Markdown(), but that
            // was to escape raw HTML in the original Markdown source. This time,
            // we're escaping the markup we've just created, so that we don't wrap
            // <p> tags around block-level tags.
            text = _HashHTMLBlocks(text);
            text = _FormParagraphs(text, doNotUnhash);

            return text;
        }

        function _RunSpanGamut(text) {
            //
            // These are all the transformations that occur *within* block-level
            // tags like paragraphs, headers, and list items.
            //

            text = pluginHooks.preSpanGamut(text);
            
            text = _DoCodeSpans(text);
            text = _EscapeSpecialCharsWithinTagAttributes(text);
            text = _EncodeBackslashEscapes(text);

            // Process anchor and image tags. Images must come first,
            // because ![foo][f] looks like an anchor.
            text = _DoImages(text);
            text = _DoAnchors(text);

            // Make links out of things like `<http://example.com/>`
            // Must come after _DoAnchors(), because you can use < and >
            // delimiters in inline links like [this](<url>).
            text = _DoAutoLinks(text);
            
            text = text.replace(/~P/g, "://"); // put in place to prevent autolinking; reset now
            
            text = _EncodeAmpsAndAngles(text);
            text = _DoItalicsAndBold(text);

            // Do hard breaks:
            text = text.replace(/  +\n/g, " <br>\n");
            
            text = pluginHooks.postSpanGamut(text);

            return text;
        }

        function _EscapeSpecialCharsWithinTagAttributes(text) {
            //
            // Within tags -- meaning between < and > -- encode [\ ` * _] so they
            // don't conflict with their use in Markdown for code, italics and strong.
            //

            // Build a regex to find HTML tags and comments.  See Friedl's 
            // "Mastering Regular Expressions", 2nd Ed., pp. 200-201.

            // SE: changed the comment part of the regex

            var regex = /(<[a-z\/!$]("[^"]*"|'[^']*'|[^'">])*>|<!(--(?:|(?:[^>-]|-[^>])(?:[^-]|-[^-])*)--)>)/gi;

            text = text.replace(regex, function (wholeMatch) {
                var tag = wholeMatch.replace(/(.)<\/?code>(?=.)/g, "$1`");
                tag = escapeCharacters(tag, wholeMatch.charAt(1) == "!" ? "\\`*_/" : "\\`*_"); // also escape slashes in comments to prevent autolinking there -- http://meta.stackoverflow.com/questions/95987
                return tag;
            });

            return text;
        }

        function _DoAnchors(text) {
            //
            // Turn Markdown link shortcuts into XHTML <a> tags.
            //
            //
            // First, handle reference-style links: [link text] [id]
            //

            /*
            text = text.replace(/
                (                           // wrap whole match in $1
                    \[
                    (
                        (?:
                            \[[^\]]*\]      // allow brackets nested one level
                            |
                            [^\[]           // or anything else
                        )*
                    )
                    \]

                    [ ]?                    // one optional space
                    (?:\n[ ]*)?             // one optional newline followed by spaces

                    \[
                    (.*?)                   // id = $3
                    \]
                )
                ()()()()                    // pad remaining backreferences
            /g, writeAnchorTag);
            */
            text = text.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g, writeAnchorTag);

            //
            // Next, inline-style links: [link text](url "optional title")
            //

            /*
            text = text.replace(/
                (                           // wrap whole match in $1
                    \[
                    (
                        (?:
                            \[[^\]]*\]      // allow brackets nested one level
                            |
                            [^\[\]]         // or anything else
                        )*
                    )
                    \]
                    \(                      // literal paren
                    [ \t]*
                    ()                      // no id, so leave $3 empty
                    <?(                     // href = $4
                        (?:
                            \([^)]*\)       // allow one level of (correctly nested) parens (think MSDN)
                            |
                            [^()\s]
                        )*?
                    )>?                
                    [ \t]*
                    (                       // $5
                        (['"])              // quote char = $6
                        (.*?)               // Title = $7
                        \6                  // matching quote
                        [ \t]*              // ignore any spaces/tabs between closing quote and )
                    )?                      // title is optional
                    \)
                )
            /g, writeAnchorTag);
            */

            text = text.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\]\([ \t]*()<?((?:\([^)]*\)|[^()\s])*?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g, writeAnchorTag);

            //
            // Last, handle reference-style shortcuts: [link text]
            // These must come last in case you've also got [link test][1]
            // or [link test](/foo)
            //

            /*
            text = text.replace(/
                (                   // wrap whole match in $1
                    \[
                    ([^\[\]]+)      // link text = $2; can't contain '[' or ']'
                    \]
                )
                ()()()()()          // pad rest of backreferences
            /g, writeAnchorTag);
            */
            text = text.replace(/(\[([^\[\]]+)\])()()()()()/g, writeAnchorTag);

            return text;
        }

        function writeAnchorTag(wholeMatch, m1, m2, m3, m4, m5, m6, m7) {
            if (m7 == undefined) m7 = "";
            var whole_match = m1;
            var link_text = m2.replace(/:\/\//g, "~P"); // to prevent auto-linking withing the link. will be converted back after the auto-linker runs
            var link_id = m3.toLowerCase();
            var url = m4;
            var title = m7;

            if (url == "") {
                if (link_id == "") {
                    // lower-case and turn embedded newlines into spaces
                    link_id = link_text.toLowerCase().replace(/ ?\n/g, " ");
                }
                url = "#" + link_id;

                if (g_urls.get(link_id) != undefined) {
                    url = g_urls.get(link_id);
                    if (g_titles.get(link_id) != undefined) {
                        title = g_titles.get(link_id);
                    }
                }
                else {
                    if (whole_match.search(/\(\s*\)$/m) > -1) {
                        // Special case for explicit empty url
                        url = "";
                    } else {
                        return whole_match;
                    }
                }
            }
            url = encodeProblemUrlChars(url);
            url = escapeCharacters(url, "*_");
            var result = "<a href=\"" + url + "\"";

            if (title != "") {
                title = attributeEncode(title);
                title = escapeCharacters(title, "*_");
                result += " title=\"" + title + "\"";
            }

            result += ">" + link_text + "</a>";

            return result;
        }

        function _DoImages(text) {
            //
            // Turn Markdown image shortcuts into <img> tags.
            //

            //
            // First, handle reference-style labeled images: ![alt text][id]
            //

            /*
            text = text.replace(/
                (                   // wrap whole match in $1
                    !\[
                    (.*?)           // alt text = $2
                    \]

                    [ ]?            // one optional space
                    (?:\n[ ]*)?     // one optional newline followed by spaces

                    \[
                    (.*?)           // id = $3
                    \]
                )
                ()()()()            // pad rest of backreferences
            /g, writeImageTag);
            */
            text = text.replace(/(!\[(.*?)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g, writeImageTag);

            //
            // Next, handle inline images:  ![alt text](url "optional title")
            // Don't forget: encode * and _

            /*
            text = text.replace(/
                (                   // wrap whole match in $1
                    !\[
                    (.*?)           // alt text = $2
                    \]
                    \s?             // One optional whitespace character
                    \(              // literal paren
                    [ \t]*
                    ()              // no id, so leave $3 empty
                    <?(\S+?)>?      // src url = $4
                    [ \t]*
                    (               // $5
                        (['"])      // quote char = $6
                        (.*?)       // title = $7
                        \6          // matching quote
                        [ \t]*
                    )?              // title is optional
                    \)
                )
            /g, writeImageTag);
            */
            text = text.replace(/(!\[(.*?)\]\s?\([ \t]*()<?(\S+?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g, writeImageTag);

            return text;
        }
        
        function attributeEncode(text) {
            // unconditionally replace angle brackets here -- what ends up in an attribute (e.g. alt or title)
            // never makes sense to have verbatim HTML in it (and the sanitizer would totally break it)
            return text.replace(/>/g, "&gt;").replace(/</g, "&lt;").replace(/"/g, "&quot;");
        }

        function writeImageTag(wholeMatch, m1, m2, m3, m4, m5, m6, m7) {
            var whole_match = m1;
            var alt_text = m2;
            var link_id = m3.toLowerCase();
            var url = m4;
            var title = m7;

            if (!title) title = "";

            if (url == "") {
                if (link_id == "") {
                    // lower-case and turn embedded newlines into spaces
                    link_id = alt_text.toLowerCase().replace(/ ?\n/g, " ");
                }
                url = "#" + link_id;

                if (g_urls.get(link_id) != undefined) {
                    url = g_urls.get(link_id);
                    if (g_titles.get(link_id) != undefined) {
                        title = g_titles.get(link_id);
                    }
                }
                else {
                    return whole_match;
                }
            }
            
            alt_text = escapeCharacters(attributeEncode(alt_text), "*_[]()");
            url = escapeCharacters(url, "*_");
            var result = "<img src=\"" + url + "\" alt=\"" + alt_text + "\"";

            // attacklab: Markdown.pl adds empty title attributes to images.
            // Replicate this bug.

            //if (title != "") {
            title = attributeEncode(title);
            title = escapeCharacters(title, "*_");
            result += " title=\"" + title + "\"";
            //}

            result += " />";

            return result;
        }

        function _DoHeaders(text) {

            // Setext-style headers:
            //  Header 1
            //  ========
            //  
            //  Header 2
            //  --------
            //
            text = text.replace(/^(.+)[ \t]*\n=+[ \t]*\n+/gm,
                function (wholeMatch, m1) { return "<h1>" + _RunSpanGamut(m1) + "</h1>\n\n"; }
            );

            text = text.replace(/^(.+)[ \t]*\n-+[ \t]*\n+/gm,
                function (matchFound, m1) { return "<h2>" + _RunSpanGamut(m1) + "</h2>\n\n"; }
            );

            // atx-style headers:
            //  # Header 1
            //  ## Header 2
            //  ## Header 2 with closing hashes ##
            //  ...
            //  ###### Header 6
            //

            /*
            text = text.replace(/
                ^(\#{1,6})      // $1 = string of #'s
                [ \t]*
                (.+?)           // $2 = Header text
                [ \t]*
                \#*             // optional closing #'s (not counted)
                \n+
            /gm, function() {...});
            */

            text = text.replace(/^(\#{1,6})[ \t]*(.+?)[ \t]*\#*\n+/gm,
                function (wholeMatch, m1, m2) {
                    var h_level = m1.length;
                    return "<h" + h_level + ">" + _RunSpanGamut(m2) + "</h" + h_level + ">\n\n";
                }
            );

            return text;
        }

        function _DoLists(text, isInsideParagraphlessListItem) {
            //
            // Form HTML ordered (numbered) and unordered (bulleted) lists.
            //

            // attacklab: add sentinel to hack around khtml/safari bug:
            // http://bugs.webkit.org/show_bug.cgi?id=11231
            text += "~0";

            // Re-usable pattern to match any entirel ul or ol list:

            /*
            var whole_list = /
                (                                   // $1 = whole list
                    (                               // $2
                        [ ]{0,3}                    // attacklab: g_tab_width - 1
                        ([*+-]|\d+[.])              // $3 = first list item marker
                        [ \t]+
                    )
                    [^\r]+?
                    (                               // $4
                        ~0                          // sentinel for workaround; should be $
                        |
                        \n{2,}
                        (?=\S)
                        (?!                         // Negative lookahead for another list item marker
                            [ \t]*
                            (?:[*+-]|\d+[.])[ \t]+
                        )
                    )
                )
            /g
            */
            var whole_list = /^(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm;

            if (g_list_level) {
                text = text.replace(whole_list, function (wholeMatch, m1, m2) {
                    var list = m1;
                    var list_type = (m2.search(/[*+-]/g) > -1) ? "ul" : "ol";

                    var result = _ProcessListItems(list, list_type, isInsideParagraphlessListItem);

                    // Trim any trailing whitespace, to put the closing `</$list_type>`
                    // up on the preceding line, to get it past the current stupid
                    // HTML block parser. This is a hack to work around the terrible
                    // hack that is the HTML block parser.
                    result = result.replace(/\s+$/, "");
                    result = "<" + list_type + ">" + result + "</" + list_type + ">\n";
                    return result;
                });
            } else {
                whole_list = /(\n\n|^\n?)(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/g;
                text = text.replace(whole_list, function (wholeMatch, m1, m2, m3) {
                    var runup = m1;
                    var list = m2;

                    var list_type = (m3.search(/[*+-]/g) > -1) ? "ul" : "ol";
                    var result = _ProcessListItems(list, list_type);
                    result = runup + "<" + list_type + ">\n" + result + "</" + list_type + ">\n";
                    return result;
                });
            }

            // attacklab: strip sentinel
            text = text.replace(/~0/, "");

            return text;
        }

        var _listItemMarkers = { ol: "\\d+[.]", ul: "[*+-]" };

        function _ProcessListItems(list_str, list_type, isInsideParagraphlessListItem) {
            //
            //  Process the contents of a single ordered or unordered list, splitting it
            //  into individual list items.
            //
            //  list_type is either "ul" or "ol".

            // The $g_list_level global keeps track of when we're inside a list.
            // Each time we enter a list, we increment it; when we leave a list,
            // we decrement. If it's zero, we're not in a list anymore.
            //
            // We do this because when we're not inside a list, we want to treat
            // something like this:
            //
            //    I recommend upgrading to version
            //    8. Oops, now this line is treated
            //    as a sub-list.
            //
            // As a single paragraph, despite the fact that the second line starts
            // with a digit-period-space sequence.
            //
            // Whereas when we're inside a list (or sub-list), that line will be
            // treated as the start of a sub-list. What a kludge, huh? This is
            // an aspect of Markdown's syntax that's hard to parse perfectly
            // without resorting to mind-reading. Perhaps the solution is to
            // change the syntax rules such that sub-lists must start with a
            // starting cardinal number; e.g. "1." or "a.".

            g_list_level++;

            // trim trailing blank lines:
            list_str = list_str.replace(/\n{2,}$/, "\n");

            // attacklab: add sentinel to emulate \z
            list_str += "~0";

            // In the original attacklab showdown, list_type was not given to this function, and anything
            // that matched /[*+-]|\d+[.]/ would just create the next <li>, causing this mismatch:
            //
            //  Markdown          rendered by WMD        rendered by MarkdownSharp
            //  ------------------------------------------------------------------
            //  1. first          1. first               1. first
            //  2. second         2. second              2. second
            //  - third           3. third                   * third
            //
            // We changed this to behave identical to MarkdownSharp. This is the constructed RegEx,
            // with {MARKER} being one of \d+[.] or [*+-], depending on list_type:
        
            /*
            list_str = list_str.replace(/
                (^[ \t]*)                       // leading whitespace = $1
                ({MARKER}) [ \t]+               // list marker = $2
                ([^\r]+?                        // list item text   = $3
                    (\n+)
                )
                (?=
                    (~0 | \2 ({MARKER}) [ \t]+)
                )
            /gm, function(){...});
            */

            var marker = _listItemMarkers[list_type];
            var re = new RegExp("(^[ \\t]*)(" + marker + ")[ \\t]+([^\\r]+?(\\n+))(?=(~0|\\1(" + marker + ")[ \\t]+))", "gm");
            var last_item_had_a_double_newline = false;
            list_str = list_str.replace(re,
                function (wholeMatch, m1, m2, m3) {
                    var item = m3;
                    var leading_space = m1;
                    var ends_with_double_newline = /\n\n$/.test(item);
                    var contains_double_newline = ends_with_double_newline || item.search(/\n{2,}/) > -1;

                    if (contains_double_newline || last_item_had_a_double_newline) {
                        item = _RunBlockGamut(_Outdent(item), /* doNotUnhash = */true);
                    }
                    else {
                        // Recursion for sub-lists:
                        item = _DoLists(_Outdent(item), /* isInsideParagraphlessListItem= */ true);
                        item = item.replace(/\n$/, ""); // chomp(item)
                        if (!isInsideParagraphlessListItem) // only the outer-most item should run this, otherwise it's run multiple times for the inner ones
                            item = _RunSpanGamut(item);
                    }
                    last_item_had_a_double_newline = ends_with_double_newline;
                    return "<li>" + item + "</li>\n";
                }
            );

            // attacklab: strip sentinel
            list_str = list_str.replace(/~0/g, "");

            g_list_level--;
            return list_str;
        }

        function _DoCodeBlocks(text) {
            //
            //  Process Markdown `<pre><code>` blocks.
            //  

            /*
            text = text.replace(/
                (?:\n\n|^)
                (                               // $1 = the code block -- one or more lines, starting with a space/tab
                    (?:
                        (?:[ ]{4}|\t)           // Lines must start with a tab or a tab-width of spaces - attacklab: g_tab_width
                        .*\n+
                    )+
                )
                (\n*[ ]{0,3}[^ \t\n]|(?=~0))    // attacklab: g_tab_width
            /g ,function(){...});
            */

            // attacklab: sentinel workarounds for lack of \A and \Z, safari\khtml bug
            text += "~0";

            text = text.replace(/(?:\n\n|^\n?)((?:(?:[ ]{4}|\t).*\n+)+)(\n*[ ]{0,3}[^ \t\n]|(?=~0))/g,
                function (wholeMatch, m1, m2) {
                    var codeblock = m1;
                    var nextChar = m2;

                    codeblock = _EncodeCode(_Outdent(codeblock));
                    codeblock = _Detab(codeblock);
                    codeblock = codeblock.replace(/^\n+/g, ""); // trim leading newlines
                    codeblock = codeblock.replace(/\n+$/g, ""); // trim trailing whitespace

                    codeblock = "<pre><code>" + codeblock + "\n</code></pre>";

                    return "\n\n" + codeblock + "\n\n" + nextChar;
                }
            );

            // attacklab: strip sentinel
            text = text.replace(/~0/, "");

            return text;
        }

        function hashBlock(text) {
            text = text.replace(/(^\n+|\n+$)/g, "");
            return "\n\n~K" + (g_html_blocks.push(text) - 1) + "K\n\n";
        }

        function _DoCodeSpans(text) {
            //
            // * Backtick quotes are used for <code></code> spans.
            // 
            // * You can use multiple backticks as the delimiters if you want to
            //   include literal backticks in the code span. So, this input:
            //     
            //      Just type ``foo `bar` baz`` at the prompt.
            //     
            //   Will translate to:
            //     
            //      <p>Just type <code>foo `bar` baz</code> at the prompt.</p>
            //     
            //   There's no arbitrary limit to the number of backticks you
            //   can use as delimters. If you need three consecutive backticks
            //   in your code, use four for delimiters, etc.
            //
            // * You can use spaces to get literal backticks at the edges:
            //     
            //      ... type `` `bar` `` ...
            //     
            //   Turns to:
            //     
            //      ... type <code>`bar`</code> ...
            //

            /*
            text = text.replace(/
                (^|[^\\])       // Character before opening ` can't be a backslash
                (`+)            // $2 = Opening run of `
                (               // $3 = The code block
                    [^\r]*?
                    [^`]        // attacklab: work around lack of lookbehind
                )
                \2              // Matching closer
                (?!`)
            /gm, function(){...});
            */

            text = text.replace(/(^|[^\\])(`+)([^\r]*?[^`])\2(?!`)/gm,
                function (wholeMatch, m1, m2, m3, m4) {
                    var c = m3;
                    c = c.replace(/^([ \t]*)/g, ""); // leading whitespace
                    c = c.replace(/[ \t]*$/g, ""); // trailing whitespace
                    c = _EncodeCode(c);
                    c = c.replace(/:\/\//g, "~P"); // to prevent auto-linking. Not necessary in code *blocks*, but in code spans. Will be converted back after the auto-linker runs.
                    return m1 + "<code>" + c + "</code>";
                }
            );

            return text;
        }

        function _EncodeCode(text) {
            //
            // Encode/escape certain characters inside Markdown code runs.
            // The point is that in code, these characters are literals,
            // and lose their special Markdown meanings.
            //
            // Encode all ampersands; HTML entities are not
            // entities within a Markdown code span.
            text = text.replace(/&/g, "&amp;");

            // Do the angle bracket song and dance:
            text = text.replace(/</g, "&lt;");
            text = text.replace(/>/g, "&gt;");

            // Now, escape characters that are magic in Markdown:
            text = escapeCharacters(text, "\*_{}[]\\", false);

            // jj the line above breaks this:
            //---

            //* Item

            //   1. Subitem

            //            special char: *
            //---

            return text;
        }

        function _DoItalicsAndBold(text) {

            // <strong> must go first:
            text = text.replace(/([\W_]|^)(\*\*|__)(?=\S)([^\r]*?\S[\*_]*)\2([\W_]|$)/g,
            "$1<strong>$3</strong>$4");

            text = text.replace(/([\W_]|^)(\*|_)(?=\S)([^\r\*_]*?\S)\2([\W_]|$)/g,
            "$1<em>$3</em>$4");

            return text;
        }

        function _DoBlockQuotes(text) {

            /*
            text = text.replace(/
                (                           // Wrap whole match in $1
                    (
                        ^[ \t]*>[ \t]?      // '>' at the start of a line
                        .+\n                // rest of the first line
                        (.+\n)*             // subsequent consecutive lines
                        \n*                 // blanks
                    )+
                )
            /gm, function(){...});
            */

            text = text.replace(/((^[ \t]*>[ \t]?.+\n(.+\n)*\n*)+)/gm,
                function (wholeMatch, m1) {
                    var bq = m1;

                    // attacklab: hack around Konqueror 3.5.4 bug:
                    // "----------bug".replace(/^-/g,"") == "bug"

                    bq = bq.replace(/^[ \t]*>[ \t]?/gm, "~0"); // trim one level of quoting

                    // attacklab: clean up hack
                    bq = bq.replace(/~0/g, "");

                    bq = bq.replace(/^[ \t]+$/gm, "");     // trim whitespace-only lines
                    bq = _RunBlockGamut(bq);             // recurse

                    bq = bq.replace(/(^|\n)/g, "$1  ");
                    // These leading spaces screw with <pre> content, so we need to fix that:
                    bq = bq.replace(
                            /(\s*<pre>[^\r]+?<\/pre>)/gm,
                        function (wholeMatch, m1) {
                            var pre = m1;
                            // attacklab: hack around Konqueror 3.5.4 bug:
                            pre = pre.replace(/^  /mg, "~0");
                            pre = pre.replace(/~0/g, "");
                            return pre;
                        });

                    return hashBlock("<blockquote>\n" + bq + "\n</blockquote>");
                }
            );
            return text;
        }

        function _FormParagraphs(text, doNotUnhash) {
            //
            //  Params:
            //    $text - string to process with html <p> tags
            //

            // Strip leading and trailing lines:
            text = text.replace(/^\n+/g, "");
            text = text.replace(/\n+$/g, "");

            var grafs = text.split(/\n{2,}/g);
            var grafsOut = [];
            
            var markerRe = /~K(\d+)K/;

            //
            // Wrap <p> tags.
            //
            var end = grafs.length;
            for (var i = 0; i < end; i++) {
                var str = grafs[i];

                // if this is an HTML marker, copy it
                if (markerRe.test(str)) {
                    grafsOut.push(str);
                }
                else if (/\S/.test(str)) {
                    str = _RunSpanGamut(str);
                    str = str.replace(/^([ \t]*)/g, "<p>");
                    str += "</p>"
                    grafsOut.push(str);
                }

            }
            //
            // Unhashify HTML blocks
            //
            if (!doNotUnhash) {
                end = grafsOut.length;
                for (var i = 0; i < end; i++) {
                    var foundAny = true;
                    while (foundAny) { // we may need several runs, since the data may be nested
                        foundAny = false;
                        grafsOut[i] = grafsOut[i].replace(/~K(\d+)K/g, function (wholeMatch, id) {
                            foundAny = true;
                            return g_html_blocks[id];
                        });
                    }
                }
            }
            return grafsOut.join("\n\n");
        }

        function _EncodeAmpsAndAngles(text) {
            // Smart processing for ampersands and angle brackets that need to be encoded.

            // Ampersand-encoding based entirely on Nat Irons's Amputator MT plugin:
            //   http://bumppo.net/projects/amputator/
            text = text.replace(/&(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/g, "&amp;");

            // Encode naked <'s
            text = text.replace(/<(?![a-z\/?!]|~D)/gi, "&lt;");

            return text;
        }

        function _EncodeBackslashEscapes(text) {
            //
            //   Parameter:  String.
            //   Returns:    The string, with after processing the following backslash
            //               escape sequences.
            //

            // attacklab: The polite way to do this is with the new
            // escapeCharacters() function:
            //
            //     text = escapeCharacters(text,"\\",true);
            //     text = escapeCharacters(text,"`*_{}[]()>#+-.!",true);
            //
            // ...but we're sidestepping its use of the (slow) RegExp constructor
            // as an optimization for Firefox.  This function gets called a LOT.

            text = text.replace(/\\(\\)/g, escapeCharacters_callback);
            text = text.replace(/\\([`*_{}\[\]()>#+-.!])/g, escapeCharacters_callback);
            return text;
        }

        var charInsideUrl = "[-A-Z0-9+&@#/%?=~_|[\\]()!:,.;]",
            charEndingUrl = "[-A-Z0-9+&@#/%=~_|[\\])]",
            autoLinkRegex = new RegExp("(=\"|<)?\\b(https?|ftp)(://" + charInsideUrl + "*" + charEndingUrl + ")(?=$|\\W)", "gi"),
            endCharRegex = new RegExp(charEndingUrl, "i");

        function handleTrailingParens(wholeMatch, lookbehind, protocol, link) {
            if (lookbehind)
                return wholeMatch;
            if (link.charAt(link.length - 1) !== ")")
                return "<" + protocol + link + ">";
            var parens = link.match(/[()]/g);
            var level = 0;
            for (var i = 0; i < parens.length; i++) {
                if (parens[i] === "(") {
                    if (level <= 0)
                        level = 1;
                    else
                        level++;
                }
                else {
                    level--;
                }
            }
            var tail = "";
            if (level < 0) {
                var re = new RegExp("\\){1," + (-level) + "}$");
                link = link.replace(re, function (trailingParens) {
                    tail = trailingParens;
                    return "";
                });
            }
            if (tail) {
                var lastChar = link.charAt(link.length - 1);
                if (!endCharRegex.test(lastChar)) {
                    tail = lastChar + tail;
                    link = link.substr(0, link.length - 1);
                }
            }
            return "<" + protocol + link + ">" + tail;
        }
        
        function _DoAutoLinks(text) {

            // note that at this point, all other URL in the text are already hyperlinked as <a href=""></a>
            // *except* for the <http://www.foo.com> case

            // automatically add < and > around unadorned raw hyperlinks
            // must be preceded by a non-word character (and not by =" or <) and followed by non-word/EOF character
            // simulating the lookbehind in a consuming way is okay here, since a URL can neither and with a " nor
            // with a <, so there is no risk of overlapping matches.
            text = text.replace(autoLinkRegex, handleTrailingParens);

            //  autolink anything like <http://example.com>
            
            var replacer = function (wholematch, m1) { return "<a href=\"" + m1 + "\">" + pluginHooks.plainLinkText(m1) + "</a>"; }
            text = text.replace(/<((https?|ftp):[^'">\s]+)>/gi, replacer);

            // Email addresses: <address@domain.foo>
            /*
            text = text.replace(/
                <
                (?:mailto:)?
                (
                    [-.\w]+
                    \@
                    [-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+
                )
                >
            /gi, _DoAutoLinks_callback());
            */

            /* disabling email autolinking, since we don't do that on the server, either
            text = text.replace(/<(?:mailto:)?([-.\w]+\@[-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+)>/gi,
                function(wholeMatch,m1) {
                    return _EncodeEmailAddress( _UnescapeSpecialChars(m1) );
                }
            );
            */
            return text;
        }

        function _UnescapeSpecialChars(text) {
            //
            // Swap back in all the special characters we've hidden.
            //
            text = text.replace(/~E(\d+)E/g,
                function (wholeMatch, m1) {
                    var charCodeToReplace = parseInt(m1);
                    return String.fromCharCode(charCodeToReplace);
                }
            );
            return text;
        }

        function _Outdent(text) {
            //
            // Remove one level of line-leading tabs or spaces
            //

            // attacklab: hack around Konqueror 3.5.4 bug:
            // "----------bug".replace(/^-/g,"") == "bug"

            text = text.replace(/^(\t|[ ]{1,4})/gm, "~0"); // attacklab: g_tab_width

            // attacklab: clean up hack
            text = text.replace(/~0/g, "")

            return text;
        }

        function _Detab(text) {
            if (!/\t/.test(text))
                return text;

            var spaces = ["    ", "   ", "  ", " "],
            skew = 0,
            v;

            return text.replace(/[\n\t]/g, function (match, offset) {
                if (match === "\n") {
                    skew = offset + 1;
                    return match;
                }
                v = (offset - skew) % 4;
                skew = offset + 1;
                return spaces[v];
            });
        }

        //
        //  attacklab: Utility functions
        //

        var _problemUrlChars = /(?:["'*()[\]:]|~D)/g;

        // hex-encodes some unusual "problem" chars in URLs to avoid URL detection problems 
        function encodeProblemUrlChars(url) {
            if (!url)
                return "";

            var len = url.length;

            return url.replace(_problemUrlChars, function (match, offset) {
                if (match == "~D") // escape for dollar
                    return "%24";
                if (match == ":") {
                    if (offset == len - 1 || /[0-9\/]/.test(url.charAt(offset + 1)))
                        return ":"
                }
                return "%" + match.charCodeAt(0).toString(16);
            });
        }


        function escapeCharacters(text, charsToEscape, afterBackslash) {
            // First we have to escape the escape characters so that
            // we can build a character class out of them
            var regexString = "([" + charsToEscape.replace(/([\[\]\\])/g, "\\$1") + "])";

            if (afterBackslash) {
                regexString = "\\\\" + regexString;
            }

            var regex = new RegExp(regexString, "g");
            text = text.replace(regex, escapeCharacters_callback);

            return text;
        }


        function escapeCharacters_callback(wholeMatch, m1) {
            var charCodeToEscape = m1.charCodeAt(0);
            return "~E" + charCodeToEscape + "E";
        }

    }; // end of the Markdown.Converter constructor

})();

(function () {
    var output, Converter;
    if (typeof exports === "object" && typeof require === "function") { // we're in a CommonJS (e.g. Node.js) module
        output = exports;
        Converter = require("./Markdown.Converter").Converter;
    } else {
        output = window.Markdown;
        Converter = output.Converter;
    }
        
    output.getSanitizingConverter = function () {
        var converter = new Converter();
        converter.hooks.chain("postConversion", sanitizeHtml);
        converter.hooks.chain("postConversion", balanceTags);
        return converter;
    }

    function sanitizeHtml(html) {
        return html.replace(/<[^>]*>?/gi, sanitizeTag);
    }

    // (tags that can be opened/closed) | (tags that stand alone)
    var basic_tag_whitelist = /^(<\/?(b|blockquote|code|del|dd|dl|dt|em|h1|h2|h3|i|kbd|li|ol|p|pre|s|sup|sub|strong|strike|ul)>|<(br|hr)\s?\/?>)$/i;
    // <a href="url..." optional title>|</a>
    var a_white = /^(<a\shref="((https?|ftp):\/\/|\/)[-A-Za-z0-9+&@#\/%?=~_|!:,.;\(\)]+"(\stitle="[^"<>]+")?\s?>|<\/a>)$/i;

    // <img src="url..." optional width  optional height  optional alt  optional title
    var img_white = /^(<img\ssrc="(https?:\/\/|\/)[-A-Za-z0-9+&@#\/%?=~_|!:,.;\(\)]+"(\swidth="\d{1,3}")?(\sheight="\d{1,3}")?(\salt="[^"<>]*")?(\stitle="[^"<>]*")?\s?\/?>)$/i;

    function sanitizeTag(tag) {
        if (tag.match(basic_tag_whitelist) || tag.match(a_white) || tag.match(img_white))
            return tag;
        else
            return "";
    }

    /// <summary>
    /// attempt to balance HTML tags in the html string
    /// by removing any unmatched opening or closing tags
    /// IMPORTANT: we *assume* HTML has *already* been 
    /// sanitized and is safe/sane before balancing!
    /// 
    /// adapted from CODESNIPPET: A8591DBA-D1D3-11DE-947C-BA5556D89593
    /// </summary>
    function balanceTags(html) {

        if (html == "")
            return "";

        var re = /<\/?\w+[^>]*(\s|$|>)/g;
        // convert everything to lower case; this makes
        // our case insensitive comparisons easier
        var tags = html.toLowerCase().match(re);

        // no HTML tags present? nothing to do; exit now
        var tagcount = (tags || []).length;
        if (tagcount == 0)
            return html;

        var tagname, tag;
        var ignoredtags = "<p><img><br><li><hr>";
        var match;
        var tagpaired = [];
        var tagremove = [];
        var needsRemoval = false;

        // loop through matched tags in forward order
        for (var ctag = 0; ctag < tagcount; ctag++) {
            tagname = tags[ctag].replace(/<\/?(\w+).*/, "$1");
            // skip any already paired tags
            // and skip tags in our ignore list; assume they're self-closed
            if (tagpaired[ctag] || ignoredtags.search("<" + tagname + ">") > -1)
                continue;

            tag = tags[ctag];
            match = -1;

            if (!/^<\//.test(tag)) {
                // this is an opening tag
                // search forwards (next tags), look for closing tags
                for (var ntag = ctag + 1; ntag < tagcount; ntag++) {
                    if (!tagpaired[ntag] && tags[ntag] == "</" + tagname + ">") {
                        match = ntag;
                        break;
                    }
                }
            }

            if (match == -1)
                needsRemoval = tagremove[ctag] = true; // mark for removal
            else
                tagpaired[match] = true; // mark paired
        }

        if (!needsRemoval)
            return html;

        // delete all orphaned tags from the string

        var ctag = 0;
        html = html.replace(re, function (match) {
            var res = tagremove[ctag] ? "" : match;
            ctag++;
            return res;
        });
        return html;
    }
})();

// Askbot adapter to markdown converter;
var getAskbotMarkdownConverter = function() {
    askbot['controllers'] = askbot['controllers'] || {};
    var converter = askbot['controllers']['markdownConverter'];
    if (!converter) {
        converter = new AskbotMarkdownConverter();
        askbot['controllers']['markdownConverter'] = converter;
    }
    return converter;
};

var AskbotMarkdownConverter = function() {
    this._converter = new Markdown.getSanitizingConverter();
    this._timeout = null;
};

AskbotMarkdownConverter.prototype.scheduleMathJaxRendering = function () {
    if (this._timeout) {
        clearTimeout(this._timeout);
    }
    var renderFunc = function () {
        MathJax.Hub.Queue(['Typeset', MathJax.Hub, 'previewer']);
    };
    this._timeout = setTimeout(renderFunc, 500);
};

AskbotMarkdownConverter.prototype.makeHtml = function (text) {
    var makeHtmlBase = this._converter.makeHtml;
    if (askbot['settings']['mathjaxEnabled'] === false){
        return makeHtmlBase(text);
    } else if (typeof MathJax != 'undefined') {
        MathJax.Hub.queue.Push(
            function(){
                $('#previewer').html(makeHtmlBase(text));
            }
        );
        this.scheduleMathJaxRendering();
        return $('#previewer').html();
    } else {
        console.log('Could not load MathJax');
        return makeHtmlBase(text);
    }
};

var Attacklab = Attacklab || {};

Attacklab.wmdBase = function(){

	// A few handy aliases for readability.
	var wmd  = self.Attacklab;
	var doc  = self.document;
	var re   = self.RegExp;
	var nav  = self.navigator;

	// Some namespaces.
	wmd.Util = {};
	wmd.Position = {};
	wmd.Command = {};
	wmd.Global = {};

	var util = wmd.Util;
	var position = wmd.Position;
	var command = wmd.Command;
	var global = wmd.Global;


	// Used to work around some browser bugs where we can't use feature testing.
    global.isChrome = /chrome/.test(nav.userAgent.toLowerCase());
	global.isIE = /msie/.test(nav.userAgent.toLowerCase());
	global.isIE_5or6 = /msie 6/.test(nav.userAgent.toLowerCase()) || /msie 5/.test(nav.userAgent.toLowerCase());
	global.isIE_7plus = global.isIE && !global.isIE_5or6;
	global.isOpera = /opera/.test(nav.userAgent.toLowerCase());
	global.isKonqueror = /konqueror/.test(nav.userAgent.toLowerCase());

	var toolbar_strong_label = gettext('bold') + " <strong> Ctrl-B";
    var toolbar_emphasis_label = gettext('italic') + " <em> Ctrl-I";
    var toolbar_hyperlink_label = gettext('link') + " <a> Ctrl-L";
    var toolbar_blockquote_label = gettext('quote') + " <blockquote> Ctrl-.";
    var toolbar_code_label = gettext('preformatted text') + " <pre><code> Ctrl-K";
    var toolbar_image_label = gettext('image') + " <img> Ctrl-G";
    var toolbar_attachment_label = gettext('attachment') + " Ctrl-F";
    var toolbar_numbered_label = gettext('numbered list') + " <ol> Ctrl-O";
    var toolbar_bulleted_label = gettext('bulleted list') + " <ul> Ctrl-U";
    var toolbar_heading_label = gettext('heading') + " <h1>/<h2> Ctrl-H";
    var toolbar_horizontal_label = gettext('horizontal bar') + " <hr> Ctrl-R";
    var toolbar_undo_label = gettext('undo') + " Ctrl-Z";
    var toolbar_redo_label = gettext('redo') + " Ctrl-Y";

	// -------------------------------------------------------------------
	//  YOUR CHANGES GO HERE
	//
	// I've tried to localize the things you are likely to change to
	// this area.
	// -------------------------------------------------------------------

	// The text that appears on the upper part of the dialog box when
	// entering links.
	var imageDialogText = "<p style='margin-top: 0px'>" + gettext('enter image url') + '</p>';
	var linkDialogText = "<p style='margin-top: 0px'>" + gettext('enter url') + '</p>';
    var fileDialogText = "<p>" + gettext('upload file attachment') + '</p>';
	// The default text that appears in the dialog input box when entering
	// links.
	var imageDefaultText = "http://";
	var linkDefaultText = "http://";

	// The location of your button images relative to the base directory.
	var imageDirectory = "images/";

	// Some intervals in ms.  These can be adjusted to reduce the control's load.
	var previewPollInterval = 500;
	var pastePollInterval = 100;

	// The link and title for the help button
	var helpLink = "http://wmd-editor.com/";
	var helpHoverTitle = "WMD website";
	var helpTarget = "_blank";
    var localUploadFileName = null;

	// -------------------------------------------------------------------
	//  END OF YOUR CHANGES
	// -------------------------------------------------------------------

	// A collection of the important regions on the page.
	// Cached so we don't have to keep traversing the DOM.
	wmd.PanelCollection = function(){
		this.buttonBar = doc.getElementById(util.makeId("wmd-button-bar"));
		this.preview = doc.getElementById(util.makeId("previewer"));
		this.output = doc.getElementById(util.makeId("wmd-output"));
		this.input = doc.getElementById(util.makeId("editor"));
	};

	// This PanelCollection object can't be filled until after the page
	// has loaded.
	wmd.panels = undefined;

	// Internet explorer has problems with CSS sprite buttons that use HTML
	// lists.  When you click on the background image "button", IE will
	// select the non-existent link text and discard the selection in the
	// textarea.  The solution to this is to cache the textarea selection
	// on the button's mousedown event and set a flag.  In the part of the
	// code where we need to grab the selection, we check for the flag
	// and, if it's set, use the cached area instead of querying the
	// textarea.
	//
	// This ONLY affects Internet Explorer (tested on versions 6, 7
	// and 8) and ONLY on button clicks.  Keyboard shortcuts work
	// normally since the focus never leaves the textarea.
	wmd.ieCachedRange = null;		// cached textarea selection
	wmd.ieRetardedClick = false;	// flag

	// Returns true if the DOM element is visible, false if it's hidden.
	// Checks if display is anything other than none.
	util.isVisible = function (elem) {

	    if (window.getComputedStyle) {
	        // Most browsers
			return window.getComputedStyle(elem, null).getPropertyValue("display") !== "none";
		}
		else if (elem.currentStyle) {
		    // IE
			return elem.currentStyle.display !== "none";
		}
	};


	// Adds a listener callback to a DOM element which is fired on a specified
	// event.
	util.addEvent = function(elem, event, listener){
		if (elem) {
            if (elem.attachEvent) {
                // IE only.  The "on" is mandatory.
                elem.attachEvent("on" + event, listener);
            } else {
                // Other browsers.
                elem.addEventListener(event, listener, false);
            }
        }
	};


	// Removes a listener callback from a DOM element which is fired on a specified
	// event.
	util.removeEvent = function(elem, event, listener){
		if (elem.detachEvent) {
			// IE only.  The "on" is mandatory.
			elem.detachEvent("on" + event, listener);
		}
		else {
			// Other browsers.
			elem.removeEventListener(event, listener, false);
		}
	};

	// Converts \r\n and \r to \n.
	util.fixEolChars = function(text){
		text = text.replace(/\r\n/g, "\n");
		text = text.replace(/\r/g, "\n");
		return text;
	};

	// Extends a regular expression.  Returns a new RegExp
	// using pre + regex + post as the expression.
	// Used in a few functions where we have a base
	// expression and we want to pre- or append some
	// conditions to it (e.g. adding "$" to the end).
	// The flags are unchanged.
	//
	// regex is a RegExp, pre and post are strings.
	util.extendRegExp = function(regex, pre, post){

		if (pre === null || pre === undefined)
		{
			pre = "";
		}
		if(post === null || post === undefined)
		{
			post = "";
		}

		var pattern = regex.toString();
		var flags;

		// Replace the flags with empty space and store them.
		pattern = pattern.replace(/\/([gim]*)$/, "");
		flags = re.$1;

		// Remove the slash delimiters on the regular expression.
		pattern = pattern.replace(/(^\/|\/$)/g, "");
		pattern = pre + pattern + post;

		return new re(pattern, flags);
	};


	// Sets the image for a button passed to the WMD editor.
	// Returns a new element with the image attached.
	// Adds several style properties to the image.
	util.createImage = function(img){

		var imgPath = imageDirectory + img;

		var elem = doc.createElement("img");
		elem.className = "wmd-button wmd-image-button";
		elem.src = imgPath;

		return elem;
	};


// This simulates a modal dialog box and asks for the URL when you
// click the hyperlink or image buttons.
//
// text: The html for the input box.
// defaultInputText: The default value that appears in the input box.
// makeLinkMarkdown: The function which is executed when the prompt is dismissed, either via OK or Cancel
util.prompt = function(text, defaultInputText, makeLinkMarkdown, dialogType){

    // These variables need to be declared at this level since they are used
    // in multiple functions.
    var dialog;// The dialog box.
    var background;// The background beind the dialog box.
    var input;// The text box where you enter the hyperlink.

    if (defaultInputText === undefined) {
        defaultInputText = "";
    }

    // Used as a keydown event handler. Esc dismisses the prompt.
    // Key code 27 is ESC.
    var checkEscape = function(key){
        var code = (key.charCode || key.keyCode);
        if (code === 27) {
            close(true);
        }
    };

    // Dismisses the hyperlink input box.
    // isCancel is true if we don't care about the input text.
    // isCancel is false if we are going to keep the text.
    var close = function(isCancel){
        util.removeEvent(doc.body, "keydown", checkEscape);
        var text = input.value;

        if (isCancel){
            text = null;
        }
        else{
            // Fixes common pasting errors.
            text = text.replace('http://http://', 'http://');
            text = text.replace('http://https://', 'https://');
            text = text.replace('http://ftp://', 'ftp://');

            if (text.indexOf('http://') === -1 && text.indexOf('ftp://') === -1 && text.indexOf('https://') === -1) {
                if (dialogType == 'link'){
                    //add http only to urls
                    text = 'http://' + text;
                }
            }
        }

        dialog.parentNode.removeChild(dialog);
        background.parentNode.removeChild(background);
        makeLinkMarkdown(text);
        return false;
    };

    // Creates the background behind the hyperlink text entry box.
    // Most of this has been moved to CSS but the div creation and
    // browser-specific hacks remain here.
    var createBackground = function(){

        background = doc.createElement("div");
        background.className = "wmd-prompt-background";
        style = background.style;
        style.position = "absolute";
        style.top = "0";

        style.zIndex = "1000";

        // Some versions of Konqueror don't support transparent colors
        // so we make the whole window transparent.
        //
        // Is this necessary on modern konqueror browsers?
        if (global.isKonqueror) {
            style.backgroundColor = "transparent";
        } else if (global.isIE) {
            style.filter = "alpha(opacity=50)";
        } else {
            style.opacity = "0.5";
        }

        var pageSize = position.getPageSize();
        style.height = pageSize[1] + "px";

        if(global.isIE) {
            style.left = doc.documentElement.scrollLeft;
            style.width = doc.documentElement.clientWidth;
        } else {
            style.left = "0";
            style.width = "100%";
        }

        doc.body.appendChild(background);
    };

    // Create the text input box form/window.
    var createDialog = function(){

        // The main dialog box.
        dialog = doc.createElement("div");
        dialog.className = "wmd-prompt-dialog";
        dialog.style.padding = "10px;";
        dialog.style.position = "fixed";
        dialog.style.width = "400px";
        dialog.style.zIndex = "1001";

        // The dialog text.
        var question = doc.createElement("div");
        question.innerHTML = text;
        question.style.padding = "5px";
        dialog.appendChild(question);

        // The web form container for the text box and buttons.
        var form = doc.createElement("form");
        form.onsubmit = function(){ return close(false); };
        style = form.style;
        style.padding = "0";
        style.margin = "0";
        style.cssFloat = "left";
        style.width = "100%";
        style.textAlign = "center";
        style.position = "relative";
        dialog.appendChild(form);

        // The input text box
        input = doc.createElement("input");
        if(dialogType == 'image' || dialogType == 'file'){
            input.id = util.makeId("image-url");
        }
        input.type = "text";
        if (dialogType == 'file'){
            input.disabled = "disabled";
        };

        input.value = defaultInputText;
        style = input.style;
        style.display = "block";
        style.width = "80%";
        style.marginLeft = style.marginRight = "auto";
        form.appendChild(input);

        //EF. fucus at the end of the input box
        //putCursorAtEnd($(input));

        // The upload file input
        if(dialogType == 'image' || dialogType == 'file'){
            var upload_container = $('<div></div>');
            var upload_input = $('<input type="file" />');
            upload_input.attr('name', 'file-upload');
            upload_input.attr('id', 'file-upload');
            upload_input.attr('size', 26);

            var spinner = $('<img />');
            spinner.attr('id', 'loading');
            spinner.attr('src', mediaUrl("media/images/indicator.gif"));
            spinner.css('display', 'none');

            var startUploadHandler = function(){
                localUploadFileName = $(this).val();//this is a local var
                /*
                 * startUploadHandler is passed into the ajaxFileUpload
                 * in order to re-install the onchange handler
                 * because the jquery extension ajaxFileUpload removes the handler
                 */
                var options = {
                    spinner: spinner,
                    uploadInputId: 'file-upload',
                    urlInput: $(input),
                    startUploadHandler: startUploadHandler
                };
                return ajaxFileUpload(options);
                //$('#image-url'), startUploadHandler);
            };

            upload_input.change(startUploadHandler);

            upload_container.append(upload_input);
            upload_container.append($('<br/>'));

            upload_container.append(spinner);

            upload_container.css('padding', '5px');
            $(form).append(upload_container);
        }

        // The ok button
        var okButton = doc.createElement("input");
        okButton.type = "button";
        okButton.onclick = function(){
            var isCancel = false;
            if ($.trim($(input).val()) === ''){
                isCancel = true;
            }
            return close(isCancel);
        };
        okButton.value = "OK";
        style = okButton.style;
        style.margin = "10px";
        style.display = "inline";
        style.width = "7em";

        // The cancel button
        var cancelButton = doc.createElement("input");
        cancelButton.type = "button";
        cancelButton.onclick = function(){ return close(true); };
        cancelButton.value = "Cancel";
        style = cancelButton.style;
        style.margin = "10px";
        style.display = "inline";
        style.width = "7em";

        // The order of these buttons is different on macs.
        if (/mac/.test(nav.platform.toLowerCase())) {
            form.appendChild(cancelButton);
            form.appendChild(okButton);
        }
        else {
            form.appendChild(okButton);
            form.appendChild(cancelButton);
        }

        util.addEvent(doc.body, "keydown", checkEscape);
        dialog.style.top = "50%";
        dialog.style.left = "50%";
        dialog.style.display = "block";
        if(global.isIE_5or6){
            dialog.style.position = "absolute";
            dialog.style.top = doc.documentElement.scrollTop + 200 + "px";
            dialog.style.left = "50%";
        }
        doc.body.appendChild(dialog);

        // This has to be done AFTER adding the dialog to the form if you
        // want it to be centered.
        dialog.style.marginTop = -(position.getHeight(dialog) / 2) + "px";
        dialog.style.marginLeft = -(position.getWidth(dialog) / 2) + "px";

        $(document).trigger('askbot.afterCreateWMDPrompt', [dialog]);
    };

    createBackground();

    // Why is this in a zero-length timeout?
    // Is it working around a browser bug?
    setTimeout(function(){
        createDialog();
        var defTextLen = defaultInputText.length;
        if (input.type == 'text' && input.selectionStart !== undefined) {
            input.selectionStart = 0;
            input.selectionEnd = defTextLen;
        } else if (input.createTextRange) {
            var range = input.createTextRange();
            range.collapse(false);
            range.moveStart("character", -defTextLen);
            range.moveEnd("character", defTextLen);
            range.select();
        }

        input.focus();
    }, 0);
};


	// UNFINISHED
	// The assignment in the while loop makes jslint cranky.
	// I'll change it to a better loop later.
	position.getTop = function(elem, isInner){
		var result = elem.offsetTop;
		if (!isInner) {
        while (elem.offsetParent) {
            elem = elem.offsetParent;
            result += elem.offsetTop;
        }
		}
		return result;
	};

	position.getHeight = function (elem) {
		return elem.offsetHeight || elem.scrollHeight;
	};

	position.getWidth = function (elem) {
		return elem.offsetWidth || elem.scrollWidth;
	};

	position.getPageSize = function(){

		var scrollWidth, scrollHeight;
		var innerWidth, innerHeight;

		// It's not very clear which blocks work with which browsers.
		if (self.innerHeight && self.scrollMaxY) {
			scrollWidth = doc.body.scrollWidth;
			scrollHeight = self.innerHeight + self.scrollMaxY;
		} else if (doc.body.scrollHeight > doc.body.offsetHeight){
			scrollWidth = doc.body.scrollWidth;
			scrollHeight = doc.body.scrollHeight;
		} else {
			scrollWidth = doc.body.offsetWidth;
			scrollHeight = doc.body.offsetHeight;
		}

		if (self.innerHeight) {
			// Non-IE browser
			innerWidth = self.innerWidth;
			innerHeight = self.innerHeight;
		} else if (doc.documentElement && doc.documentElement.clientHeight){
			// Some versions of IE (IE 6 w/ a DOCTYPE declaration)
			innerWidth = doc.documentElement.clientWidth;
			innerHeight = doc.documentElement.clientHeight;
		} else if(doc.body) {
			// Other versions of IE
			innerWidth = doc.body.clientWidth;
			innerHeight = doc.body.clientHeight;
		}

        var maxWidth = Math.max(scrollWidth, innerWidth);
        var maxHeight = Math.max(scrollHeight, innerHeight);
        return [maxWidth, maxHeight, innerWidth, innerHeight];
	};

	// Watches the input textarea, polling at an interval and runs
	// a callback function if anything has changed.
	wmd.inputPoller = function(callback, interval){

		var pollerObj = this;
		var inputArea = wmd.panels.input;

		// Stored start, end and text.  Used to see if there are changes to the input.
		var lastStart;
		var lastEnd;
		var markdown;

		var killHandle; // Used to cancel monitoring on destruction.
		// Checks to see if anything has changed in the textarea.
		// If so, it runs the callback.
		this.tick = function(){

			if (!util.isVisible(inputArea)) {
				return;
			}

			// Update the selection start and end, text.
			if (inputArea.selectionStart || inputArea.selectionStart === 0) {
				var start = inputArea.selectionStart;
				var end = inputArea.selectionEnd;
				if (start != lastStart || end != lastEnd) {
					lastStart = start;
					lastEnd = end;

					if (markdown != inputArea.value) {
						markdown = inputArea.value;
						return true;
					}
				}
			}
			return false;
		};


		var doTickCallback = function(){

			if (!util.isVisible(inputArea)) {
				return;
			}

			// If anything has changed, call the function.
			if (pollerObj.tick()) {
				callback();
			}
		};

		// Set how often we poll the textarea for changes.
		var assignInterval = function(){
			// previewPollInterval is set at the top of the namespace.
			killHandle = setInterval(doTickCallback, interval);
		};

		this.destroy = function(){
			clearInterval(killHandle);
		};

		assignInterval();
	};

	// Handles pushing and popping TextareaStates for undo/redo commands.
	// I should rename the stack variables to list.
	wmd.undoManager = function(callback){

		var undoObj = this;
		var undoStack = []; // A stack of undo states
		var stackPtr = 0; // The index of the current state
		var mode = "none";
		var lastState; // The last state
		var poller;
		var timer; // The setTimeout handle for cancelling the timer
		var inputStateObj;

		// Set the mode for later logic steps.
		var setMode = function(newMode, noSave){

			if (mode != newMode) {
				mode = newMode;
				if (!noSave) {
					saveState();
				}
			}

			if (!global.isIE || mode != "moving") {
				timer = setTimeout(refreshState, 1);
			}
			else {
				inputStateObj = null;
			}
		};

		var refreshState = function(){
			inputStateObj = new wmd.TextareaState();
			poller.tick();
			timer = undefined;
		};

		this.setCommandMode = function(){
			mode = "command";
			saveState();
			timer = setTimeout(refreshState, 0);
		};

		this.canUndo = function(){
			return stackPtr > 1;
		};

		this.canRedo = function(){
			if (undoStack[stackPtr + 1]) {
				return true;
			}
			return false;
		};

		// Removes the last state and restores it.
		this.undo = function(){

			if (undoObj.canUndo()) {
				if (lastState) {
					// What about setting state -1 to null or checking for undefined?
					lastState.restore();
					lastState = null;
				}
				else {
					undoStack[stackPtr] = new wmd.TextareaState();
					undoStack[--stackPtr].restore();

					if (callback) {
						callback();
					}
				}
			}

			mode = "none";
			wmd.panels.input.focus();
			refreshState();
		};

		// Redo an action.
		this.redo = function(){

			if (undoObj.canRedo()) {

				undoStack[++stackPtr].restore();

				if (callback) {
					callback();
				}
			}

			mode = "none";
			wmd.panels.input.focus();
			refreshState();
		};

		// Push the input area state to the stack.
		var saveState = function(){

			var currState = inputStateObj || new wmd.TextareaState();

			if (!currState) {
				return false;
			}
			if (mode == "moving") {
				if (!lastState) {
					lastState = currState;
				}
				return;
			}
			if (lastState) {
				if (undoStack[stackPtr - 1].text != lastState.text) {
					undoStack[stackPtr++] = lastState;
				}
				lastState = null;
			}
			undoStack[stackPtr++] = currState;
			undoStack[stackPtr + 1] = null;
			if (callback) {
				callback();
			}
		};

		var handleCtrlYZ = function(event){

			var handled = false;

			if (event.ctrlKey || event.metaKey) {

				// IE and Opera do not support charCode.
				var keyCode = event.charCode || event.keyCode;
				var keyCodeChar = String.fromCharCode(keyCode);

				switch (keyCodeChar) {

					case "y":
						undoObj.redo();
						handled = true;
						break;

					case "z":
						if (!event.shiftKey) {
							undoObj.undo();
						}
						else {
							undoObj.redo();
						}
						handled = true;
						break;
				}
			}

			if (handled) {
				if (event.preventDefault) {
					event.preventDefault();
				}
				if (event) {
					event.returnValue = false;
				}
				return;
			}
		};

		// Set the mode depending on what is going on in the input area.
		var handleModeChange = function(event){

			if (!event.ctrlKey && !event.metaKey) {

				var keyCode = event.keyCode;

				if ((keyCode >= 33 && keyCode <= 40) || (keyCode >= 63232 && keyCode <= 63235)) {
					// 33 - 40: page up/dn and arrow keys
					// 63232 - 63235: page up/dn and arrow keys on safari
					setMode("moving");
				}
				else if (keyCode == 8 || keyCode == 46 || keyCode == 127) {
					// 8: backspace
					// 46: delete
					// 127: delete
					setMode("deleting");
				}
				else if (keyCode == 13) {
					// 13: Enter
					setMode("newlines");
				}
				else if (keyCode == 27) {
					// 27: escape
					setMode("escape");
				}
				else if ((keyCode < 16 || keyCode > 20) && keyCode != 91) {
					// 16-20 are shift, etc.
					// 91: left window key
					// I think this might be a little messed up since there are
					// a lot of nonprinting keys above 20.
					setMode("typing");
				}
			}
		};

		var setEventHandlers = function(){

			util.addEvent(wmd.panels.input, "keypress", function(event){
				// keyCode 89: y
				// keyCode 90: z
				if ((event.ctrlKey || event.metaKey) && (event.keyCode == 89 || event.keyCode == 90)) {
					event.preventDefault();
				}
			});

			var handlePaste = function(){
				if (global.isIE || (inputStateObj && inputStateObj.text != wmd.panels.input.value)) {
					if (timer === undefined) {
						mode = "paste";
						saveState();
						refreshState();
					}
				}
			};

			// pastePollInterval is specified at the beginning of this namespace.
			poller = new wmd.inputPoller(handlePaste, pastePollInterval);

			util.addEvent(wmd.panels.input, "keydown", handleCtrlYZ);
			util.addEvent(wmd.panels.input, "keydown", handleModeChange);

			util.addEvent(wmd.panels.input, "mousedown", function(){
				setMode("moving");
			});
			wmd.panels.input.onpaste = handlePaste;
			wmd.panels.input.ondrop = handlePaste;
		};

		var init = function(){
			setEventHandlers();
			refreshState();
			saveState();
		};

		this.destroy = function(){
			if (poller) {
				poller.destroy();
			}
		};

		init();
	};

	// I think my understanding of how the buttons and callbacks are stored in the array is incomplete.
	wmd.editor = function(previewRefreshCallback){

		if (!previewRefreshCallback) {
			previewRefreshCallback = function(){};
		}

		var inputBox = wmd.panels.input;

		var offsetHeight = 0;

		var editObj = this;

		var mainDiv;
		var mainSpan;

		var div; // This name is pretty ambiguous.  I should rename this.

		// Used to cancel recurring events from setInterval.
		var creationHandle;

		var undoMgr; // The undo manager

        var isButtonUsed = function(button){
            var buttons = $.trim(wmd.wmd_env.buttons).split(/\s+/);
            return $.inArray(button, buttons) !== -1;
        };

		// Perform the button's action.
		var doClick = function(button){

			inputBox.focus();

			if (button.textOp) {

				if (undoMgr) {
					undoMgr.setCommandMode();
				}

				var state = new wmd.TextareaState();

				if (!state) {
					return;
				}

				var chunks = state.getChunks();

				// Some commands launch a "modal" prompt dialog.  Javascript
				// can't really make a modal dialog box and the WMD code
				// will continue to execute while the dialog is displayed.
				// This prevents the dialog pattern I'm used to and means
				// I can't do something like this:
				//
				// var link = CreateLinkDialog();
				// makeMarkdownLink(link);
				//
				// Instead of this straightforward method of handling a
				// dialog I have to pass any code which would execute
				// after the dialog is dismissed (e.g. link creation)
				// in a function parameter.
				//
				// Yes this is awkward and I think it sucks, but there's
				// no real workaround.  Only the image and link code
				// create dialogs and require the function pointers.
				var fixupInputArea = function(){

					inputBox.focus();

					if (chunks) {
						state.setChunks(chunks);
					}

					state.restore();
					previewRefreshCallback();
				};

				var noCleanup = button.textOp(chunks, fixupInputArea);

				if(!noCleanup) {
					fixupInputArea();
				}

			}

			if (button.execute) {
				button.execute(editObj);
			}
		};

		var setUndoRedoButtonStates = function(){
			if(undoMgr){
				setupButton(document.getElementById(util.makeId("wmd-undo-button")), undoMgr.canUndo());
				setupButton(document.getElementById(util.makeId("wmd-redo-button")), undoMgr.canRedo());
			}
		};

		var setupButton = function(button, isEnabled) {

			var normalYShift = "0px";
			var disabledYShift = "-20px";
			var highlightYShift = "-40px";

			if(isEnabled) {
				button.style.backgroundPosition = button.XShift + " " + normalYShift;
				button.onmouseover = function(){
					this.style.backgroundPosition = this.XShift + " " + highlightYShift;
				};

				button.onmouseout = function(){
					this.style.backgroundPosition = this.XShift + " " + normalYShift;
				};

				// IE tries to select the background image "button" text (it's
				// implemented in a list item) so we have to cache the selection
				// on mousedown.
				if(global.isIE) {
					button.onmousedown =  function() {
						wmd.ieRetardedClick = true;
						wmd.ieCachedRange = document.selection.createRange();
					};
				}

				if (!button.isHelp)
				{
					button.onclick = function() {
						if (this.onmouseout) {
							this.onmouseout();
						}
						doClick(this);
						return false;
					};
				}
			}
			else {
				button.style.backgroundPosition = button.XShift + " " + disabledYShift;
				button.onmouseover = button.onmouseout = button.onclick = function(){};
			}
		};

		var makeSpritedButtonRow = function(){
			var buttonBar = document.getElementById(util.makeId("wmd-button-bar"));
            buttonBar.className = 'wmd-button-bar';
			var normalYShift = "0px";
			var disabledYShift = "-20px";
			var highlightYShift = "-40px";

			var buttonRow = document.createElement("ul");
            buttonRow.className = 'wmd-button-row';
			buttonRow.id = util.makeId("wmd-button-row");
			buttonRow = buttonBar.appendChild(buttonRow);

            if (isButtonUsed('bold')){
                var boldButton = document.createElement("li");
                boldButton.className = "wmd-button wmd-bold-button";
                boldButton.id = util.makeId("wmd-bold-button");
                boldButton.title = toolbar_strong_label;
                boldButton.XShift = "0px";
                boldButton.textOp = command.doBold;
                setupButton(boldButton, true);
                buttonRow.appendChild(boldButton);
            }

            if (isButtonUsed('italic')){
                var italicButton = document.createElement("li");
                italicButton.className = "wmd-button wmd-italic-button";
                italicButton.id = util.makeId("wmd-italic-button");
                italicButton.title = toolbar_emphasis_label;
                italicButton.XShift = "-20px";
                italicButton.textOp = command.doItalic;
                setupButton(italicButton, true);
                buttonRow.appendChild(italicButton);
            }

            if (
                isButtonUsed('link') ||
                isButtonUsed('blockquote') ||
                isButtonUsed('code') ||
                isButtonUsed('image') ||
                isButtonUsed('attachment')
            ) {
                var spacer1 = document.createElement("li");
                spacer1.className = "wmd-spacer wmd-spacer1";
                spacer1.id = util.makeId("wmd-spacer1");
                buttonRow.appendChild(spacer1);
            }

            if (isButtonUsed('link')){
                var linkButton = document.createElement("li");
                linkButton.className = "wmd-button wmd-link-button";
                linkButton.id = util.makeId("wmd-link-button");
                linkButton.title = toolbar_hyperlink_label;
                linkButton.XShift = "-40px";
                linkButton.textOp = function(chunk, postProcessing){
                    return command.doLinkOrImage(chunk, postProcessing, 'link');
                };
                setupButton(linkButton, true);
                buttonRow.appendChild(linkButton);
            }

            if (isButtonUsed('blockquote')){
                var quoteButton = document.createElement("li");
                quoteButton.className = "wmd-button wmd-quote-button";
                quoteButton.id = util.makeId("wmd-quote-button");
                quoteButton.title = toolbar_blockquote_label;
                quoteButton.XShift = "-60px";
                quoteButton.textOp = command.doBlockquote;
                setupButton(quoteButton, true);
                buttonRow.appendChild(quoteButton);
            }

            if (isButtonUsed('code')){
                var codeButton = document.createElement("li");
                codeButton.className = "wmd-button wmd-code-button";
                codeButton.id = util.makeId("wmd-code-button");
                codeButton.title = toolbar_code_label;
                codeButton.XShift = "-80px";
                codeButton.textOp = command.doCode;
                setupButton(codeButton, true);
                buttonRow.appendChild(codeButton);
            }

            if (isButtonUsed('image')){
                var imageButton = document.createElement("li");
                imageButton.className = "wmd-button wmd-image-button";
                imageButton.id = util.makeId("wmd-image-button");
                imageButton.title = toolbar_image_label;
                imageButton.XShift = "-100px";
                imageButton.textOp = function(chunk, postProcessing){
                    return command.doLinkOrImage(chunk, postProcessing, 'image');
                };
                setupButton(imageButton, true);
                buttonRow.appendChild(imageButton);
            }

            if (isButtonUsed('attachment')){
                var attachmentButton = document.createElement("li");
                attachmentButton.className = "wmd-button wmd-attachment-button";
                attachmentButton.id = util.makeId("wmd-attachment-button");
                attachmentButton.title = toolbar_attachment_label;
                attachmentButton.XShift = "-120px";
                attachmentButton.textOp = function(chunk, postProcessing){
                    return command.doLinkOrImage(chunk, postProcessing, 'file');
                };
                setupButton(attachmentButton, true);
                buttonRow.appendChild(attachmentButton);
            }

            if (
                isButtonUsed('ol') ||
                isButtonUsed('ul') ||
                isButtonUsed('heading') ||
                isButtonUsed('hr')
            ) {
                var spacer2 = document.createElement("li");
                spacer2.className = "wmd-spacer wmd-spacer2";
                spacer2.id = util.makeId("wmd-spacer2");
                buttonRow.appendChild(spacer2);
            }

            if (isButtonUsed('ol')) {
                var olistButton = document.createElement("li");
                olistButton.className = "wmd-button wmd-olist-button";
                olistButton.id = util.makeId("wmd-olist-button");
                olistButton.title = toolbar_numbered_label;
                olistButton.XShift = "-140px";
                olistButton.textOp = function(chunk, postProcessing){
                    command.doList(chunk, postProcessing, true);
                };
                setupButton(olistButton, true);
                buttonRow.appendChild(olistButton);
            }

            if (isButtonUsed('ul')) {
                var ulistButton = document.createElement("li");
                ulistButton.className = "wmd-button wmd-ulist-button";
                ulistButton.id = util.makeId("wmd-ulist-button");
                ulistButton.title = toolbar_bulleted_label;
                ulistButton.XShift = "-160px";
                ulistButton.textOp = function(chunk, postProcessing){
                    command.doList(chunk, postProcessing, false);
                };
                setupButton(ulistButton, true);
                buttonRow.appendChild(ulistButton);
            }

            if (isButtonUsed('heading')) {
                var headingButton = document.createElement("li");
                headingButton.className = "wmd-button wmd-heading-button";
                headingButton.id = util.makeId("wmd-heading-button");
                headingButton.title = toolbar_heading_label;
                headingButton.XShift = "-180px";
                headingButton.textOp = command.doHeading;
                setupButton(headingButton, true);
                buttonRow.appendChild(headingButton);
            }

            if (isButtonUsed('hr')) {
                var hrButton = document.createElement("li");
                hrButton.className = "wmd-button wmd-hr-button";
                hrButton.id = util.makeId("wmd-hr-button");
                hrButton.title = toolbar_horizontal_label;
                hrButton.XShift = "-200px";
                hrButton.textOp = command.doHorizontalRule;
                setupButton(hrButton, true);
                buttonRow.appendChild(hrButton);
            }

            if (isButtonUsed('undo')){
                var spacer3 = document.createElement("li");
                spacer3.className = "wmd-spacer wmd-spacer3";
                spacer3.id = util.makeId("wmd-spacer3");
                buttonRow.appendChild(spacer3);

                var undoButton = document.createElement("li");
                undoButton.className = "wmd-button wmd-undo-button";
                undoButton.id = util.makeId("wmd-undo-button");
                undoButton.title = toolbar_undo_label;
                undoButton.XShift = "-220px";
                undoButton.execute = function(manager){
                    manager.undo();
                };
                setupButton(undoButton, true);
                buttonRow.appendChild(undoButton);

                var redoButton = document.createElement("li");
                redoButton.className = "wmd-button wmd-redo-button";
                redoButton.id = util.makeId("wmd-redo-button");
                redoButton.title = toolbar_redo_label;
                if (/win/.test(nav.platform.toLowerCase())) {
                    redoButton.title = toolbar_redo_label;
                }
                else {
                    // mac and other non-Windows platforms
                    redoButton.title = gettext('redo') + " - Ctrl+Shift+Z";
                }
                redoButton.XShift = "-240px";
                redoButton.execute = function(manager){
                    manager.redo();
                };
                setupButton(redoButton, true);
                buttonRow.appendChild(redoButton);
			    setUndoRedoButtonStates();
            }
			/*
			var helpButton = document.createElement("li");
			helpButton.className = "wmd-button wmd-help-button";
			helpButton.id = util.makeId("wmd-help-button");
			helpButton.XShift = "-240px";
			helpButton.isHelp = true;

			var helpAnchor = document.createElement("a");
			helpAnchor.href = helpLink;
			helpAnchor.target = helpTarget
			helpAnchor.title = helpHoverTitle;
			helpButton.appendChild(helpAnchor);

			setupButton(helpButton, true);
			buttonRow.appendChild(helpButton);
			*/
		};

		var setupEditor = function(){

            //prevent double initialization of the same editor
			var buttonBar = document.getElementById(util.makeId("wmd-button-bar"));
            if (buttonBar.className == 'wmd-button-bar') {
                return;
            }

			if (/\?noundo/.test(doc.location.href)) {
				wmd.nativeUndo = true;
			}

			if (!wmd.nativeUndo && isButtonUsed('undo')) {
				undoMgr = new wmd.undoManager(function(){
					previewRefreshCallback();
					setUndoRedoButtonStates();
				});
			}

			makeSpritedButtonRow();


			var keyEvent = "keydown";
			if (global.isOpera) {
				keyEvent = "keypress";
			}

			util.addEvent(inputBox, keyEvent, function(key){

				// Check to see if we have a button key and, if so execute the callback.
				if (key.ctrlKey || key.metaKey) {

					var keyCode = key.charCode || key.keyCode;
					var keyCodeStr = String.fromCharCode(keyCode).toLowerCase();

					// Bugfix for messed up DEL and .
					if (keyCode === 46) {
						keyCodeStr = "";
					}
					if (keyCode === 190) {
						keyCodeStr = ".";
					}

					switch(keyCodeStr) {
						case "b":
							doClick(document.getElementById(util.makeId("wmd-bold-button")));
							break;
						case "i":
							doClick(document.getElementById(util.makeId("wmd-italic-button")));
							break;
						case "l":
							doClick(document.getElementById(util.makeId("wmd-link-button")));
							break;
						case ".":
							doClick(document.getElementById(util.makeId("wmd-quote-button")));
							break;
						case "k":
							doClick(document.getElementById(util.makeId("wmd-code-button")));
							break;
						case "g":
							doClick(document.getElementById(util.makeId("wmd-image-button")));
							break;
						case "o":
							doClick(document.getElementById(util.makeId("wmd-olist-button")));
							break;
						case "u":
							doClick(document.getElementById(util.makeId("wmd-ulist-button")));
							break;
						case "h":
							doClick(document.getElementById(util.makeId("wmd-heading-button")));
							break;
						case "r":
							doClick(document.getElementById(util.makeId("wmd-hr-button")));
							break;
						case "y":
							doClick(document.getElementById(util.makeId("wmd-redo-button")));
							break;
						case "z":
							if(key.shiftKey) {
								doClick(document.getElementById(util.makeId("wmd-redo-button")));
							}
							else {
								doClick(document.getElementById(util.makeId("wmd-undo-button")));
							}
							break;
						default:
							return;
					}


					if (key.preventDefault) {
						key.preventDefault();
					}

					if (event) {
						event.returnValue = false;
					}
				}
			});

			// Auto-indent on shift-enter
			util.addEvent(inputBox, "keyup", function(key){
				if (key.shiftKey && !key.ctrlKey && !key.metaKey) {
					var keyCode = key.charCode || key.keyCode;
					// Character 13 is Enter
					if (keyCode === 13) {
						fakeButton = {};
						fakeButton.textOp = command.doAutoindent;
						doClick(fakeButton);
					}
				}
			});

			if (inputBox.form) {
				var submitCallback = inputBox.form.onsubmit;
				inputBox.form.onsubmit = function(){
					convertToHtml();
					if (submitCallback) {
						return submitCallback.apply(this, arguments);
					}
				};
			}
		};

		// Convert the contents of the input textarea to HTML in the output/preview panels.
		var convertToHtml = function(){

			if (wmd.showdown) {
				var markdownConverter = getAskbotMarkdownConverter();
			}
			var text = inputBox.value;

			var callback = function(){
				inputBox.value = text;
        //value is assigned here
			};

			if (!/markdown/.test(wmd.wmd_env.output.toLowerCase())) {
				if (markdownConverter) {
					inputBox.value = markdownConverter.makeHtml(text);
          //value is assigned here
					setTimeout(callback, 0);
				}
			}
			return true;
		};


		this.undo = function(){
			if (undoMgr) {
				undoMgr.undo();
			}
		};

		this.redo = function(){
			if (undoMgr) {
				undoMgr.redo();
			}
		};

		// This is pretty useless.  The setupEditor function contents
		// should just be copied here.
		var init = function(){
			setupEditor();
		};

		this.destroy = function(){
			if (undoMgr) {
				undoMgr.destroy();
			}
			if (div.parentNode) {
				div.parentNode.removeChild(div);
			}
			if (inputBox) {
				inputBox.style.marginTop = "";
			}
			clearInterval(creationHandle);
		};

		init();
	};

	// The input textarea state/contents.
	// This is used to implement undo/redo by the undo manager.
	wmd.TextareaState = function(){

		// Aliases
		var stateObj = this;
		var inputArea = wmd.panels.input;

		this.init = function() {

			if (!util.isVisible(inputArea)) {
				return;
			}

			this.setInputAreaSelectionStartEnd();
			this.scrollTop = inputArea.scrollTop;
			if (!this.text && inputArea.selectionStart || inputArea.selectionStart === 0) {
				this.text = inputArea.value;
			}

		};

		// Sets the selected text in the input box after we've performed an
		// operation.
		this.setInputAreaSelection = function(){

			if (!util.isVisible(inputArea)) {
				return;
			}

			if (inputArea.selectionStart !== undefined && !global.isOpera) {

				inputArea.focus();
				inputArea.selectionStart = stateObj.start;
				inputArea.selectionEnd = stateObj.end;
				inputArea.scrollTop = stateObj.scrollTop;
			}
			else if (doc.selection) {

				if (doc.activeElement && doc.activeElement !== inputArea) {
					return;
				}

				inputArea.focus();
				var range = inputArea.createTextRange();
				range.moveStart("character", -inputArea.value.length);
				range.moveEnd("character", -inputArea.value.length);
				range.moveEnd("character", stateObj.end);
				range.moveStart("character", stateObj.start);
				range.select();
			}
		};

		this.setInputAreaSelectionStartEnd = function(){

			if (inputArea.selectionStart || inputArea.selectionStart === 0) {

				stateObj.start = inputArea.selectionStart;
				stateObj.end = inputArea.selectionEnd;
			}
			else if (doc.selection) {

				stateObj.text = util.fixEolChars(inputArea.value);

				// IE loses the selection in the textarea when buttons are
				// clicked.  On IE we cache the selection and set a flag
				// which we check for here.
				var range;
				if(wmd.ieRetardedClick && wmd.ieCachedRange) {
					range = wmd.ieCachedRange;
					wmd.ieRetardedClick = false;
				}
				else {
					range = doc.selection.createRange();
				}

				var fixedRange = util.fixEolChars(range.text);
				var marker = "\x07";
				var markedRange = marker + fixedRange + marker;
				range.text = markedRange;
				var inputText = util.fixEolChars(inputArea.value);

				range.moveStart("character", -markedRange.length);
				range.text = fixedRange;

				stateObj.start = inputText.indexOf(marker);
				stateObj.end = inputText.lastIndexOf(marker) - marker.length;

				var len = stateObj.text.length - util.fixEolChars(inputArea.value).length;

				if (len) {
					range.moveStart("character", -fixedRange.length);
					while (len--) {
						fixedRange += "\n";
						stateObj.end += 1;
					}
					range.text = fixedRange;
				}

				this.setInputAreaSelection();
			}
		};

		// Restore this state into the input area.
		this.restore = function(){

			if (stateObj.text !== undefined && stateObj.text != inputArea.value) {
				inputArea.value = stateObj.text;
        //value is assigned here
			}
			this.setInputAreaSelection();
			inputArea.scrollTop = stateObj.scrollTop;
		};

		// Gets a collection of HTML chunks from the inptut textarea.
		this.getChunks = function(){

			var chunk = new wmd.Chunks();

			chunk.before = util.fixEolChars(stateObj.text.substring(0, stateObj.start));
			chunk.startTag = "";
			chunk.selection = util.fixEolChars(stateObj.text.substring(stateObj.start, stateObj.end));
			chunk.endTag = "";
			chunk.after = util.fixEolChars(stateObj.text.substring(stateObj.end));
			chunk.scrollTop = stateObj.scrollTop;

			return chunk;
		};

		// Sets the TextareaState properties given a chunk of markdown.
		this.setChunks = function(chunk){

			chunk.before = chunk.before + chunk.startTag;
			chunk.after = chunk.endTag + chunk.after;

			if (global.isOpera) {
				chunk.before = chunk.before.replace(/\n/g, "\r\n");
				chunk.selection = chunk.selection.replace(/\n/g, "\r\n");
				chunk.after = chunk.after.replace(/\n/g, "\r\n");
			}

			this.start = chunk.before.length;
			this.end = chunk.before.length + chunk.selection.length;
			this.text = chunk.before + chunk.selection + chunk.after;
			this.scrollTop = chunk.scrollTop;
		};

		this.init();
	};

	// before: contains all the text in the input box BEFORE the selection.
	// after: contains all the text in the input box AFTER the selection.
	wmd.Chunks = function(){
	};

	// startRegex: a regular expression to find the start tag
	// endRegex: a regular expresssion to find the end tag
	wmd.Chunks.prototype.findTags = function(startRegex, endRegex){

		var chunkObj = this;
		var regex;

		if (startRegex) {

			regex = util.extendRegExp(startRegex, "", "$");

			this.before = this.before.replace(regex,
				function(match){
					chunkObj.startTag = chunkObj.startTag + match;
					return "";
				});

			regex = util.extendRegExp(startRegex, "^", "");

			this.selection = this.selection.replace(regex,
				function(match){
					chunkObj.startTag = chunkObj.startTag + match;
					return "";
				});
		}

		if (endRegex) {

			regex = util.extendRegExp(endRegex, "", "$");

			this.selection = this.selection.replace(regex,
				function(match){
					chunkObj.endTag = match + chunkObj.endTag;
					return "";
				});

			regex = util.extendRegExp(endRegex, "^", "");

			this.after = this.after.replace(regex,
				function(match){
					chunkObj.endTag = match + chunkObj.endTag;
					return "";
				});
		}
	};

	// If remove is false, the whitespace is transferred
	// to the before/after regions.
	//
	// If remove is true, the whitespace disappears.
	wmd.Chunks.prototype.trimWhitespace = function(remove){

		this.selection = this.selection.replace(/^(\s*)/, "");

		if (!remove) {
			this.before += re.$1;
		}

		this.selection = this.selection.replace(/(\s*)$/, "");

		if (!remove) {
			this.after = re.$1 + this.after;
		}
	};


	wmd.Chunks.prototype.skipLines = function(nLinesBefore, nLinesAfter, findExtraNewlines){

		if (nLinesBefore === undefined) {
			nLinesBefore = 1;
		}

		if (nLinesAfter === undefined) {
			nLinesAfter = 1;
		}

		nLinesBefore++;
		nLinesAfter++;

		var regexText;
		var replacementText;

        if (global.isChrome) {//Chrome bug workaround
            'X'.match(/()./);
        }

		this.selection = this.selection.replace(/(^\n*)/, "");
		this.startTag = this.startTag + re.$1;
		this.selection = this.selection.replace(/(\n*$)/, "");
		this.endTag = this.endTag + re.$1;
		this.startTag = this.startTag.replace(/(^\n*)/, "");
		this.before = this.before + re.$1;
		this.endTag = this.endTag.replace(/(\n*$)/, "");
		this.after = this.after + re.$1;

		if (this.before) {

			regexText = replacementText = "";

			while (nLinesBefore--) {
				regexText += "\\n?";
				replacementText += "\n";
			}

			if (findExtraNewlines) {
				regexText = "\\n*";
			}
			this.before = this.before.replace(new re(regexText + "$", ""), replacementText);
		}

		if (this.after) {

			regexText = replacementText = "";

			while (nLinesAfter--) {
				regexText += "\\n?";
				replacementText += "\n";
			}
			if (findExtraNewlines) {
				regexText = "\\n*";
			}

			this.after = this.after.replace(new re(regexText, ""), replacementText);
		}
	};

	// The markdown symbols - 4 spaces = code, > = blockquote, etc.
	command.prefixes = "(?:\\s{4,}|\\s*>|\\s*-\\s+|\\s*\\d+\\.|=|\\+|-|_|\\*|#|\\s*\\[[^\n]]+\\]:)";

	// Remove markdown symbols from the chunk selection.
	command.unwrap = function(chunk){
		var txt = new re("([^\\n])\\n(?!(\\n|" + command.prefixes + "))", "g");
		chunk.selection = chunk.selection.replace(txt, "$1 $2");
	};

	command.wrap = function(chunk, len){
		command.unwrap(chunk);
		var regex = new re("(.{1," + len + "})( +|$\\n?)", "gm");

		chunk.selection = chunk.selection.replace(regex, function(line, marked){
			if (new re("^" + command.prefixes, "").test(line)) {
				return line;
			}
			return marked + "\n";
		});

		chunk.selection = chunk.selection.replace(/\s+$/, "");
	};

	command.doBold = function(chunk, postProcessing){
		return command.doBorI(chunk, postProcessing, 2, gettext("strong text"));
	};

	command.doItalic = function(chunk, postProcessing){
		return command.doBorI(chunk, postProcessing, 1, gettext("emphasized text"));
	};

	// chunk: The selected region that will be enclosed with */**
	// nStars: 1 for italics, 2 for bold
	// insertText: If you just click the button without highlighting text, this gets inserted
	command.doBorI = function(chunk, postProcessing, nStars, insertText){

		// Get rid of whitespace and fixup newlines.
		chunk.trimWhitespace();
		chunk.selection = chunk.selection.replace(/\n{2,}/g, "\n");

		// Look for stars before and after.  Is the chunk already marked up?
		chunk.before.search(/(\**$)/);
		var starsBefore = re.$1;

		chunk.after.search(/(^\**)/);
		var starsAfter = re.$1;

		var prevStars = Math.min(starsBefore.length, starsAfter.length);

		// Remove stars if we have to since the button acts as a toggle.
		if ((prevStars >= nStars) && (prevStars != 2 || nStars != 1)) {
			chunk.before = chunk.before.replace(re("[*]{" + nStars + "}$", ""), "");
			chunk.after = chunk.after.replace(re("^[*]{" + nStars + "}", ""), "");
		}
		else if (!chunk.selection && starsAfter) {
			// It's not really clear why this code is necessary.  It just moves
			// some arbitrary stuff around.
			chunk.after = chunk.after.replace(/^([*_]*)/, "");
			chunk.before = chunk.before.replace(/(\s?)$/, "");
			var whitespace = re.$1;
			chunk.before = chunk.before + starsAfter + whitespace;
		}
		else {

			// In most cases, if you don't have any selected text and click the button
			// you'll get a selected, marked up region with the default text inserted.
			if (!chunk.selection && !starsAfter) {
				chunk.selection = insertText;
			}

			// Add the true markup.
			var markup = nStars <= 1 ? "*" : "**"; // shouldn't the test be = ?
			chunk.before = chunk.before + markup;
			chunk.after = markup + chunk.after;
		}

		return;
	};

	command.stripLinkDefs = function(text, defsToAdd){

		text = text.replace(/^[ ]{0,3}\[(\d+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?[ \t]*\n?[ \t]*(?:(\n*)["(](.+?)[")][ \t]*)?(?:\n+|$)/gm,
			function(totalMatch, id, link, newlines, title){
				defsToAdd[id] = totalMatch.replace(/\s*$/, "");
				if (newlines) {
					// Strip the title and return that separately.
					defsToAdd[id] = totalMatch.replace(/["(](.+?)[")]$/, "");
					return newlines + title;
				}
				return "";
			});

		return text;
	};

	command.addLinkDef = function(chunk, linkDef){

		var refNumber = 0; // The current reference number
		var defsToAdd = {}; //
		// Start with a clean slate by removing all previous link definitions.
		chunk.before = command.stripLinkDefs(chunk.before, defsToAdd);
		chunk.selection = command.stripLinkDefs(chunk.selection, defsToAdd);
		chunk.after = command.stripLinkDefs(chunk.after, defsToAdd);

		var defs = "";
		var regex = /(\[(?:\[[^\]]*\]|[^\[\]])*\][ ]?(?:\n[ ]*)?\[)(\d+)(\])/g;

		var addDefNumber = function(def){
			refNumber++;
			def = def.replace(/^[ ]{0,3}\[(\d+)\]:/, "  [" + refNumber + "]:");
			defs += "\n" + def;
		};

		var getLink = function(wholeMatch, link, id, end){

			if (defsToAdd[id]) {
				addDefNumber(defsToAdd[id]);
				return link + refNumber + end;

			}
			return wholeMatch;
		};

		chunk.before = chunk.before.replace(regex, getLink);

		if (linkDef) {
			addDefNumber(linkDef);
		}
		else {
			chunk.selection = chunk.selection.replace(regex, getLink);
		}

		var refOut = refNumber;

		chunk.after = chunk.after.replace(regex, getLink);

		if (chunk.after) {
			chunk.after = chunk.after.replace(/\n*$/, "");
		}
		if (!chunk.after) {
			chunk.selection = chunk.selection.replace(/\n*$/, "");
		}

		chunk.after += "\n\n" + defs;

		return refOut;
	};

	command.doLinkOrImage = function(chunk, postProcessing, itemType){

		chunk.trimWhitespace();
		chunk.findTags(/\s*!?\[/, /\][ ]?(?:\n[ ]*)?(\[.*?\])?/);

		if (chunk.endTag.length > 1) {

			chunk.startTag = chunk.startTag.replace(/!?\[/, "");
			chunk.endTag = "";
			command.addLinkDef(chunk, null);

		}
		else {

			if (/\n\n/.test(chunk.selection)) {
				command.addLinkDef(chunk, null);
				return;
			}

			// The function to be executed when you enter a link and press OK or Cancel.
			// Marks up the link and adds the ref.
    var makeLinkMarkdown = function(link){

        if (link !== null) {

            chunk.startTag = chunk.endTag = "";
            //var linkDef = " [999]: " + link;

            //var num = command.addLinkDef(chunk, linkDef);
            chunk.startTag = (itemType == 'image') ? "![" : "[";
            chunk.endTag = "](" + link + ")";

            if (!chunk.selection) {
                if (itemType == 'image') {
                    chunk.selection = gettext("image description");
                }
                else if (itemType == 'file'){
                    chunk.selection = localUploadFileName || gettext("file name");
                    localUploadFileName = null;
                }
                else {
                    chunk.selection = gettext("link text");
                }
            }
        }
        else {
            if (itemType == 'image' || itemType == 'file'){
                return;
            }
        }
        postProcessing();
    };
    if (itemType == 'image') {
        // add forth param to identify image window
        util.prompt(imageDialogText, imageDefaultText, makeLinkMarkdown, 'image');
    }
    else if (itemType == 'file'){
        util.prompt(fileDialogText, '', makeLinkMarkdown, 'file');
    }
    else {
        util.prompt(linkDialogText, linkDefaultText, makeLinkMarkdown, 'link');
    }
    return true;
    }
};

	util.makeAPI = function(){
		wmd.wmd = {};
		wmd.wmd.editor = wmd.editor;
		wmd.wmd.previewManager = wmd.previewManager;
	};

    util.makeId = function(idToken) {
        if (wmd.wmd_env['idSeed']) {
            return askbotMakeId(idToken, wmd.wmd_env['idSeed']);
        }
        return idToken;
    };

	util.startEditor = function(start_now, buttons, idSeed){

        wmd.wmd_env['idSeed'] = idSeed;

		if (wmd.wmd_env.autostart === false) {
			util.makeAPI();
			return;
		}

        if (buttons){
            wmd.wmd_env.buttons = buttons;
        }

		var edit;		// The editor (buttons + input + outputs) - the main object.
		var previewMgr;	// The preview manager.

		// Fired after the page has fully loaded.
		var loadListener = function(){

			wmd.panels = new wmd.PanelCollection();
			if (!wmd.panels.input) {
				return;
			}

			previewMgr = new wmd.previewManager();
			var previewRefreshCallback = previewMgr.refresh;

			edit = new wmd.editor(previewRefreshCallback);

			previewMgr.refresh(true);

		};

        if (start_now){
            loadListener();
        } else {
		    util.addEvent(window, "load", loadListener);
        }
	};

	wmd.previewManager = function(){

		var managerObj = this;
		var converter;
		var poller;
		var timeout;
		var elapsedTime;
		var oldInputText;
		var htmlOut;
		var maxDelay = 3000;
		var startType = "delayed"; // The other legal value is "manual"

		// Adds event listeners to elements and creates the input poller.
		var setupEvents = function(inputElem, listener){

			util.addEvent(inputElem, "input", listener);
			inputElem.onpaste = listener;
			inputElem.ondrop = listener;

			util.addEvent(inputElem, "keypress", listener);
			util.addEvent(inputElem, "keydown", listener);
			// previewPollInterval is set at the top of this file.
			poller = new wmd.inputPoller(listener, previewPollInterval);
		};

		var getDocScrollTop = function(){

			var result = 0;

			if (window.innerHeight) {
				result = pageYOffset;
			}
			else
				if (doc.documentElement && doc.documentElement.scrollTop) {
					result = doc.documentElement.scrollTop;
				}
				else
					if (doc.body) {
						result = doc.body.scrollTop;
					}

			return result;
		};

		var makePreviewHtml = function(){

			// If there are no registered preview and output panels
			// there is nothing to do.
			if (!wmd.panels.preview && !wmd.panels.output) {
				return;
			}

			var text = wmd.panels.input.value;
			if (text && text == oldInputText) {
				return; // Input text hasn't changed.
			}
			else {
				oldInputText = text;
			}

			var prevTime = new Date().getTime();

			if (!converter) {
                converter = getAskbotMarkdownConverter();
			}

			if (converter) {
				text = converter.makeHtml(text);
			}

			// Calculate the processing time of the HTML creation.
			// It's used as the delay time in the event listener.
			var currTime = new Date().getTime();
			elapsedTime = currTime - prevTime;

			pushPreviewHtml(text);
			htmlOut = text;
		};

		// setTimeout is already used.  Used as an event listener.
		var applyTimeout = function(){

			if (timeout) {
				clearTimeout(timeout);
				timeout = undefined;
			}

			if (startType !== "manual") {

				var delay = 0;

				if (startType === "delayed") {
					delay = elapsedTime;
				}

				if (delay > maxDelay) {
					delay = maxDelay;
				}
				timeout = setTimeout(makePreviewHtml, delay);
			}
		};

		var getScaleFactor = function(panel){
			if (panel.scrollHeight <= panel.clientHeight) {
				return 1;
			}
			return panel.scrollTop / (panel.scrollHeight - panel.clientHeight);
		};

		var setPanelScrollTops = function(){

			if (wmd.panels.preview) {
				wmd.panels.preview.scrollTop = (wmd.panels.preview.scrollHeight - wmd.panels.preview.clientHeight) * getScaleFactor(wmd.panels.preview);
			}

			if (wmd.panels.output) {
				wmd.panels.output.scrollTop = (wmd.panels.output.scrollHeight - wmd.panels.output.clientHeight) * getScaleFactor(wmd.panels.output);
			}
		};

		this.refresh = function(requiresRefresh){

			if (requiresRefresh) {
				oldInputText = "";
				makePreviewHtml();
			}
			else {
				applyTimeout();
			}
		};

		this.processingTime = function(){
			return elapsedTime;
		};

		// The output HTML
		this.output = function(){
			return htmlOut;
		};

		// The mode can be "manual" or "delayed"
		this.setUpdateMode = function(mode){
			startType = mode;
			managerObj.refresh();
		};

		var isFirstTimeFilled = true;

		var pushPreviewHtml = function(text){

			var emptyTop = position.getTop(wmd.panels.input) - getDocScrollTop();

			// Send the encoded HTML to the output textarea/div.
			if (wmd.panels.output) {
				// The value property is only defined if the output is a textarea.
				if (wmd.panels.output.value !== undefined) {
					wmd.panels.output.value = text;
          //value is assigned here
					wmd.panels.output.readOnly = true;
				}
				// Otherwise we are just replacing the text in a div.
				// Send the HTML wrapped in <pre><code>
				else {
					var newText = text.replace(/&/g, "&amp;");
					newText = newText.replace(/</g, "&lt;");
					wmd.panels.output.innerHTML = "<pre><code>" + newText + "</code></pre>";
				}
			}

			if (wmd.panels.preview) {
				wmd.panels.preview.innerHTML = text;
			}

			setPanelScrollTops();

			if (isFirstTimeFilled) {
				isFirstTimeFilled = false;
				return;
			}

			var fullTop = position.getTop(wmd.panels.input) - getDocScrollTop();

			if (global.isIE) {
				setTimeout(function(){
					scrollBy(0, fullTop - emptyTop);
				}, 0);
			}
			else {
				scrollBy(0, fullTop - emptyTop);
			}
		};

		var init = function(){
			if (!wmd.panels.input) {
				return;
			}

			setupEvents(wmd.panels.input, applyTimeout);
			makePreviewHtml();

			if (wmd.panels.preview) {
				wmd.panels.preview.scrollTop = 0;
			}
			if (wmd.panels.output) {
				wmd.panels.output.scrollTop = 0;
			}
		};

		this.destroy = function(){
			if (poller) {
				poller.destroy();
			}
		};

		init();
	};

	// When making a list, hitting shift-enter will put your cursor on the next line
	// at the current indent level.
	command.doAutoindent = function(chunk, postProcessing){

		chunk.before = chunk.before.replace(/(\n|^)[ ]{0,3}([*+-]|\d+[.])[ \t]*\n$/, "\n\n");
		chunk.before = chunk.before.replace(/(\n|^)[ ]{0,3}>[ \t]*\n$/, "\n\n");
		chunk.before = chunk.before.replace(/(\n|^)[ \t]+\n$/, "\n\n");

		if(/(\n|^)[ ]{0,3}([*+-]|\d+[.])[ \t]+.*\n$/.test(chunk.before)){
			if(command.doList){
				command.doList(chunk);
			}
		}
		if(/(\n|^)[ ]{0,3}>[ \t]+.*\n$/.test(chunk.before)){
			if(command.doBlockquote){
				command.doBlockquote(chunk);
			}
		}
		if(/(\n|^)(\t|[ ]{4,}).*\n$/.test(chunk.before)){
			if(command.doCode){
				command.doCode(chunk);
			}
		}
	};

	command.doBlockquote = function(chunk, postProcessing){

		chunk.selection = chunk.selection.replace(/^(\n*)([^\r]+?)(\n*)$/,
			function(totalMatch, newlinesBefore, text, newlinesAfter){
				chunk.before += newlinesBefore;
				chunk.after = newlinesAfter + chunk.after;
				return text;
			});

		chunk.before = chunk.before.replace(/(>[ \t]*)$/,
			function(totalMatch, blankLine){
				chunk.selection = blankLine + chunk.selection;
				return "";
			});

		chunk.selection = chunk.selection.replace(/^(\s|>)+$/ ,"");
		chunk.selection = chunk.selection || "Blockquote";

		if(chunk.before){
			chunk.before = chunk.before.replace(/\n?$/,"\n");
		}
		if(chunk.after){
			chunk.after = chunk.after.replace(/^\n?/,"\n");
		}

		chunk.before = chunk.before.replace(/(((\n|^)(\n[ \t]*)*>(.+\n)*.*)+(\n[ \t]*)*$)/,
			function(totalMatch){
				chunk.startTag = totalMatch;
				return "";
			});

		chunk.after = chunk.after.replace(/^(((\n|^)(\n[ \t]*)*>(.+\n)*.*)+(\n[ \t]*)*)/,
			function(totalMatch){
				chunk.endTag = totalMatch;
				return "";
			});

		var replaceBlanksInTags = function(useBracket){

			var replacement = useBracket ? "> " : "";

			if(chunk.startTag){
				chunk.startTag = chunk.startTag.replace(/\n((>|\s)*)\n$/,
					function(totalMatch, markdown){
						return "\n" + markdown.replace(/^[ ]{0,3}>?[ \t]*$/gm, replacement) + "\n";
					});
			}
			if(chunk.endTag){
				chunk.endTag = chunk.endTag.replace(/^\n((>|\s)*)\n/,
					function(totalMatch, markdown){
						return "\n" + markdown.replace(/^[ ]{0,3}>?[ \t]*$/gm, replacement) + "\n";
					});
			}
		};

		if(/^(?![ ]{0,3}>)/m.test(chunk.selection)){
			command.wrap(chunk, wmd.wmd_env.lineLength - 2);
			chunk.selection = chunk.selection.replace(/^/gm, "> ");
			replaceBlanksInTags(true);
			chunk.skipLines();
		}
		else{
			chunk.selection = chunk.selection.replace(/^[ ]{0,3}> ?/gm, "");
			command.unwrap(chunk);
			replaceBlanksInTags(false);

			if(!/^(\n|^)[ ]{0,3}>/.test(chunk.selection) && chunk.startTag){
				chunk.startTag = chunk.startTag.replace(/\n{0,2}$/, "\n\n");
			}

			if(!/(\n|^)[ ]{0,3}>.*$/.test(chunk.selection) && chunk.endTag){
				chunk.endTag=chunk.endTag.replace(/^\n{0,2}/, "\n\n");
			}
		}

		if(!/\n/.test(chunk.selection)){
			chunk.selection = chunk.selection.replace(/^(> *)/,
			function(wholeMatch, blanks){
				chunk.startTag += blanks;
				return "";
			});
		}
	};

	command.doCode = function(chunk, postProcessing){

		var hasTextBefore = /\S[ ]*$/.test(chunk.before);
		var hasTextAfter = /^[ ]*\S/.test(chunk.after);

		// Use 'four space' markdown if the selection is on its own
		// line or is multiline.
		if((!hasTextAfter && !hasTextBefore) || /\n/.test(chunk.selection)){

			chunk.before = chunk.before.replace(/[ ]{4}$/,
				function(totalMatch){
					chunk.selection = totalMatch + chunk.selection;
					return "";
				});

			var nLinesBack = 1;
			var nLinesForward = 1;

			if(/\n(\t|[ ]{4,}).*\n$/.test(chunk.before)){
				nLinesBack = 0;
			}
			if(/^\n(\t|[ ]{4,})/.test(chunk.after)){
				nLinesForward = 0;
			}

			chunk.skipLines(nLinesBack, nLinesForward);

			if(!chunk.selection){
				chunk.startTag = "    ";
				chunk.selection = gettext("enter code here");
			}
			else {
				if(/^[ ]{0,3}\S/m.test(chunk.selection)){
					chunk.selection = chunk.selection.replace(/^/gm, "    ");
				}
				else{
					chunk.selection = chunk.selection.replace(/^[ ]{4}/gm, "");
				}
			}
		}
		else{
			// Use backticks (`) to delimit the code block.

			chunk.trimWhitespace();
			chunk.findTags(/`/, /`/);

			if(!chunk.startTag && !chunk.endTag){
				chunk.startTag = chunk.endTag="`";
				if(!chunk.selection){
					chunk.selection = gettext("enter code here");
				}
			}
			else if(chunk.endTag && !chunk.startTag){
				chunk.before += chunk.endTag;
				chunk.endTag = "";
			}
			else{
				chunk.startTag = chunk.endTag="";
			}
		}
	};

	command.doList = function(chunk, postProcessing, isNumberedList){

		// These are identical except at the very beginning and end.
		// Should probably use the regex extension function to make this clearer.
		var previousItemsRegex = /(\n|^)(([ ]{0,3}([*+-]|\d+[.])[ \t]+.*)(\n.+|\n{2,}([*+-].*|\d+[.])[ \t]+.*|\n{2,}[ \t]+\S.*)*)\n*$/;
		var nextItemsRegex = /^\n*(([ ]{0,3}([*+-]|\d+[.])[ \t]+.*)(\n.+|\n{2,}([*+-].*|\d+[.])[ \t]+.*|\n{2,}[ \t]+\S.*)*)\n*/;

		// The default bullet is a dash but others are possible.
		// This has nothing to do with the particular HTML bullet,
		// it's just a markdown bullet.
		var bullet = "-";

		// The number in a numbered list.
		var num = 1;

		// Get the item prefix - e.g. " 1. " for a numbered list, " - " for a bulleted list.
		var getItemPrefix = function(){
			var prefix;
			if(isNumberedList){
				prefix = " " + num + ". ";
				num++;
			}
			else{
				prefix = " " + bullet + " ";
			}
			return prefix;
		};

		// Fixes the prefixes of the other list items.
		var getPrefixedItem = function(itemText){

			// The numbering flag is unset when called by autoindent.
			if(isNumberedList === undefined){
				isNumberedList = /^\s*\d/.test(itemText);
			}

			// Renumber/bullet the list element.
			itemText = itemText.replace(/^[ ]{0,3}([*+-]|\d+[.])\s/gm,
				function( _ ){
					return getItemPrefix();
				});

			return itemText;
		};

		chunk.findTags(/(\n|^)*[ ]{0,3}([*+-]|\d+[.])\s+/, null);

		if(chunk.before && !/\n$/.test(chunk.before) && !/^\n/.test(chunk.startTag)){
			chunk.before += chunk.startTag;
			chunk.startTag = "";
		}

		if(chunk.startTag){

			var hasDigits = /\d+[.]/.test(chunk.startTag);
			chunk.startTag = "";
			chunk.selection = chunk.selection.replace(/\n[ ]{4}/g, "\n");
			command.unwrap(chunk);
			chunk.skipLines();

			if(hasDigits){
				// Have to renumber the bullet points if this is a numbered list.
				chunk.after = chunk.after.replace(nextItemsRegex, getPrefixedItem);
			}
			if(isNumberedList == hasDigits){
				return;
			}
		}

		var nLinesUp = 1;

		chunk.before = chunk.before.replace(previousItemsRegex,
			function(itemText){
				if(/^\s*([*+-])/.test(itemText)){
					bullet = re.$1;
				}
				nLinesUp = /[^\n]\n\n[^\n]/.test(itemText) ? 1 : 0;
				return getPrefixedItem(itemText);
			});

		if(!chunk.selection){
			chunk.selection = gettext("List item");
		}

		var prefix = getItemPrefix();

		var nLinesDown = 1;

		chunk.after = chunk.after.replace(nextItemsRegex,
			function(itemText){
				nLinesDown = /[^\n]\n\n[^\n]/.test(itemText) ? 1 : 0;
				return getPrefixedItem(itemText);
			});

		chunk.trimWhitespace(true);
		chunk.skipLines(nLinesUp, nLinesDown, true);
		chunk.startTag = prefix;
		var spaces = prefix.replace(/./g, " ");
		command.wrap(chunk, wmd.wmd_env.lineLength - spaces.length);
		chunk.selection = chunk.selection.replace(/\n/g, "\n" + spaces);

	};

	command.doHeading = function(chunk, postProcessing){

		// Remove leading/trailing whitespace and reduce internal spaces to single spaces.
		chunk.selection = chunk.selection.replace(/\s+/g, " ");
		chunk.selection = chunk.selection.replace(/(^\s+|\s+$)/g, "");

		// If we clicked the button with no selected text, we just
		// make a level 2 hash header around some default text.
		if(!chunk.selection){
			chunk.startTag = "## ";
			chunk.selection = gettext("Heading");
			chunk.endTag = " ##";
			return;
		}

		var headerLevel = 0;		// The existing header level of the selected text.

		// Remove any existing hash heading markdown and save the header level.
		chunk.findTags(/#+[ ]*/, /[ ]*#+/);
		if(/#+/.test(chunk.startTag)){
			headerLevel = re.lastMatch.length;
		}
		chunk.startTag = chunk.endTag = "";

		// Try to get the current header level by looking for - and = in the line
		// below the selection.
		chunk.findTags(null, /\s?(-+|=+)/);
		if(/=+/.test(chunk.endTag)){
			headerLevel = 1;
		}
		if(/-+/.test(chunk.endTag)){
			headerLevel = 2;
		}

		// Skip to the next line so we can create the header markdown.
		chunk.startTag = chunk.endTag = "";
		chunk.skipLines(1, 1);

		// We make a level 2 header if there is no current header.
		// If there is a header level, we substract one from the header level.
		// If it's already a level 1 header, it's removed.
		var headerLevelToCreate = headerLevel == 0 ? 2 : headerLevel - 1;

		if(headerLevelToCreate > 0){

			// The button only creates level 1 and 2 underline headers.
			// Why not have it iterate over hash header levels?  Wouldn't that be easier and cleaner?
			var headerChar = headerLevelToCreate >= 2 ? "-" : "=";
			var len = chunk.selection.length;
			if(len > wmd.wmd_env.lineLength){
				len = wmd.wmd_env.lineLength;
			}
			chunk.endTag = "\n";
			while(len--){
				chunk.endTag += headerChar;
			}
		}
	};

	command.doHorizontalRule = function(chunk, postProcessing){
		chunk.startTag = "----------\n";
		chunk.selection = "";
		chunk.skipLines(2, 1, true);
	}
};


Attacklab.wmd_env = {};
Attacklab.account_options = {};
Attacklab.wmd_defaults = {version:1, output:"Markdown", lineLength:40, delayLoad:false};

if (askbot['settings']['editorType'] == 'markdown' && !Attacklab.wmd) {
	Attacklab.wmd = function() {
		Attacklab.loadEnv = function() {
			var mergeEnv = function(env) {
				if(!env) {
					return;
				}

				for(var key in env) {
					Attacklab.wmd_env[key] = env[key];
				}
			};

			mergeEnv(Attacklab.wmd_defaults);
			mergeEnv(Attacklab.account_options);
			mergeEnv(window["wmd_options"]);
			Attacklab.full = true;

			var defaultButtons = "bold italic link blockquote code image attachment ol ul heading hr";
			Attacklab.wmd_env.buttons = Attacklab.wmd_env.buttons || defaultButtons;
		};
		Attacklab.loadEnv();

	};

	Attacklab.wmd();
	Attacklab.wmdBase();
	Attacklab.Util.startEditor();
};

/*
 * jQuery validation plug-in 1.7
 *
 * http://bassistance.de/jquery-plugins/jquery-plugin-validation/
 * http://docs.jquery.com/Plugins/Validation
 *
 * Copyright (c) 2006 - 2008 Jrn Zaefferer
 *
 * $Id: jquery.validate.js 6403 2009-06-17 14:27:16Z joern.zaefferer $
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 */
(function($){$.extend($.fn,{validate:function(options){if(!this.length){options&&options.debug&&window.console&&console.warn("nothing selected, can't validate, returning nothing");return;}var validator=$.data(this[0],'validator');if(validator){return validator;}validator=new $.validator(options,this[0]);$.data(this[0],'validator',validator);if(validator.settings.onsubmit){this.find("input, button").filter(".cancel").click(function(){validator.cancelSubmit=true;});if(validator.settings.submitHandler){this.find("input, button").filter(":submit").click(function(){validator.submitButton=this;});}this.submit(function(event){if(validator.settings.debug)event.preventDefault();function handle(){if(validator.settings.submitHandler){if(validator.submitButton){var hidden=$("<input type='hidden'/>").attr("name",validator.submitButton.name).val(validator.submitButton.value).appendTo(validator.currentForm);}validator.settings.submitHandler.call(validator,validator.currentForm);if(validator.submitButton){hidden.remove();}return false;}return true;}if(validator.cancelSubmit){validator.cancelSubmit=false;return handle();}if(validator.form()){if(validator.pendingRequest){validator.formSubmitted=true;return false;}return handle();}else{validator.focusInvalid();return false;}});}return validator;},valid:function(){if($(this[0]).is('form')){return this.validate().form();}else{var valid=true;var validator=$(this[0].form).validate();this.each(function(){valid&=validator.element(this);});return valid;}},removeAttrs:function(attributes){var result={},$element=this;$.each(attributes.split(/\s/),function(index,value){result[value]=$element.attr(value);$element.removeAttr(value);});return result;},rules:function(command,argument){var element=this[0];if(command){var settings=$.data(element.form,'validator').settings;var staticRules=settings.rules;var existingRules=$.validator.staticRules(element);switch(command){case"add":$.extend(existingRules,$.validator.normalizeRule(argument));staticRules[element.name]=existingRules;if(argument.messages)settings.messages[element.name]=$.extend(settings.messages[element.name],argument.messages);break;case"remove":if(!argument){delete staticRules[element.name];return existingRules;}var filtered={};$.each(argument.split(/\s/),function(index,method){filtered[method]=existingRules[method];delete existingRules[method];});return filtered;}}var data=$.validator.normalizeRules($.extend({},$.validator.metadataRules(element),$.validator.classRules(element),$.validator.attributeRules(element),$.validator.staticRules(element)),element);if(data.required){var param=data.required;delete data.required;data=$.extend({required:param},data);}return data;}});$.extend($.expr[":"],{blank:function(a){return!$.trim(""+a.value);},filled:function(a){return!!$.trim(""+a.value);},unchecked:function(a){return!a.checked;}});$.validator=function(options,form){this.settings=$.extend(true,{},$.validator.defaults,options);this.currentForm=form;this.init();};$.validator.format=function(source,params){if(arguments.length==1)return function(){var args=$.makeArray(arguments);args.unshift(source);return $.validator.format.apply(this,args);};if(arguments.length>2&&params.constructor!=Array){params=$.makeArray(arguments).slice(1);}if(params.constructor!=Array){params=[params];}$.each(params,function(i,n){source=source.replace(new RegExp("\\{"+i+"\\}","g"),n);});return source;};$.extend($.validator,{defaults:{messages:{},groups:{},rules:{},errorClass:"error",validClass:"valid",errorElement:"label",focusInvalid:true,errorContainer:$([]),errorLabelContainer:$([]),onsubmit:true,ignore:[],ignoreTitle:false,onfocusin:function(element){this.lastActive=element;if(this.settings.focusCleanup&&!this.blockFocusCleanup){this.settings.unhighlight&&this.settings.unhighlight.call(this,element,this.settings.errorClass,this.settings.validClass);this.errorsFor(element).hide();}},onfocusout:function(element){if(!this.checkable(element)&&(element.name in this.submitted||!this.optional(element))){this.element(element);}},onkeyup:function(element){if(element.name in this.submitted||element==this.lastElement){this.element(element);}},onclick:function(element){if(element.name in this.submitted)this.element(element);else if(element.parentNode.name in this.submitted)this.element(element.parentNode);},highlight:function(element,errorClass,validClass){$(element).addClass(errorClass).removeClass(validClass);},unhighlight:function(element,errorClass,validClass){$(element).removeClass(errorClass).addClass(validClass);}},setDefaults:function(settings){$.extend($.validator.defaults,settings);},messages:{required:"This field is required.",remote:"Please fix this field.",email:"Please enter a valid email address.",url:"Please enter a valid URL.",date:"Please enter a valid date.",dateISO:"Please enter a valid date (ISO).",number:"Please enter a valid number.",digits:"Please enter only digits.",creditcard:"Please enter a valid credit card number.",equalTo:"Please enter the same value again.",accept:"Please enter a value with a valid extension.",maxlength:$.validator.format("Please enter no more than {0} characters."),minlength:$.validator.format("Please enter at least {0} characters."),rangelength:$.validator.format("Please enter a value between {0} and {1} characters long."),range:$.validator.format("Please enter a value between {0} and {1}."),max:$.validator.format("Please enter a value less than or equal to {0}."),min:$.validator.format("Please enter a value greater than or equal to {0}.")},autoCreateRanges:false,prototype:{init:function(){this.labelContainer=$(this.settings.errorLabelContainer);this.errorContext=this.labelContainer.length&&this.labelContainer||$(this.currentForm);this.containers=$(this.settings.errorContainer).add(this.settings.errorLabelContainer);this.submitted={};this.valueCache={};this.pendingRequest=0;this.pending={};this.invalid={};this.reset();var groups=(this.groups={});$.each(this.settings.groups,function(key,value){$.each(value.split(/\s/),function(index,name){groups[name]=key;});});var rules=this.settings.rules;$.each(rules,function(key,value){rules[key]=$.validator.normalizeRule(value);});function delegate(event){var validator=$.data(this[0].form,"validator"),eventType="on"+event.type.replace(/^validate/,"");validator.settings[eventType]&&validator.settings[eventType].call(validator,this[0]);}$(this.currentForm).validateDelegate(":text, :password, :file, select, textarea","focusin focusout keyup",delegate).validateDelegate(":radio, :checkbox, select, option","click",delegate);if(this.settings.invalidHandler)$(this.currentForm).bind("invalid-form.validate",this.settings.invalidHandler);},form:function(){this.checkForm();$.extend(this.submitted,this.errorMap);this.invalid=$.extend({},this.errorMap);if(!this.valid())$(this.currentForm).triggerHandler("invalid-form",[this]);this.showErrors();return this.valid();},checkForm:function(){this.prepareForm();for(var i=0,elements=(this.currentElements=this.elements());elements[i];i++){this.check(elements[i]);}return this.valid();},element:function(element){element=this.clean(element);this.lastElement=element;this.prepareElement(element);this.currentElements=$(element);var result=this.check(element);if(result){delete this.invalid[element.name];}else{this.invalid[element.name]=true;}if(!this.numberOfInvalids()){this.toHide=this.toHide.add(this.containers);}this.showErrors();return result;},showErrors:function(errors){if(errors){$.extend(this.errorMap,errors);this.errorList=[];for(var name in errors){this.errorList.push({message:errors[name],element:this.findByName(name)[0]});}this.successList=$.grep(this.successList,function(element){return!(element.name in errors);});}this.settings.showErrors?this.settings.showErrors.call(this,this.errorMap,this.errorList):this.defaultShowErrors();},resetForm:function(){if($.fn.resetForm)$(this.currentForm).resetForm();this.submitted={};this.prepareForm();this.hideErrors();this.elements().removeClass(this.settings.errorClass);},numberOfInvalids:function(){return this.objectLength(this.invalid);},objectLength:function(obj){var count=0;for(var i in obj)count++;return count;},hideErrors:function(){this.addWrapper(this.toHide).hide();},valid:function(){return this.size()==0;},size:function(){return this.errorList.length;},focusInvalid:function(){if(this.settings.focusInvalid){try{$(this.findLastActive()||this.errorList.length&&this.errorList[0].element||[]).filter(":visible").focus().trigger("focusin");}catch(e){}}},findLastActive:function(){var lastActive=this.lastActive;return lastActive&&$.grep(this.errorList,function(n){return n.element.name==lastActive.name;}).length==1&&lastActive;},elements:function(){var validator=this,rulesCache={};return $([]).add(this.currentForm.elements).filter(":input").not(":submit, :reset, :image, [disabled]").not(this.settings.ignore).filter(function(){!this.name&&validator.settings.debug&&window.console&&console.error("%o has no name assigned",this);if(this.name in rulesCache||!validator.objectLength($(this).rules()))return false;rulesCache[this.name]=true;return true;});},clean:function(selector){return $(selector)[0];},errors:function(){return $(this.settings.errorElement+"."+this.settings.errorClass,this.errorContext);},reset:function(){this.successList=[];this.errorList=[];this.errorMap={};this.toShow=$([]);this.toHide=$([]);this.currentElements=$([]);},prepareForm:function(){this.reset();this.toHide=this.errors().add(this.containers);},prepareElement:function(element){this.reset();this.toHide=this.errorsFor(element);},check:function(element){element=this.clean(element);if(this.checkable(element)){element=this.findByName(element.name)[0];}var rules=$(element).rules();var dependencyMismatch=false;for(method in rules){var rule={method:method,parameters:rules[method]};try{var result=$.validator.methods[method].call(this,element.value.replace(/\r/g,""),element,rule.parameters);if(result=="dependency-mismatch"){dependencyMismatch=true;continue;}dependencyMismatch=false;if(result=="pending"){this.toHide=this.toHide.not(this.errorsFor(element));return;}if(!result){this.formatAndAdd(element,rule);return false;}}catch(e){this.settings.debug&&window.console&&console.log("exception occured when checking element "+element.id
+", check the '"+rule.method+"' method",e);throw e;}}if(dependencyMismatch)return;if(this.objectLength(rules))this.successList.push(element);return true;},customMetaMessage:function(element,method){if(!$.metadata)return;var meta=this.settings.meta?$(element).metadata()[this.settings.meta]:$(element).metadata();return meta&&meta.messages&&meta.messages[method];},customMessage:function(name,method){var m=this.settings.messages[name];return m&&(m.constructor==String?m:m[method]);},findDefined:function(){for(var i=0;i<arguments.length;i++){if(arguments[i]!==undefined)return arguments[i];}return undefined;},defaultMessage:function(element,method){return this.findDefined(this.customMessage(element.name,method),this.customMetaMessage(element,method),!this.settings.ignoreTitle&&element.title||undefined,$.validator.messages[method],"<strong>Warning: No message defined for "+element.name+"</strong>");},formatAndAdd:function(element,rule){var message=this.defaultMessage(element,rule.method),theregex=/\$?\{(\d+)\}/g;if(typeof message=="function"){message=message.call(this,rule.parameters,element);}else if(theregex.test(message)){message=jQuery.format(message.replace(theregex,'{$1}'),rule.parameters);}this.errorList.push({message:message,element:element});this.errorMap[element.name]=message;this.submitted[element.name]=message;},addWrapper:function(toToggle){if(this.settings.wrapper)toToggle=toToggle.add(toToggle.parent(this.settings.wrapper));return toToggle;},defaultShowErrors:function(){for(var i=0;this.errorList[i];i++){var error=this.errorList[i];this.settings.highlight&&this.settings.highlight.call(this,error.element,this.settings.errorClass,this.settings.validClass);this.showLabel(error.element,error.message);}if(this.errorList.length){this.toShow=this.toShow.add(this.containers);}if(this.settings.success){for(var i=0;this.successList[i];i++){this.showLabel(this.successList[i]);}}if(this.settings.unhighlight){for(var i=0,elements=this.validElements();elements[i];i++){this.settings.unhighlight.call(this,elements[i],this.settings.errorClass,this.settings.validClass);}}this.toHide=this.toHide.not(this.toShow);this.hideErrors();this.addWrapper(this.toShow).show();},validElements:function(){return this.currentElements.not(this.invalidElements());},invalidElements:function(){return $(this.errorList).map(function(){return this.element;});},showLabel:function(element,message){var label=this.errorsFor(element);if(label.length){label.removeClass().addClass(this.settings.errorClass);label.attr("generated")&&label.html(message);}else{label=$("<"+this.settings.errorElement+"/>").attr({"for":this.idOrName(element),generated:true}).addClass(this.settings.errorClass).html(message||"");if(this.settings.wrapper){label=label.hide().show().wrap("<"+this.settings.wrapper+"/>").parent();}if(!this.labelContainer.append(label).length)this.settings.errorPlacement?this.settings.errorPlacement(label,$(element)):label.insertAfter(element);}if(!message&&this.settings.success){label.text("");typeof this.settings.success=="string"?label.addClass(this.settings.success):this.settings.success(label);}this.toShow=this.toShow.add(label);},errorsFor:function(element){var name=this.idOrName(element);return this.errors().filter(function(){return $(this).attr('for')==name;});},idOrName:function(element){return this.groups[element.name]||(this.checkable(element)?element.name:element.id||element.name);},checkable:function(element){return/radio|checkbox/i.test(element.type);},findByName:function(name){var form=this.currentForm;return $(document.getElementsByName(name)).map(function(index,element){return element.form==form&&element.name==name&&element||null;});},getLength:function(value,element){switch(element.nodeName.toLowerCase()){case'select':return $("option:selected",element).length;case'input':if(this.checkable(element))return this.findByName(element.name).filter(':checked').length;}return value.length;},depend:function(param,element){return this.dependTypes[typeof param]?this.dependTypes[typeof param](param,element):true;},dependTypes:{"boolean":function(param,element){return param;},"string":function(param,element){return!!$(param,element.form).length;},"function":function(param,element){return param(element);}},optional:function(element){return!$.validator.methods.required.call(this,$.trim(element.value),element)&&"dependency-mismatch";},startRequest:function(element){if(!this.pending[element.name]){this.pendingRequest++;this.pending[element.name]=true;}},stopRequest:function(element,valid){this.pendingRequest--;if(this.pendingRequest<0)this.pendingRequest=0;delete this.pending[element.name];if(valid&&this.pendingRequest==0&&this.formSubmitted&&this.form()){$(this.currentForm).submit();this.formSubmitted=false;}else if(!valid&&this.pendingRequest==0&&this.formSubmitted){$(this.currentForm).triggerHandler("invalid-form",[this]);this.formSubmitted=false;}},previousValue:function(element){return $.data(element,"previousValue")||$.data(element,"previousValue",{old:null,valid:true,message:this.defaultMessage(element,"remote")});}},classRuleSettings:{required:{required:true},email:{email:true},url:{url:true},date:{date:true},dateISO:{dateISO:true},dateDE:{dateDE:true},number:{number:true},numberDE:{numberDE:true},digits:{digits:true},creditcard:{creditcard:true}},addClassRules:function(className,rules){className.constructor==String?this.classRuleSettings[className]=rules:$.extend(this.classRuleSettings,className);},classRules:function(element){var rules={};var classes=$(element).attr('class');classes&&$.each(classes.split(' '),function(){if(this in $.validator.classRuleSettings){$.extend(rules,$.validator.classRuleSettings[this]);}});return rules;},attributeRules:function(element){var rules={};var $element=$(element);for(method in $.validator.methods){var value=$element.attr(method);if(value){rules[method]=value;}}if(rules.maxlength&&/-1|2147483647|524288/.test(rules.maxlength)){delete rules.maxlength;}return rules;},metadataRules:function(element){if(!$.metadata)return{};var meta=$.data(element.form,'validator').settings.meta;return meta?$(element).metadata()[meta]:$(element).metadata();},staticRules:function(element){var rules={};var validator=$.data(element.form,'validator');if(validator.settings.rules){rules=$.validator.normalizeRule(validator.settings.rules[element.name])||{};}return rules;},normalizeRules:function(rules,element){$.each(rules,function(prop,val){if(val===false){delete rules[prop];return;}if(val.param||val.depends){var keepRule=true;switch(typeof val.depends){case"string":keepRule=!!$(val.depends,element.form).length;break;case"function":keepRule=val.depends.call(element,element);break;}if(keepRule){rules[prop]=val.param!==undefined?val.param:true;}else{delete rules[prop];}}});$.each(rules,function(rule,parameter){rules[rule]=$.isFunction(parameter)?parameter(element):parameter;});$.each(['minlength','maxlength','min','max'],function(){if(rules[this]){rules[this]=Number(rules[this]);}});$.each(['rangelength','range'],function(){if(rules[this]){rules[this]=[Number(rules[this][0]),Number(rules[this][1])];}});if($.validator.autoCreateRanges){if(rules.min&&rules.max){rules.range=[rules.min,rules.max];delete rules.min;delete rules.max;}if(rules.minlength&&rules.maxlength){rules.rangelength=[rules.minlength,rules.maxlength];delete rules.minlength;delete rules.maxlength;}}if(rules.messages){delete rules.messages;}return rules;},normalizeRule:function(data){if(typeof data=="string"){var transformed={};$.each(data.split(/\s/),function(){transformed[this]=true;});data=transformed;}return data;},addMethod:function(name,method,message){$.validator.methods[name]=method;$.validator.messages[name]=message!=undefined?message:$.validator.messages[name];if(method.length<3){$.validator.addClassRules(name,$.validator.normalizeRule(name));}},methods:{required:function(value,element,param){if(!this.depend(param,element))return"dependency-mismatch";switch(element.nodeName.toLowerCase()){case'select':var val=$(element).val();return val&&val.length>0;case'input':if(this.checkable(element))return this.getLength(value,element)>0;default:return $.trim(value).length>0;}},remote:function(value,element,param){if(this.optional(element))return"dependency-mismatch";var previous=this.previousValue(element);if(!this.settings.messages[element.name])this.settings.messages[element.name]={};previous.originalMessage=this.settings.messages[element.name].remote;this.settings.messages[element.name].remote=previous.message;param=typeof param=="string"&&{url:param}||param;if(previous.old!==value){previous.old=value;var validator=this;this.startRequest(element);var data={};data[element.name]=value;$.ajax($.extend(true,{url:param,mode:"abort",port:"validate"+element.name,dataType:"json",data:data,success:function(response){validator.settings.messages[element.name].remote=previous.originalMessage;var valid=response===true;if(valid){var submitted=validator.formSubmitted;validator.prepareElement(element);validator.formSubmitted=submitted;validator.successList.push(element);validator.showErrors();}else{var errors={};var message=(previous.message=response||validator.defaultMessage(element,"remote"));errors[element.name]=$.isFunction(message)?message(value):message;validator.showErrors(errors);}previous.valid=valid;validator.stopRequest(element,valid);}},param));return"pending";}else if(this.pending[element.name]){return"pending";}return previous.valid;},minlength:function(value,element,param){return this.optional(element)||this.getLength($.trim(value),element)>=param;},maxlength:function(value,element,param){return this.optional(element)||this.getLength($.trim(value),element)<=param;},rangelength:function(value,element,param){var length=this.getLength($.trim(value),element);return this.optional(element)||(length>=param[0]&&length<=param[1]);},min:function(value,element,param){return this.optional(element)||value>=param;},max:function(value,element,param){return this.optional(element)||value<=param;},range:function(value,element,param){return this.optional(element)||(value>=param[0]&&value<=param[1]);},email:function(value,element){return this.optional(element)||/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i.test(value);},url:function(value,element){return this.optional(element)||/^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(value);},date:function(value,element){return this.optional(element)||!/Invalid|NaN/.test(new Date(value));},dateISO:function(value,element){return this.optional(element)||/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}$/.test(value);},number:function(value,element){return this.optional(element)||/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/.test(value);},digits:function(value,element){return this.optional(element)||/^\d+$/.test(value);},creditcard:function(value,element){if(this.optional(element))return"dependency-mismatch";if(/[^0-9-]+/.test(value))return false;var nCheck=0,nDigit=0,bEven=false;value=value.replace(/\D/g,"");for(var n=value.length-1;n>=0;n--){var cDigit=value.charAt(n);var nDigit=parseInt(cDigit,10);if(bEven){if((nDigit*=2)>9)nDigit-=9;}nCheck+=nDigit;bEven=!bEven;}return(nCheck%10)==0;},accept:function(value,element,param){param=typeof param=="string"?param.replace(/,/g,'|'):"png|jpe?g|gif";return this.optional(element)||value.match(new RegExp(".("+param+")$","i"));},equalTo:function(value,element,param){var target=$(param).unbind(".validate-equalTo").bind("blur.validate-equalTo",function(){$(element).valid();});return value==target.val();}}});$.format=$.validator.format;})(jQuery);;(function($){var ajax=$.ajax;var pendingRequests={};$.ajax=function(settings){settings=$.extend(settings,$.extend({},$.ajaxSettings,settings));var port=settings.port;if(settings.mode=="abort"){if(pendingRequests[port]){pendingRequests[port].abort();}return(pendingRequests[port]=ajax.apply(this,arguments));}return ajax.apply(this,arguments);};})(jQuery);;(function($){if(!jQuery.event.special.focusin&&!jQuery.event.special.focusout&&document.addEventListener){$.each({focus:'focusin',blur:'focusout'},function(original,fix){$.event.special[fix]={setup:function(){this.addEventListener(original,handler,true);},teardown:function(){this.removeEventListener(original,handler,true);},handler:function(e){arguments[0]=$.event.fix(e);arguments[0].type=fix;return $.event.handle.apply(this,arguments);}};function handler(e){e=$.event.fix(e);e.type=fix;return $.event.handle.call(this,e);}});};$.extend($.fn,{validateDelegate:function(delegate,type,handler){return this.bind(type,function(event){var target=$(event.target);if(target.is(delegate)){return handler.apply(target,arguments);}});}});})(jQuery);
/* google prettify.js from google code */
var q=null;window.PR_SHOULD_USE_CONTINUATION=!0;
(function () {function L(a) {function m(a) {var f=a.charCodeAt(0);if(f!==92)return f;var b=a.charAt(1);return(f=r[b])?f:'0'<=b&&b<="7"?parseInt(a.substring(1),8):b==="u"||b==="x"?parseInt(a.substring(2),16):a.charCodeAt(1)}function e(a) {if(a<32)return(a<16?"\\x0":"\\x")+a.toString(16);a=String.fromCharCode(a);if(a==="\\"||a==="-"||a==="["||a==="]")a="\\"+a;return a}function h(a) {for(var f=a.substring(1,a.length-1).match(/\\u[\dA-Fa-f]{4}|\\x[\dA-Fa-f]{2}|\\[0-3][0-7]{0,2}|\\[0-7]{1,2}|\\[\S\s]|[^\\]/g),a=
[],b=[],o=f[0]==="^",c=o?1:0,i=f.length;c<i;++c) {var j=f[c];if(/\\[bdsw]/i.test(j))a.push(j);else{var j=m(j),d;c+2<i&&"-"===f[c+1]?(d=m(f[c+2]),c+=2):d=j;b.push([j,d]);d<65||j>122||(d<65||j>90||b.push([Math.max(65,j)|32,Math.min(d,90)|32]),d<97||j>122||b.push([Math.max(97,j)&-33,Math.min(d,122)&-33]))}}b.sort(function (a,f) {return a[0]-f[0]||f[1]-a[1]});f=[];j=[NaN,NaN];for(c=0;c<b.length;++c)i=b[c],i[0]<=j[1]+1?j[1]=Math.max(j[1],i[1]):f.push(j=i);b=["["];o&&b.push("^");b.push.apply(b,a);for(c=0;c<
f.length;++c)i=f[c],b.push(e(i[0])),i[1]>i[0]&&(i[1]+1>i[0]&&b.push("-"),b.push(e(i[1])));b.push("]");return b.join("")}function y(a) {for(var f=a.source.match(/\[(?:[^\\\]]|\\[\S\s])*]|\\u[\dA-Fa-f]{4}|\\x[\dA-Fa-f]{2}|\\\d+|\\[^\dux]|\(\?[!:=]|[()^]|[^()[\\^]+/g),b=f.length,d=[],c=0,i=0;c<b;++c) {var j=f[c];j==='('?++i:"\\"===j.charAt(0)&&(j=+j.substring(1))&&j<=i&&(d[j]=-1)}for(c=1;c<d.length;++c)-1===d[c]&&(d[c]=++t);for(i=c=0;c<b;++c)j=f[c],j==="("?(++i,d[i]===void 0&&(f[c]="(?:")):"\\"===j.charAt(0)&&
(j=+j.substring(1))&&j<=i&&(f[c]="\\"+d[i]);for(i=c=0;c<b;++c)"^"===f[c]&&"^"!==f[c+1]&&(f[c]="");if(a.ignoreCase&&s)for(c=0;c<b;++c)j=f[c],a=j.charAt(0),j.length>=2&&a==="["?f[c]=h(j):a!=="\\"&&(f[c]=j.replace(/[A-Za-z]/g,function (a) {a=a.charCodeAt(0);return"["+String.fromCharCode(a&-33,a|32)+"]"}));return f.join("")}for(var t=0,s=!1,l=!1,p=0,d=a.length;p<d;++p) {var g=a[p];if(g.ignoreCase)l=!0;else if(/[a-z]/i.test(g.source.replace(/\\u[\da-f]{4}|\\x[\da-f]{2}|\\[^UXux]/gi,""))) {s=!0;l=!1;break}}for(var r=
{b:8,t:9,n:10,v:11,f:12,r:13},n=[],p=0,d=a.length;p<d;++p) {g=a[p];if(g.global||g.multiline)throw Error(""+g);n.push("(?:"+y(g)+')')}return RegExp(n.join("|"),l?"gi":"g")}function M(a) {function m(a) {switch(a.nodeType) {case 1:if(e.test(a.className))break;for(var g=a.firstChild;g;g=g.nextSibling)m(g);g=a.nodeName;if("BR"===g||"LI"===g)h[s]="\n",t[s<<1]=y++,t[s++<<1|1]=a;break;case 3:case 4:g=a.nodeValue,g.length&&(g=p?g.replace(/\r\n?/g,"\n"):g.replace(/[\t\n\r ]+/g," "),h[s]=g,t[s<<1]=y,y+=g.length,
t[s++<<1|1]=a)}}var e=/(?:^|\s)nocode(?:\s|$)/,h=[],y=0,t=[],s=0,l;a.currentStyle?l=a.currentStyle.whiteSpace:window.getComputedStyle&&(l=document.defaultView.getComputedStyle(a,q).getPropertyValue("white-space"));var p=l&&"pre"===l.substring(0,3);m(a);return{a:h.join("").replace(/\n$/,""),c:t}}function B(a,m,e,h) {m&&(a={a:m,d:a},e(a),h.push.apply(h,a.e))}function x(a,m) {function e(a) {for(var l=a.d,p=[l,"pln"],d=0,g=a.a.match(y)||[],r={},n=0,z=g.length;n<z;++n) {var f=g[n],b=r[f],o=void 0,c;if(typeof b===
"string")c=!1;else{var i=h[f.charAt(0)];if(i)o=f.match(i[1]),b=i[0];else{for(c=0;c<t;++c)if(i=m[c],o=f.match(i[1])) {b=i[0];break}o||(b="pln")}if((c=b.length>=5&&"lang-"===b.substring(0,5))&&!(o&&typeof o[1]==="string"))c=!1,b="src";c||(r[f]=b)}i=d;d+=f.length;if(c) {c=o[1];var j=f.indexOf(c),k=j+c.length;o[2]&&(k=f.length-o[2].length,j=k-c.length);b=b.substring(5);B(l+i,f.substring(0,j),e,p);B(l+i+j,c,C(b,c),p);B(l+i+k,f.substring(k),e,p)}else p.push(l+i,b)}a.e=p}var h={},y;(function () {for(var e=a.concat(m),
l=[],p={},d=0,g=e.length;d<g;++d) {var r=e[d],n=r[3];if(n)for(var k=n.length;--k>=0;)h[n.charAt(k)]=r;r=r[1];n=""+r;p.hasOwnProperty(n)||(l.push(r),p[n]=q)}l.push(/[\S\s]/);y=L(l)})();var t=m.length;return e}function u(a) {var m=[],e=[];a.tripleQuotedStrings?m.push(["str",/^(?:'''(?:[^'\\]|\\[\S\s]|''?(?=[^']))*(?:'''|$)|"""(?:[^"\\]|\\[\S\s]|""?(?=[^"]))*(?:"""|$)|'(?:[^'\\]|\\[\S\s])*(?:'|$)|"(?:[^"\\]|\\[\S\s])*(?:"|$))/,q,"'\""]):a.multiLineStrings?m.push(["str",/^(?:'(?:[^'\\]|\\[\S\s])*(?:'|$)|"(?:[^"\\]|\\[\S\s])*(?:"|$)|`(?:[^\\`]|\\[\S\s])*(?:`|$))/,
q,"'\"`"]):m.push(["str",/^(?:'(?:[^\n\r'\\]|\\.)*(?:'|$)|"(?:[^\n\r"\\]|\\.)*(?:"|$))/,q,"\"'"]);a.verbatimStrings&&e.push(["str",/^@"(?:[^"]|"")*(?:"|$)/,q]);var h=a.hashComments;h&&(a.cStyleComments?(h>1?m.push(["com",/^#(?:##(?:[^#]|#(?!##))*(?:###|$)|.*)/,q,"#"]):m.push(["com",/^#(?:(?:define|elif|else|endif|error|ifdef|include|ifndef|line|pragma|undef|warning)\b|[^\n\r]*)/,q,"#"]),e.push(["str",/^<(?:(?:(?:\.\.\/)*|\/?)(?:[\w-]+(?:\/[\w-]+)+)?[\w-]+\.h|[a-z]\w*)>/,q])):m.push(["com",/^#[^\n\r]*/,
q,"#"]));a.cStyleComments&&(e.push(["com",/^\/\/[^\n\r]*/,q]),e.push(["com",/^\/\*[\S\s]*?(?:\*\/|$)/,q]));a.regexLiterals&&e.push(["lang-regex",/^(?:^^\.?|[!+-]|!=|!==|#|%|%=|&|&&|&&=|&=|\(|\*|\*=|\+=|,|-=|->|\/|\/=|:|::|;|<|<<|<<=|<=|=|==|===|>|>=|>>|>>=|>>>|>>>=|[?@[^]|\^=|\^\^|\^\^=|{|\||\|=|\|\||\|\|=|~|break|case|continue|delete|do|else|finally|instanceof|return|throw|try|typeof)\s*(\/(?=[^*/])(?:[^/[\\]|\\[\S\s]|\[(?:[^\\\]]|\\[\S\s])*(?:]|$))+\/)/]);(h=a.types)&&e.push(["typ",h]);a=(""+a.keywords).replace(/^ | $/g,
"");a.length&&e.push(["kwd",RegExp("^(?:"+a.replace(/[\s,]+/g,"|")+")\\b"),q]);m.push(["pln",/^\s+/,q," \r\n\t\xa0"]);e.push(["lit",/^@[$_a-z][\w$@]*/i,q],["typ",/^(?:[@_]?[A-Z]+[a-z][\w$@]*|\w+_t\b)/,q],["pln",/^[$_a-z][\w$@]*/i,q],["lit",/^(?:0x[\da-f]+|(?:\d(?:_\d+)*\d*(?:\.\d*)?|\.\d\+)(?:e[+-]?\d+)?)[a-z]*/i,q,"0123456789"],["pln",/^\\[\S\s]?/,q],["pun",/^.[^\s\w"-$'./@\\`]*/,q]);return x(m,e)}function D(a,m) {function e(a) {switch(a.nodeType) {case 1:if(k.test(a.className))break;if("BR"===a.nodeName)h(a),
a.parentNode&&a.parentNode.removeChild(a);else for(a=a.firstChild;a;a=a.nextSibling)e(a);break;case 3:case 4:if(p) {var b=a.nodeValue,d=b.match(t);if(d) {var c=b.substring(0,d.index);a.nodeValue=c;(b=b.substring(d.index+d[0].length))&&a.parentNode.insertBefore(s.createTextNode(b),a.nextSibling);h(a);c||a.parentNode.removeChild(a)}}}}function h(a) {function b(a,d) {var e=d?a.cloneNode(!1):a,f=a.parentNode;if(f) {var f=b(f,1),g=a.nextSibling;f.appendChild(e);for(var h=g;h;h=g)g=h.nextSibling,f.appendChild(h)}return e}
for(;!a.nextSibling;)if(a=a.parentNode,!a)return;for(var a=b(a.nextSibling,0),e;(e=a.parentNode)&&e.nodeType===1;)a=e;d.push(a)}var k=/(?:^|\s)nocode(?:\s|$)/,t=/\r\n?|\n/,s=a.ownerDocument,l;a.currentStyle?l=a.currentStyle.whiteSpace:window.getComputedStyle&&(l=s.defaultView.getComputedStyle(a,q).getPropertyValue("white-space"));var p=l&&"pre"===l.substring(0,3);for(l=s.createElement("LI");a.firstChild;)l.appendChild(a.firstChild);for(var d=[l],g=0;g<d.length;++g)e(d[g]);m===(m|0)&&d[0].setAttribute("value",
m);var r=s.createElement("OL");r.className="linenums";for(var n=Math.max(0,m-1|0)||0,g=0,z=d.length;g<z;++g)l=d[g],l.className="L"+(g+n)%10,l.firstChild||l.appendChild(s.createTextNode("\xa0")),r.appendChild(l);a.appendChild(r)}function k(a,m) {for(var e=m.length;--e>=0;) {var h=m[e];A.hasOwnProperty(h)?window.console&&console.warn("cannot override language handler %s",h):A[h]=a}}function C(a,m) {if(!a||!A.hasOwnProperty(a))a=/^\s*</.test(m)?"default-markup":"default-code";return A[a]}function E(a) {var m=
a.g;try{var e=M(a.h),h=e.a;a.a=h;a.c=e.c;a.d=0;C(m,h)(a);var k=/\bMSIE\b/.test(navigator.userAgent),m=/\n/g,t=a.a,s=t.length,e=0,l=a.c,p=l.length,h=0,d=a.e,g=d.length,a=0;d[g]=s;var r,n;for(n=r=0;n<g;)d[n]!==d[n+2]?(d[r++]=d[n++],d[r++]=d[n++]):n+=2;g=r;for(n=r=0;n<g;) {for(var z=d[n],f=d[n+1],b=n+2;b+2<=g&&d[b+1]===f;)b+=2;d[r++]=z;d[r++]=f;n=b}for(d.length=r;h<p;) {var o=l[h+2]||s,c=d[a+2]||s,b=Math.min(o,c),i=l[h+1],j;if(i.nodeType!==1&&(j=t.substring(e,b))) {k&&(j=j.replace(m,"\r"));i.nodeValue=
j;var u=i.ownerDocument,v=u.createElement("SPAN");v.className=d[a+1];var x=i.parentNode;x.replaceChild(v,i);v.appendChild(i);e<o&&(l[h+1]=i=u.createTextNode(t.substring(b,o)),x.insertBefore(i,v.nextSibling))}e=b;e>=o&&(h+=2);e>=c&&(a+=2)}}catch(w) {"console"in window&&console.log(w&&w.stack?w.stack:w)}}var v=["break,continue,do,else,for,if,return,while"],w=[[v,"auto,case,char,const,default,double,enum,extern,float,goto,int,long,register,short,signed,sizeof,static,struct,switch,typedef,union,unsigned,void,volatile"],
"catch,class,delete,false,import,new,operator,private,protected,public,this,throw,true,try,typeof"],F=[w,"alignof,align_union,asm,axiom,bool,concept,concept_map,const_cast,constexpr,decltype,dynamic_cast,explicit,export,friend,inline,late_check,mutable,namespace,nullptr,reinterpret_cast,static_assert,static_cast,template,typeid,typename,using,virtual,where"],G=[w,"abstract,boolean,byte,extends,final,finally,implements,import,instanceof,null,native,package,strictfp,super,synchronized,throws,transient"],
H=[G,"as,base,by,checked,decimal,delegate,descending,dynamic,event,fixed,foreach,from,group,implicit,in,interface,internal,into,is,lock,object,out,override,orderby,params,partial,readonly,ref,sbyte,sealed,stackalloc,string,select,uint,ulong,unchecked,unsafe,ushort,var"],w=[w,"debugger,eval,export,function,get,null,set,undefined,var,with,Infinity,NaN"],I=[v,"and,as,assert,class,def,del,elif,except,exec,finally,from,global,import,in,is,lambda,nonlocal,not,or,pass,print,raise,try,with,yield,False,True,None"],
J=[v,"alias,and,begin,case,class,def,defined,elsif,end,ensure,false,in,module,next,nil,not,or,redo,rescue,retry,self,super,then,true,undef,unless,until,when,yield,BEGIN,END"],v=[v,"case,done,elif,esac,eval,fi,function,in,local,set,then,until"],K=/^(DIR|FILE|vector|(de|priority_)?queue|list|stack|(const_)?iterator|(multi)?(set|map)|bitset|u?(int|float)\d*)/,N=/\S/,O=u({keywords:[F,H,w,"caller,delete,die,do,dump,elsif,eval,exit,foreach,for,goto,if,import,last,local,my,next,no,our,print,package,redo,require,sub,undef,unless,until,use,wantarray,while,BEGIN,END"+
I,J,v],hashComments:!0,cStyleComments:!0,multiLineStrings:!0,regexLiterals:!0}),A={};k(O,["default-code"]);k(x([],[["pln",/^[^<?]+/],["dec",/^<!\w[^>]*(?:>|$)/],["com",/^<\!--[\S\s]*?(?:--\>|$)/],["lang-",/^<\?([\S\s]+?)(?:\?>|$)/],["lang-",/^<%([\S\s]+?)(?:%>|$)/],["pun",/^(?:<[%?]|[%?]>)/],["lang-",/^<xmp\b[^>]*>([\S\s]+?)<\/xmp\b[^>]*>/i],["lang-js",/^<script\b[^>]*>([\S\s]*?)(<\/script\b[^>]*>)/i],["lang-css",/^<style\b[^>]*>([\S\s]*?)(<\/style\b[^>]*>)/i],["lang-in.tag",/^(<\/?[a-z][^<>]*>)/i]]),
["default-markup","htm","html","mxml","xhtml","xml","xsl"]);k(x([["pln",/^\s+/,q," \t\r\n"],["atv",/^(?:"[^"]*"?|'[^']*'?)/,q,"\"'"]],[["tag",/^^<\/?[a-z](?:[\w-.:]*\w)?|\/?>$/i],["atn",/^(?!style[\s=]|on)[a-z](?:[\w:-]*\w)?/i],["lang-uq.val",/^=\s*([^\s"'>]*(?:[^\s"'/>]|\/(?=\s)))/],["pun",/^[/<->]+/],["lang-js",/^on\w+\s*=\s*"([^"]+)"/i],["lang-js",/^on\w+\s*=\s*'([^']+)'/i],["lang-js",/^on\w+\s*=\s*([^\s"'>]+)/i],["lang-css",/^style\s*=\s*"([^"]+)"/i],["lang-css",/^style\s*=\s*'([^']+)'/i],["lang-css",
/^style\s*=\s*([^\s"'>]+)/i]]),["in.tag"]);k(x([],[["atv",/^[\S\s]+/]]),["uq.val"]);k(u({keywords:F,hashComments:!0,cStyleComments:!0,types:K}),["c","cc","cpp","cxx","cyc","m"]);k(u({keywords:"null,true,false"}),["json"]);k(u({keywords:H,hashComments:!0,cStyleComments:!0,verbatimStrings:!0,types:K}),["cs"]);k(u({keywords:G,cStyleComments:!0}),["java"]);k(u({keywords:v,hashComments:!0,multiLineStrings:!0}),["bsh","csh","sh"]);k(u({keywords:I,hashComments:!0,multiLineStrings:!0,tripleQuotedStrings:!0}),
["cv","py"]);k(u({keywords:"caller,delete,die,do,dump,elsif,eval,exit,foreach,for,goto,if,import,last,local,my,next,no,our,print,package,redo,require,sub,undef,unless,until,use,wantarray,while,BEGIN,END",hashComments:!0,multiLineStrings:!0,regexLiterals:!0}),["perl","pl","pm"]);k(u({keywords:J,hashComments:!0,multiLineStrings:!0,regexLiterals:!0}),["rb"]);k(u({keywords:w,cStyleComments:!0,regexLiterals:!0}),["js"]);k(u({keywords:"all,and,by,catch,class,else,extends,false,finally,for,if,in,is,isnt,loop,new,no,not,null,of,off,on,or,return,super,then,true,try,unless,until,when,while,yes",
hashComments:3,cStyleComments:!0,multilineStrings:!0,tripleQuotedStrings:!0,regexLiterals:!0}),["coffee"]);k(x([],[["str",/^[\S\s]+/]]),["regex"]);window.prettyPrintOne=function (a,m,e) {var h=document.createElement("PRE");h.innerHTML=a;e&&D(h,e);E({g:m,i:e,h:h});return h.innerHTML};window.prettyPrint=function (a) {function m() {for(var e=window.PR_SHOULD_USE_CONTINUATION?l.now()+250:Infinity;p<h.length&&l.now()<e;p++) {var n=h[p],k=n.className;if(k.indexOf("prettyprint")>=0) {var k=k.match(g),f,b;if(b=
!k) {b=n;for(var o=void 0,c=b.firstChild;c;c=c.nextSibling)var i=c.nodeType,o=i===1?o?b:c:i===3?N.test(c.nodeValue)?b:o:o;b=(f=o===b?void 0:o)&&"CODE"===f.tagName}b&&(k=f.className.match(g));k&&(k=k[1]);b=!1;for(o=n.parentNode;o;o=o.parentNode)if((o.tagName==="pre"||o.tagName==="code"||o.tagName==="xmp")&&o.className&&o.className.indexOf("prettyprint")>=0) {b=!0;break}b||((b=(b=n.className.match(/\blinenums\b(?::(\d+))?/))?b[1]&&b[1].length?+b[1]:!0:!1)&&D(n,b),d={g:k,h:n,i:b},E(d))}}p<h.length?setTimeout(m,
250):a&&a()}for(var e=[document.getElementsByTagName("pre"),document.getElementsByTagName("code"),document.getElementsByTagName("xmp")],h=[],k=0;k<e.length;++k)for(var t=0,s=e[k].length;t<s;++t)h.push(e[k][t]);var e=q,l=Date;l.now||(l={now:function () {return+new Date}});var p=0,d,g=/\blang(?:uage)?-([\w.]+)(?!\S)/;m()};window.PR={createSimpleLexer:x,registerLangHandler:k,sourceDecorator:u,PR_ATTRIB_NAME:"atn",PR_ATTRIB_VALUE:"atv",PR_COMMENT:"com",PR_DECLARATION:"dec",PR_KEYWORD:"kwd",PR_LITERAL:"lit",
PR_NOCODE:"nocode",PR_PLAIN:"pln",PR_PUNCTUATION:"pun",PR_SOURCE:"src",PR_STRING:"str",PR_TAG:"tag",PR_TYPE:"typ"}})();

var Toggle = function() {
    this._state = 'off-state';
    this._messages = {};
    this._states = [
        'on-state',
        'off-state',
        'on-prompt',
        'off-prompt'
    ];
};
inherits(Toggle, SimpleControl);

Toggle.prototype.resetStyles = function () {
    var element = this._element;
    var states = this._states;
    $.each(states, function (idx, state) {
        element.removeClass(state);
    });
    this.setText('');
};

Toggle.prototype.isOn = function () {
    return this._element.data('isOn');
};

Toggle.prototype.isCheckBox = function () {
    var element = this._element;
    return element.attr('type') === 'checkbox';
};

Toggle.prototype.setState = function (state) {
    var element = this._element;
    var oldState = this._state;
    this._state = state;
    if (element) {
        this.resetStyles();
        element.addClass(state);
        if (state === 'on-state') {
            element.data('isOn', true);
        } else if (state === 'off-state') {
            element.data('isOn', false);
        }
        if (this.isCheckBox()) {
            if (state === 'on-state') {
                element.attr('checked', true);
            } else if (state === 'off-state') {
                element.attr('checked', false);
            }
        } else {
            this.setText(this._messages[state]);
        }
        this._element.trigger(
            'askbot.Toggle.stateChange',
            {'oldState': oldState, 'newState': state}
        );
    }
};

Toggle.prototype.toggleState = function () {
    if (this.isOn()) {
        this.setState('off-state');
    } else {
        this.setState('on-state');
    }
};

Toggle.prototype.setText = function (text) {
    var btnText = this._element.find('.js-btn-text');
    var where  = btnText.length ? btnText : this._element;
    where.html(text);
};

Toggle.prototype.setMessages = function(messages) {
    $.extend(this._messages, messages);
};

Toggle.prototype.setMessage = function(state, text) {
    this._messages[state] = text;
};

Toggle.prototype.createDom = function () {
    //limitation is that we make a div with createDom
    var element = this.makeElement('div');
    this._element = element;

    var messages = this._messages || {};

    messages['on-state'] = messages['on-state'] || gettext('enabled');
    messages['off-state'] = messages['off-state'] || gettext('disabled');

    element.data('onStateText', messages['on-state']);
    element.data('offStateText', messages['off-state']);
    element.data('onPromptText', messages['on-prompt'] || messages['off-state']);
    element.data('offPromptText', messages['off-prompt'] || messages['on-state']);

    this.decorate(element);
};

Toggle.prototype.decorate = function (element) {
    this._element = element;
    //read messages for all states
    var messages = {};
    messages['on-state'] = element.data('onStateText') || gettext('enabled');
    messages['off-state'] = element.data('offStateText') || gettext('disabled');
    messages['on-prompt'] = element.data('onPromptText') || messages['off-state'];
    messages['off-prompt'] = element.data('offPromptText') || messages['on-state'];
    this._messages = messages;


    //detect state and save it
    if (this.isCheckBox()) {
        this._state = this._state || (element.is(':checked') ? 'on-state' : 'off-state');
    } else {
        this._state = element.data('isOn') ? 'on-state' : this._state;
    }
    this.setState(this._state);

    //set mouseover handler only for non-checkbox version
    if (this.isCheckBox() === false) {
        var me = this;
        element.mouseover(function () {
            var is_on = me.isOn();
            if (is_on) {
                me.setState('off-prompt');
            } else {
                me.setState('on-prompt');
            }
            return false;
        });
        element.mouseout(function () {
            var is_on = me.isOn();
            if (is_on) {
                me.setState('on-state');
            } else {
                me.setState('off-state');
            }
            return false;
        });
    }

    setupButtonEventHandlers(element, this.getHandler());
};

var ExpanderToggle = function (expandable) {
    Toggle.call(this);
    this.setExpandable(expandable);
    this._handler = this.getExpanderHandler();
};
inherits(ExpanderToggle, Toggle);

ExpanderToggle.prototype.setCollapsed = function (collapsed) {
    if (collapsed) {
        this.setState('off-state');
    } else {
        this.setState('on-state');
    }
};

ExpanderToggle.prototype.setExpandable = function(expandable) {
    this._expandable = expandable;
};

ExpanderToggle.prototype.getExpandable = function() {
    return this._expandable;
};

ExpanderToggle.prototype.getExpanderHandler = function () {
    var me = this;
    return function () {
        me.toggleState();
        var expandable = me.getExpandable();
        if (expandable) {
            if (me.isOn()) {
                expandable.show();
            } else {
                expandable.hide();
            }
        }
    };
};

/*
Scripts for cnprog.com
Project Name: Lanai
All Rights Resevred 2008. CNPROG.COM
*/
var lanai = {
    /**
     * Finds any <pre><code></code></pre> tags which aren't registered for
     * pretty printing, adds the appropriate class name and invokes prettify.
     */
    highlightSyntax: function () {
        var styled = false;
        $('pre code').parent().each(function () {
            if (!$(this).hasClass('prettyprint')) {
                $(this).addClass('prettyprint');
                styled = true;
            }
        });

        if (styled) {
            prettyPrint();
        }
    }
};

//todo: clean-up now there is utils:WaitIcon
function appendLoader(element) {
    loading = gettext('loading...');
    element.append('<img class="ajax-loader" ' +
        'src="' + mediaUrl('media/images/indicator.gif') + '" title="' +
        loading +
        '" alt="' +
        loading +
    '" />');
}

function removeLoader() {
    $('img.ajax-loader').remove();
}

function setSubmitButtonDisabled(form, isDisabled) {
    form.find('input[type="submit"]').attr('disabled', isDisabled);
}

function enableSubmitButton(form) {
    setSubmitButtonDisabled(form, false);
}

function disableSubmitButton(form) {
    setSubmitButtonDisabled(form, true);
}

function setupFormValidation(form, validationRules, validationMessages, onSubmitCallback) {
    enableSubmitButton(form);
    var placementLocation = askbot.settings.errorPlacement;
    var placementClass = placementLocation ? ' ' + placementLocation : '';
    form.validate({
        debug: true,
        rules: (validationRules ? validationRules : {}),
        messages: (validationMessages ? validationMessages : {}),
        errorElement: 'span',
        errorClass: 'form-error' + placementClass,
        highlight: function (element) {
            $(element).closest('.form-group').addClass('has-error');
        },
        unhighlight: function (element) {
            var formGroup = $(element).closest('.form-group');
            formGroup.removeClass('has-error');
            formGroup.find('.form-error').remove();
        },
        errorPlacement: function (error, element) {
            //bs3 error placement
            var label = element.closest('.form-group').find('label');
            if (placementLocation === 'in-label') {
                label.html(error);
                return;
            } else if (placementLocation === 'after-label') {
                var errorLabel = element.closest('.form-group').find('.form-error');
                if (errorLabel.length) {
                    errorLabel.replaceWith(error);
                } else {
                    label.after(error);
                }
                return;
            }

            //old askbot error placement
            var span = element.next().find('.form-error');
            if (span.length === 0) {
                span = element.parent().find('.form-error');
                if (span.length === 0) {
                    //for resizable textarea
                    var element_id = element.attr('id');
                    $('label[for="' + element_id + '"]').after(error);
                }
            } else {
                span.replaceWith(error);
            }
        },
        submitHandler: function (form_dom) {
            disableSubmitButton($(form_dom));

            if (onSubmitCallback) {
                onSubmitCallback(form_dom);
            } else {
                form_dom.submit();
            }
        }
    });
}

var validateTagLength = function (value) {
    var tags = getUniqueWords(value);
    var are_tags_ok = true;
    $.each(tags, function (index, value) {
        if (value.length > askbot.settings.maxTagLength) {
            are_tags_ok = false;
        }
    });
    return are_tags_ok;
};
var validateTagCount = function (value) {
    var tags = getUniqueWords(value);
    return (tags.length <= askbot.settings.maxTagsPerPost);
};

$.validator.addMethod('limit_tag_count', validateTagCount);
$.validator.addMethod('limit_tag_length', validateTagLength);

askbot.validators = askbot.validators || {};

askbot.validators.titleValidator = function (text) {
    text = $.trim(text);
    if (text.length < askbot.settings.minTitleLength) {
        throw interpolate(
                        ngettext(
                            'enter > %(length)s character',
                            'enter > %(length)s characters',
                            askbot.settings.minTitleLength
                        ),
                        {'length': askbot.settings.minTitleLength},
                        true
                    );
    }
};

askbot.validators.questionDetailsValidator = function (text) {
    text = $.trim(text);
    var minLength = askbot.settings.minQuestionBodyLength;
    if (minLength && (text.length < minLength)) {
        /* todo - for tinymce text extract text from html 
            otherwise html tags will be counted and user misled */
        throw interpolate(
                    ngettext(
                        'details must have > %s character',
                        'details must have > %s characters',
                        minLength
                    ),
                    [minLength]
                );
    }
};

askbot.validators.answerValidator = function (text) {
    var minLength = askbot.settings.minAnswerBodyLength;
    var textLength
    text = $.trim(text);
    if (askbot.settings.editorType == 'tinymce') {
        textLength = $('<p>' + text + '</p>').text().length;
    } else {
        textLength = text.length;
    }
    if (minLength && (textLength < minLength)) {
        throw interpolate(
                ngettext(
                    'enter > %(length)s character',
                    'enter > %(length)s characters',
                    minLength
                ),
                {'length': minLength},
                true
            );
    }
};

var CPValidator = (function () {
    return {
        getQuestionFormRules: function () {
            return {
                tags: {
                    required: askbot.settings.tagsAreRequired,
                    maxlength: 105,
                    limit_tag_count: true,
                    limit_tag_length: true
                },
                text: {
                    required: !!askbot.settings.minQuestionBodyLength,
                    minlength: askbot.settings.minQuestionBodyLength
                },
                title: {
                    required: true,
                    minlength: askbot.settings.minTitleLength
                }
            };
        },
        getQuestionFormMessages: function () {
            return {
                tags: {
                    required: ' ' + gettext('tags cannot be empty'),
                    maxlength: askbot.messages.tagLimits,
                    limit_tag_count: askbot.messages.maxTagsPerPost,
                    limit_tag_length: askbot.messages.maxTagLength
                },
                text: {
                    required: ' ' + gettext('details are required'),
                    minlength: interpolate(
                                    ngettext(
                                        'details must have > %s character',
                                        'details must have > %s characters',
                                        askbot.settings.minQuestionBodyLength
                                    ),
                                    [askbot.settings.minQuestionBodyLength]
                                )
                },
                title: {
                    required: ' ' + gettext('enter your question'),
                    minlength: interpolate(
                                    ngettext(
                                        'enter > %(length)s character',
                                        'enter > %(length)s characters',
                                        askbot.settings.minTitleLength
                                    ),
                                    {'length': askbot.settings.minTitleLength},
                                    true
                                )
                }
            };
        },
        getAnswerFormRules: function () {
            return {
                text: {
                    required: true,
                    minlength: askbot.settings.minAnswerBodyLength
                }
            };
        },
        getAnswerFormMessages: function () {
            return {
                text: {
                    required: ' ' + gettext('content cannot be empty'),
                    minlength: interpolate(
                                    ngettext(
                                        'enter > %(length)s character',
                                        'enter > %(length)s characters',
                                        askbot.settings.minAnswerBodyLength
                                    ),
                                    {'length': askbot.settings.minAnswerBodyLength},
                                    true
                                )
                }
            };
        }
    };
})();

/**
 * @constructor
 */
var ThreadUsersDialog = function () {
    SimpleControl.call(this);
    this._heading_text = 'Add heading with the setHeadingText()';
};
inherits(ThreadUsersDialog, SimpleControl);

ThreadUsersDialog.prototype.setHeadingText = function (text) {
    this._heading_text = text;
};

ThreadUsersDialog.prototype.showUsers = function (html) {
    this._dialog.setContent(html);
    this._dialog.show();
};

ThreadUsersDialog.prototype.startShowingUsers = function () {
    var me = this;
    var threadId = this._threadId;
    var url = this._url;
    $.ajax({
        type: 'GET',
        data: {'thread_id': threadId},
        dataType: 'json',
        url: url,
        cache: false,
        success: function (data) {
            if (data.success) {
                me.showUsers(data.html);
            } else {
                showMessage(me.getElement(), data.message, 'after');
            }
        }
    });
};

ThreadUsersDialog.prototype.decorate = function (element) {
    this._element = element;
    ThreadUsersDialog.superClass_.decorate.call(this, element);
    this._threadId = element.data('threadId');
    this._url = element.data('url');
    var dialog = new ModalDialog();
    dialog.setRejectButtonText('');
    dialog.setAcceptButtonText(gettext('Back to the question'));
    dialog.setHeadingText(this._heading_text);
    dialog.setAcceptHandler(function () { dialog.hide(); });
    var dialog_element = dialog.getElement();
    $(dialog_element).find('.modal-footer').css('text-align', 'center');
    $('body').append(dialog_element);
    this._dialog = dialog;
    var me = this;
    this.setHandler(function () {
        me.startShowingUsers();
    });
};

var MergeQuestionsDialog = function () {
    ModalDialog.call(this);
    this._tags = [];
    this._prevQuestionId = undefined;
};
inherits(MergeQuestionsDialog, ModalDialog);

MergeQuestionsDialog.prototype.show = function () {
    MergeQuestionsDialog.superClass_.show.call(this);
    this._idInput.focus();
};

MergeQuestionsDialog.prototype.getStartMergingHandler = function () {
    var me = this;
    return function () {
        $.ajax({
            type: 'POST',
            cache: false,
            dataType: 'json',
            url: askbot.urls.mergeQuestions,
            data: JSON.stringify({
                from_id: me.getFromId(),
                to_id: me.getToId()
            }),
            success: function (data) {
                window.location.reload();
            }
        });
    };
};

MergeQuestionsDialog.prototype.setPreview = function (data) {
    this._previewTitle.html(data.title);
    this._previewBody.html(data.summary);
    for (var i = 0; i < this._tags.length; i++) {
        this._tags[i].dispose();
    }
    for (i = 0; i < data.tags.length; i++) {
        var tag = new Tag();
        tag.setLinkable(false);
        tag.setName(data.tags[i]);
        this._previewTags.append(tag.getElement());
        this._tags.push(tag);
    }
    this._preview.fadeIn();
};

MergeQuestionsDialog.prototype.clearIdInput = function () {
    this._idInput.val('');
};

MergeQuestionsDialog.prototype.clearPreview = function () {
    for (var i = 0; i < this._tags.length; i++) {
        this._tags[i].dispose();
    }
    this._previewTitle.html('');
    this._previewBody.html('');
    this._previewTags.html('');
    this.setAcceptButtonText(gettext('Load preview'));
    this._preview.hide();
};

MergeQuestionsDialog.prototype.getFromId = function () {
    return this._fromId;
};

MergeQuestionsDialog.prototype.getToId = function () {
    return this._idInput.val();
};

MergeQuestionsDialog.prototype.getPrevToId = function () {
    return this._prevQuestionId;
};

MergeQuestionsDialog.prototype.setPrevToId = function (toId) {
    this._prevQuestionId = toId;
};

MergeQuestionsDialog.prototype.getLoadPreviewHandler = function () {
    var me = this;
    return function () {
        var prevId = me.getPrevToId();
        var curId = me.getToId();
        // here I am disabling eqeqeq because it looks like there's a type coercion going on, can't be sure
        // so skipping it
        /*jshint eqeqeq:false*/
        if (curId) {// && curId != prevId) {
        /*jshint eqeqeq:true*/
            $.ajax({
                type: 'GET',
                cache: false,
                dataType: 'json',
                url: askbot.urls.apiV1Questions + curId + '/',
                success: function (data) {
                    me.setPreview(data);
                    me.setPrevToId(curId);
                    me.setAcceptButtonText(gettext('Merge'));
                    me.setPreviewLoaded(true);
                    return false;
                },
                error: function () {
                    me.clearPreview();
                    me.setAcceptButtonText(gettext('Load preview'));
                    me.setPreviewLoaded(false);
                    return false;
                }
            });
        }
    };
};

MergeQuestionsDialog.prototype.setPreviewLoaded = function(isLoaded) {
    this._isPreviewLoaded = isLoaded;
};

MergeQuestionsDialog.prototype.isPreviewLoaded = function() {
    return this._isPreviewLoaded;
};

MergeQuestionsDialog.prototype.getAcceptHandler = function() {
    var me = this;
    return function() {
        var handler;
        if (me.isPreviewLoaded()) {
            handler = me.getStartMergingHandler();
        } else {
            handler = me.getLoadPreviewHandler();
        }
        handler();
        return false;
    };
};

MergeQuestionsDialog.prototype.getRejectHandler = function() {
    var me = this;
    return function() {
        me.clearPreview();
        me.clearIdInput();
        me.setPreviewLoaded(false);
        me.hide();
    };
};

MergeQuestionsDialog.prototype.createDom = function () {
    //make content
    var content = this.makeElement('div');
    var label = this.makeElement('label');
    label.attr('for', 'question_id');
    label.html(gettext(askbot.messages.enterDuplicateQuestionId));
    content.append(label);
    var input = this.makeElement('input');
    input.attr('type', 'text');
    input.attr('name', 'question_id');
    content.append(input);
    this._idInput = input;

    var preview = this.makeElement('div');
    content.append(preview);
    this._preview = preview;
    preview.hide();

    var title = this.makeElement('h3');
    preview.append(title);
    this._previewTitle = title;

    var tags = this.makeElement('div');
    tags.addClass('tags');
    this._preview.append(tags);
    this._previewTags = tags;

    var clr = this.makeElement('div');
    clr.addClass('clearfix');
    this._preview.append(clr);

    var body = this.makeElement('div');
    body.addClass('body');
    this._preview.append(body);
    this._previewBody = body;

    var previewHandler = this.getLoadPreviewHandler();
    var enterHandler = makeKeyHandler(13, previewHandler);
    input.keydown(enterHandler);
    input.blur(previewHandler);

    this.setContent(content);

    this.setClass('merge-questions');
    this.setRejectButtonText(gettext('Cancel'));
    this.setAcceptButtonText(gettext('Load preview'));
    this.setHeadingText(askbot.messages.mergeQuestions);
    this.setRejectHandler(this.getRejectHandler());
    this.setAcceptHandler(this.getAcceptHandler());

    MergeQuestionsDialog.superClass_.createDom.call(this);
    this._element.hide();

    this._fromId = $('.js-question').data('postId');
    //have to do this on document since _element is not in the DOM yet
    $(document).trigger('askbot.afterMergeQuestionsDialogCreateDom', [this]);
};

/**
 * @constructor
 */
var DraftPost = function () {
    WrappedElement.call(this);
};
inherits(DraftPost, WrappedElement);

/**
 * @return {string}
 */
DraftPost.prototype.getUrl = function () {
    throw 'Not Implemented';
};

/**
 * @return {boolean}
 */
DraftPost.prototype.shouldSave = function () {
    throw 'Not Implemented';
};

/**
 * @return {object} data dict
 */
DraftPost.prototype.getData = function () {
    throw 'Not Implemented';
};

DraftPost.prototype.backupData = function () {
    this._old_data = this.getData();
};

DraftPost.prototype.showNotification = function () {
    var note = $('.editor-status span');
    note.hide();
    note.html(gettext('draft saved...'));
    note.fadeIn().delay(3000).fadeOut();
};

DraftPost.prototype.getSaveHandler = function () {
    var me = this;
    return function (save_synchronously) {
        if (me.shouldSave()) {
            $.ajax({
                type: 'POST',
                cache: false,
                dataType: 'json',
                async: save_synchronously ? false : true,
                url: me.getUrl(),
                data: me.getData(),
                success: function (data) {
                    if (data.success && !save_synchronously) {
                        me.showNotification();
                    }
                    me.backupData();
                }
            });
        }
    };
};

DraftPost.prototype.decorate = function (element) {
    this._element = element;
    this.assignContentElements();
    this.backupData();
    setInterval(this.getSaveHandler(), 30000);//auto-save twice a minute
    var me = this;
    window.onbeforeunload = function () {
        var saveHandler = me.getSaveHandler();
        saveHandler(true);
        //var msg = gettext("%s, we've saved your draft, but...");
        //return interpolate(msg, [askbot.data.userName]);
    };
};


/**
 * @contstructor
 */
var DraftQuestion = function () {
    DraftPost.call(this);
};
inherits(DraftQuestion, DraftPost);

DraftQuestion.prototype.getUrl = function () {
    return askbot.urls.saveDraftQuestion;
};

DraftQuestion.prototype.shouldSave = function () {
    var newd = this.getData();
    var oldd = this._old_data;
    return (
        newd.title !== oldd.title ||
        newd.text !== oldd.text ||
        newd.tagnames !== oldd.tagnames
    );
};

DraftQuestion.prototype.getData = function () {
    return {
        'title': this._title_element.val(),
        'text': this._text_element.val(),
        'tagnames': this._tagnames_element.val()
    };
};

DraftQuestion.prototype.assignContentElements = function () {
    this._title_element = $('#id_title');
    this._text_element = $('#editor');
    this._tagnames_element = $('#id_tags');
};

var DraftAnswer = function () {
    DraftPost.call(this);
};
inherits(DraftAnswer, DraftPost);

DraftAnswer.prototype.setThreadId = function (id) {
    this._threadId = id;
};

DraftAnswer.prototype.getUrl = function () {
    return askbot.urls.saveDraftAnswer;
};

DraftAnswer.prototype.shouldSave = function () {
    return this.getData().text !== this._old_data.text;
};

DraftAnswer.prototype.getData = function () {
    return {
        'text': this._textElement.val(),
        'thread_id': this._threadId
    };
};

DraftAnswer.prototype.assignContentElements = function () {
    this._textElement = $('#editor');
};


/**
 * @constructor
 * @extends {SimpleControl}
 * @param {Comment} comment to upvote
 */
var CommentVoteButton = function (comment) {
    SimpleControl.call(this);
    /**
     * @param {Comment}
     */
    this._comment = comment;
    /**
     * @type {boolean}
     */
    this._voted = false;
    /**
     * @type {number}
     */
    this._score = 0;
};
inherits(CommentVoteButton, SimpleControl);
/**
 * @param {number} score
 */
CommentVoteButton.prototype.setScore = function (score) {
    this._score = score;
    if (this._element) {
        this._element.html(score || '');
    }
    this._element.trigger('askbot.afterSetScore', [this, score]);
};
/**
 * @param {boolean} voted
 */
CommentVoteButton.prototype.setVoted = function (voted) {
    this._voted = voted;
    if (this._element && voted) {
        this._element.addClass('upvoted');
    } else if (this._element) {
        this._element.removeClass('upvoted');
    }
};

CommentVoteButton.prototype.getVoteHandler = function () {
    var me = this;
    var comment = this._comment;
    return function () {
        var cancelVote =  me._voted ? true: false;
        var post_id = me._comment.getId();
        var data = {
            cancel_vote: cancelVote,
            post_id: post_id
        };
        $.ajax({
            type: 'POST',
            data: data,
            dataType: 'json',
            url: askbot.urls.upvote_comment,
            cache: false,
            success: function (data) {
                if (data.success) {
                    me.setScore(data.score);
                    me.setVoted(!cancelVote);
                } else {
                    showMessage(comment.getElement(), data.message, 'after');
                }
            }
        });
    };
};

CommentVoteButton.prototype.decorate = function (element) {
    this._element = element;
    this.setHandler(this.getVoteHandler());

    element = this._element;
    var comment = this._comment;
    /* can't call comment.getElement() here due
     * an issue in the getElement() of comment
     * so use an "illegal" access to comment._element here
     */
    comment._element.mouseenter(function () {
        //outside height may not be known
        //var height = comment.getElement().height();
        //element.height(height);
        element.addClass('hover');
    });
    comment._element.mouseleave(function () {
        element.removeClass('hover');
    });

};

CommentVoteButton.prototype.createDom = function () {
    this._element = this.makeElement('div');
    if (this._score > 0) {
        this._element.html(this._score);
    }
    this._element.addClass('upvote');
    if (this._voted) {
        this._element.addClass('upvoted');
    }
    this.decorate(this._element);
};

/**
 * an updater of the follower count
 */
var updateQuestionFollowerCount = function (evt, data) {
    var fav = $('.js-question-follower-count');
    var count = data.num_followers;
    if (count === 0) {
        fav.text('');
    } else {
        var fmt = ngettext('%s follower', '%s followers', count);
        fav.text(interpolate(fmt, [count]));
    }
};

/**
 * legacy Vote class
 * handles all sorts of vote-like operations
 */
var Vote = (function () {
    // All actions are related to a question
    var questionId;
    //question slug to build redirect urls
    var questionSlug;
    // The object we operate on actually. It can be a question or an answer.
    var postId;
    var questionAuthorId;
    var currentUserId;
    var answerContainerIdPrefix = 'post-id-';
    var voteContainerId = 'vote-buttons';
    var imgIdPrefixAccept = 'answer-img-accept-';
    var imgIdPrefixQuestionVoteup = 'question-img-upvote-';
    var imgIdPrefixQuestionVotedown = 'question-img-downvote-';
    var imgIdPrefixAnswerVoteup = 'answer-img-upvote-';
    var imgIdPrefixAnswerVotedown = 'answer-img-downvote-';
    var voteNumberClass = 'vote-number';
    var offensiveIdPrefixQuestionFlag = 'question-offensive-flag-';
    var removeOffensiveIdPrefixQuestionFlag = 'question-offensive-remove-flag-';
    var removeAllOffensiveIdPrefixQuestionFlag = 'question-offensive-remove-all-flag-';
    var offensiveIdPrefixAnswerFlag = 'answer-offensive-flag-';
    var removeOffensiveIdPrefixAnswerFlag = 'answer-offensive-remove-flag-';
    var removeAllOffensiveIdPrefixAnswerFlag = 'answer-offensive-remove-all-flag-';
    var offensiveClassFlag = 'offensive-flag';
    var questionControlsId = 'question-controls';
    var removeAnswerLinkIdPrefix = 'answer-delete-link-';
    var questionSubscribeUpdates = 'question-subscribe-updates';
    var questionSubscribeSidebar = 'question-subscribe-sidebar';

    var acceptAnonymousMessage = gettext('insufficient privilege');

    var pleaseLogin = ' <a href="' + askbot.urls.user_signin + '">' + gettext('please login') + '</a>';

    //todo: this below is probably not used
    var subscribeAnonymousMessage = gettext('anonymous users cannot subscribe to questions') + pleaseLogin;
    var voteAnonymousMessage = gettext('anonymous users cannot vote') + pleaseLogin;
    //there were a couple of more messages...
    var offensiveAnonymousMessage = gettext('anonymous users cannot flag offensive posts') + pleaseLogin;
    var removeConfirmation = gettext('confirm delete');
    var removeAnonymousMessage = gettext('anonymous users cannot delete/undelete') + pleaseLogin;
    var recoveredMessage = gettext('post recovered');
    var deletedMessage = gettext('post deleted');

    var VoteType = {
        acceptAnswer: 0,
        questionUpVote: 1,
        questionDownVote: 2,
        answerUpVote: 5,
        answerDownVote:6,
        offensiveQuestion: 7,
        removeOffensiveQuestion: 7.5,
        removeAllOffensiveQuestion: 7.6,
        offensiveAnswer: 8,
        removeOffensiveAnswer: 8.5,
        removeAllOffensiveAnswer: 8.6,
        removeQuestion: 9,//deprecate
        removeAnswer: 10,//deprecate
        questionSubscribeUpdates: 11,
        questionUnsubscribeUpdates: 12
    };

    var getQuestionVoteUpButton = function () {
        var questionVoteUpButton = 'div.' + voteContainerId + ' div[id^="' + imgIdPrefixQuestionVoteup + '"]';
        return $(questionVoteUpButton);
    };
    var getQuestionVoteDownButton = function () {
        var questionVoteDownButton = 'div.' + voteContainerId + ' div[id^="' + imgIdPrefixQuestionVotedown + '"]';
        return $(questionVoteDownButton);
    };
    var getAnswerVoteUpButtons = function () {
        var answerVoteUpButton = 'div.' + voteContainerId + ' div[id^="' + imgIdPrefixAnswerVoteup + '"]';
        return $(answerVoteUpButton);
    };
    var getAnswerVoteDownButtons = function () {
        var answerVoteDownButton = 'div.' + voteContainerId + ' div[id^="' + imgIdPrefixAnswerVotedown + '"]';
        return $(answerVoteDownButton);
    };
    var getAnswerVoteUpButton = function (id) {
        var answerVoteUpButton = 'div.' + voteContainerId + ' div[id="' + imgIdPrefixAnswerVoteup + id + '"]';
        return $(answerVoteUpButton);
    };
    var getAnswerVoteDownButton = function (id) {
        var answerVoteDownButton = 'div.' + voteContainerId + ' div[id="' + imgIdPrefixAnswerVotedown + id + '"]';
        return $(answerVoteDownButton);
    };

    var getOffensiveQuestionFlag = function () {
        var offensiveQuestionFlag = 'span[id^="' + offensiveIdPrefixQuestionFlag + '"]';
        return $(offensiveQuestionFlag);
    };

    var getRemoveOffensiveQuestionFlag = function () {
        var removeOffensiveQuestionFlag = 'span[id^="' + removeOffensiveIdPrefixQuestionFlag + '"]';
        return $(removeOffensiveQuestionFlag);
    };

    var getRemoveAllOffensiveQuestionFlag = function () {
        var removeAllOffensiveQuestionFlag = 'span[id^="' + removeAllOffensiveIdPrefixQuestionFlag + '"]';
        return $(removeAllOffensiveQuestionFlag);
    };

    var getOffensiveAnswerFlags = function () {
        var offensiveQuestionFlag = 'span[id^="' + offensiveIdPrefixAnswerFlag + '"]';
        return $(offensiveQuestionFlag);
    };

    var getRemoveOffensiveAnswerFlag = function () {
        var removeOffensiveAnswerFlag = 'span[id^="' + removeOffensiveIdPrefixAnswerFlag + '"]';
        return $(removeOffensiveAnswerFlag);
    };

    var getRemoveAllOffensiveAnswerFlag = function () {
        var removeAllOffensiveAnswerFlag = 'span[id^="' + removeAllOffensiveIdPrefixAnswerFlag + '"]';
        return $(removeAllOffensiveAnswerFlag);
    };

    var getquestionSubscribeUpdatesCheckbox = function () {
        return $('#' + questionSubscribeUpdates);
    };

    var getquestionSubscribeSidebarCheckbox = function () {
        return $('#' + questionSubscribeSidebar);
    };

    var getremoveAnswersLinks = function () {
        var removeAnswerLinks = 'a[id^="' + removeAnswerLinkIdPrefix + '"]';
        return $(removeAnswerLinks);
    };

    var setVoteImage = function (voteType, undo, object) {
        var flag = undo ? false : true;
        if (object.hasClass('on')) {
            object.removeClass('on');
        } else {
            object.addClass('on');
        }

        if (undo) {
            if (voteType === VoteType.questionUpVote || voteType === VoteType.questionDownVote) {
                $(getQuestionVoteUpButton()).removeClass('on');
                $(getQuestionVoteDownButton()).removeClass('on');
            } else {
                $(getAnswerVoteUpButton(postId)).removeClass('on');
                $(getAnswerVoteDownButton(postId)).removeClass('on');
            }
        }
    };

    var setVoteNumber = function (object, number) {
        var voteNumber = object.parent('div.' + voteContainerId).find('div.' + voteNumberClass);
        $(voteNumber).text(number);
    };

    var bindEvents = function () {
        // accept answers
        var acceptedButtons = 'div.' + voteContainerId + ' div[id^="' + imgIdPrefixAccept + '"]';
        $(acceptedButtons).unbind('click').click(function (event) {
            Vote.accept($(event.target));
        });

        // question vote up
        var questionVoteUpButton = getQuestionVoteUpButton();
        questionVoteUpButton.unbind('click').click(function (event) {
            Vote.vote($(event.target), VoteType.questionUpVote);
        });

        var questionVoteDownButton = getQuestionVoteDownButton();
        questionVoteDownButton.unbind('click').click(function (event) {
            Vote.vote($(event.target), VoteType.questionDownVote);
        });

        var answerVoteUpButton = getAnswerVoteUpButtons();
        answerVoteUpButton.unbind('click').click(function (event) {
            Vote.vote($(event.target), VoteType.answerUpVote);
        });

        var answerVoteDownButton = getAnswerVoteDownButtons();
        answerVoteDownButton.unbind('click').click(function (event) {
            Vote.vote($(event.target), VoteType.answerDownVote);
        });

        getOffensiveQuestionFlag().unbind('click').click(function (event) {
            Vote.offensive(this, VoteType.offensiveQuestion);
        });

        getRemoveOffensiveQuestionFlag().unbind('click').click(function (event) {
            Vote.remove_offensive(this, VoteType.removeOffensiveQuestion);
        });

        getRemoveAllOffensiveQuestionFlag().unbind('click').click(function (event) {
            Vote.remove_all_offensive(this, VoteType.removeAllOffensiveQuestion);
        });

        getOffensiveAnswerFlags().unbind('click').click(function (event) {
            Vote.offensive(this, VoteType.offensiveAnswer);
        });

        getRemoveOffensiveAnswerFlag().unbind('click').click(function (event) {
            Vote.remove_offensive(this, VoteType.removeOffensiveAnswer);
        });

        getRemoveAllOffensiveAnswerFlag().unbind('click').click(function (event) {
            Vote.remove_all_offensive(this, VoteType.removeAllOffensiveAnswer);
        });

        getquestionSubscribeUpdatesCheckbox().unbind('click').click(function (event) {
            //despeluchar esto
            if (this.checked) {
                getquestionSubscribeSidebarCheckbox().attr({'checked': true});
                Vote.vote($(event.target), VoteType.questionSubscribeUpdates);
            } else {
                getquestionSubscribeSidebarCheckbox().attr({'checked': false});
                Vote.vote($(event.target), VoteType.questionUnsubscribeUpdates);
            }
        });

        getquestionSubscribeSidebarCheckbox().unbind('click').click(function (event) {
            if (this.checked) {
                getquestionSubscribeUpdatesCheckbox().attr({'checked': true});
                Vote.vote($(event.target), VoteType.questionSubscribeUpdates);
            } else {
                getquestionSubscribeUpdatesCheckbox().attr({'checked': false});
                Vote.vote($(event.target), VoteType.questionUnsubscribeUpdates);
            }
        });

        getremoveAnswersLinks().unbind('click').click(function (event) {
            Vote.remove(this, VoteType.removeAnswer);
        });
    };

    var submit = function (object, voteType, callback) {
        //this function submits votes
        $.ajax({
            type: 'POST',
            cache: false,
            dataType: 'json',
            url: askbot.urls.vote_url,
            data: { type: voteType, postId: postId },
            error: handleFail,
            success: function (data) {
                callback(object, voteType, data);
            }
        });
    };

    var handleFail = function (xhr, msg) {
        alert('Callback invoke error: ' + msg);
    };

    // callback function for Accept Answer action
    var callback_accept = function (object, voteType, data) {
        /*jshint eqeqeq:false */
        if (data.allowed == '0' && data.success == '0') {
            showMessage(object, acceptAnonymousMessage);
        } else if (data.allowed == '-1') {
            var message = interpolate(
                gettext('sorry, you cannot %(accept_own_answer)s'),
                {'accept_own_answer': askbot.messages.acceptOwnAnswer},
                true
            );
            showMessage(object, message);
        } else if (data.status == '1') {
            $('#' + answerContainerIdPrefix + postId).removeClass('accepted-answer');
            object.trigger('askbot.unacceptAnswer', [object, data]);
        } else if (data.success == '1') {
            var answers = ('div[id^="' + answerContainerIdPrefix + '"]');
            $(answers).removeClass('accepted-answer');
            $('#' + answerContainerIdPrefix + postId).addClass('accepted-answer');
            object.trigger('askbot.acceptAnswer', [object, data]);
        } else {
            showMessage(object, data.message);
        }
        /*jshint eqeqeq:true */
    };

    var callback_vote = function (object, voteType, data) {
        /*jshint eqeqeq:false */
        if (data.success == '0') {
            showMessage(object, data.message);
            return;
        } else {
            if (data.status == '1') {
                setVoteImage(voteType, true, object);
                object.trigger('askbot.voteDown', [object, data]);
            } else {
                setVoteImage(voteType, false, object);
                object.trigger('askbot.voteUp', [object, data]);
            }
            setVoteNumber(object, data.count);
            if (data.message && data.message.length > 0) {
                showMessage(object, data.message);
            }
            return;
        }
        /*jshint eqeqeq:true */
    };

    var callback_offensive = function (object, voteType, data) {
        /*jshint eqeqeq:false */
        //todo: transfer proper translations of these from i18n.js
        //to django.po files
        //_('anonymous users cannot flag offensive posts') + pleaseLogin;
        if (data.success == '1') {
            if (data.count > 0) {
                $(object).children('span[class="darkred"]').text('(' + data.count + ')');
            } else {
                $(object).children('span[class="darkred"]').text('');
            }

            // Change the link text and rebind events
            $(object).find('.question-flag').html(gettext('remove flag'));
            var obj_id = $(object).attr('id');
            $(object).attr('id', obj_id.replace('flag-', 'remove-flag-'));

            getRemoveOffensiveQuestionFlag().unbind('click').click(function (event) {
                Vote.remove_offensive(this, VoteType.removeOffensiveQuestion);
            });

            getRemoveOffensiveAnswerFlag().unbind('click').click(function (event) {
                Vote.remove_offensive(this, VoteType.removeOffensiveAnswer);
            });
        } else {
            object = $(object);
            showMessage(object, data.message);
        }
        /*jshint eqeqeq:true */
    };

    var callback_remove_offensive = function (object, voteType, data) {
        /*jshint eqeqeq:false */
        //todo: transfer proper translations of these from i18n.js
        //to django.po files
        //_('anonymous users cannot flag offensive posts') + pleaseLogin;
        if (data.success == '1') {
            if (data.count > 0) {
                $(object).children('span[class="darkred"]').text('(' + data.count + ')');
            } else {
                $(object).children('span[class="darkred"]').text('');
                // Remove "remove all flags link" since there are no more flags to remove
                var remove_all = $(object).siblings('span.offensive-flag[id*="-offensive-remove-all-flag-"]');
                $(remove_all).next('span.sep').remove();
                $(remove_all).remove();
            }
            // Change the link text and rebind events
            $(object).find('.question-flag').html(gettext('flag offensive'));
            var obj_id = $(object).attr('id');
            $(object).attr('id', obj_id.replace('remove-flag-', 'flag-'));

            getOffensiveQuestionFlag().unbind('click').click(function (event) {
                Vote.offensive(this, VoteType.offensiveQuestion);
            });

            getOffensiveAnswerFlags().unbind('click').click(function (event) {
                Vote.offensive(this, VoteType.offensiveAnswer);
            });
        } else {
            object = $(object);
            showMessage(object, data.message);
        }
        /*jshint eqeqeq:true */
    };

    var callback_remove_all_offensive = function (object, voteType, data) {
        /*jshint eqeqeq:false */
        //todo: transfer proper translations of these from i18n.js
        //to django.po files
        //_('anonymous users cannot flag offensive posts') + pleaseLogin;
        if (data.success == '1') {
            if (data.count > 0) {
                $(object).children('span[class="darkred"]').text('(' + data.count + ')');
            } else {
                $(object).children('span[class="darkred"]').text('');
            }
            // remove the link. All flags are gone
            var remove_own = $(object).siblings('span.offensive-flag[id*="-offensive-remove-flag-"]');
            $(remove_own).find('.question-flag').html(gettext('flag offensive'));
            $(remove_own).attr('id', $(remove_own).attr('id').replace('remove-flag-', 'flag-'));

            $(object).next('span.sep').remove();
            $(object).remove();

            getOffensiveQuestionFlag().unbind('click').click(function (event) {
                Vote.offensive(this, VoteType.offensiveQuestion);
            });

            getOffensiveAnswerFlags().unbind('click').click(function (event) {
                Vote.offensive(this, VoteType.offensiveAnswer);
            });
        } else {
            object = $(object);
            showMessage(object, data.message);
        }
        /*jshint eqeqeq:true */
    };

    var callback_remove = function (object, voteType, data) {
        /*jshint eqeqeq:false */
        if (data.success == '1') {
            if (removeActionType == 'delete') {
                postNode.addClass('deleted');
                postRemoveLink.innerHTML = gettext('undelete');
                showMessage(object, deletedMessage);
            } else if (removeActionType == 'undelete') {
                postNode.removeClass('deleted');
                postRemoveLink.innerHTML = gettext('delete');
                showMessage(object, recoveredMessage);
            }
        } else {
            showMessage(object, data.message);
        }
        /*jshint eqeqeq:true */
    };

    return {
        init: function (qId, qSlug, questionAuthor, userId) {
            questionId = qId;
            questionSlug = qSlug;
            questionAuthorId = questionAuthor;
            currentUserId = '' + userId;//convert to string
            bindEvents();
        },

        //accept answer
        accept: function (object) {
            object = object.closest('.answer-img-accept');
            postId = object.attr('id').substring(imgIdPrefixAccept.length);
            submit(object, VoteType.acceptAnswer, callback_accept);
        },

        vote: function (object, voteType) {
            object = object.closest('.post-vote');
            if (!currentUserId || currentUserId.toUpperCase() === 'NONE') {
                if (voteType === VoteType.questionSubscribeUpdates || voteType === VoteType.questionUnsubscribeUpdates) {
                    getquestionSubscribeSidebarCheckbox().removeAttr('checked');
                    getquestionSubscribeUpdatesCheckbox().removeAttr('checked');
                    showMessage(object, subscribeAnonymousMessage);
                } else {
                    showMessage(
                        $(object),
                        voteAnonymousMessage.replace(
                                '{{QuestionID}}',
                                questionId
                            ).replace(
                                '{{questionSlug}}',
                                questionSlug
                            )
                    );
                }
                return false;
            }
            // up and downvote processor
            if (voteType === VoteType.answerUpVote) {
                postId = object.attr('id').substring(imgIdPrefixAnswerVoteup.length);
            } else if (voteType === VoteType.answerDownVote) {
                postId = object.attr('id').substring(imgIdPrefixAnswerVotedown.length);
            } else {
                postId = questionId;
            }

            submit(object, voteType, callback_vote);
        },
        //flag offensive
        offensive: function (object, voteType) {
            if (!currentUserId || currentUserId.toUpperCase() === 'NONE') {
                showMessage(
                    $(object),
                    offensiveAnonymousMessage.replace(
                            '{{QuestionID}}',
                            questionId
                        ).replace(
                            '{{questionSlug}}',
                            questionSlug
                        )
                );
                return false;
            }
            postId = object.id.substr(object.id.lastIndexOf('-') + 1);
            submit(object, voteType, callback_offensive);
        },
        //remove flag offensive
        remove_offensive: function (object, voteType) {
            if (!currentUserId || currentUserId.toUpperCase() === 'NONE') {
                showMessage(
                    $(object),
                    offensiveAnonymousMessage.replace(
                            '{{QuestionID}}',
                            questionId
                        ).replace(
                            '{{questionSlug}}',
                            questionSlug
                        )
                );
                return false;
            }
            postId = object.id.substr(object.id.lastIndexOf('-') + 1);
            submit(object, voteType, callback_remove_offensive);
        },
        remove_all_offensive: function (object, voteType) {
            if (!currentUserId || currentUserId.toUpperCase() === 'NONE') {
                showMessage(
                    $(object),
                    offensiveAnonymousMessage.replace(
                            '{{QuestionID}}',
                            questionId
                        ).replace(
                            '{{questionSlug}}',
                            questionSlug
                        )
                );
                return false;
            }
            postId = object.id.substr(object.id.lastIndexOf('-') + 1);
            submit(object, voteType, callback_remove_all_offensive);
        },
        //delete question or answer (comments are deleted separately)
        remove: function (object, voteType) {
            if (!currentUserId || currentUserId.toUpperCase() === 'NONE') {
                showMessage(
                    $(object),
                    removeAnonymousMessage.replace(
                            '{{QuestionID}}',
                            questionId
                        ).replace(
                            '{{questionSlug}}',
                            questionSlug
                        )
                    );
                return false;
            }
            bits = object.id.split('-');
            postId = bits.pop();/* this seems to be used within submit! */
            postType = bits.shift();

            var do_proceed = false;
            postNode = $('#post-id-' + postId);
            postRemoveLink = object;
            if (postNode.hasClass('deleted')) {
                removeActionType = 'undelete';
                do_proceed = true;
            } else {
                removeActionType = 'delete';
                do_proceed = confirm(removeConfirmation);
            }
            if (do_proceed) {
                submit($(object), voteType, callback_remove);
            }
        }
    };
})();

var questionRetagger = (function () {

    var oldTagsHTML = '';
    var tagInput = null;
    var tagsList = null;
    var retagLink = null;

    var restoreEventHandlers = function () {
        $(document).unbind('click', cancelRetag);
    };

    var cancelRetag = function () {
        tagsList.html(oldTagsHTML);
        tagsList.removeClass('post-retag');
        tagsList.addClass('post-tags');
        restoreEventHandlers();
        initRetagger();
    };

    var drawNewTags = function (new_tags) {
        tagsList.empty();
        if (new_tags === '') {
            return;
        }
        new_tags = new_tags.split(/\s+/);
        var tags_html = '';
        $.each(new_tags, function (index, name) {
            var tag = new Tag();
            tag.setName(name);
            var li = $('<li></li>');
            tagsList.append(li);
            li.append(tag.getElement());
        });
    };

    var doRetag = function () {
        $.ajax({
            type: 'POST',
            url: askbot.urls.retag,
            dataType: 'json',
            data: { tags: getUniqueWords(tagInput.val()).join(' ') },
            success: function (json) {
                if (json.success) {
                    new_tags = getUniqueWords(json.new_tags);
                    oldTagsHtml = '';
                    cancelRetag();
                    drawNewTags(new_tags.join(' '));
                    if (json.message) {
                        notify.show(json.message);
                    }
                } else {
                    cancelRetag();
                    showMessage(tagsList, json.message);
                }
            },
            error: function (xhr, textStatus) {
                showMessage(tagsList, gettext('sorry, something is not right here'));
                cancelRetag();
            }
        });
        return false;
    };

    var setupInputEventHandlers = function (input) {
        input.keydown(function (e) {
            if ((e.which && e.which === 27) || (e.keyCode && e.keyCode === 27)) {
                cancelRetag();
            }
        });
        $(document).unbind('click', cancelRetag).click(cancelRetag);
        input.closest('form').click(function (e) {
            e.stopPropagation();
        });
    };

    var createRetagForm = function (old_tags_string) {
        var div = $('<form method="post"></form>');
        tagInput = $('<input id="retag_tags" type="text" autocomplete="off" name="tags" size="30"/>');
        addExtraCssClasses(tagInput, 'textInputClasses');
        //var tagLabel = $('<label for="retag_tags" class="error"></label>');
        //populate input
        var tagAc = new AutoCompleter({
            url: askbot.urls.get_tag_list,
            minChars: 1,
            useCache: true,
            matchInside: true,
            maxCacheLength: 100,
            delay: 10
        });
        tagAc.decorate(tagInput);
        tagAc._results.on('click', function (e) {
            //click on results should not trigger cancelRetag
            e.stopPropagation();
        });
        tagInput.val(old_tags_string);
        div.append(tagInput);
        //div.append(tagLabel);
        setupInputEventHandlers(tagInput);

        //button = $('<input type="submit" />');
        //button.val(gettext('save tags'));
        //div.append(button);
        //setupButtonEventHandlers(button);
        $(document).trigger('askbot.afterCreateRetagForm', [div]);

        div.validate({//copy-paste from utils.js
            rules: {
                tags: {
                    required: askbot.settings.tagsAreRequired,
                    maxlength: askbot.settings.maxTagsPerPost * askbot.settings.maxTagLength,
                    limit_tag_count: true,
                    limit_tag_length: true
                }
            },
            messages: {
                tags: {
                    required: gettext('tags cannot be empty'),
                    maxlength: askbot.messages.tagLimits,
                    limit_tag_count: askbot.messages.maxTagsPerPost,
                    limit_tag_length: askbot.messages.maxTagLength
                }
            },
            submitHandler: doRetag,
            errorClass: 'retag-error'
        });

        $(document).trigger('askbot.afterSetupValidationRetagForm', [div]);

        return div;
    };

    var getTagsAsString = function (tags_div) {
        var links = tags_div.find('.js-tag-name');
        var tags_str = '';
        links.each(function (index, element) {
            if (index === 0) {
                //this is pretty bad - we should use Tag.getName()
                tags_str = $(element).data('tagName');
            } else {
                tags_str += ' ' + $(element).data('tagName');
            }
        });
        return tags_str;
    };

    var noopHandler = function () {
        tagInput.focus();
        return false;
    };

    var deactivateRetagLink = function () {
        retagLink.unbind('click').click(noopHandler);
        retagLink.unbind('keypress').keypress(noopHandler);
    };

    var startRetag = function () {
        tagsList = $('#question-tags');
        oldTagsHTML = tagsList.html();//save to restore on cancel
        var old_tags_string = getTagsAsString(tagsList);
        var retag_form = createRetagForm(old_tags_string);
        tagsList.html('');
        tagsList.append(retag_form);
        tagsList.removeClass('post-tags');
        tagsList.addClass('post-retag');
        tagInput.focus();
        deactivateRetagLink();
        return false;
    };

    var setupClickAndEnterHandler = function (element, callback) {
        element.unbind('click').click(callback);
        element.unbind('keypress').keypress(function (e) {
            if ((e.which && e.which === 13) || (e.keyCode && e.keyCode === 13)) {
                callback();
            }
        });
    };

    var initRetagger = function () {
        setupClickAndEnterHandler(retagLink, startRetag);
    };

    return {
        init: function () {
            retagLink = $('#retag');
            initRetagger();
        }
    };
})();

/**
 * @constructor
 * Controls vor voting for a post
 */
var VoteControls = function () {
    WrappedElement.call(this);
    this._postAuthorId = undefined;
    this._postId = undefined;
};
inherits(VoteControls, WrappedElement);

VoteControls.prototype.setPostId = function (postId) {
    this._postId = postId;
};

VoteControls.prototype.getPostId = function () {
    return this._postId;
};

VoteControls.prototype.setPostAuthorId = function (userId) {
    this._postAuthorId = userId;
};

VoteControls.prototype.setSlug = function (slug) {
    this._slug = slug;
};

VoteControls.prototype.setPostType = function (postType) {
    this._postType = postType;
};

VoteControls.prototype.getPostType = function () {
    return this._postType;
};

VoteControls.prototype.clearVotes = function () {
    this._upvoteButton.removeClass('on');
    this._downvoteButton.removeClass('on');
};

VoteControls.prototype.toggleButton = function (button) {
    if (button.hasClass('on')) {
        button.removeClass('on');
    } else {
        button.addClass('on');
    }
};

VoteControls.prototype.toggleVote = function (voteType) {
    if (voteType === 'upvote') {
        this.toggleButton(this._upvoteButton);
    } else {
        this.toggleButton(this._downvoteButton);
    }
};

VoteControls.prototype.setVoteCount = function (count) {
    this._voteCount.html(count);
};

VoteControls.prototype.updateDisplay = function (voteType, data) {
    /* jshint eqeqeq:false */
    if (data.status == '1') {
        this.clearVotes();
    } else {
        this.toggleVote(voteType);
    }
    this.setVoteCount(data.count);
    if (data.message && data.message.length > 0) {
        showMessage(this._element, data.message);
    }
    /* jshint eqeqeq:true */
};

VoteControls.prototype.getAnonymousMessage = function (message) {
    var pleaseLogin = ' <a href="' + askbot.urls.user_signin + '">' + gettext('please login') + '</a>';
    message += pleaseLogin;
    message = message.replace('{{QuestionID}}', this._postId);
    return message.replace('{{questionSlug}}', this._slug);
};

VoteControls.prototype.getVoteHandler = function (voteType) {
    var me = this;
    return function () {
        if (askbot.data.userIsAuthenticated === false) {
            var message = me.getAnonymousMessage(gettext('anonymous users cannot vote'));
            showMessage(me.getElement(), message);
        } else {
            //this function submits votes
            var voteMap = {
                'question': { 'upvote': 1, 'downvote': 2 },
                'answer': { 'upvote': 5, 'downvote': 6 }
            };
            var legacyVoteType = voteMap[me.getPostType()][voteType];
            $.ajax({
                type: 'POST',
                cache: false,
                dataType: 'json',
                url: askbot.urls.vote_url,
                data: {
                    type: legacyVoteType,
                    postId: me.getPostId()
                },
                error: function () {
                    showMessage(me.getElement(), gettext('sorry, something is not right here'));
                },
                success: function (data) {
                    if (data.success) {
                        me.updateDisplay(voteType, data);
                    } else {
                        showMessage(me.getElement(), data.message);
                    }
                }
            });
        }
    };
};

VoteControls.prototype.decorate = function (element) {
    this._element = element;
    var upvoteButton = element.find('.upvote');
    this._upvoteButton = upvoteButton;
    setupButtonEventHandlers(upvoteButton, this.getVoteHandler('upvote'));
    var downvoteButton = element.find('.downvote');
    this._downvoteButton = downvoteButton;
    setupButtonEventHandlers(downvoteButton, this.getVoteHandler('downvote'));
    this._voteCount = element.find('.vote-number');
};

var DeletePostLink = function () {
    SimpleControl.call(this);
    this._post_id = null;
};
inherits(DeletePostLink, SimpleControl);

DeletePostLink.prototype.setPostId = function (id) {
    this._post_id = id;
};

DeletePostLink.prototype.getPostId = function () {
    return this._post_id;
};

DeletePostLink.prototype.getPostElement = function () {
    return $('#post-id-' + this.getPostId());
};

DeletePostLink.prototype.isPostDeleted = function () {
    return this._post_deleted;
};

DeletePostLink.prototype.setPostDeleted = function (is_deleted) {
    var post = this.getPostElement();
    if (is_deleted === true) {
        post.addClass('deleted');
        this._post_deleted = true;
        this.getElement().html(gettext('undelete'));
    } else if (is_deleted === false) {
        post.removeClass('deleted');
        this._post_deleted = false;
        this.getElement().html(gettext('delete'));
    }
};

DeletePostLink.prototype.getDeleteHandler = function () {
    var me = this;
    var post_id = this.getPostId();
    return function () {
        var data = {
            'post_id': me.getPostId(),
            //todo rename cancel_vote -> undo
            'cancel_vote': me.isPostDeleted() ? true : false
        };
        $.ajax({
            type: 'POST',
            data: data,
            dataType: 'json',
            url: askbot.urls.delete_post,
            cache: false,
            success: function (data) {
                if (data.success) {
                    me.setPostDeleted(data.is_deleted);
                } else {
                    showMessage(me.getElement(), data.message);
                }
            }
        });
    };
};

DeletePostLink.prototype.decorate = function (element) {
    this._element = element;
    this._post_deleted = this.getPostElement().hasClass('deleted');
    this.setHandler(this.getDeleteHandler());
};

/**
 * @constructor
 * a simple textarea-based editor
 */
var SimpleEditor = function (attrs) {
    WrappedElement.call(this);
    attrs = attrs || {};
    this._rows = attrs.rows || 10;
    this._cols = attrs.cols || 60;
    this._minLines = attrs.minLines || 1;
    this._maxlength = attrs.maxlength || 1000;
};
inherits(SimpleEditor, WrappedElement);

SimpleEditor.prototype.focus = function (onFocus) {
    this._textarea.focus();
    if (onFocus) {
        onFocus();
    }
};

SimpleEditor.prototype.putCursorAtEnd = function () {
    putCursorAtEnd(this._textarea);
};

SimpleEditor.prototype.start = function () {
    this.getAutoResizeHandler()();
};

SimpleEditor.prototype.setHighlight = function (isHighlighted) {
    if (isHighlighted === true) {
        this._textarea.addClass('highlight');
    } else {
        this._textarea.removeClass('highlight');
    }
};

SimpleEditor.prototype.setTextareaName = function (name) {
    this._textareaName = name;
};


SimpleEditor.prototype.getText = function () {
    return $.trim(this._textarea.val());
};

SimpleEditor.prototype.getHtml = function () {
    return '<div class="transient-comment"><p>' + this.getText() + '</p></div>';
};

SimpleEditor.prototype.setText = function (text) {
    this._text = text;
    if (this._textarea) {
        this._textarea.val(text);
        this.getAutoResizeHandler()();
    }
};

SimpleEditor.prototype.getAutoResizeHandler = function() {
    var textarea = this._textarea;
    var mirror = this._mirror;
    var minLines = this._minLines;
    var me = this;
    return function(evt) {
        me.setMirrorStyle();
        var text = me.getText();
        if (evt) {
            if (evt.type == 'keydown' && getKeyCode(evt) == 13) {
                text += '\nZ';//add one char after newline
            } else if (/(\r|\n)$/.exec(evt.target.value)) {
                text += '\nZ';//add one char after newline
            }
        }
        mirror.text(text);
        var height = mirror.height();
        var lineHeight = parseInt(textarea.css('line-height')) || 10;
        height = lineHeight * Math.max(Math.ceil(height/lineHeight), minLines);
        textarea.css('height', height + 8);
    }
};

SimpleEditor.prototype.setMirrorStyle = function() {
    //copy styles into mirror from the textarea
    var textarea = this._textarea;
    var mirrorCss = {
        'position': 'absolute',
        'top': '-999em',
        'padding': textarea.css('padding'),
        'margin': textarea.css('margin'),
        'width': textarea.css('width'),
        'word-wrap': textarea.css('word-wrap'),
        'word-break': textarea.css('word-break'),
        'overflow': textarea.css('overflow')
    };
    //for IE, as .css('font') fails
    var fontProps = getFontProps(textarea);
    mirrorCss = $.extend(mirrorCss, fontProps);
    this._mirror.css(mirrorCss);
};

/**
 * a textarea inside a div,
 * the reason for this is that we subclass this
 * in WMD, and that one requires a more complex structure
 */
SimpleEditor.prototype.createDom = function () {
    this._element = getTemplate('.js-simple-editor');
    var textarea = this._element.find('textarea');
    var mirror = this._element.find('.mirror');

    this._textarea = textarea;
    this._mirror = mirror;


    if (askbot.settings.tinymceEditorDeselector) {
        textarea.addClass(askbot.settings.tinymceEditorDeselector);//suppress tinyMCE
    }
    addExtraCssClasses(textarea, 'editorClasses');
    if (this._text) {
        textarea.val(this._text);
    }
    textarea.attr({
        'cols': this._cols,
        'rows': this._rows,
        'maxlength': this._maxlength
    });
    if (this._textareaName) {
        textarea.attr('name', this._textareaName);
    }

    textarea.on('change paste keyup keydown', this.getAutoResizeHandler());
};

var WMDExpanderToggle = function (editor) {
    ExpanderToggle.call(this, editor.getPreviewerElement());
    this._editor = editor.getEditorElement();
    this._state = 'on-state';
    this._messages = {
        'on-state': gettext('Preview: (hide)'),
        'off-state': gettext('Show preview')
    }
};
inherits(WMDExpanderToggle, ExpanderToggle);

WMDExpanderToggle.prototype.getEditor = function () {
    return this._editor;
};

WMDExpanderToggle.prototype.setPreviewerCollapsedClass = function (collapsed) {
    var ed = this.getEditor();
    if (collapsed) {
        ed.addClass('wmd-previewer-collapsed');
    } else {
        ed.removeClass('wmd-previewer-collapsed');
    }
};

WMDExpanderToggle.prototype.createDom = function () {
    getSuperClass(WMDExpanderToggle).createDom.call(this);
    this._element.addClass('wmd-previewer-toggle');
    var editor = this.getEditor();

    var me = this;
    this._element.on('askbot.Toggle.stateChange', function (evt, data) {
        var newState = data['newState'];
        var collapsed = (newState == 'off-state' || newState == 'on-prompt');
        me.setPreviewerCollapsedClass(collapsed);
        return false;
    });
    this._element.on('askbot.WrappedElement.show askbot.WrappedElement.hide', function () {
        me.setPreviewerCollapsedClass(!me.isOn());
        return false;
    });
}

/**
 * @constructor
 * a wrapper for the WMD editor
 */
var WMD = function (opts) {
    SimpleEditor.call(this, opts);
    this._text = undefined;
    this._enabled_buttons = 'bold italic link blockquote code ' +
        'image attachment ol ul heading hr';
    this._previewerEnabled = true;
};
inherits(WMD, SimpleEditor);

//@todo: implement getHtml method that runs text through showdown renderer

WMD.prototype.setEnabledButtons = function (buttons) {
    this._enabled_buttons = buttons;
};

WMD.prototype.setPreviewerEnabled = function (enabledStatus) {
    this._previewerEnabled = enabledStatus;
    if (this._previewer) {
        if (enabledStatus) {
            this._previewer.show();
            this._previewerToggle.show();
        } else {
            this._previewer.hide();
            this._previewerToggle.hide();
        }
    }
};

WMD.prototype.getPreviewerEnabled = function () {
    return this._previewerEnabled;
};

WMD.prototype.getPreviewerElement = function () {
    return this._previewer;
};

WMD.prototype.getEditorElement = function () {
    return this._editor;
};

WMD.prototype.createDom = function () {
    this._element = this.makeElement('div');
    var clearfix = this.makeElement('div').addClass('clearfix');
    this._element.append(clearfix);

    var wmd_container = this.makeElement('div');
    wmd_container.addClass('wmd-container');
    this._editor = wmd_container;

    this._element.append(wmd_container);

    var wmd_buttons = this.makeElement('div')
                        .attr('id', this.makeId('wmd-button-bar'))
                        .addClass('wmd-panel');
    wmd_container.append(wmd_buttons);

    var editor = this.makeElement('textarea')
                        .attr('id', this.makeId('editor'));
    addExtraCssClasses(editor, 'editorClasses');
    if (this._textareaName) {
        editor.attr('name', this._textareaName);
    }

    wmd_container.append(editor);
    this._textarea = editor;

    var mirror = this.makeElement('pre').addClass('mirror');
    wmd_container.append(mirror);
    this._mirror = mirror;
    $(editor).on('change paste keyup keydown', this.getAutoResizeHandler());


    if (this._text) {
        editor.val(this._text);
    }

    var previewer = this.makeElement('div')
                        .attr('id', this.makeId('previewer'))
                        .addClass('wmd-preview');
    this._previewer = previewer;

    var toggle = new WMDExpanderToggle(this);
    this._previewerToggle = toggle;
    wmd_container.append(toggle.getElement());

    wmd_container.append(previewer);

    if (this._previewerEnabled === false) {
        previewer.hide();
        this._previewerToggle.hide();
    }
};

WMD.prototype.decorate = function (element) {
    this._element = element;
    this._textarea = element.find('textarea');
    this._previewer = element.find('.wmd-preview');
    this._mirror = element.find('.mirror');
    this._textarea.on('change paste keyup keydown', this.getAutoResizeHandler());
};

WMD.prototype.start = function () {
    Attacklab.Util.startEditor(true, this._enabled_buttons, this.getIdSeed());
    getSuperClass(WMD).start.call(this);
};

/**
 * @constructor
 */
var TinyMCE = function (config) {
    WrappedElement.call(this);
    var defaultConfig = JSON.parse(askbot['settings']['tinyMCEConfigJson']);
    this._config = $.extend(defaultConfig, config || {});

    this._id = 'editor';//desired id of the textarea
};
inherits(TinyMCE, WrappedElement);

TinyMCE.prototype.setTextareaName = function (name) {
    this._textareaName = name;
};

/*
 * not passed onto prototoype on purpose!!!
 */
TinyMCE.onInitHook = function () {
    //set initial content
    var ed = tinyMCE.activeEditor;
    //if we have spellchecker - enable it by default
    if (inArray('spellchecker', askbot.settings.tinyMCEPlugins)) {
        setTimeout(function () {
            ed.controlManager.setActive('spellchecker', true);
            tinyMCE.execCommand('mceSpellCheck', true);
        }, 1);
    }
    $('.mceStatusbar').remove();
};

TinyMCE.onChangeHook = function (editor) {
    tinyMCE.triggerSave();
    $(tinyMCE.get(editor.id).getElement()).change();
};

/* 3 dummy functions to match WMD api */
TinyMCE.prototype.setEnabledButtons = function () {};

TinyMCE.prototype.start = function () {
    //copy the options, because we need to modify them
    var opts = $.extend({}, this._config);
    var me = this;
    var extraOpts = {
        'mode': 'exact',
        'elements': this._id
    };
    opts = $.extend(opts, extraOpts);
    tinyMCE.init(opts);
    if (this._text) {
        this.setText(this._text);
    }
};
TinyMCE.prototype.setPreviewerEnabled = function () {};
TinyMCE.prototype.setHighlight = function () {};

TinyMCE.prototype.putCursorAtEnd = function () {
    var ed = tinyMCE.activeEditor;
    //add an empty span with a unique id
    var endId = tinymce.DOM.uniqueId();
    ed.dom.add(ed.getBody(), 'span', {'id': endId}, '');
    //select that span
    var newNode = ed.dom.select('span#' + endId);
    ed.selection.select(newNode[0]);
};

TinyMCE.prototype.focus = function (onFocus) {
    var editorId = this._id;
    var winH = $(window).height();
    var winY = $(window).scrollTop();
    var edY = this._element.offset().top;
    var edH = this._element.height();

    //@todo: the fallacy of this method is timeout - should instead use queue
    //because at the time of calling focus() the editor may not be initialized yet
    setTimeout(
        function () {
            tinyMCE.execCommand('mceFocus', false, editorId);

            //@todo: make this general to all editors

            //if editor bottom is below viewport
            var isBelow = ((edY + edH) > (winY + winH));
            var isAbove = (edY < winY);
            if (isBelow || isAbove) {
                //then center on screen
                $(window).scrollTop(edY - edH / 2 - winY / 2);
            }
            if (onFocus) {
                onFocus();
            }
        },
        100
    );


};

TinyMCE.prototype.setId = function (id) {
    this._id = id;
};

TinyMCE.prototype.setText = function (text) {
    this._text = text;
    if (this.isLoaded()) {
        tinymce.get(this._id).setContent(text);
    }
};

TinyMCE.prototype.getText = function () {
    return tinyMCE.activeEditor.getContent();
};

TinyMCE.prototype.getHtml = TinyMCE.prototype.getText;

TinyMCE.prototype.isLoaded = function () {
    return (typeof tinymce !== 'undefined' && tinymce.get(this._id) !== undefined);
};

TinyMCE.prototype.createDom = function () {
    var editorBox = this.makeElement('div');
    editorBox.addClass('wmd-container');
    this._element = editorBox;
    var textarea = this.makeElement('textarea');
    textarea.attr('id', this._id);
    textarea.addClass('editor');
    if (this._textareaName) {
        textarea.attr('name', this._textareaName);
    }
    //textarea.addClass(askbot.settings.tinymceEditorDeselector);
    this._element.append(textarea);
};

TinyMCE.prototype.decorate = function (element) {
    this._element = element;
    this._id = element.attr('id');
};

/**
 * Form for editing and posting new comment
 * supports 3 editors: markdown, tinymce and plain textarea.
 * There is only one instance of this form in use on the question page.
 * It can be attached to any comment on the page, or to a new blank
 * comment.
 */
var EditCommentForm = function () {
    WrappedElement.call(this);
    this._comment = null;
    this._commentsWidget = null;
    this._element = null;
    this._editorReady = false;
    this._text = '';
};
inherits(EditCommentForm, WrappedElement);

EditCommentForm.prototype.hide = function () {
    this._element.hide();
};

EditCommentForm.prototype.show = function () {
    this._element.show();
};

EditCommentForm.prototype.getEditor = function () {
    return this._editor;
};

EditCommentForm.prototype.getEditorType = function () {
    if (askbot.settings.commentsEditorType === 'rich-text') {
        return askbot.settings.editorType;
    } else {
        return 'plain-text';
    }
};

EditCommentForm.prototype.startTinyMCEEditor = function () {
    var editorId = this.makeId('comment-editor');
    var opts = {
        mode: 'exact',
        content_css: mediaUrl('media/style/tinymce/comments-content.css'),
        elements: editorId,
        theme: 'advanced',
        theme_advanced_toolbar_location: 'top',
        theme_advanced_toolbar_align: 'left',
        theme_advanced_buttons1: 'bold, italic, |, link, |, numlist, bullist',
        theme_advanced_buttons2: '',
        theme_advanced_path: false,
        plugins: '',
        width: '100%',
        height: '70'
    };
    var editor = new TinyMCE(opts);
    editor.setId(editorId);
    editor.setText(this._text);
    this._editorBox.prepend(editor.getElement());
    editor.start();
    this._editor = editor;
};

EditCommentForm.prototype.startWMDEditor = function () {
    var editor = new WMD({minLines: 3});
    editor.setEnabledButtons('bold italic link code ol ul');
    editor.setPreviewerEnabled(false);
    editor.setText(this._text);
    this._editorBox.prepend(editor.getElement());//attach DOM before start
    editor.start();//have to start after attaching DOM
    this._editor = editor;
};

EditCommentForm.prototype.startSimpleEditor = function () {
    this._editor = new SimpleEditor({minLines: 3});
    this._editorBox.prepend(this._editor.getElement());
};

EditCommentForm.prototype.startEditor = function () {
    var editorType = this.getEditorType();
    if (editorType === 'tinymce') {
        this.startTinyMCEEditor();
        //@todo: implement save on enter and character counter in tinyMCE
        return;
    } else if (editorType === 'markdown') {
        this.startWMDEditor();
    } else {
        this.startSimpleEditor();
    }

    //code below is common to SimpleEditor and WMD
    var editor = this._editor;
    var editorElement = this._editor.getElement();

    var limitLength = this.getCommentTruncator();
    editorElement.blur(limitLength);
    editorElement.focus(limitLength);
    editorElement.keyup(limitLength);
    editorElement.keyup(limitLength);

    var updateCounter = this.getCounterUpdater();
    var escapeHandler = makeKeyHandler(27, this.getCancelHandler());
    //todo: try this on the div
    //this should be set on the textarea!
    editorElement.blur(updateCounter);
    editorElement.focus(updateCounter);
    editorElement.keyup(updateCounter);
    editorElement.keyup(escapeHandler);

    if (askbot.settings.saveCommentOnEnter) {
        var save_handler = makeKeyHandler(13, this.getSaveHandler());
        editor.getElement().keydown(save_handler);
    }

    editorElement.trigger('askbot.afterStartEditor', [editor]);
};

EditCommentForm.prototype.getCommentsWidget = function () {
    return this._commentsWidget;
};

/**
 * attaches comment editor to a particular comment
 */
EditCommentForm.prototype.attachTo = function (comment, mode) {
    this._comment = comment;
    this._type = mode;//action: 'add' or 'edit'
    this._commentsWidget = comment.getContainerWidget();
    this._text = comment.getText();
    comment.getElement().after(this.getElement());
    comment.getElement().hide();
    this._commentsWidget.hideOpenEditorButton();//hide add comment button
    //fix up the comment submit button, depending on the mode
    if (this._type === 'add') {
        this._submit_btn.html(gettext('add comment'));
        if (this._minorEditBox) {
            this._minorEditBox.hide();
        }
    } else {
        this._submit_btn.html(gettext('save comment'));
        if (this._minorEditBox) {
            this._minorEditBox.show();
        }
    }
    //enable the editor
    this.getElement().show();
    this.enableForm();
    this.startEditor();
    this._editor.setText(this._text);
    var ed = this._editor;
    var onFocus = function () {
        ed.putCursorAtEnd();
    };
    this._editor.focus(onFocus);
    setupButtonEventHandlers(this._submit_btn, this.getSaveHandler());
    setupButtonEventHandlers(this._cancel_btn, this.getCancelHandler());

    this.getElement().trigger('askbot.afterEditCommentFormAttached', [this, mode]);
};

EditCommentForm.prototype.getCounterUpdater = function () {
    //returns event handler
    var counter = this._text_counter;
    var editor = this._editor;
    var handler = function () {
        var maxCommentLength = askbot.data.maxCommentLength;
        var length = editor.getText().length;
        var length1 = maxCommentLength - 100;

        if (length1 < 0) {
            length1 = Math.round(0.7 * maxCommentLength);
        }
        var length2 = maxCommentLength - 30;
        if (length2 < 0) {
            length2 = Math.round(0.9 * maxCommentLength);
        }

        /* todo make smooth color transition, from gray to red
         * or rather - from start color to end color */
        var color = 'maroon';
        var chars = askbot.settings.minCommentBodyLength;
        var feedback = '';
        if (length === 0) {
            feedback = interpolate(gettext('enter at least %s characters'), [chars]);
        } else if (length < chars) {
            feedback = interpolate(gettext('enter at least %s more characters'), [chars - length]);
        } else {
            if (length > length2) {
                color = '#f00';
            } else if (length > length1) {
                color = '#f60';
            } else {
                color = '#999';
            }
            chars = maxCommentLength - length;
            feedback = '';
            if (chars > 0) {
                feedback = interpolate(gettext('%s characters left'), [chars]);
            } else {
                feedback = gettext('maximum comment length reached');
            }
        }
        counter.html(feedback);
        counter.css('color', color);
        return true;
    };
    return handler;
};

EditCommentForm.prototype.getCommentTruncator = function () {
    var me = this;
    return function () {
        var editor = me.getEditor();
        var text = editor.getText();
        var maxLength = askbot.data.maxCommentLength;
        if (text.length > maxLength) {
            text = text.substr(0, maxLength);
            editor.setText(text);
        }
    };
};

/**
 * @todo: clean up this method so it does just one thing
 */
EditCommentForm.prototype.canCancel = function () {
    if (this._element === null) {
        return true;
    }
    if (this._editor === undefined) {
        return true;
    }
    var ctext = this._editor.getText();
    if ($.trim(ctext) === $.trim(this._text)) {
        return true;
    } else if (this.confirmAbandon()) {
        return true;
    }
    this._editor.focus();
    return false;
};

EditCommentForm.prototype.getCancelHandler = function () {
    var me = this;
    return function (evt) {
        if (me.canCancel()) {
            var widget = me.getCommentsWidget();
            widget.handleDeletedComment();
            me.detach();
            evt.preventDefault();
            $(document).trigger('askbot.afterEditCommentFormCancel', [me]);
        }
        return false;
    };
};

EditCommentForm.prototype.detach = function () {
    if (this._comment === null) {
        return;
    }
    this._comment.getContainerWidget().showOpenEditorButton();
    if (this._comment.isBlank()) {
        this._comment.dispose();
    } else {
        this._comment.getElement().show();
    }
    this.reset();
    this._element = this._element.detach();

    this._editor.dispose();
    this._editor = undefined;

    removeButtonEventHandlers(this._submit_btn);
    removeButtonEventHandlers(this._cancel_btn);
};

EditCommentForm.prototype.createDom = function () {
    this._element = $('<form></form>');
    this._element.attr('class', 'post-comments');

    var div = $('<div></div>');
    this._element.append(div);

    /** a stub container for the editor */
    this._editorBox = div;
    /**
     * editor itself will live at this._editor
     * and will be initialized by the attachTo()
     */

    this._controlsBox = this.makeElement('div');
    this._controlsBox.addClass('edit-comment-buttons');
    div.append(this._controlsBox);

    this._text_counter = $('<span></span>').attr('class', 'counter');
    this._controlsBox.append(this._text_counter);

    this._submit_btn = $('<button></button>');
    addExtraCssClasses(this._submit_btn, 'primaryButtonClasses');
    this._controlsBox.append(this._submit_btn);
    this._cancel_btn = $('<button class="cancel"></button>');
    addExtraCssClasses(this._cancel_btn, 'cancelButtonClasses');
    this._cancel_btn.html(gettext('cancel'));
    this._controlsBox.append(this._cancel_btn);

    //if email alerts are enabled, add a checkbox "suppress_email"
    if (askbot.settings.enableEmailAlerts === true) {
        this._minorEditBox = this.makeElement('div');
        this._minorEditBox.addClass('checkbox');
        this._controlsBox.append(this._minorEditBox);
        var checkBox = this.makeElement('input');
        checkBox.attr('type', 'checkbox');
        checkBox.attr('name', 'suppress_email');
        checkBox.attr('id', 'suppress_email');
        this._minorEditBox.append(checkBox);
        var label = this.makeElement('label');
        label.attr('for', 'suppress_email');
        label.html(gettext('minor edit (don\'t send alerts)'));
        this._minorEditBox.append(label);
    }

};

EditCommentForm.prototype.isEnabled = function () {
    return (this._submit_btn.attr('disabled') !== 'disabled');//confusing! setters use boolean
};

EditCommentForm.prototype.enableForm = function () {
    this._submit_btn.attr('disabled', false);
    this._cancel_btn.attr('disabled', false);
};

EditCommentForm.prototype.disableForm = function () {
    this._submit_btn.attr('disabled', true);
    this._cancel_btn.attr('disabled', true);
};

EditCommentForm.prototype.reset = function () {
    this._comment = null;
    this._text = '';
    this._editor.setText('');
    this.enableForm();
};

EditCommentForm.prototype.confirmAbandon = function () {
    this._editor.focus();
    this._editor.getElement().scrollTop();
    this._editor.setHighlight(true);
    var answer = confirm(
        gettext('Are you sure you don\'t want to post this comment?')
    );
    this._editor.setHighlight(false);
    return answer;
};

EditCommentForm.prototype.getSuppressEmail = function () {
    return this._element.find('input[name="suppress_email"]').is(':checked');
};

EditCommentForm.prototype.setSuppressEmail = function (bool) {
    this._element.find('input[name="suppress_email"]').prop('checked', bool).trigger('change');
};

EditCommentForm.prototype.updateUserPostsData = function(json) {
    //add any posts by the user to the list
    var data = askbot.data.user_posts;
    $.each(json, function(idx, item) {
        if (item.user_id === askbot.data.userId && !data[item.id]) {
            data[item.id] = 1;
        }
    });
};

EditCommentForm.prototype.getSaveHandler = function () {
    var me = this;
    var editor = this._editor;
    return function () {
        var commentData, timestamp, userName;
        if (me.isEnabled() === false) {//prevent double submits
            return false;
        }
        me.disableForm();

        var text = editor.getText();
        if (text.length < askbot.settings.minCommentBodyLength) {
            editor.focus();
            me.enableForm();
            return false;
        }

        //display the comment and show that it is not yet saved
        me.hide();
        me._comment.getElement().show();
        commentData = me._comment.getData();
        timestamp = commentData.comment_added_at || gettext('just now');
        if (me._comment.isBlank()) {
            userName = askbot.data.userName;
        } else {
            userName = commentData.user_display_name;
        }

        me._comment.setContent({
            'html': editor.getHtml(),
            'text': text,
            'user_display_name': userName,
            'comment_added_at': timestamp,
            'user_profile_url': askbot.data.userProfileUrl,
            'user_avatar_url': askbot.data.userCommentAvatarUrl
        });
        me._comment.setDraftStatus(true);
        var postCommentsWidget = me._comment.getContainerWidget();
        if (postCommentsWidget.canAddComment()) {
            postCommentsWidget.showOpenEditorButton();
        }
        var commentsElement = postCommentsWidget.getElement();
        commentsElement.trigger('askbot.beforeCommentSubmit');

        var post_data = {
            comment: text,
            avatar_size: askbot.settings.commentAvatarSize
        };

        if (me._type === 'edit') {
            post_data.comment_id = me._comment.getId();
            post_url = askbot.urls.editComment;
            post_data.suppress_email = me.getSuppressEmail();
            me.setSuppressEmail(false);
        } else {
            post_data.post_type = me._comment.getParentType();
            post_data.post_id = me._comment.getParentId();
            post_url = askbot.urls.postComments;
        }

        $.ajax({
            type: 'POST',
            url: post_url,
            dataType: 'json',
            data: post_data,
            success: function (json) {
                //type is 'edit' or 'add'
                me._comment.setDraftStatus(false);
                if (me._type === 'add') {
                    me._comment.dispose();
                    me.updateUserPostsData(json);
                    me._comment.getContainerWidget().reRenderComments(json);
                } else {
                    me._comment.setContent(json);
                }
                me.detach();
                commentsElement.trigger('askbot.afterCommentSubmitSuccess');
            },
            error: function (xhr, textStatus) {
                me._comment.getElement().show();
                showMessage(me._comment.getElement(), xhr.responseText, 'after');
                me._comment.setDraftStatus(false);
                me.detach();
                me.enableForm();
                commentsElement.trigger('askbot.afterCommentSubmitError');
            }
        });
        return false;
    };
};

var Comment = function (widget, data) {
    WrappedElement.call(this);
    this._container_widget = widget;
    this._data = data || {};
    this._element = null;
    this._is_convertible = askbot.data.userIsAdminOrMod;
    this.convert_link = null;
    this._delete_prompt = gettext('delete this comment');
    this._editorForm = undefined;
    if (data && data.is_deletable) {
        this._deletable = data.is_deletable;
    } else {
        this._deletable = false;
    }
    if (data && data.is_editable) {
        this._editable = data.is_deletable;
    } else {
        this._editable = false;
    }
};
inherits(Comment, WrappedElement);

Comment.prototype.getData = function () {
    return this._data;
};

Comment.prototype.startEditing = function () {
    var form = this._editorForm || new EditCommentForm();
    this._editorForm = form;
    // if new comment:
    if (this.isBlank()) {
        form.attachTo(this, 'add');
    } else {
        form.attachTo(this, 'edit');
    }
    form.show();
};

Comment.prototype.decorate = function (element) {
    this._element = $(element);
    var parent_type = this._element.closest('.comments').data('parentPostType');
    var comment_id = this._element.data('postId') || undefined;
    this._data = {'id': comment_id};

    this._contentBox = this._element.find('.comment-content');

    var timestamp = this._element.find('.timeago');
    this._dateElement = timestamp;
    this._data.comment_added_at = timestamp.attr('title');
    var userLink = this._element.find('.author');
    this._data.user_display_name = userLink.html();
    // @todo: read other data

    var commentBody = this._element.find('.comment-body');
    if (commentBody.length > 0) {
        this._comment_body = commentBody;
    }

    var delete_img = this._element.find('.js-delete-icon');
    if (delete_img.length > 0) {
        this._deletable = true;
        this._delete_icon = new DeleteIcon(this.deletePrompt);
        this._delete_icon.setHandler(this.getDeleteHandler());
        this._delete_icon.decorate(delete_img);
    }
    var edit_link = this._element.find('.js-edit');
    if (edit_link.length > 0) {
        this._editable = true;
        this._edit_link = new EditLink();
        this._edit_link.setHandler(this.getEditHandler());
        this._edit_link.decorate(edit_link);
    }

    var convert_link = this._element.find('.convert-comment');
    if (this._is_convertible) {
        this._convert_link = new CommentConvertLink(comment_id);
        this._convert_link.decorate(convert_link);
    } else {
        convert_link.remove();
    }

    var deleter = this._element.find('.comment-delete');
    if (deleter.length > 0) {
        this._comment_delete = deleter;
    }

    var vote = new CommentVoteButton(this);
    vote.decorate(this._element.find('.upvote'));
    this._voteButton = vote;

    this._userLink = this._element.find('.author');

    this._element.trigger('askbot.afterCommentDecorate', [this]);
};

Comment.prototype.setDraftStatus = function (isDraft) {
    return;
    //@todo: implement nice feedback about posting in progress
    //maybe it should be an element that lasts at least a second
    //to avoid the possible brief flash
    // if (isDraft === true) {
    //     this._normalBackground = this._element.css('background');
    //     this._element.css('background', 'rgb(255, 243, 195)');
    // } else {
    //     this._element.css('background', this._normalBackground);
    // }
};


Comment.prototype.isBlank = function () {
    return this.getId() === undefined;
};

Comment.prototype.getId = function () {
    return this._data ? this._data.id : undefined;
};

Comment.prototype.hasContent = function () {
    return ('id' in this._data);
    //shortcut for 'user_profile_url' 'html' 'user_display_name' 'comment_age'
};

Comment.prototype.hasText = function () {
    return ('text' in this._data);
};

Comment.prototype.getContainerWidget = function () {
    return this._container_widget;
};

Comment.prototype.getParentType = function () {
    return this._container_widget.getPostType();
};

Comment.prototype.getParentId = function () {
    return this._container_widget.getPostId();
};

/**
 * this function is basically an "updateDom"
 */
Comment.prototype.setContent = function (data) {
    this._data = $.extend(this._data, data);
    data = this._data;
    this._element.data('postId', data.id);
    this._element.attr('data-post-id', data.id);
    this._element.attr('id', 'post-id-' + data.id);

    // 1) create the votes element if it is not there
    var vote = this._voteButton;
    vote.setVoted(data.upvoted_by_user);
    vote.setScore(data.score);

    // 2) maybe adjust deletable status
    //set id of the comment deleter
    if (data.id) {
        var deleter = this._element.find('.comment-delete');
        deleter.attr('id', 'post-' + data.id.toString() + '-delete');
    }

    // 3) set the comment html
    if (EditCommentForm.prototype.getEditorType() === 'tinymce') {
        var theComment = $('<div/>');
        theComment.html(data.html);
        //sanitize, just in case
        this._comment_body.empty();
        this._comment_body.append(theComment);
        this._data.text = data.html;
    } else {
        this._comment_body.empty();
        this._comment_body.html(data.html);
    }

    // 4) update user info
    this._userLink.attr('href', data.user_profile_url);
    this._userLink.html(data.user_display_name);

    // 5) update avatar
    var avatar = this._element.find('.js-avatar-box');
    if (avatar.length) {
        avatar.attr('href', data.user_profile_url);
        var img = avatar.find('.js-avatar');
        img.attr('src', decodeHtml(data.user_avatar_url));//with decoded &amp;
    }

    // 6) update the timestamp
    this._dateElement.html(data.comment_added_at);
    this._dateElement.attr('title', data.comment_added_at);
    this._dateElement.timeago();

    // 7) set comment score
    if (data.score) {
        var votes = this._element.find('.js-score');
        votes.text(data.score);
        votes.attr('id', 'comment-img-upvote-' + data.id.toString());
    }

    // 8) possibly add edit link
    if (this._editable) {
        var oldEditLink = this._edit_link;
        this._edit_link = new EditLink();
        this._edit_link.setHandler(this.getEditHandler());
        oldEditLink.getElement().replaceWith(this._edit_link.getElement());
        oldEditLink.dispose();
    }

    if (this._is_convertible) {
        var oldConvertLink = this._convert_link;
        this._convert_link = new CommentConvertLink(this._data.id);
        oldConvertLink.getElement().replaceWith(this._convert_link.getElement());
        //this has to be here, because if we trigger events inside of the
        //CommentConvertLink functions since the element is not yet in the dom we
        //will never catch the event
        this._convert_link.getElement().trigger('askbot.afterCommentConvertLinkInserted', [this._convert_link]);
        oldConvertLink.dispose();
    }
    //maybe hide edit/delete buttons
    if (data.id) {
        askbot['functions']['renderPostControls'](data.id.toString());
        askbot['functions']['renderPostVoteButtons']('comment', data.id.toString());
    }
    if (askbot.settings.mathjaxEnabled === true) {
        runMathJax();
    }
    this._element.trigger('askbot.afterCommentSetData', [this, data]);
};

Comment.prototype.dispose = function () {
    if (this._comment_body) {
        this._comment_body.remove();
    }
    if (this._comment_delete) {
        this._comment_delete.remove();
    }
    if (this._user_link) {
        this._user_link.remove();
    }
    if (this._comment_added_at) {
        this._comment_added_at.remove();
    }
    if (this._delete_icon) {
        this._delete_icon.dispose();
    }
    if (this._edit_link) {
        this._edit_link.dispose();
    }
    if (this._convert_link) {
        this._convert_link.dispose();
    }
    this._data = null;
    Comment.superClass_.dispose.call(this);
};

Comment.prototype.getElement = function () {
    Comment.superClass_.getElement.call(this);
    if (this.isBlank() && this.hasContent()) {
        this.setContent();
    }
    return this._element;
};

Comment.prototype.loadText = function (on_load_handler) {
    var me = this;
    $.ajax({
        type: 'GET',
        url: askbot.urls.getComment,
        data: {id: this._data.id},
        success: function (json) {
            if (json.success) {
                me._data.text = json.text;
                on_load_handler();
            } else {
                showMessage(me.getElement(), json.message, 'after');
            }
        },
        error: function (xhr, textStatus, exception) {
            showMessage(me.getElement(), xhr.responseText, 'after');
        }
    });
};

Comment.prototype.getText = function () {
    if (!this.isBlank()) {
        if ('text' in this._data) {
            return this._data.text;
        }
    }
    return '';
};

Comment.prototype.getEditHandler = function () {
    var me = this;
    return function () {
        if (me.hasText()) {
            me.startEditing();
        } else {
            me.loadText(function () { me.startEditing(); });
        }
    };
};

Comment.prototype.getDeleteHandler = function () {
    var comment = this;
    var del_icon = this._delete_icon;
    return function () {
        if (confirm(gettext('confirm delete comment'))) {
            //comment.getElement().hide();
            $.ajax({
                type: 'POST',
                url: askbot.urls.deleteComment,
                data: {
                    comment_id: comment.getId(),
                    avatar_size: askbot.settings.commentAvatarSize
                },
                success: function (json, textStatus, xhr) {
                    var widget = comment.getContainerWidget();
                    comment.dispose();
                    widget.handleDeletedComment();
                },
                error: function (xhr, textStatus, exception) {
                    comment.getElement().show();
                    showMessage(del_icon.getElement(), xhr.responseText);
                },
                dataType: 'json'
            });
        }
    };
};

var PostCommentsWidget = function () {
    WrappedElement.call(this);
    this._denied = false;
};
inherits(PostCommentsWidget, WrappedElement);

PostCommentsWidget.prototype.decorate = function (element) {
    this._element = element;
    this._post_id = element.data('parentPostId');
    this._post_type = element.data('parentPostType');
    //var widget_id = element.attr('id');
    //this._userCanPost = askbot['data'][widget_id]['can_post'];
    this._commentsReversed = askbot.settings.commentsReversed;

    //see if user can comment here
    this._loadCommentsButton = element.find('.js-load-comments-btn');

    if (this._loadCommentsButton.length) {
        if (this._commentsReversed/* || this._userCanPost */) {
            setupButtonEventHandlers(
                this._loadCommentsButton,
                this.getLoadCommentsHandler()
            );
        } else {
            setupButtonEventHandlers(
                this._loadCommentsButton,
                this.getAllowEditHandler()
            );
        }
    }

    this._openEditorButton = element.find('.js-open-editor-btn');
    if (this._openEditorButton.length) {
        setupButtonEventHandlers(
            this._openEditorButton,
            this.getOpenEditorHandler(this._openEditorButton)
        );
    }

    this._isTruncated = this._openEditorButton.hasClass('hidden');

    this._cbox = element.find('.content');
    var comments = [];
    var me = this;
    this._cbox.children('.comment').each(function (index, element) {
        var comment = new Comment(me);
        comments.push(comment);
        comment.decorate(element);
    });
    this._comments = comments;
};

PostCommentsWidget.prototype.handleDeletedComment = function () {
    /* if the widget does not have any comments, set
    the 'empty' class on the widget element */
    if (this._cbox.children('.comment').length === 0) {
        if (this._commentsReversed === false) {
            this._element.siblings('.comment-title').hide();
        }
        this._element.addClass('empty');
    }
};

PostCommentsWidget.prototype.getPostType = function () {
    return this._post_type;
};

PostCommentsWidget.prototype.getPostId = function () {
    return this._post_id;
};

PostCommentsWidget.prototype.getLoadCommentsButton = function () {
    return this._loadCommentsButton;
};

PostCommentsWidget.prototype.getOpenEditorButton = function () {
    return this._openEditorButton;
};

PostCommentsWidget.prototype.hideOpenEditorButton = function () {
    this._openEditorButton.hide();
    this._openEditorButton.addClass('hidden');
};

PostCommentsWidget.prototype.showOpenEditorButton = function () {
    this._openEditorButton.show();
    this._openEditorButton.removeClass('hidden');
};

PostCommentsWidget.prototype.startNewComment = function () {
    //find comment template, clone it's dom
    var comment = new Comment(this);
    var commentElem = getTemplate('.js-comment');
    if (this._commentsReversed) {
        this._cbox.prepend(commentElem);
    } else {
        this._cbox.append(commentElem);
    }
    comment.decorate(commentElem);
    this._element.removeClass('empty');
    this._element.trigger('askbot.beforeCommentStart');
    comment.startEditing();
};

PostCommentsWidget.prototype.canAddComment = function () {
    return this._commentsReversed || this._isTruncated === false;
};

PostCommentsWidget.prototype.userCanPost = function () {
    var data = askbot.data;
    if (data.userIsAuthenticated) {
        //true if admin, post owner or high rep user
        if (data.userIsAdminOrMod) {
            return true;
        } else if (this.getPostId() in data.user_posts) {
            return true;
        }
    }
    return false;
};

PostCommentsWidget.prototype.getAllowEditHandler = function () {
    var me = this;
    return function () {
        me.reloadAllComments(function (json) {
            me.reRenderComments(json);
            //2) change button text to "post a comment"
            me.getLoadCommentsButton().remove();
            me.showOpenEditorButton();
        });
    };
};

PostCommentsWidget.prototype.getOpenEditorHandler = function (button) {
    var me = this;
    return function () {
        //if user can't post, we tell him something and refuse
        var message;
        if (askbot.settings.readOnlyModeEnabled === true) {
            message = askbot.messages.readOnlyMessage;
            showMessage(button, message, 'after');
        } else if (askbot.data.userIsAuthenticated) {
            me.startNewComment();
        } else {
            message = gettext(
                'please sign in or register to post comments'
            );
            showMessage(button, message, 'after');
        }
    };
};

PostCommentsWidget.prototype.getLoadCommentsHandler = function () {
    var me = this;
    return function () {
        me.reloadAllComments(function (json) {
            me.reRenderComments(json);
            me.getLoadCommentsButton().remove();
        });
    };
};


PostCommentsWidget.prototype.reloadAllComments = function (callback) {
    var post_data = {
        post_id: this._post_id,
        post_type: this._post_type,
        avatar_size: askbot.settings.commentAvatarSize
    };
    var me = this;
    $.ajax({
        type: 'GET',
        url: askbot.urls.postComments,
        data: post_data,
        success: function (json) {
            callback(json);
            me._isTruncated = false;
        },
        dataType: 'json'
    });
};

PostCommentsWidget.prototype.reRenderComments = function (json) {
    var me = this;
    me._cbox.trigger('askbot.beforeReRenderComments', [this, json]);
    $.each(this._comments, function (i, item) {
        item.dispose();
    });
    this._comments = [];
    $.each(json, function (i, item) {
        var comment = new Comment(me);
        var commentElem = getTemplate('.js-comment');
        me._cbox.append(commentElem);
        comment.decorate(commentElem);
        comment.setContent(item);
        me._comments.push(comment);
    });
    me._cbox.trigger('askbot.afterReRenderComments', [this, json]);
};


var socialSharing = (function () {

    var SERVICE_DATA = {
        //url - template for the sharing service url, params are for the popup
        identica: {
            url: 'http://identi.ca/notice/new?status_textarea={TEXT}%20{URL}',
            params: 'width=820, height=526,toolbar=1,status=1,resizable=1,scrollbars=1'
        },
        twitter: {
            url: 'http://twitter.com/share?url={URL}&ref=twitbtn&text={TEXT}',
            params: 'width=820,height=526,toolbar=1,status=1,resizable=1,scrollbars=1'
        },
        facebook: {
            url: 'http://www.facebook.com/sharer.php?u={URL}&ref=fbshare&t={TEXT}',
            params: 'width=630,height=436,toolbar=1,status=1,resizable=1,scrollbars=1'
        },
        linkedin: {
            url: 'http://www.linkedin.com/shareArticle?mini=true&url={URL}&title={TEXT}',
            params: 'width=630,height=436,toolbar=1,status=1,resizable=1,scrollbars=1'
        }
    };
    var URL = '';
    var TEXT = '';

    var share_page = function (service_name) {
        if (SERVICE_DATA[service_name]) {
            var url = SERVICE_DATA[service_name].url;
            url = url.replace('{TEXT}', TEXT);
            url = url.replace('{URL}', URL);
            var params = SERVICE_DATA[service_name].params;
            if (!window.open(url, 'sharing', params)) {
                window.location.href = url;
            }
            return false;
            //@todo: change to some other url shortening service
            // $.ajax({
            //     url: "http://json-tinyurl.appspot.com/?&callback=?",
            //     dataType: 'json',
            //     data: {'url':URL},
            //     success: function (data) {
            //         url = url.replace('{URL}', data.tinyurl);
            //     },
            //     error: function (xhr, opts, error) {
            //         url = url.replace('{URL}', URL);
            //     },
            //     complete: function (data) {
            //         url = url.replace('{TEXT}', TEXT);
            //         var params = SERVICE_DATA[service_name].params;
            //         if (!window.open(url, "sharing", params)) {
            //             window.location.href=url;
            //         }
            //     }
            // });
        }
    };

    return {
        init: function () {
            URL = window.location.href;
            var urlBits = URL.split('/');
            URL = urlBits.slice(0, -2).join('/') + '/';
            TEXT = encodeURIComponent($('h1 > a').text());
            var hashtag = encodeURIComponent(
                                askbot.settings.sharingSuffixText
                            );
            TEXT = TEXT.substr(0, 134 - URL.length - hashtag.length);
            TEXT = TEXT + '... ' + hashtag;
            var fb = $('a.facebook-share');
            var tw = $('a.twitter-share');
            var ln = $('a.linkedin-share');
            var ica = $('a.identica-share');
            copyAltToTitle(fb);
            copyAltToTitle(tw);
            copyAltToTitle(ln);
            copyAltToTitle(ica);
            setupButtonEventHandlers(fb, function () { share_page('facebook'); });
            setupButtonEventHandlers(tw, function () { share_page('twitter'); });
            setupButtonEventHandlers(ln, function () { share_page('linkedin'); });
            setupButtonEventHandlers(ica, function () { share_page('identica'); });
        }
    };
})();

/**
 * @constructor
 * @todo: change this to generic object description editor
 */
var TagWikiEditor = function () {
    WrappedElement.call(this);
    this._state = 'display';//'edit' or 'display'
    this._content_backup  = '';
    this._is_editor_loaded = false;
    this._enabled_editor_buttons = null;
    this._previewerEnabled = false;
};
inherits(TagWikiEditor, WrappedElement);

TagWikiEditor.prototype.backupContent = function () {
    this._content_backup = this._content_box.contents();
};

TagWikiEditor.prototype.setEnabledEditorButtons = function (buttons) {
    this._enabled_editor_buttons = buttons;
};

TagWikiEditor.prototype.setPreviewerEnabled = function (state) {
    this._previewerEnabled = state;
    if (this.isEditorLoaded()) {
        this._editor.setPreviewerEnabled(this._previewerEnabled);
    }
};

TagWikiEditor.prototype.setContent = function (content) {
    this._content_box.empty();
    this._content_box.append(content);
};

TagWikiEditor.prototype.setState = function (state) {
    if (state === 'edit') {
        this._state = state;
        this._edit_btn.hide();
        this._cancel_btn.show();
        this._save_btn.show();
        this._cancel_sep.show();
    } else if (state === 'display') {
        this._state = state;
        this._edit_btn.show();
        this._cancel_btn.hide();
        this._cancel_sep.hide();
        this._save_btn.hide();
    }
};

TagWikiEditor.prototype.restoreContent = function () {
    var content_box = this._content_box;
    content_box.empty();
    $.each(this._content_backup, function (idx, element) {
        content_box.append(element);
    });
};

TagWikiEditor.prototype.getTagId = function () {
    return this._tag_id;
};

TagWikiEditor.prototype.isEditorLoaded = function () {
    return this._is_editor_loaded;
};

TagWikiEditor.prototype.setEditorLoaded = function () {
    this._is_editor_loaded = true;
    return true;
};

/**
 * loads initial data for the editor input and activates
 * the editor
 */
TagWikiEditor.prototype.startActivatingEditor = function () {
    var editor = this._editor;
    var me = this;
    var data = {
        object_id: me.getTagId(),
        model_name: 'Group'
    };
    $.ajax({
        type: 'GET',
        url: askbot.urls.load_object_description,
        data: data,
        cache: false,
        success: function (data) {
            me.backupContent();
            editor.setText(data);
            me.setContent(editor.getElement());
            me.setState('edit');
            if (me.isEditorLoaded() === false) {
                editor.start();
                me.setEditorLoaded();
            }
        }
    });
};

TagWikiEditor.prototype.saveData = function () {
    var me = this;
    var text = this._editor.getText();
    var data = {
        object_id: me.getTagId(),
        model_name: 'Group',//todo: fixme
        text: text
    };
    $.ajax({
        type: 'POST',
        dataType: 'json',
        url: askbot.urls.save_object_description,
        data: data,
        cache: false,
        success: function (data) {
            if (data.success) {
                me.setState('display');
                me.setContent(data.html);
            } else {
                showMessage(me.getElement(), data.message);
            }
        }
    });
};

TagWikiEditor.prototype.cancelEdit = function () {
    this.restoreContent();
    this.setState('display');
};

TagWikiEditor.prototype.decorate = function (element) {
    //expect <div id='group-wiki-{{id}}'><div class="content"/><a class="edit"/></div>
    this._element = element;
    var edit_btn = element.find('.edit-description');
    this._edit_btn = edit_btn;

    //adding two buttons...
    var save_btn = this.makeElement('a');
    save_btn.html(gettext('save'));
    edit_btn.after(save_btn);
    save_btn.hide();
    this._save_btn = save_btn;

    var cancel_btn = this.makeElement('a');
    cancel_btn.html(gettext('cancel'));
    save_btn.after(cancel_btn);
    cancel_btn.hide();
    this._cancel_btn = cancel_btn;

    this._cancel_sep = $('<span> | </span>');
    cancel_btn.before(this._cancel_sep);
    this._cancel_sep.hide();

    this._content_box = element.find('.content');
    this._tag_id = element.attr('id').split('-').pop();

    var me = this;
    var editor;
    if (askbot.settings.editorType === 'markdown') {
        editor = new WMD({minLines: 3});
    } else {
        editor = new TinyMCE({//override defaults
            theme_advanced_buttons1: 'bold, italic, |, link, |, numlist, bullist',
            theme_advanced_buttons2: '',
            theme_advanced_path: false,
            plugins: ''
        });
    }
    if (this._enabled_editor_buttons) {
        editor.setEnabledButtons(this._enabled_editor_buttons);
    }
    editor.setPreviewerEnabled(this._previewerEnabled);
    this._editor = editor;
    setupButtonEventHandlers(edit_btn, function () { me.startActivatingEditor(); });
    setupButtonEventHandlers(cancel_btn, function () {me.cancelEdit(); });
    setupButtonEventHandlers(save_btn, function () {me.saveData(); });
};

var ImageChanger = function () {
    WrappedElement.call(this);
    this._image_element = undefined;
    this._delete_button = undefined;
    this._save_url = undefined;
    this._delete_url = undefined;
    this._messages = undefined;
};
inherits(ImageChanger, WrappedElement);

ImageChanger.prototype.setImageElement = function (image_element) {
    this._image_element = image_element;
};

ImageChanger.prototype.setMessages = function (messages) {
    this._messages = messages;
};

ImageChanger.prototype.setDeleteButton = function (delete_button) {
    this._delete_button = delete_button;
};

ImageChanger.prototype.setSaveUrl = function (url) {
    this._save_url = url;
};

ImageChanger.prototype.setDeleteUrl = function (url) {
    this._delete_url = url;
};

ImageChanger.prototype.setAjaxData = function (data) {
    this._ajax_data = data;
};

ImageChanger.prototype.showImage = function (image_url) {
    this._image_element.attr('src', image_url);
    this._image_element.show();
};

ImageChanger.prototype.deleteImage = function () {
    this._image_element.attr('src', '');
    this._image_element.css('display', 'none');

    var me = this;
    var delete_url = this._delete_url;
    var data = this._ajax_data;
    $.ajax({
        type: 'POST',
        dataType: 'json',
        url: delete_url,
        data: data,
        cache: false,
        success: function (data) {
            if (data.success) {
                showMessage(me.getElement(), data.message, 'after');
            }
        }
    });
};

ImageChanger.prototype.saveImageUrl = function (image_url) {
    var me = this;
    var data = this._ajax_data;
    data.image_url = image_url;
    var save_url = this._save_url;
    $.ajax({
        type: 'POST',
        dataType: 'json',
        url: save_url,
        data: data,
        cache: false,
        success: function (data) {
            if (!data.success) {
                showMessage(me.getElement(), data.message, 'after');
            }
        }
    });
};

ImageChanger.prototype.startDialog = function () {
    //reusing the wmd's file uploader
    var me = this;
    var change_image_text = this._messages.change_image;
    var change_image_button = this._element;
    Attacklab.Util.prompt(
        '<h3>' + gettext('Enter the logo url or upload an image') + '</h3>',
        'http://',
        function (image_url) {
            if (image_url) {
                me.saveImageUrl(image_url);
                me.showImage(image_url);
                change_image_button.html(change_image_text);
                me.showDeleteButton();
            }
        },
        'image'
    );
};

ImageChanger.prototype.showDeleteButton = function () {
    this._delete_button.show();
    this._delete_button.prev().show();
};

ImageChanger.prototype.hideDeleteButton = function () {
    this._delete_button.hide();
    this._delete_button.prev().hide();
};


ImageChanger.prototype.startDeleting = function () {
    if (confirm(gettext('Do you really want to remove the image?'))) {
        this.deleteImage();
        this._element.html(this._messages.add_image);
        this.hideDeleteButton();
        this._delete_button.hide();
        var sep = this._delete_button.prev();
        sep.hide();
    }
};

/**
 * decorates an element that will serve as the image changer button
 */
ImageChanger.prototype.decorate = function (element) {
    this._element = element;
    var me = this;
    setupButtonEventHandlers(
        element,
        function () {
            me.startDialog();
        }
    );
    setupButtonEventHandlers(
        this._delete_button,
        function () {
            me.startDeleting();
        }
    );
};

var UserGroupProfileEditor = function () {
    TagWikiEditor.call(this);
};
inherits(UserGroupProfileEditor, TagWikiEditor);

UserGroupProfileEditor.prototype.toggleEmailModeration = function () {
    var btn = this._moderate_email_btn;
    var group_id = this.getTagId();
    $.ajax({
        type: 'POST',
        dataType: 'json',
        cache: false,
        data: {group_id: group_id},
        url: askbot.urls.toggle_group_email_moderation,
        success: function (data) {
            if (data.success) {
                btn.html(data.new_button_text);
            } else {
                showMessage(btn, data.message);
            }
        }
    });
};

UserGroupProfileEditor.prototype.decorate = function (element) {
    this.setEnabledEditorButtons('bold italic link ol ul');
    this.setPreviewerEnabled(false);
    UserGroupProfileEditor.superClass_.decorate.call(this, element);
    var change_logo_btn = element.find('.change-logo');
    this._change_logo_btn = change_logo_btn;

    var moderate_email_toggle = new AjaxToggle();
    moderate_email_toggle.setPostData({
        group_id: this.getTagId(),
        property_name: 'moderate_email'
    });
    var moderate_email_btn = element.find('#moderate-email');
    this._moderate_email_btn = moderate_email_btn;
    moderate_email_toggle.decorate(moderate_email_btn);

    var moderate_publishing_replies_toggle = new AjaxToggle();
    moderate_publishing_replies_toggle.setPostData({
        group_id: this.getTagId(),
        property_name: 'moderate_answers_to_enquirers'
    });
    var btn = element.find('#moderate-answers-to-enquirers');
    moderate_publishing_replies_toggle.decorate(btn);

    var vip_toggle = new AjaxToggle();
    vip_toggle.setPostData({
        group_id: this.getTagId(),
        property_name: 'is_vip'
    });
    btn = element.find('#vip-toggle');
    vip_toggle.decorate(btn);

    var readOnlyToggle = new AjaxToggle();
    readOnlyToggle.setPostData({
        group_id: this.getTagId(),
        property_name: 'read_only'
    });
    btn = element.find('#read-only-toggle');
    readOnlyToggle.decorate(btn);

    var opennessSelector = new DropdownSelect();
    var selectorElement = element.find('#group-openness-selector');
    opennessSelector.setPostData({
        group_id: this.getTagId(),
        property_name: 'openness'
    });
    opennessSelector.decorate(selectorElement);

    var email_editor = new TextPropertyEditor();
    email_editor.decorate(element.find('#preapproved-emails'));

    var domain_editor = new TextPropertyEditor();
    domain_editor.decorate(element.find('#preapproved-email-domains'));

    var logo_changer = new ImageChanger();
    logo_changer.setImageElement(element.find('.group-logo'));
    logo_changer.setAjaxData({
        group_id: this.getTagId()
    });
    logo_changer.setSaveUrl(askbot.urls.save_group_logo_url);
    logo_changer.setDeleteUrl(askbot.urls.delete_group_logo_url);
    logo_changer.setMessages({
        change_image: gettext('change logo'),
        add_image: gettext('add logo')
    });
    var delete_logo_btn = element.find('.delete-logo');
    logo_changer.setDeleteButton(delete_logo_btn);
    logo_changer.decorate(change_logo_btn);
};

var GroupJoinButton = function () {
    AjaxToggle.call(this);
};
inherits(GroupJoinButton, AjaxToggle);

GroupJoinButton.prototype.getPostData = function () {
    return { group_id: this._group_id };
};

GroupJoinButton.prototype.getHandler = function () {
    var me = this;
    return function () {
        $.ajax({
            type: 'POST',
            dataType: 'json',
            cache: false,
            data: me.getPostData(),
            url: askbot.urls.join_or_leave_group,
            success: function (data) {
                if (data.success) {
                    var level = data.membership_level;
                    var new_state = 'off-state';
                    if (level === 'full' || level === 'pending') {
                        new_state = 'on-state';
                    }
                    me.setState(new_state);
                } else {
                    showMessage(me.getElement(), data.message);
                }
            }
        });
    };
};
GroupJoinButton.prototype.decorate = function (elem) {
    GroupJoinButton.superClass_.decorate.call(this, elem);
    this._group_id = this._element.data('groupId');
};

var TagEditor = function () {
    WrappedElement.call(this);
    this._has_hot_backspace = false;
    this._settings = JSON.parse(askbot.settings.tag_editor);
};
inherits(TagEditor, WrappedElement);

TagEditor.prototype.getSelectedTags = function () {
    return $.trim(this._hidden_tags_input.val()).split(/\s+/);
};

TagEditor.prototype.setSelectedTags = function (tag_names) {
    this._hidden_tags_input.val($.trim(tag_names.join(' ')));
};

TagEditor.prototype.addSelectedTag = function (tag_name) {
    var tag_names = this._hidden_tags_input.val();
    this._hidden_tags_input.val(tag_names + ' ' + tag_name);
    $('.acResults').hide();//a hack to hide the autocompleter
};

TagEditor.prototype.isSelectedTagName = function (tag_name) {
    var tag_names = this.getSelectedTags();
    return $.inArray(tag_name, tag_names) !== -1;
};

TagEditor.prototype.removeSelectedTag = function (tag_name) {
    var tag_names = this.getSelectedTags();
    var idx = $.inArray(tag_name, tag_names);
    if (idx !== -1) {
        tag_names.splice(idx, 1);
    }
    this.setSelectedTags(tag_names);
};

TagEditor.prototype.getTagDeleteHandler = function (tag) {
    var me = this;
    return function () {
        me.removeSelectedTag(tag.getName());
        me.clearErrorMessage();
        var li = tag.getElement().parent();
        tag.dispose();
        li.remove();
        $('.acResults').hide();//a hack to hide the autocompleter
        me.fixHeight();
    };
};

TagEditor.prototype.cleanTag = function (tag_name, reject_dupe) {
    tag_name = $.trim(tag_name);
    tag_name = tag_name.replace(/\s+/, ' ');

    var force_lowercase = this._settings.force_lowercase_tags;
    if (force_lowercase) {
        tag_name = tag_name.toLowerCase();
    }

    if (reject_dupe && this.isSelectedTagName(tag_name)) {
        throw interpolate(
            gettext('tag "%s" was already added, no need to repeat (press "escape" to delete)'),
            [tag_name]
        );
    }

    var max_tags = this._settings.max_tags_per_post;
    if (this.getSelectedTags().length + 1 > max_tags) {//count current
        throw interpolate(
            ngettext(
                'a maximum of %s tag is allowed',
                'a maximum of %s tags are allowed',
                max_tags
            ),
            [max_tags]
        );
    }

    //generic cleaning
    return cleanTag(tag_name, this._settings);
};

TagEditor.prototype.addTag = function (tag_name) {
    var tag = new Tag();
    tag.setName(tag_name);
    tag.setDeletable(true);
    tag.setLinkable(true);
    tag.setDeleteHandler(this.getTagDeleteHandler(tag));
    var li = this.makeElement('li');
    this._tags_container.append(li);
    li.append(tag.getElement());
    this.addSelectedTag(tag_name);
};

TagEditor.prototype.immediateClearErrorMessage = function () {
    this._error_alert.html('');
    this._error_alert.show();
    //this._element.css('margin-top', '18px');//todo: the margin thing is a hack
};

TagEditor.prototype.clearErrorMessage = function (fade) {
    if (fade) {
        var me = this;
        this._error_alert.fadeOut(function () {
            me.immediateClearErrorMessage();
        });
    } else {
        this.immediateClearErrorMessage();
    }
};

TagEditor.prototype.setErrorMessage = function (text) {
    var old_text = this._error_alert.html();
    this._error_alert.html(text);
    if (old_text === '') {
        this._error_alert.hide();
        this._error_alert.fadeIn(100);
    }
    //this._element.css('margin-top', '0');//todo: remove this hack
};

TagEditor.prototype.getAddTagHandler = function () {
    var me = this;
    return function (tag_name) {
        if (me.isSelectedTagName(tag_name)) {
            return;
        }
        try {
            var clean_tag_name = me.cleanTag($.trim(tag_name));
            me.addTag(clean_tag_name);
            me.clearNewTagInput();
            me.fixHeight();
        } catch (error) {
            me.setErrorMessage(error);
            setTimeout(function () {
                me.clearErrorMessage(true);
            }, 1000);
        }
    };
};

TagEditor.prototype.getRawNewTagValue = function () {
    return this._visible_tags_input.val();//without trimming
};

TagEditor.prototype.clearNewTagInput = function () {
    return this._visible_tags_input.val('');
};

TagEditor.prototype.editLastTag = function () {
    //delete rendered tag
    var tc = this._tags_container;
    tc.find('li:last').remove();
    //remove from hidden tags input
    var tags = this.getSelectedTags();
    var last_tag = tags.pop();
    this.setSelectedTags(tags);
    //populate the tag editor
    this._visible_tags_input.val(last_tag);
    putCursorAtEnd(this._visible_tags_input);
};

TagEditor.prototype.setHotBackspace = function (is_hot) {
    this._has_hot_backspace = is_hot;
};

TagEditor.prototype.hasHotBackspace = function () {
    return this._has_hot_backspace;
};

TagEditor.prototype.completeTagInput = function (reject_dupe) {
    var tag_name = $.trim(this._visible_tags_input.val());
    try {
        tag_name = this.cleanTag(tag_name, reject_dupe);
        this.addTag(tag_name);
        this.clearNewTagInput();
    } catch (error) {
        this.setErrorMessage(error);
    }
};

TagEditor.prototype.saveHeight = function () {
    return;
    // var elem = this._visible_tags_input;
    // this._height = elem.offset().top;
};

TagEditor.prototype.fixHeight = function () {
    return;
    // var new_height = this._visible_tags_input.offset().top;
    // //@todo: replace this by real measurement
    // var element_height = parseInt(
    //     this._element.css('height').replace('px', '')
    // );
    // if (new_height > this._height) {
    //     this._element.css('height', element_height + 28);//magic number!!!
    // } else if (new_height < this._height) {
    //     this._element.css('height', element_height - 28);//magic number!!!
    // }
    // this.saveHeight();
};

TagEditor.prototype.closeAutoCompleter = function () {
    this._autocompleter.finish();
};

TagEditor.prototype.getTagInputKeyHandler = function () {
    var new_tags = this._visible_tags_input;
    var me = this;
    return function (e) {
        if (e.shiftKey) {
            return;
        }
        me.saveHeight();
        var key = e.which || e.keyCode;
        var text = me.getRawNewTagValue();

        //space 32, enter 13
        if (key === 32 || key === 13) {
            var tag_name = $.trim(text);
            if (tag_name.length > 0) {
                try {
                    tag_name = me.cleanTag(tag_name, true);
                    $.ajax({
                        type: 'POST',
                        url: askbot['urls']['cleanTagName'],
                        data: {'tag_name': tag_name},
                        dataType: 'json',
                        cache: false,
                        success: function (data) {
                            if (data['success']) {
                                me.addTag(data['cleaned_tag_name']);
                                me.clearNewTagInput();
                                me.fixHeight();
                            } else if (data['message']) {
                                me.setErrorMessage(data['message']);
                                setTimeout(function () {
                                    me.clearErrorMessage(true);
                                }, 1000);
                            }
                        }
                    });
                } catch (error) {
                    me.setErrorMessage(error);
                }
            }
            return false;
        }

        if (text === '') {
            me.clearErrorMessage();
            me.closeAutoCompleter();
        } else {
            try {
                /* do-nothing validation here
                 * just to report any errors while
                 * the user is typing */
                me.cleanTag(text);
                me.clearErrorMessage();
            } catch (error) {
                me.setErrorMessage(error);
            }
        }

        //8 is backspace
        if (key === 8 && text.length === 0) {
            if (me.hasHotBackspace() === true) {
                me.editLastTag();
                me.setHotBackspace(false);
            } else {
                me.setHotBackspace(true);
            }
        }

        //27 is escape
        if (key === 27) {
            me.clearNewTagInput();
            me.clearErrorMessage();
        }

        if (key !== 8) {
            me.setHotBackspace(false);
        }
        me.fixHeight();
        return false;
    };
};

TagEditor.prototype.decorate = function (element) {
    this._element = element;
    this._hidden_tags_input = element.find('input[name="tags"]');//this one is hidden
    this._tags_container = element.find('ul.tags');
    this._error_alert = $('.tag-editor-error-alert > span');

    var me = this;
    this._tags_container.children().each(function (idx, elem) {
        var tag = new Tag();
        tag.setDeletable(true);
        tag.setLinkable(false);
        tag.decorate($(elem));
        tag.setDeleteHandler(me.getTagDeleteHandler(tag));
    });

    var visible_tags_input = element.find('.new-tags-input');
    this._visible_tags_input = visible_tags_input;
    this.saveHeight();

    var tagsAc = new AutoCompleter({
        url: askbot.urls.get_tag_list,
        onItemSelect: function (item) {
            if (me.isSelectedTagName(item.value) === false) {
                me.completeTagInput();
            } else {
                me.clearNewTagInput();
            }
        },
        minChars: 1,
        useCache: true,
        matchInside: true,
        maxCacheLength: 100,
        delay: 10
    });
    tagsAc.decorate(visible_tags_input);
    this._autocompleter = tagsAc;
    visible_tags_input.keyup(this.getTagInputKeyHandler());

    element.click(function (e) {
        visible_tags_input.focus();
        return false;
    });
};

/**
 * @constructor
 * Category is a select box item
 * that has CategoryEditControls
 */
var Category = function () {
    SelectBoxItem.call(this);
    this._state = 'display';
    this._settings = JSON.parse(askbot.settings.tag_editor);
};
inherits(Category, SelectBoxItem);

Category.prototype.setCategoryTree = function (tree) {
    this._tree = tree;
};

Category.prototype.getCategoryTree = function () {
    return this._tree;
};

Category.prototype.getName = function () {
    return this.getContent().getContent();
};

Category.prototype.getPath = function () {
    return this._tree.getPathToItem(this);
};

Category.prototype.setState = function (state) {
    this._state = state;
    if (!this._element) {
        return;
    }
    this._input_box.val('');
    if (state === 'display') {
        this.showContent();
        this.hideEditor();
        this.hideEditControls();
    } else if (state === 'editable') {
        this._tree._state = 'editable';//a hack
        this.showContent();
        this.hideEditor();
        this.showEditControls();
    } else if (state === 'editing') {
        this._prev_tree_state = this._tree.getState();
        this._tree._state = 'editing';//a hack
        this._input_box.val(this.getName());
        this.hideContent();
        this.showEditor();
        this.hideEditControls();
    }
};

Category.prototype.hideEditControls = function () {
    this._delete_button.hide();
    this._edit_button.hide();
    this._element.unbind('mouseenter mouseleave');
};

Category.prototype.showEditControls = function () {
    var del = this._delete_button;
    var edit = this._edit_button;
    this._element.hover(
        function () {
            del.show();
            edit.show();
        },
        function () {
            del.hide();
            edit.hide();
        }
    );
};

Category.prototype.showEditControlsNow = function () {
    this._delete_button.show();
    this._edit_button.show();
};

Category.prototype.hideContent = function () {
    this.getContent().getElement().hide();
};

Category.prototype.showContent = function () {
    this.getContent().getElement().show();
};

Category.prototype.showEditor = function () {
    this._input_box.show();
    this._input_box.focus();
    this._save_button.show();
    this._cancel_button.show();
};

Category.prototype.hideEditor = function () {
    this._input_box.hide();
    this._save_button.hide();
    this._cancel_button.hide();
};

Category.prototype.getInput = function () {
    return this._input_box.val();
};

Category.prototype.getDeleteHandler = function () {
    var me = this;
    return function () {
        if (confirm(gettext('Delete category?'))) {
            var tree = me.getCategoryTree();
            $.ajax({
                type: 'POST',
                dataType: 'json',
                data: JSON.stringify({
                    tag_name: me.getName(),
                    path: me.getPath()
                }),
                cache: false,
                url: askbot.urls.delete_tag,
                success: function (data) {
                    if (data.success) {
                        //rebuild category tree based on data
                        tree.setData(data.tree_data);
                        //re-open current branch
                        tree.selectPath(tree.getCurrentPath());
                        tree.setState('editable');
                    } else {
                        alert(data.message);
                    }
                }
            });
        }
        return false;
    };
};

Category.prototype.getSaveHandler = function () {
    var me = this;
    var settings = this._settings;
    //here we need old value and new value
    return function () {
        var to_name = me.getInput();
        try {
            to_name = cleanTag(to_name, settings);
            var data = {
                from_name: me.getOriginalName(),
                to_name: to_name,
                path: me.getPath()
            };
            $.ajax({
                type: 'POST',
                dataType: 'json',
                data: JSON.stringify(data),
                cache: false,
                url: askbot.urls.rename_tag,
                success: function (data) {
                    if (data.success) {
                        me.setName(to_name);
                        me.setState('editable');
                        me.showEditControlsNow();
                    } else {
                        alert(data.message);
                    }
                }
            });
        } catch (error) {
            alert(error);
        }
        return false;
    };
};

Category.prototype.addControls = function () {
    var input_box = this.makeElement('input');
    input_box.attr('type', 'text');
    this._input_box = input_box;
    this._element.append(input_box);

    var save_button = this.makeButton(
        gettext('save'),
        this.getSaveHandler()
    );
    this._save_button = save_button;
    this._element.append(save_button);

    var me = this;
    var cancel_button = this.makeButton(
        'x',
        function () {
            me.setState('editable');
            me.showEditControlsNow();
            return false;
        }
    );
    this._cancel_button = cancel_button;
    this._element.append(cancel_button);

    var edit_button = this.makeButton(
        gettext('edit'),
        function () {
            //todo: I would like to make only one at a time editable
            //var tree = me.getCategoryTree();
            //tree.closeAllEditors();
            //tree.setState('editable');
            //calc path, then select it
            var tree = me.getCategoryTree();
            tree.selectPath(me.getPath());
            me.setState('editing');
            return false;
        }
    );
    this._edit_button = edit_button;
    this._element.append(edit_button);

    var delete_button = this.makeButton(
        'x', this.getDeleteHandler()
    );
    this._delete_button = delete_button;
    this._element.append(delete_button);
};

Category.prototype.getOriginalName = function () {
    return this._original_name;
};

Category.prototype.createDom = function () {
    Category.superClass_.createDom.call(this);
    this.addControls();
    this.setState('display');
    this._original_name = this.getName();
};

Category.prototype.decorate = function (element) {
    Category.superClass_.decorate.call(this, element);
    this.addControls();
    this.setState('display');
    this._original_name = this.getName();
};

var CategoryAdder = function () {
    WrappedElement.call(this);
    this._state = 'disabled';//waitedit
    this._tree = undefined;//category tree
    this._settings = JSON.parse(askbot.settings.tag_editor);
};
inherits(CategoryAdder, WrappedElement);

CategoryAdder.prototype.setCategoryTree = function (tree) {
    this._tree = tree;
};

CategoryAdder.prototype.setLevel = function (level) {
    this._level = level;
};

CategoryAdder.prototype.setState = function (state) {
    this._state = state;
    if (!this._element) {
        return;
    }
    if (state === 'waiting') {
        this._element.show();
        this._input.val('');
        this._input.hide();
        this._save_button.hide();
        this._cancel_button.hide();
        this._trigger.show();
    } else if (state === 'editable') {
        this._element.show();
        this._input.show();
        this._input.val('');
        this._input.focus();
        this._save_button.show();
        this._cancel_button.show();
        this._trigger.hide();
    } else if (state === 'disabled') {
        this.setState('waiting');//a little hack
        this._state = 'disabled';
        this._element.hide();
    }
};

CategoryAdder.prototype.cleanCategoryName = function (name) {
    name = $.trim(name);
    if (name === '') {
        throw gettext('category name cannot be empty');
    }
    //if ( this._tree.hasCategory(name) ) {
        //throw interpolate(
        //throw gettext('this category already exists');
        //    [this._tree.getDisplayPathByName(name)]
        //)
    //}
    return cleanTag(name, this._settings);
};

CategoryAdder.prototype.getPath = function () {
    var path = this._tree.getCurrentPath();
    if (path.length > this._level + 1) {
        return path.slice(0, this._level + 1);
    } else {
        return path;
    }
};

CategoryAdder.prototype.getSelectBox = function () {
    return this._tree.getSelectBox(this._level);
};

CategoryAdder.prototype.startAdding = function () {
    var name;
    try {
        name = this._input.val();
        name = this.cleanCategoryName(name);
    } catch (error) {
        alert(error);
        return;
    }

    //don't add dupes to the same level
    var existing_names = this.getSelectBox().getNames();
    if ($.inArray(name, existing_names) !== -1) {
        alert(gettext('already exists at the current level!'));
        return;
    }

    var me = this;
    var tree = this._tree;
    var adder_path = this.getPath();

    $.ajax({
        type: 'POST',
        dataType: 'json',
        data: JSON.stringify({
            path: adder_path,
            new_category_name: name
        }),
        url: askbot.urls.add_tag_category,
        cache: false,
        success: function (data) {
            if (data.success) {
                //rebuild category tree based on data
                tree.setData(data.tree_data);
                tree.selectPath(data.new_path);
                tree.setState('editable');
                me.setState('waiting');
            } else {
                alert(data.message);
            }
        }
    });
};

CategoryAdder.prototype.createDom = function () {
    this._element = this.makeElement('li');
    //add open adder link
    var trigger = this.makeElement('a');
    this._trigger = trigger;
    trigger.html(gettext('add category'));
    this._element.append(trigger);
    //add input box and the add button
    var input = this.makeElement('input');
    this._input = input;
    input.addClass('add-category');
    input.attr({
        'name': 'add_category',
        'type': 'text'
    });
    this._element.append(input);
    //add save category button
    var save_button = this.makeElement('button');
    this._save_button = save_button;
    save_button.html(gettext('save'));
    this._element.append(save_button);

    var cancel_button = this.makeElement('button');
    this._cancel_button = cancel_button;
    cancel_button.html('x');
    this._element.append(cancel_button);

    this.setState(this._state);

    var me = this;
    setupButtonEventHandlers(
        trigger,
        function () { me.setState('editable'); }
    );
    setupButtonEventHandlers(
        save_button,
        function () {
            me.startAdding();
            return false;//prevent form submit
        }
    );
    setupButtonEventHandlers(
        cancel_button,
        function () {
            me.setState('waiting');
            return false;//prevent submit
        }
    );
    //create input box, button and the "activate" link
};

/**
 * @constructor
 * SelectBox subclass to create/edit/delete
 * categories
 */
var CategorySelectBox = function () {
    SelectBox.call(this);
    this._item_class = Category;
    this._category_adder = undefined;
    this._tree = undefined;//cat tree
    this._level = undefined;
};
inherits(CategorySelectBox, SelectBox);

CategorySelectBox.prototype.setState = function (state) {
    this._state = state;
    if (state === 'select') {
        if (this._category_adder) {
            this._category_adder.setState('disabled');
        }
        $.each(this._items, function (idx, item) {
            item.setState('display');
        });
    } else if (state === 'editable') {
        this._category_adder.setState('waiting');
        $.each(this._items, function (idx, item) {
            item.setState('editable');
        });
    }
};

CategorySelectBox.prototype.setCategoryTree = function (tree) {
    this._tree = tree;
};

CategorySelectBox.prototype.getCategoryTree = function () {
};

CategorySelectBox.prototype.setLevel = function (level) {
    this._level = level;
};

CategorySelectBox.prototype.getNames = function () {
    var names = [];
    $.each(this._items, function (idx, item) {
        names.push(item.getName());
    });
    return names;
};

CategorySelectBox.prototype.appendCategoryAdder = function () {
    var adder = new CategoryAdder();
    adder.setLevel(this._level);
    adder.setCategoryTree(this._tree);
    this._category_adder = adder;
    this._element.append(adder.getElement());
};

CategorySelectBox.prototype.createDom = function () {
    CategorySelectBox.superClass_.createDom.call(this);
    if (askbot.data.userIsAdmin) {
        this.appendCategoryAdder();
    }
};

CategorySelectBox.prototype.decorate = function (element) {
    CategorySelectBox.superClass_.decorate.call(this, element);
    this.setState(this._state);
    if (askbot.data.userIsAdmin) {
        this.appendCategoryAdder();
    }
};

/**
 * @constructor
 * turns on/off the category editor
 */
var CategoryEditorToggle = function () {
    AjaxToggle.call(this);
};
inherits(CategoryEditorToggle, AjaxToggle);

CategoryEditorToggle.prototype.setCategorySelector = function (sel) {
    this._category_selector = sel;
};

CategoryEditorToggle.prototype.getCategorySelector = function () {
    return this._category_selector;
};

CategoryEditorToggle.prototype.decorate = function (element) {
    CategoryEditorToggle.superClass_.decorate.call(this, element);
};

CategoryEditorToggle.prototype.getDefaultHandler = function () {
    var me = this;
    return function () {
        var editor = me.getCategorySelector();
        if (me.isOn()) {
            me.setState('off-state');
            editor.setState('select');
        } else {
            me.setState('on-state');
            editor.setState('editable');
        }
    };
};

var CategorySelector = function () {
    Widget.call(this);
    this._data = null;
    this._select_handler = function () {};//dummy default
    this._current_path = [0];//path points to selected item in tree
};
inherits(CategorySelector, Widget);

/**
 * propagates state to the individual selectors
 */
CategorySelector.prototype.setState = function (state) {
    this._state = state;
    if (state === 'editing') {
        return;//do not propagate this state
    }
    $.each(this._selectors, function (idx, selector) {
        selector.setState(state);
    });
};

CategorySelector.prototype.getPathToItem = function (item) {
    function findPathToItemInTree(tree, item) {
        for (var i = 0; i < tree.length; i++) {
            var node = tree[i];
            if (node[2] === item) {
                return [i];
            }
            var path = findPathToItemInTree(node[1], item);
            if (path.length > 0) {
                path.unshift(i);
                return path;
            }
        }
        return [];
    }
    return findPathToItemInTree(this._data, item);
};

CategorySelector.prototype.applyToDataItems = function (func) {
    function applyToDataItems(tree) {
        $.each(tree, function (idx, item) {
            func(item);
            applyToDataItems(item[1]);
        });
    }
    if (this._data) {
        applyToDataItems(this._data);
    }
};

CategorySelector.prototype.setData = function (data) {
    this._data = data;
    var tree = this;
    function attachCategory(item) {
        var cat = new Category();
        cat.setName(item[0]);
        cat.setCategoryTree(tree);
        item[2] = cat;
    }
    this.applyToDataItems(attachCategory);
};

/**
 * clears contents of selector boxes starting from
 * the given level, in range 0..2
 */
CategorySelector.prototype.clearCategoryLevels = function (level) {
    for (var i = level; i < 3; i++) {
        this._selectors[i].detachAllItems();
    }
};

CategorySelector.prototype.getLeafItems = function (selection_path) {
    //traverse the tree down to items pointed to by the path
    var data = this._data[0];
    for (var i = 1; i < selection_path.length; i++) {
        data = data[1][selection_path[i]];
    }
    return data[1];
};

/**
 * called when a sub-level needs to open
 */
CategorySelector.prototype.populateCategoryLevel = function (source_path) {
    var level = source_path.length - 1;
    if (level >= 3) {
        return;
    }
    //clear all items downstream
    this.clearCategoryLevels(level);

    //populate current selector
    var selector = this._selectors[level];
    var items  = this.getLeafItems(source_path);

    $.each(items, function (idx, item) {
        var category_name = item[0];
        var category_subtree = item[1];
        var category_object = item[2];
        selector.addItemObject(category_object);
        if (category_subtree.length > 0) {
            category_object.addCssClass('tree');
        }
    });

    this.setState(this._state);//update state

    selector.clearSelection();
};

CategorySelector.prototype.selectPath = function (path) {
    var i;
    for (i = 1; i <= path.length; i++) {
        this.populateCategoryLevel(path.slice(0, i));
    }
    for (i = 1; i < path.length; i++) {
        var sel_box = this._selectors[i - 1];
        var category = sel_box.getItemByIndex(path[i]);
        sel_box.selectItem(category);
    }
};

CategorySelector.prototype.getSelectBox = function (level) {
    return this._selectors[level];
};

CategorySelector.prototype.getSelectedPath = function (selected_level) {
    var path = [0];//root, todo: better use names for path???
    /*
     * upper limit capped by current clicked level
     * we ignore all selection above the current level
     */
    for (var i = 0; i < selected_level + 1; i++) {
        var selector = this._selectors[i];
        var item = selector.getSelectedItem();
        if (item) {
            path.push(selector.getItemIndex(item));
        } else {
            return path;
        }
    }
    return path;
};

/** getter and setter are not symmetric */
CategorySelector.prototype.setSelectHandler = function (handler) {
    this._select_handler = handler;
};

CategorySelector.prototype.getSelectHandlerInternal = function () {
    return this._select_handler;
};

CategorySelector.prototype.setCurrentPath = function (path) {
    this._current_path = path;
    return true;
};

CategorySelector.prototype.getCurrentPath = function () {
    return this._current_path;
};

CategorySelector.prototype.getEditorToggle = function () {
    return this._editor_toggle;
};

/*CategorySelector.prototype.closeAllEditors = function () {
    $.each(this._selectors, function (idx, sel) {
        sel._category_adder.setState('wait');
        $.each(sel._items, function (idx2, item) {
            item.setState('editable');
        });
    });
};*/

CategorySelector.prototype.getSelectHandler = function (level) {
    var me = this;
    return function (item_data) {
        if (me.getState() === 'editing') {
            return;//don't navigate when editing
        }
        //1) run the assigned select handler
        var tag_name = item_data.title;
        if (me.getState() === 'select') {
            /* this one will actually select the tag
             * maybe a bit too implicit
             */
            me.getSelectHandlerInternal()(tag_name);
        }
        //2) if appropriate, populate the higher level
        if (level < 2) {
            var current_path = me.getSelectedPath(level);
            me.setCurrentPath(current_path);
            me.populateCategoryLevel(current_path);
        }
    };
};

CategorySelector.prototype.decorate = function (element) {
    this._element = element;
    this._selectors = [];

    var selector0 = new CategorySelectBox();
    selector0.setLevel(0);
    selector0.setCategoryTree(this);
    selector0.decorate(element.find('.cat-col-0'));
    selector0.setSelectHandler(this.getSelectHandler(0));
    this._selectors.push(selector0);

    var selector1 = new CategorySelectBox();
    selector1.setLevel(1);
    selector1.setCategoryTree(this);
    selector1.decorate(element.find('.cat-col-1'));
    selector1.setSelectHandler(this.getSelectHandler(1));
    this._selectors.push(selector1);

    var selector2 = new CategorySelectBox();
    selector2.setLevel(2);
    selector2.setCategoryTree(this);
    selector2.decorate(element.find('.cat-col-2'));
    selector2.setSelectHandler(this.getSelectHandler(2));
    this._selectors.push(selector2);

    if (askbot.data.userIsAdminOrMod) {
        var editor_toggle = new CategoryEditorToggle();
        editor_toggle.setCategorySelector(this);
        var toggle_element = $('.category-editor-toggle');
        toggle_element.show();
        editor_toggle.decorate(toggle_element);
        this._editor_toggle = editor_toggle;
    }

    this.populateCategoryLevel([0]);
};

/**
 * @constructor
 * loads html for the category selector from
 * the server via ajax and activates the
 * CategorySelector on the loaded HTML
 */
var CategorySelectorLoader = function () {
    WrappedElement.call(this);
    this._is_loaded = false;
};
inherits(CategorySelectorLoader, WrappedElement);

CategorySelectorLoader.prototype.setCategorySelector = function (sel) {
    this._category_selector = sel;
};

CategorySelectorLoader.prototype.setLoaded = function (is_loaded) {
    this._is_loaded = is_loaded;
};

CategorySelectorLoader.prototype.isLoaded = function () {
    return this._is_loaded;
};

CategorySelectorLoader.prototype.setEditor = function (editor) {
    this._editor = editor;
};

CategorySelectorLoader.prototype.closeEditor = function () {
    this._editor.hide();
    this._editor_buttons.hide();
    this._display_tags_container.show();
    this._question_body.show();
    this._question_controls.show();
};

CategorySelectorLoader.prototype.openEditor = function () {
    this._editor.show();
    this._editor_buttons.show();
    this._display_tags_container.hide();
    this._question_body.hide();
    this._question_controls.hide();
    var sel = this._category_selector;
    sel.setState('select');
    sel.getEditorToggle().setState('off-state');
};

CategorySelectorLoader.prototype.addEditorButtons = function () {
    this._editor.after(this._editor_buttons);
};

CategorySelectorLoader.prototype.getOnLoadHandler = function () {
    var me = this;
    return function (html) {
        me.setLoaded(true);

        //append loaded html to dom
        var editor = $('<div>' + html + '</div>');
        me.setEditor(editor);
        $('#question-tags').after(editor);

        var selector = askbot.functions.initCategoryTree();
        me.setCategorySelector(selector);

        me.addEditorButtons();
        me.openEditor();
        //add the save button
    };
};

CategorySelectorLoader.prototype.startLoadingHTML = function (on_load) {
    var me = this;
    $.ajax({
        type: 'GET',
        dataType: 'json',
        data: { template_name: 'widgets/tag_category_selector.html' },
        url: askbot.urls.get_html_template,
        cache: true,
        success: function (data) {
            if (data.success) {
                on_load(data.html);
            } else {
                showMessage(me.getElement(), data.message);
            }
        }
    });
};

CategorySelectorLoader.prototype.getRetagHandler = function () {
    var me = this;
    return function () {
        if (me.isLoaded() === false) {
            me.startLoadingHTML(me.getOnLoadHandler());
        } else {
            me.openEditor();
        }
        return false;
    };
};

CategorySelectorLoader.prototype.drawNewTags = function (new_tags) {
    var container = this._display_tags_container;
    container.html('');
    if (new_tags === '') {
        return;
    }

    new_tags = new_tags.split(/\s+/);
    var me = this;
    $.each(new_tags, function (index, name) {
        var li = me.makeElement('li');
        container.append(li);
        var tag = new Tag();
        tag.setName(name);
        li.append(tag.getElement());
    });
};

CategorySelectorLoader.prototype.getSaveHandler = function () {
    var me = this;
    return function () {
        var tagInput = $('input[name="tags"]');
        $.ajax({
            type: 'POST',
            url: askbot.urls.retag,
            dataType: 'json',
            data: { tags: getUniqueWords(tagInput.val()).join(' ') },
            success: function (json) {
                if (json.success) {
                    var new_tags = getUniqueWords(json.new_tags);
                    oldTagsHtml = '';
                    me.closeEditor();
                    me.drawNewTags(new_tags.join(' '));
                } else {
                    me.closeEditor();
                    showMessage(me.getElement(), json.message);
                }
            },
            error: function (xhr) {
                showMessage(tagsDiv, 'sorry, something is not right here');
                cancelRetag();
            }
        });
        return false;
    };
};

CategorySelectorLoader.prototype.getCancelHandler = function () {
    var me = this;
    return function () {
        me.closeEditor();
    };
};

CategorySelectorLoader.prototype.decorate = function (element) {
    this._element = element;
    this._display_tags_container = $('#question-tags');
    this._question_body = $('.question .post-body');
    this._question_controls = $('#question-controls');

    this._editor_buttons = this.makeElement('div');
    this._done_button = this.makeElement('button');
    this._done_button.html(gettext('save tags'));
    this._editor_buttons.append(this._done_button);

    this._cancel_button = this.makeElement('button');
    this._cancel_button.html(gettext('cancel'));
    this._editor_buttons.append(this._cancel_button);
    this._editor_buttons.find('button').addClass('submit');
    this._editor_buttons.addClass('retagger-buttons');

    //done button
    setupButtonEventHandlers(
        this._done_button,
        this.getSaveHandler()
    );
    //cancel button
    setupButtonEventHandlers(
        this._cancel_button,
        this.getCancelHandler()
    );

    //retag button
    setupButtonEventHandlers(
        element,
        this.getRetagHandler()
    );
};


var AskButton = function () {
    SimpleControl.call(this);
    this._handler = function (evt) {
        if (askbot.data.userIsReadOnly === true) {
            notify.show(gettext('Sorry, you have only read access'));
            evt.preventDefault();
        }
    };
};
inherits(AskButton, SimpleControl);


$(document).ready(function () {
    $('.comments').each(function (index, element) {
        var comments = new PostCommentsWidget();
        comments.decorate($(element));
    });
    $('[id^="post-id-"]').each(function (idx, element) {
        var deleter = new DeletePostLink();
        //confusingly .question-delete matches the answers too need rename
        var post_id = element.id.split('-').pop();
        deleter.setPostId(post_id);
        deleter.decorate($(element).find('.question-delete'));
    });
    //todo: convert to "control" class
    var publishBtns = $('.answer-publish, .answer-unpublish');
    publishBtns.each(function (idx, btn) {
        setupButtonEventHandlers($(btn), function () {
            var answerId = $(btn).data('answerId');
            $.ajax({
                type: 'POST',
                dataType: 'json',
                data: {'answer_id': answerId},
                url: askbot.urls.publishAnswer,
                success: function (data) {
                    if (data.success) {
                        window.location.reload(true);
                    } else {
                        showMessage($(btn), data.message);
                    }
                }
            });
        });
    });

    if (askbot.settings.tagSource === 'category-tree') {
        var catSelectorLoader = new CategorySelectorLoader();
        catSelectorLoader.decorate($('#retag'));
    } else {
        questionRetagger.init();
    }
    socialSharing.init();

    var proxyUserNameInput = $('#id_post_author_username');
    var proxyUserEmailInput = $('#id_post_author_email');
    if (proxyUserNameInput.length === 1) {

        var userSelectHandler = function (data) {
            proxyUserEmailInput.val(data.data[0]);
        };

        var fakeUserAc = new AutoCompleter({
            url: askbot.urls.get_users_info,
            minChars: 1,
            useCache: true,
            matchInside: true,
            maxCacheLength: 100,
            delay: 10,
            onItemSelect: userSelectHandler
        });
        fakeUserAc.decorate(proxyUserNameInput);
    }
    //if groups are enabled - activate share functions
    var groupsInput = $('#share_group_name');
    if (groupsInput.length === 1) {
        var groupsAc = new AutoCompleter({
            url: askbot.urls.getGroupsList,
            promptText: gettext('Group name:'),
            minChars: 1,
            useCache: false,
            matchInside: true,
            maxCacheLength: 100,
            delay: 10
        });
        groupsAc.decorate(groupsInput);
    }
    var usersInput = $('#share_user_name');
    if (usersInput.length === 1) {
        var usersAc = new AutoCompleter({
            url: '/get-users-info/',
            promptText: askbot.messages.userNamePrompt,
            minChars: 1,
            useCache: false,
            matchInside: true,
            maxCacheLength: 100,
            delay: 10
        });
        usersAc.decorate(usersInput);
    }

    var showSharedUsers = $('.see-related-users');
    if (showSharedUsers.length) {
        var usersPopup = new ThreadUsersDialog();
        usersPopup.setHeadingText(gettext('Shared with the following users:'));
        usersPopup.decorate(showSharedUsers);
    }
    var showSharedGroups = $('.see-related-groups');
    if (showSharedGroups.length) {
        var groupsPopup = new ThreadUsersDialog();
        groupsPopup.setHeadingText(gettext('Shared with the following groups:'));
        groupsPopup.decorate(showSharedGroups);
    }

    var askButton = new AskButton();
    askButton.decorate($('#askButton'));

    if (askbot.data.userIsThreadModerator) {
        var mergeQuestions = new MergeQuestionsDialog();
        $('body').append(mergeQuestions.getElement());
        var mergeBtn = $('.question-merge');
        setupButtonEventHandlers(mergeBtn, function () {
            mergeQuestions.show();
        });
    }
});

/**
 * @constructor
 * Adds in-place text editor for a text value
 * of a database object. Whether editing is
 * permissible is to be enforced in the backend
 */
var Editable = function(){
    WrappedElement.call(this);
    this._state = 'display';//'edit' or 'display'
    this._isEditorLoaded = false;
    this._enabledEditorButtons = null;
    this._isPreviewerEnabled = false;
};
inherits(Editable, WrappedElement);

Editable.prototype.backupContent = function(){
    this._contentBackup = this._contentBox.contents();
};

Editable.prototype.setEnabledEditorButtons = function(buttons){
    this._enabledEditorButtons = buttons;
};

Editable.prototype.setPreviewerEnabled = function(state){
    this._isPreviewerEnabled = state;
    if (this.isEditorLoaded()){
        this._editor.setPreviewerEnabled(state);
    }
};

Editable.prototype.setContent = function(content){
    this._content.empty();
    this._content.append(content);
    if (askbot.settings.mathjaxEnabled) {
        runMathJax();
    }
};

Editable.prototype.setState = function(state){
    if (state === 'edit'){
        this._state = state;
        this._editorBox.show();
        this._editBtn.hide();
        this._saveBtn.show();
        this._cancelBtn.show();
        this._hideables.hide();
        this._content.hide();
    } else if (state === 'display'){
        this._editorBox.hide();
        this._saveBtn.hide();
        this._cancelBtn.hide();
        this._editBtn.show();
        this._hideables.show();
        this._content.show();
    }
};

Editable.prototype.restoreContent = function(){
    var content_box = this._contentBox;
    content_box.empty();
    $.each(this._contentBackup, function(idx, element){
        content_box.append(element);
    });
};

Editable.prototype.isEditorLoaded = function(){
    return this._isEditorLoaded;
};

Editable.prototype.setEditorLoaded = function(){
    return this._isEditorLoaded = true;
};

Editable.prototype.getObjectId = function() {
    return this._objectId;
};

Editable.prototype.getAttributeName = function() {
    return this._attributeName;
};

Editable.prototype.startEditingText = function (text) {
    var ed = this._editor;
    this.setState('edit');
    if (this.isEditorLoaded() === false){
        ed.start();
        this.setEditorLoaded();
    }
    var onFocus = function () {
        ed.setText(text);
        ed.putCursorAtEnd();
    };
    ed.focus(onFocus);
}

/**
 * loads initial data for the editor input and activates
 * the editor
 */
Editable.prototype.startActivatingEditor = function (evt) {
    evt.preventDefault();
    var editor = this._editor;

    if (this._editorType == 'tinymce') {//take shortcut.
        this.startEditingText(this._content.html());
        return false;
    }

    var me = this;
    var paramName = this._saveTextParamName;

    $.ajax({
        type: 'GET',
        url: this._getTextUrl,
        data: this._getTextUrlParams,
        cache: false,
        success: function(data){
            me.startEditingText(data[paramName]);
        }
    });
    return false;
};

Editable.prototype.setError = function (text) {
    this._error.html(text);
};

Editable.prototype.clearError = function () {
    this._error.html('');
};

Editable.prototype.cancelEdit = function () {
    this.setState('display');
    this.clearError();
};

Editable.prototype.saveText = function () {
    var me = this;
    var editorText = this._editor.getText();

    if (this._editorType == 'tinymce') {
        editorText = stripTags(editorText);
    }

    if (this._validator) {
        try {
            this._validator(editorText);
            this.clearError();
        } catch (e) {
            this.setError(e);
            return;
        }
    }

    //optimistic update
    if (this._editorType === 'markdown') {
        var converter = getAskbotMarkdownConverter();
        editorText = converter.makeHtml(editorText);
    }
    this.setContent(editorText);
    this.setState('display');
    
    var data = this._saveTextUrlParams;
    editorText = this._editor.getText();
    data[this._saveTextParamName] = editorText;
    var validatedParamName = this._validatedTextParamName;

    $.ajax({
        type: 'POST',
        dataType: 'json',
        url: this._saveTextUrl,
        data: data,
        cache: false,
        success: function(data){
            if (data['success']){
                me.setContent(data[validatedParamName]);
            } else {
                me.setState('edit');
                showMessage(me.getElement(), data['message']);
            }
        }
    });
};

Editable.prototype.decorate = function(element){
     /* expected markup
        <div class="js-editable"
            id="js-<something>" //here "something" must be unique enough
            // 1. urls below are parsed and parameters added as part of request
            //    this way url parameter input is more compact and comes with the 
            //    corresponding url
            // 2. the getTextUrl is optional - if absent, text will be taken as
            //    displayed in the html. This feature won't work with the markdown editor
            data-get-text-url="{% url user_get_description %}?user_id={{ view_user.pk }}"
            data-save-text-url="{% url user_set_description %}?user_id={{ view_user.pk }}"
            // this parameter will be added to the POST request made to saveTextUrl
            data-save-text-param-name="description"
            // this parameter is optional, used to retreive data from server after saving
            // i.e. when saved data is first validated and perhaps parsed
            //if absent, assumed value will be the same as saveTextParamName
            data-validated-text-param-name="description_html"
            // depending on the editor type we might ignore the getTextUrl
            // as we need the access the url only in the case of markdown editor
            data-editor-type="<one of supported editor types>"
            data-editor-compact="true"//optional
        >
            //this item must be inside of js-editable
            <div class="js-editable-content">some text which will be editable</div>
            // the button as shown below does not have to be inside of js-editable.
            // we find the button by the Id, which starts with js-edit-btn and 
            // ends the same as id of the .js-editable
            // Also, the html elements of button and the container are not important,
            // only ids, class names and "data" parameters on the .js-editable
            // the <something> in the id below must be the same as in the id of
            // the .js-editable
            <button id="js-edit-btn-<something>">{% trans %}edit{% endtrans %}</button>
        </div>
    */
    var parsed, editor;
    this._element = element;
    //validate that id starts with "js-" and is longer than 3 chars
    var id = element.attr('id');
    if ( !id || id.length <= 3 ) {
        throw "id of .js-editable must have > 3 characters";
    }
    if ( id.substr(0, 3) !== 'js-' ) {
        throw "id of .js-editable must start with js-";
    }
    this._id = id.substr(3);
    this._content = element.find('.js-editable-content');
    //must be defined
    var editBtn = $(document.getElementById('js-edit-btn-' + this._id));
    if ( !editBtn ) {
        throw "edit button with id js-edit-btn-" + this._id + " is required";
    }
    this._editBtn = editBtn;

    var err = element.find('.js-error');
    if (err.length === 0) {
        err = this.makeElement('div');
        err.addClass('js-error');
        this._element.prepend(err);
    }
    this._error = err;

    //parse these two urls and separate url and the params
    var getTextUrl = element.data('getTextUrl');
    if (getTextUrl) {
        parsed = parseUrl(element.data('getTextUrl'));
        this._getTextUrl = parsed[0];
        this._getTextUrlParams = parsed[1];
    } else {
        this._getTextUrl = undefined;
        this._getTextUrlParams = undefined;
    }

    parsed = parseUrl(element.data('saveTextUrl'));
    this._saveTextUrl = parsed[0];
    this._saveTextUrlParams = parsed[1];

    this._saveTextParamName = element.data('saveTextParamName');
    this._validatedTextParamName = element.data('validatedTextParamName') || this._saveTextParamName;

    this._useCompactEditor = element.data('editorCompact');

    var validatorPath = element.data('validator');
    if (validatorPath) {
        this._validator = getObjectByPath(validatorPath);
    }

    //create container for the editor and buttons
    var editorBox = this.makeElement('div');
    this._content.after(editorBox);
    this._editorBox = editorBox;

    //create editor
    var editorType = element.data('editorType') || askbot['settings']['editorType'];
    var minLines = element.data('minLines') || 1;
    this._editorType = editorType;
    if (editorType === 'markdown') {
        editor = new WMD({'minLines': minLines});
        if (this._useCompactEditor) {
            editor.setEnabledButtons('bold italic link code ol ul');
        }
        var preview = element.data('previewerEnabled');
        editor.setPreviewerEnabled(preview);
    } else if (editorType === 'tinymce') {
        if (this._useCompactEditor) {
            editor = new TinyMCE({//override defaults
                theme_advanced_buttons1: 'bold, italic, |, link, |, numlist, bullist',
                theme_advanced_buttons2: '',
                theme_advanced_path: false,
                plugins: ''
            });
        } else {
            editor = new TinyMCE();
        }
        editor.setId('tinyMCE-' + this._id);
    } else {
        editor = new SimpleEditor({'minLines': minLines});
    }
    this._editor = editor;
    editorBox.append(editor.getElement());
    editorBox.hide();

    //adding two buttons...
    var formControls = element.find('.js-editable-controls');
    if (formControls.length === 0) {
        formControls = this.makeElement('div');
        formControls.addClass('.js-editable-controls');
        editorBox.append(formControls);
    }

    this._hideables = $('.js-editable-hide-' + this._id);

    var saveBtn = this.makeElement('button');
    //saveBtn.addClass('btn btn-primary');
    saveBtn.html(gettext('save'));
    formControls.append(saveBtn);
    this._saveBtn = saveBtn;

    var cancelBtn = this.makeElement('button');
    cancelBtn.html(gettext('cancel'));
    //cancelBtn.addClass('btn');
    formControls.append(cancelBtn);
    this._cancelBtn = cancelBtn;

    this.setState('display');

    var me = this;
    setupButtonEventHandlers(editBtn, function(evt){ me.startActivatingEditor(evt) });
    setupButtonEventHandlers(cancelBtn, function(){ me.cancelEdit() });
    setupButtonEventHandlers(saveBtn, function(){ me.saveText() });
};

(function () {
    var items = $('.js-editable');
    $.each(items, function(idx, item) {
        var editable = new Editable();
        editable.decorate($(item));
    });
})();

/**
 * Form class.
 * Helps build forms with validation
 */
var Form = function () {
    WrappedElement.call(this);
    /* all dicts have key of field name */
    this._errors = {};
    this._errorElements = {};
    this._validators = {};
    this._inputs = {};
};
inherits(Form, WrappedElement);

Form.prototype.fieldHasErrors = function (fieldName) {
    return this._errors[fieldName];
};

Form.prototype.formHasErrors = function () {
    var fields = this._fieldNames;
    for (var i=0; i<fields.length; i++) {
        var field = fields[i];
        if (this.fieldHasErrors(field)) {
            return true;
        }
    }
    return false;
};

Form.prototype.validateForm = function () {
    var fields = this._fieldNames;
    for (var i=0; i<fields.length; i++) {
        this.validateField(fields[i]);
    }
};

Form.prototype.getFormValidationHandler = function () {
    var me = this;
    return function () {
        me.validateForm();
        if (me.formHasErrors()) {
            return false;
        }
    };
};

Form.prototype.setFieldError = function (fieldName, errorMsg) {
    var error = this._errorElements[fieldName];
    error.html(errorMsg);
    this._errors[fieldName] = true;
};

Form.prototype.clearFieldError = function (fieldName) {
    var error = this._errorElements[fieldName];
    error.html('');
    this._errors[fieldName] = false;
};

Form.prototype.validateField = function (fieldName) {
    var input = this._inputs[fieldName];
    var validator = this._validators[fieldName];
    var val = input.val();
    try {
        validator(val);
        this.clearFieldError(fieldName);
    } catch (error) {
        this.setFieldError(fieldName, error);
    }
}

Form.prototype.decorateField = function (fieldName) {
    //get validator
    var element = $(this._element);
    var validator = element.data(fieldName + 'Validator');
    validator = getObjectByPath(validator);
    this._validators[fieldName] = validator;

    var error = element.find('.js-' + fieldName + '-error');
    this._errorElements[fieldName] = error;

    var input = element.find('input[name="' + fieldName + '"]');
    if (input.length == 0) {
        input = element.find('textarea[name="' + fieldName + '"]');
    }
    if (input.length == 0) {
        input = element.find('select[name="' + fieldName + '"]');
    }
    this._inputs[fieldName] = input;

    var me = this;
    input.change(function () {
        me.validateField(fieldName);
        return false;
    });
};

Form.prototype.decorate = function (element) {
    this._element = element;
    //look for validated fields
    var fieldNames = $(element).data('validatedFields');
    fieldNames = $.trim(fieldNames).split(',');

    for (var i=0; i<fieldNames.length; i++) {
        var fieldName = $.trim(fieldNames[i]);
        fieldNames[i] = fieldName;//save cleaned field name
        this.decorateField(fieldName);
    }
    this._fieldNames = fieldNames;

    element.submit(this.getFormValidationHandler());
};

/**
 * @constructor
 * An element that encloses an editor and everything inside it.
 * By default editor is hidden and user sees a box with a prompt
 * suggesting to make a post.
 * When user clicks, editor becomes accessible.
 */
var FoldedEditor = function () {
    WrappedElement.call(this);
};
inherits(FoldedEditor, WrappedElement);

FoldedEditor.prototype.getEditor = function () {
    return this._editor;
};

FoldedEditor.prototype.getEditorInputId = function () {
    return this._element.find('textarea').attr('id');
};

FoldedEditor.prototype.onAfterOpenHandler = function () {
    var editor = this.getEditor();
    if (editor) {
        editor.start();
        editor.focus(function(){
            editor.putCursorAtEnd()
            $(document).trigger('askbot.FoldedEditor.afterOpened', [this]);
        });
    }
};

FoldedEditor.prototype.getOpenHandler = function () {
    var editorBox = this._editorBox;
    var promptBox = this._prompt;
    var me = this;
    return function () {
        if (askbot.data.userIsReadOnly === true) {
            notify.show(gettext('Sorry, you have only read access'));
        } else {
            promptBox.hide();
            editorBox.show();
            var element = me.getElement();
            element.addClass('unfolded');

            /* make the editor one shot - once it unfolds it's
            * not accepting any events
            */
            element.unbind('click');
            element.unbind('focus');

            /* this function will open the editor
            * and focus cursor on the editor
            */
            me.onAfterOpenHandler();
        }
    };
};

FoldedEditor.prototype.decorate = function (element) {
    this._element = element;
    this._prompt = element.find('.js-folded-editor-trigger');
    this._editorBox = element.find('.editor-proper');

    var editorType = askbot.settings.editorType;
    var editor;

    if (editorType === 'tinymce') {
        editor = new TinyMCE();
        editor.setId('editor');
    } else if (editorType === 'markdown') {
        editor = new WMD({'minLines': 10});
        editor.setIdSeed('');
    } else {
        throw 'wrong editor type "' + editorType + '"'
    }
    editor.setTextareaName('text');
    this._editor = editor;

    var placeHolder = element.find('.editor-placeholder');
    editor.setText(placeHolder.data('draftAnswer'));
    placeHolder.append(editor.getElement());
    //editor.start();

    var openHandler = this.getOpenHandler();
    element.click(openHandler);
    element.focus(openHandler);
};

var AnswerForm = function () {
    Form.call(this);
};
inherits(AnswerForm, Form);

AnswerForm.prototype.getAfterOpenHandler = function () {
    /* decorate the super class now, b/c now we have
       the editor input element in DOM */
    var element = this._element;
    var me = this;
    return function () {
        getSuperClass(AnswerForm).decorate.call(me, element);
    };
};

AnswerForm.prototype.decorate = function (element) {
    this._element = element;
    /* todo: move folded editor inside the answer form! */
    var editorBox = element.closest('.folded-editor');
    if (editorBox.length) {
        var foldedEditor = new FoldedEditor();
        foldedEditor.decorate(editorBox);
        var onAfterOpen = this.getAfterOpenHandler();
        $(document).on('askbot.FoldedEditor.afterOpened', onAfterOpen);
    }
};
           20220106144528-8l2   https://answers.ros.org/m/CACHE/js/2ec153a4cd31.js   D /*
	jQuery TextAreaResizer plugin
	Created on 17th January 2008 by Ryan O'Dell
	Version 1.0.4
*/(function($){var textarea,staticOffset;var iLastMousePos=0;var iMin=32;var grip;$.fn.TextAreaResizer=function(){return this.each(function(){textarea=$(this).addClass('processed'),staticOffset=null;$(this).wrap('<div class="resizable-textarea"><span></span></div>').parent().append($('<div class="grippie"></div>').bind("mousedown",{el:this},startDrag));var grippie=$('div.grippie',$(this).parent())[0];grippie.style.marginRight=(grippie.offsetWidth-$(this)[0].offsetWidth)+'px'})};function startDrag(e){textarea=$(e.data.el);textarea.blur();iLastMousePos=mousePosition(e).y;staticOffset=textarea.height()-iLastMousePos;textarea.css('opacity',0.25);$(document).mousemove(performDrag).mouseup(endDrag);return false}function performDrag(e){var iThisMousePos=mousePosition(e).y;var iMousePos=staticOffset+iThisMousePos;if(iLastMousePos>=(iThisMousePos)){iMousePos-=5}iLastMousePos=iThisMousePos;iMousePos=Math.max(iMin,iMousePos);textarea.height(iMousePos+'px');if(iMousePos<iMin){endDrag(e)}return false}function endDrag(e){$(document).unbind('mousemove',performDrag).unbind('mouseup',endDrag);textarea.css('opacity',1);textarea.focus();textarea=null;staticOffset=null;iLastMousePos=0}function mousePosition(e){return{x:e.clientX+document.documentElement.scrollLeft,y:e.clientY+document.documentElement.scrollTop}}})(jQuery);
/*
 *	TypeWatch 2.0 - Original by Denny Ferrassoli / Refactored by Charles Christolini
 *  Copyright(c) 2007 Denny Ferrassoli - DennyDotNet.com
 *  Coprright(c) 2008 Charles Christolini - BinaryPie.com
 *  Dual licensed under the MIT and GPL licenses:
 *  http://www.opensource.org/licenses/mit-license.php
 *  http://www.gnu.org/licenses/gpl.html
*/(function(jQuery){jQuery.fn.typeWatch=function(o){var options=jQuery.extend({wait:750,callback:function(){},highlight:true,captureLength:2},o);function checkElement(timer,override){var elTxt=jQuery(timer.el).val();if((elTxt.length>options.captureLength&&elTxt.toUpperCase()!=timer.text)||(override&&elTxt.length>options.captureLength)){timer.text=elTxt.toUpperCase();timer.cb(elTxt)}};function watchElement(elem){if(elem.type.toUpperCase()=="TEXT"||elem.nodeName.toUpperCase()=="TEXTAREA"){var timer={timer:null,text:jQuery(elem).val().toUpperCase(),cb:options.callback,el:elem,wait:options.wait};if(options.highlight){jQuery(elem).focus(function(){this.select()})}var startWatch=function(evt){var timerWait=timer.wait;var overrideBool=false;if(evt.keyCode==13&&this.type.toUpperCase()=="TEXT"){timerWait=1;overrideBool=true}var timerCallbackFx=function(){checkElement(timer,overrideBool)};clearTimeout(timer.timer);timer.timer=setTimeout(timerCallbackFx,timerWait)};jQuery(elem).keydown(startWatch)}};return this.each(function(index){watchElement(this)})}})(jQuery);
/*
Ajax upload
*/jQuery.extend({createUploadIframe:function(d,b){var a="jUploadFrame"+d;if(window.ActiveXObject){var c=document.createElement('<iframe id="'+a+'" name="'+a+'" />');if(typeof b=="boolean"){c.src="javascript:false"}else{if(typeof b=="string"){c.src=b}}}else{var c=document.createElement("iframe");c.id=a;c.name=a}c.style.position="absolute";c.style.top="-1000px";c.style.left="-1000px";document.body.appendChild(c);return c},createUploadForm:function(g,b){var e="jUploadForm"+g;var a="jUploadFile"+g;var d=$('<form  action="" method="POST" name="'+e+'" id="'+e+'" enctype="multipart/form-data"></form>');var c=$("#"+b);var f=$(c).clone();$(c).attr("id",a);$(c).before(f);$(c).appendTo(d);$(d).css("position","absolute");$(d).css("top","-1200px");$(d).css("left","-1200px");$(d).appendTo("body");return d},ajaxFileUpload:function(k){k=jQuery.extend({},jQuery.ajaxSettings,k);var a=new Date().getTime();var b=jQuery.createUploadForm(a,k.fileElementId);var i=jQuery.createUploadIframe(a,k.secureuri);var h="jUploadFrame"+a;var j="jUploadForm"+a;if(k.global&&!jQuery.active++){jQuery.event.trigger("ajaxStart")}var c=false;var f={};if(k.global){jQuery.event.trigger("ajaxSend",[f,k])}var d=function(l){var p=document.getElementById(h);try{if(p.contentWindow){f.responseText=p.contentWindow.document.body?p.contentWindow.document.body.innerText:null;f.responseXML=p.contentWindow.document.XMLDocument?p.contentWindow.document.XMLDocument:p.contentWindow.document}else{if(p.contentDocument){f.responseText=p.contentDocument.document.body?p.contentDocument.document.body.textContent||document.body.innerText:null;f.responseXML=p.contentDocument.document.XMLDocument?p.contentDocument.document.XMLDocument:p.contentDocument.document}}}catch(o){jQuery.handleError(k,f,null,o)}if(f||l=="timeout"){c=true;var m;try{m=l!="timeout"?"success":"error";if(m!="error"){var n=jQuery.uploadHttpData(f,k.dataType);if(k.success){k.success(n,m)}if(k.global){jQuery.event.trigger("ajaxSuccess",[f,k])}}else{jQuery.handleError(k,f,m)}}catch(o){m="error";jQuery.handleError(k,f,m,o)}if(k.global){jQuery.event.trigger("ajaxComplete",[f,k])}if(k.global&&!--jQuery.active){jQuery.event.trigger("ajaxStop")}if(k.complete){k.complete(f,m)}jQuery(p).unbind();setTimeout(function(){try{$(p).remove();$(b).remove()}catch(q){jQuery.handleError(k,f,null,q)}},100);f=null}};if(k.timeout>0){setTimeout(function(){if(!c){d("timeout")}},k.timeout)}try{var b=$("#"+j);$(b).attr("action",k.url);$(b).attr("method","POST");$(b).attr("target",h);if(b.encoding){b.encoding="multipart/form-data"}else{b.enctype="multipart/form-data"}$(b).submit()}catch(g){jQuery.handleError(k,f,null,g)}if(window.attachEvent){document.getElementById(h).attachEvent("onload",d)}else{document.getElementById(h).addEventListener("load",d,false)}return{abort:function(){}}},uploadHttpData:function(r,type){var data=!type;data=type=="xml"||data?r.responseXML:r.responseText;if(type=="script"){jQuery.globalEval(data)}if(type=="json"){eval("data = "+data)}if(type=="html"){jQuery("<div>").html(data).evalScripts()}return data}});
/**
 * Upload call. Used only once in the wmd file upload
 * this is used in the wmd file uploader and the
 * askbots image and attachment upload plugins
 * @todo refactor this code to "new style"
 */
function ajaxFileUpload(options) {

    var spinner = options['spinner'];
    var uploadInputId = options['uploadInputId'];
    var urlInput = $(options['urlInput']);
    var startUploadHandler = options['startUploadHandler'];

    spinner.ajaxStart(function(){
        $(this).show();
    }).ajaxComplete(function(){
        $(this).hide();
    });

    /* important!!! upload input must be loaded by id
     * because ajaxFileUpload monkey-patches the upload form */
    $('#' + uploadInputId).ajaxStart(function(){
        $(this).hide();
    }).ajaxComplete(function(){
        $(this).show();
    });

    //var localFilePath = upload_input.val();
    $.ajaxFileUpload({
        url: askbot['urls']['upload'],
        secureuri: false,
        fileElementId: uploadInputId,
        dataType: 'xml',
        success: function (data, status) {

            var fileURL = $(data).find('file_url').text();
            /*
            * hopefully a fix for the "fakepath" issue
            * https://www.mediawiki.org/wiki/Special:Code/MediaWiki/83225
            */
            fileURL = fileURL.replace(/\w:.*\\(.*)$/,'$1');
            var error = $(data).find('error').text();
            if(error != ''){
                alert(error);
            } else {
                urlInput.attr('value', fileURL);
            }

            /* re-install this as the upload extension
             * will remove the handler to prevent double uploading
             * this hack is a manipulation around the
             * ajaxFileUpload jQuery plugin. */
            $('#' + uploadInputId).unbind('change').change(startUploadHandler);
        },
        error: function (data, status, e) {
            if (startUploadHandler){
                /* re-install this as the upload extension
                * will remove the handler to prevent double uploading */
                $('#' + uploadInputId).unbind('change').change(startUploadHandler);
            }
        }
    });
    return false;
};

/* ===================================================
 * bootstrap-transition.js v2.0.2
 * http://twitter.github.com/bootstrap/javascript.html#transitions
 * ===================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ========================================================== */

!function( $ ) {

  $(function () {

    "use strict"

    /* CSS TRANSITION SUPPORT (https://gist.github.com/373874)
     * ======================================================= */

    $.support.transition = (function () {
      var thisBody = document.body || document.documentElement
        , thisStyle = thisBody.style
        , support = thisStyle.transition !== undefined || thisStyle.WebkitTransition !== undefined || thisStyle.MozTransition !== undefined || thisStyle.MsTransition !== undefined || thisStyle.OTransition !== undefined

      return support && {
        end: (function () {
          var transitionEnd = "TransitionEnd"
          if ( $.browser.webkit ) {
          	transitionEnd = "webkitTransitionEnd"
          } else if ( $.browser.mozilla ) {
          	transitionEnd = "transitionend"
          } else if ( $.browser.opera ) {
          	transitionEnd = "oTransitionEnd"
          }
          return transitionEnd
        }())
      }
    })()

  })

}( window.jQuery );
/* =========================================================
 * bootstrap-modal.js v2.0.2
 * http://twitter.github.com/bootstrap/javascript.html#modals
 * =========================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ========================================================= */


!function( $ ){

  "use strict"

 /* MODAL CLASS DEFINITION
  * ====================== */

  var Modal = function ( content, options ) {
    this.options = options
    this.$element = $(content)
      .delegate('[data-dismiss="modal"]', 'click.dismiss.modal', $.proxy(this.hide, this))
  }

  Modal.prototype = {

      constructor: Modal

    , toggle: function () {
        return this[!this.isShown ? 'show' : 'hide']()
      }

    , show: function () {
        var that = this

        if (this.isShown) return

        $('body').addClass('modal-open')

        this.isShown = true
        this.$element.trigger('show')

        escape.call(this)
        backdrop.call(this, function () {
          var transition = $.support.transition && that.$element.hasClass('fade')

          !that.$element.parent().length && that.$element.appendTo(document.body) //don't move modals dom position

          that.$element
            .show()

          if (transition) {
            that.$element[0].offsetWidth // force reflow
          }

          that.$element.addClass('in')

          transition ?
            that.$element.one($.support.transition.end, function () { that.$element.trigger('shown') }) :
            that.$element.trigger('shown')

        })
      }

    , hide: function ( e ) {
        e && e.preventDefault()

        if (!this.isShown) return

        var that = this
        this.isShown = false

        $('body').removeClass('modal-open')

        escape.call(this)

        this.$element
          .trigger('hide')
          .removeClass('in')

        $.support.transition && this.$element.hasClass('fade') ?
          hideWithTransition.call(this) :
          hideModal.call(this)
      }

  }


 /* MODAL PRIVATE METHODS
  * ===================== */

  function hideWithTransition() {
    var that = this
      , timeout = setTimeout(function () {
          that.$element.off($.support.transition.end)
          hideModal.call(that)
        }, 500)

    this.$element.one($.support.transition.end, function () {
      clearTimeout(timeout)
      hideModal.call(that)
    })
  }

  function hideModal( that ) {
    this.$element
      .hide()
      .trigger('hidden')

    backdrop.call(this)
  }

  function backdrop( callback ) {
    var that = this
      , animate = this.$element.hasClass('fade') ? 'fade' : ''

    if (this.isShown && this.options.backdrop) {
      var doAnimate = $.support.transition && animate

      this.$backdrop = $('<div class="modal-backdrop ' + animate + '" />')
        .appendTo(document.body)

      if (this.options.backdrop != 'static') {
        this.$backdrop.click($.proxy(this.hide, this))
      }

      if (doAnimate) this.$backdrop[0].offsetWidth // force reflow

      this.$backdrop.addClass('in')

      doAnimate ?
        this.$backdrop.one($.support.transition.end, callback) :
        callback()

    } else if (!this.isShown && this.$backdrop) {
      this.$backdrop.removeClass('in')

      $.support.transition && this.$element.hasClass('fade')?
        this.$backdrop.one($.support.transition.end, $.proxy(removeBackdrop, this)) :
        removeBackdrop.call(this)

    } else if (callback) {
      callback()
    }
  }

  function removeBackdrop() {
    this.$backdrop.remove()
    this.$backdrop = null
  }

  function escape() {
    var that = this
    if (this.isShown && this.options.keyboard) {
      $(document).on('keyup.dismiss.modal', function ( e ) {
        e.which == 27 && that.hide()
      })
    } else if (!this.isShown) {
      $(document).off('keyup.dismiss.modal')
    }
  }


 /* MODAL PLUGIN DEFINITION
  * ======================= */

  $.fn.modal = function ( option ) {
    return this.each(function () {
      var $this = $(this)
        , data = $this.data('modal')
        , options = $.extend({}, $.fn.modal.defaults, $this.data(), typeof option == 'object' && option)
      if (!data) $this.data('modal', (data = new Modal(this, options)))
      if (typeof option == 'string') data[option]()
      else if (options.show) data.show()
    })
  }

  $.fn.modal.defaults = {
      backdrop: true
    , keyboard: true
    , show: true
  }

  $.fn.modal.Constructor = Modal


 /* MODAL DATA-API
  * ============== */

  $(function () {
    $('body').on('click.modal.data-api', '[data-toggle="modal"]', function ( e ) {
      var $this = $(this), href
        , $target = $($this.attr('data-target') || (href = $this.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '')) //strip for ie7
        , option = $target.data('modal') ? 'toggle' : $.extend({}, $target.data(), $this.data())

      e.preventDefault()
      $target.modal(option)
    })
  })

}( window.jQuery );
/* ============================================================
 * bootstrap-dropdown.js v2.0.2
 * http://twitter.github.com/bootstrap/javascript.html#dropdowns
 * ============================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ============================================================ */


!function( $ ){

  "use strict"

 /* DROPDOWN CLASS DEFINITION
  * ========================= */

  var toggle = '[data-toggle="dropdown"]'
    , Dropdown = function ( element ) {
        var $el = $(element).on('click.dropdown.data-api', this.toggle)
        $('html').on('click.dropdown.data-api', function () {
          $el.parent().removeClass('open')
        })
      }

  Dropdown.prototype = {

    constructor: Dropdown

  , toggle: function ( e ) {
      var $this = $(this)
        , selector = $this.attr('data-target')
        , $parent
        , isActive

      if (!selector) {
        selector = $this.attr('href')
        selector = selector && selector.replace(/.*(?=#[^\s]*$)/, '') //strip for ie7
      }

      $parent = $(selector)
      $parent.length || ($parent = $this.parent())

      isActive = $parent.hasClass('open')

      clearMenus()
      !isActive && $parent.toggleClass('open')

      return false
    }

  }

  function clearMenus() {
    $(toggle).parent().removeClass('open')
  }


  /* DROPDOWN PLUGIN DEFINITION
   * ========================== */

  $.fn.dropdown = function ( option ) {
    return this.each(function () {
      var $this = $(this)
        , data = $this.data('dropdown')
      if (!data) $this.data('dropdown', (data = new Dropdown(this)))
      if (typeof option == 'string') data[option].call($this)
    })
  }

  $.fn.dropdown.Constructor = Dropdown


  /* APPLY TO STANDARD DROPDOWN ELEMENTS
   * =================================== */

  $(function () {
    $('html').on('click.dropdown.data-api', clearMenus)
    $('body').on('click.dropdown.data-api', toggle, Dropdown.prototype.toggle)
  })

}( window.jQuery );
/* =============================================================
 * bootstrap-scrollspy.js v2.0.2
 * http://twitter.github.com/bootstrap/javascript.html#scrollspy
 * =============================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ============================================================== */

!function ( $ ) {

  "use strict"

  /* SCROLLSPY CLASS DEFINITION
   * ========================== */

  function ScrollSpy( element, options) {
    var process = $.proxy(this.process, this)
      , $element = $(element).is('body') ? $(window) : $(element)
      , href
    this.options = $.extend({}, $.fn.scrollspy.defaults, options)
    this.$scrollElement = $element.on('scroll.scroll.data-api', process)
    this.selector = (this.options.target
      || ((href = $(element).attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '')) //strip for ie7
      || '') + ' .nav li > a'
    this.$body = $('body').on('click.scroll.data-api', this.selector, process)
    this.refresh()
    this.process()
  }

  ScrollSpy.prototype = {

      constructor: ScrollSpy

    , refresh: function () {
        this.targets = this.$body
          .find(this.selector)
          .map(function () {
            var href = $(this).attr('href')
            return /^#\w/.test(href) && $(href).length ? href : null
          })

        this.offsets = $.map(this.targets, function (id) {
          return $(id).position().top
        })
      }

    , process: function () {
        var scrollTop = this.$scrollElement.scrollTop() + this.options.offset
          , offsets = this.offsets
          , targets = this.targets
          , activeTarget = this.activeTarget
          , i

        for (i = offsets.length; i--;) {
          activeTarget != targets[i]
            && scrollTop >= offsets[i]
            && (!offsets[i + 1] || scrollTop <= offsets[i + 1])
            && this.activate( targets[i] )
        }
      }

    , activate: function (target) {
        var active

        this.activeTarget = target

        this.$body
          .find(this.selector).parent('.active')
          .removeClass('active')

        active = this.$body
          .find(this.selector + '[href="' + target + '"]')
          .parent('li')
          .addClass('active')

        if ( active.parent('.dropdown-menu') )  {
          active.closest('li.dropdown').addClass('active')
        }
      }

  }


 /* SCROLLSPY PLUGIN DEFINITION
  * =========================== */

  $.fn.scrollspy = function ( option ) {
    return this.each(function () {
      var $this = $(this)
        , data = $this.data('scrollspy')
        , options = typeof option == 'object' && option
      if (!data) $this.data('scrollspy', (data = new ScrollSpy(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  $.fn.scrollspy.Constructor = ScrollSpy

  $.fn.scrollspy.defaults = {
    offset: 10
  }


 /* SCROLLSPY DATA-API
  * ================== */

  $(function () {
    $('[data-spy="scroll"]').each(function () {
      var $spy = $(this)
      $spy.scrollspy($spy.data())
    })
  })

}( window.jQuery );
/* ========================================================
 * bootstrap-tab.js v2.0.2
 * http://twitter.github.com/bootstrap/javascript.html#tabs
 * ========================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ======================================================== */


!function( $ ){

  "use strict"

 /* TAB CLASS DEFINITION
  * ==================== */

  var Tab = function ( element ) {
    this.element = $(element)
  }

  Tab.prototype = {

    constructor: Tab

  , show: function () {
      var $this = this.element
        , $ul = $this.closest('ul:not(.dropdown-menu)')
        , selector = $this.attr('data-target')
        , previous
        , $target

      if (!selector) {
        selector = $this.attr('href')
        selector = selector && selector.replace(/.*(?=#[^\s]*$)/, '') //strip for ie7
      }

      if ( $this.parent('li').hasClass('active') ) return

      previous = $ul.find('.active a').last()[0]

      $this.trigger({
        type: 'show'
      , relatedTarget: previous
      })

      $target = $(selector)

      this.activate($this.parent('li'), $ul)
      this.activate($target, $target.parent(), function () {
        $this.trigger({
          type: 'shown'
        , relatedTarget: previous
        })
      })
    }

  , activate: function ( element, container, callback) {
      var $active = container.find('> .active')
        , transition = callback
            && $.support.transition
            && $active.hasClass('fade')

      function next() {
        $active
          .removeClass('active')
          .find('> .dropdown-menu > .active')
          .removeClass('active')

        element.addClass('active')

        if (transition) {
          element[0].offsetWidth // reflow for transition
          element.addClass('in')
        } else {
          element.removeClass('fade')
        }

        if ( element.parent('.dropdown-menu') ) {
          element.closest('li.dropdown').addClass('active')
        }

        callback && callback()
      }

      transition ?
        $active.one($.support.transition.end, next) :
        next()

      $active.removeClass('in')
    }
  }


 /* TAB PLUGIN DEFINITION
  * ===================== */

  $.fn.tab = function ( option ) {
    return this.each(function () {
      var $this = $(this)
        , data = $this.data('tab')
      if (!data) $this.data('tab', (data = new Tab(this)))
      if (typeof option == 'string') data[option]()
    })
  }

  $.fn.tab.Constructor = Tab


 /* TAB DATA-API
  * ============ */

  $(function () {
    $('body').on('click.tab.data-api', '[data-toggle="tab"], [data-toggle="pill"]', function (e) {
      e.preventDefault()
      $(this).tab('show')
    })
  })

}( window.jQuery );
/* ===========================================================
 * bootstrap-tooltip.js v2.0.2
 * http://twitter.github.com/bootstrap/javascript.html#tooltips
 * Inspired by the original jQuery.tipsy by Jason Frame
 * ===========================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ========================================================== */

!function( $ ) {

  "use strict"

 /* TOOLTIP PUBLIC CLASS DEFINITION
  * =============================== */

  var Tooltip = function ( element, options ) {
    this.init('tooltip', element, options)
  }

  Tooltip.prototype = {

    constructor: Tooltip

  , init: function ( type, element, options ) {
      var eventIn
        , eventOut

      this.type = type
      this.$element = $(element)
      this.options = this.getOptions(options)
      this.enabled = true

      if (this.options.trigger != 'manual') {
        eventIn  = this.options.trigger == 'hover' ? 'mouseenter' : 'focus'
        eventOut = this.options.trigger == 'hover' ? 'mouseleave' : 'blur'
        this.$element.on(eventIn, this.options.selector, $.proxy(this.enter, this))
        this.$element.on(eventOut, this.options.selector, $.proxy(this.leave, this))
      }

      this.options.selector ?
        (this._options = $.extend({}, this.options, { trigger: 'manual', selector: '' })) :
        this.fixTitle()
    }

  , getOptions: function ( options ) {
      options = $.extend({}, $.fn[this.type].defaults, options, this.$element.data())

      if (options.delay && typeof options.delay == 'number') {
        options.delay = {
          show: options.delay
        , hide: options.delay
        }
      }

      return options
    }

  , enter: function ( e ) {
      var self = $(e.currentTarget)[this.type](this._options).data(this.type)

      if (!self.options.delay || !self.options.delay.show) {
        self.show()
      } else {
        self.hoverState = 'in'
        setTimeout(function() {
          if (self.hoverState == 'in') {
            self.show()
          }
        }, self.options.delay.show)
      }
    }

  , leave: function ( e ) {
      var self = $(e.currentTarget)[this.type](this._options).data(this.type)

      if (!self.options.delay || !self.options.delay.hide) {
        self.hide()
      } else {
        self.hoverState = 'out'
        setTimeout(function() {
          if (self.hoverState == 'out') {
            self.hide()
          }
        }, self.options.delay.hide)
      }
    }

  , show: function () {
      var $tip
        , inside
        , pos
        , actualWidth
        , actualHeight
        , placement
        , tp

      if (this.hasContent() && this.enabled) {
        $tip = this.tip()
        this.setContent()

        if (this.options.animation) {
          $tip.addClass('fade')
        }

        placement = typeof this.options.placement == 'function' ?
          this.options.placement.call(this, $tip[0], this.$element[0]) :
          this.options.placement

        inside = /in/.test(placement)

        $tip
          .remove()
          .css({ top: 0, left: 0, display: 'block' })
          .appendTo(inside ? this.$element : document.body)

        pos = this.getPosition(inside)

        actualWidth = $tip[0].offsetWidth
        actualHeight = $tip[0].offsetHeight

        switch (inside ? placement.split(' ')[1] : placement) {
          case 'bottom':
            tp = {top: pos.top + pos.height, left: pos.left + pos.width / 2 - actualWidth / 2}
            break
          case 'top':
            tp = {top: pos.top - actualHeight, left: pos.left + pos.width / 2 - actualWidth / 2}
            break
          case 'left':
            tp = {top: pos.top + pos.height / 2 - actualHeight / 2, left: pos.left - actualWidth}
            break
          case 'right':
            tp = {top: pos.top + pos.height / 2 - actualHeight / 2, left: pos.left + pos.width}
            break
        }

        $tip
          .css(tp)
          .addClass(placement)
          .addClass('in')
      }
    }

  , setContent: function () {
      var $tip = this.tip()
      $tip.find('.tooltip-inner').html(this.getTitle())
      $tip.removeClass('fade in top bottom left right')
    }

  , hide: function () {
      var that = this
        , $tip = this.tip()

      $tip.removeClass('in')

      function removeWithAnimation() {
        var timeout = setTimeout(function () {
          $tip.off($.support.transition.end).remove()
        }, 500)

        $tip.one($.support.transition.end, function () {
          clearTimeout(timeout)
          $tip.remove()
        })
      }

      $.support.transition && this.$tip.hasClass('fade') ?
        removeWithAnimation() :
        $tip.remove()
    }

  , fixTitle: function () {
      var $e = this.$element
      if ($e.attr('title') || typeof($e.attr('data-original-title')) != 'string') {
        $e.attr('data-original-title', $e.attr('title') || '').removeAttr('title')
      }
    }

  , hasContent: function () {
      return this.getTitle()
    }

  , getPosition: function (inside) {
      return $.extend({}, (inside ? {top: 0, left: 0} : this.$element.offset()), {
        width: this.$element[0].offsetWidth
      , height: this.$element[0].offsetHeight
      })
    }

  , getTitle: function () {
      var title
        , $e = this.$element
        , o = this.options

      title = $e.attr('data-original-title')
        || (typeof o.title == 'function' ? o.title.call($e[0]) :  o.title)

      title = (title || '').toString().replace(/(^\s*|\s*$)/, "")

      return title
    }

  , tip: function () {
      return this.$tip = this.$tip || $(this.options.template)
    }

  , validate: function () {
      if (!this.$element[0].parentNode) {
        this.hide()
        this.$element = null
        this.options = null
      }
    }

  , enable: function () {
      this.enabled = true
    }

  , disable: function () {
      this.enabled = false
    }

  , toggleEnabled: function () {
      this.enabled = !this.enabled
    }

  , toggle: function () {
      this[this.tip().hasClass('in') ? 'hide' : 'show']()
    }

  }


 /* TOOLTIP PLUGIN DEFINITION
  * ========================= */

  $.fn.tooltip = function ( option ) {
    return this.each(function () {
      var $this = $(this)
        , data = $this.data('tooltip')
        , options = typeof option == 'object' && option
      if (!data) $this.data('tooltip', (data = new Tooltip(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  $.fn.tooltip.Constructor = Tooltip

  $.fn.tooltip.defaults = {
    animation: true
  , delay: 0
  , selector: false
  , placement: 'top'
  , trigger: 'hover'
  , title: ''
  , template: '<div class="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>'
  }

}( window.jQuery );
/* ===========================================================
 * bootstrap-popover.js v2.0.2
 * http://twitter.github.com/bootstrap/javascript.html#popovers
 * ===========================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =========================================================== */


!function( $ ) {

 "use strict"

  var Popover = function ( element, options ) {
    this.init('popover', element, options)
  }

  /* NOTE: POPOVER EXTENDS BOOTSTRAP-TOOLTIP.js
     ========================================== */

  Popover.prototype = $.extend({}, $.fn.tooltip.Constructor.prototype, {

    constructor: Popover

  , setContent: function () {
      var $tip = this.tip()
        , title = this.getTitle()
        , content = this.getContent()

      $tip.find('.popover-title')[ $.type(title) == 'object' ? 'append' : 'html' ](title)
      $tip.find('.popover-content > *')[ $.type(content) == 'object' ? 'append' : 'html' ](content)

      $tip.removeClass('fade top bottom left right in')
    }

  , hasContent: function () {
      return this.getTitle() || this.getContent()
    }

  , getContent: function () {
      var content
        , $e = this.$element
        , o = this.options

      content = $e.attr('data-content')
        || (typeof o.content == 'function' ? o.content.call($e[0]) :  o.content)

      content = content.toString().replace(/(^\s*|\s*$)/, "")

      return content
    }

  , tip: function() {
      if (!this.$tip) {
        this.$tip = $(this.options.template)
      }
      return this.$tip
    }

  })


 /* POPOVER PLUGIN DEFINITION
  * ======================= */

  $.fn.popover = function ( option ) {
    return this.each(function () {
      var $this = $(this)
        , data = $this.data('popover')
        , options = typeof option == 'object' && option
      if (!data) $this.data('popover', (data = new Popover(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  $.fn.popover.Constructor = Popover

  $.fn.popover.defaults = $.extend({} , $.fn.tooltip.defaults, {
    placement: 'right'
  , content: ''
  , template: '<div class="popover"><div class="arrow"></div><div class="popover-inner"><h3 class="popover-title"></h3><div class="popover-content"><p></p></div></div></div>'
  })

}( window.jQuery );
/* ==========================================================
 * bootstrap-alert.js v2.0.2
 * http://twitter.github.com/bootstrap/javascript.html#alerts
 * ==========================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ========================================================== */


!function( $ ){

  "use strict"

 /* ALERT CLASS DEFINITION
  * ====================== */

  var dismiss = '[data-dismiss="alert"]'
    , Alert = function ( el ) {
        $(el).on('click', dismiss, this.close)
      }

  Alert.prototype = {

    constructor: Alert

  , close: function ( e ) {
      var $this = $(this)
        , selector = $this.attr('data-target')
        , $parent

      if (!selector) {
        selector = $this.attr('href')
        selector = selector && selector.replace(/.*(?=#[^\s]*$)/, '') //strip for ie7
      }

      $parent = $(selector)
      $parent.trigger('close')

      e && e.preventDefault()

      $parent.length || ($parent = $this.hasClass('alert') ? $this : $this.parent())

      $parent
        .trigger('close')
        .removeClass('in')

      function removeElement() {
        $parent
          .trigger('closed')
          .remove()
      }

      $.support.transition && $parent.hasClass('fade') ?
        $parent.on($.support.transition.end, removeElement) :
        removeElement()
    }

  }


 /* ALERT PLUGIN DEFINITION
  * ======================= */

  $.fn.alert = function ( option ) {
    return this.each(function () {
      var $this = $(this)
        , data = $this.data('alert')
      if (!data) $this.data('alert', (data = new Alert(this)))
      if (typeof option == 'string') data[option].call($this)
    })
  }

  $.fn.alert.Constructor = Alert


 /* ALERT DATA-API
  * ============== */

  $(function () {
    $('body').on('click.alert.data-api', dismiss, Alert.prototype.close)
  })

}( window.jQuery );
/* ============================================================
 * bootstrap-button.js v2.0.2
 * http://twitter.github.com/bootstrap/javascript.html#buttons
 * ============================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ============================================================ */

!function( $ ){

  "use strict"

 /* BUTTON PUBLIC CLASS DEFINITION
  * ============================== */

  var Button = function ( element, options ) {
    this.$element = $(element)
    this.options = $.extend({}, $.fn.button.defaults, options)
  }

  Button.prototype = {

      constructor: Button

    , setState: function ( state ) {
        var d = 'disabled'
          , $el = this.$element
          , data = $el.data()
          , val = $el.is('input') ? 'val' : 'html'

        state = state + 'Text'
        data.resetText || $el.data('resetText', $el[val]())

        $el[val](data[state] || this.options[state])

        // push to event loop to allow forms to submit
        setTimeout(function () {
          state == 'loadingText' ?
            $el.addClass(d).attr(d, d) :
            $el.removeClass(d).removeAttr(d)
        }, 0)
      }

    , toggle: function () {
        var $parent = this.$element.parent('[data-toggle="buttons-radio"]')

        $parent && $parent
          .find('.active')
          .removeClass('active')

        this.$element.toggleClass('active')
      }

  }


 /* BUTTON PLUGIN DEFINITION
  * ======================== */

  $.fn.button = function ( option ) {
    return this.each(function () {
      var $this = $(this)
        , data = $this.data('button')
        , options = typeof option == 'object' && option
      if (!data) $this.data('button', (data = new Button(this, options)))
      if (option == 'toggle') data.toggle()
      else if (option) data.setState(option)
    })
  }

  $.fn.button.defaults = {
    loadingText: 'loading...'
  }

  $.fn.button.Constructor = Button


 /* BUTTON DATA-API
  * =============== */

  $(function () {
    $('body').on('click.button.data-api', '[data-toggle^=button]', function ( e ) {
      var $btn = $(e.target)
      if (!$btn.hasClass('btn')) $btn = $btn.closest('.btn')
      $btn.button('toggle')
    })
  })

}( window.jQuery );
/* =============================================================
 * bootstrap-collapse.js v2.0.2
 * http://twitter.github.com/bootstrap/javascript.html#collapse
 * =============================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ============================================================ */

!function( $ ){

  "use strict"

  var Collapse = function ( element, options ) {
  	this.$element = $(element)
    this.options = $.extend({}, $.fn.collapse.defaults, options)

    if (this.options["parent"]) {
      this.$parent = $(this.options["parent"])
    }

    this.options.toggle && this.toggle()
  }

  Collapse.prototype = {

    constructor: Collapse

  , dimension: function () {
      var hasWidth = this.$element.hasClass('width')
      return hasWidth ? 'width' : 'height'
    }

  , show: function () {
      var dimension = this.dimension()
        , scroll = $.camelCase(['scroll', dimension].join('-'))
        , actives = this.$parent && this.$parent.find('.in')
        , hasData

      if (actives && actives.length) {
        hasData = actives.data('collapse')
        actives.collapse('hide')
        hasData || actives.data('collapse', null)
      }

      this.$element[dimension](0)
      this.transition('addClass', 'show', 'shown')
      this.$element[dimension](this.$element[0][scroll])

    }

  , hide: function () {
      var dimension = this.dimension()
      this.reset(this.$element[dimension]())
      this.transition('removeClass', 'hide', 'hidden')
      this.$element[dimension](0)
    }

  , reset: function ( size ) {
      var dimension = this.dimension()

      this.$element
        .removeClass('collapse')
        [dimension](size || 'auto')
        [0].offsetWidth

      this.$element[size ? 'addClass' : 'removeClass']('collapse')

      return this
    }

  , transition: function ( method, startEvent, completeEvent ) {
      var that = this
        , complete = function () {
            if (startEvent == 'show') that.reset()
            that.$element.trigger(completeEvent)
          }

      this.$element
        .trigger(startEvent)
        [method]('in')

      $.support.transition && this.$element.hasClass('collapse') ?
        this.$element.one($.support.transition.end, complete) :
        complete()
  	}

  , toggle: function () {
      this[this.$element.hasClass('in') ? 'hide' : 'show']()
  	}

  }

  /* COLLAPSIBLE PLUGIN DEFINITION
  * ============================== */

  $.fn.collapse = function ( option ) {
    return this.each(function () {
      var $this = $(this)
        , data = $this.data('collapse')
        , options = typeof option == 'object' && option
      if (!data) $this.data('collapse', (data = new Collapse(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  $.fn.collapse.defaults = {
    toggle: true
  }

  $.fn.collapse.Constructor = Collapse


 /* COLLAPSIBLE DATA-API
  * ==================== */

  $(function () {
    $('body').on('click.collapse.data-api', '[data-toggle=collapse]', function ( e ) {
      var $this = $(this), href
        , target = $this.attr('data-target')
          || e.preventDefault()
          || (href = $this.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '') //strip for ie7
        , option = $(target).data('collapse') ? 'toggle' : $this.data()
      $(target).collapse(option)
    })
  })

}( window.jQuery );
/* ==========================================================
 * bootstrap-carousel.js v2.0.2
 * http://twitter.github.com/bootstrap/javascript.html#carousel
 * ==========================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ========================================================== */


!function( $ ){

  "use strict"

 /* CAROUSEL CLASS DEFINITION
  * ========================= */

  var Carousel = function (element, options) {
    this.$element = $(element)
    this.options = $.extend({}, $.fn.carousel.defaults, options)
    this.options.slide && this.slide(this.options.slide)
    this.options.pause == 'hover' && this.$element
      .on('mouseenter', $.proxy(this.pause, this))
      .on('mouseleave', $.proxy(this.cycle, this))
  }

  Carousel.prototype = {

    cycle: function () {
      this.interval = setInterval($.proxy(this.next, this), this.options.interval)
      return this
    }

  , to: function (pos) {
      var $active = this.$element.find('.active')
        , children = $active.parent().children()
        , activePos = children.index($active)
        , that = this

      if (pos > (children.length - 1) || pos < 0) return

      if (this.sliding) {
        return this.$element.one('slid', function () {
          that.to(pos)
        })
      }

      if (activePos == pos) {
        return this.pause().cycle()
      }

      return this.slide(pos > activePos ? 'next' : 'prev', $(children[pos]))
    }

  , pause: function () {
      clearInterval(this.interval)
      this.interval = null
      return this
    }

  , next: function () {
      if (this.sliding) return
      return this.slide('next')
    }

  , prev: function () {
      if (this.sliding) return
      return this.slide('prev')
    }

  , slide: function (type, next) {
      var $active = this.$element.find('.active')
        , $next = next || $active[type]()
        , isCycling = this.interval
        , direction = type == 'next' ? 'left' : 'right'
        , fallback  = type == 'next' ? 'first' : 'last'
        , that = this

      this.sliding = true

      isCycling && this.pause()

      $next = $next.length ? $next : this.$element.find('.item')[fallback]()

      if ($next.hasClass('active')) return

      if (!$.support.transition && this.$element.hasClass('slide')) {
        this.$element.trigger('slide')
        $active.removeClass('active')
        $next.addClass('active')
        this.sliding = false
        this.$element.trigger('slid')
      } else {
        $next.addClass(type)
        $next[0].offsetWidth // force reflow
        $active.addClass(direction)
        $next.addClass(direction)
        this.$element.trigger('slide')
        this.$element.one($.support.transition.end, function () {
          $next.removeClass([type, direction].join(' ')).addClass('active')
          $active.removeClass(['active', direction].join(' '))
          that.sliding = false
          setTimeout(function () { that.$element.trigger('slid') }, 0)
        })
      }

      isCycling && this.cycle()

      return this
    }

  }


 /* CAROUSEL PLUGIN DEFINITION
  * ========================== */

  $.fn.carousel = function ( option ) {
    return this.each(function () {
      var $this = $(this)
        , data = $this.data('carousel')
        , options = typeof option == 'object' && option
      if (!data) $this.data('carousel', (data = new Carousel(this, options)))
      if (typeof option == 'number') data.to(option)
      else if (typeof option == 'string' || (option = options.slide)) data[option]()
      else data.cycle()
    })
  }

  $.fn.carousel.defaults = {
    interval: 5000
  , pause: 'hover'
  }

  $.fn.carousel.Constructor = Carousel


 /* CAROUSEL DATA-API
  * ================= */

  $(function () {
    $('body').on('click.carousel.data-api', '[data-slide]', function ( e ) {
      var $this = $(this), href
        , $target = $($this.attr('data-target') || (href = $this.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '')) //strip for ie7
        , options = !$target.data('modal') && $.extend({}, $target.data(), $this.data())
      $target.carousel(options)
      e.preventDefault()
    })
  })

}( window.jQuery );
/* =============================================================
 * bootstrap-typeahead.js v2.0.2
 * http://twitter.github.com/bootstrap/javascript.html#typeahead
 * =============================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ============================================================ */

!function( $ ){

  "use strict"

  var Typeahead = function ( element, options ) {
    this.$element = $(element)
    this.options = $.extend({}, $.fn.typeahead.defaults, options)
    this.matcher = this.options.matcher || this.matcher
    this.sorter = this.options.sorter || this.sorter
    this.highlighter = this.options.highlighter || this.highlighter
    this.$menu = $(this.options.menu).appendTo('body')
    this.source = this.options.source
    this.shown = false
    this.listen()
  }

  Typeahead.prototype = {

    constructor: Typeahead

  , select: function () {
      var val = this.$menu.find('.active').attr('data-value')
      this.$element.val(val)
      this.$element.change();
      return this.hide()
    }

  , show: function () {
      var pos = $.extend({}, this.$element.offset(), {
        height: this.$element[0].offsetHeight
      })

      this.$menu.css({
        top: pos.top + pos.height
      , left: pos.left
      })

      this.$menu.show()
      this.shown = true
      return this
    }

  , hide: function () {
      this.$menu.hide()
      this.shown = false
      return this
    }

  , lookup: function (event) {
      var that = this
        , items
        , q

      this.query = this.$element.val()

      if (!this.query) {
        return this.shown ? this.hide() : this
      }

      items = $.grep(this.source, function (item) {
        if (that.matcher(item)) return item
      })

      items = this.sorter(items)

      if (!items.length) {
        return this.shown ? this.hide() : this
      }

      return this.render(items.slice(0, this.options.items)).show()
    }

  , matcher: function (item) {
      return ~item.toLowerCase().indexOf(this.query.toLowerCase())
    }

  , sorter: function (items) {
      var beginswith = []
        , caseSensitive = []
        , caseInsensitive = []
        , item

      while (item = items.shift()) {
        if (!item.toLowerCase().indexOf(this.query.toLowerCase())) beginswith.push(item)
        else if (~item.indexOf(this.query)) caseSensitive.push(item)
        else caseInsensitive.push(item)
      }

      return beginswith.concat(caseSensitive, caseInsensitive)
    }

  , highlighter: function (item) {
      return item.replace(new RegExp('(' + this.query + ')', 'ig'), function ($1, match) {
        return '<strong>' + match + '</strong>'
      })
    }

  , render: function (items) {
      var that = this

      items = $(items).map(function (i, item) {
        i = $(that.options.item).attr('data-value', item)
        i.find('a').html(that.highlighter(item))
        return i[0]
      })

      items.first().addClass('active')
      this.$menu.html(items)
      return this
    }

  , next: function (event) {
      var active = this.$menu.find('.active').removeClass('active')
        , next = active.next()

      if (!next.length) {
        next = $(this.$menu.find('li')[0])
      }

      next.addClass('active')
    }

  , prev: function (event) {
      var active = this.$menu.find('.active').removeClass('active')
        , prev = active.prev()

      if (!prev.length) {
        prev = this.$menu.find('li').last()
      }

      prev.addClass('active')
    }

  , listen: function () {
      this.$element
        .on('blur',     $.proxy(this.blur, this))
        .on('keypress', $.proxy(this.keypress, this))
        .on('keyup',    $.proxy(this.keyup, this))

      if ($.browser.webkit || $.browser.msie) {
        this.$element.on('keydown', $.proxy(this.keypress, this))
      }

      this.$menu
        .on('click', $.proxy(this.click, this))
        .on('mouseenter', 'li', $.proxy(this.mouseenter, this))
    }

  , keyup: function (e) {
      switch(e.keyCode) {
        case 40: // down arrow
        case 38: // up arrow
          break

        case 9: // tab
        case 13: // enter
          if (!this.shown) return
          this.select()
          break

        case 27: // escape
          if (!this.shown) return
          this.hide()
          break

        default:
          this.lookup()
      }

      e.stopPropagation()
      e.preventDefault()
  }

  , keypress: function (e) {
      if (!this.shown) return

      switch(e.keyCode) {
        case 9: // tab
        case 13: // enter
        case 27: // escape
          e.preventDefault()
          break

        case 38: // up arrow
          e.preventDefault()
          this.prev()
          break

        case 40: // down arrow
          e.preventDefault()
          this.next()
          break
      }

      e.stopPropagation()
    }

  , blur: function (e) {
      var that = this
      setTimeout(function () { that.hide() }, 150)
    }

  , click: function (e) {
      e.stopPropagation()
      e.preventDefault()
      this.select()
    }

  , mouseenter: function (e) {
      this.$menu.find('.active').removeClass('active')
      $(e.currentTarget).addClass('active')
    }

  }


  /* TYPEAHEAD PLUGIN DEFINITION
   * =========================== */

  $.fn.typeahead = function ( option ) {
    return this.each(function () {
      var $this = $(this)
        , data = $this.data('typeahead')
        , options = typeof option == 'object' && option
      if (!data) $this.data('typeahead', (data = new Typeahead(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  $.fn.typeahead.defaults = {
    source: []
  , items: 8
  , menu: '<ul class="typeahead dropdown-menu"></ul>'
  , item: '<li><a href="#"></a></li>'
  }

  $.fn.typeahead.Constructor = Typeahead


 /* TYPEAHEAD DATA-API
  * ================== */

  $(function () {
    $('body').on('focus.typeahead.data-api', '[data-provide="typeahead"]', function (e) {
      var $this = $(this)
      if ($this.data('typeahead')) return
      e.preventDefault()
      $this.typeahead($this.data())
    })
  })

}( window.jQuery );
var Markdown;

if (typeof exports === "object" && typeof require === "function") // we're in a CommonJS (e.g. Node.js) module
    Markdown = exports;
else
    Markdown = {};
    
// The following text is included for historical reasons, but should
// be taken with a pinch of salt; it's not all true anymore.

//
// Wherever possible, Showdown is a straight, line-by-line port
// of the Perl version of Markdown.
//
// This is not a normal parser design; it's basically just a
// series of string substitutions.  It's hard to read and
// maintain this way,  but keeping Showdown close to the original
// design makes it easier to port new features.
//
// More importantly, Showdown behaves like markdown.pl in most
// edge cases.  So web applications can do client-side preview
// in Javascript, and then build identical HTML on the server.
//
// This port needs the new RegExp functionality of ECMA 262,
// 3rd Edition (i.e. Javascript 1.5).  Most modern web browsers
// should do fine.  Even with the new regular expression features,
// We do a lot of work to emulate Perl's regex functionality.
// The tricky changes in this file mostly have the "attacklab:"
// label.  Major or self-explanatory changes don't.
//
// Smart diff tools like Araxis Merge will be able to match up
// this file with markdown.pl in a useful way.  A little tweaking
// helps: in a copy of markdown.pl, replace "#" with "//" and
// replace "$text" with "text".  Be sure to ignore whitespace
// and line endings.
//


//
// Usage:
//
//   var text = "Markdown *rocks*.";
//
//   var converter = new Markdown.Converter();
//   var html = converter.makeHtml(text);
//
//   alert(html);
//
// Note: move the sample code to the bottom of this
// file before uncommenting it.
//

(function () {

    function identity(x) { return x; }
    function returnFalse(x) { return false; }

    function HookCollection() { }

    HookCollection.prototype = {

        chain: function (hookname, func) {
            var original = this[hookname];
            if (!original)
                throw new Error("unknown hook " + hookname);

            if (original === identity)
                this[hookname] = func;
            else
                this[hookname] = function (text) {
                    var args = Array.prototype.slice.call(arguments, 0);
                    args[0] = original.apply(null, args);
                    return func.apply(null, args);
                };
        },
        set: function (hookname, func) {
            if (!this[hookname])
                throw new Error("unknown hook " + hookname);
            this[hookname] = func;
        },
        addNoop: function (hookname) {
            this[hookname] = identity;
        },
        addFalse: function (hookname) {
            this[hookname] = returnFalse;
        }
    };

    Markdown.HookCollection = HookCollection;

    // g_urls and g_titles allow arbitrary user-entered strings as keys. This
    // caused an exception (and hence stopped the rendering) when the user entered
    // e.g. [push] or [__proto__]. Adding a prefix to the actual key prevents this
    // (since no builtin property starts with "s_"). See
    // http://meta.stackoverflow.com/questions/64655/strange-wmd-bug
    // (granted, switching from Array() to Object() alone would have left only __proto__
    // to be a problem)
    function SaveHash() { }
    SaveHash.prototype = {
        set: function (key, value) {
            this["s_" + key] = value;
        },
        get: function (key) {
            return this["s_" + key];
        }
    };

    Markdown.Converter = function () {
        var pluginHooks = this.hooks = new HookCollection();
        
        // given a URL that was encountered by itself (without markup), should return the link text that's to be given to this link
        pluginHooks.addNoop("plainLinkText");
        
        // called with the orignal text as given to makeHtml. The result of this plugin hook is the actual markdown source that will be cooked
        pluginHooks.addNoop("preConversion");
        
        // called with the text once all normalizations have been completed (tabs to spaces, line endings, etc.), but before any conversions have
        pluginHooks.addNoop("postNormalization");
        
        // Called with the text before / after creating block elements like code blocks and lists. Note that this is called recursively
        // with inner content, e.g. it's called with the full text, and then only with the content of a blockquote. The inner
        // call will receive outdented text.
        pluginHooks.addNoop("preBlockGamut");
        pluginHooks.addNoop("postBlockGamut");
        
        // called with the text of a single block element before / after the span-level conversions (bold, code spans, etc.) have been made
        pluginHooks.addNoop("preSpanGamut");
        pluginHooks.addNoop("postSpanGamut");
        
        // called with the final cooked HTML code. The result of this plugin hook is the actual output of makeHtml
        pluginHooks.addNoop("postConversion");

        //
        // Private state of the converter instance:
        //

        // Global hashes, used by various utility routines
        var g_urls;
        var g_titles;
        var g_html_blocks;

        // Used to track when we're inside an ordered or unordered list
        // (see _ProcessListItems() for details):
        var g_list_level;

        this.makeHtml = function (text) {

            //
            // Main function. The order in which other subs are called here is
            // essential. Link and image substitutions need to happen before
            // _EscapeSpecialCharsWithinTagAttributes(), so that any *'s or _'s in the <a>
            // and <img> tags get encoded.
            //

            // This will only happen if makeHtml on the same converter instance is called from a plugin hook.
            // Don't do that.
            if (g_urls)
                throw new Error("Recursive call to converter.makeHtml");
        
            // Create the private state objects.
            g_urls = new SaveHash();
            g_titles = new SaveHash();
            g_html_blocks = [];
            g_list_level = 0;

            text = pluginHooks.preConversion(text);

            // attacklab: Replace ~ with ~T
            // This lets us use tilde as an escape char to avoid md5 hashes
            // The choice of character is arbitray; anything that isn't
            // magic in Markdown will work.
            text = text.replace(/~/g, "~T");

            // attacklab: Replace $ with ~D
            // RegExp interprets $ as a special character
            // when it's in a replacement string
            text = text.replace(/\$/g, "~D");

            // Standardize line endings
            text = text.replace(/\r\n/g, "\n"); // DOS to Unix
            text = text.replace(/\r/g, "\n"); // Mac to Unix

            // Make sure text begins and ends with a couple of newlines:
            text = "\n\n" + text + "\n\n";

            // Convert all tabs to spaces.
            text = _Detab(text);

            // Strip any lines consisting only of spaces and tabs.
            // This makes subsequent regexen easier to write, because we can
            // match consecutive blank lines with /\n+/ instead of something
            // contorted like /[ \t]*\n+/ .
            text = text.replace(/^[ \t]+$/mg, "");
            
            text = pluginHooks.postNormalization(text);

            // Turn block-level HTML blocks into hash entries
            text = _HashHTMLBlocks(text);

            // Strip link definitions, store in hashes.
            text = _StripLinkDefinitions(text);

            text = _RunBlockGamut(text);

            text = _UnescapeSpecialChars(text);

            // attacklab: Restore dollar signs
            text = text.replace(/~D/g, "$$");

            // attacklab: Restore tildes
            text = text.replace(/~T/g, "~");

            text = pluginHooks.postConversion(text);

            g_html_blocks = g_titles = g_urls = null;

            return text;
        };

        function _StripLinkDefinitions(text) {
            //
            // Strips link definitions from text, stores the URLs and titles in
            // hash references.
            //

            // Link defs are in the form: ^[id]: url "optional title"

            /*
            text = text.replace(/
                ^[ ]{0,3}\[(.+)\]:  // id = $1  attacklab: g_tab_width - 1
                [ \t]*
                \n?                 // maybe *one* newline
                [ \t]*
                <?(\S+?)>?          // url = $2
                (?=\s|$)            // lookahead for whitespace instead of the lookbehind removed below
                [ \t]*
                \n?                 // maybe one newline
                [ \t]*
                (                   // (potential) title = $3
                    (\n*)           // any lines skipped = $4 attacklab: lookbehind removed
                    [ \t]+
                    ["(]
                    (.+?)           // title = $5
                    [")]
                    [ \t]*
                )?                  // title is optional
                (?:\n+|$)
            /gm, function(){...});
            */

            text = text.replace(/^[ ]{0,3}\[(.+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?(?=\s|$)[ \t]*\n?[ \t]*((\n*)["(](.+?)[")][ \t]*)?(?:\n+)/gm,
                function (wholeMatch, m1, m2, m3, m4, m5) {
                    m1 = m1.toLowerCase();
                    g_urls.set(m1, _EncodeAmpsAndAngles(m2));  // Link IDs are case-insensitive
                    if (m4) {
                        // Oops, found blank lines, so it's not a title.
                        // Put back the parenthetical statement we stole.
                        return m3;
                    } else if (m5) {
                        g_titles.set(m1, m5.replace(/"/g, "&quot;"));
                    }

                    // Completely remove the definition from the text
                    return "";
                }
            );

            return text;
        }

        function _HashHTMLBlocks(text) {

            // Hashify HTML blocks:
            // We only want to do this for block-level HTML tags, such as headers,
            // lists, and tables. That's because we still want to wrap <p>s around
            // "paragraphs" that are wrapped in non-block-level tags, such as anchors,
            // phrase emphasis, and spans. The list of tags we're looking for is
            // hard-coded:
            var block_tags_a = "p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del"
            var block_tags_b = "p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math"

            // First, look for nested blocks, e.g.:
            //   <div>
            //     <div>
            //     tags for inner block must be indented.
            //     </div>
            //   </div>
            //
            // The outermost tags must start at the left margin for this to match, and
            // the inner nested divs must be indented.
            // We need to do this before the next, more liberal match, because the next
            // match will start at the first `<div>` and stop at the first `</div>`.

            // attacklab: This regex can be expensive when it fails.

            /*
            text = text.replace(/
                (                       // save in $1
                    ^                   // start of line  (with /m)
                    <($block_tags_a)    // start tag = $2
                    \b                  // word break
                                        // attacklab: hack around khtml/pcre bug...
                    [^\r]*?\n           // any number of lines, minimally matching
                    </\2>               // the matching end tag
                    [ \t]*              // trailing spaces/tabs
                    (?=\n+)             // followed by a newline
                )                       // attacklab: there are sentinel newlines at end of document
            /gm,function(){...}};
            */
            text = text.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del)\b[^\r]*?\n<\/\2>[ \t]*(?=\n+))/gm, hashElement);

            //
            // Now match more liberally, simply from `\n<tag>` to `</tag>\n`
            //

            /*
            text = text.replace(/
                (                       // save in $1
                    ^                   // start of line  (with /m)
                    <($block_tags_b)    // start tag = $2
                    \b                  // word break
                                        // attacklab: hack around khtml/pcre bug...
                    [^\r]*?             // any number of lines, minimally matching
                    .*</\2>             // the matching end tag
                    [ \t]*              // trailing spaces/tabs
                    (?=\n+)             // followed by a newline
                )                       // attacklab: there are sentinel newlines at end of document
            /gm,function(){...}};
            */
            text = text.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math)\b[^\r]*?.*<\/\2>[ \t]*(?=\n+)\n)/gm, hashElement);

            // Special case just for <hr />. It was easier to make a special case than
            // to make the other regex more complicated.  

            /*
            text = text.replace(/
                \n                  // Starting after a blank line
                [ ]{0,3}
                (                   // save in $1
                    (<(hr)          // start tag = $2
                        \b          // word break
                        ([^<>])*?
                    \/?>)           // the matching end tag
                    [ \t]*
                    (?=\n{2,})      // followed by a blank line
                )
            /g,hashElement);
            */
            text = text.replace(/\n[ ]{0,3}((<(hr)\b([^<>])*?\/?>)[ \t]*(?=\n{2,}))/g, hashElement);

            // Special case for standalone HTML comments:

            /*
            text = text.replace(/
                \n\n                                            // Starting after a blank line
                [ ]{0,3}                                        // attacklab: g_tab_width - 1
                (                                               // save in $1
                    <!
                    (--(?:|(?:[^>-]|-[^>])(?:[^-]|-[^-])*)--)   // see http://www.w3.org/TR/html-markup/syntax.html#comments and http://meta.stackoverflow.com/q/95256
                    >
                    [ \t]*
                    (?=\n{2,})                                  // followed by a blank line
                )
            /g,hashElement);
            */
            text = text.replace(/\n\n[ ]{0,3}(<!(--(?:|(?:[^>-]|-[^>])(?:[^-]|-[^-])*)--)>[ \t]*(?=\n{2,}))/g, hashElement);

            // PHP and ASP-style processor instructions (<?...?> and <%...%>)

            /*
            text = text.replace(/
                (?:
                    \n\n            // Starting after a blank line
                )
                (                   // save in $1
                    [ ]{0,3}        // attacklab: g_tab_width - 1
                    (?:
                        <([?%])     // $2
                        [^\r]*?
                        \2>
                    )
                    [ \t]*
                    (?=\n{2,})      // followed by a blank line
                )
            /g,hashElement);
            */
            text = text.replace(/(?:\n\n)([ ]{0,3}(?:<([?%])[^\r]*?\2>)[ \t]*(?=\n{2,}))/g, hashElement);

            return text;
        }

        function hashElement(wholeMatch, m1) {
            var blockText = m1;

            // Undo double lines
            blockText = blockText.replace(/^\n+/, "");

            // strip trailing blank lines
            blockText = blockText.replace(/\n+$/g, "");

            // Replace the element text with a marker ("~KxK" where x is its key)
            blockText = "\n\n~K" + (g_html_blocks.push(blockText) - 1) + "K\n\n";

            return blockText;
        }
        
        var blockGamutHookCallback = function (t) { return _RunBlockGamut(t); }

        function _RunBlockGamut(text, doNotUnhash) {
            //
            // These are all the transformations that form block-level
            // tags like paragraphs, headers, and list items.
            //
            
            text = pluginHooks.preBlockGamut(text, blockGamutHookCallback);
            
            text = _DoHeaders(text);

            // Do Horizontal Rules:
            var replacement = "<hr />\n";
            text = text.replace(/^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$/gm, replacement);
            text = text.replace(/^[ ]{0,2}([ ]?-[ ]?){3,}[ \t]*$/gm, replacement);
            text = text.replace(/^[ ]{0,2}([ ]?_[ ]?){3,}[ \t]*$/gm, replacement);

            text = _DoLists(text);
            text = _DoCodeBlocks(text);
            text = _DoBlockQuotes(text);
            
            text = pluginHooks.postBlockGamut(text, blockGamutHookCallback);

            // We already ran _HashHTMLBlocks() before, in Markdown(), but that
            // was to escape raw HTML in the original Markdown source. This time,
            // we're escaping the markup we've just created, so that we don't wrap
            // <p> tags around block-level tags.
            text = _HashHTMLBlocks(text);
            text = _FormParagraphs(text, doNotUnhash);

            return text;
        }

        function _RunSpanGamut(text) {
            //
            // These are all the transformations that occur *within* block-level
            // tags like paragraphs, headers, and list items.
            //

            text = pluginHooks.preSpanGamut(text);
            
            text = _DoCodeSpans(text);
            text = _EscapeSpecialCharsWithinTagAttributes(text);
            text = _EncodeBackslashEscapes(text);

            // Process anchor and image tags. Images must come first,
            // because ![foo][f] looks like an anchor.
            text = _DoImages(text);
            text = _DoAnchors(text);

            // Make links out of things like `<http://example.com/>`
            // Must come after _DoAnchors(), because you can use < and >
            // delimiters in inline links like [this](<url>).
            text = _DoAutoLinks(text);
            
            text = text.replace(/~P/g, "://"); // put in place to prevent autolinking; reset now
            
            text = _EncodeAmpsAndAngles(text);
            text = _DoItalicsAndBold(text);

            // Do hard breaks:
            text = text.replace(/  +\n/g, " <br>\n");
            
            text = pluginHooks.postSpanGamut(text);

            return text;
        }

        function _EscapeSpecialCharsWithinTagAttributes(text) {
            //
            // Within tags -- meaning between < and > -- encode [\ ` * _] so they
            // don't conflict with their use in Markdown for code, italics and strong.
            //

            // Build a regex to find HTML tags and comments.  See Friedl's 
            // "Mastering Regular Expressions", 2nd Ed., pp. 200-201.

            // SE: changed the comment part of the regex

            var regex = /(<[a-z\/!$]("[^"]*"|'[^']*'|[^'">])*>|<!(--(?:|(?:[^>-]|-[^>])(?:[^-]|-[^-])*)--)>)/gi;

            text = text.replace(regex, function (wholeMatch) {
                var tag = wholeMatch.replace(/(.)<\/?code>(?=.)/g, "$1`");
                tag = escapeCharacters(tag, wholeMatch.charAt(1) == "!" ? "\\`*_/" : "\\`*_"); // also escape slashes in comments to prevent autolinking there -- http://meta.stackoverflow.com/questions/95987
                return tag;
            });

            return text;
        }

        function _DoAnchors(text) {
            //
            // Turn Markdown link shortcuts into XHTML <a> tags.
            //
            //
            // First, handle reference-style links: [link text] [id]
            //

            /*
            text = text.replace(/
                (                           // wrap whole match in $1
                    \[
                    (
                        (?:
                            \[[^\]]*\]      // allow brackets nested one level
                            |
                            [^\[]           // or anything else
                        )*
                    )
                    \]

                    [ ]?                    // one optional space
                    (?:\n[ ]*)?             // one optional newline followed by spaces

                    \[
                    (.*?)                   // id = $3
                    \]
                )
                ()()()()                    // pad remaining backreferences
            /g, writeAnchorTag);
            */
            text = text.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g, writeAnchorTag);

            //
            // Next, inline-style links: [link text](url "optional title")
            //

            /*
            text = text.replace(/
                (                           // wrap whole match in $1
                    \[
                    (
                        (?:
                            \[[^\]]*\]      // allow brackets nested one level
                            |
                            [^\[\]]         // or anything else
                        )*
                    )
                    \]
                    \(                      // literal paren
                    [ \t]*
                    ()                      // no id, so leave $3 empty
                    <?(                     // href = $4
                        (?:
                            \([^)]*\)       // allow one level of (correctly nested) parens (think MSDN)
                            |
                            [^()\s]
                        )*?
                    )>?                
                    [ \t]*
                    (                       // $5
                        (['"])              // quote char = $6
                        (.*?)               // Title = $7
                        \6                  // matching quote
                        [ \t]*              // ignore any spaces/tabs between closing quote and )
                    )?                      // title is optional
                    \)
                )
            /g, writeAnchorTag);
            */

            text = text.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\]\([ \t]*()<?((?:\([^)]*\)|[^()\s])*?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g, writeAnchorTag);

            //
            // Last, handle reference-style shortcuts: [link text]
            // These must come last in case you've also got [link test][1]
            // or [link test](/foo)
            //

            /*
            text = text.replace(/
                (                   // wrap whole match in $1
                    \[
                    ([^\[\]]+)      // link text = $2; can't contain '[' or ']'
                    \]
                )
                ()()()()()          // pad rest of backreferences
            /g, writeAnchorTag);
            */
            text = text.replace(/(\[([^\[\]]+)\])()()()()()/g, writeAnchorTag);

            return text;
        }

        function writeAnchorTag(wholeMatch, m1, m2, m3, m4, m5, m6, m7) {
            if (m7 == undefined) m7 = "";
            var whole_match = m1;
            var link_text = m2.replace(/:\/\//g, "~P"); // to prevent auto-linking withing the link. will be converted back after the auto-linker runs
            var link_id = m3.toLowerCase();
            var url = m4;
            var title = m7;

            if (url == "") {
                if (link_id == "") {
                    // lower-case and turn embedded newlines into spaces
                    link_id = link_text.toLowerCase().replace(/ ?\n/g, " ");
                }
                url = "#" + link_id;

                if (g_urls.get(link_id) != undefined) {
                    url = g_urls.get(link_id);
                    if (g_titles.get(link_id) != undefined) {
                        title = g_titles.get(link_id);
                    }
                }
                else {
                    if (whole_match.search(/\(\s*\)$/m) > -1) {
                        // Special case for explicit empty url
                        url = "";
                    } else {
                        return whole_match;
                    }
                }
            }
            url = encodeProblemUrlChars(url);
            url = escapeCharacters(url, "*_");
            var result = "<a href=\"" + url + "\"";

            if (title != "") {
                title = attributeEncode(title);
                title = escapeCharacters(title, "*_");
                result += " title=\"" + title + "\"";
            }

            result += ">" + link_text + "</a>";

            return result;
        }

        function _DoImages(text) {
            //
            // Turn Markdown image shortcuts into <img> tags.
            //

            //
            // First, handle reference-style labeled images: ![alt text][id]
            //

            /*
            text = text.replace(/
                (                   // wrap whole match in $1
                    !\[
                    (.*?)           // alt text = $2
                    \]

                    [ ]?            // one optional space
                    (?:\n[ ]*)?     // one optional newline followed by spaces

                    \[
                    (.*?)           // id = $3
                    \]
                )
                ()()()()            // pad rest of backreferences
            /g, writeImageTag);
            */
            text = text.replace(/(!\[(.*?)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g, writeImageTag);

            //
            // Next, handle inline images:  ![alt text](url "optional title")
            // Don't forget: encode * and _

            /*
            text = text.replace(/
                (                   // wrap whole match in $1
                    !\[
                    (.*?)           // alt text = $2
                    \]
                    \s?             // One optional whitespace character
                    \(              // literal paren
                    [ \t]*
                    ()              // no id, so leave $3 empty
                    <?(\S+?)>?      // src url = $4
                    [ \t]*
                    (               // $5
                        (['"])      // quote char = $6
                        (.*?)       // title = $7
                        \6          // matching quote
                        [ \t]*
                    )?              // title is optional
                    \)
                )
            /g, writeImageTag);
            */
            text = text.replace(/(!\[(.*?)\]\s?\([ \t]*()<?(\S+?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g, writeImageTag);

            return text;
        }
        
        function attributeEncode(text) {
            // unconditionally replace angle brackets here -- what ends up in an attribute (e.g. alt or title)
            // never makes sense to have verbatim HTML in it (and the sanitizer would totally break it)
            return text.replace(/>/g, "&gt;").replace(/</g, "&lt;").replace(/"/g, "&quot;");
        }

        function writeImageTag(wholeMatch, m1, m2, m3, m4, m5, m6, m7) {
            var whole_match = m1;
            var alt_text = m2;
            var link_id = m3.toLowerCase();
            var url = m4;
            var title = m7;

            if (!title) title = "";

            if (url == "") {
                if (link_id == "") {
                    // lower-case and turn embedded newlines into spaces
                    link_id = alt_text.toLowerCase().replace(/ ?\n/g, " ");
                }
                url = "#" + link_id;

                if (g_urls.get(link_id) != undefined) {
                    url = g_urls.get(link_id);
                    if (g_titles.get(link_id) != undefined) {
                        title = g_titles.get(link_id);
                    }
                }
                else {
                    return whole_match;
                }
            }
            
            alt_text = escapeCharacters(attributeEncode(alt_text), "*_[]()");
            url = escapeCharacters(url, "*_");
            var result = "<img src=\"" + url + "\" alt=\"" + alt_text + "\"";

            // attacklab: Markdown.pl adds empty title attributes to images.
            // Replicate this bug.

            //if (title != "") {
            title = attributeEncode(title);
            title = escapeCharacters(title, "*_");
            result += " title=\"" + title + "\"";
            //}

            result += " />";

            return result;
        }

        function _DoHeaders(text) {

            // Setext-style headers:
            //  Header 1
            //  ========
            //  
            //  Header 2
            //  --------
            //
            text = text.replace(/^(.+)[ \t]*\n=+[ \t]*\n+/gm,
                function (wholeMatch, m1) { return "<h1>" + _RunSpanGamut(m1) + "</h1>\n\n"; }
            );

            text = text.replace(/^(.+)[ \t]*\n-+[ \t]*\n+/gm,
                function (matchFound, m1) { return "<h2>" + _RunSpanGamut(m1) + "</h2>\n\n"; }
            );

            // atx-style headers:
            //  # Header 1
            //  ## Header 2
            //  ## Header 2 with closing hashes ##
            //  ...
            //  ###### Header 6
            //

            /*
            text = text.replace(/
                ^(\#{1,6})      // $1 = string of #'s
                [ \t]*
                (.+?)           // $2 = Header text
                [ \t]*
                \#*             // optional closing #'s (not counted)
                \n+
            /gm, function() {...});
            */

            text = text.replace(/^(\#{1,6})[ \t]*(.+?)[ \t]*\#*\n+/gm,
                function (wholeMatch, m1, m2) {
                    var h_level = m1.length;
                    return "<h" + h_level + ">" + _RunSpanGamut(m2) + "</h" + h_level + ">\n\n";
                }
            );

            return text;
        }

        function _DoLists(text, isInsideParagraphlessListItem) {
            //
            // Form HTML ordered (numbered) and unordered (bulleted) lists.
            //

            // attacklab: add sentinel to hack around khtml/safari bug:
            // http://bugs.webkit.org/show_bug.cgi?id=11231
            text += "~0";

            // Re-usable pattern to match any entirel ul or ol list:

            /*
            var whole_list = /
                (                                   // $1 = whole list
                    (                               // $2
                        [ ]{0,3}                    // attacklab: g_tab_width - 1
                        ([*+-]|\d+[.])              // $3 = first list item marker
                        [ \t]+
                    )
                    [^\r]+?
                    (                               // $4
                        ~0                          // sentinel for workaround; should be $
                        |
                        \n{2,}
                        (?=\S)
                        (?!                         // Negative lookahead for another list item marker
                            [ \t]*
                            (?:[*+-]|\d+[.])[ \t]+
                        )
                    )
                )
            /g
            */
            var whole_list = /^(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm;

            if (g_list_level) {
                text = text.replace(whole_list, function (wholeMatch, m1, m2) {
                    var list = m1;
                    var list_type = (m2.search(/[*+-]/g) > -1) ? "ul" : "ol";

                    var result = _ProcessListItems(list, list_type, isInsideParagraphlessListItem);

                    // Trim any trailing whitespace, to put the closing `</$list_type>`
                    // up on the preceding line, to get it past the current stupid
                    // HTML block parser. This is a hack to work around the terrible
                    // hack that is the HTML block parser.
                    result = result.replace(/\s+$/, "");
                    result = "<" + list_type + ">" + result + "</" + list_type + ">\n";
                    return result;
                });
            } else {
                whole_list = /(\n\n|^\n?)(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/g;
                text = text.replace(whole_list, function (wholeMatch, m1, m2, m3) {
                    var runup = m1;
                    var list = m2;

                    var list_type = (m3.search(/[*+-]/g) > -1) ? "ul" : "ol";
                    var result = _ProcessListItems(list, list_type);
                    result = runup + "<" + list_type + ">\n" + result + "</" + list_type + ">\n";
                    return result;
                });
            }

            // attacklab: strip sentinel
            text = text.replace(/~0/, "");

            return text;
        }

        var _listItemMarkers = { ol: "\\d+[.]", ul: "[*+-]" };

        function _ProcessListItems(list_str, list_type, isInsideParagraphlessListItem) {
            //
            //  Process the contents of a single ordered or unordered list, splitting it
            //  into individual list items.
            //
            //  list_type is either "ul" or "ol".

            // The $g_list_level global keeps track of when we're inside a list.
            // Each time we enter a list, we increment it; when we leave a list,
            // we decrement. If it's zero, we're not in a list anymore.
            //
            // We do this because when we're not inside a list, we want to treat
            // something like this:
            //
            //    I recommend upgrading to version
            //    8. Oops, now this line is treated
            //    as a sub-list.
            //
            // As a single paragraph, despite the fact that the second line starts
            // with a digit-period-space sequence.
            //
            // Whereas when we're inside a list (or sub-list), that line will be
            // treated as the start of a sub-list. What a kludge, huh? This is
            // an aspect of Markdown's syntax that's hard to parse perfectly
            // without resorting to mind-reading. Perhaps the solution is to
            // change the syntax rules such that sub-lists must start with a
            // starting cardinal number; e.g. "1." or "a.".

            g_list_level++;

            // trim trailing blank lines:
            list_str = list_str.replace(/\n{2,}$/, "\n");

            // attacklab: add sentinel to emulate \z
            list_str += "~0";

            // In the original attacklab showdown, list_type was not given to this function, and anything
            // that matched /[*+-]|\d+[.]/ would just create the next <li>, causing this mismatch:
            //
            //  Markdown          rendered by WMD        rendered by MarkdownSharp
            //  ------------------------------------------------------------------
            //  1. first          1. first               1. first
            //  2. second         2. second              2. second
            //  - third           3. third                   * third
            //
            // We changed this to behave identical to MarkdownSharp. This is the constructed RegEx,
            // with {MARKER} being one of \d+[.] or [*+-], depending on list_type:
        
            /*
            list_str = list_str.replace(/
                (^[ \t]*)                       // leading whitespace = $1
                ({MARKER}) [ \t]+               // list marker = $2
                ([^\r]+?                        // list item text   = $3
                    (\n+)
                )
                (?=
                    (~0 | \2 ({MARKER}) [ \t]+)
                )
            /gm, function(){...});
            */

            var marker = _listItemMarkers[list_type];
            var re = new RegExp("(^[ \\t]*)(" + marker + ")[ \\t]+([^\\r]+?(\\n+))(?=(~0|\\1(" + marker + ")[ \\t]+))", "gm");
            var last_item_had_a_double_newline = false;
            list_str = list_str.replace(re,
                function (wholeMatch, m1, m2, m3) {
                    var item = m3;
                    var leading_space = m1;
                    var ends_with_double_newline = /\n\n$/.test(item);
                    var contains_double_newline = ends_with_double_newline || item.search(/\n{2,}/) > -1;

                    if (contains_double_newline || last_item_had_a_double_newline) {
                        item = _RunBlockGamut(_Outdent(item), /* doNotUnhash = */true);
                    }
                    else {
                        // Recursion for sub-lists:
                        item = _DoLists(_Outdent(item), /* isInsideParagraphlessListItem= */ true);
                        item = item.replace(/\n$/, ""); // chomp(item)
                        if (!isInsideParagraphlessListItem) // only the outer-most item should run this, otherwise it's run multiple times for the inner ones
                            item = _RunSpanGamut(item);
                    }
                    last_item_had_a_double_newline = ends_with_double_newline;
                    return "<li>" + item + "</li>\n";
                }
            );

            // attacklab: strip sentinel
            list_str = list_str.replace(/~0/g, "");

            g_list_level--;
            return list_str;
        }

        function _DoCodeBlocks(text) {
            //
            //  Process Markdown `<pre><code>` blocks.
            //  

            /*
            text = text.replace(/
                (?:\n\n|^)
                (                               // $1 = the code block -- one or more lines, starting with a space/tab
                    (?:
                        (?:[ ]{4}|\t)           // Lines must start with a tab or a tab-width of spaces - attacklab: g_tab_width
                        .*\n+
                    )+
                )
                (\n*[ ]{0,3}[^ \t\n]|(?=~0))    // attacklab: g_tab_width
            /g ,function(){...});
            */

            // attacklab: sentinel workarounds for lack of \A and \Z, safari\khtml bug
            text += "~0";

            text = text.replace(/(?:\n\n|^\n?)((?:(?:[ ]{4}|\t).*\n+)+)(\n*[ ]{0,3}[^ \t\n]|(?=~0))/g,
                function (wholeMatch, m1, m2) {
                    var codeblock = m1;
                    var nextChar = m2;

                    codeblock = _EncodeCode(_Outdent(codeblock));
                    codeblock = _Detab(codeblock);
                    codeblock = codeblock.replace(/^\n+/g, ""); // trim leading newlines
                    codeblock = codeblock.replace(/\n+$/g, ""); // trim trailing whitespace

                    codeblock = "<pre><code>" + codeblock + "\n</code></pre>";

                    return "\n\n" + codeblock + "\n\n" + nextChar;
                }
            );

            // attacklab: strip sentinel
            text = text.replace(/~0/, "");

            return text;
        }

        function hashBlock(text) {
            text = text.replace(/(^\n+|\n+$)/g, "");
            return "\n\n~K" + (g_html_blocks.push(text) - 1) + "K\n\n";
        }

        function _DoCodeSpans(text) {
            //
            // * Backtick quotes are used for <code></code> spans.
            // 
            // * You can use multiple backticks as the delimiters if you want to
            //   include literal backticks in the code span. So, this input:
            //     
            //      Just type ``foo `bar` baz`` at the prompt.
            //     
            //   Will translate to:
            //     
            //      <p>Just type <code>foo `bar` baz</code> at the prompt.</p>
            //     
            //   There's no arbitrary limit to the number of backticks you
            //   can use as delimters. If you need three consecutive backticks
            //   in your code, use four for delimiters, etc.
            //
            // * You can use spaces to get literal backticks at the edges:
            //     
            //      ... type `` `bar` `` ...
            //     
            //   Turns to:
            //     
            //      ... type <code>`bar`</code> ...
            //

            /*
            text = text.replace(/
                (^|[^\\])       // Character before opening ` can't be a backslash
                (`+)            // $2 = Opening run of `
                (               // $3 = The code block
                    [^\r]*?
                    [^`]        // attacklab: work around lack of lookbehind
                )
                \2              // Matching closer
                (?!`)
            /gm, function(){...});
            */

            text = text.replace(/(^|[^\\])(`+)([^\r]*?[^`])\2(?!`)/gm,
                function (wholeMatch, m1, m2, m3, m4) {
                    var c = m3;
                    c = c.replace(/^([ \t]*)/g, ""); // leading whitespace
                    c = c.replace(/[ \t]*$/g, ""); // trailing whitespace
                    c = _EncodeCode(c);
                    c = c.replace(/:\/\//g, "~P"); // to prevent auto-linking. Not necessary in code *blocks*, but in code spans. Will be converted back after the auto-linker runs.
                    return m1 + "<code>" + c + "</code>";
                }
            );

            return text;
        }

        function _EncodeCode(text) {
            //
            // Encode/escape certain characters inside Markdown code runs.
            // The point is that in code, these characters are literals,
            // and lose their special Markdown meanings.
            //
            // Encode all ampersands; HTML entities are not
            // entities within a Markdown code span.
            text = text.replace(/&/g, "&amp;");

            // Do the angle bracket song and dance:
            text = text.replace(/</g, "&lt;");
            text = text.replace(/>/g, "&gt;");

            // Now, escape characters that are magic in Markdown:
            text = escapeCharacters(text, "\*_{}[]\\", false);

            // jj the line above breaks this:
            //---

            //* Item

            //   1. Subitem

            //            special char: *
            //---

            return text;
        }

        function _DoItalicsAndBold(text) {

            // <strong> must go first:
            text = text.replace(/([\W_]|^)(\*\*|__)(?=\S)([^\r]*?\S[\*_]*)\2([\W_]|$)/g,
            "$1<strong>$3</strong>$4");

            text = text.replace(/([\W_]|^)(\*|_)(?=\S)([^\r\*_]*?\S)\2([\W_]|$)/g,
            "$1<em>$3</em>$4");

            return text;
        }

        function _DoBlockQuotes(text) {

            /*
            text = text.replace(/
                (                           // Wrap whole match in $1
                    (
                        ^[ \t]*>[ \t]?      // '>' at the start of a line
                        .+\n                // rest of the first line
                        (.+\n)*             // subsequent consecutive lines
                        \n*                 // blanks
                    )+
                )
            /gm, function(){...});
            */

            text = text.replace(/((^[ \t]*>[ \t]?.+\n(.+\n)*\n*)+)/gm,
                function (wholeMatch, m1) {
                    var bq = m1;

                    // attacklab: hack around Konqueror 3.5.4 bug:
                    // "----------bug".replace(/^-/g,"") == "bug"

                    bq = bq.replace(/^[ \t]*>[ \t]?/gm, "~0"); // trim one level of quoting

                    // attacklab: clean up hack
                    bq = bq.replace(/~0/g, "");

                    bq = bq.replace(/^[ \t]+$/gm, "");     // trim whitespace-only lines
                    bq = _RunBlockGamut(bq);             // recurse

                    bq = bq.replace(/(^|\n)/g, "$1  ");
                    // These leading spaces screw with <pre> content, so we need to fix that:
                    bq = bq.replace(
                            /(\s*<pre>[^\r]+?<\/pre>)/gm,
                        function (wholeMatch, m1) {
                            var pre = m1;
                            // attacklab: hack around Konqueror 3.5.4 bug:
                            pre = pre.replace(/^  /mg, "~0");
                            pre = pre.replace(/~0/g, "");
                            return pre;
                        });

                    return hashBlock("<blockquote>\n" + bq + "\n</blockquote>");
                }
            );
            return text;
        }

        function _FormParagraphs(text, doNotUnhash) {
            //
            //  Params:
            //    $text - string to process with html <p> tags
            //

            // Strip leading and trailing lines:
            text = text.replace(/^\n+/g, "");
            text = text.replace(/\n+$/g, "");

            var grafs = text.split(/\n{2,}/g);
            var grafsOut = [];
            
            var markerRe = /~K(\d+)K/;

            //
            // Wrap <p> tags.
            //
            var end = grafs.length;
            for (var i = 0; i < end; i++) {
                var str = grafs[i];

                // if this is an HTML marker, copy it
                if (markerRe.test(str)) {
                    grafsOut.push(str);
                }
                else if (/\S/.test(str)) {
                    str = _RunSpanGamut(str);
                    str = str.replace(/^([ \t]*)/g, "<p>");
                    str += "</p>"
                    grafsOut.push(str);
                }

            }
            //
            // Unhashify HTML blocks
            //
            if (!doNotUnhash) {
                end = grafsOut.length;
                for (var i = 0; i < end; i++) {
                    var foundAny = true;
                    while (foundAny) { // we may need several runs, since the data may be nested
                        foundAny = false;
                        grafsOut[i] = grafsOut[i].replace(/~K(\d+)K/g, function (wholeMatch, id) {
                            foundAny = true;
                            return g_html_blocks[id];
                        });
                    }
                }
            }
            return grafsOut.join("\n\n");
        }

        function _EncodeAmpsAndAngles(text) {
            // Smart processing for ampersands and angle brackets that need to be encoded.

            // Ampersand-encoding based entirely on Nat Irons's Amputator MT plugin:
            //   http://bumppo.net/projects/amputator/
            text = text.replace(/&(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/g, "&amp;");

            // Encode naked <'s
            text = text.replace(/<(?![a-z\/?!]|~D)/gi, "&lt;");

            return text;
        }

        function _EncodeBackslashEscapes(text) {
            //
            //   Parameter:  String.
            //   Returns:    The string, with after processing the following backslash
            //               escape sequences.
            //

            // attacklab: The polite way to do this is with the new
            // escapeCharacters() function:
            //
            //     text = escapeCharacters(text,"\\",true);
            //     text = escapeCharacters(text,"`*_{}[]()>#+-.!",true);
            //
            // ...but we're sidestepping its use of the (slow) RegExp constructor
            // as an optimization for Firefox.  This function gets called a LOT.

            text = text.replace(/\\(\\)/g, escapeCharacters_callback);
            text = text.replace(/\\([`*_{}\[\]()>#+-.!])/g, escapeCharacters_callback);
            return text;
        }

        var charInsideUrl = "[-A-Z0-9+&@#/%?=~_|[\\]()!:,.;]",
            charEndingUrl = "[-A-Z0-9+&@#/%=~_|[\\])]",
            autoLinkRegex = new RegExp("(=\"|<)?\\b(https?|ftp)(://" + charInsideUrl + "*" + charEndingUrl + ")(?=$|\\W)", "gi"),
            endCharRegex = new RegExp(charEndingUrl, "i");

        function handleTrailingParens(wholeMatch, lookbehind, protocol, link) {
            if (lookbehind)
                return wholeMatch;
            if (link.charAt(link.length - 1) !== ")")
                return "<" + protocol + link + ">";
            var parens = link.match(/[()]/g);
            var level = 0;
            for (var i = 0; i < parens.length; i++) {
                if (parens[i] === "(") {
                    if (level <= 0)
                        level = 1;
                    else
                        level++;
                }
                else {
                    level--;
                }
            }
            var tail = "";
            if (level < 0) {
                var re = new RegExp("\\){1," + (-level) + "}$");
                link = link.replace(re, function (trailingParens) {
                    tail = trailingParens;
                    return "";
                });
            }
            if (tail) {
                var lastChar = link.charAt(link.length - 1);
                if (!endCharRegex.test(lastChar)) {
                    tail = lastChar + tail;
                    link = link.substr(0, link.length - 1);
                }
            }
            return "<" + protocol + link + ">" + tail;
        }
        
        function _DoAutoLinks(text) {

            // note that at this point, all other URL in the text are already hyperlinked as <a href=""></a>
            // *except* for the <http://www.foo.com> case

            // automatically add < and > around unadorned raw hyperlinks
            // must be preceded by a non-word character (and not by =" or <) and followed by non-word/EOF character
            // simulating the lookbehind in a consuming way is okay here, since a URL can neither and with a " nor
            // with a <, so there is no risk of overlapping matches.
            text = text.replace(autoLinkRegex, handleTrailingParens);

            //  autolink anything like <http://example.com>
            
            var replacer = function (wholematch, m1) { return "<a href=\"" + m1 + "\">" + pluginHooks.plainLinkText(m1) + "</a>"; }
            text = text.replace(/<((https?|ftp):[^'">\s]+)>/gi, replacer);

            // Email addresses: <address@domain.foo>
            /*
            text = text.replace(/
                <
                (?:mailto:)?
                (
                    [-.\w]+
                    \@
                    [-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+
                )
                >
            /gi, _DoAutoLinks_callback());
            */

            /* disabling email autolinking, since we don't do that on the server, either
            text = text.replace(/<(?:mailto:)?([-.\w]+\@[-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+)>/gi,
                function(wholeMatch,m1) {
                    return _EncodeEmailAddress( _UnescapeSpecialChars(m1) );
                }
            );
            */
            return text;
        }

        function _UnescapeSpecialChars(text) {
            //
            // Swap back in all the special characters we've hidden.
            //
            text = text.replace(/~E(\d+)E/g,
                function (wholeMatch, m1) {
                    var charCodeToReplace = parseInt(m1);
                    return String.fromCharCode(charCodeToReplace);
                }
            );
            return text;
        }

        function _Outdent(text) {
            //
            // Remove one level of line-leading tabs or spaces
            //

            // attacklab: hack around Konqueror 3.5.4 bug:
            // "----------bug".replace(/^-/g,"") == "bug"

            text = text.replace(/^(\t|[ ]{1,4})/gm, "~0"); // attacklab: g_tab_width

            // attacklab: clean up hack
            text = text.replace(/~0/g, "")

            return text;
        }

        function _Detab(text) {
            if (!/\t/.test(text))
                return text;

            var spaces = ["    ", "   ", "  ", " "],
            skew = 0,
            v;

            return text.replace(/[\n\t]/g, function (match, offset) {
                if (match === "\n") {
                    skew = offset + 1;
                    return match;
                }
                v = (offset - skew) % 4;
                skew = offset + 1;
                return spaces[v];
            });
        }

        //
        //  attacklab: Utility functions
        //

        var _problemUrlChars = /(?:["'*()[\]:]|~D)/g;

        // hex-encodes some unusual "problem" chars in URLs to avoid URL detection problems 
        function encodeProblemUrlChars(url) {
            if (!url)
                return "";

            var len = url.length;

            return url.replace(_problemUrlChars, function (match, offset) {
                if (match == "~D") // escape for dollar
                    return "%24";
                if (match == ":") {
                    if (offset == len - 1 || /[0-9\/]/.test(url.charAt(offset + 1)))
                        return ":"
                }
                return "%" + match.charCodeAt(0).toString(16);
            });
        }


        function escapeCharacters(text, charsToEscape, afterBackslash) {
            // First we have to escape the escape characters so that
            // we can build a character class out of them
            var regexString = "([" + charsToEscape.replace(/([\[\]\\])/g, "\\$1") + "])";

            if (afterBackslash) {
                regexString = "\\\\" + regexString;
            }

            var regex = new RegExp(regexString, "g");
            text = text.replace(regex, escapeCharacters_callback);

            return text;
        }


        function escapeCharacters_callback(wholeMatch, m1) {
            var charCodeToEscape = m1.charCodeAt(0);
            return "~E" + charCodeToEscape + "E";
        }

    }; // end of the Markdown.Converter constructor

})();

(function () {
    var output, Converter;
    if (typeof exports === "object" && typeof require === "function") { // we're in a CommonJS (e.g. Node.js) module
        output = exports;
        Converter = require("./Markdown.Converter").Converter;
    } else {
        output = window.Markdown;
        Converter = output.Converter;
    }
        
    output.getSanitizingConverter = function () {
        var converter = new Converter();
        converter.hooks.chain("postConversion", sanitizeHtml);
        converter.hooks.chain("postConversion", balanceTags);
        return converter;
    }

    function sanitizeHtml(html) {
        return html.replace(/<[^>]*>?/gi, sanitizeTag);
    }

    // (tags that can be opened/closed) | (tags that stand alone)
    var basic_tag_whitelist = /^(<\/?(b|blockquote|code|del|dd|dl|dt|em|h1|h2|h3|i|kbd|li|ol|p|pre|s|sup|sub|strong|strike|ul)>|<(br|hr)\s?\/?>)$/i;
    // <a href="url..." optional title>|</a>
    var a_white = /^(<a\shref="((https?|ftp):\/\/|\/)[-A-Za-z0-9+&@#\/%?=~_|!:,.;\(\)]+"(\stitle="[^"<>]+")?\s?>|<\/a>)$/i;

    // <img src="url..." optional width  optional height  optional alt  optional title
    var img_white = /^(<img\ssrc="(https?:\/\/|\/)[-A-Za-z0-9+&@#\/%?=~_|!:,.;\(\)]+"(\swidth="\d{1,3}")?(\sheight="\d{1,3}")?(\salt="[^"<>]*")?(\stitle="[^"<>]*")?\s?\/?>)$/i;

    function sanitizeTag(tag) {
        if (tag.match(basic_tag_whitelist) || tag.match(a_white) || tag.match(img_white))
            return tag;
        else
            return "";
    }

    /// <summary>
    /// attempt to balance HTML tags in the html string
    /// by removing any unmatched opening or closing tags
    /// IMPORTANT: we *assume* HTML has *already* been 
    /// sanitized and is safe/sane before balancing!
    /// 
    /// adapted from CODESNIPPET: A8591DBA-D1D3-11DE-947C-BA5556D89593
    /// </summary>
    function balanceTags(html) {

        if (html == "")
            return "";

        var re = /<\/?\w+[^>]*(\s|$|>)/g;
        // convert everything to lower case; this makes
        // our case insensitive comparisons easier
        var tags = html.toLowerCase().match(re);

        // no HTML tags present? nothing to do; exit now
        var tagcount = (tags || []).length;
        if (tagcount == 0)
            return html;

        var tagname, tag;
        var ignoredtags = "<p><img><br><li><hr>";
        var match;
        var tagpaired = [];
        var tagremove = [];
        var needsRemoval = false;

        // loop through matched tags in forward order
        for (var ctag = 0; ctag < tagcount; ctag++) {
            tagname = tags[ctag].replace(/<\/?(\w+).*/, "$1");
            // skip any already paired tags
            // and skip tags in our ignore list; assume they're self-closed
            if (tagpaired[ctag] || ignoredtags.search("<" + tagname + ">") > -1)
                continue;

            tag = tags[ctag];
            match = -1;

            if (!/^<\//.test(tag)) {
                // this is an opening tag
                // search forwards (next tags), look for closing tags
                for (var ntag = ctag + 1; ntag < tagcount; ntag++) {
                    if (!tagpaired[ntag] && tags[ntag] == "</" + tagname + ">") {
                        match = ntag;
                        break;
                    }
                }
            }

            if (match == -1)
                needsRemoval = tagremove[ctag] = true; // mark for removal
            else
                tagpaired[match] = true; // mark paired
        }

        if (!needsRemoval)
            return html;

        // delete all orphaned tags from the string

        var ctag = 0;
        html = html.replace(re, function (match) {
            var res = tagremove[ctag] ? "" : match;
            ctag++;
            return res;
        });
        return html;
    }
})();

// Askbot adapter to markdown converter;
var getAskbotMarkdownConverter = function() {
    askbot['controllers'] = askbot['controllers'] || {};
    var converter = askbot['controllers']['markdownConverter'];
    if (!converter) {
        converter = new AskbotMarkdownConverter();
        askbot['controllers']['markdownConverter'] = converter;
    }
    return converter;
};

var AskbotMarkdownConverter = function() {
    this._converter = new Markdown.getSanitizingConverter();
    this._timeout = null;
};

AskbotMarkdownConverter.prototype.scheduleMathJaxRendering = function () {
    if (this._timeout) {
        clearTimeout(this._timeout);
    }
    var renderFunc = function () {
        MathJax.Hub.Queue(['Typeset', MathJax.Hub, 'previewer']);
    };
    this._timeout = setTimeout(renderFunc, 500);
};

AskbotMarkdownConverter.prototype.makeHtml = function (text) {
    var makeHtmlBase = this._converter.makeHtml;
    if (askbot['settings']['mathjaxEnabled'] === false){
        return makeHtmlBase(text);
    } else if (typeof MathJax != 'undefined') {
        MathJax.Hub.queue.Push(
            function(){
                $('#previewer').html(makeHtmlBase(text));
            }
        );
        this.scheduleMathJaxRendering();
        return $('#previewer').html();
    } else {
        console.log('Could not load MathJax');
        return makeHtmlBase(text);
    }
};

var Attacklab = Attacklab || {};

Attacklab.wmdBase = function(){

	// A few handy aliases for readability.
	var wmd  = self.Attacklab;
	var doc  = self.document;
	var re   = self.RegExp;
	var nav  = self.navigator;

	// Some namespaces.
	wmd.Util = {};
	wmd.Position = {};
	wmd.Command = {};
	wmd.Global = {};

	var util = wmd.Util;
	var position = wmd.Position;
	var command = wmd.Command;
	var global = wmd.Global;


	// Used to work around some browser bugs where we can't use feature testing.
    global.isChrome = /chrome/.test(nav.userAgent.toLowerCase());
	global.isIE = /msie/.test(nav.userAgent.toLowerCase());
	global.isIE_5or6 = /msie 6/.test(nav.userAgent.toLowerCase()) || /msie 5/.test(nav.userAgent.toLowerCase());
	global.isIE_7plus = global.isIE && !global.isIE_5or6;
	global.isOpera = /opera/.test(nav.userAgent.toLowerCase());
	global.isKonqueror = /konqueror/.test(nav.userAgent.toLowerCase());

	var toolbar_strong_label = gettext('bold') + " <strong> Ctrl-B";
    var toolbar_emphasis_label = gettext('italic') + " <em> Ctrl-I";
    var toolbar_hyperlink_label = gettext('link') + " <a> Ctrl-L";
    var toolbar_blockquote_label = gettext('quote') + " <blockquote> Ctrl-.";
    var toolbar_code_label = gettext('preformatted text') + " <pre><code> Ctrl-K";
    var toolbar_image_label = gettext('image') + " <img> Ctrl-G";
    var toolbar_attachment_label = gettext('attachment') + " Ctrl-F";
    var toolbar_numbered_label = gettext('numbered list') + " <ol> Ctrl-O";
    var toolbar_bulleted_label = gettext('bulleted list') + " <ul> Ctrl-U";
    var toolbar_heading_label = gettext('heading') + " <h1>/<h2> Ctrl-H";
    var toolbar_horizontal_label = gettext('horizontal bar') + " <hr> Ctrl-R";
    var toolbar_undo_label = gettext('undo') + " Ctrl-Z";
    var toolbar_redo_label = gettext('redo') + " Ctrl-Y";

	// -------------------------------------------------------------------
	//  YOUR CHANGES GO HERE
	//
	// I've tried to localize the things you are likely to change to
	// this area.
	// -------------------------------------------------------------------

	// The text that appears on the upper part of the dialog box when
	// entering links.
	var imageDialogText = "<p style='margin-top: 0px'>" + gettext('enter image url') + '</p>';
	var linkDialogText = "<p style='margin-top: 0px'>" + gettext('enter url') + '</p>';
    var fileDialogText = "<p>" + gettext('upload file attachment') + '</p>';
	// The default text that appears in the dialog input box when entering
	// links.
	var imageDefaultText = "http://";
	var linkDefaultText = "http://";

	// The location of your button images relative to the base directory.
	var imageDirectory = "images/";

	// Some intervals in ms.  These can be adjusted to reduce the control's load.
	var previewPollInterval = 500;
	var pastePollInterval = 100;

	// The link and title for the help button
	var helpLink = "http://wmd-editor.com/";
	var helpHoverTitle = "WMD website";
	var helpTarget = "_blank";
    var localUploadFileName = null;

	// -------------------------------------------------------------------
	//  END OF YOUR CHANGES
	// -------------------------------------------------------------------

	// A collection of the important regions on the page.
	// Cached so we don't have to keep traversing the DOM.
	wmd.PanelCollection = function(){
		this.buttonBar = doc.getElementById(util.makeId("wmd-button-bar"));
		this.preview = doc.getElementById(util.makeId("previewer"));
		this.output = doc.getElementById(util.makeId("wmd-output"));
		this.input = doc.getElementById(util.makeId("editor"));
	};

	// This PanelCollection object can't be filled until after the page
	// has loaded.
	wmd.panels = undefined;

	// Internet explorer has problems with CSS sprite buttons that use HTML
	// lists.  When you click on the background image "button", IE will
	// select the non-existent link text and discard the selection in the
	// textarea.  The solution to this is to cache the textarea selection
	// on the button's mousedown event and set a flag.  In the part of the
	// code where we need to grab the selection, we check for the flag
	// and, if it's set, use the cached area instead of querying the
	// textarea.
	//
	// This ONLY affects Internet Explorer (tested on versions 6, 7
	// and 8) and ONLY on button clicks.  Keyboard shortcuts work
	// normally since the focus never leaves the textarea.
	wmd.ieCachedRange = null;		// cached textarea selection
	wmd.ieRetardedClick = false;	// flag

	// Returns true if the DOM element is visible, false if it's hidden.
	// Checks if display is anything other than none.
	util.isVisible = function (elem) {

	    if (window.getComputedStyle) {
	        // Most browsers
			return window.getComputedStyle(elem, null).getPropertyValue("display") !== "none";
		}
		else if (elem.currentStyle) {
		    // IE
			return elem.currentStyle.display !== "none";
		}
	};


	// Adds a listener callback to a DOM element which is fired on a specified
	// event.
	util.addEvent = function(elem, event, listener){
		if (elem) {
            if (elem.attachEvent) {
                // IE only.  The "on" is mandatory.
                elem.attachEvent("on" + event, listener);
            } else {
                // Other browsers.
                elem.addEventListener(event, listener, false);
            }
        }
	};


	// Removes a listener callback from a DOM element which is fired on a specified
	// event.
	util.removeEvent = function(elem, event, listener){
		if (elem.detachEvent) {
			// IE only.  The "on" is mandatory.
			elem.detachEvent("on" + event, listener);
		}
		else {
			// Other browsers.
			elem.removeEventListener(event, listener, false);
		}
	};

	// Converts \r\n and \r to \n.
	util.fixEolChars = function(text){
		text = text.replace(/\r\n/g, "\n");
		text = text.replace(/\r/g, "\n");
		return text;
	};

	// Extends a regular expression.  Returns a new RegExp
	// using pre + regex + post as the expression.
	// Used in a few functions where we have a base
	// expression and we want to pre- or append some
	// conditions to it (e.g. adding "$" to the end).
	// The flags are unchanged.
	//
	// regex is a RegExp, pre and post are strings.
	util.extendRegExp = function(regex, pre, post){

		if (pre === null || pre === undefined)
		{
			pre = "";
		}
		if(post === null || post === undefined)
		{
			post = "";
		}

		var pattern = regex.toString();
		var flags;

		// Replace the flags with empty space and store them.
		pattern = pattern.replace(/\/([gim]*)$/, "");
		flags = re.$1;

		// Remove the slash delimiters on the regular expression.
		pattern = pattern.replace(/(^\/|\/$)/g, "");
		pattern = pre + pattern + post;

		return new re(pattern, flags);
	};


	// Sets the image for a button passed to the WMD editor.
	// Returns a new element with the image attached.
	// Adds several style properties to the image.
	util.createImage = function(img){

		var imgPath = imageDirectory + img;

		var elem = doc.createElement("img");
		elem.className = "wmd-button wmd-image-button";
		elem.src = imgPath;

		return elem;
	};


// This simulates a modal dialog box and asks for the URL when you
// click the hyperlink or image buttons.
//
// text: The html for the input box.
// defaultInputText: The default value that appears in the input box.
// makeLinkMarkdown: The function which is executed when the prompt is dismissed, either via OK or Cancel
util.prompt = function(text, defaultInputText, makeLinkMarkdown, dialogType){

    // These variables need to be declared at this level since they are used
    // in multiple functions.
    var dialog;// The dialog box.
    var background;// The background beind the dialog box.
    var input;// The text box where you enter the hyperlink.

    if (defaultInputText === undefined) {
        defaultInputText = "";
    }

    // Used as a keydown event handler. Esc dismisses the prompt.
    // Key code 27 is ESC.
    var checkEscape = function(key){
        var code = (key.charCode || key.keyCode);
        if (code === 27) {
            close(true);
        }
    };

    // Dismisses the hyperlink input box.
    // isCancel is true if we don't care about the input text.
    // isCancel is false if we are going to keep the text.
    var close = function(isCancel){
        util.removeEvent(doc.body, "keydown", checkEscape);
        var text = input.value;

        if (isCancel){
            text = null;
        }
        else{
            // Fixes common pasting errors.
            text = text.replace('http://http://', 'http://');
            text = text.replace('http://https://', 'https://');
            text = text.replace('http://ftp://', 'ftp://');

            if (text.indexOf('http://') === -1 && text.indexOf('ftp://') === -1 && text.indexOf('https://') === -1) {
                if (dialogType == 'link'){
                    //add http only to urls
                    text = 'http://' + text;
                }
            }
        }

        dialog.parentNode.removeChild(dialog);
        background.parentNode.removeChild(background);
        makeLinkMarkdown(text);
        return false;
    };

    // Creates the background behind the hyperlink text entry box.
    // Most of this has been moved to CSS but the div creation and
    // browser-specific hacks remain here.
    var createBackground = function(){

        background = doc.createElement("div");
        background.className = "wmd-prompt-background";
        style = background.style;
        style.position = "absolute";
        style.top = "0";

        style.zIndex = "1000";

        // Some versions of Konqueror don't support transparent colors
        // so we make the whole window transparent.
        //
        // Is this necessary on modern konqueror browsers?
        if (global.isKonqueror) {
            style.backgroundColor = "transparent";
        } else if (global.isIE) {
            style.filter = "alpha(opacity=50)";
        } else {
            style.opacity = "0.5";
        }

        var pageSize = position.getPageSize();
        style.height = pageSize[1] + "px";

        if(global.isIE) {
            style.left = doc.documentElement.scrollLeft;
            style.width = doc.documentElement.clientWidth;
        } else {
            style.left = "0";
            style.width = "100%";
        }

        doc.body.appendChild(background);
    };

    // Create the text input box form/window.
    var createDialog = function(){

        // The main dialog box.
        dialog = doc.createElement("div");
        dialog.className = "wmd-prompt-dialog";
        dialog.style.padding = "10px;";
        dialog.style.position = "fixed";
        dialog.style.width = "400px";
        dialog.style.zIndex = "1001";

        // The dialog text.
        var question = doc.createElement("div");
        question.innerHTML = text;
        question.style.padding = "5px";
        dialog.appendChild(question);

        // The web form container for the text box and buttons.
        var form = doc.createElement("form");
        form.onsubmit = function(){ return close(false); };
        style = form.style;
        style.padding = "0";
        style.margin = "0";
        style.cssFloat = "left";
        style.width = "100%";
        style.textAlign = "center";
        style.position = "relative";
        dialog.appendChild(form);

        // The input text box
        input = doc.createElement("input");
        if(dialogType == 'image' || dialogType == 'file'){
            input.id = util.makeId("image-url");
        }
        input.type = "text";
        if (dialogType == 'file'){
            input.disabled = "disabled";
        };

        input.value = defaultInputText;
        style = input.style;
        style.display = "block";
        style.width = "80%";
        style.marginLeft = style.marginRight = "auto";
        form.appendChild(input);

        //EF. fucus at the end of the input box
        //putCursorAtEnd($(input));

        // The upload file input
        if(dialogType == 'image' || dialogType == 'file'){
            var upload_container = $('<div></div>');
            var upload_input = $('<input type="file" />');
            upload_input.attr('name', 'file-upload');
            upload_input.attr('id', 'file-upload');
            upload_input.attr('size', 26);

            var spinner = $('<img />');
            spinner.attr('id', 'loading');
            spinner.attr('src', mediaUrl("media/images/indicator.gif"));
            spinner.css('display', 'none');

            var startUploadHandler = function(){
                localUploadFileName = $(this).val();//this is a local var
                /*
                 * startUploadHandler is passed into the ajaxFileUpload
                 * in order to re-install the onchange handler
                 * because the jquery extension ajaxFileUpload removes the handler
                 */
                var options = {
                    spinner: spinner,
                    uploadInputId: 'file-upload',
                    urlInput: $(input),
                    startUploadHandler: startUploadHandler
                };
                return ajaxFileUpload(options);
                //$('#image-url'), startUploadHandler);
            };

            upload_input.change(startUploadHandler);

            upload_container.append(upload_input);
            upload_container.append($('<br/>'));

            upload_container.append(spinner);

            upload_container.css('padding', '5px');
            $(form).append(upload_container);
        }

        // The ok button
        var okButton = doc.createElement("input");
        okButton.type = "button";
        okButton.onclick = function(){
            var isCancel = false;
            if ($.trim($(input).val()) === ''){
                isCancel = true;
            }
            return close(isCancel);
        };
        okButton.value = "OK";
        style = okButton.style;
        style.margin = "10px";
        style.display = "inline";
        style.width = "7em";

        // The cancel button
        var cancelButton = doc.createElement("input");
        cancelButton.type = "button";
        cancelButton.onclick = function(){ return close(true); };
        cancelButton.value = "Cancel";
        style = cancelButton.style;
        style.margin = "10px";
        style.display = "inline";
        style.width = "7em";

        // The order of these buttons is different on macs.
        if (/mac/.test(nav.platform.toLowerCase())) {
            form.appendChild(cancelButton);
            form.appendChild(okButton);
        }
        else {
            form.appendChild(okButton);
            form.appendChild(cancelButton);
        }

        util.addEvent(doc.body, "keydown", checkEscape);
        dialog.style.top = "50%";
        dialog.style.left = "50%";
        dialog.style.display = "block";
        if(global.isIE_5or6){
            dialog.style.position = "absolute";
            dialog.style.top = doc.documentElement.scrollTop + 200 + "px";
            dialog.style.left = "50%";
        }
        doc.body.appendChild(dialog);

        // This has to be done AFTER adding the dialog to the form if you
        // want it to be centered.
        dialog.style.marginTop = -(position.getHeight(dialog) / 2) + "px";
        dialog.style.marginLeft = -(position.getWidth(dialog) / 2) + "px";

        $(document).trigger('askbot.afterCreateWMDPrompt', [dialog]);
    };

    createBackground();

    // Why is this in a zero-length timeout?
    // Is it working around a browser bug?
    setTimeout(function(){
        createDialog();
        var defTextLen = defaultInputText.length;
        if (input.type == 'text' && input.selectionStart !== undefined) {
            input.selectionStart = 0;
            input.selectionEnd = defTextLen;
        } else if (input.createTextRange) {
            var range = input.createTextRange();
            range.collapse(false);
            range.moveStart("character", -defTextLen);
            range.moveEnd("character", defTextLen);
            range.select();
        }

        input.focus();
    }, 0);
};


	// UNFINISHED
	// The assignment in the while loop makes jslint cranky.
	// I'll change it to a better loop later.
	position.getTop = function(elem, isInner){
		var result = elem.offsetTop;
		if (!isInner) {
        while (elem.offsetParent) {
            elem = elem.offsetParent;
            result += elem.offsetTop;
        }
		}
		return result;
	};

	position.getHeight = function (elem) {
		return elem.offsetHeight || elem.scrollHeight;
	};

	position.getWidth = function (elem) {
		return elem.offsetWidth || elem.scrollWidth;
	};

	position.getPageSize = function(){

		var scrollWidth, scrollHeight;
		var innerWidth, innerHeight;

		// It's not very clear which blocks work with which browsers.
		if (self.innerHeight && self.scrollMaxY) {
			scrollWidth = doc.body.scrollWidth;
			scrollHeight = self.innerHeight + self.scrollMaxY;
		} else if (doc.body.scrollHeight > doc.body.offsetHeight){
			scrollWidth = doc.body.scrollWidth;
			scrollHeight = doc.body.scrollHeight;
		} else {
			scrollWidth = doc.body.offsetWidth;
			scrollHeight = doc.body.offsetHeight;
		}

		if (self.innerHeight) {
			// Non-IE browser
			innerWidth = self.innerWidth;
			innerHeight = self.innerHeight;
		} else if (doc.documentElement && doc.documentElement.clientHeight){
			// Some versions of IE (IE 6 w/ a DOCTYPE declaration)
			innerWidth = doc.documentElement.clientWidth;
			innerHeight = doc.documentElement.clientHeight;
		} else if(doc.body) {
			// Other versions of IE
			innerWidth = doc.body.clientWidth;
			innerHeight = doc.body.clientHeight;
		}

        var maxWidth = Math.max(scrollWidth, innerWidth);
        var maxHeight = Math.max(scrollHeight, innerHeight);
        return [maxWidth, maxHeight, innerWidth, innerHeight];
	};

	// Watches the input textarea, polling at an interval and runs
	// a callback function if anything has changed.
	wmd.inputPoller = function(callback, interval){

		var pollerObj = this;
		var inputArea = wmd.panels.input;

		// Stored start, end and text.  Used to see if there are changes to the input.
		var lastStart;
		var lastEnd;
		var markdown;

		var killHandle; // Used to cancel monitoring on destruction.
		// Checks to see if anything has changed in the textarea.
		// If so, it runs the callback.
		this.tick = function(){

			if (!util.isVisible(inputArea)) {
				return;
			}

			// Update the selection start and end, text.
			if (inputArea.selectionStart || inputArea.selectionStart === 0) {
				var start = inputArea.selectionStart;
				var end = inputArea.selectionEnd;
				if (start != lastStart || end != lastEnd) {
					lastStart = start;
					lastEnd = end;

					if (markdown != inputArea.value) {
						markdown = inputArea.value;
						return true;
					}
				}
			}
			return false;
		};


		var doTickCallback = function(){

			if (!util.isVisible(inputArea)) {
				return;
			}

			// If anything has changed, call the function.
			if (pollerObj.tick()) {
				callback();
			}
		};

		// Set how often we poll the textarea for changes.
		var assignInterval = function(){
			// previewPollInterval is set at the top of the namespace.
			killHandle = setInterval(doTickCallback, interval);
		};

		this.destroy = function(){
			clearInterval(killHandle);
		};

		assignInterval();
	};

	// Handles pushing and popping TextareaStates for undo/redo commands.
	// I should rename the stack variables to list.
	wmd.undoManager = function(callback){

		var undoObj = this;
		var undoStack = []; // A stack of undo states
		var stackPtr = 0; // The index of the current state
		var mode = "none";
		var lastState; // The last state
		var poller;
		var timer; // The setTimeout handle for cancelling the timer
		var inputStateObj;

		// Set the mode for later logic steps.
		var setMode = function(newMode, noSave){

			if (mode != newMode) {
				mode = newMode;
				if (!noSave) {
					saveState();
				}
			}

			if (!global.isIE || mode != "moving") {
				timer = setTimeout(refreshState, 1);
			}
			else {
				inputStateObj = null;
			}
		};

		var refreshState = function(){
			inputStateObj = new wmd.TextareaState();
			poller.tick();
			timer = undefined;
		};

		this.setCommandMode = function(){
			mode = "command";
			saveState();
			timer = setTimeout(refreshState, 0);
		};

		this.canUndo = function(){
			return stackPtr > 1;
		};

		this.canRedo = function(){
			if (undoStack[stackPtr + 1]) {
				return true;
			}
			return false;
		};

		// Removes the last state and restores it.
		this.undo = function(){

			if (undoObj.canUndo()) {
				if (lastState) {
					// What about setting state -1 to null or checking for undefined?
					lastState.restore();
					lastState = null;
				}
				else {
					undoStack[stackPtr] = new wmd.TextareaState();
					undoStack[--stackPtr].restore();

					if (callback) {
						callback();
					}
				}
			}

			mode = "none";
			wmd.panels.input.focus();
			refreshState();
		};

		// Redo an action.
		this.redo = function(){

			if (undoObj.canRedo()) {

				undoStack[++stackPtr].restore();

				if (callback) {
					callback();
				}
			}

			mode = "none";
			wmd.panels.input.focus();
			refreshState();
		};

		// Push the input area state to the stack.
		var saveState = function(){

			var currState = inputStateObj || new wmd.TextareaState();

			if (!currState) {
				return false;
			}
			if (mode == "moving") {
				if (!lastState) {
					lastState = currState;
				}
				return;
			}
			if (lastState) {
				if (undoStack[stackPtr - 1].text != lastState.text) {
					undoStack[stackPtr++] = lastState;
				}
				lastState = null;
			}
			undoStack[stackPtr++] = currState;
			undoStack[stackPtr + 1] = null;
			if (callback) {
				callback();
			}
		};

		var handleCtrlYZ = function(event){

			var handled = false;

			if (event.ctrlKey || event.metaKey) {

				// IE and Opera do not support charCode.
				var keyCode = event.charCode || event.keyCode;
				var keyCodeChar = String.fromCharCode(keyCode);

				switch (keyCodeChar) {

					case "y":
						undoObj.redo();
						handled = true;
						break;

					case "z":
						if (!event.shiftKey) {
							undoObj.undo();
						}
						else {
							undoObj.redo();
						}
						handled = true;
						break;
				}
			}

			if (handled) {
				if (event.preventDefault) {
					event.preventDefault();
				}
				if (event) {
					event.returnValue = false;
				}
				return;
			}
		};

		// Set the mode depending on what is going on in the input area.
		var handleModeChange = function(event){

			if (!event.ctrlKey && !event.metaKey) {

				var keyCode = event.keyCode;

				if ((keyCode >= 33 && keyCode <= 40) || (keyCode >= 63232 && keyCode <= 63235)) {
					// 33 - 40: page up/dn and arrow keys
					// 63232 - 63235: page up/dn and arrow keys on safari
					setMode("moving");
				}
				else if (keyCode == 8 || keyCode == 46 || keyCode == 127) {
					// 8: backspace
					// 46: delete
					// 127: delete
					setMode("deleting");
				}
				else if (keyCode == 13) {
					// 13: Enter
					setMode("newlines");
				}
				else if (keyCode == 27) {
					// 27: escape
					setMode("escape");
				}
				else if ((keyCode < 16 || keyCode > 20) && keyCode != 91) {
					// 16-20 are shift, etc.
					// 91: left window key
					// I think this might be a little messed up since there are
					// a lot of nonprinting keys above 20.
					setMode("typing");
				}
			}
		};

		var setEventHandlers = function(){

			util.addEvent(wmd.panels.input, "keypress", function(event){
				// keyCode 89: y
				// keyCode 90: z
				if ((event.ctrlKey || event.metaKey) && (event.keyCode == 89 || event.keyCode == 90)) {
					event.preventDefault();
				}
			});

			var handlePaste = function(){
				if (global.isIE || (inputStateObj && inputStateObj.text != wmd.panels.input.value)) {
					if (timer === undefined) {
						mode = "paste";
						saveState();
						refreshState();
					}
				}
			};

			// pastePollInterval is specified at the beginning of this namespace.
			poller = new wmd.inputPoller(handlePaste, pastePollInterval);

			util.addEvent(wmd.panels.input, "keydown", handleCtrlYZ);
			util.addEvent(wmd.panels.input, "keydown", handleModeChange);

			util.addEvent(wmd.panels.input, "mousedown", function(){
				setMode("moving");
			});
			wmd.panels.input.onpaste = handlePaste;
			wmd.panels.input.ondrop = handlePaste;
		};

		var init = function(){
			setEventHandlers();
			refreshState();
			saveState();
		};

		this.destroy = function(){
			if (poller) {
				poller.destroy();
			}
		};

		init();
	};

	// I think my understanding of how the buttons and callbacks are stored in the array is incomplete.
	wmd.editor = function(previewRefreshCallback){

		if (!previewRefreshCallback) {
			previewRefreshCallback = function(){};
		}

		var inputBox = wmd.panels.input;

		var offsetHeight = 0;

		var editObj = this;

		var mainDiv;
		var mainSpan;

		var div; // This name is pretty ambiguous.  I should rename this.

		// Used to cancel recurring events from setInterval.
		var creationHandle;

		var undoMgr; // The undo manager

        var isButtonUsed = function(button){
            var buttons = $.trim(wmd.wmd_env.buttons).split(/\s+/);
            return $.inArray(button, buttons) !== -1;
        };

		// Perform the button's action.
		var doClick = function(button){

			inputBox.focus();

			if (button.textOp) {

				if (undoMgr) {
					undoMgr.setCommandMode();
				}

				var state = new wmd.TextareaState();

				if (!state) {
					return;
				}

				var chunks = state.getChunks();

				// Some commands launch a "modal" prompt dialog.  Javascript
				// can't really make a modal dialog box and the WMD code
				// will continue to execute while the dialog is displayed.
				// This prevents the dialog pattern I'm used to and means
				// I can't do something like this:
				//
				// var link = CreateLinkDialog();
				// makeMarkdownLink(link);
				//
				// Instead of this straightforward method of handling a
				// dialog I have to pass any code which would execute
				// after the dialog is dismissed (e.g. link creation)
				// in a function parameter.
				//
				// Yes this is awkward and I think it sucks, but there's
				// no real workaround.  Only the image and link code
				// create dialogs and require the function pointers.
				var fixupInputArea = function(){

					inputBox.focus();

					if (chunks) {
						state.setChunks(chunks);
					}

					state.restore();
					previewRefreshCallback();
				};

				var noCleanup = button.textOp(chunks, fixupInputArea);

				if(!noCleanup) {
					fixupInputArea();
				}

			}

			if (button.execute) {
				button.execute(editObj);
			}
		};

		var setUndoRedoButtonStates = function(){
			if(undoMgr){
				setupButton(document.getElementById(util.makeId("wmd-undo-button")), undoMgr.canUndo());
				setupButton(document.getElementById(util.makeId("wmd-redo-button")), undoMgr.canRedo());
			}
		};

		var setupButton = function(button, isEnabled) {

			var normalYShift = "0px";
			var disabledYShift = "-20px";
			var highlightYShift = "-40px";

			if(isEnabled) {
				button.style.backgroundPosition = button.XShift + " " + normalYShift;
				button.onmouseover = function(){
					this.style.backgroundPosition = this.XShift + " " + highlightYShift;
				};

				button.onmouseout = function(){
					this.style.backgroundPosition = this.XShift + " " + normalYShift;
				};

				// IE tries to select the background image "button" text (it's
				// implemented in a list item) so we have to cache the selection
				// on mousedown.
				if(global.isIE) {
					button.onmousedown =  function() {
						wmd.ieRetardedClick = true;
						wmd.ieCachedRange = document.selection.createRange();
					};
				}

				if (!button.isHelp)
				{
					button.onclick = function() {
						if (this.onmouseout) {
							this.onmouseout();
						}
						doClick(this);
						return false;
					};
				}
			}
			else {
				button.style.backgroundPosition = button.XShift + " " + disabledYShift;
				button.onmouseover = button.onmouseout = button.onclick = function(){};
			}
		};

		var makeSpritedButtonRow = function(){
			var buttonBar = document.getElementById(util.makeId("wmd-button-bar"));
            buttonBar.className = 'wmd-button-bar';
			var normalYShift = "0px";
			var disabledYShift = "-20px";
			var highlightYShift = "-40px";

			var buttonRow = document.createElement("ul");
            buttonRow.className = 'wmd-button-row';
			buttonRow.id = util.makeId("wmd-button-row");
			buttonRow = buttonBar.appendChild(buttonRow);

            if (isButtonUsed('bold')){
                var boldButton = document.createElement("li");
                boldButton.className = "wmd-button wmd-bold-button";
                boldButton.id = util.makeId("wmd-bold-button");
                boldButton.title = toolbar_strong_label;
                boldButton.XShift = "0px";
                boldButton.textOp = command.doBold;
                setupButton(boldButton, true);
                buttonRow.appendChild(boldButton);
            }

            if (isButtonUsed('italic')){
                var italicButton = document.createElement("li");
                italicButton.className = "wmd-button wmd-italic-button";
                italicButton.id = util.makeId("wmd-italic-button");
                italicButton.title = toolbar_emphasis_label;
                italicButton.XShift = "-20px";
                italicButton.textOp = command.doItalic;
                setupButton(italicButton, true);
                buttonRow.appendChild(italicButton);
            }

            if (
                isButtonUsed('link') ||
                isButtonUsed('blockquote') ||
                isButtonUsed('code') ||
                isButtonUsed('image') ||
                isButtonUsed('attachment')
            ) {
                var spacer1 = document.createElement("li");
                spacer1.className = "wmd-spacer wmd-spacer1";
                spacer1.id = util.makeId("wmd-spacer1");
                buttonRow.appendChild(spacer1);
            }

            if (isButtonUsed('link')){
                var linkButton = document.createElement("li");
                linkButton.className = "wmd-button wmd-link-button";
                linkButton.id = util.makeId("wmd-link-button");
                linkButton.title = toolbar_hyperlink_label;
                linkButton.XShift = "-40px";
                linkButton.textOp = function(chunk, postProcessing){
                    return command.doLinkOrImage(chunk, postProcessing, 'link');
                };
                setupButton(linkButton, true);
                buttonRow.appendChild(linkButton);
            }

            if (isButtonUsed('blockquote')){
                var quoteButton = document.createElement("li");
                quoteButton.className = "wmd-button wmd-quote-button";
                quoteButton.id = util.makeId("wmd-quote-button");
                quoteButton.title = toolbar_blockquote_label;
                quoteButton.XShift = "-60px";
                quoteButton.textOp = command.doBlockquote;
                setupButton(quoteButton, true);
                buttonRow.appendChild(quoteButton);
            }

            if (isButtonUsed('code')){
                var codeButton = document.createElement("li");
                codeButton.className = "wmd-button wmd-code-button";
                codeButton.id = util.makeId("wmd-code-button");
                codeButton.title = toolbar_code_label;
                codeButton.XShift = "-80px";
                codeButton.textOp = command.doCode;
                setupButton(codeButton, true);
                buttonRow.appendChild(codeButton);
            }

            if (isButtonUsed('image')){
                var imageButton = document.createElement("li");
                imageButton.className = "wmd-button wmd-image-button";
                imageButton.id = util.makeId("wmd-image-button");
                imageButton.title = toolbar_image_label;
                imageButton.XShift = "-100px";
                imageButton.textOp = function(chunk, postProcessing){
                    return command.doLinkOrImage(chunk, postProcessing, 'image');
                };
                setupButton(imageButton, true);
                buttonRow.appendChild(imageButton);
            }

            if (isButtonUsed('attachment')){
                var attachmentButton = document.createElement("li");
                attachmentButton.className = "wmd-button wmd-attachment-button";
                attachmentButton.id = util.makeId("wmd-attachment-button");
                attachmentButton.title = toolbar_attachment_label;
                attachmentButton.XShift = "-120px";
                attachmentButton.textOp = function(chunk, postProcessing){
                    return command.doLinkOrImage(chunk, postProcessing, 'file');
                };
                setupButton(attachmentButton, true);
                buttonRow.appendChild(attachmentButton);
            }

            if (
                isButtonUsed('ol') ||
                isButtonUsed('ul') ||
                isButtonUsed('heading') ||
                isButtonUsed('hr')
            ) {
                var spacer2 = document.createElement("li");
                spacer2.className = "wmd-spacer wmd-spacer2";
                spacer2.id = util.makeId("wmd-spacer2");
                buttonRow.appendChild(spacer2);
            }

            if (isButtonUsed('ol')) {
                var olistButton = document.createElement("li");
                olistButton.className = "wmd-button wmd-olist-button";
                olistButton.id = util.makeId("wmd-olist-button");
                olistButton.title = toolbar_numbered_label;
                olistButton.XShift = "-140px";
                olistButton.textOp = function(chunk, postProcessing){
                    command.doList(chunk, postProcessing, true);
                };
                setupButton(olistButton, true);
                buttonRow.appendChild(olistButton);
            }

            if (isButtonUsed('ul')) {
                var ulistButton = document.createElement("li");
                ulistButton.className = "wmd-button wmd-ulist-button";
                ulistButton.id = util.makeId("wmd-ulist-button");
                ulistButton.title = toolbar_bulleted_label;
                ulistButton.XShift = "-160px";
                ulistButton.textOp = function(chunk, postProcessing){
                    command.doList(chunk, postProcessing, false);
                };
                setupButton(ulistButton, true);
                buttonRow.appendChild(ulistButton);
            }

            if (isButtonUsed('heading')) {
                var headingButton = document.createElement("li");
                headingButton.className = "wmd-button wmd-heading-button";
                headingButton.id = util.makeId("wmd-heading-button");
                headingButton.title = toolbar_heading_label;
                headingButton.XShift = "-180px";
                headingButton.textOp = command.doHeading;
                setupButton(headingButton, true);
                buttonRow.appendChild(headingButton);
            }

            if (isButtonUsed('hr')) {
                var hrButton = document.createElement("li");
                hrButton.className = "wmd-button wmd-hr-button";
                hrButton.id = util.makeId("wmd-hr-button");
                hrButton.title = toolbar_horizontal_label;
                hrButton.XShift = "-200px";
                hrButton.textOp = command.doHorizontalRule;
                setupButton(hrButton, true);
                buttonRow.appendChild(hrButton);
            }

            if (isButtonUsed('undo')){
                var spacer3 = document.createElement("li");
                spacer3.className = "wmd-spacer wmd-spacer3";
                spacer3.id = util.makeId("wmd-spacer3");
                buttonRow.appendChild(spacer3);

                var undoButton = document.createElement("li");
                undoButton.className = "wmd-button wmd-undo-button";
                undoButton.id = util.makeId("wmd-undo-button");
                undoButton.title = toolbar_undo_label;
                undoButton.XShift = "-220px";
                undoButton.execute = function(manager){
                    manager.undo();
                };
                setupButton(undoButton, true);
                buttonRow.appendChild(undoButton);

                var redoButton = document.createElement("li");
                redoButton.className = "wmd-button wmd-redo-button";
                redoButton.id = util.makeId("wmd-redo-button");
                redoButton.title = toolbar_redo_label;
                if (/win/.test(nav.platform.toLowerCase())) {
                    redoButton.title = toolbar_redo_label;
                }
                else {
                    // mac and other non-Windows platforms
                    redoButton.title = gettext('redo') + " - Ctrl+Shift+Z";
                }
                redoButton.XShift = "-240px";
                redoButton.execute = function(manager){
                    manager.redo();
                };
                setupButton(redoButton, true);
                buttonRow.appendChild(redoButton);
			    setUndoRedoButtonStates();
            }
			/*
			var helpButton = document.createElement("li");
			helpButton.className = "wmd-button wmd-help-button";
			helpButton.id = util.makeId("wmd-help-button");
			helpButton.XShift = "-240px";
			helpButton.isHelp = true;

			var helpAnchor = document.createElement("a");
			helpAnchor.href = helpLink;
			helpAnchor.target = helpTarget
			helpAnchor.title = helpHoverTitle;
			helpButton.appendChild(helpAnchor);

			setupButton(helpButton, true);
			buttonRow.appendChild(helpButton);
			*/
		};

		var setupEditor = function(){

            //prevent double initialization of the same editor
			var buttonBar = document.getElementById(util.makeId("wmd-button-bar"));
            if (buttonBar.className == 'wmd-button-bar') {
                return;
            }

			if (/\?noundo/.test(doc.location.href)) {
				wmd.nativeUndo = true;
			}

			if (!wmd.nativeUndo && isButtonUsed('undo')) {
				undoMgr = new wmd.undoManager(function(){
					previewRefreshCallback();
					setUndoRedoButtonStates();
				});
			}

			makeSpritedButtonRow();


			var keyEvent = "keydown";
			if (global.isOpera) {
				keyEvent = "keypress";
			}

			util.addEvent(inputBox, keyEvent, function(key){

				// Check to see if we have a button key and, if so execute the callback.
				if (key.ctrlKey || key.metaKey) {

					var keyCode = key.charCode || key.keyCode;
					var keyCodeStr = String.fromCharCode(keyCode).toLowerCase();

					// Bugfix for messed up DEL and .
					if (keyCode === 46) {
						keyCodeStr = "";
					}
					if (keyCode === 190) {
						keyCodeStr = ".";
					}

					switch(keyCodeStr) {
						case "b":
							doClick(document.getElementById(util.makeId("wmd-bold-button")));
							break;
						case "i":
							doClick(document.getElementById(util.makeId("wmd-italic-button")));
							break;
						case "l":
							doClick(document.getElementById(util.makeId("wmd-link-button")));
							break;
						case ".":
							doClick(document.getElementById(util.makeId("wmd-quote-button")));
							break;
						case "k":
							doClick(document.getElementById(util.makeId("wmd-code-button")));
							break;
						case "g":
							doClick(document.getElementById(util.makeId("wmd-image-button")));
							break;
						case "o":
							doClick(document.getElementById(util.makeId("wmd-olist-button")));
							break;
						case "u":
							doClick(document.getElementById(util.makeId("wmd-ulist-button")));
							break;
						case "h":
							doClick(document.getElementById(util.makeId("wmd-heading-button")));
							break;
						case "r":
							doClick(document.getElementById(util.makeId("wmd-hr-button")));
							break;
						case "y":
							doClick(document.getElementById(util.makeId("wmd-redo-button")));
							break;
						case "z":
							if(key.shiftKey) {
								doClick(document.getElementById(util.makeId("wmd-redo-button")));
							}
							else {
								doClick(document.getElementById(util.makeId("wmd-undo-button")));
							}
							break;
						default:
							return;
					}


					if (key.preventDefault) {
						key.preventDefault();
					}

					if (event) {
						event.returnValue = false;
					}
				}
			});

			// Auto-indent on shift-enter
			util.addEvent(inputBox, "keyup", function(key){
				if (key.shiftKey && !key.ctrlKey && !key.metaKey) {
					var keyCode = key.charCode || key.keyCode;
					// Character 13 is Enter
					if (keyCode === 13) {
						fakeButton = {};
						fakeButton.textOp = command.doAutoindent;
						doClick(fakeButton);
					}
				}
			});

			if (inputBox.form) {
				var submitCallback = inputBox.form.onsubmit;
				inputBox.form.onsubmit = function(){
					convertToHtml();
					if (submitCallback) {
						return submitCallback.apply(this, arguments);
					}
				};
			}
		};

		// Convert the contents of the input textarea to HTML in the output/preview panels.
		var convertToHtml = function(){

			if (wmd.showdown) {
				var markdownConverter = getAskbotMarkdownConverter();
			}
			var text = inputBox.value;

			var callback = function(){
				inputBox.value = text;
        //value is assigned here
			};

			if (!/markdown/.test(wmd.wmd_env.output.toLowerCase())) {
				if (markdownConverter) {
					inputBox.value = markdownConverter.makeHtml(text);
          //value is assigned here
					setTimeout(callback, 0);
				}
			}
			return true;
		};


		this.undo = function(){
			if (undoMgr) {
				undoMgr.undo();
			}
		};

		this.redo = function(){
			if (undoMgr) {
				undoMgr.redo();
			}
		};

		// This is pretty useless.  The setupEditor function contents
		// should just be copied here.
		var init = function(){
			setupEditor();
		};

		this.destroy = function(){
			if (undoMgr) {
				undoMgr.destroy();
			}
			if (div.parentNode) {
				div.parentNode.removeChild(div);
			}
			if (inputBox) {
				inputBox.style.marginTop = "";
			}
			clearInterval(creationHandle);
		};

		init();
	};

	// The input textarea state/contents.
	// This is used to implement undo/redo by the undo manager.
	wmd.TextareaState = function(){

		// Aliases
		var stateObj = this;
		var inputArea = wmd.panels.input;

		this.init = function() {

			if (!util.isVisible(inputArea)) {
				return;
			}

			this.setInputAreaSelectionStartEnd();
			this.scrollTop = inputArea.scrollTop;
			if (!this.text && inputArea.selectionStart || inputArea.selectionStart === 0) {
				this.text = inputArea.value;
			}

		};

		// Sets the selected text in the input box after we've performed an
		// operation.
		this.setInputAreaSelection = function(){

			if (!util.isVisible(inputArea)) {
				return;
			}

			if (inputArea.selectionStart !== undefined && !global.isOpera) {

				inputArea.focus();
				inputArea.selectionStart = stateObj.start;
				inputArea.selectionEnd = stateObj.end;
				inputArea.scrollTop = stateObj.scrollTop;
			}
			else if (doc.selection) {

				if (doc.activeElement && doc.activeElement !== inputArea) {
					return;
				}

				inputArea.focus();
				var range = inputArea.createTextRange();
				range.moveStart("character", -inputArea.value.length);
				range.moveEnd("character", -inputArea.value.length);
				range.moveEnd("character", stateObj.end);
				range.moveStart("character", stateObj.start);
				range.select();
			}
		};

		this.setInputAreaSelectionStartEnd = function(){

			if (inputArea.selectionStart || inputArea.selectionStart === 0) {

				stateObj.start = inputArea.selectionStart;
				stateObj.end = inputArea.selectionEnd;
			}
			else if (doc.selection) {

				stateObj.text = util.fixEolChars(inputArea.value);

				// IE loses the selection in the textarea when buttons are
				// clicked.  On IE we cache the selection and set a flag
				// which we check for here.
				var range;
				if(wmd.ieRetardedClick && wmd.ieCachedRange) {
					range = wmd.ieCachedRange;
					wmd.ieRetardedClick = false;
				}
				else {
					range = doc.selection.createRange();
				}

				var fixedRange = util.fixEolChars(range.text);
				var marker = "\x07";
				var markedRange = marker + fixedRange + marker;
				range.text = markedRange;
				var inputText = util.fixEolChars(inputArea.value);

				range.moveStart("character", -markedRange.length);
				range.text = fixedRange;

				stateObj.start = inputText.indexOf(marker);
				stateObj.end = inputText.lastIndexOf(marker) - marker.length;

				var len = stateObj.text.length - util.fixEolChars(inputArea.value).length;

				if (len) {
					range.moveStart("character", -fixedRange.length);
					while (len--) {
						fixedRange += "\n";
						stateObj.end += 1;
					}
					range.text = fixedRange;
				}

				this.setInputAreaSelection();
			}
		};

		// Restore this state into the input area.
		this.restore = function(){

			if (stateObj.text !== undefined && stateObj.text != inputArea.value) {
				inputArea.value = stateObj.text;
        //value is assigned here
			}
			this.setInputAreaSelection();
			inputArea.scrollTop = stateObj.scrollTop;
		};

		// Gets a collection of HTML chunks from the inptut textarea.
		this.getChunks = function(){

			var chunk = new wmd.Chunks();

			chunk.before = util.fixEolChars(stateObj.text.substring(0, stateObj.start));
			chunk.startTag = "";
			chunk.selection = util.fixEolChars(stateObj.text.substring(stateObj.start, stateObj.end));
			chunk.endTag = "";
			chunk.after = util.fixEolChars(stateObj.text.substring(stateObj.end));
			chunk.scrollTop = stateObj.scrollTop;

			return chunk;
		};

		// Sets the TextareaState properties given a chunk of markdown.
		this.setChunks = function(chunk){

			chunk.before = chunk.before + chunk.startTag;
			chunk.after = chunk.endTag + chunk.after;

			if (global.isOpera) {
				chunk.before = chunk.before.replace(/\n/g, "\r\n");
				chunk.selection = chunk.selection.replace(/\n/g, "\r\n");
				chunk.after = chunk.after.replace(/\n/g, "\r\n");
			}

			this.start = chunk.before.length;
			this.end = chunk.before.length + chunk.selection.length;
			this.text = chunk.before + chunk.selection + chunk.after;
			this.scrollTop = chunk.scrollTop;
		};

		this.init();
	};

	// before: contains all the text in the input box BEFORE the selection.
	// after: contains all the text in the input box AFTER the selection.
	wmd.Chunks = function(){
	};

	// startRegex: a regular expression to find the start tag
	// endRegex: a regular expresssion to find the end tag
	wmd.Chunks.prototype.findTags = function(startRegex, endRegex){

		var chunkObj = this;
		var regex;

		if (startRegex) {

			regex = util.extendRegExp(startRegex, "", "$");

			this.before = this.before.replace(regex,
				function(match){
					chunkObj.startTag = chunkObj.startTag + match;
					return "";
				});

			regex = util.extendRegExp(startRegex, "^", "");

			this.selection = this.selection.replace(regex,
				function(match){
					chunkObj.startTag = chunkObj.startTag + match;
					return "";
				});
		}

		if (endRegex) {

			regex = util.extendRegExp(endRegex, "", "$");

			this.selection = this.selection.replace(regex,
				function(match){
					chunkObj.endTag = match + chunkObj.endTag;
					return "";
				});

			regex = util.extendRegExp(endRegex, "^", "");

			this.after = this.after.replace(regex,
				function(match){
					chunkObj.endTag = match + chunkObj.endTag;
					return "";
				});
		}
	};

	// If remove is false, the whitespace is transferred
	// to the before/after regions.
	//
	// If remove is true, the whitespace disappears.
	wmd.Chunks.prototype.trimWhitespace = function(remove){

		this.selection = this.selection.replace(/^(\s*)/, "");

		if (!remove) {
			this.before += re.$1;
		}

		this.selection = this.selection.replace(/(\s*)$/, "");

		if (!remove) {
			this.after = re.$1 + this.after;
		}
	};


	wmd.Chunks.prototype.skipLines = function(nLinesBefore, nLinesAfter, findExtraNewlines){

		if (nLinesBefore === undefined) {
			nLinesBefore = 1;
		}

		if (nLinesAfter === undefined) {
			nLinesAfter = 1;
		}

		nLinesBefore++;
		nLinesAfter++;

		var regexText;
		var replacementText;

        if (global.isChrome) {//Chrome bug workaround
            'X'.match(/()./);
        }

		this.selection = this.selection.replace(/(^\n*)/, "");
		this.startTag = this.startTag + re.$1;
		this.selection = this.selection.replace(/(\n*$)/, "");
		this.endTag = this.endTag + re.$1;
		this.startTag = this.startTag.replace(/(^\n*)/, "");
		this.before = this.before + re.$1;
		this.endTag = this.endTag.replace(/(\n*$)/, "");
		this.after = this.after + re.$1;

		if (this.before) {

			regexText = replacementText = "";

			while (nLinesBefore--) {
				regexText += "\\n?";
				replacementText += "\n";
			}

			if (findExtraNewlines) {
				regexText = "\\n*";
			}
			this.before = this.before.replace(new re(regexText + "$", ""), replacementText);
		}

		if (this.after) {

			regexText = replacementText = "";

			while (nLinesAfter--) {
				regexText += "\\n?";
				replacementText += "\n";
			}
			if (findExtraNewlines) {
				regexText = "\\n*";
			}

			this.after = this.after.replace(new re(regexText, ""), replacementText);
		}
	};

	// The markdown symbols - 4 spaces = code, > = blockquote, etc.
	command.prefixes = "(?:\\s{4,}|\\s*>|\\s*-\\s+|\\s*\\d+\\.|=|\\+|-|_|\\*|#|\\s*\\[[^\n]]+\\]:)";

	// Remove markdown symbols from the chunk selection.
	command.unwrap = function(chunk){
		var txt = new re("([^\\n])\\n(?!(\\n|" + command.prefixes + "))", "g");
		chunk.selection = chunk.selection.replace(txt, "$1 $2");
	};

	command.wrap = function(chunk, len){
		command.unwrap(chunk);
		var regex = new re("(.{1," + len + "})( +|$\\n?)", "gm");

		chunk.selection = chunk.selection.replace(regex, function(line, marked){
			if (new re("^" + command.prefixes, "").test(line)) {
				return line;
			}
			return marked + "\n";
		});

		chunk.selection = chunk.selection.replace(/\s+$/, "");
	};

	command.doBold = function(chunk, postProcessing){
		return command.doBorI(chunk, postProcessing, 2, gettext("strong text"));
	};

	command.doItalic = function(chunk, postProcessing){
		return command.doBorI(chunk, postProcessing, 1, gettext("emphasized text"));
	};

	// chunk: The selected region that will be enclosed with */**
	// nStars: 1 for italics, 2 for bold
	// insertText: If you just click the button without highlighting text, this gets inserted
	command.doBorI = function(chunk, postProcessing, nStars, insertText){

		// Get rid of whitespace and fixup newlines.
		chunk.trimWhitespace();
		chunk.selection = chunk.selection.replace(/\n{2,}/g, "\n");

		// Look for stars before and after.  Is the chunk already marked up?
		chunk.before.search(/(\**$)/);
		var starsBefore = re.$1;

		chunk.after.search(/(^\**)/);
		var starsAfter = re.$1;

		var prevStars = Math.min(starsBefore.length, starsAfter.length);

		// Remove stars if we have to since the button acts as a toggle.
		if ((prevStars >= nStars) && (prevStars != 2 || nStars != 1)) {
			chunk.before = chunk.before.replace(re("[*]{" + nStars + "}$", ""), "");
			chunk.after = chunk.after.replace(re("^[*]{" + nStars + "}", ""), "");
		}
		else if (!chunk.selection && starsAfter) {
			// It's not really clear why this code is necessary.  It just moves
			// some arbitrary stuff around.
			chunk.after = chunk.after.replace(/^([*_]*)/, "");
			chunk.before = chunk.before.replace(/(\s?)$/, "");
			var whitespace = re.$1;
			chunk.before = chunk.before + starsAfter + whitespace;
		}
		else {

			// In most cases, if you don't have any selected text and click the button
			// you'll get a selected, marked up region with the default text inserted.
			if (!chunk.selection && !starsAfter) {
				chunk.selection = insertText;
			}

			// Add the true markup.
			var markup = nStars <= 1 ? "*" : "**"; // shouldn't the test be = ?
			chunk.before = chunk.before + markup;
			chunk.after = markup + chunk.after;
		}

		return;
	};

	command.stripLinkDefs = function(text, defsToAdd){

		text = text.replace(/^[ ]{0,3}\[(\d+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?[ \t]*\n?[ \t]*(?:(\n*)["(](.+?)[")][ \t]*)?(?:\n+|$)/gm,
			function(totalMatch, id, link, newlines, title){
				defsToAdd[id] = totalMatch.replace(/\s*$/, "");
				if (newlines) {
					// Strip the title and return that separately.
					defsToAdd[id] = totalMatch.replace(/["(](.+?)[")]$/, "");
					return newlines + title;
				}
				return "";
			});

		return text;
	};

	command.addLinkDef = function(chunk, linkDef){

		var refNumber = 0; // The current reference number
		var defsToAdd = {}; //
		// Start with a clean slate by removing all previous link definitions.
		chunk.before = command.stripLinkDefs(chunk.before, defsToAdd);
		chunk.selection = command.stripLinkDefs(chunk.selection, defsToAdd);
		chunk.after = command.stripLinkDefs(chunk.after, defsToAdd);

		var defs = "";
		var regex = /(\[(?:\[[^\]]*\]|[^\[\]])*\][ ]?(?:\n[ ]*)?\[)(\d+)(\])/g;

		var addDefNumber = function(def){
			refNumber++;
			def = def.replace(/^[ ]{0,3}\[(\d+)\]:/, "  [" + refNumber + "]:");
			defs += "\n" + def;
		};

		var getLink = function(wholeMatch, link, id, end){

			if (defsToAdd[id]) {
				addDefNumber(defsToAdd[id]);
				return link + refNumber + end;

			}
			return wholeMatch;
		};

		chunk.before = chunk.before.replace(regex, getLink);

		if (linkDef) {
			addDefNumber(linkDef);
		}
		else {
			chunk.selection = chunk.selection.replace(regex, getLink);
		}

		var refOut = refNumber;

		chunk.after = chunk.after.replace(regex, getLink);

		if (chunk.after) {
			chunk.after = chunk.after.replace(/\n*$/, "");
		}
		if (!chunk.after) {
			chunk.selection = chunk.selection.replace(/\n*$/, "");
		}

		chunk.after += "\n\n" + defs;

		return refOut;
	};

	command.doLinkOrImage = function(chunk, postProcessing, itemType){

		chunk.trimWhitespace();
		chunk.findTags(/\s*!?\[/, /\][ ]?(?:\n[ ]*)?(\[.*?\])?/);

		if (chunk.endTag.length > 1) {

			chunk.startTag = chunk.startTag.replace(/!?\[/, "");
			chunk.endTag = "";
			command.addLinkDef(chunk, null);

		}
		else {

			if (/\n\n/.test(chunk.selection)) {
				command.addLinkDef(chunk, null);
				return;
			}

			// The function to be executed when you enter a link and press OK or Cancel.
			// Marks up the link and adds the ref.
    var makeLinkMarkdown = function(link){

        if (link !== null) {

            chunk.startTag = chunk.endTag = "";
            //var linkDef = " [999]: " + link;

            //var num = command.addLinkDef(chunk, linkDef);
            chunk.startTag = (itemType == 'image') ? "![" : "[";
            chunk.endTag = "](" + link + ")";

            if (!chunk.selection) {
                if (itemType == 'image') {
                    chunk.selection = gettext("image description");
                }
                else if (itemType == 'file'){
                    chunk.selection = localUploadFileName || gettext("file name");
                    localUploadFileName = null;
                }
                else {
                    chunk.selection = gettext("link text");
                }
            }
        }
        else {
            if (itemType == 'image' || itemType == 'file'){
                return;
            }
        }
        postProcessing();
    };
    if (itemType == 'image') {
        // add forth param to identify image window
        util.prompt(imageDialogText, imageDefaultText, makeLinkMarkdown, 'image');
    }
    else if (itemType == 'file'){
        util.prompt(fileDialogText, '', makeLinkMarkdown, 'file');
    }
    else {
        util.prompt(linkDialogText, linkDefaultText, makeLinkMarkdown, 'link');
    }
    return true;
    }
};

	util.makeAPI = function(){
		wmd.wmd = {};
		wmd.wmd.editor = wmd.editor;
		wmd.wmd.previewManager = wmd.previewManager;
	};

    util.makeId = function(idToken) {
        if (wmd.wmd_env['idSeed']) {
            return askbotMakeId(idToken, wmd.wmd_env['idSeed']);
        }
        return idToken;
    };

	util.startEditor = function(start_now, buttons, idSeed){

        wmd.wmd_env['idSeed'] = idSeed;

		if (wmd.wmd_env.autostart === false) {
			util.makeAPI();
			return;
		}

        if (buttons){
            wmd.wmd_env.buttons = buttons;
        }

		var edit;		// The editor (buttons + input + outputs) - the main object.
		var previewMgr;	// The preview manager.

		// Fired after the page has fully loaded.
		var loadListener = function(){

			wmd.panels = new wmd.PanelCollection();
			if (!wmd.panels.input) {
				return;
			}

			previewMgr = new wmd.previewManager();
			var previewRefreshCallback = previewMgr.refresh;

			edit = new wmd.editor(previewRefreshCallback);

			previewMgr.refresh(true);

		};

        if (start_now){
            loadListener();
        } else {
		    util.addEvent(window, "load", loadListener);
        }
	};

	wmd.previewManager = function(){

		var managerObj = this;
		var converter;
		var poller;
		var timeout;
		var elapsedTime;
		var oldInputText;
		var htmlOut;
		var maxDelay = 3000;
		var startType = "delayed"; // The other legal value is "manual"

		// Adds event listeners to elements and creates the input poller.
		var setupEvents = function(inputElem, listener){

			util.addEvent(inputElem, "input", listener);
			inputElem.onpaste = listener;
			inputElem.ondrop = listener;

			util.addEvent(inputElem, "keypress", listener);
			util.addEvent(inputElem, "keydown", listener);
			// previewPollInterval is set at the top of this file.
			poller = new wmd.inputPoller(listener, previewPollInterval);
		};

		var getDocScrollTop = function(){

			var result = 0;

			if (window.innerHeight) {
				result = pageYOffset;
			}
			else
				if (doc.documentElement && doc.documentElement.scrollTop) {
					result = doc.documentElement.scrollTop;
				}
				else
					if (doc.body) {
						result = doc.body.scrollTop;
					}

			return result;
		};

		var makePreviewHtml = function(){

			// If there are no registered preview and output panels
			// there is nothing to do.
			if (!wmd.panels.preview && !wmd.panels.output) {
				return;
			}

			var text = wmd.panels.input.value;
			if (text && text == oldInputText) {
				return; // Input text hasn't changed.
			}
			else {
				oldInputText = text;
			}

			var prevTime = new Date().getTime();

			if (!converter) {
                converter = getAskbotMarkdownConverter();
			}

			if (converter) {
				text = converter.makeHtml(text);
			}

			// Calculate the processing time of the HTML creation.
			// It's used as the delay time in the event listener.
			var currTime = new Date().getTime();
			elapsedTime = currTime - prevTime;

			pushPreviewHtml(text);
			htmlOut = text;
		};

		// setTimeout is already used.  Used as an event listener.
		var applyTimeout = function(){

			if (timeout) {
				clearTimeout(timeout);
				timeout = undefined;
			}

			if (startType !== "manual") {

				var delay = 0;

				if (startType === "delayed") {
					delay = elapsedTime;
				}

				if (delay > maxDelay) {
					delay = maxDelay;
				}
				timeout = setTimeout(makePreviewHtml, delay);
			}
		};

		var getScaleFactor = function(panel){
			if (panel.scrollHeight <= panel.clientHeight) {
				return 1;
			}
			return panel.scrollTop / (panel.scrollHeight - panel.clientHeight);
		};

		var setPanelScrollTops = function(){

			if (wmd.panels.preview) {
				wmd.panels.preview.scrollTop = (wmd.panels.preview.scrollHeight - wmd.panels.preview.clientHeight) * getScaleFactor(wmd.panels.preview);
			}

			if (wmd.panels.output) {
				wmd.panels.output.scrollTop = (wmd.panels.output.scrollHeight - wmd.panels.output.clientHeight) * getScaleFactor(wmd.panels.output);
			}
		};

		this.refresh = function(requiresRefresh){

			if (requiresRefresh) {
				oldInputText = "";
				makePreviewHtml();
			}
			else {
				applyTimeout();
			}
		};

		this.processingTime = function(){
			return elapsedTime;
		};

		// The output HTML
		this.output = function(){
			return htmlOut;
		};

		// The mode can be "manual" or "delayed"
		this.setUpdateMode = function(mode){
			startType = mode;
			managerObj.refresh();
		};

		var isFirstTimeFilled = true;

		var pushPreviewHtml = function(text){

			var emptyTop = position.getTop(wmd.panels.input) - getDocScrollTop();

			// Send the encoded HTML to the output textarea/div.
			if (wmd.panels.output) {
				// The value property is only defined if the output is a textarea.
				if (wmd.panels.output.value !== undefined) {
					wmd.panels.output.value = text;
          //value is assigned here
					wmd.panels.output.readOnly = true;
				}
				// Otherwise we are just replacing the text in a div.
				// Send the HTML wrapped in <pre><code>
				else {
					var newText = text.replace(/&/g, "&amp;");
					newText = newText.replace(/</g, "&lt;");
					wmd.panels.output.innerHTML = "<pre><code>" + newText + "</code></pre>";
				}
			}

			if (wmd.panels.preview) {
				wmd.panels.preview.innerHTML = text;
			}

			setPanelScrollTops();

			if (isFirstTimeFilled) {
				isFirstTimeFilled = false;
				return;
			}

			var fullTop = position.getTop(wmd.panels.input) - getDocScrollTop();

			if (global.isIE) {
				setTimeout(function(){
					scrollBy(0, fullTop - emptyTop);
				}, 0);
			}
			else {
				scrollBy(0, fullTop - emptyTop);
			}
		};

		var init = function(){
			if (!wmd.panels.input) {
				return;
			}

			setupEvents(wmd.panels.input, applyTimeout);
			makePreviewHtml();

			if (wmd.panels.preview) {
				wmd.panels.preview.scrollTop = 0;
			}
			if (wmd.panels.output) {
				wmd.panels.output.scrollTop = 0;
			}
		};

		this.destroy = function(){
			if (poller) {
				poller.destroy();
			}
		};

		init();
	};

	// When making a list, hitting shift-enter will put your cursor on the next line
	// at the current indent level.
	command.doAutoindent = function(chunk, postProcessing){

		chunk.before = chunk.before.replace(/(\n|^)[ ]{0,3}([*+-]|\d+[.])[ \t]*\n$/, "\n\n");
		chunk.before = chunk.before.replace(/(\n|^)[ ]{0,3}>[ \t]*\n$/, "\n\n");
		chunk.before = chunk.before.replace(/(\n|^)[ \t]+\n$/, "\n\n");

		if(/(\n|^)[ ]{0,3}([*+-]|\d+[.])[ \t]+.*\n$/.test(chunk.before)){
			if(command.doList){
				command.doList(chunk);
			}
		}
		if(/(\n|^)[ ]{0,3}>[ \t]+.*\n$/.test(chunk.before)){
			if(command.doBlockquote){
				command.doBlockquote(chunk);
			}
		}
		if(/(\n|^)(\t|[ ]{4,}).*\n$/.test(chunk.before)){
			if(command.doCode){
				command.doCode(chunk);
			}
		}
	};

	command.doBlockquote = function(chunk, postProcessing){

		chunk.selection = chunk.selection.replace(/^(\n*)([^\r]+?)(\n*)$/,
			function(totalMatch, newlinesBefore, text, newlinesAfter){
				chunk.before += newlinesBefore;
				chunk.after = newlinesAfter + chunk.after;
				return text;
			});

		chunk.before = chunk.before.replace(/(>[ \t]*)$/,
			function(totalMatch, blankLine){
				chunk.selection = blankLine + chunk.selection;
				return "";
			});

		chunk.selection = chunk.selection.replace(/^(\s|>)+$/ ,"");
		chunk.selection = chunk.selection || "Blockquote";

		if(chunk.before){
			chunk.before = chunk.before.replace(/\n?$/,"\n");
		}
		if(chunk.after){
			chunk.after = chunk.after.replace(/^\n?/,"\n");
		}

		chunk.before = chunk.before.replace(/(((\n|^)(\n[ \t]*)*>(.+\n)*.*)+(\n[ \t]*)*$)/,
			function(totalMatch){
				chunk.startTag = totalMatch;
				return "";
			});

		chunk.after = chunk.after.replace(/^(((\n|^)(\n[ \t]*)*>(.+\n)*.*)+(\n[ \t]*)*)/,
			function(totalMatch){
				chunk.endTag = totalMatch;
				return "";
			});

		var replaceBlanksInTags = function(useBracket){

			var replacement = useBracket ? "> " : "";

			if(chunk.startTag){
				chunk.startTag = chunk.startTag.replace(/\n((>|\s)*)\n$/,
					function(totalMatch, markdown){
						return "\n" + markdown.replace(/^[ ]{0,3}>?[ \t]*$/gm, replacement) + "\n";
					});
			}
			if(chunk.endTag){
				chunk.endTag = chunk.endTag.replace(/^\n((>|\s)*)\n/,
					function(totalMatch, markdown){
						return "\n" + markdown.replace(/^[ ]{0,3}>?[ \t]*$/gm, replacement) + "\n";
					});
			}
		};

		if(/^(?![ ]{0,3}>)/m.test(chunk.selection)){
			command.wrap(chunk, wmd.wmd_env.lineLength - 2);
			chunk.selection = chunk.selection.replace(/^/gm, "> ");
			replaceBlanksInTags(true);
			chunk.skipLines();
		}
		else{
			chunk.selection = chunk.selection.replace(/^[ ]{0,3}> ?/gm, "");
			command.unwrap(chunk);
			replaceBlanksInTags(false);

			if(!/^(\n|^)[ ]{0,3}>/.test(chunk.selection) && chunk.startTag){
				chunk.startTag = chunk.startTag.replace(/\n{0,2}$/, "\n\n");
			}

			if(!/(\n|^)[ ]{0,3}>.*$/.test(chunk.selection) && chunk.endTag){
				chunk.endTag=chunk.endTag.replace(/^\n{0,2}/, "\n\n");
			}
		}

		if(!/\n/.test(chunk.selection)){
			chunk.selection = chunk.selection.replace(/^(> *)/,
			function(wholeMatch, blanks){
				chunk.startTag += blanks;
				return "";
			});
		}
	};

	command.doCode = function(chunk, postProcessing){

		var hasTextBefore = /\S[ ]*$/.test(chunk.before);
		var hasTextAfter = /^[ ]*\S/.test(chunk.after);

		// Use 'four space' markdown if the selection is on its own
		// line or is multiline.
		if((!hasTextAfter && !hasTextBefore) || /\n/.test(chunk.selection)){

			chunk.before = chunk.before.replace(/[ ]{4}$/,
				function(totalMatch){
					chunk.selection = totalMatch + chunk.selection;
					return "";
				});

			var nLinesBack = 1;
			var nLinesForward = 1;

			if(/\n(\t|[ ]{4,}).*\n$/.test(chunk.before)){
				nLinesBack = 0;
			}
			if(/^\n(\t|[ ]{4,})/.test(chunk.after)){
				nLinesForward = 0;
			}

			chunk.skipLines(nLinesBack, nLinesForward);

			if(!chunk.selection){
				chunk.startTag = "    ";
				chunk.selection = gettext("enter code here");
			}
			else {
				if(/^[ ]{0,3}\S/m.test(chunk.selection)){
					chunk.selection = chunk.selection.replace(/^/gm, "    ");
				}
				else{
					chunk.selection = chunk.selection.replace(/^[ ]{4}/gm, "");
				}
			}
		}
		else{
			// Use backticks (`) to delimit the code block.

			chunk.trimWhitespace();
			chunk.findTags(/`/, /`/);

			if(!chunk.startTag && !chunk.endTag){
				chunk.startTag = chunk.endTag="`";
				if(!chunk.selection){
					chunk.selection = gettext("enter code here");
				}
			}
			else if(chunk.endTag && !chunk.startTag){
				chunk.before += chunk.endTag;
				chunk.endTag = "";
			}
			else{
				chunk.startTag = chunk.endTag="";
			}
		}
	};

	command.doList = function(chunk, postProcessing, isNumberedList){

		// These are identical except at the very beginning and end.
		// Should probably use the regex extension function to make this clearer.
		var previousItemsRegex = /(\n|^)(([ ]{0,3}([*+-]|\d+[.])[ \t]+.*)(\n.+|\n{2,}([*+-].*|\d+[.])[ \t]+.*|\n{2,}[ \t]+\S.*)*)\n*$/;
		var nextItemsRegex = /^\n*(([ ]{0,3}([*+-]|\d+[.])[ \t]+.*)(\n.+|\n{2,}([*+-].*|\d+[.])[ \t]+.*|\n{2,}[ \t]+\S.*)*)\n*/;

		// The default bullet is a dash but others are possible.
		// This has nothing to do with the particular HTML bullet,
		// it's just a markdown bullet.
		var bullet = "-";

		// The number in a numbered list.
		var num = 1;

		// Get the item prefix - e.g. " 1. " for a numbered list, " - " for a bulleted list.
		var getItemPrefix = function(){
			var prefix;
			if(isNumberedList){
				prefix = " " + num + ". ";
				num++;
			}
			else{
				prefix = " " + bullet + " ";
			}
			return prefix;
		};

		// Fixes the prefixes of the other list items.
		var getPrefixedItem = function(itemText){

			// The numbering flag is unset when called by autoindent.
			if(isNumberedList === undefined){
				isNumberedList = /^\s*\d/.test(itemText);
			}

			// Renumber/bullet the list element.
			itemText = itemText.replace(/^[ ]{0,3}([*+-]|\d+[.])\s/gm,
				function( _ ){
					return getItemPrefix();
				});

			return itemText;
		};

		chunk.findTags(/(\n|^)*[ ]{0,3}([*+-]|\d+[.])\s+/, null);

		if(chunk.before && !/\n$/.test(chunk.before) && !/^\n/.test(chunk.startTag)){
			chunk.before += chunk.startTag;
			chunk.startTag = "";
		}

		if(chunk.startTag){

			var hasDigits = /\d+[.]/.test(chunk.startTag);
			chunk.startTag = "";
			chunk.selection = chunk.selection.replace(/\n[ ]{4}/g, "\n");
			command.unwrap(chunk);
			chunk.skipLines();

			if(hasDigits){
				// Have to renumber the bullet points if this is a numbered list.
				chunk.after = chunk.after.replace(nextItemsRegex, getPrefixedItem);
			}
			if(isNumberedList == hasDigits){
				return;
			}
		}

		var nLinesUp = 1;

		chunk.before = chunk.before.replace(previousItemsRegex,
			function(itemText){
				if(/^\s*([*+-])/.test(itemText)){
					bullet = re.$1;
				}
				nLinesUp = /[^\n]\n\n[^\n]/.test(itemText) ? 1 : 0;
				return getPrefixedItem(itemText);
			});

		if(!chunk.selection){
			chunk.selection = gettext("List item");
		}

		var prefix = getItemPrefix();

		var nLinesDown = 1;

		chunk.after = chunk.after.replace(nextItemsRegex,
			function(itemText){
				nLinesDown = /[^\n]\n\n[^\n]/.test(itemText) ? 1 : 0;
				return getPrefixedItem(itemText);
			});

		chunk.trimWhitespace(true);
		chunk.skipLines(nLinesUp, nLinesDown, true);
		chunk.startTag = prefix;
		var spaces = prefix.replace(/./g, " ");
		command.wrap(chunk, wmd.wmd_env.lineLength - spaces.length);
		chunk.selection = chunk.selection.replace(/\n/g, "\n" + spaces);

	};

	command.doHeading = function(chunk, postProcessing){

		// Remove leading/trailing whitespace and reduce internal spaces to single spaces.
		chunk.selection = chunk.selection.replace(/\s+/g, " ");
		chunk.selection = chunk.selection.replace(/(^\s+|\s+$)/g, "");

		// If we clicked the button with no selected text, we just
		// make a level 2 hash header around some default text.
		if(!chunk.selection){
			chunk.startTag = "## ";
			chunk.selection = gettext("Heading");
			chunk.endTag = " ##";
			return;
		}

		var headerLevel = 0;		// The existing header level of the selected text.

		// Remove any existing hash heading markdown and save the header level.
		chunk.findTags(/#+[ ]*/, /[ ]*#+/);
		if(/#+/.test(chunk.startTag)){
			headerLevel = re.lastMatch.length;
		}
		chunk.startTag = chunk.endTag = "";

		// Try to get the current header level by looking for - and = in the line
		// below the selection.
		chunk.findTags(null, /\s?(-+|=+)/);
		if(/=+/.test(chunk.endTag)){
			headerLevel = 1;
		}
		if(/-+/.test(chunk.endTag)){
			headerLevel = 2;
		}

		// Skip to the next line so we can create the header markdown.
		chunk.startTag = chunk.endTag = "";
		chunk.skipLines(1, 1);

		// We make a level 2 header if there is no current header.
		// If there is a header level, we substract one from the header level.
		// If it's already a level 1 header, it's removed.
		var headerLevelToCreate = headerLevel == 0 ? 2 : headerLevel - 1;

		if(headerLevelToCreate > 0){

			// The button only creates level 1 and 2 underline headers.
			// Why not have it iterate over hash header levels?  Wouldn't that be easier and cleaner?
			var headerChar = headerLevelToCreate >= 2 ? "-" : "=";
			var len = chunk.selection.length;
			if(len > wmd.wmd_env.lineLength){
				len = wmd.wmd_env.lineLength;
			}
			chunk.endTag = "\n";
			while(len--){
				chunk.endTag += headerChar;
			}
		}
	};

	command.doHorizontalRule = function(chunk, postProcessing){
		chunk.startTag = "----------\n";
		chunk.selection = "";
		chunk.skipLines(2, 1, true);
	}
};


Attacklab.wmd_env = {};
Attacklab.account_options = {};
Attacklab.wmd_defaults = {version:1, output:"Markdown", lineLength:40, delayLoad:false};

if (askbot['settings']['editorType'] == 'markdown' && !Attacklab.wmd) {
	Attacklab.wmd = function() {
		Attacklab.loadEnv = function() {
			var mergeEnv = function(env) {
				if(!env) {
					return;
				}

				for(var key in env) {
					Attacklab.wmd_env[key] = env[key];
				}
			};

			mergeEnv(Attacklab.wmd_defaults);
			mergeEnv(Attacklab.account_options);
			mergeEnv(window["wmd_options"]);
			Attacklab.full = true;

			var defaultButtons = "bold italic link blockquote code image attachment ol ul heading hr";
			Attacklab.wmd_env.buttons = Attacklab.wmd_env.buttons || defaultButtons;
		};
		Attacklab.loadEnv();

	};

	Attacklab.wmd();
	Attacklab.wmdBase();
	Attacklab.Util.startEditor();
};

/*
 * jQuery validation plug-in 1.7
 *
 * http://bassistance.de/jquery-plugins/jquery-plugin-validation/
 * http://docs.jquery.com/Plugins/Validation
 *
 * Copyright (c) 2006 - 2008 Jrn Zaefferer
 *
 * $Id: jquery.validate.js 6403 2009-06-17 14:27:16Z joern.zaefferer $
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 */
(function($){$.extend($.fn,{validate:function(options){if(!this.length){options&&options.debug&&window.console&&console.warn("nothing selected, can't validate, returning nothing");return;}var validator=$.data(this[0],'validator');if(validator){return validator;}validator=new $.validator(options,this[0]);$.data(this[0],'validator',validator);if(validator.settings.onsubmit){this.find("input, button").filter(".cancel").click(function(){validator.cancelSubmit=true;});if(validator.settings.submitHandler){this.find("input, button").filter(":submit").click(function(){validator.submitButton=this;});}this.submit(function(event){if(validator.settings.debug)event.preventDefault();function handle(){if(validator.settings.submitHandler){if(validator.submitButton){var hidden=$("<input type='hidden'/>").attr("name",validator.submitButton.name).val(validator.submitButton.value).appendTo(validator.currentForm);}validator.settings.submitHandler.call(validator,validator.currentForm);if(validator.submitButton){hidden.remove();}return false;}return true;}if(validator.cancelSubmit){validator.cancelSubmit=false;return handle();}if(validator.form()){if(validator.pendingRequest){validator.formSubmitted=true;return false;}return handle();}else{validator.focusInvalid();return false;}});}return validator;},valid:function(){if($(this[0]).is('form')){return this.validate().form();}else{var valid=true;var validator=$(this[0].form).validate();this.each(function(){valid&=validator.element(this);});return valid;}},removeAttrs:function(attributes){var result={},$element=this;$.each(attributes.split(/\s/),function(index,value){result[value]=$element.attr(value);$element.removeAttr(value);});return result;},rules:function(command,argument){var element=this[0];if(command){var settings=$.data(element.form,'validator').settings;var staticRules=settings.rules;var existingRules=$.validator.staticRules(element);switch(command){case"add":$.extend(existingRules,$.validator.normalizeRule(argument));staticRules[element.name]=existingRules;if(argument.messages)settings.messages[element.name]=$.extend(settings.messages[element.name],argument.messages);break;case"remove":if(!argument){delete staticRules[element.name];return existingRules;}var filtered={};$.each(argument.split(/\s/),function(index,method){filtered[method]=existingRules[method];delete existingRules[method];});return filtered;}}var data=$.validator.normalizeRules($.extend({},$.validator.metadataRules(element),$.validator.classRules(element),$.validator.attributeRules(element),$.validator.staticRules(element)),element);if(data.required){var param=data.required;delete data.required;data=$.extend({required:param},data);}return data;}});$.extend($.expr[":"],{blank:function(a){return!$.trim(""+a.value);},filled:function(a){return!!$.trim(""+a.value);},unchecked:function(a){return!a.checked;}});$.validator=function(options,form){this.settings=$.extend(true,{},$.validator.defaults,options);this.currentForm=form;this.init();};$.validator.format=function(source,params){if(arguments.length==1)return function(){var args=$.makeArray(arguments);args.unshift(source);return $.validator.format.apply(this,args);};if(arguments.length>2&&params.constructor!=Array){params=$.makeArray(arguments).slice(1);}if(params.constructor!=Array){params=[params];}$.each(params,function(i,n){source=source.replace(new RegExp("\\{"+i+"\\}","g"),n);});return source;};$.extend($.validator,{defaults:{messages:{},groups:{},rules:{},errorClass:"error",validClass:"valid",errorElement:"label",focusInvalid:true,errorContainer:$([]),errorLabelContainer:$([]),onsubmit:true,ignore:[],ignoreTitle:false,onfocusin:function(element){this.lastActive=element;if(this.settings.focusCleanup&&!this.blockFocusCleanup){this.settings.unhighlight&&this.settings.unhighlight.call(this,element,this.settings.errorClass,this.settings.validClass);this.errorsFor(element).hide();}},onfocusout:function(element){if(!this.checkable(element)&&(element.name in this.submitted||!this.optional(element))){this.element(element);}},onkeyup:function(element){if(element.name in this.submitted||element==this.lastElement){this.element(element);}},onclick:function(element){if(element.name in this.submitted)this.element(element);else if(element.parentNode.name in this.submitted)this.element(element.parentNode);},highlight:function(element,errorClass,validClass){$(element).addClass(errorClass).removeClass(validClass);},unhighlight:function(element,errorClass,validClass){$(element).removeClass(errorClass).addClass(validClass);}},setDefaults:function(settings){$.extend($.validator.defaults,settings);},messages:{required:"This field is required.",remote:"Please fix this field.",email:"Please enter a valid email address.",url:"Please enter a valid URL.",date:"Please enter a valid date.",dateISO:"Please enter a valid date (ISO).",number:"Please enter a valid number.",digits:"Please enter only digits.",creditcard:"Please enter a valid credit card number.",equalTo:"Please enter the same value again.",accept:"Please enter a value with a valid extension.",maxlength:$.validator.format("Please enter no more than {0} characters."),minlength:$.validator.format("Please enter at least {0} characters."),rangelength:$.validator.format("Please enter a value between {0} and {1} characters long."),range:$.validator.format("Please enter a value between {0} and {1}."),max:$.validator.format("Please enter a value less than or equal to {0}."),min:$.validator.format("Please enter a value greater than or equal to {0}.")},autoCreateRanges:false,prototype:{init:function(){this.labelContainer=$(this.settings.errorLabelContainer);this.errorContext=this.labelContainer.length&&this.labelContainer||$(this.currentForm);this.containers=$(this.settings.errorContainer).add(this.settings.errorLabelContainer);this.submitted={};this.valueCache={};this.pendingRequest=0;this.pending={};this.invalid={};this.reset();var groups=(this.groups={});$.each(this.settings.groups,function(key,value){$.each(value.split(/\s/),function(index,name){groups[name]=key;});});var rules=this.settings.rules;$.each(rules,function(key,value){rules[key]=$.validator.normalizeRule(value);});function delegate(event){var validator=$.data(this[0].form,"validator"),eventType="on"+event.type.replace(/^validate/,"");validator.settings[eventType]&&validator.settings[eventType].call(validator,this[0]);}$(this.currentForm).validateDelegate(":text, :password, :file, select, textarea","focusin focusout keyup",delegate).validateDelegate(":radio, :checkbox, select, option","click",delegate);if(this.settings.invalidHandler)$(this.currentForm).bind("invalid-form.validate",this.settings.invalidHandler);},form:function(){this.checkForm();$.extend(this.submitted,this.errorMap);this.invalid=$.extend({},this.errorMap);if(!this.valid())$(this.currentForm).triggerHandler("invalid-form",[this]);this.showErrors();return this.valid();},checkForm:function(){this.prepareForm();for(var i=0,elements=(this.currentElements=this.elements());elements[i];i++){this.check(elements[i]);}return this.valid();},element:function(element){element=this.clean(element);this.lastElement=element;this.prepareElement(element);this.currentElements=$(element);var result=this.check(element);if(result){delete this.invalid[element.name];}else{this.invalid[element.name]=true;}if(!this.numberOfInvalids()){this.toHide=this.toHide.add(this.containers);}this.showErrors();return result;},showErrors:function(errors){if(errors){$.extend(this.errorMap,errors);this.errorList=[];for(var name in errors){this.errorList.push({message:errors[name],element:this.findByName(name)[0]});}this.successList=$.grep(this.successList,function(element){return!(element.name in errors);});}this.settings.showErrors?this.settings.showErrors.call(this,this.errorMap,this.errorList):this.defaultShowErrors();},resetForm:function(){if($.fn.resetForm)$(this.currentForm).resetForm();this.submitted={};this.prepareForm();this.hideErrors();this.elements().removeClass(this.settings.errorClass);},numberOfInvalids:function(){return this.objectLength(this.invalid);},objectLength:function(obj){var count=0;for(var i in obj)count++;return count;},hideErrors:function(){this.addWrapper(this.toHide).hide();},valid:function(){return this.size()==0;},size:function(){return this.errorList.length;},focusInvalid:function(){if(this.settings.focusInvalid){try{$(this.findLastActive()||this.errorList.length&&this.errorList[0].element||[]).filter(":visible").focus().trigger("focusin");}catch(e){}}},findLastActive:function(){var lastActive=this.lastActive;return lastActive&&$.grep(this.errorList,function(n){return n.element.name==lastActive.name;}).length==1&&lastActive;},elements:function(){var validator=this,rulesCache={};return $([]).add(this.currentForm.elements).filter(":input").not(":submit, :reset, :image, [disabled]").not(this.settings.ignore).filter(function(){!this.name&&validator.settings.debug&&window.console&&console.error("%o has no name assigned",this);if(this.name in rulesCache||!validator.objectLength($(this).rules()))return false;rulesCache[this.name]=true;return true;});},clean:function(selector){return $(selector)[0];},errors:function(){return $(this.settings.errorElement+"."+this.settings.errorClass,this.errorContext);},reset:function(){this.successList=[];this.errorList=[];this.errorMap={};this.toShow=$([]);this.toHide=$([]);this.currentElements=$([]);},prepareForm:function(){this.reset();this.toHide=this.errors().add(this.containers);},prepareElement:function(element){this.reset();this.toHide=this.errorsFor(element);},check:function(element){element=this.clean(element);if(this.checkable(element)){element=this.findByName(element.name)[0];}var rules=$(element).rules();var dependencyMismatch=false;for(method in rules){var rule={method:method,parameters:rules[method]};try{var result=$.validator.methods[method].call(this,element.value.replace(/\r/g,""),element,rule.parameters);if(result=="dependency-mismatch"){dependencyMismatch=true;continue;}dependencyMismatch=false;if(result=="pending"){this.toHide=this.toHide.not(this.errorsFor(element));return;}if(!result){this.formatAndAdd(element,rule);return false;}}catch(e){this.settings.debug&&window.console&&console.log("exception occured when checking element "+element.id
+", check the '"+rule.method+"' method",e);throw e;}}if(dependencyMismatch)return;if(this.objectLength(rules))this.successList.push(element);return true;},customMetaMessage:function(element,method){if(!$.metadata)return;var meta=this.settings.meta?$(element).metadata()[this.settings.meta]:$(element).metadata();return meta&&meta.messages&&meta.messages[method];},customMessage:function(name,method){var m=this.settings.messages[name];return m&&(m.constructor==String?m:m[method]);},findDefined:function(){for(var i=0;i<arguments.length;i++){if(arguments[i]!==undefined)return arguments[i];}return undefined;},defaultMessage:function(element,method){return this.findDefined(this.customMessage(element.name,method),this.customMetaMessage(element,method),!this.settings.ignoreTitle&&element.title||undefined,$.validator.messages[method],"<strong>Warning: No message defined for "+element.name+"</strong>");},formatAndAdd:function(element,rule){var message=this.defaultMessage(element,rule.method),theregex=/\$?\{(\d+)\}/g;if(typeof message=="function"){message=message.call(this,rule.parameters,element);}else if(theregex.test(message)){message=jQuery.format(message.replace(theregex,'{$1}'),rule.parameters);}this.errorList.push({message:message,element:element});this.errorMap[element.name]=message;this.submitted[element.name]=message;},addWrapper:function(toToggle){if(this.settings.wrapper)toToggle=toToggle.add(toToggle.parent(this.settings.wrapper));return toToggle;},defaultShowErrors:function(){for(var i=0;this.errorList[i];i++){var error=this.errorList[i];this.settings.highlight&&this.settings.highlight.call(this,error.element,this.settings.errorClass,this.settings.validClass);this.showLabel(error.element,error.message);}if(this.errorList.length){this.toShow=this.toShow.add(this.containers);}if(this.settings.success){for(var i=0;this.successList[i];i++){this.showLabel(this.successList[i]);}}if(this.settings.unhighlight){for(var i=0,elements=this.validElements();elements[i];i++){this.settings.unhighlight.call(this,elements[i],this.settings.errorClass,this.settings.validClass);}}this.toHide=this.toHide.not(this.toShow);this.hideErrors();this.addWrapper(this.toShow).show();},validElements:function(){return this.currentElements.not(this.invalidElements());},invalidElements:function(){return $(this.errorList).map(function(){return this.element;});},showLabel:function(element,message){var label=this.errorsFor(element);if(label.length){label.removeClass().addClass(this.settings.errorClass);label.attr("generated")&&label.html(message);}else{label=$("<"+this.settings.errorElement+"/>").attr({"for":this.idOrName(element),generated:true}).addClass(this.settings.errorClass).html(message||"");if(this.settings.wrapper){label=label.hide().show().wrap("<"+this.settings.wrapper+"/>").parent();}if(!this.labelContainer.append(label).length)this.settings.errorPlacement?this.settings.errorPlacement(label,$(element)):label.insertAfter(element);}if(!message&&this.settings.success){label.text("");typeof this.settings.success=="string"?label.addClass(this.settings.success):this.settings.success(label);}this.toShow=this.toShow.add(label);},errorsFor:function(element){var name=this.idOrName(element);return this.errors().filter(function(){return $(this).attr('for')==name;});},idOrName:function(element){return this.groups[element.name]||(this.checkable(element)?element.name:element.id||element.name);},checkable:function(element){return/radio|checkbox/i.test(element.type);},findByName:function(name){var form=this.currentForm;return $(document.getElementsByName(name)).map(function(index,element){return element.form==form&&element.name==name&&element||null;});},getLength:function(value,element){switch(element.nodeName.toLowerCase()){case'select':return $("option:selected",element).length;case'input':if(this.checkable(element))return this.findByName(element.name).filter(':checked').length;}return value.length;},depend:function(param,element){return this.dependTypes[typeof param]?this.dependTypes[typeof param](param,element):true;},dependTypes:{"boolean":function(param,element){return param;},"string":function(param,element){return!!$(param,element.form).length;},"function":function(param,element){return param(element);}},optional:function(element){return!$.validator.methods.required.call(this,$.trim(element.value),element)&&"dependency-mismatch";},startRequest:function(element){if(!this.pending[element.name]){this.pendingRequest++;this.pending[element.name]=true;}},stopRequest:function(element,valid){this.pendingRequest--;if(this.pendingRequest<0)this.pendingRequest=0;delete this.pending[element.name];if(valid&&this.pendingRequest==0&&this.formSubmitted&&this.form()){$(this.currentForm).submit();this.formSubmitted=false;}else if(!valid&&this.pendingRequest==0&&this.formSubmitted){$(this.currentForm).triggerHandler("invalid-form",[this]);this.formSubmitted=false;}},previousValue:function(element){return $.data(element,"previousValue")||$.data(element,"previousValue",{old:null,valid:true,message:this.defaultMessage(element,"remote")});}},classRuleSettings:{required:{required:true},email:{email:true},url:{url:true},date:{date:true},dateISO:{dateISO:true},dateDE:{dateDE:true},number:{number:true},numberDE:{numberDE:true},digits:{digits:true},creditcard:{creditcard:true}},addClassRules:function(className,rules){className.constructor==String?this.classRuleSettings[className]=rules:$.extend(this.classRuleSettings,className);},classRules:function(element){var rules={};var classes=$(element).attr('class');classes&&$.each(classes.split(' '),function(){if(this in $.validator.classRuleSettings){$.extend(rules,$.validator.classRuleSettings[this]);}});return rules;},attributeRules:function(element){var rules={};var $element=$(element);for(method in $.validator.methods){var value=$element.attr(method);if(value){rules[method]=value;}}if(rules.maxlength&&/-1|2147483647|524288/.test(rules.maxlength)){delete rules.maxlength;}return rules;},metadataRules:function(element){if(!$.metadata)return{};var meta=$.data(element.form,'validator').settings.meta;return meta?$(element).metadata()[meta]:$(element).metadata();},staticRules:function(element){var rules={};var validator=$.data(element.form,'validator');if(validator.settings.rules){rules=$.validator.normalizeRule(validator.settings.rules[element.name])||{};}return rules;},normalizeRules:function(rules,element){$.each(rules,function(prop,val){if(val===false){delete rules[prop];return;}if(val.param||val.depends){var keepRule=true;switch(typeof val.depends){case"string":keepRule=!!$(val.depends,element.form).length;break;case"function":keepRule=val.depends.call(element,element);break;}if(keepRule){rules[prop]=val.param!==undefined?val.param:true;}else{delete rules[prop];}}});$.each(rules,function(rule,parameter){rules[rule]=$.isFunction(parameter)?parameter(element):parameter;});$.each(['minlength','maxlength','min','max'],function(){if(rules[this]){rules[this]=Number(rules[this]);}});$.each(['rangelength','range'],function(){if(rules[this]){rules[this]=[Number(rules[this][0]),Number(rules[this][1])];}});if($.validator.autoCreateRanges){if(rules.min&&rules.max){rules.range=[rules.min,rules.max];delete rules.min;delete rules.max;}if(rules.minlength&&rules.maxlength){rules.rangelength=[rules.minlength,rules.maxlength];delete rules.minlength;delete rules.maxlength;}}if(rules.messages){delete rules.messages;}return rules;},normalizeRule:function(data){if(typeof data=="string"){var transformed={};$.each(data.split(/\s/),function(){transformed[this]=true;});data=transformed;}return data;},addMethod:function(name,method,message){$.validator.methods[name]=method;$.validator.messages[name]=message!=undefined?message:$.validator.messages[name];if(method.length<3){$.validator.addClassRules(name,$.validator.normalizeRule(name));}},methods:{required:function(value,element,param){if(!this.depend(param,element))return"dependency-mismatch";switch(element.nodeName.toLowerCase()){case'select':var val=$(element).val();return val&&val.length>0;case'input':if(this.checkable(element))return this.getLength(value,element)>0;default:return $.trim(value).length>0;}},remote:function(value,element,param){if(this.optional(element))return"dependency-mismatch";var previous=this.previousValue(element);if(!this.settings.messages[element.name])this.settings.messages[element.name]={};previous.originalMessage=this.settings.messages[element.name].remote;this.settings.messages[element.name].remote=previous.message;param=typeof param=="string"&&{url:param}||param;if(previous.old!==value){previous.old=value;var validator=this;this.startRequest(element);var data={};data[element.name]=value;$.ajax($.extend(true,{url:param,mode:"abort",port:"validate"+element.name,dataType:"json",data:data,success:function(response){validator.settings.messages[element.name].remote=previous.originalMessage;var valid=response===true;if(valid){var submitted=validator.formSubmitted;validator.prepareElement(element);validator.formSubmitted=submitted;validator.successList.push(element);validator.showErrors();}else{var errors={};var message=(previous.message=response||validator.defaultMessage(element,"remote"));errors[element.name]=$.isFunction(message)?message(value):message;validator.showErrors(errors);}previous.valid=valid;validator.stopRequest(element,valid);}},param));return"pending";}else if(this.pending[element.name]){return"pending";}return previous.valid;},minlength:function(value,element,param){return this.optional(element)||this.getLength($.trim(value),element)>=param;},maxlength:function(value,element,param){return this.optional(element)||this.getLength($.trim(value),element)<=param;},rangelength:function(value,element,param){var length=this.getLength($.trim(value),element);return this.optional(element)||(length>=param[0]&&length<=param[1]);},min:function(value,element,param){return this.optional(element)||value>=param;},max:function(value,element,param){return this.optional(element)||value<=param;},range:function(value,element,param){return this.optional(element)||(value>=param[0]&&value<=param[1]);},email:function(value,element){return this.optional(element)||/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i.test(value);},url:function(value,element){return this.optional(element)||/^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(value);},date:function(value,element){return this.optional(element)||!/Invalid|NaN/.test(new Date(value));},dateISO:function(value,element){return this.optional(element)||/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}$/.test(value);},number:function(value,element){return this.optional(element)||/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/.test(value);},digits:function(value,element){return this.optional(element)||/^\d+$/.test(value);},creditcard:function(value,element){if(this.optional(element))return"dependency-mismatch";if(/[^0-9-]+/.test(value))return false;var nCheck=0,nDigit=0,bEven=false;value=value.replace(/\D/g,"");for(var n=value.length-1;n>=0;n--){var cDigit=value.charAt(n);var nDigit=parseInt(cDigit,10);if(bEven){if((nDigit*=2)>9)nDigit-=9;}nCheck+=nDigit;bEven=!bEven;}return(nCheck%10)==0;},accept:function(value,element,param){param=typeof param=="string"?param.replace(/,/g,'|'):"png|jpe?g|gif";return this.optional(element)||value.match(new RegExp(".("+param+")$","i"));},equalTo:function(value,element,param){var target=$(param).unbind(".validate-equalTo").bind("blur.validate-equalTo",function(){$(element).valid();});return value==target.val();}}});$.format=$.validator.format;})(jQuery);;(function($){var ajax=$.ajax;var pendingRequests={};$.ajax=function(settings){settings=$.extend(settings,$.extend({},$.ajaxSettings,settings));var port=settings.port;if(settings.mode=="abort"){if(pendingRequests[port]){pendingRequests[port].abort();}return(pendingRequests[port]=ajax.apply(this,arguments));}return ajax.apply(this,arguments);};})(jQuery);;(function($){if(!jQuery.event.special.focusin&&!jQuery.event.special.focusout&&document.addEventListener){$.each({focus:'focusin',blur:'focusout'},function(original,fix){$.event.special[fix]={setup:function(){this.addEventListener(original,handler,true);},teardown:function(){this.removeEventListener(original,handler,true);},handler:function(e){arguments[0]=$.event.fix(e);arguments[0].type=fix;return $.event.handle.apply(this,arguments);}};function handler(e){e=$.event.fix(e);e.type=fix;return $.event.handle.call(this,e);}});};$.extend($.fn,{validateDelegate:function(delegate,type,handler){return this.bind(type,function(event){var target=$(event.target);if(target.is(delegate)){return handler.apply(target,arguments);}});}});})(jQuery);
/* google prettify.js from google code */
var q=null;window.PR_SHOULD_USE_CONTINUATION=!0;
(function () {function L(a) {function m(a) {var f=a.charCodeAt(0);if(f!==92)return f;var b=a.charAt(1);return(f=r[b])?f:'0'<=b&&b<="7"?parseInt(a.substring(1),8):b==="u"||b==="x"?parseInt(a.substring(2),16):a.charCodeAt(1)}function e(a) {if(a<32)return(a<16?"\\x0":"\\x")+a.toString(16);a=String.fromCharCode(a);if(a==="\\"||a==="-"||a==="["||a==="]")a="\\"+a;return a}function h(a) {for(var f=a.substring(1,a.length-1).match(/\\u[\dA-Fa-f]{4}|\\x[\dA-Fa-f]{2}|\\[0-3][0-7]{0,2}|\\[0-7]{1,2}|\\[\S\s]|[^\\]/g),a=
[],b=[],o=f[0]==="^",c=o?1:0,i=f.length;c<i;++c) {var j=f[c];if(/\\[bdsw]/i.test(j))a.push(j);else{var j=m(j),d;c+2<i&&"-"===f[c+1]?(d=m(f[c+2]),c+=2):d=j;b.push([j,d]);d<65||j>122||(d<65||j>90||b.push([Math.max(65,j)|32,Math.min(d,90)|32]),d<97||j>122||b.push([Math.max(97,j)&-33,Math.min(d,122)&-33]))}}b.sort(function (a,f) {return a[0]-f[0]||f[1]-a[1]});f=[];j=[NaN,NaN];for(c=0;c<b.length;++c)i=b[c],i[0]<=j[1]+1?j[1]=Math.max(j[1],i[1]):f.push(j=i);b=["["];o&&b.push("^");b.push.apply(b,a);for(c=0;c<
f.length;++c)i=f[c],b.push(e(i[0])),i[1]>i[0]&&(i[1]+1>i[0]&&b.push("-"),b.push(e(i[1])));b.push("]");return b.join("")}function y(a) {for(var f=a.source.match(/\[(?:[^\\\]]|\\[\S\s])*]|\\u[\dA-Fa-f]{4}|\\x[\dA-Fa-f]{2}|\\\d+|\\[^\dux]|\(\?[!:=]|[()^]|[^()[\\^]+/g),b=f.length,d=[],c=0,i=0;c<b;++c) {var j=f[c];j==='('?++i:"\\"===j.charAt(0)&&(j=+j.substring(1))&&j<=i&&(d[j]=-1)}for(c=1;c<d.length;++c)-1===d[c]&&(d[c]=++t);for(i=c=0;c<b;++c)j=f[c],j==="("?(++i,d[i]===void 0&&(f[c]="(?:")):"\\"===j.charAt(0)&&
(j=+j.substring(1))&&j<=i&&(f[c]="\\"+d[i]);for(i=c=0;c<b;++c)"^"===f[c]&&"^"!==f[c+1]&&(f[c]="");if(a.ignoreCase&&s)for(c=0;c<b;++c)j=f[c],a=j.charAt(0),j.length>=2&&a==="["?f[c]=h(j):a!=="\\"&&(f[c]=j.replace(/[A-Za-z]/g,function (a) {a=a.charCodeAt(0);return"["+String.fromCharCode(a&-33,a|32)+"]"}));return f.join("")}for(var t=0,s=!1,l=!1,p=0,d=a.length;p<d;++p) {var g=a[p];if(g.ignoreCase)l=!0;else if(/[a-z]/i.test(g.source.replace(/\\u[\da-f]{4}|\\x[\da-f]{2}|\\[^UXux]/gi,""))) {s=!0;l=!1;break}}for(var r=
{b:8,t:9,n:10,v:11,f:12,r:13},n=[],p=0,d=a.length;p<d;++p) {g=a[p];if(g.global||g.multiline)throw Error(""+g);n.push("(?:"+y(g)+')')}return RegExp(n.join("|"),l?"gi":"g")}function M(a) {function m(a) {switch(a.nodeType) {case 1:if(e.test(a.className))break;for(var g=a.firstChild;g;g=g.nextSibling)m(g);g=a.nodeName;if("BR"===g||"LI"===g)h[s]="\n",t[s<<1]=y++,t[s++<<1|1]=a;break;case 3:case 4:g=a.nodeValue,g.length&&(g=p?g.replace(/\r\n?/g,"\n"):g.replace(/[\t\n\r ]+/g," "),h[s]=g,t[s<<1]=y,y+=g.length,
t[s++<<1|1]=a)}}var e=/(?:^|\s)nocode(?:\s|$)/,h=[],y=0,t=[],s=0,l;a.currentStyle?l=a.currentStyle.whiteSpace:window.getComputedStyle&&(l=document.defaultView.getComputedStyle(a,q).getPropertyValue("white-space"));var p=l&&"pre"===l.substring(0,3);m(a);return{a:h.join("").replace(/\n$/,""),c:t}}function B(a,m,e,h) {m&&(a={a:m,d:a},e(a),h.push.apply(h,a.e))}function x(a,m) {function e(a) {for(var l=a.d,p=[l,"pln"],d=0,g=a.a.match(y)||[],r={},n=0,z=g.length;n<z;++n) {var f=g[n],b=r[f],o=void 0,c;if(typeof b===
"string")c=!1;else{var i=h[f.charAt(0)];if(i)o=f.match(i[1]),b=i[0];else{for(c=0;c<t;++c)if(i=m[c],o=f.match(i[1])) {b=i[0];break}o||(b="pln")}if((c=b.length>=5&&"lang-"===b.substring(0,5))&&!(o&&typeof o[1]==="string"))c=!1,b="src";c||(r[f]=b)}i=d;d+=f.length;if(c) {c=o[1];var j=f.indexOf(c),k=j+c.length;o[2]&&(k=f.length-o[2].length,j=k-c.length);b=b.substring(5);B(l+i,f.substring(0,j),e,p);B(l+i+j,c,C(b,c),p);B(l+i+k,f.substring(k),e,p)}else p.push(l+i,b)}a.e=p}var h={},y;(function () {for(var e=a.concat(m),
l=[],p={},d=0,g=e.length;d<g;++d) {var r=e[d],n=r[3];if(n)for(var k=n.length;--k>=0;)h[n.charAt(k)]=r;r=r[1];n=""+r;p.hasOwnProperty(n)||(l.push(r),p[n]=q)}l.push(/[\S\s]/);y=L(l)})();var t=m.length;return e}function u(a) {var m=[],e=[];a.tripleQuotedStrings?m.push(["str",/^(?:'''(?:[^'\\]|\\[\S\s]|''?(?=[^']))*(?:'''|$)|"""(?:[^"\\]|\\[\S\s]|""?(?=[^"]))*(?:"""|$)|'(?:[^'\\]|\\[\S\s])*(?:'|$)|"(?:[^"\\]|\\[\S\s])*(?:"|$))/,q,"'\""]):a.multiLineStrings?m.push(["str",/^(?:'(?:[^'\\]|\\[\S\s])*(?:'|$)|"(?:[^"\\]|\\[\S\s])*(?:"|$)|`(?:[^\\`]|\\[\S\s])*(?:`|$))/,
q,"'\"`"]):m.push(["str",/^(?:'(?:[^\n\r'\\]|\\.)*(?:'|$)|"(?:[^\n\r"\\]|\\.)*(?:"|$))/,q,"\"'"]);a.verbatimStrings&&e.push(["str",/^@"(?:[^"]|"")*(?:"|$)/,q]);var h=a.hashComments;h&&(a.cStyleComments?(h>1?m.push(["com",/^#(?:##(?:[^#]|#(?!##))*(?:###|$)|.*)/,q,"#"]):m.push(["com",/^#(?:(?:define|elif|else|endif|error|ifdef|include|ifndef|line|pragma|undef|warning)\b|[^\n\r]*)/,q,"#"]),e.push(["str",/^<(?:(?:(?:\.\.\/)*|\/?)(?:[\w-]+(?:\/[\w-]+)+)?[\w-]+\.h|[a-z]\w*)>/,q])):m.push(["com",/^#[^\n\r]*/,
q,"#"]));a.cStyleComments&&(e.push(["com",/^\/\/[^\n\r]*/,q]),e.push(["com",/^\/\*[\S\s]*?(?:\*\/|$)/,q]));a.regexLiterals&&e.push(["lang-regex",/^(?:^^\.?|[!+-]|!=|!==|#|%|%=|&|&&|&&=|&=|\(|\*|\*=|\+=|,|-=|->|\/|\/=|:|::|;|<|<<|<<=|<=|=|==|===|>|>=|>>|>>=|>>>|>>>=|[?@[^]|\^=|\^\^|\^\^=|{|\||\|=|\|\||\|\|=|~|break|case|continue|delete|do|else|finally|instanceof|return|throw|try|typeof)\s*(\/(?=[^*/])(?:[^/[\\]|\\[\S\s]|\[(?:[^\\\]]|\\[\S\s])*(?:]|$))+\/)/]);(h=a.types)&&e.push(["typ",h]);a=(""+a.keywords).replace(/^ | $/g,
"");a.length&&e.push(["kwd",RegExp("^(?:"+a.replace(/[\s,]+/g,"|")+")\\b"),q]);m.push(["pln",/^\s+/,q," \r\n\t\xa0"]);e.push(["lit",/^@[$_a-z][\w$@]*/i,q],["typ",/^(?:[@_]?[A-Z]+[a-z][\w$@]*|\w+_t\b)/,q],["pln",/^[$_a-z][\w$@]*/i,q],["lit",/^(?:0x[\da-f]+|(?:\d(?:_\d+)*\d*(?:\.\d*)?|\.\d\+)(?:e[+-]?\d+)?)[a-z]*/i,q,"0123456789"],["pln",/^\\[\S\s]?/,q],["pun",/^.[^\s\w"-$'./@\\`]*/,q]);return x(m,e)}function D(a,m) {function e(a) {switch(a.nodeType) {case 1:if(k.test(a.className))break;if("BR"===a.nodeName)h(a),
a.parentNode&&a.parentNode.removeChild(a);else for(a=a.firstChild;a;a=a.nextSibling)e(a);break;case 3:case 4:if(p) {var b=a.nodeValue,d=b.match(t);if(d) {var c=b.substring(0,d.index);a.nodeValue=c;(b=b.substring(d.index+d[0].length))&&a.parentNode.insertBefore(s.createTextNode(b),a.nextSibling);h(a);c||a.parentNode.removeChild(a)}}}}function h(a) {function b(a,d) {var e=d?a.cloneNode(!1):a,f=a.parentNode;if(f) {var f=b(f,1),g=a.nextSibling;f.appendChild(e);for(var h=g;h;h=g)g=h.nextSibling,f.appendChild(h)}return e}
for(;!a.nextSibling;)if(a=a.parentNode,!a)return;for(var a=b(a.nextSibling,0),e;(e=a.parentNode)&&e.nodeType===1;)a=e;d.push(a)}var k=/(?:^|\s)nocode(?:\s|$)/,t=/\r\n?|\n/,s=a.ownerDocument,l;a.currentStyle?l=a.currentStyle.whiteSpace:window.getComputedStyle&&(l=s.defaultView.getComputedStyle(a,q).getPropertyValue("white-space"));var p=l&&"pre"===l.substring(0,3);for(l=s.createElement("LI");a.firstChild;)l.appendChild(a.firstChild);for(var d=[l],g=0;g<d.length;++g)e(d[g]);m===(m|0)&&d[0].setAttribute("value",
m);var r=s.createElement("OL");r.className="linenums";for(var n=Math.max(0,m-1|0)||0,g=0,z=d.length;g<z;++g)l=d[g],l.className="L"+(g+n)%10,l.firstChild||l.appendChild(s.createTextNode("\xa0")),r.appendChild(l);a.appendChild(r)}function k(a,m) {for(var e=m.length;--e>=0;) {var h=m[e];A.hasOwnProperty(h)?window.console&&console.warn("cannot override language handler %s",h):A[h]=a}}function C(a,m) {if(!a||!A.hasOwnProperty(a))a=/^\s*</.test(m)?"default-markup":"default-code";return A[a]}function E(a) {var m=
a.g;try{var e=M(a.h),h=e.a;a.a=h;a.c=e.c;a.d=0;C(m,h)(a);var k=/\bMSIE\b/.test(navigator.userAgent),m=/\n/g,t=a.a,s=t.length,e=0,l=a.c,p=l.length,h=0,d=a.e,g=d.length,a=0;d[g]=s;var r,n;for(n=r=0;n<g;)d[n]!==d[n+2]?(d[r++]=d[n++],d[r++]=d[n++]):n+=2;g=r;for(n=r=0;n<g;) {for(var z=d[n],f=d[n+1],b=n+2;b+2<=g&&d[b+1]===f;)b+=2;d[r++]=z;d[r++]=f;n=b}for(d.length=r;h<p;) {var o=l[h+2]||s,c=d[a+2]||s,b=Math.min(o,c),i=l[h+1],j;if(i.nodeType!==1&&(j=t.substring(e,b))) {k&&(j=j.replace(m,"\r"));i.nodeValue=
j;var u=i.ownerDocument,v=u.createElement("SPAN");v.className=d[a+1];var x=i.parentNode;x.replaceChild(v,i);v.appendChild(i);e<o&&(l[h+1]=i=u.createTextNode(t.substring(b,o)),x.insertBefore(i,v.nextSibling))}e=b;e>=o&&(h+=2);e>=c&&(a+=2)}}catch(w) {"console"in window&&console.log(w&&w.stack?w.stack:w)}}var v=["break,continue,do,else,for,if,return,while"],w=[[v,"auto,case,char,const,default,double,enum,extern,float,goto,int,long,register,short,signed,sizeof,static,struct,switch,typedef,union,unsigned,void,volatile"],
"catch,class,delete,false,import,new,operator,private,protected,public,this,throw,true,try,typeof"],F=[w,"alignof,align_union,asm,axiom,bool,concept,concept_map,const_cast,constexpr,decltype,dynamic_cast,explicit,export,friend,inline,late_check,mutable,namespace,nullptr,reinterpret_cast,static_assert,static_cast,template,typeid,typename,using,virtual,where"],G=[w,"abstract,boolean,byte,extends,final,finally,implements,import,instanceof,null,native,package,strictfp,super,synchronized,throws,transient"],
H=[G,"as,base,by,checked,decimal,delegate,descending,dynamic,event,fixed,foreach,from,group,implicit,in,interface,internal,into,is,lock,object,out,override,orderby,params,partial,readonly,ref,sbyte,sealed,stackalloc,string,select,uint,ulong,unchecked,unsafe,ushort,var"],w=[w,"debugger,eval,export,function,get,null,set,undefined,var,with,Infinity,NaN"],I=[v,"and,as,assert,class,def,del,elif,except,exec,finally,from,global,import,in,is,lambda,nonlocal,not,or,pass,print,raise,try,with,yield,False,True,None"],
J=[v,"alias,and,begin,case,class,def,defined,elsif,end,ensure,false,in,module,next,nil,not,or,redo,rescue,retry,self,super,then,true,undef,unless,until,when,yield,BEGIN,END"],v=[v,"case,done,elif,esac,eval,fi,function,in,local,set,then,until"],K=/^(DIR|FILE|vector|(de|priority_)?queue|list|stack|(const_)?iterator|(multi)?(set|map)|bitset|u?(int|float)\d*)/,N=/\S/,O=u({keywords:[F,H,w,"caller,delete,die,do,dump,elsif,eval,exit,foreach,for,goto,if,import,last,local,my,next,no,our,print,package,redo,require,sub,undef,unless,until,use,wantarray,while,BEGIN,END"+
I,J,v],hashComments:!0,cStyleComments:!0,multiLineStrings:!0,regexLiterals:!0}),A={};k(O,["default-code"]);k(x([],[["pln",/^[^<?]+/],["dec",/^<!\w[^>]*(?:>|$)/],["com",/^<\!--[\S\s]*?(?:--\>|$)/],["lang-",/^<\?([\S\s]+?)(?:\?>|$)/],["lang-",/^<%([\S\s]+?)(?:%>|$)/],["pun",/^(?:<[%?]|[%?]>)/],["lang-",/^<xmp\b[^>]*>([\S\s]+?)<\/xmp\b[^>]*>/i],["lang-js",/^<script\b[^>]*>([\S\s]*?)(<\/script\b[^>]*>)/i],["lang-css",/^<style\b[^>]*>([\S\s]*?)(<\/style\b[^>]*>)/i],["lang-in.tag",/^(<\/?[a-z][^<>]*>)/i]]),
["default-markup","htm","html","mxml","xhtml","xml","xsl"]);k(x([["pln",/^\s+/,q," \t\r\n"],["atv",/^(?:"[^"]*"?|'[^']*'?)/,q,"\"'"]],[["tag",/^^<\/?[a-z](?:[\w-.:]*\w)?|\/?>$/i],["atn",/^(?!style[\s=]|on)[a-z](?:[\w:-]*\w)?/i],["lang-uq.val",/^=\s*([^\s"'>]*(?:[^\s"'/>]|\/(?=\s)))/],["pun",/^[/<->]+/],["lang-js",/^on\w+\s*=\s*"([^"]+)"/i],["lang-js",/^on\w+\s*=\s*'([^']+)'/i],["lang-js",/^on\w+\s*=\s*([^\s"'>]+)/i],["lang-css",/^style\s*=\s*"([^"]+)"/i],["lang-css",/^style\s*=\s*'([^']+)'/i],["lang-css",
/^style\s*=\s*([^\s"'>]+)/i]]),["in.tag"]);k(x([],[["atv",/^[\S\s]+/]]),["uq.val"]);k(u({keywords:F,hashComments:!0,cStyleComments:!0,types:K}),["c","cc","cpp","cxx","cyc","m"]);k(u({keywords:"null,true,false"}),["json"]);k(u({keywords:H,hashComments:!0,cStyleComments:!0,verbatimStrings:!0,types:K}),["cs"]);k(u({keywords:G,cStyleComments:!0}),["java"]);k(u({keywords:v,hashComments:!0,multiLineStrings:!0}),["bsh","csh","sh"]);k(u({keywords:I,hashComments:!0,multiLineStrings:!0,tripleQuotedStrings:!0}),
["cv","py"]);k(u({keywords:"caller,delete,die,do,dump,elsif,eval,exit,foreach,for,goto,if,import,last,local,my,next,no,our,print,package,redo,require,sub,undef,unless,until,use,wantarray,while,BEGIN,END",hashComments:!0,multiLineStrings:!0,regexLiterals:!0}),["perl","pl","pm"]);k(u({keywords:J,hashComments:!0,multiLineStrings:!0,regexLiterals:!0}),["rb"]);k(u({keywords:w,cStyleComments:!0,regexLiterals:!0}),["js"]);k(u({keywords:"all,and,by,catch,class,else,extends,false,finally,for,if,in,is,isnt,loop,new,no,not,null,of,off,on,or,return,super,then,true,try,unless,until,when,while,yes",
hashComments:3,cStyleComments:!0,multilineStrings:!0,tripleQuotedStrings:!0,regexLiterals:!0}),["coffee"]);k(x([],[["str",/^[\S\s]+/]]),["regex"]);window.prettyPrintOne=function (a,m,e) {var h=document.createElement("PRE");h.innerHTML=a;e&&D(h,e);E({g:m,i:e,h:h});return h.innerHTML};window.prettyPrint=function (a) {function m() {for(var e=window.PR_SHOULD_USE_CONTINUATION?l.now()+250:Infinity;p<h.length&&l.now()<e;p++) {var n=h[p],k=n.className;if(k.indexOf("prettyprint")>=0) {var k=k.match(g),f,b;if(b=
!k) {b=n;for(var o=void 0,c=b.firstChild;c;c=c.nextSibling)var i=c.nodeType,o=i===1?o?b:c:i===3?N.test(c.nodeValue)?b:o:o;b=(f=o===b?void 0:o)&&"CODE"===f.tagName}b&&(k=f.className.match(g));k&&(k=k[1]);b=!1;for(o=n.parentNode;o;o=o.parentNode)if((o.tagName==="pre"||o.tagName==="code"||o.tagName==="xmp")&&o.className&&o.className.indexOf("prettyprint")>=0) {b=!0;break}b||((b=(b=n.className.match(/\blinenums\b(?::(\d+))?/))?b[1]&&b[1].length?+b[1]:!0:!1)&&D(n,b),d={g:k,h:n,i:b},E(d))}}p<h.length?setTimeout(m,
250):a&&a()}for(var e=[document.getElementsByTagName("pre"),document.getElementsByTagName("code"),document.getElementsByTagName("xmp")],h=[],k=0;k<e.length;++k)for(var t=0,s=e[k].length;t<s;++t)h.push(e[k][t]);var e=q,l=Date;l.now||(l={now:function () {return+new Date}});var p=0,d,g=/\blang(?:uage)?-([\w.]+)(?!\S)/;m()};window.PR={createSimpleLexer:x,registerLangHandler:k,sourceDecorator:u,PR_ATTRIB_NAME:"atn",PR_ATTRIB_VALUE:"atv",PR_COMMENT:"com",PR_DECLARATION:"dec",PR_KEYWORD:"kwd",PR_LITERAL:"lit",
PR_NOCODE:"nocode",PR_PLAIN:"pln",PR_PUNCTUATION:"pun",PR_SOURCE:"src",PR_STRING:"str",PR_TAG:"tag",PR_TYPE:"typ"}})();

var Toggle = function() {
    this._state = 'off-state';
    this._messages = {};
    this._states = [
        'on-state',
        'off-state',
        'on-prompt',
        'off-prompt'
    ];
};
inherits(Toggle, SimpleControl);

Toggle.prototype.resetStyles = function () {
    var element = this._element;
    var states = this._states;
    $.each(states, function (idx, state) {
        element.removeClass(state);
    });
    this.setText('');
};

Toggle.prototype.isOn = function () {
    return this._element.data('isOn');
};

Toggle.prototype.isCheckBox = function () {
    var element = this._element;
    return element.attr('type') === 'checkbox';
};

Toggle.prototype.setState = function (state) {
    var element = this._element;
    var oldState = this._state;
    this._state = state;
    if (element) {
        this.resetStyles();
        element.addClass(state);
        if (state === 'on-state') {
            element.data('isOn', true);
        } else if (state === 'off-state') {
            element.data('isOn', false);
        }
        if (this.isCheckBox()) {
            if (state === 'on-state') {
                element.attr('checked', true);
            } else if (state === 'off-state') {
                element.attr('checked', false);
            }
        } else {
            this.setText(this._messages[state]);
        }
        this._element.trigger(
            'askbot.Toggle.stateChange',
            {'oldState': oldState, 'newState': state}
        );
    }
};

Toggle.prototype.toggleState = function () {
    if (this.isOn()) {
        this.setState('off-state');
    } else {
        this.setState('on-state');
    }
};

Toggle.prototype.setText = function (text) {
    var btnText = this._element.find('.js-btn-text');
    var where  = btnText.length ? btnText : this._element;
    where.html(text);
};

Toggle.prototype.setMessages = function(messages) {
    $.extend(this._messages, messages);
};

Toggle.prototype.setMessage = function(state, text) {
    this._messages[state] = text;
};

Toggle.prototype.createDom = function () {
    //limitation is that we make a div with createDom
    var element = this.makeElement('div');
    this._element = element;

    var messages = this._messages || {};

    messages['on-state'] = messages['on-state'] || gettext('enabled');
    messages['off-state'] = messages['off-state'] || gettext('disabled');

    element.data('onStateText', messages['on-state']);
    element.data('offStateText', messages['off-state']);
    element.data('onPromptText', messages['on-prompt'] || messages['off-state']);
    element.data('offPromptText', messages['off-prompt'] || messages['on-state']);

    this.decorate(element);
};

Toggle.prototype.decorate = function (element) {
    this._element = element;
    //read messages for all states
    var messages = {};
    messages['on-state'] = element.data('onStateText') || gettext('enabled');
    messages['off-state'] = element.data('offStateText') || gettext('disabled');
    messages['on-prompt'] = element.data('onPromptText') || messages['off-state'];
    messages['off-prompt'] = element.data('offPromptText') || messages['on-state'];
    this._messages = messages;


    //detect state and save it
    if (this.isCheckBox()) {
        this._state = this._state || (element.is(':checked') ? 'on-state' : 'off-state');
    } else {
        this._state = element.data('isOn') ? 'on-state' : this._state;
    }
    this.setState(this._state);

    //set mouseover handler only for non-checkbox version
    if (this.isCheckBox() === false) {
        var me = this;
        element.mouseover(function () {
            var is_on = me.isOn();
            if (is_on) {
                me.setState('off-prompt');
            } else {
                me.setState('on-prompt');
            }
            return false;
        });
        element.mouseout(function () {
            var is_on = me.isOn();
            if (is_on) {
                me.setState('on-state');
            } else {
                me.setState('off-state');
            }
            return false;
        });
    }

    setupButtonEventHandlers(element, this.getHandler());
};

var ExpanderToggle = function (expandable) {
    Toggle.call(this);
    this.setExpandable(expandable);
    this._handler = this.getExpanderHandler();
};
inherits(ExpanderToggle, Toggle);

ExpanderToggle.prototype.setCollapsed = function (collapsed) {
    if (collapsed) {
        this.setState('off-state');
    } else {
        this.setState('on-state');
    }
};

ExpanderToggle.prototype.setExpandable = function(expandable) {
    this._expandable = expandable;
};

ExpanderToggle.prototype.getExpandable = function() {
    return this._expandable;
};

ExpanderToggle.prototype.getExpanderHandler = function () {
    var me = this;
    return function () {
        me.toggleState();
        var expandable = me.getExpandable();
        if (expandable) {
            if (me.isOn()) {
                expandable.show();
            } else {
                expandable.hide();
            }
        }
    };
};

/*
Scripts for cnprog.com
Project Name: Lanai
All Rights Resevred 2008. CNPROG.COM
*/
var lanai = {
    /**
     * Finds any <pre><code></code></pre> tags which aren't registered for
     * pretty printing, adds the appropriate class name and invokes prettify.
     */
    highlightSyntax: function () {
        var styled = false;
        $('pre code').parent().each(function () {
            if (!$(this).hasClass('prettyprint')) {
                $(this).addClass('prettyprint');
                styled = true;
            }
        });

        if (styled) {
            prettyPrint();
        }
    }
};

//todo: clean-up now there is utils:WaitIcon
function appendLoader(element) {
    loading = gettext('loading...');
    element.append('<img class="ajax-loader" ' +
        'src="' + mediaUrl('media/images/indicator.gif') + '" title="' +
        loading +
        '" alt="' +
        loading +
    '" />');
}

function removeLoader() {
    $('img.ajax-loader').remove();
}

function setSubmitButtonDisabled(form, isDisabled) {
    form.find('input[type="submit"]').attr('disabled', isDisabled);
}

function enableSubmitButton(form) {
    setSubmitButtonDisabled(form, false);
}

function disableSubmitButton(form) {
    setSubmitButtonDisabled(form, true);
}

function setupFormValidation(form, validationRules, validationMessages, onSubmitCallback) {
    enableSubmitButton(form);
    var placementLocation = askbot.settings.errorPlacement;
    var placementClass = placementLocation ? ' ' + placementLocation : '';
    form.validate({
        debug: true,
        rules: (validationRules ? validationRules : {}),
        messages: (validationMessages ? validationMessages : {}),
        errorElement: 'span',
        errorClass: 'form-error' + placementClass,
        highlight: function (element) {
            $(element).closest('.form-group').addClass('has-error');
        },
        unhighlight: function (element) {
            var formGroup = $(element).closest('.form-group');
            formGroup.removeClass('has-error');
            formGroup.find('.form-error').remove();
        },
        errorPlacement: function (error, element) {
            //bs3 error placement
            var label = element.closest('.form-group').find('label');
            if (placementLocation === 'in-label') {
                label.html(error);
                return;
            } else if (placementLocation === 'after-label') {
                var errorLabel = element.closest('.form-group').find('.form-error');
                if (errorLabel.length) {
                    errorLabel.replaceWith(error);
                } else {
                    label.after(error);
                }
                return;
            }

            //old askbot error placement
            var span = element.next().find('.form-error');
            if (span.length === 0) {
                span = element.parent().find('.form-error');
                if (span.length === 0) {
                    //for resizable textarea
                    var element_id = element.attr('id');
                    $('label[for="' + element_id + '"]').after(error);
                }
            } else {
                span.replaceWith(error);
            }
        },
        submitHandler: function (form_dom) {
            disableSubmitButton($(form_dom));

            if (onSubmitCallback) {
                onSubmitCallback(form_dom);
            } else {
                form_dom.submit();
            }
        }
    });
}

var validateTagLength = function (value) {
    var tags = getUniqueWords(value);
    var are_tags_ok = true;
    $.each(tags, function (index, value) {
        if (value.length > askbot.settings.maxTagLength) {
            are_tags_ok = false;
        }
    });
    return are_tags_ok;
};
var validateTagCount = function (value) {
    var tags = getUniqueWords(value);
    return (tags.length <= askbot.settings.maxTagsPerPost);
};

$.validator.addMethod('limit_tag_count', validateTagCount);
$.validator.addMethod('limit_tag_length', validateTagLength);

askbot.validators = askbot.validators || {};

askbot.validators.titleValidator = function (text) {
    text = $.trim(text);
    if (text.length < askbot.settings.minTitleLength) {
        throw interpolate(
                        ngettext(
                            'enter > %(length)s character',
                            'enter > %(length)s characters',
                            askbot.settings.minTitleLength
                        ),
                        {'length': askbot.settings.minTitleLength},
                        true
                    );
    }
};

askbot.validators.questionDetailsValidator = function (text) {
    text = $.trim(text);
    var minLength = askbot.settings.minQuestionBodyLength;
    if (minLength && (text.length < minLength)) {
        /* todo - for tinymce text extract text from html 
            otherwise html tags will be counted and user misled */
        throw interpolate(
                    ngettext(
                        'details must have > %s character',
                        'details must have > %s characters',
                        minLength
                    ),
                    [minLength]
                );
    }
};

askbot.validators.answerValidator = function (text) {
    var minLength = askbot.settings.minAnswerBodyLength;
    var textLength
    text = $.trim(text);
    if (askbot.settings.editorType == 'tinymce') {
        textLength = $('<p>' + text + '</p>').text().length;
    } else {
        textLength = text.length;
    }
    if (minLength && (textLength < minLength)) {
        throw interpolate(
                ngettext(
                    'enter > %(length)s character',
                    'enter > %(length)s characters',
                    minLength
                ),
                {'length': minLength},
                true
            );
    }
};

var CPValidator = (function () {
    return {
        getQuestionFormRules: function () {
            return {
                tags: {
                    required: askbot.settings.tagsAreRequired,
                    maxlength: 105,
                    limit_tag_count: true,
                    limit_tag_length: true
                },
                text: {
                    required: !!askbot.settings.minQuestionBodyLength,
                    minlength: askbot.settings.minQuestionBodyLength
                },
                title: {
                    required: true,
                    minlength: askbot.settings.minTitleLength
                }
            };
        },
        getQuestionFormMessages: function () {
            return {
                tags: {
                    required: ' ' + gettext('tags cannot be empty'),
                    maxlength: askbot.messages.tagLimits,
                    limit_tag_count: askbot.messages.maxTagsPerPost,
                    limit_tag_length: askbot.messages.maxTagLength
                },
                text: {
                    required: ' ' + gettext('details are required'),
                    minlength: interpolate(
                                    ngettext(
                                        'details must have > %s character',
                                        'details must have > %s characters',
                                        askbot.settings.minQuestionBodyLength
                                    ),
                                    [askbot.settings.minQuestionBodyLength]
                                )
                },
                title: {
                    required: ' ' + gettext('enter your question'),
                    minlength: interpolate(
                                    ngettext(
                                        'enter > %(length)s character',
                                        'enter > %(length)s characters',
                                        askbot.settings.minTitleLength
                                    ),
                                    {'length': askbot.settings.minTitleLength},
                                    true
                                )
                }
            };
        },
        getAnswerFormRules: function () {
            return {
                text: {
                    required: true,
                    minlength: askbot.settings.minAnswerBodyLength
                }
            };
        },
        getAnswerFormMessages: function () {
            return {
                text: {
                    required: ' ' + gettext('content cannot be empty'),
                    minlength: interpolate(
                                    ngettext(
                                        'enter > %(length)s character',
                                        'enter > %(length)s characters',
                                        askbot.settings.minAnswerBodyLength
                                    ),
                                    {'length': askbot.settings.minAnswerBodyLength},
                                    true
                                )
                }
            };
        }
    };
})();

/**
 * @constructor
 */
var ThreadUsersDialog = function () {
    SimpleControl.call(this);
    this._heading_text = 'Add heading with the setHeadingText()';
};
inherits(ThreadUsersDialog, SimpleControl);

ThreadUsersDialog.prototype.setHeadingText = function (text) {
    this._heading_text = text;
};

ThreadUsersDialog.prototype.showUsers = function (html) {
    this._dialog.setContent(html);
    this._dialog.show();
};

ThreadUsersDialog.prototype.startShowingUsers = function () {
    var me = this;
    var threadId = this._threadId;
    var url = this._url;
    $.ajax({
        type: 'GET',
        data: {'thread_id': threadId},
        dataType: 'json',
        url: url,
        cache: false,
        success: function (data) {
            if (data.success) {
                me.showUsers(data.html);
            } else {
                showMessage(me.getElement(), data.message, 'after');
            }
        }
    });
};

ThreadUsersDialog.prototype.decorate = function (element) {
    this._element = element;
    ThreadUsersDialog.superClass_.decorate.call(this, element);
    this._threadId = element.data('threadId');
    this._url = element.data('url');
    var dialog = new ModalDialog();
    dialog.setRejectButtonText('');
    dialog.setAcceptButtonText(gettext('Back to the question'));
    dialog.setHeadingText(this._heading_text);
    dialog.setAcceptHandler(function () { dialog.hide(); });
    var dialog_element = dialog.getElement();
    $(dialog_element).find('.modal-footer').css('text-align', 'center');
    $('body').append(dialog_element);
    this._dialog = dialog;
    var me = this;
    this.setHandler(function () {
        me.startShowingUsers();
    });
};

var MergeQuestionsDialog = function () {
    ModalDialog.call(this);
    this._tags = [];
    this._prevQuestionId = undefined;
};
inherits(MergeQuestionsDialog, ModalDialog);

MergeQuestionsDialog.prototype.show = function () {
    MergeQuestionsDialog.superClass_.show.call(this);
    this._idInput.focus();
};

MergeQuestionsDialog.prototype.getStartMergingHandler = function () {
    var me = this;
    return function () {
        $.ajax({
            type: 'POST',
            cache: false,
            dataType: 'json',
            url: askbot.urls.mergeQuestions,
            data: JSON.stringify({
                from_id: me.getFromId(),
                to_id: me.getToId()
            }),
            success: function (data) {
                window.location.reload();
            }
        });
    };
};

MergeQuestionsDialog.prototype.setPreview = function (data) {
    this._previewTitle.html(data.title);
    this._previewBody.html(data.summary);
    for (var i = 0; i < this._tags.length; i++) {
        this._tags[i].dispose();
    }
    for (i = 0; i < data.tags.length; i++) {
        var tag = new Tag();
        tag.setLinkable(false);
        tag.setName(data.tags[i]);
        this._previewTags.append(tag.getElement());
        this._tags.push(tag);
    }
    this._preview.fadeIn();
};

MergeQuestionsDialog.prototype.clearIdInput = function () {
    this._idInput.val('');
};

MergeQuestionsDialog.prototype.clearPreview = function () {
    for (var i = 0; i < this._tags.length; i++) {
        this._tags[i].dispose();
    }
    this._previewTitle.html('');
    this._previewBody.html('');
    this._previewTags.html('');
    this.setAcceptButtonText(gettext('Load preview'));
    this._preview.hide();
};

MergeQuestionsDialog.prototype.getFromId = function () {
    return this._fromId;
};

MergeQuestionsDialog.prototype.getToId = function () {
    return this._idInput.val();
};

MergeQuestionsDialog.prototype.getPrevToId = function () {
    return this._prevQuestionId;
};

MergeQuestionsDialog.prototype.setPrevToId = function (toId) {
    this._prevQuestionId = toId;
};

MergeQuestionsDialog.prototype.getLoadPreviewHandler = function () {
    var me = this;
    return function () {
        var prevId = me.getPrevToId();
        var curId = me.getToId();
        // here I am disabling eqeqeq because it looks like there's a type coercion going on, can't be sure
        // so skipping it
        /*jshint eqeqeq:false*/
        if (curId) {// && curId != prevId) {
        /*jshint eqeqeq:true*/
            $.ajax({
                type: 'GET',
                cache: false,
                dataType: 'json',
                url: askbot.urls.apiV1Questions + curId + '/',
                success: function (data) {
                    me.setPreview(data);
                    me.setPrevToId(curId);
                    me.setAcceptButtonText(gettext('Merge'));
                    me.setPreviewLoaded(true);
                    return false;
                },
                error: function () {
                    me.clearPreview();
                    me.setAcceptButtonText(gettext('Load preview'));
                    me.setPreviewLoaded(false);
                    return false;
                }
            });
        }
    };
};

MergeQuestionsDialog.prototype.setPreviewLoaded = function(isLoaded) {
    this._isPreviewLoaded = isLoaded;
};

MergeQuestionsDialog.prototype.isPreviewLoaded = function() {
    return this._isPreviewLoaded;
};

MergeQuestionsDialog.prototype.getAcceptHandler = function() {
    var me = this;
    return function() {
        var handler;
        if (me.isPreviewLoaded()) {
            handler = me.getStartMergingHandler();
        } else {
            handler = me.getLoadPreviewHandler();
        }
        handler();
        return false;
    };
};

MergeQuestionsDialog.prototype.getRejectHandler = function() {
    var me = this;
    return function() {
        me.clearPreview();
        me.clearIdInput();
        me.setPreviewLoaded(false);
        me.hide();
    };
};

MergeQuestionsDialog.prototype.createDom = function () {
    //make content
    var content = this.makeElement('div');
    var label = this.makeElement('label');
    label.attr('for', 'question_id');
    label.html(gettext(askbot.messages.enterDuplicateQuestionId));
    content.append(label);
    var input = this.makeElement('input');
    input.attr('type', 'text');
    input.attr('name', 'question_id');
    content.append(input);
    this._idInput = input;

    var preview = this.makeElement('div');
    content.append(preview);
    this._preview = preview;
    preview.hide();

    var title = this.makeElement('h3');
    preview.append(title);
    this._previewTitle = title;

    var tags = this.makeElement('div');
    tags.addClass('tags');
    this._preview.append(tags);
    this._previewTags = tags;

    var clr = this.makeElement('div');
    clr.addClass('clearfix');
    this._preview.append(clr);

    var body = this.makeElement('div');
    body.addClass('body');
    this._preview.append(body);
    this._previewBody = body;

    var previewHandler = this.getLoadPreviewHandler();
    var enterHandler = makeKeyHandler(13, previewHandler);
    input.keydown(enterHandler);
    input.blur(previewHandler);

    this.setContent(content);

    this.setClass('merge-questions');
    this.setRejectButtonText(gettext('Cancel'));
    this.setAcceptButtonText(gettext('Load preview'));
    this.setHeadingText(askbot.messages.mergeQuestions);
    this.setRejectHandler(this.getRejectHandler());
    this.setAcceptHandler(this.getAcceptHandler());

    MergeQuestionsDialog.superClass_.createDom.call(this);
    this._element.hide();

    this._fromId = $('.js-question').data('postId');
    //have to do this on document since _element is not in the DOM yet
    $(document).trigger('askbot.afterMergeQuestionsDialogCreateDom', [this]);
};

/**
 * @constructor
 */
var DraftPost = function () {
    WrappedElement.call(this);
};
inherits(DraftPost, WrappedElement);

/**
 * @return {string}
 */
DraftPost.prototype.getUrl = function () {
    throw 'Not Implemented';
};

/**
 * @return {boolean}
 */
DraftPost.prototype.shouldSave = function () {
    throw 'Not Implemented';
};

/**
 * @return {object} data dict
 */
DraftPost.prototype.getData = function () {
    throw 'Not Implemented';
};

DraftPost.prototype.backupData = function () {
    this._old_data = this.getData();
};

DraftPost.prototype.showNotification = function () {
    var note = $('.editor-status span');
    note.hide();
    note.html(gettext('draft saved...'));
    note.fadeIn().delay(3000).fadeOut();
};

DraftPost.prototype.getSaveHandler = function () {
    var me = this;
    return function (save_synchronously) {
        if (me.shouldSave()) {
            $.ajax({
                type: 'POST',
                cache: false,
                dataType: 'json',
                async: save_synchronously ? false : true,
                url: me.getUrl(),
                data: me.getData(),
                success: function (data) {
                    if (data.success && !save_synchronously) {
                        me.showNotification();
                    }
                    me.backupData();
                }
            });
        }
    };
};

DraftPost.prototype.decorate = function (element) {
    this._element = element;
    this.assignContentElements();
    this.backupData();
    setInterval(this.getSaveHandler(), 30000);//auto-save twice a minute
    var me = this;
    window.onbeforeunload = function () {
        var saveHandler = me.getSaveHandler();
        saveHandler(true);
        //var msg = gettext("%s, we've saved your draft, but...");
        //return interpolate(msg, [askbot.data.userName]);
    };
};


/**
 * @contstructor
 */
var DraftQuestion = function () {
    DraftPost.call(this);
};
inherits(DraftQuestion, DraftPost);

DraftQuestion.prototype.getUrl = function () {
    return askbot.urls.saveDraftQuestion;
};

DraftQuestion.prototype.shouldSave = function () {
    var newd = this.getData();
    var oldd = this._old_data;
    return (
        newd.title !== oldd.title ||
        newd.text !== oldd.text ||
        newd.tagnames !== oldd.tagnames
    );
};

DraftQuestion.prototype.getData = function () {
    return {
        'title': this._title_element.val(),
        'text': this._text_element.val(),
        'tagnames': this._tagnames_element.val()
    };
};

DraftQuestion.prototype.assignContentElements = function () {
    this._title_element = $('#id_title');
    this._text_element = $('#editor');
    this._tagnames_element = $('#id_tags');
};

var DraftAnswer = function () {
    DraftPost.call(this);
};
inherits(DraftAnswer, DraftPost);

DraftAnswer.prototype.setThreadId = function (id) {
    this._threadId = id;
};

DraftAnswer.prototype.getUrl = function () {
    return askbot.urls.saveDraftAnswer;
};

DraftAnswer.prototype.shouldSave = function () {
    return this.getData().text !== this._old_data.text;
};

DraftAnswer.prototype.getData = function () {
    return {
        'text': this._textElement.val(),
        'thread_id': this._threadId
    };
};

DraftAnswer.prototype.assignContentElements = function () {
    this._textElement = $('#editor');
};


/**
 * @constructor
 * @extends {SimpleControl}
 * @param {Comment} comment to upvote
 */
var CommentVoteButton = function (comment) {
    SimpleControl.call(this);
    /**
     * @param {Comment}
     */
    this._comment = comment;
    /**
     * @type {boolean}
     */
    this._voted = false;
    /**
     * @type {number}
     */
    this._score = 0;
};
inherits(CommentVoteButton, SimpleControl);
/**
 * @param {number} score
 */
CommentVoteButton.prototype.setScore = function (score) {
    this._score = score;
    if (this._element) {
        this._element.html(score || '');
    }
    this._element.trigger('askbot.afterSetScore', [this, score]);
};
/**
 * @param {boolean} voted
 */
CommentVoteButton.prototype.setVoted = function (voted) {
    this._voted = voted;
    if (this._element && voted) {
        this._element.addClass('upvoted');
    } else if (this._element) {
        this._element.removeClass('upvoted');
    }
};

CommentVoteButton.prototype.getVoteHandler = function () {
    var me = this;
    var comment = this._comment;
    return function () {
        var cancelVote =  me._voted ? true: false;
        var post_id = me._comment.getId();
        var data = {
            cancel_vote: cancelVote,
            post_id: post_id
        };
        $.ajax({
            type: 'POST',
            data: data,
            dataType: 'json',
            url: askbot.urls.upvote_comment,
            cache: false,
            success: function (data) {
                if (data.success) {
                    me.setScore(data.score);
                    me.setVoted(!cancelVote);
                } else {
                    showMessage(comment.getElement(), data.message, 'after');
                }
            }
        });
    };
};

CommentVoteButton.prototype.decorate = function (element) {
    this._element = element;
    this.setHandler(this.getVoteHandler());

    element = this._element;
    var comment = this._comment;
    /* can't call comment.getElement() here due
     * an issue in the getElement() of comment
     * so use an "illegal" access to comment._element here
     */
    comment._element.mouseenter(function () {
        //outside height may not be known
        //var height = comment.getElement().height();
        //element.height(height);
        element.addClass('hover');
    });
    comment._element.mouseleave(function () {
        element.removeClass('hover');
    });

};

CommentVoteButton.prototype.createDom = function () {
    this._element = this.makeElement('div');
    if (this._score > 0) {
        this._element.html(this._score);
    }
    this._element.addClass('upvote');
    if (this._voted) {
        this._element.addClass('upvoted');
    }
    this.decorate(this._element);
};

/**
 * an updater of the follower count
 */
var updateQuestionFollowerCount = function (evt, data) {
    var fav = $('.js-question-follower-count');
    var count = data.num_followers;
    if (count === 0) {
        fav.text('');
    } else {
        var fmt = ngettext('%s follower', '%s followers', count);
        fav.text(interpolate(fmt, [count]));
    }
};

/**
 * legacy Vote class
 * handles all sorts of vote-like operations
 */
var Vote = (function () {
    // All actions are related to a question
    var questionId;
    //question slug to build redirect urls
    var questionSlug;
    // The object we operate on actually. It can be a question or an answer.
    var postId;
    var questionAuthorId;
    var currentUserId;
    var answerContainerIdPrefix = 'post-id-';
    var voteContainerId = 'vote-buttons';
    var imgIdPrefixAccept = 'answer-img-accept-';
    var imgIdPrefixQuestionVoteup = 'question-img-upvote-';
    var imgIdPrefixQuestionVotedown = 'question-img-downvote-';
    var imgIdPrefixAnswerVoteup = 'answer-img-upvote-';
    var imgIdPrefixAnswerVotedown = 'answer-img-downvote-';
    var voteNumberClass = 'vote-number';
    var offensiveIdPrefixQuestionFlag = 'question-offensive-flag-';
    var removeOffensiveIdPrefixQuestionFlag = 'question-offensive-remove-flag-';
    var removeAllOffensiveIdPrefixQuestionFlag = 'question-offensive-remove-all-flag-';
    var offensiveIdPrefixAnswerFlag = 'answer-offensive-flag-';
    var removeOffensiveIdPrefixAnswerFlag = 'answer-offensive-remove-flag-';
    var removeAllOffensiveIdPrefixAnswerFlag = 'answer-offensive-remove-all-flag-';
    var offensiveClassFlag = 'offensive-flag';
    var questionControlsId = 'question-controls';
    var removeAnswerLinkIdPrefix = 'answer-delete-link-';
    var questionSubscribeUpdates = 'question-subscribe-updates';
    var questionSubscribeSidebar = 'question-subscribe-sidebar';

    var acceptAnonymousMessage = gettext('insufficient privilege');

    var pleaseLogin = ' <a href="' + askbot.urls.user_signin + '">' + gettext('please login') + '</a>';

    //todo: this below is probably not used
    var subscribeAnonymousMessage = gettext('anonymous users cannot subscribe to questions') + pleaseLogin;
    var voteAnonymousMessage = gettext('anonymous users cannot vote') + pleaseLogin;
    //there were a couple of more messages...
    var offensiveAnonymousMessage = gettext('anonymous users cannot flag offensive posts') + pleaseLogin;
    var removeConfirmation = gettext('confirm delete');
    var removeAnonymousMessage = gettext('anonymous users cannot delete/undelete') + pleaseLogin;
    var recoveredMessage = gettext('post recovered');
    var deletedMessage = gettext('post deleted');

    var VoteType = {
        acceptAnswer: 0,
        questionUpVote: 1,
        questionDownVote: 2,
        answerUpVote: 5,
        answerDownVote:6,
        offensiveQuestion: 7,
        removeOffensiveQuestion: 7.5,
        removeAllOffensiveQuestion: 7.6,
        offensiveAnswer: 8,
        removeOffensiveAnswer: 8.5,
        removeAllOffensiveAnswer: 8.6,
        removeQuestion: 9,//deprecate
        removeAnswer: 10,//deprecate
        questionSubscribeUpdates: 11,
        questionUnsubscribeUpdates: 12
    };

    var getQuestionVoteUpButton = function () {
        var questionVoteUpButton = 'div.' + voteContainerId + ' div[id^="' + imgIdPrefixQuestionVoteup + '"]';
        return $(questionVoteUpButton);
    };
    var getQuestionVoteDownButton = function () {
        var questionVoteDownButton = 'div.' + voteContainerId + ' div[id^="' + imgIdPrefixQuestionVotedown + '"]';
        return $(questionVoteDownButton);
    };
    var getAnswerVoteUpButtons = function () {
        var answerVoteUpButton = 'div.' + voteContainerId + ' div[id^="' + imgIdPrefixAnswerVoteup + '"]';
        return $(answerVoteUpButton);
    };
    var getAnswerVoteDownButtons = function () {
        var answerVoteDownButton = 'div.' + voteContainerId + ' div[id^="' + imgIdPrefixAnswerVotedown + '"]';
        return $(answerVoteDownButton);
    };
    var getAnswerVoteUpButton = function (id) {
        var answerVoteUpButton = 'div.' + voteContainerId + ' div[id="' + imgIdPrefixAnswerVoteup + id + '"]';
        return $(answerVoteUpButton);
    };
    var getAnswerVoteDownButton = function (id) {
        var answerVoteDownButton = 'div.' + voteContainerId + ' div[id="' + imgIdPrefixAnswerVotedown + id + '"]';
        return $(answerVoteDownButton);
    };

    var getOffensiveQuestionFlag = function () {
        var offensiveQuestionFlag = 'span[id^="' + offensiveIdPrefixQuestionFlag + '"]';
        return $(offensiveQuestionFlag);
    };

    var getRemoveOffensiveQuestionFlag = function () {
        var removeOffensiveQuestionFlag = 'span[id^="' + removeOffensiveIdPrefixQuestionFlag + '"]';
        return $(removeOffensiveQuestionFlag);
    };

    var getRemoveAllOffensiveQuestionFlag = function () {
        var removeAllOffensiveQuestionFlag = 'span[id^="' + removeAllOffensiveIdPrefixQuestionFlag + '"]';
        return $(removeAllOffensiveQuestionFlag);
    };

    var getOffensiveAnswerFlags = function () {
        var offensiveQuestionFlag = 'span[id^="' + offensiveIdPrefixAnswerFlag + '"]';
        return $(offensiveQuestionFlag);
    };

    var getRemoveOffensiveAnswerFlag = function () {
        var removeOffensiveAnswerFlag = 'span[id^="' + removeOffensiveIdPrefixAnswerFlag + '"]';
        return $(removeOffensiveAnswerFlag);
    };

    var getRemoveAllOffensiveAnswerFlag = function () {
        var removeAllOffensiveAnswerFlag = 'span[id^="' + removeAllOffensiveIdPrefixAnswerFlag + '"]';
        return $(removeAllOffensiveAnswerFlag);
    };

    var getquestionSubscribeUpdatesCheckbox = function () {
        return $('#' + questionSubscribeUpdates);
    };

    var getquestionSubscribeSidebarCheckbox = function () {
        return $('#' + questionSubscribeSidebar);
    };

    var getremoveAnswersLinks = function () {
        var removeAnswerLinks = 'a[id^="' + removeAnswerLinkIdPrefix + '"]';
        return $(removeAnswerLinks);
    };

    var setVoteImage = function (voteType, undo, object) {
        var flag = undo ? false : true;
        if (object.hasClass('on')) {
            object.removeClass('on');
        } else {
            object.addClass('on');
        }

        if (undo) {
            if (voteType === VoteType.questionUpVote || voteType === VoteType.questionDownVote) {
                $(getQuestionVoteUpButton()).removeClass('on');
                $(getQuestionVoteDownButton()).removeClass('on');
            } else {
                $(getAnswerVoteUpButton(postId)).removeClass('on');
                $(getAnswerVoteDownButton(postId)).removeClass('on');
            }
        }
    };

    var setVoteNumber = function (object, number) {
        var voteNumber = object.parent('div.' + voteContainerId).find('div.' + voteNumberClass);
        $(voteNumber).text(number);
    };

    var bindEvents = function () {
        // accept answers
        var acceptedButtons = 'div.' + voteContainerId + ' div[id^="' + imgIdPrefixAccept + '"]';
        $(acceptedButtons).unbind('click').click(function (event) {
            Vote.accept($(event.target));
        });

        // question vote up
        var questionVoteUpButton = getQuestionVoteUpButton();
        questionVoteUpButton.unbind('click').click(function (event) {
            Vote.vote($(event.target), VoteType.questionUpVote);
        });

        var questionVoteDownButton = getQuestionVoteDownButton();
        questionVoteDownButton.unbind('click').click(function (event) {
            Vote.vote($(event.target), VoteType.questionDownVote);
        });

        var answerVoteUpButton = getAnswerVoteUpButtons();
        answerVoteUpButton.unbind('click').click(function (event) {
            Vote.vote($(event.target), VoteType.answerUpVote);
        });

        var answerVoteDownButton = getAnswerVoteDownButtons();
        answerVoteDownButton.unbind('click').click(function (event) {
            Vote.vote($(event.target), VoteType.answerDownVote);
        });

        getOffensiveQuestionFlag().unbind('click').click(function (event) {
            Vote.offensive(this, VoteType.offensiveQuestion);
        });

        getRemoveOffensiveQuestionFlag().unbind('click').click(function (event) {
            Vote.remove_offensive(this, VoteType.removeOffensiveQuestion);
        });

        getRemoveAllOffensiveQuestionFlag().unbind('click').click(function (event) {
            Vote.remove_all_offensive(this, VoteType.removeAllOffensiveQuestion);
        });

        getOffensiveAnswerFlags().unbind('click').click(function (event) {
            Vote.offensive(this, VoteType.offensiveAnswer);
        });

        getRemoveOffensiveAnswerFlag().unbind('click').click(function (event) {
            Vote.remove_offensive(this, VoteType.removeOffensiveAnswer);
        });

        getRemoveAllOffensiveAnswerFlag().unbind('click').click(function (event) {
            Vote.remove_all_offensive(this, VoteType.removeAllOffensiveAnswer);
        });

        getquestionSubscribeUpdatesCheckbox().unbind('click').click(function (event) {
            //despeluchar esto
            if (this.checked) {
                getquestionSubscribeSidebarCheckbox().attr({'checked': true});
                Vote.vote($(event.target), VoteType.questionSubscribeUpdates);
            } else {
                getquestionSubscribeSidebarCheckbox().attr({'checked': false});
                Vote.vote($(event.target), VoteType.questionUnsubscribeUpdates);
            }
        });

        getquestionSubscribeSidebarCheckbox().unbind('click').click(function (event) {
            if (this.checked) {
                getquestionSubscribeUpdatesCheckbox().attr({'checked': true});
                Vote.vote($(event.target), VoteType.questionSubscribeUpdates);
            } else {
                getquestionSubscribeUpdatesCheckbox().attr({'checked': false});
                Vote.vote($(event.target), VoteType.questionUnsubscribeUpdates);
            }
        });

        getremoveAnswersLinks().unbind('click').click(function (event) {
            Vote.remove(this, VoteType.removeAnswer);
        });
    };

    var submit = function (object, voteType, callback) {
        //this function submits votes
        $.ajax({
            type: 'POST',
            cache: false,
            dataType: 'json',
            url: askbot.urls.vote_url,
            data: { type: voteType, postId: postId },
            error: handleFail,
            success: function (data) {
                callback(object, voteType, data);
            }
        });
    };

    var handleFail = function (xhr, msg) {
        alert('Callback invoke error: ' + msg);
    };

    // callback function for Accept Answer action
    var callback_accept = function (object, voteType, data) {
        /*jshint eqeqeq:false */
        if (data.allowed == '0' && data.success == '0') {
            showMessage(object, acceptAnonymousMessage);
        } else if (data.allowed == '-1') {
            var message = interpolate(
                gettext('sorry, you cannot %(accept_own_answer)s'),
                {'accept_own_answer': askbot.messages.acceptOwnAnswer},
                true
            );
            showMessage(object, message);
        } else if (data.status == '1') {
            $('#' + answerContainerIdPrefix + postId).removeClass('accepted-answer');
            object.trigger('askbot.unacceptAnswer', [object, data]);
        } else if (data.success == '1') {
            var answers = ('div[id^="' + answerContainerIdPrefix + '"]');
            $(answers).removeClass('accepted-answer');
            $('#' + answerContainerIdPrefix + postId).addClass('accepted-answer');
            object.trigger('askbot.acceptAnswer', [object, data]);
        } else {
            showMessage(object, data.message);
        }
        /*jshint eqeqeq:true */
    };

    var callback_vote = function (object, voteType, data) {
        /*jshint eqeqeq:false */
        if (data.success == '0') {
            showMessage(object, data.message);
            return;
        } else {
            if (data.status == '1') {
                setVoteImage(voteType, true, object);
                object.trigger('askbot.voteDown', [object, data]);
            } else {
                setVoteImage(voteType, false, object);
                object.trigger('askbot.voteUp', [object, data]);
            }
            setVoteNumber(object, data.count);
            if (data.message && data.message.length > 0) {
                showMessage(object, data.message);
            }
            return;
        }
        /*jshint eqeqeq:true */
    };

    var callback_offensive = function (object, voteType, data) {
        /*jshint eqeqeq:false */
        //todo: transfer proper translations of these from i18n.js
        //to django.po files
        //_('anonymous users cannot flag offensive posts') + pleaseLogin;
        if (data.success == '1') {
            if (data.count > 0) {
                $(object).children('span[class="darkred"]').text('(' + data.count + ')');
            } else {
                $(object).children('span[class="darkred"]').text('');
            }

            // Change the link text and rebind events
            $(object).find('.question-flag').html(gettext('remove flag'));
            var obj_id = $(object).attr('id');
            $(object).attr('id', obj_id.replace('flag-', 'remove-flag-'));

            getRemoveOffensiveQuestionFlag().unbind('click').click(function (event) {
                Vote.remove_offensive(this, VoteType.removeOffensiveQuestion);
            });

            getRemoveOffensiveAnswerFlag().unbind('click').click(function (event) {
                Vote.remove_offensive(this, VoteType.removeOffensiveAnswer);
            });
        } else {
            object = $(object);
            showMessage(object, data.message);
        }
        /*jshint eqeqeq:true */
    };

    var callback_remove_offensive = function (object, voteType, data) {
        /*jshint eqeqeq:false */
        //todo: transfer proper translations of these from i18n.js
        //to django.po files
        //_('anonymous users cannot flag offensive posts') + pleaseLogin;
        if (data.success == '1') {
            if (data.count > 0) {
                $(object).children('span[class="darkred"]').text('(' + data.count + ')');
            } else {
                $(object).children('span[class="darkred"]').text('');
                // Remove "remove all flags link" since there are no more flags to remove
                var remove_all = $(object).siblings('span.offensive-flag[id*="-offensive-remove-all-flag-"]');
                $(remove_all).next('span.sep').remove();
                $(remove_all).remove();
            }
            // Change the link text and rebind events
            $(object).find('.question-flag').html(gettext('flag offensive'));
            var obj_id = $(object).attr('id');
            $(object).attr('id', obj_id.replace('remove-flag-', 'flag-'));

            getOffensiveQuestionFlag().unbind('click').click(function (event) {
                Vote.offensive(this, VoteType.offensiveQuestion);
            });

            getOffensiveAnswerFlags().unbind('click').click(function (event) {
                Vote.offensive(this, VoteType.offensiveAnswer);
            });
        } else {
            object = $(object);
            showMessage(object, data.message);
        }
        /*jshint eqeqeq:true */
    };

    var callback_remove_all_offensive = function (object, voteType, data) {
        /*jshint eqeqeq:false */
        //todo: transfer proper translations of these from i18n.js
        //to django.po files
        //_('anonymous users cannot flag offensive posts') + pleaseLogin;
        if (data.success == '1') {
            if (data.count > 0) {
                $(object).children('span[class="darkred"]').text('(' + data.count + ')');
            } else {
                $(object).children('span[class="darkred"]').text('');
            }
            // remove the link. All flags are gone
            var remove_own = $(object).siblings('span.offensive-flag[id*="-offensive-remove-flag-"]');
            $(remove_own).find('.question-flag').html(gettext('flag offensive'));
            $(remove_own).attr('id', $(remove_own).attr('id').replace('remove-flag-', 'flag-'));

            $(object).next('span.sep').remove();
            $(object).remove();

            getOffensiveQuestionFlag().unbind('click').click(function (event) {
                Vote.offensive(this, VoteType.offensiveQuestion);
            });

            getOffensiveAnswerFlags().unbind('click').click(function (event) {
                Vote.offensive(this, VoteType.offensiveAnswer);
            });
        } else {
            object = $(object);
            showMessage(object, data.message);
        }
        /*jshint eqeqeq:true */
    };

    var callback_remove = function (object, voteType, data) {
        /*jshint eqeqeq:false */
        if (data.success == '1') {
            if (removeActionType == 'delete') {
                postNode.addClass('deleted');
                postRemoveLink.innerHTML = gettext('undelete');
                showMessage(object, deletedMessage);
            } else if (removeActionType == 'undelete') {
                postNode.removeClass('deleted');
                postRemoveLink.innerHTML = gettext('delete');
                showMessage(object, recoveredMessage);
            }
        } else {
            showMessage(object, data.message);
        }
        /*jshint eqeqeq:true */
    };

    return {
        init: function (qId, qSlug, questionAuthor, userId) {
            questionId = qId;
            questionSlug = qSlug;
            questionAuthorId = questionAuthor;
            currentUserId = '' + userId;//convert to string
            bindEvents();
        },

        //accept answer
        accept: function (object) {
            object = object.closest('.answer-img-accept');
            postId = object.attr('id').substring(imgIdPrefixAccept.length);
            submit(object, VoteType.acceptAnswer, callback_accept);
        },

        vote: function (object, voteType) {
            object = object.closest('.post-vote');
            if (!currentUserId || currentUserId.toUpperCase() === 'NONE') {
                if (voteType === VoteType.questionSubscribeUpdates || voteType === VoteType.questionUnsubscribeUpdates) {
                    getquestionSubscribeSidebarCheckbox().removeAttr('checked');
                    getquestionSubscribeUpdatesCheckbox().removeAttr('checked');
                    showMessage(object, subscribeAnonymousMessage);
                } else {
                    showMessage(
                        $(object),
                        voteAnonymousMessage.replace(
                                '{{QuestionID}}',
                                questionId
                            ).replace(
                                '{{questionSlug}}',
                                questionSlug
                            )
                    );
                }
                return false;
            }
            // up and downvote processor
            if (voteType === VoteType.answerUpVote) {
                postId = object.attr('id').substring(imgIdPrefixAnswerVoteup.length);
            } else if (voteType === VoteType.answerDownVote) {
                postId = object.attr('id').substring(imgIdPrefixAnswerVotedown.length);
            } else {
                postId = questionId;
            }

            submit(object, voteType, callback_vote);
        },
        //flag offensive
        offensive: function (object, voteType) {
            if (!currentUserId || currentUserId.toUpperCase() === 'NONE') {
                showMessage(
                    $(object),
                    offensiveAnonymousMessage.replace(
                            '{{QuestionID}}',
                            questionId
                        ).replace(
                            '{{questionSlug}}',
                            questionSlug
                        )
                );
                return false;
            }
            postId = object.id.substr(object.id.lastIndexOf('-') + 1);
            submit(object, voteType, callback_offensive);
        },
        //remove flag offensive
        remove_offensive: function (object, voteType) {
            if (!currentUserId || currentUserId.toUpperCase() === 'NONE') {
                showMessage(
                    $(object),
                    offensiveAnonymousMessage.replace(
                            '{{QuestionID}}',
                            questionId
                        ).replace(
                            '{{questionSlug}}',
                            questionSlug
                        )
                );
                return false;
            }
            postId = object.id.substr(object.id.lastIndexOf('-') + 1);
            submit(object, voteType, callback_remove_offensive);
        },
        remove_all_offensive: function (object, voteType) {
            if (!currentUserId || currentUserId.toUpperCase() === 'NONE') {
                showMessage(
                    $(object),
                    offensiveAnonymousMessage.replace(
                            '{{QuestionID}}',
                            questionId
                        ).replace(
                            '{{questionSlug}}',
                            questionSlug
                        )
                );
                return false;
            }
            postId = object.id.substr(object.id.lastIndexOf('-') + 1);
            submit(object, voteType, callback_remove_all_offensive);
        },
        //delete question or answer (comments are deleted separately)
        remove: function (object, voteType) {
            if (!currentUserId || currentUserId.toUpperCase() === 'NONE') {
                showMessage(
                    $(object),
                    removeAnonymousMessage.replace(
                            '{{QuestionID}}',
                            questionId
                        ).replace(
                            '{{questionSlug}}',
                            questionSlug
                        )
                    );
                return false;
            }
            bits = object.id.split('-');
            postId = bits.pop();/* this seems to be used within submit! */
            postType = bits.shift();

            var do_proceed = false;
            postNode = $('#post-id-' + postId);
            postRemoveLink = object;
            if (postNode.hasClass('deleted')) {
                removeActionType = 'undelete';
                do_proceed = true;
            } else {
                removeActionType = 'delete';
                do_proceed = confirm(removeConfirmation);
            }
            if (do_proceed) {
                submit($(object), voteType, callback_remove);
            }
        }
    };
})();

var questionRetagger = (function () {

    var oldTagsHTML = '';
    var tagInput = null;
    var tagsList = null;
    var retagLink = null;

    var restoreEventHandlers = function () {
        $(document).unbind('click', cancelRetag);
    };

    var cancelRetag = function () {
        tagsList.html(oldTagsHTML);
        tagsList.removeClass('post-retag');
        tagsList.addClass('post-tags');
        restoreEventHandlers();
        initRetagger();
    };

    var drawNewTags = function (new_tags) {
        tagsList.empty();
        if (new_tags === '') {
            return;
        }
        new_tags = new_tags.split(/\s+/);
        var tags_html = '';
        $.each(new_tags, function (index, name) {
            var tag = new Tag();
            tag.setName(name);
            var li = $('<li></li>');
            tagsList.append(li);
            li.append(tag.getElement());
        });
    };

    var doRetag = function () {
        $.ajax({
            type: 'POST',
            url: askbot.urls.retag,
            dataType: 'json',
            data: { tags: getUniqueWords(tagInput.val()).join(' ') },
            success: function (json) {
                if (json.success) {
                    new_tags = getUniqueWords(json.new_tags);
                    oldTagsHtml = '';
                    cancelRetag();
                    drawNewTags(new_tags.join(' '));
                    if (json.message) {
                        notify.show(json.message);
                    }
                } else {
                    cancelRetag();
                    showMessage(tagsList, json.message);
                }
            },
            error: function (xhr, textStatus) {
                showMessage(tagsList, gettext('sorry, something is not right here'));
                cancelRetag();
            }
        });
        return false;
    };

    var setupInputEventHandlers = function (input) {
        input.keydown(function (e) {
            if ((e.which && e.which === 27) || (e.keyCode && e.keyCode === 27)) {
                cancelRetag();
            }
        });
        $(document).unbind('click', cancelRetag).click(cancelRetag);
        input.closest('form').click(function (e) {
            e.stopPropagation();
        });
    };

    var createRetagForm = function (old_tags_string) {
        var div = $('<form method="post"></form>');
        tagInput = $('<input id="retag_tags" type="text" autocomplete="off" name="tags" size="30"/>');
        addExtraCssClasses(tagInput, 'textInputClasses');
        //var tagLabel = $('<label for="retag_tags" class="error"></label>');
        //populate input
        var tagAc = new AutoCompleter({
            url: askbot.urls.get_tag_list,
            minChars: 1,
            useCache: true,
            matchInside: true,
            maxCacheLength: 100,
            delay: 10
        });
        tagAc.decorate(tagInput);
        tagAc._results.on('click', function (e) {
            //click on results should not trigger cancelRetag
            e.stopPropagation();
        });
        tagInput.val(old_tags_string);
        div.append(tagInput);
        //div.append(tagLabel);
        setupInputEventHandlers(tagInput);

        //button = $('<input type="submit" />');
        //button.val(gettext('save tags'));
        //div.append(button);
        //setupButtonEventHandlers(button);
        $(document).trigger('askbot.afterCreateRetagForm', [div]);

        div.validate({//copy-paste from utils.js
            rules: {
                tags: {
                    required: askbot.settings.tagsAreRequired,
                    maxlength: askbot.settings.maxTagsPerPost * askbot.settings.maxTagLength,
                    limit_tag_count: true,
                    limit_tag_length: true
                }
            },
            messages: {
                tags: {
                    required: gettext('tags cannot be empty'),
                    maxlength: askbot.messages.tagLimits,
                    limit_tag_count: askbot.messages.maxTagsPerPost,
                    limit_tag_length: askbot.messages.maxTagLength
                }
            },
            submitHandler: doRetag,
            errorClass: 'retag-error'
        });

        $(document).trigger('askbot.afterSetupValidationRetagForm', [div]);

        return div;
    };

    var getTagsAsString = function (tags_div) {
        var links = tags_div.find('.js-tag-name');
        var tags_str = '';
        links.each(function (index, element) {
            if (index === 0) {
                //this is pretty bad - we should use Tag.getName()
                tags_str = $(element).data('tagName');
            } else {
                tags_str += ' ' + $(element).data('tagName');
            }
        });
        return tags_str;
    };

    var noopHandler = function () {
        tagInput.focus();
        return false;
    };

    var deactivateRetagLink = function () {
        retagLink.unbind('click').click(noopHandler);
        retagLink.unbind('keypress').keypress(noopHandler);
    };

    var startRetag = function () {
        tagsList = $('#question-tags');
        oldTagsHTML = tagsList.html();//save to restore on cancel
        var old_tags_string = getTagsAsString(tagsList);
        var retag_form = createRetagForm(old_tags_string);
        tagsList.html('');
        tagsList.append(retag_form);
        tagsList.removeClass('post-tags');
        tagsList.addClass('post-retag');
        tagInput.focus();
        deactivateRetagLink();
        return false;
    };

    var setupClickAndEnterHandler = function (element, callback) {
        element.unbind('click').click(callback);
        element.unbind('keypress').keypress(function (e) {
            if ((e.which && e.which === 13) || (e.keyCode && e.keyCode === 13)) {
                callback();
            }
        });
    };

    var initRetagger = function () {
        setupClickAndEnterHandler(retagLink, startRetag);
    };

    return {
        init: function () {
            retagLink = $('#retag');
            initRetagger();
        }
    };
})();

/**
 * @constructor
 * Controls vor voting for a post
 */
var VoteControls = function () {
    WrappedElement.call(this);
    this._postAuthorId = undefined;
    this._postId = undefined;
};
inherits(VoteControls, WrappedElement);

VoteControls.prototype.setPostId = function (postId) {
    this._postId = postId;
};

VoteControls.prototype.getPostId = function () {
    return this._postId;
};

VoteControls.prototype.setPostAuthorId = function (userId) {
    this._postAuthorId = userId;
};

VoteControls.prototype.setSlug = function (slug) {
    this._slug = slug;
};

VoteControls.prototype.setPostType = function (postType) {
    this._postType = postType;
};

VoteControls.prototype.getPostType = function () {
    return this._postType;
};

VoteControls.prototype.clearVotes = function () {
    this._upvoteButton.removeClass('on');
    this._downvoteButton.removeClass('on');
};

VoteControls.prototype.toggleButton = function (button) {
    if (button.hasClass('on')) {
        button.removeClass('on');
    } else {
        button.addClass('on');
    }
};

VoteControls.prototype.toggleVote = function (voteType) {
    if (voteType === 'upvote') {
        this.toggleButton(this._upvoteButton);
    } else {
        this.toggleButton(this._downvoteButton);
    }
};

VoteControls.prototype.setVoteCount = function (count) {
    this._voteCount.html(count);
};

VoteControls.prototype.updateDisplay = function (voteType, data) {
    /* jshint eqeqeq:false */
    if (data.status == '1') {
        this.clearVotes();
    } else {
        this.toggleVote(voteType);
    }
    this.setVoteCount(data.count);
    if (data.message && data.message.length > 0) {
        showMessage(this._element, data.message);
    }
    /* jshint eqeqeq:true */
};

VoteControls.prototype.getAnonymousMessage = function (message) {
    var pleaseLogin = ' <a href="' + askbot.urls.user_signin + '">' + gettext('please login') + '</a>';
    message += pleaseLogin;
    message = message.replace('{{QuestionID}}', this._postId);
    return message.replace('{{questionSlug}}', this._slug);
};

VoteControls.prototype.getVoteHandler = function (voteType) {
    var me = this;
    return function () {
        if (askbot.data.userIsAuthenticated === false) {
            var message = me.getAnonymousMessage(gettext('anonymous users cannot vote'));
            showMessage(me.getElement(), message);
        } else {
            //this function submits votes
            var voteMap = {
                'question': { 'upvote': 1, 'downvote': 2 },
                'answer': { 'upvote': 5, 'downvote': 6 }
            };
            var legacyVoteType = voteMap[me.getPostType()][voteType];
            $.ajax({
                type: 'POST',
                cache: false,
                dataType: 'json',
                url: askbot.urls.vote_url,
                data: {
                    type: legacyVoteType,
                    postId: me.getPostId()
                },
                error: function () {
                    showMessage(me.getElement(), gettext('sorry, something is not right here'));
                },
                success: function (data) {
                    if (data.success) {
                        me.updateDisplay(voteType, data);
                    } else {
                        showMessage(me.getElement(), data.message);
                    }
                }
            });
        }
    };
};

VoteControls.prototype.decorate = function (element) {
    this._element = element;
    var upvoteButton = element.find('.upvote');
    this._upvoteButton = upvoteButton;
    setupButtonEventHandlers(upvoteButton, this.getVoteHandler('upvote'));
    var downvoteButton = element.find('.downvote');
    this._downvoteButton = downvoteButton;
    setupButtonEventHandlers(downvoteButton, this.getVoteHandler('downvote'));
    this._voteCount = element.find('.vote-number');
};

var DeletePostLink = function () {
    SimpleControl.call(this);
    this._post_id = null;
};
inherits(DeletePostLink, SimpleControl);

DeletePostLink.prototype.setPostId = function (id) {
    this._post_id = id;
};

DeletePostLink.prototype.getPostId = function () {
    return this._post_id;
};

DeletePostLink.prototype.getPostElement = function () {
    return $('#post-id-' + this.getPostId());
};

DeletePostLink.prototype.isPostDeleted = function () {
    return this._post_deleted;
};

DeletePostLink.prototype.setPostDeleted = function (is_deleted) {
    var post = this.getPostElement();
    if (is_deleted === true) {
        post.addClass('deleted');
        this._post_deleted = true;
        this.getElement().html(gettext('undelete'));
    } else if (is_deleted === false) {
        post.removeClass('deleted');
        this._post_deleted = false;
        this.getElement().html(gettext('delete'));
    }
};

DeletePostLink.prototype.getDeleteHandler = function () {
    var me = this;
    var post_id = this.getPostId();
    return function () {
        var data = {
            'post_id': me.getPostId(),
            //todo rename cancel_vote -> undo
            'cancel_vote': me.isPostDeleted() ? true : false
        };
        $.ajax({
            type: 'POST',
            data: data,
            dataType: 'json',
            url: askbot.urls.delete_post,
            cache: false,
            success: function (data) {
                if (data.success) {
                    me.setPostDeleted(data.is_deleted);
                } else {
                    showMessage(me.getElement(), data.message);
                }
            }
        });
    };
};

DeletePostLink.prototype.decorate = function (element) {
    this._element = element;
    this._post_deleted = this.getPostElement().hasClass('deleted');
    this.setHandler(this.getDeleteHandler());
};

/**
 * @constructor
 * a simple textarea-based editor
 */
var SimpleEditor = function (attrs) {
    WrappedElement.call(this);
    attrs = attrs || {};
    this._rows = attrs.rows || 10;
    this._cols = attrs.cols || 60;
    this._minLines = attrs.minLines || 1;
    this._maxlength = attrs.maxlength || 1000;
};
inherits(SimpleEditor, WrappedElement);

SimpleEditor.prototype.focus = function (onFocus) {
    this._textarea.focus();
    if (onFocus) {
        onFocus();
    }
};

SimpleEditor.prototype.putCursorAtEnd = function () {
    putCursorAtEnd(this._textarea);
};

SimpleEditor.prototype.start = function () {
    this.getAutoResizeHandler()();
};

SimpleEditor.prototype.setHighlight = function (isHighlighted) {
    if (isHighlighted === true) {
        this._textarea.addClass('highlight');
    } else {
        this._textarea.removeClass('highlight');
    }
};

SimpleEditor.prototype.setTextareaName = function (name) {
    this._textareaName = name;
};


SimpleEditor.prototype.getText = function () {
    return $.trim(this._textarea.val());
};

SimpleEditor.prototype.getHtml = function () {
    return '<div class="transient-comment"><p>' + this.getText() + '</p></div>';
};

SimpleEditor.prototype.setText = function (text) {
    this._text = text;
    if (this._textarea) {
        this._textarea.val(text);
        this.getAutoResizeHandler()();
    }
};

SimpleEditor.prototype.getAutoResizeHandler = function() {
    var textarea = this._textarea;
    var mirror = this._mirror;
    var minLines = this._minLines;
    var me = this;
    return function(evt) {
        me.setMirrorStyle();
        var text = me.getText();
        if (evt) {
            if (evt.type == 'keydown' && getKeyCode(evt) == 13) {
                text += '\nZ';//add one char after newline
            } else if (/(\r|\n)$/.exec(evt.target.value)) {
                text += '\nZ';//add one char after newline
            }
        }
        mirror.text(text);
        var height = mirror.height();
        var lineHeight = parseInt(textarea.css('line-height')) || 10;
        height = lineHeight * Math.max(Math.ceil(height/lineHeight), minLines);
        textarea.css('height', height + 8);
    }
};

SimpleEditor.prototype.setMirrorStyle = function() {
    //copy styles into mirror from the textarea
    var textarea = this._textarea;
    var mirrorCss = {
        'position': 'absolute',
        'top': '-999em',
        'padding': textarea.css('padding'),
        'margin': textarea.css('margin'),
        'width': textarea.css('width'),
        'word-wrap': textarea.css('word-wrap'),
        'word-break': textarea.css('word-break'),
        'overflow': textarea.css('overflow')
    };
    //for IE, as .css('font') fails
    var fontProps = getFontProps(textarea);
    mirrorCss = $.extend(mirrorCss, fontProps);
    this._mirror.css(mirrorCss);
};

/**
 * a textarea inside a div,
 * the reason for this is that we subclass this
 * in WMD, and that one requires a more complex structure
 */
SimpleEditor.prototype.createDom = function () {
    this._element = getTemplate('.js-simple-editor');
    var textarea = this._element.find('textarea');
    var mirror = this._element.find('.mirror');

    this._textarea = textarea;
    this._mirror = mirror;


    if (askbot.settings.tinymceEditorDeselector) {
        textarea.addClass(askbot.settings.tinymceEditorDeselector);//suppress tinyMCE
    }
    addExtraCssClasses(textarea, 'editorClasses');
    if (this._text) {
        textarea.val(this._text);
    }
    textarea.attr({
        'cols': this._cols,
        'rows': this._rows,
        'maxlength': this._maxlength
    });
    if (this._textareaName) {
        textarea.attr('name', this._textareaName);
    }

    textarea.on('change paste keyup keydown', this.getAutoResizeHandler());
};

var WMDExpanderToggle = function (editor) {
    ExpanderToggle.call(this, editor.getPreviewerElement());
    this._editor = editor.getEditorElement();
    this._state = 'on-state';
    this._messages = {
        'on-state': gettext('Preview: (hide)'),
        'off-state': gettext('Show preview')
    }
};
inherits(WMDExpanderToggle, ExpanderToggle);

WMDExpanderToggle.prototype.getEditor = function () {
    return this._editor;
};

WMDExpanderToggle.prototype.setPreviewerCollapsedClass = function (collapsed) {
    var ed = this.getEditor();
    if (collapsed) {
        ed.addClass('wmd-previewer-collapsed');
    } else {
        ed.removeClass('wmd-previewer-collapsed');
    }
};

WMDExpanderToggle.prototype.createDom = function () {
    getSuperClass(WMDExpanderToggle).createDom.call(this);
    this._element.addClass('wmd-previewer-toggle');
    var editor = this.getEditor();

    var me = this;
    this._element.on('askbot.Toggle.stateChange', function (evt, data) {
        var newState = data['newState'];
        var collapsed = (newState == 'off-state' || newState == 'on-prompt');
        me.setPreviewerCollapsedClass(collapsed);
        return false;
    });
    this._element.on('askbot.WrappedElement.show askbot.WrappedElement.hide', function () {
        me.setPreviewerCollapsedClass(!me.isOn());
        return false;
    });
}

/**
 * @constructor
 * a wrapper for the WMD editor
 */
var WMD = function (opts) {
    SimpleEditor.call(this, opts);
    this._text = undefined;
    this._enabled_buttons = 'bold italic link blockquote code ' +
        'image attachment ol ul heading hr';
    this._previewerEnabled = true;
};
inherits(WMD, SimpleEditor);

//@todo: implement getHtml method that runs text through showdown renderer

WMD.prototype.setEnabledButtons = function (buttons) {
    this._enabled_buttons = buttons;
};

WMD.prototype.setPreviewerEnabled = function (enabledStatus) {
    this._previewerEnabled = enabledStatus;
    if (this._previewer) {
        if (enabledStatus) {
            this._previewer.show();
            this._previewerToggle.show();
        } else {
            this._previewer.hide();
            this._previewerToggle.hide();
        }
    }
};

WMD.prototype.getPreviewerEnabled = function () {
    return this._previewerEnabled;
};

WMD.prototype.getPreviewerElement = function () {
    return this._previewer;
};

WMD.prototype.getEditorElement = function () {
    return this._editor;
};

WMD.prototype.createDom = function () {
    this._element = this.makeElement('div');
    var clearfix = this.makeElement('div').addClass('clearfix');
    this._element.append(clearfix);

    var wmd_container = this.makeElement('div');
    wmd_container.addClass('wmd-container');
    this._editor = wmd_container;

    this._element.append(wmd_container);

    var wmd_buttons = this.makeElement('div')
                        .attr('id', this.makeId('wmd-button-bar'))
                        .addClass('wmd-panel');
    wmd_container.append(wmd_buttons);

    var editor = this.makeElement('textarea')
                        .attr('id', this.makeId('editor'));
    addExtraCssClasses(editor, 'editorClasses');
    if (this._textareaName) {
        editor.attr('name', this._textareaName);
    }

    wmd_container.append(editor);
    this._textarea = editor;

    var mirror = this.makeElement('pre').addClass('mirror');
    wmd_container.append(mirror);
    this._mirror = mirror;
    $(editor).on('change paste keyup keydown', this.getAutoResizeHandler());


    if (this._text) {
        editor.val(this._text);
    }

    var previewer = this.makeElement('div')
                        .attr('id', this.makeId('previewer'))
                        .addClass('wmd-preview');
    this._previewer = previewer;

    var toggle = new WMDExpanderToggle(this);
    this._previewerToggle = toggle;
    wmd_container.append(toggle.getElement());

    wmd_container.append(previewer);

    if (this._previewerEnabled === false) {
        previewer.hide();
        this._previewerToggle.hide();
    }
};

WMD.prototype.decorate = function (element) {
    this._element = element;
    this._textarea = element.find('textarea');
    this._previewer = element.find('.wmd-preview');
    this._mirror = element.find('.mirror');
    this._textarea.on('change paste keyup keydown', this.getAutoResizeHandler());
};

WMD.prototype.start = function () {
    Attacklab.Util.startEditor(true, this._enabled_buttons, this.getIdSeed());
    getSuperClass(WMD).start.call(this);
};

/**
 * @constructor
 */
var TinyMCE = function (config) {
    WrappedElement.call(this);
    var defaultConfig = JSON.parse(askbot['settings']['tinyMCEConfigJson']);
    this._config = $.extend(defaultConfig, config || {});

    this._id = 'editor';//desired id of the textarea
};
inherits(TinyMCE, WrappedElement);

TinyMCE.prototype.setTextareaName = function (name) {
    this._textareaName = name;
};

/*
 * not passed onto prototoype on purpose!!!
 */
TinyMCE.onInitHook = function () {
    //set initial content
    var ed = tinyMCE.activeEditor;
    //if we have spellchecker - enable it by default
    if (inArray('spellchecker', askbot.settings.tinyMCEPlugins)) {
        setTimeout(function () {
            ed.controlManager.setActive('spellchecker', true);
            tinyMCE.execCommand('mceSpellCheck', true);
        }, 1);
    }
    $('.mceStatusbar').remove();
};

TinyMCE.onChangeHook = function (editor) {
    tinyMCE.triggerSave();
    $(tinyMCE.get(editor.id).getElement()).change();
};

/* 3 dummy functions to match WMD api */
TinyMCE.prototype.setEnabledButtons = function () {};

TinyMCE.prototype.start = function () {
    //copy the options, because we need to modify them
    var opts = $.extend({}, this._config);
    var me = this;
    var extraOpts = {
        'mode': 'exact',
        'elements': this._id
    };
    opts = $.extend(opts, extraOpts);
    tinyMCE.init(opts);
    if (this._text) {
        this.setText(this._text);
    }
};
TinyMCE.prototype.setPreviewerEnabled = function () {};
TinyMCE.prototype.setHighlight = function () {};

TinyMCE.prototype.putCursorAtEnd = function () {
    var ed = tinyMCE.activeEditor;
    //add an empty span with a unique id
    var endId = tinymce.DOM.uniqueId();
    ed.dom.add(ed.getBody(), 'span', {'id': endId}, '');
    //select that span
    var newNode = ed.dom.select('span#' + endId);
    ed.selection.select(newNode[0]);
};

TinyMCE.prototype.focus = function (onFocus) {
    var editorId = this._id;
    var winH = $(window).height();
    var winY = $(window).scrollTop();
    var edY = this._element.offset().top;
    var edH = this._element.height();

    //@todo: the fallacy of this method is timeout - should instead use queue
    //because at the time of calling focus() the editor may not be initialized yet
    setTimeout(
        function () {
            tinyMCE.execCommand('mceFocus', false, editorId);

            //@todo: make this general to all editors

            //if editor bottom is below viewport
            var isBelow = ((edY + edH) > (winY + winH));
            var isAbove = (edY < winY);
            if (isBelow || isAbove) {
                //then center on screen
                $(window).scrollTop(edY - edH / 2 - winY / 2);
            }
            if (onFocus) {
                onFocus();
            }
        },
        100
    );


};

TinyMCE.prototype.setId = function (id) {
    this._id = id;
};

TinyMCE.prototype.setText = function (text) {
    this._text = text;
    if (this.isLoaded()) {
        tinymce.get(this._id).setContent(text);
    }
};

TinyMCE.prototype.getText = function () {
    return tinyMCE.activeEditor.getContent();
};

TinyMCE.prototype.getHtml = TinyMCE.prototype.getText;

TinyMCE.prototype.isLoaded = function () {
    return (typeof tinymce !== 'undefined' && tinymce.get(this._id) !== undefined);
};

TinyMCE.prototype.createDom = function () {
    var editorBox = this.makeElement('div');
    editorBox.addClass('wmd-container');
    this._element = editorBox;
    var textarea = this.makeElement('textarea');
    textarea.attr('id', this._id);
    textarea.addClass('editor');
    if (this._textareaName) {
        textarea.attr('name', this._textareaName);
    }
    //textarea.addClass(askbot.settings.tinymceEditorDeselector);
    this._element.append(textarea);
};

TinyMCE.prototype.decorate = function (element) {
    this._element = element;
    this._id = element.attr('id');
};

/**
 * Form for editing and posting new comment
 * supports 3 editors: markdown, tinymce and plain textarea.
 * There is only one instance of this form in use on the question page.
 * It can be attached to any comment on the page, or to a new blank
 * comment.
 */
var EditCommentForm = function () {
    WrappedElement.call(this);
    this._comment = null;
    this._commentsWidget = null;
    this._element = null;
    this._editorReady = false;
    this._text = '';
};
inherits(EditCommentForm, WrappedElement);

EditCommentForm.prototype.hide = function () {
    this._element.hide();
};

EditCommentForm.prototype.show = function () {
    this._element.show();
};

EditCommentForm.prototype.getEditor = function () {
    return this._editor;
};

EditCommentForm.prototype.getEditorType = function () {
    if (askbot.settings.commentsEditorType === 'rich-text') {
        return askbot.settings.editorType;
    } else {
        return 'plain-text';
    }
};

EditCommentForm.prototype.startTinyMCEEditor = function () {
    var editorId = this.makeId('comment-editor');
    var opts = {
        mode: 'exact',
        content_css: mediaUrl('media/style/tinymce/comments-content.css'),
        elements: editorId,
        theme: 'advanced',
        theme_advanced_toolbar_location: 'top',
        theme_advanced_toolbar_align: 'left',
        theme_advanced_buttons1: 'bold, italic, |, link, |, numlist, bullist',
        theme_advanced_buttons2: '',
        theme_advanced_path: false,
        plugins: '',
        width: '100%',
        height: '70'
    };
    var editor = new TinyMCE(opts);
    editor.setId(editorId);
    editor.setText(this._text);
    this._editorBox.prepend(editor.getElement());
    editor.start();
    this._editor = editor;
};

EditCommentForm.prototype.startWMDEditor = function () {
    var editor = new WMD({minLines: 3});
    editor.setEnabledButtons('bold italic link code ol ul');
    editor.setPreviewerEnabled(false);
    editor.setText(this._text);
    this._editorBox.prepend(editor.getElement());//attach DOM before start
    editor.start();//have to start after attaching DOM
    this._editor = editor;
};

EditCommentForm.prototype.startSimpleEditor = function () {
    this._editor = new SimpleEditor({minLines: 3});
    this._editorBox.prepend(this._editor.getElement());
};

EditCommentForm.prototype.startEditor = function () {
    var editorType = this.getEditorType();
    if (editorType === 'tinymce') {
        this.startTinyMCEEditor();
        //@todo: implement save on enter and character counter in tinyMCE
        return;
    } else if (editorType === 'markdown') {
        this.startWMDEditor();
    } else {
        this.startSimpleEditor();
    }

    //code below is common to SimpleEditor and WMD
    var editor = this._editor;
    var editorElement = this._editor.getElement();

    var limitLength = this.getCommentTruncator();
    editorElement.blur(limitLength);
    editorElement.focus(limitLength);
    editorElement.keyup(limitLength);
    editorElement.keyup(limitLength);

    var updateCounter = this.getCounterUpdater();
    var escapeHandler = makeKeyHandler(27, this.getCancelHandler());
    //todo: try this on the div
    //this should be set on the textarea!
    editorElement.blur(updateCounter);
    editorElement.focus(updateCounter);
    editorElement.keyup(updateCounter);
    editorElement.keyup(escapeHandler);

    if (askbot.settings.saveCommentOnEnter) {
        var save_handler = makeKeyHandler(13, this.getSaveHandler());
        editor.getElement().keydown(save_handler);
    }

    editorElement.trigger('askbot.afterStartEditor', [editor]);
};

EditCommentForm.prototype.getCommentsWidget = function () {
    return this._commentsWidget;
};

/**
 * attaches comment editor to a particular comment
 */
EditCommentForm.prototype.attachTo = function (comment, mode) {
    this._comment = comment;
    this._type = mode;//action: 'add' or 'edit'
    this._commentsWidget = comment.getContainerWidget();
    this._text = comment.getText();
    comment.getElement().after(this.getElement());
    comment.getElement().hide();
    this._commentsWidget.hideOpenEditorButton();//hide add comment button
    //fix up the comment submit button, depending on the mode
    if (this._type === 'add') {
        this._submit_btn.html(gettext('add comment'));
        if (this._minorEditBox) {
            this._minorEditBox.hide();
        }
    } else {
        this._submit_btn.html(gettext('save comment'));
        if (this._minorEditBox) {
            this._minorEditBox.show();
        }
    }
    //enable the editor
    this.getElement().show();
    this.enableForm();
    this.startEditor();
    this._editor.setText(this._text);
    var ed = this._editor;
    var onFocus = function () {
        ed.putCursorAtEnd();
    };
    this._editor.focus(onFocus);
    setupButtonEventHandlers(this._submit_btn, this.getSaveHandler());
    setupButtonEventHandlers(this._cancel_btn, this.getCancelHandler());

    this.getElement().trigger('askbot.afterEditCommentFormAttached', [this, mode]);
};

EditCommentForm.prototype.getCounterUpdater = function () {
    //returns event handler
    var counter = this._text_counter;
    var editor = this._editor;
    var handler = function () {
        var maxCommentLength = askbot.data.maxCommentLength;
        var length = editor.getText().length;
        var length1 = maxCommentLength - 100;

        if (length1 < 0) {
            length1 = Math.round(0.7 * maxCommentLength);
        }
        var length2 = maxCommentLength - 30;
        if (length2 < 0) {
            length2 = Math.round(0.9 * maxCommentLength);
        }

        /* todo make smooth color transition, from gray to red
         * or rather - from start color to end color */
        var color = 'maroon';
        var chars = askbot.settings.minCommentBodyLength;
        var feedback = '';
        if (length === 0) {
            feedback = interpolate(gettext('enter at least %s characters'), [chars]);
        } else if (length < chars) {
            feedback = interpolate(gettext('enter at least %s more characters'), [chars - length]);
        } else {
            if (length > length2) {
                color = '#f00';
            } else if (length > length1) {
                color = '#f60';
            } else {
                color = '#999';
            }
            chars = maxCommentLength - length;
            feedback = '';
            if (chars > 0) {
                feedback = interpolate(gettext('%s characters left'), [chars]);
            } else {
                feedback = gettext('maximum comment length reached');
            }
        }
        counter.html(feedback);
        counter.css('color', color);
        return true;
    };
    return handler;
};

EditCommentForm.prototype.getCommentTruncator = function () {
    var me = this;
    return function () {
        var editor = me.getEditor();
        var text = editor.getText();
        var maxLength = askbot.data.maxCommentLength;
        if (text.length > maxLength) {
            text = text.substr(0, maxLength);
            editor.setText(text);
        }
    };
};

/**
 * @todo: clean up this method so it does just one thing
 */
EditCommentForm.prototype.canCancel = function () {
    if (this._element === null) {
        return true;
    }
    if (this._editor === undefined) {
        return true;
    }
    var ctext = this._editor.getText();
    if ($.trim(ctext) === $.trim(this._text)) {
        return true;
    } else if (this.confirmAbandon()) {
        return true;
    }
    this._editor.focus();
    return false;
};

EditCommentForm.prototype.getCancelHandler = function () {
    var me = this;
    return function (evt) {
        if (me.canCancel()) {
            var widget = me.getCommentsWidget();
            widget.handleDeletedComment();
            me.detach();
            evt.preventDefault();
            $(document).trigger('askbot.afterEditCommentFormCancel', [me]);
        }
        return false;
    };
};

EditCommentForm.prototype.detach = function () {
    if (this._comment === null) {
        return;
    }
    this._comment.getContainerWidget().showOpenEditorButton();
    if (this._comment.isBlank()) {
        this._comment.dispose();
    } else {
        this._comment.getElement().show();
    }
    this.reset();
    this._element = this._element.detach();

    this._editor.dispose();
    this._editor = undefined;

    removeButtonEventHandlers(this._submit_btn);
    removeButtonEventHandlers(this._cancel_btn);
};

EditCommentForm.prototype.createDom = function () {
    this._element = $('<form></form>');
    this._element.attr('class', 'post-comments');

    var div = $('<div></div>');
    this._element.append(div);

    /** a stub container for the editor */
    this._editorBox = div;
    /**
     * editor itself will live at this._editor
     * and will be initialized by the attachTo()
     */

    this._controlsBox = this.makeElement('div');
    this._controlsBox.addClass('edit-comment-buttons');
    div.append(this._controlsBox);

    this._text_counter = $('<span></span>').attr('class', 'counter');
    this._controlsBox.append(this._text_counter);

    this._submit_btn = $('<button></button>');
    addExtraCssClasses(this._submit_btn, 'primaryButtonClasses');
    this._controlsBox.append(this._submit_btn);
    this._cancel_btn = $('<button class="cancel"></button>');
    addExtraCssClasses(this._cancel_btn, 'cancelButtonClasses');
    this._cancel_btn.html(gettext('cancel'));
    this._controlsBox.append(this._cancel_btn);

    //if email alerts are enabled, add a checkbox "suppress_email"
    if (askbot.settings.enableEmailAlerts === true) {
        this._minorEditBox = this.makeElement('div');
        this._minorEditBox.addClass('checkbox');
        this._controlsBox.append(this._minorEditBox);
        var checkBox = this.makeElement('input');
        checkBox.attr('type', 'checkbox');
        checkBox.attr('name', 'suppress_email');
        checkBox.attr('id', 'suppress_email');
        this._minorEditBox.append(checkBox);
        var label = this.makeElement('label');
        label.attr('for', 'suppress_email');
        label.html(gettext('minor edit (don\'t send alerts)'));
        this._minorEditBox.append(label);
    }

};

EditCommentForm.prototype.isEnabled = function () {
    return (this._submit_btn.attr('disabled') !== 'disabled');//confusing! setters use boolean
};

EditCommentForm.prototype.enableForm = function () {
    this._submit_btn.attr('disabled', false);
    this._cancel_btn.attr('disabled', false);
};

EditCommentForm.prototype.disableForm = function () {
    this._submit_btn.attr('disabled', true);
    this._cancel_btn.attr('disabled', true);
};

EditCommentForm.prototype.reset = function () {
    this._comment = null;
    this._text = '';
    this._editor.setText('');
    this.enableForm();
};

EditCommentForm.prototype.confirmAbandon = function () {
    this._editor.focus();
    this._editor.getElement().scrollTop();
    this._editor.setHighlight(true);
    var answer = confirm(
        gettext('Are you sure you don\'t want to post this comment?')
    );
    this._editor.setHighlight(false);
    return answer;
};

EditCommentForm.prototype.getSuppressEmail = function () {
    return this._element.find('input[name="suppress_email"]').is(':checked');
};

EditCommentForm.prototype.setSuppressEmail = function (bool) {
    this._element.find('input[name="suppress_email"]').prop('checked', bool).trigger('change');
};

EditCommentForm.prototype.updateUserPostsData = function(json) {
    //add any posts by the user to the list
    var data = askbot.data.user_posts;
    $.each(json, function(idx, item) {
        if (item.user_id === askbot.data.userId && !data[item.id]) {
            data[item.id] = 1;
        }
    });
};

EditCommentForm.prototype.getSaveHandler = function () {
    var me = this;
    var editor = this._editor;
    return function () {
        var commentData, timestamp, userName;
        if (me.isEnabled() === false) {//prevent double submits
            return false;
        }
        me.disableForm();

        var text = editor.getText();
        if (text.length < askbot.settings.minCommentBodyLength) {
            editor.focus();
            me.enableForm();
            return false;
        }

        //display the comment and show that it is not yet saved
        me.hide();
        me._comment.getElement().show();
        commentData = me._comment.getData();
        timestamp = commentData.comment_added_at || gettext('just now');
        if (me._comment.isBlank()) {
            userName = askbot.data.userName;
        } else {
            userName = commentData.user_display_name;
        }

        me._comment.setContent({
            'html': editor.getHtml(),
            'text': text,
            'user_display_name': userName,
            'comment_added_at': timestamp,
            'user_profile_url': askbot.data.userProfileUrl,
            'user_avatar_url': askbot.data.userCommentAvatarUrl
        });
        me._comment.setDraftStatus(true);
        var postCommentsWidget = me._comment.getContainerWidget();
        if (postCommentsWidget.canAddComment()) {
            postCommentsWidget.showOpenEditorButton();
        }
        var commentsElement = postCommentsWidget.getElement();
        commentsElement.trigger('askbot.beforeCommentSubmit');

        var post_data = {
            comment: text,
            avatar_size: askbot.settings.commentAvatarSize
        };

        if (me._type === 'edit') {
            post_data.comment_id = me._comment.getId();
            post_url = askbot.urls.editComment;
            post_data.suppress_email = me.getSuppressEmail();
            me.setSuppressEmail(false);
        } else {
            post_data.post_type = me._comment.getParentType();
            post_data.post_id = me._comment.getParentId();
            post_url = askbot.urls.postComments;
        }

        $.ajax({
            type: 'POST',
            url: post_url,
            dataType: 'json',
            data: post_data,
            success: function (json) {
                //type is 'edit' or 'add'
                me._comment.setDraftStatus(false);
                if (me._type === 'add') {
                    me._comment.dispose();
                    me.updateUserPostsData(json);
                    me._comment.getContainerWidget().reRenderComments(json);
                } else {
                    me._comment.setContent(json);
                }
                me.detach();
                commentsElement.trigger('askbot.afterCommentSubmitSuccess');
            },
            error: function (xhr, textStatus) {
                me._comment.getElement().show();
                showMessage(me._comment.getElement(), xhr.responseText, 'after');
                me._comment.setDraftStatus(false);
                me.detach();
                me.enableForm();
                commentsElement.trigger('askbot.afterCommentSubmitError');
            }
        });
        return false;
    };
};

var Comment = function (widget, data) {
    WrappedElement.call(this);
    this._container_widget = widget;
    this._data = data || {};
    this._element = null;
    this._is_convertible = askbot.data.userIsAdminOrMod;
    this.convert_link = null;
    this._delete_prompt = gettext('delete this comment');
    this._editorForm = undefined;
    if (data && data.is_deletable) {
        this._deletable = data.is_deletable;
    } else {
        this._deletable = false;
    }
    if (data && data.is_editable) {
        this._editable = data.is_deletable;
    } else {
        this._editable = false;
    }
};
inherits(Comment, WrappedElement);

Comment.prototype.getData = function () {
    return this._data;
};

Comment.prototype.startEditing = function () {
    var form = this._editorForm || new EditCommentForm();
    this._editorForm = form;
    // if new comment:
    if (this.isBlank()) {
        form.attachTo(this, 'add');
    } else {
        form.attachTo(this, 'edit');
    }
    form.show();
};

Comment.prototype.decorate = function (element) {
    this._element = $(element);
    var parent_type = this._element.closest('.comments').data('parentPostType');
    var comment_id = this._element.data('postId') || undefined;
    this._data = {'id': comment_id};

    this._contentBox = this._element.find('.comment-content');

    var timestamp = this._element.find('.timeago');
    this._dateElement = timestamp;
    this._data.comment_added_at = timestamp.attr('title');
    var userLink = this._element.find('.author');
    this._data.user_display_name = userLink.html();
    // @todo: read other data

    var commentBody = this._element.find('.comment-body');
    if (commentBody.length > 0) {
        this._comment_body = commentBody;
    }

    var delete_img = this._element.find('.js-delete-icon');
    if (delete_img.length > 0) {
        this._deletable = true;
        this._delete_icon = new DeleteIcon(this.deletePrompt);
        this._delete_icon.setHandler(this.getDeleteHandler());
        this._delete_icon.decorate(delete_img);
    }
    var edit_link = this._element.find('.js-edit');
    if (edit_link.length > 0) {
        this._editable = true;
        this._edit_link = new EditLink();
        this._edit_link.setHandler(this.getEditHandler());
        this._edit_link.decorate(edit_link);
    }

    var convert_link = this._element.find('.convert-comment');
    if (this._is_convertible) {
        this._convert_link = new CommentConvertLink(comment_id);
        this._convert_link.decorate(convert_link);
    } else {
        convert_link.remove();
    }

    var deleter = this._element.find('.comment-delete');
    if (deleter.length > 0) {
        this._comment_delete = deleter;
    }

    var vote = new CommentVoteButton(this);
    vote.decorate(this._element.find('.upvote'));
    this._voteButton = vote;

    this._userLink = this._element.find('.author');

    this._element.trigger('askbot.afterCommentDecorate', [this]);
};

Comment.prototype.setDraftStatus = function (isDraft) {
    return;
    //@todo: implement nice feedback about posting in progress
    //maybe it should be an element that lasts at least a second
    //to avoid the possible brief flash
    // if (isDraft === true) {
    //     this._normalBackground = this._element.css('background');
    //     this._element.css('background', 'rgb(255, 243, 195)');
    // } else {
    //     this._element.css('background', this._normalBackground);
    // }
};


Comment.prototype.isBlank = function () {
    return this.getId() === undefined;
};

Comment.prototype.getId = function () {
    return this._data ? this._data.id : undefined;
};

Comment.prototype.hasContent = function () {
    return ('id' in this._data);
    //shortcut for 'user_profile_url' 'html' 'user_display_name' 'comment_age'
};

Comment.prototype.hasText = function () {
    return ('text' in this._data);
};

Comment.prototype.getContainerWidget = function () {
    return this._container_widget;
};

Comment.prototype.getParentType = function () {
    return this._container_widget.getPostType();
};

Comment.prototype.getParentId = function () {
    return this._container_widget.getPostId();
};

/**
 * this function is basically an "updateDom"
 */
Comment.prototype.setContent = function (data) {
    this._data = $.extend(this._data, data);
    data = this._data;
    this._element.data('postId', data.id);
    this._element.attr('data-post-id', data.id);
    this._element.attr('id', 'post-id-' + data.id);

    // 1) create the votes element if it is not there
    var vote = this._voteButton;
    vote.setVoted(data.upvoted_by_user);
    vote.setScore(data.score);

    // 2) maybe adjust deletable status
    //set id of the comment deleter
    if (data.id) {
        var deleter = this._element.find('.comment-delete');
        deleter.attr('id', 'post-' + data.id.toString() + '-delete');
    }

    // 3) set the comment html
    if (EditCommentForm.prototype.getEditorType() === 'tinymce') {
        var theComment = $('<div/>');
        theComment.html(data.html);
        //sanitize, just in case
        this._comment_body.empty();
        this._comment_body.append(theComment);
        this._data.text = data.html;
    } else {
        this._comment_body.empty();
        this._comment_body.html(data.html);
    }

    // 4) update user info
    this._userLink.attr('href', data.user_profile_url);
    this._userLink.html(data.user_display_name);

    // 5) update avatar
    var avatar = this._element.find('.js-avatar-box');
    if (avatar.length) {
        avatar.attr('href', data.user_profile_url);
        var img = avatar.find('.js-avatar');
        img.attr('src', decodeHtml(data.user_avatar_url));//with decoded &amp;
    }

    // 6) update the timestamp
    this._dateElement.html(data.comment_added_at);
    this._dateElement.attr('title', data.comment_added_at);
    this._dateElement.timeago();

    // 7) set comment score
    if (data.score) {
        var votes = this._element.find('.js-score');
        votes.text(data.score);
        votes.attr('id', 'comment-img-upvote-' + data.id.toString());
    }

    // 8) possibly add edit link
    if (this._editable) {
        var oldEditLink = this._edit_link;
        this._edit_link = new EditLink();
        this._edit_link.setHandler(this.getEditHandler());
        oldEditLink.getElement().replaceWith(this._edit_link.getElement());
        oldEditLink.dispose();
    }

    if (this._is_convertible) {
        var oldConvertLink = this._convert_link;
        this._convert_link = new CommentConvertLink(this._data.id);
        oldConvertLink.getElement().replaceWith(this._convert_link.getElement());
        //this has to be here, because if we trigger events inside of the
        //CommentConvertLink functions since the element is not yet in the dom we
        //will never catch the event
        this._convert_link.getElement().trigger('askbot.afterCommentConvertLinkInserted', [this._convert_link]);
        oldConvertLink.dispose();
    }
    //maybe hide edit/delete buttons
    if (data.id) {
        askbot['functions']['renderPostControls'](data.id.toString());
        askbot['functions']['renderPostVoteButtons']('comment', data.id.toString());
    }
    if (askbot.settings.mathjaxEnabled === true) {
        runMathJax();
    }
    this._element.trigger('askbot.afterCommentSetData', [this, data]);
};

Comment.prototype.dispose = function () {
    if (this._comment_body) {
        this._comment_body.remove();
    }
    if (this._comment_delete) {
        this._comment_delete.remove();
    }
    if (this._user_link) {
        this._user_link.remove();
    }
    if (this._comment_added_at) {
        this._comment_added_at.remove();
    }
    if (this._delete_icon) {
        this._delete_icon.dispose();
    }
    if (this._edit_link) {
        this._edit_link.dispose();
    }
    if (this._convert_link) {
        this._convert_link.dispose();
    }
    this._data = null;
    Comment.superClass_.dispose.call(this);
};

Comment.prototype.getElement = function () {
    Comment.superClass_.getElement.call(this);
    if (this.isBlank() && this.hasContent()) {
        this.setContent();
    }
    return this._element;
};

Comment.prototype.loadText = function (on_load_handler) {
    var me = this;
    $.ajax({
        type: 'GET',
        url: askbot.urls.getComment,
        data: {id: this._data.id},
        success: function (json) {
            if (json.success) {
                me._data.text = json.text;
                on_load_handler();
            } else {
                showMessage(me.getElement(), json.message, 'after');
            }
        },
        error: function (xhr, textStatus, exception) {
            showMessage(me.getElement(), xhr.responseText, 'after');
        }
    });
};

Comment.prototype.getText = function () {
    if (!this.isBlank()) {
        if ('text' in this._data) {
            return this._data.text;
        }
    }
    return '';
};

Comment.prototype.getEditHandler = function () {
    var me = this;
    return function () {
        if (me.hasText()) {
            me.startEditing();
        } else {
            me.loadText(function () { me.startEditing(); });
        }
    };
};

Comment.prototype.getDeleteHandler = function () {
    var comment = this;
    var del_icon = this._delete_icon;
    return function () {
        if (confirm(gettext('confirm delete comment'))) {
            //comment.getElement().hide();
            $.ajax({
                type: 'POST',
                url: askbot.urls.deleteComment,
                data: {
                    comment_id: comment.getId(),
                    avatar_size: askbot.settings.commentAvatarSize
                },
                success: function (json, textStatus, xhr) {
                    var widget = comment.getContainerWidget();
                    comment.dispose();
                    widget.handleDeletedComment();
                },
                error: function (xhr, textStatus, exception) {
                    comment.getElement().show();
                    showMessage(del_icon.getElement(), xhr.responseText);
                },
                dataType: 'json'
            });
        }
    };
};

var PostCommentsWidget = function () {
    WrappedElement.call(this);
    this._denied = false;
};
inherits(PostCommentsWidget, WrappedElement);

PostCommentsWidget.prototype.decorate = function (element) {
    this._element = element;
    this._post_id = element.data('parentPostId');
    this._post_type = element.data('parentPostType');
    //var widget_id = element.attr('id');
    //this._userCanPost = askbot['data'][widget_id]['can_post'];
    this._commentsReversed = askbot.settings.commentsReversed;

    //see if user can comment here
    this._loadCommentsButton = element.find('.js-load-comments-btn');

    if (this._loadCommentsButton.length) {
        if (this._commentsReversed/* || this._userCanPost */) {
            setupButtonEventHandlers(
                this._loadCommentsButton,
                this.getLoadCommentsHandler()
            );
        } else {
            setupButtonEventHandlers(
                this._loadCommentsButton,
                this.getAllowEditHandler()
            );
        }
    }

    this._openEditorButton = element.find('.js-open-editor-btn');
    if (this._openEditorButton.length) {
        setupButtonEventHandlers(
            this._openEditorButton,
            this.getOpenEditorHandler(this._openEditorButton)
        );
    }

    this._isTruncated = this._openEditorButton.hasClass('hidden');

    this._cbox = element.find('.content');
    var comments = [];
    var me = this;
    this._cbox.children('.comment').each(function (index, element) {
        var comment = new Comment(me);
        comments.push(comment);
        comment.decorate(element);
    });
    this._comments = comments;
};

PostCommentsWidget.prototype.handleDeletedComment = function () {
    /* if the widget does not have any comments, set
    the 'empty' class on the widget element */
    if (this._cbox.children('.comment').length === 0) {
        if (this._commentsReversed === false) {
            this._element.siblings('.comment-title').hide();
        }
        this._element.addClass('empty');
    }
};

PostCommentsWidget.prototype.getPostType = function () {
    return this._post_type;
};

PostCommentsWidget.prototype.getPostId = function () {
    return this._post_id;
};

PostCommentsWidget.prototype.getLoadCommentsButton = function () {
    return this._loadCommentsButton;
};

PostCommentsWidget.prototype.getOpenEditorButton = function () {
    return this._openEditorButton;
};

PostCommentsWidget.prototype.hideOpenEditorButton = function () {
    this._openEditorButton.hide();
    this._openEditorButton.addClass('hidden');
};

PostCommentsWidget.prototype.showOpenEditorButton = function () {
    this._openEditorButton.show();
    this._openEditorButton.removeClass('hidden');
};

PostCommentsWidget.prototype.startNewComment = function () {
    //find comment template, clone it's dom
    var comment = new Comment(this);
    var commentElem = getTemplate('.js-comment');
    if (this._commentsReversed) {
        this._cbox.prepend(commentElem);
    } else {
        this._cbox.append(commentElem);
    }
    comment.decorate(commentElem);
    this._element.removeClass('empty');
    this._element.trigger('askbot.beforeCommentStart');
    comment.startEditing();
};

PostCommentsWidget.prototype.canAddComment = function () {
    return this._commentsReversed || this._isTruncated === false;
};

PostCommentsWidget.prototype.userCanPost = function () {
    var data = askbot.data;
    if (data.userIsAuthenticated) {
        //true if admin, post owner or high rep user
        if (data.userIsAdminOrMod) {
            return true;
        } else if (this.getPostId() in data.user_posts) {
            return true;
        }
    }
    return false;
};

PostCommentsWidget.prototype.getAllowEditHandler = function () {
    var me = this;
    return function () {
        me.reloadAllComments(function (json) {
            me.reRenderComments(json);
            //2) change button text to "post a comment"
            me.getLoadCommentsButton().remove();
            me.showOpenEditorButton();
        });
    };
};

PostCommentsWidget.prototype.getOpenEditorHandler = function (button) {
    var me = this;
    return function () {
        //if user can't post, we tell him something and refuse
        var message;
        if (askbot.settings.readOnlyModeEnabled === true) {
            message = askbot.messages.readOnlyMessage;
            showMessage(button, message, 'after');
        } else if (askbot.data.userIsAuthenticated) {
            me.startNewComment();
        } else {
            message = gettext(
                'please sign in or register to post comments'
            );
            showMessage(button, message, 'after');
        }
    };
};

PostCommentsWidget.prototype.getLoadCommentsHandler = function () {
    var me = this;
    return function () {
        me.reloadAllComments(function (json) {
            me.reRenderComments(json);
            me.getLoadCommentsButton().remove();
        });
    };
};


PostCommentsWidget.prototype.reloadAllComments = function (callback) {
    var post_data = {
        post_id: this._post_id,
        post_type: this._post_type,
        avatar_size: askbot.settings.commentAvatarSize
    };
    var me = this;
    $.ajax({
        type: 'GET',
        url: askbot.urls.postComments,
        data: post_data,
        success: function (json) {
            callback(json);
            me._isTruncated = false;
        },
        dataType: 'json'
    });
};

PostCommentsWidget.prototype.reRenderComments = function (json) {
    var me = this;
    me._cbox.trigger('askbot.beforeReRenderComments', [this, json]);
    $.each(this._comments, function (i, item) {
        item.dispose();
    });
    this._comments = [];
    $.each(json, function (i, item) {
        var comment = new Comment(me);
        var commentElem = getTemplate('.js-comment');
        me._cbox.append(commentElem);
        comment.decorate(commentElem);
        comment.setContent(item);
        me._comments.push(comment);
    });
    me._cbox.trigger('askbot.afterReRenderComments', [this, json]);
};


var socialSharing = (function () {

    var SERVICE_DATA = {
        //url - template for the sharing service url, params are for the popup
        identica: {
            url: 'http://identi.ca/notice/new?status_textarea={TEXT}%20{URL}',
            params: 'width=820, height=526,toolbar=1,status=1,resizable=1,scrollbars=1'
        },
        twitter: {
            url: 'http://twitter.com/share?url={URL}&ref=twitbtn&text={TEXT}',
            params: 'width=820,height=526,toolbar=1,status=1,resizable=1,scrollbars=1'
        },
        facebook: {
            url: 'http://www.facebook.com/sharer.php?u={URL}&ref=fbshare&t={TEXT}',
            params: 'width=630,height=436,toolbar=1,status=1,resizable=1,scrollbars=1'
        },
        linkedin: {
            url: 'http://www.linkedin.com/shareArticle?mini=true&url={URL}&title={TEXT}',
            params: 'width=630,height=436,toolbar=1,status=1,resizable=1,scrollbars=1'
        }
    };
    var URL = '';
    var TEXT = '';

    var share_page = function (service_name) {
        if (SERVICE_DATA[service_name]) {
            var url = SERVICE_DATA[service_name].url;
            url = url.replace('{TEXT}', TEXT);
            url = url.replace('{URL}', URL);
            var params = SERVICE_DATA[service_name].params;
            if (!window.open(url, 'sharing', params)) {
                window.location.href = url;
            }
            return false;
            //@todo: change to some other url shortening service
            // $.ajax({
            //     url: "http://json-tinyurl.appspot.com/?&callback=?",
            //     dataType: 'json',
            //     data: {'url':URL},
            //     success: function (data) {
            //         url = url.replace('{URL}', data.tinyurl);
            //     },
            //     error: function (xhr, opts, error) {
            //         url = url.replace('{URL}', URL);
            //     },
            //     complete: function (data) {
            //         url = url.replace('{TEXT}', TEXT);
            //         var params = SERVICE_DATA[service_name].params;
            //         if (!window.open(url, "sharing", params)) {
            //             window.location.href=url;
            //         }
            //     }
            // });
        }
    };

    return {
        init: function () {
            URL = window.location.href;
            var urlBits = URL.split('/');
            URL = urlBits.slice(0, -2).join('/') + '/';
            TEXT = encodeURIComponent($('h1 > a').text());
            var hashtag = encodeURIComponent(
                                askbot.settings.sharingSuffixText
                            );
            TEXT = TEXT.substr(0, 134 - URL.length - hashtag.length);
            TEXT = TEXT + '... ' + hashtag;
            var fb = $('a.facebook-share');
            var tw = $('a.twitter-share');
            var ln = $('a.linkedin-share');
            var ica = $('a.identica-share');
            copyAltToTitle(fb);
            copyAltToTitle(tw);
            copyAltToTitle(ln);
            copyAltToTitle(ica);
            setupButtonEventHandlers(fb, function () { share_page('facebook'); });
            setupButtonEventHandlers(tw, function () { share_page('twitter'); });
            setupButtonEventHandlers(ln, function () { share_page('linkedin'); });
            setupButtonEventHandlers(ica, function () { share_page('identica'); });
        }
    };
})();

/**
 * @constructor
 * @todo: change this to generic object description editor
 */
var TagWikiEditor = function () {
    WrappedElement.call(this);
    this._state = 'display';//'edit' or 'display'
    this._content_backup  = '';
    this._is_editor_loaded = false;
    this._enabled_editor_buttons = null;
    this._previewerEnabled = false;
};
inherits(TagWikiEditor, WrappedElement);

TagWikiEditor.prototype.backupContent = function () {
    this._content_backup = this._content_box.contents();
};

TagWikiEditor.prototype.setEnabledEditorButtons = function (buttons) {
    this._enabled_editor_buttons = buttons;
};

TagWikiEditor.prototype.setPreviewerEnabled = function (state) {
    this._previewerEnabled = state;
    if (this.isEditorLoaded()) {
        this._editor.setPreviewerEnabled(this._previewerEnabled);
    }
};

TagWikiEditor.prototype.setContent = function (content) {
    this._content_box.empty();
    this._content_box.append(content);
};

TagWikiEditor.prototype.setState = function (state) {
    if (state === 'edit') {
        this._state = state;
        this._edit_btn.hide();
        this._cancel_btn.show();
        this._save_btn.show();
        this._cancel_sep.show();
    } else if (state === 'display') {
        this._state = state;
        this._edit_btn.show();
        this._cancel_btn.hide();
        this._cancel_sep.hide();
        this._save_btn.hide();
    }
};

TagWikiEditor.prototype.restoreContent = function () {
    var content_box = this._content_box;
    content_box.empty();
    $.each(this._content_backup, function (idx, element) {
        content_box.append(element);
    });
};

TagWikiEditor.prototype.getTagId = function () {
    return this._tag_id;
};

TagWikiEditor.prototype.isEditorLoaded = function () {
    return this._is_editor_loaded;
};

TagWikiEditor.prototype.setEditorLoaded = function () {
    this._is_editor_loaded = true;
    return true;
};

/**
 * loads initial data for the editor input and activates
 * the editor
 */
TagWikiEditor.prototype.startActivatingEditor = function () {
    var editor = this._editor;
    var me = this;
    var data = {
        object_id: me.getTagId(),
        model_name: 'Group'
    };
    $.ajax({
        type: 'GET',
        url: askbot.urls.load_object_description,
        data: data,
        cache: false,
        success: function (data) {
            me.backupContent();
            editor.setText(data);
            me.setContent(editor.getElement());
            me.setState('edit');
            if (me.isEditorLoaded() === false) {
                editor.start();
                me.setEditorLoaded();
            }
        }
    });
};

TagWikiEditor.prototype.saveData = function () {
    var me = this;
    var text = this._editor.getText();
    var data = {
        object_id: me.getTagId(),
        model_name: 'Group',//todo: fixme
        text: text
    };
    $.ajax({
        type: 'POST',
        dataType: 'json',
        url: askbot.urls.save_object_description,
        data: data,
        cache: false,
        success: function (data) {
            if (data.success) {
                me.setState('display');
                me.setContent(data.html);
            } else {
                showMessage(me.getElement(), data.message);
            }
        }
    });
};

TagWikiEditor.prototype.cancelEdit = function () {
    this.restoreContent();
    this.setState('display');
};

TagWikiEditor.prototype.decorate = function (element) {
    //expect <div id='group-wiki-{{id}}'><div class="content"/><a class="edit"/></div>
    this._element = element;
    var edit_btn = element.find('.edit-description');
    this._edit_btn = edit_btn;

    //adding two buttons...
    var save_btn = this.makeElement('a');
    save_btn.html(gettext('save'));
    edit_btn.after(save_btn);
    save_btn.hide();
    this._save_btn = save_btn;

    var cancel_btn = this.makeElement('a');
    cancel_btn.html(gettext('cancel'));
    save_btn.after(cancel_btn);
    cancel_btn.hide();
    this._cancel_btn = cancel_btn;

    this._cancel_sep = $('<span> | </span>');
    cancel_btn.before(this._cancel_sep);
    this._cancel_sep.hide();

    this._content_box = element.find('.content');
    this._tag_id = element.attr('id').split('-').pop();

    var me = this;
    var editor;
    if (askbot.settings.editorType === 'markdown') {
        editor = new WMD({minLines: 3});
    } else {
        editor = new TinyMCE({//override defaults
            theme_advanced_buttons1: 'bold, italic, |, link, |, numlist, bullist',
            theme_advanced_buttons2: '',
            theme_advanced_path: false,
            plugins: ''
        });
    }
    if (this._enabled_editor_buttons) {
        editor.setEnabledButtons(this._enabled_editor_buttons);
    }
    editor.setPreviewerEnabled(this._previewerEnabled);
    this._editor = editor;
    setupButtonEventHandlers(edit_btn, function () { me.startActivatingEditor(); });
    setupButtonEventHandlers(cancel_btn, function () {me.cancelEdit(); });
    setupButtonEventHandlers(save_btn, function () {me.saveData(); });
};

var ImageChanger = function () {
    WrappedElement.call(this);
    this._image_element = undefined;
    this._delete_button = undefined;
    this._save_url = undefined;
    this._delete_url = undefined;
    this._messages = undefined;
};
inherits(ImageChanger, WrappedElement);

ImageChanger.prototype.setImageElement = function (image_element) {
    this._image_element = image_element;
};

ImageChanger.prototype.setMessages = function (messages) {
    this._messages = messages;
};

ImageChanger.prototype.setDeleteButton = function (delete_button) {
    this._delete_button = delete_button;
};

ImageChanger.prototype.setSaveUrl = function (url) {
    this._save_url = url;
};

ImageChanger.prototype.setDeleteUrl = function (url) {
    this._delete_url = url;
};

ImageChanger.prototype.setAjaxData = function (data) {
    this._ajax_data = data;
};

ImageChanger.prototype.showImage = function (image_url) {
    this._image_element.attr('src', image_url);
    this._image_element.show();
};

ImageChanger.prototype.deleteImage = function () {
    this._image_element.attr('src', '');
    this._image_element.css('display', 'none');

    var me = this;
    var delete_url = this._delete_url;
    var data = this._ajax_data;
    $.ajax({
        type: 'POST',
        dataType: 'json',
        url: delete_url,
        data: data,
        cache: false,
        success: function (data) {
            if (data.success) {
                showMessage(me.getElement(), data.message, 'after');
            }
        }
    });
};

ImageChanger.prototype.saveImageUrl = function (image_url) {
    var me = this;
    var data = this._ajax_data;
    data.image_url = image_url;
    var save_url = this._save_url;
    $.ajax({
        type: 'POST',
        dataType: 'json',
        url: save_url,
        data: data,
        cache: false,
        success: function (data) {
            if (!data.success) {
                showMessage(me.getElement(), data.message, 'after');
            }
        }
    });
};

ImageChanger.prototype.startDialog = function () {
    //reusing the wmd's file uploader
    var me = this;
    var change_image_text = this._messages.change_image;
    var change_image_button = this._element;
    Attacklab.Util.prompt(
        '<h3>' + gettext('Enter the logo url or upload an image') + '</h3>',
        'http://',
        function (image_url) {
            if (image_url) {
                me.saveImageUrl(image_url);
                me.showImage(image_url);
                change_image_button.html(change_image_text);
                me.showDeleteButton();
            }
        },
        'image'
    );
};

ImageChanger.prototype.showDeleteButton = function () {
    this._delete_button.show();
    this._delete_button.prev().show();
};

ImageChanger.prototype.hideDeleteButton = function () {
    this._delete_button.hide();
    this._delete_button.prev().hide();
};


ImageChanger.prototype.startDeleting = function () {
    if (confirm(gettext('Do you really want to remove the image?'))) {
        this.deleteImage();
        this._element.html(this._messages.add_image);
        this.hideDeleteButton();
        this._delete_button.hide();
        var sep = this._delete_button.prev();
        sep.hide();
    }
};

/**
 * decorates an element that will serve as the image changer button
 */
ImageChanger.prototype.decorate = function (element) {
    this._element = element;
    var me = this;
    setupButtonEventHandlers(
        element,
        function () {
            me.startDialog();
        }
    );
    setupButtonEventHandlers(
        this._delete_button,
        function () {
            me.startDeleting();
        }
    );
};

var UserGroupProfileEditor = function () {
    TagWikiEditor.call(this);
};
inherits(UserGroupProfileEditor, TagWikiEditor);

UserGroupProfileEditor.prototype.toggleEmailModeration = function () {
    var btn = this._moderate_email_btn;
    var group_id = this.getTagId();
    $.ajax({
        type: 'POST',
        dataType: 'json',
        cache: false,
        data: {group_id: group_id},
        url: askbot.urls.toggle_group_email_moderation,
        success: function (data) {
            if (data.success) {
                btn.html(data.new_button_text);
            } else {
                showMessage(btn, data.message);
            }
        }
    });
};

UserGroupProfileEditor.prototype.decorate = function (element) {
    this.setEnabledEditorButtons('bold italic link ol ul');
    this.setPreviewerEnabled(false);
    UserGroupProfileEditor.superClass_.decorate.call(this, element);
    var change_logo_btn = element.find('.change-logo');
    this._change_logo_btn = change_logo_btn;

    var moderate_email_toggle = new AjaxToggle();
    moderate_email_toggle.setPostData({
        group_id: this.getTagId(),
        property_name: 'moderate_email'
    });
    var moderate_email_btn = element.find('#moderate-email');
    this._moderate_email_btn = moderate_email_btn;
    moderate_email_toggle.decorate(moderate_email_btn);

    var moderate_publishing_replies_toggle = new AjaxToggle();
    moderate_publishing_replies_toggle.setPostData({
        group_id: this.getTagId(),
        property_name: 'moderate_answers_to_enquirers'
    });
    var btn = element.find('#moderate-answers-to-enquirers');
    moderate_publishing_replies_toggle.decorate(btn);

    var vip_toggle = new AjaxToggle();
    vip_toggle.setPostData({
        group_id: this.getTagId(),
        property_name: 'is_vip'
    });
    btn = element.find('#vip-toggle');
    vip_toggle.decorate(btn);

    var readOnlyToggle = new AjaxToggle();
    readOnlyToggle.setPostData({
        group_id: this.getTagId(),
        property_name: 'read_only'
    });
    btn = element.find('#read-only-toggle');
    readOnlyToggle.decorate(btn);

    var opennessSelector = new DropdownSelect();
    var selectorElement = element.find('#group-openness-selector');
    opennessSelector.setPostData({
        group_id: this.getTagId(),
        property_name: 'openness'
    });
    opennessSelector.decorate(selectorElement);

    var email_editor = new TextPropertyEditor();
    email_editor.decorate(element.find('#preapproved-emails'));

    var domain_editor = new TextPropertyEditor();
    domain_editor.decorate(element.find('#preapproved-email-domains'));

    var logo_changer = new ImageChanger();
    logo_changer.setImageElement(element.find('.group-logo'));
    logo_changer.setAjaxData({
        group_id: this.getTagId()
    });
    logo_changer.setSaveUrl(askbot.urls.save_group_logo_url);
    logo_changer.setDeleteUrl(askbot.urls.delete_group_logo_url);
    logo_changer.setMessages({
        change_image: gettext('change logo'),
        add_image: gettext('add logo')
    });
    var delete_logo_btn = element.find('.delete-logo');
    logo_changer.setDeleteButton(delete_logo_btn);
    logo_changer.decorate(change_logo_btn);
};

var GroupJoinButton = function () {
    AjaxToggle.call(this);
};
inherits(GroupJoinButton, AjaxToggle);

GroupJoinButton.prototype.getPostData = function () {
    return { group_id: this._group_id };
};

GroupJoinButton.prototype.getHandler = function () {
    var me = this;
    return function () {
        $.ajax({
            type: 'POST',
            dataType: 'json',
            cache: false,
            data: me.getPostData(),
            url: askbot.urls.join_or_leave_group,
            success: function (data) {
                if (data.success) {
                    var level = data.membership_level;
                    var new_state = 'off-state';
                    if (level === 'full' || level === 'pending') {
                        new_state = 'on-state';
                    }
                    me.setState(new_state);
                } else {
                    showMessage(me.getElement(), data.message);
                }
            }
        });
    };
};
GroupJoinButton.prototype.decorate = function (elem) {
    GroupJoinButton.superClass_.decorate.call(this, elem);
    this._group_id = this._element.data('groupId');
};

var TagEditor = function () {
    WrappedElement.call(this);
    this._has_hot_backspace = false;
    this._settings = JSON.parse(askbot.settings.tag_editor);
};
inherits(TagEditor, WrappedElement);

TagEditor.prototype.getSelectedTags = function () {
    return $.trim(this._hidden_tags_input.val()).split(/\s+/);
};

TagEditor.prototype.setSelectedTags = function (tag_names) {
    this._hidden_tags_input.val($.trim(tag_names.join(' ')));
};

TagEditor.prototype.addSelectedTag = function (tag_name) {
    var tag_names = this._hidden_tags_input.val();
    this._hidden_tags_input.val(tag_names + ' ' + tag_name);
    $('.acResults').hide();//a hack to hide the autocompleter
};

TagEditor.prototype.isSelectedTagName = function (tag_name) {
    var tag_names = this.getSelectedTags();
    return $.inArray(tag_name, tag_names) !== -1;
};

TagEditor.prototype.removeSelectedTag = function (tag_name) {
    var tag_names = this.getSelectedTags();
    var idx = $.inArray(tag_name, tag_names);
    if (idx !== -1) {
        tag_names.splice(idx, 1);
    }
    this.setSelectedTags(tag_names);
};

TagEditor.prototype.getTagDeleteHandler = function (tag) {
    var me = this;
    return function () {
        me.removeSelectedTag(tag.getName());
        me.clearErrorMessage();
        var li = tag.getElement().parent();
        tag.dispose();
        li.remove();
        $('.acResults').hide();//a hack to hide the autocompleter
        me.fixHeight();
    };
};

TagEditor.prototype.cleanTag = function (tag_name, reject_dupe) {
    tag_name = $.trim(tag_name);
    tag_name = tag_name.replace(/\s+/, ' ');

    var force_lowercase = this._settings.force_lowercase_tags;
    if (force_lowercase) {
        tag_name = tag_name.toLowerCase();
    }

    if (reject_dupe && this.isSelectedTagName(tag_name)) {
        throw interpolate(
            gettext('tag "%s" was already added, no need to repeat (press "escape" to delete)'),
            [tag_name]
        );
    }

    var max_tags = this._settings.max_tags_per_post;
    if (this.getSelectedTags().length + 1 > max_tags) {//count current
        throw interpolate(
            ngettext(
                'a maximum of %s tag is allowed',
                'a maximum of %s tags are allowed',
                max_tags
            ),
            [max_tags]
        );
    }

    //generic cleaning
    return cleanTag(tag_name, this._settings);
};

TagEditor.prototype.addTag = function (tag_name) {
    var tag = new Tag();
    tag.setName(tag_name);
    tag.setDeletable(true);
    tag.setLinkable(true);
    tag.setDeleteHandler(this.getTagDeleteHandler(tag));
    var li = this.makeElement('li');
    this._tags_container.append(li);
    li.append(tag.getElement());
    this.addSelectedTag(tag_name);
};

TagEditor.prototype.immediateClearErrorMessage = function () {
    this._error_alert.html('');
    this._error_alert.show();
    //this._element.css('margin-top', '18px');//todo: the margin thing is a hack
};

TagEditor.prototype.clearErrorMessage = function (fade) {
    if (fade) {
        var me = this;
        this._error_alert.fadeOut(function () {
            me.immediateClearErrorMessage();
        });
    } else {
        this.immediateClearErrorMessage();
    }
};

TagEditor.prototype.setErrorMessage = function (text) {
    var old_text = this._error_alert.html();
    this._error_alert.html(text);
    if (old_text === '') {
        this._error_alert.hide();
        this._error_alert.fadeIn(100);
    }
    //this._element.css('margin-top', '0');//todo: remove this hack
};

TagEditor.prototype.getAddTagHandler = function () {
    var me = this;
    return function (tag_name) {
        if (me.isSelectedTagName(tag_name)) {
            return;
        }
        try {
            var clean_tag_name = me.cleanTag($.trim(tag_name));
            me.addTag(clean_tag_name);
            me.clearNewTagInput();
            me.fixHeight();
        } catch (error) {
            me.setErrorMessage(error);
            setTimeout(function () {
                me.clearErrorMessage(true);
            }, 1000);
        }
    };
};

TagEditor.prototype.getRawNewTagValue = function () {
    return this._visible_tags_input.val();//without trimming
};

TagEditor.prototype.clearNewTagInput = function () {
    return this._visible_tags_input.val('');
};

TagEditor.prototype.editLastTag = function () {
    //delete rendered tag
    var tc = this._tags_container;
    tc.find('li:last').remove();
    //remove from hidden tags input
    var tags = this.getSelectedTags();
    var last_tag = tags.pop();
    this.setSelectedTags(tags);
    //populate the tag editor
    this._visible_tags_input.val(last_tag);
    putCursorAtEnd(this._visible_tags_input);
};

TagEditor.prototype.setHotBackspace = function (is_hot) {
    this._has_hot_backspace = is_hot;
};

TagEditor.prototype.hasHotBackspace = function () {
    return this._has_hot_backspace;
};

TagEditor.prototype.completeTagInput = function (reject_dupe) {
    var tag_name = $.trim(this._visible_tags_input.val());
    try {
        tag_name = this.cleanTag(tag_name, reject_dupe);
        this.addTag(tag_name);
        this.clearNewTagInput();
    } catch (error) {
        this.setErrorMessage(error);
    }
};

TagEditor.prototype.saveHeight = function () {
    return;
    // var elem = this._visible_tags_input;
    // this._height = elem.offset().top;
};

TagEditor.prototype.fixHeight = function () {
    return;
    // var new_height = this._visible_tags_input.offset().top;
    // //@todo: replace this by real measurement
    // var element_height = parseInt(
    //     this._element.css('height').replace('px', '')
    // );
    // if (new_height > this._height) {
    //     this._element.css('height', element_height + 28);//magic number!!!
    // } else if (new_height < this._height) {
    //     this._element.css('height', element_height - 28);//magic number!!!
    // }
    // this.saveHeight();
};

TagEditor.prototype.closeAutoCompleter = function () {
    this._autocompleter.finish();
};

TagEditor.prototype.getTagInputKeyHandler = function () {
    var new_tags = this._visible_tags_input;
    var me = this;
    return function (e) {
        if (e.shiftKey) {
            return;
        }
        me.saveHeight();
        var key = e.which || e.keyCode;
        var text = me.getRawNewTagValue();

        //space 32, enter 13
        if (key === 32 || key === 13) {
            var tag_name = $.trim(text);
            if (tag_name.length > 0) {
                try {
                    tag_name = me.cleanTag(tag_name, true);
                    $.ajax({
                        type: 'POST',
                        url: askbot['urls']['cleanTagName'],
                        data: {'tag_name': tag_name},
                        dataType: 'json',
                        cache: false,
                        success: function (data) {
                            if (data['success']) {
                                me.addTag(data['cleaned_tag_name']);
                                me.clearNewTagInput();
                                me.fixHeight();
                            } else if (data['message']) {
                                me.setErrorMessage(data['message']);
                                setTimeout(function () {
                                    me.clearErrorMessage(true);
                                }, 1000);
                            }
                        }
                    });
                } catch (error) {
                    me.setErrorMessage(error);
                }
            }
            return false;
        }

        if (text === '') {
            me.clearErrorMessage();
            me.closeAutoCompleter();
        } else {
            try {
                /* do-nothing validation here
                 * just to report any errors while
                 * the user is typing */
                me.cleanTag(text);
                me.clearErrorMessage();
            } catch (error) {
                me.setErrorMessage(error);
            }
        }

        //8 is backspace
        if (key === 8 && text.length === 0) {
            if (me.hasHotBackspace() === true) {
                me.editLastTag();
                me.setHotBackspace(false);
            } else {
                me.setHotBackspace(true);
            }
        }

        //27 is escape
        if (key === 27) {
            me.clearNewTagInput();
            me.clearErrorMessage();
        }

        if (key !== 8) {
            me.setHotBackspace(false);
        }
        me.fixHeight();
        return false;
    };
};

TagEditor.prototype.decorate = function (element) {
    this._element = element;
    this._hidden_tags_input = element.find('input[name="tags"]');//this one is hidden
    this._tags_container = element.find('ul.tags');
    this._error_alert = $('.tag-editor-error-alert > span');

    var me = this;
    this._tags_container.children().each(function (idx, elem) {
        var tag = new Tag();
        tag.setDeletable(true);
        tag.setLinkable(false);
        tag.decorate($(elem));
        tag.setDeleteHandler(me.getTagDeleteHandler(tag));
    });

    var visible_tags_input = element.find('.new-tags-input');
    this._visible_tags_input = visible_tags_input;
    this.saveHeight();

    var tagsAc = new AutoCompleter({
        url: askbot.urls.get_tag_list,
        onItemSelect: function (item) {
            if (me.isSelectedTagName(item.value) === false) {
                me.completeTagInput();
            } else {
                me.clearNewTagInput();
            }
        },
        minChars: 1,
        useCache: true,
        matchInside: true,
        maxCacheLength: 100,
        delay: 10
    });
    tagsAc.decorate(visible_tags_input);
    this._autocompleter = tagsAc;
    visible_tags_input.keyup(this.getTagInputKeyHandler());

    element.click(function (e) {
        visible_tags_input.focus();
        return false;
    });
};

/**
 * @constructor
 * Category is a select box item
 * that has CategoryEditControls
 */
var Category = function () {
    SelectBoxItem.call(this);
    this._state = 'display';
    this._settings = JSON.parse(askbot.settings.tag_editor);
};
inherits(Category, SelectBoxItem);

Category.prototype.setCategoryTree = function (tree) {
    this._tree = tree;
};

Category.prototype.getCategoryTree = function () {
    return this._tree;
};

Category.prototype.getName = function () {
    return this.getContent().getContent();
};

Category.prototype.getPath = function () {
    return this._tree.getPathToItem(this);
};

Category.prototype.setState = function (state) {
    this._state = state;
    if (!this._element) {
        return;
    }
    this._input_box.val('');
    if (state === 'display') {
        this.showContent();
        this.hideEditor();
        this.hideEditControls();
    } else if (state === 'editable') {
        this._tree._state = 'editable';//a hack
        this.showContent();
        this.hideEditor();
        this.showEditControls();
    } else if (state === 'editing') {
        this._prev_tree_state = this._tree.getState();
        this._tree._state = 'editing';//a hack
        this._input_box.val(this.getName());
        this.hideContent();
        this.showEditor();
        this.hideEditControls();
    }
};

Category.prototype.hideEditControls = function () {
    this._delete_button.hide();
    this._edit_button.hide();
    this._element.unbind('mouseenter mouseleave');
};

Category.prototype.showEditControls = function () {
    var del = this._delete_button;
    var edit = this._edit_button;
    this._element.hover(
        function () {
            del.show();
            edit.show();
        },
        function () {
            del.hide();
            edit.hide();
        }
    );
};

Category.prototype.showEditControlsNow = function () {
    this._delete_button.show();
    this._edit_button.show();
};

Category.prototype.hideContent = function () {
    this.getContent().getElement().hide();
};

Category.prototype.showContent = function () {
    this.getContent().getElement().show();
};

Category.prototype.showEditor = function () {
    this._input_box.show();
    this._input_box.focus();
    this._save_button.show();
    this._cancel_button.show();
};

Category.prototype.hideEditor = function () {
    this._input_box.hide();
    this._save_button.hide();
    this._cancel_button.hide();
};

Category.prototype.getInput = function () {
    return this._input_box.val();
};

Category.prototype.getDeleteHandler = function () {
    var me = this;
    return function () {
        if (confirm(gettext('Delete category?'))) {
            var tree = me.getCategoryTree();
            $.ajax({
                type: 'POST',
                dataType: 'json',
                data: JSON.stringify({
                    tag_name: me.getName(),
                    path: me.getPath()
                }),
                cache: false,
                url: askbot.urls.delete_tag,
                success: function (data) {
                    if (data.success) {
                        //rebuild category tree based on data
                        tree.setData(data.tree_data);
                        //re-open current branch
                        tree.selectPath(tree.getCurrentPath());
                        tree.setState('editable');
                    } else {
                        alert(data.message);
                    }
                }
            });
        }
        return false;
    };
};

Category.prototype.getSaveHandler = function () {
    var me = this;
    var settings = this._settings;
    //here we need old value and new value
    return function () {
        var to_name = me.getInput();
        try {
            to_name = cleanTag(to_name, settings);
            var data = {
                from_name: me.getOriginalName(),
                to_name: to_name,
                path: me.getPath()
            };
            $.ajax({
                type: 'POST',
                dataType: 'json',
                data: JSON.stringify(data),
                cache: false,
                url: askbot.urls.rename_tag,
                success: function (data) {
                    if (data.success) {
                        me.setName(to_name);
                        me.setState('editable');
                        me.showEditControlsNow();
                    } else {
                        alert(data.message);
                    }
                }
            });
        } catch (error) {
            alert(error);
        }
        return false;
    };
};

Category.prototype.addControls = function () {
    var input_box = this.makeElement('input');
    input_box.attr('type', 'text');
    this._input_box = input_box;
    this._element.append(input_box);

    var save_button = this.makeButton(
        gettext('save'),
        this.getSaveHandler()
    );
    this._save_button = save_button;
    this._element.append(save_button);

    var me = this;
    var cancel_button = this.makeButton(
        'x',
        function () {
            me.setState('editable');
            me.showEditControlsNow();
            return false;
        }
    );
    this._cancel_button = cancel_button;
    this._element.append(cancel_button);

    var edit_button = this.makeButton(
        gettext('edit'),
        function () {
            //todo: I would like to make only one at a time editable
            //var tree = me.getCategoryTree();
            //tree.closeAllEditors();
            //tree.setState('editable');
            //calc path, then select it
            var tree = me.getCategoryTree();
            tree.selectPath(me.getPath());
            me.setState('editing');
            return false;
        }
    );
    this._edit_button = edit_button;
    this._element.append(edit_button);

    var delete_button = this.makeButton(
        'x', this.getDeleteHandler()
    );
    this._delete_button = delete_button;
    this._element.append(delete_button);
};

Category.prototype.getOriginalName = function () {
    return this._original_name;
};

Category.prototype.createDom = function () {
    Category.superClass_.createDom.call(this);
    this.addControls();
    this.setState('display');
    this._original_name = this.getName();
};

Category.prototype.decorate = function (element) {
    Category.superClass_.decorate.call(this, element);
    this.addControls();
    this.setState('display');
    this._original_name = this.getName();
};

var CategoryAdder = function () {
    WrappedElement.call(this);
    this._state = 'disabled';//waitedit
    this._tree = undefined;//category tree
    this._settings = JSON.parse(askbot.settings.tag_editor);
};
inherits(CategoryAdder, WrappedElement);

CategoryAdder.prototype.setCategoryTree = function (tree) {
    this._tree = tree;
};

CategoryAdder.prototype.setLevel = function (level) {
    this._level = level;
};

CategoryAdder.prototype.setState = function (state) {
    this._state = state;
    if (!this._element) {
        return;
    }
    if (state === 'waiting') {
        this._element.show();
        this._input.val('');
        this._input.hide();
        this._save_button.hide();
        this._cancel_button.hide();
        this._trigger.show();
    } else if (state === 'editable') {
        this._element.show();
        this._input.show();
        this._input.val('');
        this._input.focus();
        this._save_button.show();
        this._cancel_button.show();
        this._trigger.hide();
    } else if (state === 'disabled') {
        this.setState('waiting');//a little hack
        this._state = 'disabled';
        this._element.hide();
    }
};

CategoryAdder.prototype.cleanCategoryName = function (name) {
    name = $.trim(name);
    if (name === '') {
        throw gettext('category name cannot be empty');
    }
    //if ( this._tree.hasCategory(name) ) {
        //throw interpolate(
        //throw gettext('this category already exists');
        //    [this._tree.getDisplayPathByName(name)]
        //)
    //}
    return cleanTag(name, this._settings);
};

CategoryAdder.prototype.getPath = function () {
    var path = this._tree.getCurrentPath();
    if (path.length > this._level + 1) {
        return path.slice(0, this._level + 1);
    } else {
        return path;
    }
};

CategoryAdder.prototype.getSelectBox = function () {
    return this._tree.getSelectBox(this._level);
};

CategoryAdder.prototype.startAdding = function () {
    var name;
    try {
        name = this._input.val();
        name = this.cleanCategoryName(name);
    } catch (error) {
        alert(error);
        return;
    }

    //don't add dupes to the same level
    var existing_names = this.getSelectBox().getNames();
    if ($.inArray(name, existing_names) !== -1) {
        alert(gettext('already exists at the current level!'));
        return;
    }

    var me = this;
    var tree = this._tree;
    var adder_path = this.getPath();

    $.ajax({
        type: 'POST',
        dataType: 'json',
        data: JSON.stringify({
            path: adder_path,
            new_category_name: name
        }),
        url: askbot.urls.add_tag_category,
        cache: false,
        success: function (data) {
            if (data.success) {
                //rebuild category tree based on data
                tree.setData(data.tree_data);
                tree.selectPath(data.new_path);
                tree.setState('editable');
                me.setState('waiting');
            } else {
                alert(data.message);
            }
        }
    });
};

CategoryAdder.prototype.createDom = function () {
    this._element = this.makeElement('li');
    //add open adder link
    var trigger = this.makeElement('a');
    this._trigger = trigger;
    trigger.html(gettext('add category'));
    this._element.append(trigger);
    //add input box and the add button
    var input = this.makeElement('input');
    this._input = input;
    input.addClass('add-category');
    input.attr({
        'name': 'add_category',
        'type': 'text'
    });
    this._element.append(input);
    //add save category button
    var save_button = this.makeElement('button');
    this._save_button = save_button;
    save_button.html(gettext('save'));
    this._element.append(save_button);

    var cancel_button = this.makeElement('button');
    this._cancel_button = cancel_button;
    cancel_button.html('x');
    this._element.append(cancel_button);

    this.setState(this._state);

    var me = this;
    setupButtonEventHandlers(
        trigger,
        function () { me.setState('editable'); }
    );
    setupButtonEventHandlers(
        save_button,
        function () {
            me.startAdding();
            return false;//prevent form submit
        }
    );
    setupButtonEventHandlers(
        cancel_button,
        function () {
            me.setState('waiting');
            return false;//prevent submit
        }
    );
    //create input box, button and the "activate" link
};

/**
 * @constructor
 * SelectBox subclass to create/edit/delete
 * categories
 */
var CategorySelectBox = function () {
    SelectBox.call(this);
    this._item_class = Category;
    this._category_adder = undefined;
    this._tree = undefined;//cat tree
    this._level = undefined;
};
inherits(CategorySelectBox, SelectBox);

CategorySelectBox.prototype.setState = function (state) {
    this._state = state;
    if (state === 'select') {
        if (this._category_adder) {
            this._category_adder.setState('disabled');
        }
        $.each(this._items, function (idx, item) {
            item.setState('display');
        });
    } else if (state === 'editable') {
        this._category_adder.setState('waiting');
        $.each(this._items, function (idx, item) {
            item.setState('editable');
        });
    }
};

CategorySelectBox.prototype.setCategoryTree = function (tree) {
    this._tree = tree;
};

CategorySelectBox.prototype.getCategoryTree = function () {
};

CategorySelectBox.prototype.setLevel = function (level) {
    this._level = level;
};

CategorySelectBox.prototype.getNames = function () {
    var names = [];
    $.each(this._items, function (idx, item) {
        names.push(item.getName());
    });
    return names;
};

CategorySelectBox.prototype.appendCategoryAdder = function () {
    var adder = new CategoryAdder();
    adder.setLevel(this._level);
    adder.setCategoryTree(this._tree);
    this._category_adder = adder;
    this._element.append(adder.getElement());
};

CategorySelectBox.prototype.createDom = function () {
    CategorySelectBox.superClass_.createDom.call(this);
    if (askbot.data.userIsAdmin) {
        this.appendCategoryAdder();
    }
};

CategorySelectBox.prototype.decorate = function (element) {
    CategorySelectBox.superClass_.decorate.call(this, element);
    this.setState(this._state);
    if (askbot.data.userIsAdmin) {
        this.appendCategoryAdder();
    }
};

/**
 * @constructor
 * turns on/off the category editor
 */
var CategoryEditorToggle = function () {
    AjaxToggle.call(this);
};
inherits(CategoryEditorToggle, AjaxToggle);

CategoryEditorToggle.prototype.setCategorySelector = function (sel) {
    this._category_selector = sel;
};

CategoryEditorToggle.prototype.getCategorySelector = function () {
    return this._category_selector;
};

CategoryEditorToggle.prototype.decorate = function (element) {
    CategoryEditorToggle.superClass_.decorate.call(this, element);
};

CategoryEditorToggle.prototype.getDefaultHandler = function () {
    var me = this;
    return function () {
        var editor = me.getCategorySelector();
        if (me.isOn()) {
            me.setState('off-state');
            editor.setState('select');
        } else {
            me.setState('on-state');
            editor.setState('editable');
        }
    };
};

var CategorySelector = function () {
    Widget.call(this);
    this._data = null;
    this._select_handler = function () {};//dummy default
    this._current_path = [0];//path points to selected item in tree
};
inherits(CategorySelector, Widget);

/**
 * propagates state to the individual selectors
 */
CategorySelector.prototype.setState = function (state) {
    this._state = state;
    if (state === 'editing') {
        return;//do not propagate this state
    }
    $.each(this._selectors, function (idx, selector) {
        selector.setState(state);
    });
};

CategorySelector.prototype.getPathToItem = function (item) {
    function findPathToItemInTree(tree, item) {
        for (var i = 0; i < tree.length; i++) {
            var node = tree[i];
            if (node[2] === item) {
                return [i];
            }
            var path = findPathToItemInTree(node[1], item);
            if (path.length > 0) {
                path.unshift(i);
                return path;
            }
        }
        return [];
    }
    return findPathToItemInTree(this._data, item);
};

CategorySelector.prototype.applyToDataItems = function (func) {
    function applyToDataItems(tree) {
        $.each(tree, function (idx, item) {
            func(item);
            applyToDataItems(item[1]);
        });
    }
    if (this._data) {
        applyToDataItems(this._data);
    }
};

CategorySelector.prototype.setData = function (data) {
    this._data = data;
    var tree = this;
    function attachCategory(item) {
        var cat = new Category();
        cat.setName(item[0]);
        cat.setCategoryTree(tree);
        item[2] = cat;
    }
    this.applyToDataItems(attachCategory);
};

/**
 * clears contents of selector boxes starting from
 * the given level, in range 0..2
 */
CategorySelector.prototype.clearCategoryLevels = function (level) {
    for (var i = level; i < 3; i++) {
        this._selectors[i].detachAllItems();
    }
};

CategorySelector.prototype.getLeafItems = function (selection_path) {
    //traverse the tree down to items pointed to by the path
    var data = this._data[0];
    for (var i = 1; i < selection_path.length; i++) {
        data = data[1][selection_path[i]];
    }
    return data[1];
};

/**
 * called when a sub-level needs to open
 */
CategorySelector.prototype.populateCategoryLevel = function (source_path) {
    var level = source_path.length - 1;
    if (level >= 3) {
        return;
    }
    //clear all items downstream
    this.clearCategoryLevels(level);

    //populate current selector
    var selector = this._selectors[level];
    var items  = this.getLeafItems(source_path);

    $.each(items, function (idx, item) {
        var category_name = item[0];
        var category_subtree = item[1];
        var category_object = item[2];
        selector.addItemObject(category_object);
        if (category_subtree.length > 0) {
            category_object.addCssClass('tree');
        }
    });

    this.setState(this._state);//update state

    selector.clearSelection();
};

CategorySelector.prototype.selectPath = function (path) {
    var i;
    for (i = 1; i <= path.length; i++) {
        this.populateCategoryLevel(path.slice(0, i));
    }
    for (i = 1; i < path.length; i++) {
        var sel_box = this._selectors[i - 1];
        var category = sel_box.getItemByIndex(path[i]);
        sel_box.selectItem(category);
    }
};

CategorySelector.prototype.getSelectBox = function (level) {
    return this._selectors[level];
};

CategorySelector.prototype.getSelectedPath = function (selected_level) {
    var path = [0];//root, todo: better use names for path???
    /*
     * upper limit capped by current clicked level
     * we ignore all selection above the current level
     */
    for (var i = 0; i < selected_level + 1; i++) {
        var selector = this._selectors[i];
        var item = selector.getSelectedItem();
        if (item) {
            path.push(selector.getItemIndex(item));
        } else {
            return path;
        }
    }
    return path;
};

/** getter and setter are not symmetric */
CategorySelector.prototype.setSelectHandler = function (handler) {
    this._select_handler = handler;
};

CategorySelector.prototype.getSelectHandlerInternal = function () {
    return this._select_handler;
};

CategorySelector.prototype.setCurrentPath = function (path) {
    this._current_path = path;
    return true;
};

CategorySelector.prototype.getCurrentPath = function () {
    return this._current_path;
};

CategorySelector.prototype.getEditorToggle = function () {
    return this._editor_toggle;
};

/*CategorySelector.prototype.closeAllEditors = function () {
    $.each(this._selectors, function (idx, sel) {
        sel._category_adder.setState('wait');
        $.each(sel._items, function (idx2, item) {
            item.setState('editable');
        });
    });
};*/

CategorySelector.prototype.getSelectHandler = function (level) {
    var me = this;
    return function (item_data) {
        if (me.getState() === 'editing') {
            return;//don't navigate when editing
        }
        //1) run the assigned select handler
        var tag_name = item_data.title;
        if (me.getState() === 'select') {
            /* this one will actually select the tag
             * maybe a bit too implicit
             */
            me.getSelectHandlerInternal()(tag_name);
        }
        //2) if appropriate, populate the higher level
        if (level < 2) {
            var current_path = me.getSelectedPath(level);
            me.setCurrentPath(current_path);
            me.populateCategoryLevel(current_path);
        }
    };
};

CategorySelector.prototype.decorate = function (element) {
    this._element = element;
    this._selectors = [];

    var selector0 = new CategorySelectBox();
    selector0.setLevel(0);
    selector0.setCategoryTree(this);
    selector0.decorate(element.find('.cat-col-0'));
    selector0.setSelectHandler(this.getSelectHandler(0));
    this._selectors.push(selector0);

    var selector1 = new CategorySelectBox();
    selector1.setLevel(1);
    selector1.setCategoryTree(this);
    selector1.decorate(element.find('.cat-col-1'));
    selector1.setSelectHandler(this.getSelectHandler(1));
    this._selectors.push(selector1);

    var selector2 = new CategorySelectBox();
    selector2.setLevel(2);
    selector2.setCategoryTree(this);
    selector2.decorate(element.find('.cat-col-2'));
    selector2.setSelectHandler(this.getSelectHandler(2));
    this._selectors.push(selector2);

    if (askbot.data.userIsAdminOrMod) {
        var editor_toggle = new CategoryEditorToggle();
        editor_toggle.setCategorySelector(this);
        var toggle_element = $('.category-editor-toggle');
        toggle_element.show();
        editor_toggle.decorate(toggle_element);
        this._editor_toggle = editor_toggle;
    }

    this.populateCategoryLevel([0]);
};

/**
 * @constructor
 * loads html for the category selector from
 * the server via ajax and activates the
 * CategorySelector on the loaded HTML
 */
var CategorySelectorLoader = function () {
    WrappedElement.call(this);
    this._is_loaded = false;
};
inherits(CategorySelectorLoader, WrappedElement);

CategorySelectorLoader.prototype.setCategorySelector = function (sel) {
    this._category_selector = sel;
};

CategorySelectorLoader.prototype.setLoaded = function (is_loaded) {
    this._is_loaded = is_loaded;
};

CategorySelectorLoader.prototype.isLoaded = function () {
    return this._is_loaded;
};

CategorySelectorLoader.prototype.setEditor = function (editor) {
    this._editor = editor;
};

CategorySelectorLoader.prototype.closeEditor = function () {
    this._editor.hide();
    this._editor_buttons.hide();
    this._display_tags_container.show();
    this._question_body.show();
    this._question_controls.show();
};

CategorySelectorLoader.prototype.openEditor = function () {
    this._editor.show();
    this._editor_buttons.show();
    this._display_tags_container.hide();
    this._question_body.hide();
    this._question_controls.hide();
    var sel = this._category_selector;
    sel.setState('select');
    sel.getEditorToggle().setState('off-state');
};

CategorySelectorLoader.prototype.addEditorButtons = function () {
    this._editor.after(this._editor_buttons);
};

CategorySelectorLoader.prototype.getOnLoadHandler = function () {
    var me = this;
    return function (html) {
        me.setLoaded(true);

        //append loaded html to dom
        var editor = $('<div>' + html + '</div>');
        me.setEditor(editor);
        $('#question-tags').after(editor);

        var selector = askbot.functions.initCategoryTree();
        me.setCategorySelector(selector);

        me.addEditorButtons();
        me.openEditor();
        //add the save button
    };
};

CategorySelectorLoader.prototype.startLoadingHTML = function (on_load) {
    var me = this;
    $.ajax({
        type: 'GET',
        dataType: 'json',
        data: { template_name: 'widgets/tag_category_selector.html' },
        url: askbot.urls.get_html_template,
        cache: true,
        success: function (data) {
            if (data.success) {
                on_load(data.html);
            } else {
                showMessage(me.getElement(), data.message);
            }
        }
    });
};

CategorySelectorLoader.prototype.getRetagHandler = function () {
    var me = this;
    return function () {
        if (me.isLoaded() === false) {
            me.startLoadingHTML(me.getOnLoadHandler());
        } else {
            me.openEditor();
        }
        return false;
    };
};

CategorySelectorLoader.prototype.drawNewTags = function (new_tags) {
    var container = this._display_tags_container;
    container.html('');
    if (new_tags === '') {
        return;
    }

    new_tags = new_tags.split(/\s+/);
    var me = this;
    $.each(new_tags, function (index, name) {
        var li = me.makeElement('li');
        container.append(li);
        var tag = new Tag();
        tag.setName(name);
        li.append(tag.getElement());
    });
};

CategorySelectorLoader.prototype.getSaveHandler = function () {
    var me = this;
    return function () {
        var tagInput = $('input[name="tags"]');
        $.ajax({
            type: 'POST',
            url: askbot.urls.retag,
            dataType: 'json',
            data: { tags: getUniqueWords(tagInput.val()).join(' ') },
            success: function (json) {
                if (json.success) {
                    var new_tags = getUniqueWords(json.new_tags);
                    oldTagsHtml = '';
                    me.closeEditor();
                    me.drawNewTags(new_tags.join(' '));
                } else {
                    me.closeEditor();
                    showMessage(me.getElement(), json.message);
                }
            },
            error: function (xhr) {
                showMessage(tagsDiv, 'sorry, something is not right here');
                cancelRetag();
            }
        });
        return false;
    };
};

CategorySelectorLoader.prototype.getCancelHandler = function () {
    var me = this;
    return function () {
        me.closeEditor();
    };
};

CategorySelectorLoader.prototype.decorate = function (element) {
    this._element = element;
    this._display_tags_container = $('#question-tags');
    this._question_body = $('.question .post-body');
    this._question_controls = $('#question-controls');

    this._editor_buttons = this.makeElement('div');
    this._done_button = this.makeElement('button');
    this._done_button.html(gettext('save tags'));
    this._editor_buttons.append(this._done_button);

    this._cancel_button = this.makeElement('button');
    this._cancel_button.html(gettext('cancel'));
    this._editor_buttons.append(this._cancel_button);
    this._editor_buttons.find('button').addClass('submit');
    this._editor_buttons.addClass('retagger-buttons');

    //done button
    setupButtonEventHandlers(
        this._done_button,
        this.getSaveHandler()
    );
    //cancel button
    setupButtonEventHandlers(
        this._cancel_button,
        this.getCancelHandler()
    );

    //retag button
    setupButtonEventHandlers(
        element,
        this.getRetagHandler()
    );
};


var AskButton = function () {
    SimpleControl.call(this);
    this._handler = function (evt) {
        if (askbot.data.userIsReadOnly === true) {
            notify.show(gettext('Sorry, you have only read access'));
            evt.preventDefault();
        }
    };
};
inherits(AskButton, SimpleControl);


$(document).ready(function () {
    $('.comments').each(function (index, element) {
        var comments = new PostCommentsWidget();
        comments.decorate($(element));
    });
    $('[id^="post-id-"]').each(function (idx, element) {
        var deleter = new DeletePostLink();
        //confusingly .question-delete matches the answers too need rename
        var post_id = element.id.split('-').pop();
        deleter.setPostId(post_id);
        deleter.decorate($(element).find('.question-delete'));
    });
    //todo: convert to "control" class
    var publishBtns = $('.answer-publish, .answer-unpublish');
    publishBtns.each(function (idx, btn) {
        setupButtonEventHandlers($(btn), function () {
            var answerId = $(btn).data('answerId');
            $.ajax({
                type: 'POST',
                dataType: 'json',
                data: {'answer_id': answerId},
                url: askbot.urls.publishAnswer,
                success: function (data) {
                    if (data.success) {
                        window.location.reload(true);
                    } else {
                        showMessage($(btn), data.message);
                    }
                }
            });
        });
    });

    if (askbot.settings.tagSource === 'category-tree') {
        var catSelectorLoader = new CategorySelectorLoader();
        catSelectorLoader.decorate($('#retag'));
    } else {
        questionRetagger.init();
    }
    socialSharing.init();

    var proxyUserNameInput = $('#id_post_author_username');
    var proxyUserEmailInput = $('#id_post_author_email');
    if (proxyUserNameInput.length === 1) {

        var userSelectHandler = function (data) {
            proxyUserEmailInput.val(data.data[0]);
        };

        var fakeUserAc = new AutoCompleter({
            url: askbot.urls.get_users_info,
            minChars: 1,
            useCache: true,
            matchInside: true,
            maxCacheLength: 100,
            delay: 10,
            onItemSelect: userSelectHandler
        });
        fakeUserAc.decorate(proxyUserNameInput);
    }
    //if groups are enabled - activate share functions
    var groupsInput = $('#share_group_name');
    if (groupsInput.length === 1) {
        var groupsAc = new AutoCompleter({
            url: askbot.urls.getGroupsList,
            promptText: gettext('Group name:'),
            minChars: 1,
            useCache: false,
            matchInside: true,
            maxCacheLength: 100,
            delay: 10
        });
        groupsAc.decorate(groupsInput);
    }
    var usersInput = $('#share_user_name');
    if (usersInput.length === 1) {
        var usersAc = new AutoCompleter({
            url: '/get-users-info/',
            promptText: askbot.messages.userNamePrompt,
            minChars: 1,
            useCache: false,
            matchInside: true,
            maxCacheLength: 100,
            delay: 10
        });
        usersAc.decorate(usersInput);
    }

    var showSharedUsers = $('.see-related-users');
    if (showSharedUsers.length) {
        var usersPopup = new ThreadUsersDialog();
        usersPopup.setHeadingText(gettext('Shared with the following users:'));
        usersPopup.decorate(showSharedUsers);
    }
    var showSharedGroups = $('.see-related-groups');
    if (showSharedGroups.length) {
        var groupsPopup = new ThreadUsersDialog();
        groupsPopup.setHeadingText(gettext('Shared with the following groups:'));
        groupsPopup.decorate(showSharedGroups);
    }

    var askButton = new AskButton();
    askButton.decorate($('#askButton'));

    if (askbot.data.userIsThreadModerator) {
        var mergeQuestions = new MergeQuestionsDialog();
        $('body').append(mergeQuestions.getElement());
        var mergeBtn = $('.question-merge');
        setupButtonEventHandlers(mergeBtn, function () {
            mergeQuestions.show();
        });
    }
});

/**
 * @constructor
 * Adds in-place text editor for a text value
 * of a database object. Whether editing is
 * permissible is to be enforced in the backend
 */
var Editable = function(){
    WrappedElement.call(this);
    this._state = 'display';//'edit' or 'display'
    this._isEditorLoaded = false;
    this._enabledEditorButtons = null;
    this._isPreviewerEnabled = false;
};
inherits(Editable, WrappedElement);

Editable.prototype.backupContent = function(){
    this._contentBackup = this._contentBox.contents();
};

Editable.prototype.setEnabledEditorButtons = function(buttons){
    this._enabledEditorButtons = buttons;
};

Editable.prototype.setPreviewerEnabled = function(state){
    this._isPreviewerEnabled = state;
    if (this.isEditorLoaded()){
        this._editor.setPreviewerEnabled(state);
    }
};

Editable.prototype.setContent = function(content){
    this._content.empty();
    this._content.append(content);
    if (askbot.settings.mathjaxEnabled) {
        runMathJax();
    }
};

Editable.prototype.setState = function(state){
    if (state === 'edit'){
        this._state = state;
        this._editorBox.show();
        this._editBtn.hide();
        this._saveBtn.show();
        this._cancelBtn.show();
        this._hideables.hide();
        this._content.hide();
    } else if (state === 'display'){
        this._editorBox.hide();
        this._saveBtn.hide();
        this._cancelBtn.hide();
        this._editBtn.show();
        this._hideables.show();
        this._content.show();
    }
};

Editable.prototype.restoreContent = function(){
    var content_box = this._contentBox;
    content_box.empty();
    $.each(this._contentBackup, function(idx, element){
        content_box.append(element);
    });
};

Editable.prototype.isEditorLoaded = function(){
    return this._isEditorLoaded;
};

Editable.prototype.setEditorLoaded = function(){
    return this._isEditorLoaded = true;
};

Editable.prototype.getObjectId = function() {
    return this._objectId;
};

Editable.prototype.getAttributeName = function() {
    return this._attributeName;
};

Editable.prototype.startEditingText = function (text) {
    var ed = this._editor;
    this.setState('edit');
    if (this.isEditorLoaded() === false){
        ed.start();
        this.setEditorLoaded();
    }
    var onFocus = function () {
        ed.setText(text);
        ed.putCursorAtEnd();
    };
    ed.focus(onFocus);
}

/**
 * loads initial data for the editor input and activates
 * the editor
 */
Editable.prototype.startActivatingEditor = function (evt) {
    evt.preventDefault();
    var editor = this._editor;

    if (this._editorType == 'tinymce') {//take shortcut.
        this.startEditingText(this._content.html());
        return false;
    }

    var me = this;
    var paramName = this._saveTextParamName;

    $.ajax({
        type: 'GET',
        url: this._getTextUrl,
        data: this._getTextUrlParams,
        cache: false,
        success: function(data){
            me.startEditingText(data[paramName]);
        }
    });
    return false;
};

Editable.prototype.setError = function (text) {
    this._error.html(text);
};

Editable.prototype.clearError = function () {
    this._error.html('');
};

Editable.prototype.cancelEdit = function () {
    this.setState('display');
    this.clearError();
};

Editable.prototype.saveText = function () {
    var me = this;
    var editorText = this._editor.getText();

    if (this._editorType == 'tinymce') {
        editorText = stripTags(editorText);
    }

    if (this._validator) {
        try {
            this._validator(editorText);
            this.clearError();
        } catch (e) {
            this.setError(e);
            return;
        }
    }

    //optimistic update
    if (this._editorType === 'markdown') {
        var converter = getAskbotMarkdownConverter();
        editorText = converter.makeHtml(editorText);
    }
    this.setContent(editorText);
    this.setState('display');
    
    var data = this._saveTextUrlParams;
    editorText = this._editor.getText();
    data[this._saveTextParamName] = editorText;
    var validatedParamName = this._validatedTextParamName;

    $.ajax({
        type: 'POST',
        dataType: 'json',
        url: this._saveTextUrl,
        data: data,
        cache: false,
        success: function(data){
            if (data['success']){
                me.setContent(data[validatedParamName]);
            } else {
                me.setState('edit');
                showMessage(me.getElement(), data['message']);
            }
        }
    });
};

Editable.prototype.decorate = function(element){
     /* expected markup
        <div class="js-editable"
            id="js-<something>" //here "something" must be unique enough
            // 1. urls below are parsed and parameters added as part of request
            //    this way url parameter input is more compact and comes with the 
            //    corresponding url
            // 2. the getTextUrl is optional - if absent, text will be taken as
            //    displayed in the html. This feature won't work with the markdown editor
            data-get-text-url="{% url user_get_description %}?user_id={{ view_user.pk }}"
            data-save-text-url="{% url user_set_description %}?user_id={{ view_user.pk }}"
            // this parameter will be added to the POST request made to saveTextUrl
            data-save-text-param-name="description"
            // this parameter is optional, used to retreive data from server after saving
            // i.e. when saved data is first validated and perhaps parsed
            //if absent, assumed value will be the same as saveTextParamName
            data-validated-text-param-name="description_html"
            // depending on the editor type we might ignore the getTextUrl
            // as we need the access the url only in the case of markdown editor
            data-editor-type="<one of supported editor types>"
            data-editor-compact="true"//optional
        >
            //this item must be inside of js-editable
            <div class="js-editable-content">some text which will be editable</div>
            // the button as shown below does not have to be inside of js-editable.
            // we find the button by the Id, which starts with js-edit-btn and 
            // ends the same as id of the .js-editable
            // Also, the html elements of button and the container are not important,
            // only ids, class names and "data" parameters on the .js-editable
            // the <something> in the id below must be the same as in the id of
            // the .js-editable
            <button id="js-edit-btn-<something>">{% trans %}edit{% endtrans %}</button>
        </div>
    */
    var parsed, editor;
    this._element = element;
    //validate that id starts with "js-" and is longer than 3 chars
    var id = element.attr('id');
    if ( !id || id.length <= 3 ) {
        throw "id of .js-editable must have > 3 characters";
    }
    if ( id.substr(0, 3) !== 'js-' ) {
        throw "id of .js-editable must start with js-";
    }
    this._id = id.substr(3);
    this._content = element.find('.js-editable-content');
    //must be defined
    var editBtn = $(document.getElementById('js-edit-btn-' + this._id));
    if ( !editBtn ) {
        throw "edit button with id js-edit-btn-" + this._id + " is required";
    }
    this._editBtn = editBtn;

    var err = element.find('.js-error');
    if (err.length === 0) {
        err = this.makeElement('div');
        err.addClass('js-error');
        this._element.prepend(err);
    }
    this._error = err;

    //parse these two urls and separate url and the params
    var getTextUrl = element.data('getTextUrl');
    if (getTextUrl) {
        parsed = parseUrl(element.data('getTextUrl'));
        this._getTextUrl = parsed[0];
        this._getTextUrlParams = parsed[1];
    } else {
        this._getTextUrl = undefined;
        this._getTextUrlParams = undefined;
    }

    parsed = parseUrl(element.data('saveTextUrl'));
    this._saveTextUrl = parsed[0];
    this._saveTextUrlParams = parsed[1];

    this._saveTextParamName = element.data('saveTextParamName');
    this._validatedTextParamName = element.data('validatedTextParamName') || this._saveTextParamName;

    this._useCompactEditor = element.data('editorCompact');

    var validatorPath = element.data('validator');
    if (validatorPath) {
        this._validator = getObjectByPath(validatorPath);
    }

    //create container for the editor and buttons
    var editorBox = this.makeElement('div');
    this._content.after(editorBox);
    this._editorBox = editorBox;

    //create editor
    var editorType = element.data('editorType') || askbot['settings']['editorType'];
    var minLines = element.data('minLines') || 1;
    this._editorType = editorType;
    if (editorType === 'markdown') {
        editor = new WMD({'minLines': minLines});
        if (this._useCompactEditor) {
            editor.setEnabledButtons('bold italic link code ol ul');
        }
        var preview = element.data('previewerEnabled');
        editor.setPreviewerEnabled(preview);
    } else if (editorType === 'tinymce') {
        if (this._useCompactEditor) {
            editor = new TinyMCE({//override defaults
                theme_advanced_buttons1: 'bold, italic, |, link, |, numlist, bullist',
                theme_advanced_buttons2: '',
                theme_advanced_path: false,
                plugins: ''
            });
        } else {
            editor = new TinyMCE();
        }
        editor.setId('tinyMCE-' + this._id);
    } else {
        editor = new SimpleEditor({'minLines': minLines});
    }
    this._editor = editor;
    editorBox.append(editor.getElement());
    editorBox.hide();

    //adding two buttons...
    var formControls = element.find('.js-editable-controls');
    if (formControls.length === 0) {
        formControls = this.makeElement('div');
        formControls.addClass('.js-editable-controls');
        editorBox.append(formControls);
    }

    this._hideables = $('.js-editable-hide-' + this._id);

    var saveBtn = this.makeElement('button');
    //saveBtn.addClass('btn btn-primary');
    saveBtn.html(gettext('save'));
    formControls.append(saveBtn);
    this._saveBtn = saveBtn;

    var cancelBtn = this.makeElement('button');
    cancelBtn.html(gettext('cancel'));
    //cancelBtn.addClass('btn');
    formControls.append(cancelBtn);
    this._cancelBtn = cancelBtn;

    this.setState('display');

    var me = this;
    setupButtonEventHandlers(editBtn, function(evt){ me.startActivatingEditor(evt) });
    setupButtonEventHandlers(cancelBtn, function(){ me.cancelEdit() });
    setupButtonEventHandlers(saveBtn, function(){ me.saveText() });
};

(function () {
    var items = $('.js-editable');
    $.each(items, function(idx, item) {
        var editable = new Editable();
        editable.decorate($(item));
    });
})();

/**
 * Form class.
 * Helps build forms with validation
 */
var Form = function () {
    WrappedElement.call(this);
    /* all dicts have key of field name */
    this._errors = {};
    this._errorElements = {};
    this._validators = {};
    this._inputs = {};
};
inherits(Form, WrappedElement);

Form.prototype.fieldHasErrors = function (fieldName) {
    return this._errors[fieldName];
};

Form.prototype.formHasErrors = function () {
    var fields = this._fieldNames;
    for (var i=0; i<fields.length; i++) {
        var field = fields[i];
        if (this.fieldHasErrors(field)) {
            return true;
        }
    }
    return false;
};

Form.prototype.validateForm = function () {
    var fields = this._fieldNames;
    for (var i=0; i<fields.length; i++) {
        this.validateField(fields[i]);
    }
};

Form.prototype.getFormValidationHandler = function () {
    var me = this;
    return function () {
        me.validateForm();
        if (me.formHasErrors()) {
            return false;
        }
    };
};

Form.prototype.setFieldError = function (fieldName, errorMsg) {
    var error = this._errorElements[fieldName];
    error.html(errorMsg);
    this._errors[fieldName] = true;
};

Form.prototype.clearFieldError = function (fieldName) {
    var error = this._errorElements[fieldName];
    error.html('');
    this._errors[fieldName] = false;
};

Form.prototype.validateField = function (fieldName) {
    var input = this._inputs[fieldName];
    var validator = this._validators[fieldName];
    var val = input.val();
    try {
        validator(val);
        this.clearFieldError(fieldName);
    } catch (error) {
        this.setFieldError(fieldName, error);
    }
}

Form.prototype.decorateField = function (fieldName) {
    //get validator
    var element = $(this._element);
    var validator = element.data(fieldName + 'Validator');
    validator = getObjectByPath(validator);
    this._validators[fieldName] = validator;

    var error = element.find('.js-' + fieldName + '-error');
    this._errorElements[fieldName] = error;

    var input = element.find('input[name="' + fieldName + '"]');
    if (input.length == 0) {
        input = element.find('textarea[name="' + fieldName + '"]');
    }
    if (input.length == 0) {
        input = element.find('select[name="' + fieldName + '"]');
    }
    this._inputs[fieldName] = input;

    var me = this;
    input.change(function () {
        me.validateField(fieldName);
        return false;
    });
};

Form.prototype.decorate = function (element) {
    this._element = element;
    //look for validated fields
    var fieldNames = $(element).data('validatedFields');
    fieldNames = $.trim(fieldNames).split(',');

    for (var i=0; i<fieldNames.length; i++) {
        var fieldName = $.trim(fieldNames[i]);
        fieldNames[i] = fieldName;//save cleaned field name
        this.decorateField(fieldName);
    }
    this._fieldNames = fieldNames;

    element.submit(this.getFormValidationHandler());
};

/**
 * @constructor
 * An element that encloses an editor and everything inside it.
 * By default editor is hidden and user sees a box with a prompt
 * suggesting to make a post.
 * When user clicks, editor becomes accessible.
 */
var FoldedEditor = function () {
    WrappedElement.call(this);
};
inherits(FoldedEditor, WrappedElement);

FoldedEditor.prototype.getEditor = function () {
    return this._editor;
};

FoldedEditor.prototype.getEditorInputId = function () {
    return this._element.find('textarea').attr('id');
};

FoldedEditor.prototype.onAfterOpenHandler = function () {
    var editor = this.getEditor();
    if (editor) {
        editor.start();
        editor.focus(function(){
            editor.putCursorAtEnd()
            $(document).trigger('askbot.FoldedEditor.afterOpened', [this]);
        });
    }
};

FoldedEditor.prototype.getOpenHandler = function () {
    var editorBox = this._editorBox;
    var promptBox = this._prompt;
    var me = this;
    return function () {
        if (askbot.data.userIsReadOnly === true) {
            notify.show(gettext('Sorry, you have only read access'));
        } else {
            promptBox.hide();
            editorBox.show();
            var element = me.getElement();
            element.addClass('unfolded');

            /* make the editor one shot - once it unfolds it's
            * not accepting any events
            */
            element.unbind('click');
            element.unbind('focus');

            /* this function will open the editor
            * and focus cursor on the editor
            */
            me.onAfterOpenHandler();
        }
    };
};

FoldedEditor.prototype.decorate = function (element) {
    this._element = element;
    this._prompt = element.find('.js-folded-editor-trigger');
    this._editorBox = element.find('.editor-proper');

    var editorType = askbot.settings.editorType;
    var editor;

    if (editorType === 'tinymce') {
        editor = new TinyMCE();
        editor.setId('editor');
    } else if (editorType === 'markdown') {
        editor = new WMD({'minLines': 10});
        editor.setIdSeed('');
    } else {
        throw 'wrong editor type "' + editorType + '"'
    }
    editor.setTextareaName('text');
    this._editor = editor;

    var placeHolder = element.find('.editor-placeholder');
    editor.setText(placeHolder.data('draftAnswer'));
    placeHolder.append(editor.getElement());
    //editor.start();

    var openHandler = this.getOpenHandler();
    element.click(openHandler);
    element.focus(openHandler);
};

var AnswerForm = function () {
    Form.call(this);
};
inherits(AnswerForm, Form);

AnswerForm.prototype.getAfterOpenHandler = function () {
    /* decorate the super class now, b/c now we have
       the editor input element in DOM */
    var element = this._element;
    var me = this;
    return function () {
        getSuperClass(AnswerForm).decorate.call(me, element);
    };
};

AnswerForm.prototype.decorate = function (element) {
    this._element = element;
    /* todo: move folded editor inside the answer form! */
    var editorBox = element.closest('.folded-editor');
    if (editorBox.length) {
        var foldedEditor = new FoldedEditor();
        foldedEditor.decorate(editorBox);
        var onAfterOpen = this.getAfterOpenHandler();
        $(document).on('askbot.FoldedEditor.afterOpened', onAfterOpen);
    }
};
  t             textarea         staticOffset         iLastMousePos      &F      iMin   KR"      grip   H~
      TextAreaResizer    B|      addClass   $$	      processed      c      wrap	   S3      <div class="resizable-textarea"><span></span></div>
    2      parent     B-      append     1      <div class="grippie"></div>          bind   D	      mousedown      	      startDrag      2      grippie    G      div.grippie    ;[      marginRight    Z      offsetWidth    6(      data   %      blur   MQ      mousePosition            height     >      css    ue      opacity    O      document   cy	      mousemove            performDrag    =0V      mouseup    3]      endDrag          iThisMousePos       9	      iMousePos!      Kk.      max"          unbind#     K      focus$            clientX%    ,p      documentElement&    |cr
      scrollLeft'     3&      clientY(    G	      scrollTop)      >/      jQuery*     Iyq	      typeWatch+       :y      options,    l      extend-     V;      wait.         callback/   1	      highlight0            captureLength1      /      checkElement2         timer3      5O      override4   %      elTxt5      &      val6    s      toUpperCase7    3      text8   i=y      watchElement9   d!      elem:   ;      TEXT;   U5_      nodeName<   ;      TEXTAREA=   1<      select>     (
      startWatch?     g      evt@    ?B	      timerWaitA            overrideBoolB   5      keyCodeC    <aN      timerCallbackFxD    Q8u      clearTimeoutE   3At
      setTimeoutF           keydownG    :0D      createUploadIframeH     O      jUploadFrameI   2      windowJ     CKr      ActiveXObjectK      DC      createElementL      +      <iframe id="M   p      " name="N   F1      " />O         srcP    J      javascript:falseQ   7      iframeR           positionS   H<*      absoluteT   $      topU    <`(+      -1000pxV    ]      leftW   h;      bodyX   $~      appendChildY    `'      createUploadFormZ   ugP      jUploadForm[    Fk      jUploadFile\     %      <form  action="" method="POST" name="]      C,      " id="^     [e'      " enctype="multipart/form-data"></form>_    4      clone`      A      attra   O      beforeb     V      appendToc         -1200pxd    U?      ajaxFileUploade     '      ajaxSettingsf   u.      getTimeg    x      fileElementIdh      
+	      secureurii      Px      activej     IIP      eventk      !p      triggerl    Q	      ajaxStartm      qY      ajaxSendn   t      getElementByIdo     6      contentWindowp      H}#      responseTextq   	v	      innerTextr       "      responseXMLs    4#7      XMLDocumentt     K{      contentDocumentu    be      textContentv    U      handleErrorw    \o      timeoutx    \9      successy    tuW      errorz      K#$E      uploadHttpData{     Dow      dataType|   *9~      ajaxSuccess}    Z      ajaxComplete~   y]L      ajaxStop   D      complete   *N      remove     	      action     pwm      method     :      POST         encoding   2-      multipart/form-data          enctype    d      submit     VZ/      attachEvent    {p      onload      rO      addEventListener   2U)      load   ~s      xml    :_3
      globalEval     .      json   mt      data =     X      html   S      <div>      D      evalScripts    >      spinner    "      uploadInputId            urlInput   H$F      startUploadHandler     HK      show   v}      hide   exG      askbot     e~      urls   o      upload     g      fileURL    NG      file_url   l:p      \w:.*\\(.*)$   Z      alert            change     76      support    
      transition     5Bh      thisBody   &	      thisStyle      }5      WebkitTransition   %}      MozTransition      fT      MsTransition   OE      OTransition    .+      end    |@      transitionEnd      /      TransitionEnd      f      browser          webkit     a:      webkitTransitionEnd    /      mozilla    N      transitionend      t9,      opera      n      oTransitionEnd     6T      Modal      4W      content          $element   dAb      delegate   bW      [data-dismiss="modal"]           click.dismiss.modal    Og      toggle     Q!      isShown    hy      that   Km
      modal-open     ]i      backdrop   7z      hasClass   &o7      fade   oZ      shown      B9      preventDefault     +      removeClass    GE      hideWithTransition     E	      hideModal            off    W      hidden     q1      animate    M@	      doAnimate      b`	      $backdrop      o      <div class="modal-backdrop     X      click      0      removeBackdrop     a@      keyboard    X      keyup.dismiss.modal    0      which            modal      |`      option     K      $this      {!~K      defaults   $      Constructor    1/      click.modal.data-api   6      [data-toggle="modal"]      `X      href   %q      $target          data-target    I3      .*(?=#[^\s]+$)     W+<      [data-toggle="dropdown"]   gO[      Dropdown         $el    g      click.dropdown.data-api    x5      open    _l$      selector   L.1      $parent    A/      isActive   "      .*(?=#[^\s]*$)     BT
      clearMenus     (I      toggleClass    Cl      dropdown   Cz	      ScrollSpy      8J      process    8	      scrollspy            $scrollElement     P      scroll.scroll.data-api     ;       .nav li > a   1R      $body      v      click.scroll.data-api            refresh    |4      targets    9      map    fa      ^#\w   %      offsets    W      activeTarget   4P      activate   ;      .active    7=L.      [href="          "]     fU      .dropdown-menu     /      closest    &      li.dropdown    d<`      [data-spy="scroll"]    t[       $spy   R/      Tab    0      $ul    [      ul:not(.dropdown-menu)    V      previous  Q	      .active a           last  &$0      relatedTarget     -
	      container     6"      $active   	      > .active     }      > .dropdown-menu > .active	    !      tab
   Mg      click.tab.data-api    W2c)      [data-toggle="tab"], [data-toggle="pill"]     n      Tooltip   u`      init  /}8      tooltip         eventIn   Tu.      eventOut  
      getOptions    h?D      enabled   M      manual    d      hover     F
      mouseenter    fN
      mouseleave          enter     ;      leave     ->gg      _options  {s[      fixTitle  C      delay     \l      self  z      currentTarget     !
      hoverState    ?Mv	      out    I      $tip!  X      inside"    U,2      pos#   l      actualWidth$   t      actualHeight%  sc	      placement&     ]t
      hasContent'    J!      tip(   f
      setContent)    k^	      animation*     e}      display+         block,           getPosition-   Bw      offsetHeight.  @~      bottom/    J      width0      .      right1     2N      .tooltip-inner2    .      getTitle3  "      fade in top bottom left right4     'z      removeWithAnimation5   E      title6           data-original-title7   
      removeAttr8    te{      (^\s*|\s*$)9   s      template:  S      validate;  _
      parentNode<    d      enable=    7R      disable>   ]      toggleEnabled?     x_]      <div class="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>@     s!      PopoverA   4C      popoverB   ~1
      getContentC    6      .popover-titleD    r      .popover-content > *E  _      fade top bottom left right inF     o      data-contentG  S      <div class="popover"><div class="arrow"></div><div class="popover-inner"><h3 class="popover-title"></h3><div class="popover-content"><p></p></div></div></div>H    O      dismissI   N      [data-dismiss="alert"]J    |      AlertK           removeElementL     =      closedM          click.alert.data-apiN  G      ButtonO    U~      buttonP    *      setStateQ  zw      disabledR  ^      TextS  @	      resetTextT     0R      loadingTextU         [data-toggle="buttons-radio"]V     (n
      loading...W    %&k      click.button.data-apiX     ():f      [data-toggle^=button]Y     YBF      $btnZ  h_0      btn[   JW      .btn\  \!      Collapse]  #      collapse^  6	      dimension_           hasWidth`  \z      scrolla    	      camelCaseb           activesc   +      .ind         hasDatae   W      resetf     zS      autog  E
      startEventh          completeEventi           click.collapse.data-apij   -*      [data-toggle=collapse]k    B5      Carousell  lr       carouselm        sliden     FW      pauseo     Pu!      cyclep     sz      intervalq         setIntervalr   
}N      childrens  9	      activePost     c      slidingu   =      slidv  >"      prevw  bPk      clearIntervalx     	f      $nexty     #	      isCyclingz     		      direction{     J      fallback|  `~      first}     6      .item~     :      click.carousel.data-api   dq      [data-slide]  aw	      Typeahead     	      typeahead     aK      matcher   5kO      sorter    :9      highlighter   q      $menu     q      menu        listen    
      data-value    NS      lookup    #`      items     XN_      query     0
%9      grep        item        render           slice     RDo      toLowerCase   E      indexOf   of
      beginswith          caseSensitive     #      caseInsensitive   =O      shift     u2      push        concat    H       <strong>  r	      </strong>     V      keypress  KH`      keyup     5      msie  /F/      stopPropagation   
4)      <ul class="typeahead dropdown-menu"></ul>     V      <li><a href="#"></a></li>     S      focus.typeahead.data-api  ZW      [data-provide="typeahead"]    -.      Markdown  ,      exports   w      require   O      identity  `      returnFalse   a}      HookCollection    7      chain           hookname  fv      func  _      original  *      unknown hook            args  b      addNoop   TP       addFalse  {o\|      SaveHash  B;      key   64	      Converter     e      pluginHooks   b3      hooks     !6m      plainLinkText     ]      preConversion     (      postNormalization     }V      preBlockGamut           postBlockGamut    .e      preSpanGamut  q      postSpanGamut     3      postConversion    /WXR      g_urls          g_titles  n1?      g_html_blocks     <      g_list_level  <      makeHtml  $      Recursive call to converter.makeHtml  WB      ~T    hO      \$    r      ~D    `"      \r\n  a`i      \r    A{      

    I      _Detab    d      ^[ \t]+$  }      _HashHTMLBlocks         _StripLinkDefinitions     eD      _RunBlockGamut    W      _UnescapeSpecialChars     Hd      ^[ ]{0,3}\[(.+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?(?=\s|$)[ \t]*\n?[ \t]*((\n*)["(](.+?)[")][ \t]*)?(?:\n+)  T
      wholeMatch    Ta      _EncodeAmpsAndAngles  ~      &quot;    N5;      block_tags_a  l`~\      p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del  l      block_tags_b  )T      p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math  
PC      ^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del)\b[^\r]*?\n<\/\2>[ \t]*(?=\n+))  Kl      hashElement   ?Yz      ^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math)\b[^\r]*?.*<\/\2>[ \t]*(?=\n+)\n)    ~U2      \n[ ]{0,3}((<(hr)\b([^<>])*?\/?>)[ \t]*(?=\n{2,}))    ;|,J      \n\n[ ]{0,3}(<!(--(?:|(?:[^>-]|-[^>])(?:[^-]|-[^-])*)--)>[ \t]*(?=\n{2,}))    G7      (?:\n\n)([ ]{0,3}(?:<([?%])[^\r]*?\2>)[ \t]*(?=\n{2,}))   T	      blockText     N      ^\n+  (1      \n+$        

~K  k      K

   G      blockGamutHookCallback          doNotUnhash   `Yn
      _DoHeaders    6\      replacement         <hr />
   y       ^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$  4      ^[ ]{0,2}([ ]?-[ ]?){3,}[ \t]*$   h"      ^[ ]{0,2}([ ]?_[ ]?){3,}[ \t]*$   m      _DoLists        _DoCodeBlocks     B]      _DoBlockQuotes    !;      _FormParagraphs         _RunSpanGamut     =l      _DoCodeSpans  S$`8&      _EscapeSpecialCharsWithinTagAttributes    vGJ      _EncodeBackslashEscapes   UK	      _DoImages     _^
      _DoAnchors    [a      _DoAutoLinks  sdM      ~P    N      ://   j@.      _DoItalicsAndBold     j        +\n     X$       <br>
    cT      regex     3T$S      (<[a-z\/!$]("[^"]*"|'[^']*'|[^'">])*>|<!(--(?:|(?:[^>-]|-[^>])(?:[^-]|-[^-])*)--)>)   sN1G      tag   6      (.)<\/?code>(?=.)     n      $1`   cm      escapeCharacters   v      charAt    ?K      \`*_/     +      \`*_  {u?      (\[((?:\[[^\]]*\]|[^\[\]])*)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()   K=      writeAnchorTag    d      (\[((?:\[[^\]]*\]|[^\[\]])*)\]\([ \t]*()<?((?:\([^)]*\)|[^()\s])*?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))        (\[([^\[\]]+)\])()()()()()    "R      whole_match   ::	      link_text	     1y
      :\/\/
     +V      link_id   5        ?\n  X(      \(\s*\)$  >      encodeProblemUrlChars     l      *_    JU(	      <a href="     
O      attributeEncode   )'       title="        </a>  $,      (!\[(.*?)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()  p      writeImageTag     lnOA      (!\[(.*?)\]\s?\([ \t]*()<?(\S+?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))           &gt;  a @      &lt;        alt_text  ,      *_[]()    
      <img src="    $>      " alt="   P       />   A4      ^(.+)[ \t]*\n=+[ \t]*\n+  $      <h1>  '      </h1>

    ,3x      ^(.+)[ \t]*\n-+[ \t]*\n+!  %
      matchFound"          <h2>#  [      </h2>

$    >!      ^(\#{1,6})[ \t]*(.+?)[ \t]*\#*\n+%     *      h_level&         <h'    V      </h(         >

)   g\      isInsideParagraphlessListItem*     2      ~0+    nA
      whole_list,    cbY      ^(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))-           list.  	      list_type/     u`a      [*+-]0     k      _ProcessListItems1     OK      \s+$2        </3          >
4    +Hc      (\n\n|^\n?)(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))5   oFH      runup6     E_      _listItemMarkers7        \d+[.]8    xY       list_str9  Y7      \n{2,}$:   {V      marker;    9
      (^[ \t]*)(<    %      )[ \t]+([^\r]+?(\n+))(?=(~0|\1(=   zY	      )[ \t]+))>     p      last_item_had_a_double_newline?    6      leading_space@     U/      ends_with_double_newlineA  :d      \n\n$B     bv      contains_double_newlineC   ;      \n{2,}D          _OutdentE  1O      \n$F   "'      <li>G  @A      </li>
H    B      (?:\n\n|^\n?)((?:(?:[ ]{4}|\t).*\n+)+)(\n*[ ]{0,3}[^ \t\n]|(?=~0))I    JY	      codeblockJ           nextCharK  F      _EncodeCodeL   ,^      <pre><code>M   @=      
</code></pre>N    W+	      hashBlockO           (^\n+|\n+$)P   -C!      (^|[^\\])(`+)([^\r]*?[^`])\2(?!`)Q     &~-	      ^([ \t]*)R     DW      [ \t]*$S   x      <code>T    ~zj      </code>U         &amp;V     lha      *_{}[]\W   o4      ([\W_]|^)(\*\*|__)(?=\S)([^\r]*?\S[\*_]*)\2([\W_]|$)X  a      $1<strong>$3</strong>$4Y   -H.      ([\W_]|^)(\*|_)(?=\S)([^\r\*_]*?\S)\2([\W_]|$)Z          $1<em>$3</em>$4[   N9!      ((^[ \t]*>[ \t]?.+\n(.+\n)*\n*)+)\           ^[ \t]*>[ \t]?]    #      (^|\n)^          $1  _  "/      (\s*<pre>[^\r]+?<\/pre>)`  4      prea   z      ^  b   4a[      <blockquote>
c     "x      
</blockquote>d    H"      grafse     #.      grafsOutf  E}      markerReg  y?      ~K(\d+)Kh  61      stri   B=      \Sj          <p>k   !      </p>l  2>      foundAnym  K!      &(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)n     T0      <(?![a-z\/?!]|~D)o     <?      \\(\\)p    Pty      escapeCharacters_callbackq     $D{      \\([`*_{}\[\]()>#+-.!])r   Rb      charInsideUrls     dp+      [-A-Z0-9+&@#/%?=~_|[\]()!:,.;]t    Y      charEndingUrlu     IgZ      [-A-Z0-9+&@#/%=~_|[\])]v         autoLinkRegexw     n:      (="|<)?\b(https?|ftp)(://x     !Z`	      )(?=$|\W)y     1      endCharRegexz  q:      handleTrailingParens{  \
      lookbehind|    s4      protocol}  I      link~  a      parens    "=5      [()]  a[      level     n9x      tail  j.      \){1,     ,F      }$    )      trailingParens    z      lastChar  6f      substr    m6      replacer  %c
      wholematch    +      ">    -(F      <((https?|ftp):[^'">\s]+)>          ~E(\d+)E  ~d      charCodeToReplace     >      fromCharCode        ^(\t|[ ]{1,4})    :W      \t    T      spaces    51            (            xd            	T      skew  >
      [\n\t]          _problemUrlChars  6=      (?:["'*()[\]:]|~D)    X      len   g12      %24    um      [0-9\/]   (=S:
      charCodeAt    f      charsToEscape     	F5      afterBackslash    }j      regexString   ~      ([    ud
      ([\[\]\\])    1      \$1         ])    5      \\    %8      charCodeToEscape  .      ~E    [>      output    F*      ./Markdown.Converter  E	w      getSanitizingConverter    	      converter     F      sanitizeHtml  Nz      balanceTags         <[^>]*>?  ~'      sanitizeTag   CP      basic_tag_whitelist   Yr      ^(<\/?(b|blockquote|code|del|dd|dl|dt|em|h1|h2|h3|i|kbd|li|ol|p|pre|s|sup|sub|strong|strike|ul)>|<(br|hr)\s?\/?>)$    ?      a_white   5e      ^(<a\shref="((https?|ftp):\/\/|\/)[-A-Za-z0-9+&@#\/%?=~_|!:,.;\(\)]+"(\stitle="[^"<>]+")?\s?>|<\/a>)$     F	      img_white     )O      ^(<img\ssrc="(https?:\/\/|\/)[-A-Za-z0-9+&@#\/%?=~_|!:,.;\(\)]+"(\swidth="\d{1,3}")?(\sheight="\d{1,3}")?(\salt="[^"<>]*")?(\stitle="[^"<>]*")?\s?\/?>)$  &      <\/?\w+[^>]*(\s|$|>)  m      tags        tagcount  $      tagname         ignoredtags   o7      <p><img><br><li><hr>  @	      tagpaired     s	      tagremove     @x      needsRemoval  MlK      ctag  *CI      <\/?(\w+).*   !      ^<\/  8
      ntag  :0      res   )(      getAskbotMarkdownConverter    Q_      controllers   ir      markdownConverter     }       AskbotMarkdownConverter   Q

      _converter    Ag      _timeout  QY      scheduleMathJaxRendering  o
      renderFunc    \07      MathJax   M01~      Hub   v_      Queue     <      Typeset   h	      previewer           makeHtmlBase  K      settings  2O      mathjaxEnabled    p#      queue     	A      Push  G
      #previewer    Q1      console   =X      log         Could not load MathJax    =7	      Attacklab     n]6-      wmdBase   6[:      wmd   ?U3      doc   2      nav   +	      navigator     r      Util  *      Position        Command   ^      Global    9Ig      util        command   #      isChrome  u^      chrome    	      userAgent     R.      isIE  	      isIE_5or6     {      msie 6    !:      msie 5    0
      isIE_7plus    Ou      isOpera   =      isKonqueror   )a	      konqueror     i1       toolbar_strong_label  1h      gettext   OYQ[      bold  !3.       <strong> Ctrl-B  5]      toolbar_emphasis_label    
)      italic    ?x       <em> Ctrl-I  Y      toolbar_hyperlink_label   E       <a> Ctrl-L   fd      toolbar_blockquote_label   =m      quote            <blockquote> Ctrl-.  k      toolbar_code_label    [      preformatted text            <pre><code> Ctrl-K         toolbar_image_label         image      wj       <img> Ctrl-G     pvA      toolbar_attachment_label  C
      attachment           Ctrl-F          toolbar_numbered_label          numbered list     b       <ol> Ctrl-O  J      toolbar_bulleted_label    +/      bulleted list	     R       <ul> Ctrl-U
  K      toolbar_heading_label     c)/      heading   @x       <h1>/<h2> Ctrl-H     R
      toolbar_horizontal_label  Dc      horizontal bar    hS}       <hr> Ctrl-R  xU      toolbar_undo_label    ,(      undo  Oe       Ctrl-Z         toolbar_redo_label    L      redo  $       Ctrl-Y   [b_]      imageDialogText   Ft      <p style='margin-top: 0px'>         enter image url   %%}      linkDialogText    |7	      enter url           fileDialogText          upload file attachment    =      imageDefaultText  !      http://   <|      linkDefaultText    va      imageDirectory!    'Jz      images/"   x      previewPollInterval#   5<      pastePollInterval$     wf      helpLink%        http://wmd-editor.com/&    :      helpHoverTitle'    nH      WMD website(   y
      helpTarget)    9^      _blank*    @Z      localUploadFileName+   =      PanelCollection,   .Z	      buttonBar-     v$      makeId.    O      wmd-button-bar/    7      preview0   v
      wmd-output1    2|      editor2    ?:      panels3    s      ieCachedRange4     xA      ieRetardedClick5   F !	      isVisible6           getComputedStyle7  .1      getPropertyValue8  ,      none9  >      currentStyle:  6      addEvent;  l%      listener<        removeEvent=   ZP      detachEvent>   ]      removeEventListener?   )      fixEolChars@   //]3      extendRegExpA  b+      postB  P      \/([gim]*)$C   \7	      (^\/|\/$)D           createImageE   e       imgF   .      imgPathG   6CY>	      classNameH           wmd-button wmd-image-buttonI   `      promptJ    U'J      defaultInputTextK  CDW      makeLinkMarkdownL  9
      dialogTypeM    m      dialogN    ,
      backgroundO    y      checkEscapeP   hc)      codeQ        charCodeR  "X      isCancelS  >P      http://http://T    19	      http://https://U   x_ZM      https://V  ~      http://ftp://W     W\(      ftp://X    K      removeChildY   w      createBackgroundZ        div[   <      wmd-prompt-background\     f      zIndex]    Vmp      1000^  C      backgroundColor_   l=      transparent`   >	      filtera          alpha(opacity=50)b     @B<      0.5c   CR      pageSized  (PB      getPageSizee   G      clientWidthf   ?y      100%g  f`      createDialogh  /E(      wmd-prompt-dialogi     /B      paddingj   x1      10px;k     X      fixedl     z)%      400pxm     f      1001n  v,      questiono  Q:	      innerHTMLp     q      5pxq   *g      formr        onsubmits  d9      margint    (z      cssFloatu  @	      textAlignv     rLt      centerw    -k      relativex  =      filey  +gT	      image-urlz     k      80%{   G$W
      marginLeft|           upload_container}  .Iv      <div></div>~   3      upload_input        <input type="file" />     A5C      file-upload         <img />   c      loading         mediaUrl  B      media/images/indicator.gif          <br/>           okButton  ES      onclick   b      trim        10px  Tn      inline    i@{      7em   u      cancelButton  &      Cancel    xg(      mac   K      platform  Z      50%   	      marginTop     |	      getHeight     YW*      getWidth        askbot.afterCreateWMDPrompt   7
      defTextLen    A      selectionStart    L0F      selectionEnd  Yk1      createTextRange   x      range     z	      moveStart     $	      character           moveEnd   |      getTop    #J      isInner   D>	      offsetTop     t      offsetParent  LsA      scrollHeight  F)      scrollWidth   U
      innerWidth    0U      innerHeight   4i
      scrollMaxY          clientHeight  ;x      maxWidth  	      maxHeight     R      inputPoller   #z	      pollerObj     \	      inputArea     \]	      lastStart     IJ      lastEnd   ]B      markdown  oe
      killHandle           tick        doTickCallback    F$      assignInterval          destroy   ~#,      undoManager   f/      undoObj   _(	      undoStack     l<      stackPtr  Q%	      lastState           poller          inputStateObj     6sP      setMode   3[      newMode   A      noSave    8	      saveState     AL0      moving    ~      refreshState  $&      TextareaState     ?      setCommandMode    U&      canUndo   N      canRedo   0      restore   g'	      currState     <n      handleCtrlYZ        handled   
@&      ctrlKey   `$      metaKey   l      keyCodeChar   ,      shiftKey  !'      returnValue         handleModeChange  R0      deleting  G      newlines  H      typing    {      setEventHandlers  >      handlePaste   >      paste     .      onpaste         ondrop    9      previewRefreshCallback    0      inputBox        editObj         mainDiv   Ri      mainSpan  bs      creationHandle    
	      undoMgr         isButtonUsed  \      buttons   l1      wmd_env   _      \s+   G      inArray   W+      doClick   
E7      textOp    /C'      chunks    zr	      getChunks     :      fixupInputArea    u	      setChunks     )-E	      noCleanup     ~      execute   `Wq      setUndoRedoButtonStates   Mk      setupButton   M      wmd-undo-button   g\      wmd-redo-button   aR	      isEnabled           normalYShift  lT      0px   IF      disabledYShift    Wc      -20px           highlightYShift   c      -40px     ZL      backgroundPosition    a      XShift          onmouseover   <"w
      onmouseout    ]he      onmousedown   l8oi	      selection     S#      createRange   zx      isHelp    Ir_      makeSpritedButtonRow  	      buttonRow      9H      wmd-button-row    U
      boldButton    miu      wmd-button wmd-bold-button    U<>      wmd-bold-button         doBold          italicButton  ga      wmd-button wmd-italic-button  /b      wmd-italic-button     x~W      doItalic	  6
      blockquote
    H      spacer1   iv      wmd-spacer wmd-spacer1    l      wmd-spacer1   !
      linkButton    V:3      wmd-button wmd-link-button    ~      wmd-link-button         chunk     R      postProcessing    0C@      doLinkOrImage     H=
      quoteButton   s      wmd-button wmd-quote-button   b#      wmd-quote-button  A      -60px     yiX      doBlockquote  YVV
      codeButton    'O      wmd-button wmd-code-button    gtV      wmd-code-button   7~      -80px     3      doCode    V)      imageButton   b:<      wmd-image-button  rQ`      -100px     %j      attachmentButton!  .n       wmd-button wmd-attachment-button"  t,      wmd-attachment-button#     ["V      -120px$    O      spacer2%   "x!      wmd-spacer wmd-spacer2&    4_      wmd-spacer2'   fn      olistButton(   N      wmd-button wmd-olist-button)         wmd-olist-button*  
 D      -140px+    d      doList,    WTI      ulistButton-   va.h      wmd-button wmd-ulist-button.   "?      wmd-ulist-button/  }ne      -160px0    j      headingButton1     e#      wmd-button wmd-heading-button2     \~u      wmd-heading-button3    dB      -180px4    $	      doHeading5     ,      hrButton6  Zp      wmd-button wmd-hr-button7  o8r
      wmd-hr-button8           -200px9    ='      doHorizontalRule:  i`      spacer3;   X      wmd-spacer wmd-spacer3<     $      wmd-spacer3=   
      undoButton>    w      wmd-button wmd-undo-button?    q      -220px@    y      managerA   Gu
      redoButtonB    4d      wmd-button wmd-redo-buttonC    Ur      winD   B       - Ctrl+Shift+ZE   u9      -240pxF          setupEditorG          \?noundoH  0+QA      locationI  B
      nativeUndoJ    E;      keyEventK  
      keyCodeStrL    
      fakeButtonM    `      doAutoindentN  evg      submitCallbackO    B      convertToHtmlP     k>R      showdownQ  o~      stateObjR  sX)      setInputAreaSelectionStartEndS           setInputAreaSelectionT     U4      activeElementU     L>\
      fixedRangeV    "      markedRangeW   R	      inputTextX           lastIndexOfY   pG      ChunksZ    Y	      substring[     -!      startTag\  k6      endTag]    T      after^           \n_    E      
`    ~      findTagsa  
      startRegexb    9      endRegexc  S      chunkObjd  C      trimWhitespacee    d      ^(\s*)f    $      (\s*)$g    B5	      skipLinesh     8-      nLinesBeforei  K}      nLinesAfterj   .      findExtraNewlinesk     t	      regexTextl     P      replacementTextm   M      ().n   $>M1      (^\n*)o    uk      (\n*$)p    .y      \n?q   sp~      \n*r   g~,      prefixess  b=      (?:\s{4,}|\s*>|\s*-\s+|\s*\d+\.|=|\+|-|_|\*|#|\s*\[[^
]]+\]:)t     Ao      unwrapu          txtv   Be      ([^\n])\n(?!(\n|w  +W      ))x          $1 $2y     &      (.{1,z     mb      })( +|$\n?){         marked|          doBorI}          strong text~   ^      emphasized text   #S      nStars    1
      insertText    ;,      (\**$)    i1      starsBefore   	      (^\**)    0
      starsAfter     	      prevStars     U       min   s      [*]{  "C      ^[*]{     `$      ^([*_]*)  K      (\s?)$    7vk3
      whitespace          markup          **    j      stripLinkDefs     p	      defsToAdd     "Ga      ^[ ]{0,3}\[(\d+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?[ \t]*\n?[ \t]*(?:(\n*)["(](.+?)[")][ \t]*)?(?:\n+|$)     r
      totalMatch    Ss:;      \s*$        ["(](.+?)[")]$    +Cw
      addLinkDef    y      linkDef   f/	      refNumber     $      defs  7      (\[(?:\[[^\]]*\]|[^\[\]])*\][ ]?(?:\n[ ]*)?\[)(\d+)(\])   T      addDefNumber  )       def   xl      ^[ ]{0,3}\[(\d+)\]:   Q        [   .]      ]:          getLink   ]      refOut    $sBY      \n*$  vf      itemType  X      \s*!?\[   [ML      \][ ]?(?:\n[ ]*)?(\[.*?\])?   w$      !?\[  y      \n\n  F      ![    
      ](    gV      image description     	      file name     Grg	      link text     Ro      makeAPI   )V      previewManager    9      idToken   e      idSeed    <u(      askbotMakeId  t      startEditor   	      start_now     }	      autostart     \      edit  /
      previewMgr    g'r      loadListener  t@1
      managerObj    !      elapsedTime   +      oldInputText  "      htmlOut   &=j      maxDelay  D	      startType     Q      delayed   l(      setupEvents   \	      inputElem     _      getDocScrollTop   d      pageYOffset   t      makePreviewHtml   };      prevTime  &      currTime  m      pushPreviewHtml   ;1      applyTimeout  )A      getScaleFactor    ~&      panel           setPanelScrollTops    g5H      requiresRefresh   U      processingTime    n+      setUpdateMode     DA      isFirstTimeFilled     H      emptyTop        readOnly  a      newText   K5      </code></pre>     4      fullTop   4o0      scrollBy  G>%      (\n|^)[ ]{0,3}([*+-]|\d+[.])[ \t]*\n$     I      (\n|^)[ ]{0,3}>[ \t]*\n$  )q      (\n|^)[ \t]+\n$   2DA'      (\n|^)[ ]{0,3}([*+-]|\d+[.])[ \t]+.*\n$         (\n|^)[ ]{0,3}>[ \t]+.*\n$    p      (\n|^)(\t|[ ]{4,}).*\n$   <'      ^(\n*)([^\r]+?)(\n*)$           newlinesBefore    ?      newlinesAfter     n
      (>[ \t]*)$    yh\	      blankLine     &	      ^(\s|>)+$     N
      Blockquote          \n?$  5Q      ^\n?   v,      (((\n|^)(\n[ \t]*)*>(.+\n)*.*)+(\n[ \t]*)*$)  E,      ^(((\n|^)(\n[ \t]*)*>(.+\n)*.*)+(\n[ \t]*)*)  q      replaceBlanksInTags   Tt
      useBracket          >           \n((>|\s)*)\n$    O<<      ^[ ]{0,3}>?[ \t]*$    I      ^\n((>|\s)*)\n    T      ^(?![ ]{0,3}>)    RM
      lineLength    J[      ^[ ]{0,3}> ?  X~^      ^(\n|^)[ ]{0,3}>  +      \n{0,2}$   Vn      (\n|^)[ ]{0,3}>.*$    w      ^\n{0,2}  g      ^(> *)    /      blanks          hasTextBefore     cd      \S[ ]*$   fF      hasTextAfter  Il`      ^[ ]*\S         [ ]{4}$   gH
      nLinesBack    R\      nLinesForward     4M      \n(\t|[ ]{4,}).*\n$   *      ^\n(\t|[ ]{4,})   J      enter code here   Ph      ^[ ]{0,3}\S   J      ^[ ]{4}   6      isNumberedList     m       previousItemsRegex    ,tc      (\n|^)(([ ]{0,3}([*+-]|\d+[.])[ \t]+.*)(\n.+|\n{2,}([*+-].*|\d+[.])[ \t]+.*|\n{2,}[ \t]+\S.*)*)\n*$   tu      nextItemsRegex    `      ^\n*(([ ]{0,3}([*+-]|\d+[.])[ \t]+.*)(\n.+|\n{2,}([*+-].*|\d+[.])[ \t]+.*|\n{2,}[ \t]+\S.*)*)\n*  !      bullet    v.|      num   wB      getItemPrefix     2      prefix    E.      . 	    $'      getPrefixedItem
   .      itemText  ~      ^\s*\d    *q#      ^[ ]{0,3}([*+-]|\d+[.])\s            (\n|^)*[ ]{0,3}([*+-]|\d+[.])\s+  H      ^\n   5	      hasDigits     F      \n[ ]{4}  R      nLinesUp  4      ^\s*([*+-])   U      [^\n]\n\n[^\n]    Z	      List item     PO
      nLinesDown    1      (^\s+|\s+$)   ]      ##    Nz      Heading   5I       ##   {      headerLevel   oO      #+[ ]*    C      [ ]*#+    ,      #+    pi	      lastMatch     cm
      \s?(-+|=+)     u80      =+!    K      -+"    a      headerLevelToCreate#   	k[
      headerChar$    E      ----------
%   QY;      account_options&   {`      wmd_defaults'  _      version(   <X	      delayLoad)     dI
      editorType*    R      loadEnv+   (XM      mergeEnv,  >      env-   W      wmd_options.   '      full/  f      defaultButtons0    YB      bold italic link blockquote code image attachment ol ul heading hr1    .`      debug2     M      warn3  3      nothing selected, can't validate, returning nothing4   	      validator5     z3      input, button6     hb      .cancel7         cancelSubmit8        submitHandler9     Z      :submit:   1r|      submitButton;  v%      handle<    ]n      <input type='hidden'/>=    K      currentForm>   8      pendingRequest?    <'      formSubmitted@     =d      focusInvalidA  >,      validB     p      removeAttrsC   5
      attributesD    1      \sE    :      rulesF     y      argumentG  rM%      staticRulesH   ^}i      existingRulesI     0      normalizeRuleJ     7;l      messagesK  yFL      filteredL  <      normalizeRulesM    {      metadataRulesN     
      classRulesO    c      attributeRulesP    I;      requiredQ  U      paramR     R      exprS        blankT     fY      filledU    B	      uncheckedV     :0      checkedW   &<      paramsX    wP	      makeArrayY     Yl      unshiftZ   v      \{[    6      \}\    Dx
      errorClass]    |3`
      validClass^    8      errorElement_  m      errorContainer`    rl!      errorLabelContainera   .fs      ignoreb    O      ignoreTitlec   {,	      onfocusind     2
      lastActivee          focusCleanupf  8      blockFocusCleanupg     1      unhighlighth   e,	      errorsFori     e
      onfocusoutj    V	      checkablek     C>	      submittedl     1i      optionalm  E      onkeyupn   w)      lastElemento   !      setDefaultsp   I      This field is required.q   KnK      remoter    q      Please fix this field.s    <      emailt     }:#      Please enter a valid email address.u         Please enter a valid URL.v     RJ      datew        Please enter a valid date.x    s      dateISOy          Please enter a valid date (ISO).z        Please enter a valid number.{        digits|    "K      Please enter only digits.}     0
      creditcard~    fn(      Please enter a valid credit card number.  1<      equalTo   ""      Please enter the same value again.    yn      accept    ,      Please enter a value with a valid extension.  >	      maxlength     u)      Please enter no more than {0} characters.     ;nl	      minlength     Sr%      Please enter at least {0} characters.     H      rangelength   19      Please enter a value between {0} and {1} characters long.     )      Please enter a value between {0} and {1}.     |!/      Please enter a value less than or equal to {0}.   S2      Please enter a value greater than or equal to {0}.    !B:      autoCreateRanges  dsk      labelContainer    ~      errorContext  
      containers    Pv
      valueCache          invalid   5	      eventType     ~	      ^validate     :      validateDelegate  )      :text, :password, :file, select, textarea     t      focusin focusout keyup    ==-!      :radio, :checkbox, select, option     &      invalidHandler    '      invalid-form.validate     6n
	      checkForm     h)      errorMap  W      triggerHandler    VG      invalid-form  
      showErrors    +2r      prepareForm   _T      elements  a
o      currentElements   1      check     ='      clean           prepareElement    r      numberOfInvalids  p      toHide    H7	      errorList     5
      findByName    m}      successList   '(      defaultShowErrors     
V	      resetForm     M-^
      hideErrors    YA      objectLength  N#9      obj   >gL
      addWrapper          findLastActive    SZK#      :visible  M      focusin   A>~
      rulesCache          :input    q      not   6 c#      :submit, :reset, :image, [disabled]         %o has no name assigned         toShow    |Tq      dependencyMismatch          rule  n-	      methods   ;5&      dependency-mismatch   b~      formatAndAdd  O{|(      exception occured when checking element   K@      , check the '           ' method  8c      customMetaMessage     -;      metadata  
      customMessage     YuR      findDefined   W>9      defaultMessage    g(      <strong>Warning: No message defined for   >5      theregex  %      \$?\{(\d+)\}  #]      {$1}  '2      toToggle  YC      wrapper   (VD	      showLabel     -X>      validElements     V      invalidElements   W;	      generated     'i,      />    f      idOrName  YE      errorPlacement    (      insertAfter   `s      radio|checkbox    5|      getElementsByName     l'	      getLength     $v      option:selected   z      :checked        depend    PU      dependTypes   T'      startRequest  _Kp      stopRequest   0      previousValue     fndd      old   -.      classRuleSettings     )      dateDE    w;5      numberDE  vu      addClassRules     uw      classes    ?      -1|2147483647|524288  P      prop  /E      depends   (      keepRule  f	      parameter     @i
      isFunction    E	      transformed   	      addMethod     JF      originalMessage   d      ajax  >R      port  O      response  >b     ^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$     Iq     ^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$     M84      Invalid|NaN   j      ^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}$   /|(      ^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$        ^\d+$     j      [^0-9-]+  3      nCheck          nDigit          bEven     '>t      \D    .9      cDigit    &M!      png|jpe?g|gif     }<      .(    #      )$    `=(      .validate-equalTo      7 k      blur.validate-equalTo     4W      pendingRequests         special   ZM      focusout  8W      setup     Z`      handler   ]      teardown  G      PR_SHOULD_USE_CONTINUATION          \x0	         \x
    h-O      \\u[\dA-Fa-f]{4}|\\x[\dA-Fa-f]{2}|\\[0-3][0-7]{0,2}|\\[0-7]{1,2}|\\[\S\s]|[^\\]   }      \\[bdsw]  }      sort  _e      \[(?:[^\\\]]|\\[\S\s])*]|\\u[\dA-Fa-f]{4}|\\x[\dA-Fa-f]{2}|\\\d+|\\[^\dux]|\(\?[!:=]|[()^]|[^()[\\^]+     /      (?:   I      [A-Za-z]  F      [a-z]     %      \\u[\da-f]{4}|\\x[\da-f]{2}|\\[^UXux]     'J(      nodeType  ~X
      firstChild    'n      nextSibling   	      nodeValue     ZD      \r\n?     +
      [\t\n\r ]+    cd      (?:^|\s)nocode(?:\s|$)    a
      whiteSpace    &      defaultView   G      white-space   N9      pln   ^s       lang-     
7      [\S\s]          tripleQuotedStrings    zc      ^(?:'''(?:[^'\\]|\\[\S\s]|''?(?=[^']))*(?:'''|$)|"""(?:[^"\\]|\\[\S\s]|""?(?=[^"]))*(?:"""|$)|'(?:[^'\\]|\\[\S\s])*(?:'|$)|"(?:[^"\\]|\\[\S\s])*(?:"|$))!  yC      '""    /)-      multiLineStrings#  [      ^(?:'(?:[^'\\]|\\[\S\s])*(?:'|$)|"(?:[^"\\]|\\[\S\s])*(?:"|$)|`(?:[^\\`]|\\[\S\s])*(?:`|$))$   3k?      '"`%   j<      ^(?:'(?:[^\n\r'\\]|\\.)*(?:'|$)|"(?:[^\n\r"\\]|\\.)*(?:"|$))&  o;k      "''          verbatimStrings(   qy      ^@"(?:[^"]|"")*(?:"|$))    ak      hashComments*  kR      cStyleComments+    \CS      com,   aq%      ^#(?:##(?:[^#]|#(?!##))*(?:###|$)|.*)-     MF`      ^#(?:(?:define|elif|else|endif|error|ifdef|include|ifndef|line|pragma|undef|warning)\b|[^\n\r]*).  Le9D      ^<(?:(?:(?:\.\.\/)*|\/?)(?:[\w-]+(?:\/[\w-]+)+)?[\w-]+\.h|[a-z]\w*)>/  %
      ^#[^\n\r]*0    &      ^\/\/[^\n\r]*1     t      ^\/\*[\S\s]*?(?:\*\/|$)2   Qk      regexLiterals3     Jd
      lang-regex4    X8     ^(?:^^\.?|[!+-]|!=|!==|#|%|%=|&|&&|&&=|&=|\(|\*|\*=|\+=|,|-=|->|\/|\/=|:|::|;|<|<<|<<=|<=|=|==|===|>|>=|>>|>>=|>>>|>>>=|[?@[^]|\^=|\^\^|\^\^=|{|\||\|=|\|\||\|\|=|~|break|case|continue|delete|do|else|finally|instanceof|return|throw|try|typeof)\s*(\/(?=[^*/])(?:[^/[\\]|\\[\S\s]|\[(?:[^\\\]]|\\[\S\s])*(?:]|$))+\/)5  ;      types6     .      typ7   P      keywords8  8      ^ | $9     :      kwd:   N      ^(?:;        [\s,]+<    w|^      )\b=   J!	      ^\s+>  	       
	?           lit@         ^@[$_a-z][\w$@]*A  $      ^(?:[@_]?[A-Z]+[a-z][\w$@]*|\w+_t\b)B  Lix      ^[$_a-z][\w$@]*C   MG      ^(?:0x[\da-f]+|(?:\d(?:_\d+)*\d*(?:\.\d*)?|\.\d\+)(?:e[+-]?\d+)?)[a-z]*D   z 
      0123456789E    	
      ^\\[\S\s]?F    v      punG   ;xI      ^.[^\s\w"-$'./@\\`]*H  L2      insertBeforeI  6!      createTextNodeJ    g	      cloneNodeK     U4      \r\n?|\nL  J      ownerDocumentM     {D      setAttributeN  v      linenumsO        P     !;	#      cannot override language handler %sQ   <f>      ^\s*<R     b      default-markupS    :      default-codeT  }      \bMSIE\bU  <h=      SPANV  ,[uh      replaceChildW  *      break,continue,do,else,for,if,return,whileX          auto,case,char,const,default,double,enum,extern,float,goto,int,long,register,short,signed,sizeof,static,struct,switch,typedef,union,unsigned,void,volatileY    
`      catch,class,delete,false,import,new,operator,private,protected,public,this,throw,true,try,typeofZ  @      alignof,align_union,asm,axiom,bool,concept,concept_map,const_cast,constexpr,decltype,dynamic_cast,explicit,export,friend,inline,late_check,mutable,namespace,nullptr,reinterpret_cast,static_assert,static_cast,template,typeid,typename,using,virtual,where[  5      abstract,boolean,byte,extends,final,finally,implements,import,instanceof,null,native,package,strictfp,super,synchronized,throws,transient\     ]1     as,base,by,checked,decimal,delegate,descending,dynamic,event,fixed,foreach,from,group,implicit,in,interface,internal,into,is,lock,object,out,override,orderby,params,partial,readonly,ref,sbyte,sealed,stackalloc,string,select,uint,ulong,unchecked,unsafe,ushort,var]    J      debugger,eval,export,function,get,null,set,undefined,var,with,Infinity,NaN^    TL      and,as,assert,class,def,del,elif,except,exec,finally,from,global,import,in,is,lambda,nonlocal,not,or,pass,print,raise,try,with,yield,False,True,None_  S      alias,and,begin,case,class,def,defined,elsif,end,ensure,false,in,module,next,nil,not,or,redo,rescue,retry,self,super,then,true,undef,unless,until,when,yield,BEGIN,END`    =<      case,done,elif,esac,eval,fi,function,in,local,set,then,untila  kn      ^(DIR|FILE|vector|(de|priority_)?queue|list|stack|(const_)?iterator|(multi)?(set|map)|bitset|u?(int|float)\d*)b    |S.      caller,delete,die,do,dump,elsif,eval,exit,foreach,for,goto,if,import,last,local,my,next,no,our,print,package,redo,require,sub,undef,unless,until,use,wantarray,while,BEGIN,ENDc    ^      ^[^<?]+d   To      dece   /      ^<!\w[^>]*(?:>|$)f     '9      ^<\!--[\S\s]*?(?:--\>|$)g        ^<\?([\S\s]+?)(?:\?>|$)h   f      ^<%([\S\s]+?)(?:%>|$)i     xw*      ^(?:<[%?]|[%?]>)j  WP]Z%      ^<xmp\b[^>]*>([\S\s]+?)<\/xmp\b[^>]*>k     iz      lang-jsl   ?-      ^<script\b[^>]*>([\S\s]*?)(<\/script\b[^>]*>)m            lang-cssn  jk+      ^<style\b[^>]*>([\S\s]*?)(<\/style\b[^>]*>)o   `Y:      lang-in.tagp   :^r      ^(<\/?[a-z][^<>]*>)q   |      htmr   UO      mxmls  g      xhtmlt           xslu          	
v  o.      atvw   .      ^(?:"[^"]*"?|'[^']*'?)x    EI7       ^^<\/?[a-z](?:[\w-.:]*\w)?|\/?>$y  =      atnz   ;,Y%      ^(?!style[\s=]|on)[a-z](?:[\w:-]*\w)?{     w      lang-uq.val|   0^&      ^=\s*([^\s"'>]*(?:[^\s"'/>]|\/(?=\s)))}    0m      ^[/<->]+~        ^on\w+\s*=\s*"([^"]+)"    CP#u      ^on\w+\s*=\s*'([^']+)'    o      ^on\w+\s*=\s*([^\s"'>]+)  S0      ^style\s*=\s*"([^"]+)"    T;      ^style\s*=\s*'([^']+)'    :      ^style\s*=\s*([^\s"'>]+)  p'      in.tag    	\      ^[\S\s]+  I      uq.val    F      cpp   Pv      cxx   &N      cyc   M      null,true,false   4S      java  3l~      bsh         csh   +f{      perl  2b      all,and,by,catch,class,else,extends,false,finally,for,if,in,is,isnt,loop,new,no,not,null,of,off,on,or,return,super,then,true,try,unless,until,when,while,yes        multilineStrings        coffee    'M      prettyPrintOne    4      PRE   S      prettyPrint   *      now   c3      prettyprint   Q      CODE        tagName         xmp   [      \blinenums\b(?::(\d+))?   XFZ      getElementsByTagName  e      \blang(?:uage)?-([\w.]+)(?!\S)    c&{      createSimpleLexer     Xl      registerLangHandler   *nr      sourceDecorator   5O_      PR_ATTRIB_NAME          PR_ATTRIB_VALUE   )7
      PR_COMMENT    }      PR_DECLARATION    .r
      PR_KEYWORD    
      PR_LITERAL    Q	      PR_NOCODE     Rj?      nocode    /2v      PR_PLAIN  J      PR_PUNCTUATION    @	      PR_SOURCE     ,	      PR_STRING           PR_TAG    .	      PR_TYPE   dg      Toggle    !      _state    4>	      off-state     0T	      _messages     9      _states   e       on-state  s	      on-prompt     U
      off-prompt          inherits        SimpleControl     ~      resetStyles   8Al%      _element  x      states    Lg      idx         setText   X      isOn  o=
      isCheckBox    y*      checkbox        oldState  C`1      askbot.Toggle.stateChange     *      newState         toggleState   w      btnText         .js-btn-text  s(      where     v1S      setMessages   
      setMessage    Fgj	      createDom     y-      makeElement         onStateText   n      offStateText  h<      onPromptText  bz      offPromptText     6B      decorate  y	      mouseover     8^      is_on     c      mouseout  ?      setupButtonEventHandlers  Sj
      getHandler    bw      ExpanderToggle    y
      expandable    ;GeL      setExpandable     I'l      _handler        getExpanderHandler    +      setCollapsed  t	      collapsed     ?"M      _expandable   ;      getExpandable     2      lanai     ^.      highlightSyntax   IE;      styled    28      pre code  rH      appendLoader  z	      " title="     =K      removeLoader  lSo      img.ajax-loader   tl      setSubmitButtonDisabled   7
      isDisabled    !B      input[type="submit"]        enableSubmitButton    4d~      disableSubmitButton   D      setupFormValidation   V      validationRules   _X      validationMessages    'G      onSubmitCallback  ?      placementLocation           placementClass    4PB      span  
      form-error    Cj      .form-group   w	      has-error     	      formGroup     [      .form-error   9      in-label  9      after-label   B
      errorLabel    S      replaceWith   c%
      element_id          label[for="   l--      form_dom         validateTagLength     p=      getUniqueWords    S      are_tags_ok   p'G      maxTagLength  ;      validateTagCount  *L;      maxTagsPerPost    gr      limit_tag_count   T:      limit_tag_length  R
      validators	    c-      titleValidator
    q      minTitleLength    @oQ      interpolate   |      ngettext  Q      enter > %(length)s character  gK      enter > %(length)s characters           questionDetailsValidator  s^	      minLength     v\      minQuestionBodyLength     H       details must have > %s character  AT?!      details must have > %s characters     7N      answerValidator         minAnswerBodyLength   
      textLength    t      tinymce   {$      CPValidator   Z      getQuestionFormRules  tv      tagsAreRequired   "      getQuestionFormMessages         tags cannot be empty  >22-	      tagLimits     E      details are required  nL      enter your question    K      getAnswerFormRules!    r:r      getAnswerFormMessages"     6      content cannot be empty#   u&X~      ThreadUsersDialog$     |j
      _heading_text%     >%      Add heading with the setHeadingText()&     pn      setHeadingText'    	      showUsers(     2      _dialog)   6a      startShowingUsers*     >      threadId+  (	      _threadId,           _url-  
      GET.   '%	      thread_id/     
,      cache0     Z(      showMessage1    
      getElement2    jZ      superClass_3   ^      ModalDialog4   t       setRejectButtonText5   ;      setAcceptButtonText6         Back to the question7        setAcceptHandler8  &E      dialog_element9    ="      .modal-footer:     suA
      text-align;    7}$
      setHandler<    XC      MergeQuestionsDialog=  L      _tags>     P       _prevQuestionId?    bU      _idInput@        getStartMergingHandlerA    /      mergeQuestionsB    n	      stringifyC     *      from_idD   ;1?	      getFromIdE     @S      to_idF     -1s      getToIdG   MT      reloadH    G.@
      setPreviewI    (jk      _previewTitleJ     -U~      _previewBodyK  <      summaryL   &      disposeM    F      TagN   >      setLinkableO         setNameP   &      _previewTagsQ  B      _previewR  U"      fadeInS          clearIdInputT  ~4|      clearPreviewU  Te      Load previewV  #z      _fromIdW   V      getPrevToIdX   G:j      setPrevToIdY   $}      toIdZ  H      getLoadPreviewHandler[     Y>      prevId\    w      curId]     GJ      apiV1Questions^    H_      Merge_     d(      setPreviewLoaded`  1P      isLoadeda  ;9&      _isPreviewLoadedb  Jj      isPreviewLoadedc   5      getAcceptHandlerd  D      getRejectHandlere  E>f      question_idf   6      enterDuplicateQuestionIdg   l      clrh   <6      clearfixi  ~w*      previewHandlerj          enterHandlerk  Q      makeKeyHandlerl    Si      setClassm  b      merge-questionsn   3B+      setRejectHandlero  qI      .js-questionp        postIdq    T)      askbot.afterMergeQuestionsDialogCreateDomr     	      DraftPosts     F      WrappedElementt    _~C      getUrlu    hg      Not Implementedv   I 
      shouldSavew          getDatax   -}
      backupDatay    Cs	      _old_dataz     _%      showNotification{  mH9      note|  \      .editor-status span}   FQ      draft saved...~    cH:      fadeOut   '      getSaveHandler    8ea      save_synchronously          assignContentElements     B      onbeforeunload    It      saveHandler   ~0DR      DraftQuestion     a8      saveDraftQuestion     p}s      newd  hML@      oldd        tagnames         _title_element          _text_element     /o      _tagnames_element     n	      #id_title           #editor    #      #id_tags  !}      DraftAnswer   /f&      setThreadId         saveDraftAnswer   .A      _textElement  >]      CommentVoteButton     8      comment   >J      _comment  KL9      _voted           _score          setScore  5U      score     I      askbot.afterSetScore  P      setVoted  3      voted     s
      upvoted   ":      getVoteHandler     T
      cancelVote          post_id   '      getId     3      cancel_vote   oa      upvote_comment    =y      upvote    V      updateQuestionFollowerCount   Bh      fav   _      .js-question-follower-count   ,      num_followers     62      fmt         %s follower   v-      %s followers        Vote  A
      questionId    [S      questionSlug  "      questionAuthorId  J*      currentUserId     A<      answerContainerIdPrefix   $      post-id-  I      voteContainerId         vote-buttons  1      imgIdPrefixAccept     *      answer-img-accept-    S      imgIdPrefixQuestionVoteup     X      question-img-upvote-  02G      imgIdPrefixQuestionVotedown   A       question-img-downvote-    Q@>      imgIdPrefixAnswerVoteup         answer-img-upvote-    Nv      imgIdPrefixAnswerVotedown     _Y      answer-img-downvote-  |y      voteNumberClass   d      vote-number   (      offensiveIdPrefixQuestionFlag     aJY      question-offensive-flag-  y%#      removeOffensiveIdPrefixQuestionFlag   N#      question-offensive-remove-flag-   m&      removeAllOffensiveIdPrefixQuestionFlag    w@#      question-offensive-remove-all-flag-   -8      offensiveIdPrefixAnswerFlag   mk      answer-offensive-flag-    !      removeOffensiveIdPrefixAnswerFlag     	      answer-offensive-remove-flag-     |$      removeAllOffensiveIdPrefixAnswerFlag  SL!      answer-offensive-remove-all-flag-     Xl:y      offensiveClassFlag    =l      offensive-flag    b8      questionControlsId    Fk      question-controls     =      removeAnswerLinkIdPrefix  ac      answer-delete-link-   z3      questionSubscribeUpdates  =H      question-subscribe-updates    4      questionSubscribeSidebar  k      question-subscribe-sidebar    K      acceptAnonymousMessage    $      insufficient privilege    x      pleaseLogin   GE|
       <a href="    w      user_signin         please login  ;:      subscribeAnonymousMessage     K-      anonymous users cannot subscribe to questions           voteAnonymousMessage  ;UL      anonymous users cannot vote   @N      offensiveAnonymousMessage     D+      anonymous users cannot flag offensive posts   d      removeConfirmation    V      confirm delete    o/o5      removeAnonymousMessage    w&      anonymous users cannot delete/undelete    6fM      recoveredMessage  V      post recovered    xj      deletedMessage    n      post deleted  @      VoteType        acceptAnswer  .>      questionUpVote    f6      questionDownVote  ?U      answerUpVote  Z eX      answerDownVote    9!      offensiveQuestion     fO      removeOffensiveQuestion   R4      removeAllOffensiveQuestion    ,      offensiveAnswer   .      removeOffensiveAnswer           removeAllOffensiveAnswer  M      removeQuestion    OP      removeAnswer  'I      questionUnsubscribeUpdates    s      getQuestionVoteUpButton   'n      questionVoteUpButton  *      div.  l
       div[id^="          getQuestionVoteDownButton     /ks      questionVoteDownButton     6XNx      getAnswerVoteUpButtons    >c	      answerVoteUpButton          getAnswerVoteDownButtons  `xj      answerVoteDownButton        getAnswerVoteUpButton     	6	       div[id="     g      getAnswerVoteDownButton         getOffensiveQuestionFlag        offensiveQuestionFlag	     [/
      span[id^="
     v      getRemoveOffensiveQuestionFlag    5g      removeOffensiveQuestionFlag   '[!      getRemoveAllOffensiveQuestionFlag     ~s      removeAllOffensiveQuestionFlag          getOffensiveAnswerFlags         getRemoveOffensiveAnswerFlag        removeOffensiveAnswerFlag     _      getRemoveAllOffensiveAnswerFlag   'U      removeAllOffensiveAnswerFlag  )#      getquestionSubscribeUpdatesCheckbox   FN#      getquestionSubscribeSidebarCheckbox   q8v~      getremoveAnswersLinks     Ef      removeAnswerLinks     Q      a[id^="   m      setVoteImage  V~      voteType        flag  S_#      setVoteNumber     ]
      voteNumber    *
      bindEvents    VX      acceptedButtons   u      vote   1z7	      offensive!     A      remove_offensive"  x      remove_all_offensive#  R|      vote_url$  yr
      handleFail%    1      xhr&   ?X      msg'   M      Callback invoke error: (   q;p      callback_accept)   `      allowed*   H      -1+    l<_'      sorry, you cannot %(accept_own_answer)s,         accept_own_answer-           acceptOwnAnswer.   Xs      accepted-answer/   	$      askbot.unacceptAnswer0           answers1   8m	      div[id^="2     1      askbot.acceptAnswer3   6      callback_vote4     5      askbot.voteDown5   *+      askbot.voteUp6           callback_offensive7    `      span[class="darkred"]8     $      .question-flag9    o:      remove flag:   \	      obj_id;          flag-<     [      remove-flag-=  |      callback_remove_offensive>     Rq
      remove_all?    s      siblings@  q06      span.offensive-flag[id*="-offensive-remove-all-flag-"]A    [v      span.sepB        flag offensiveC    'I^      callback_remove_all_offensiveD     2
      remove_ownE    H2      span.offensive-flag[id*="-offensive-remove-flag-"]F    "hG      callback_removeG         removeActionTypeH  i)      postNodeI  _/SH      deletedJ   LS      postRemoveLinkK    0      undeleteL  X      qIdM   7N      qSlugN     o      questionAuthorO    j      userIdP    fs.      .answer-img-acceptQ     
      .post-voteR    Tm|      NONES  a}      {{QuestionID}}T    4      {{questionSlug}}U  BH      bitsV  i4      popW   3      postTypeX  3T
      do_proceedY    >k	      #post-id-Z     :}@      confirm[   q=p      questionRetagger\  u      oldTagsHTML]   A      tagInput^  O      tagsList_  o	      retagLink`     I      restoreEventHandlersa  Ju0      cancelRetagb   
      post-retagc    o;	      post-tagsd           initRetaggere  -      drawNewTagsf   7      new_tagsg        emptyh     \ 	      tags_htmli     vfv	      <li></li>j     8      doRetagk         retagl     j      oldTagsHtmlm   n      notifyn    pH
      textStatuso    	S"      sorry, something is not right herep    W      setupInputEventHandlersq   \      createRetagFormr   d|t      old_tags_strings         <form method="post"></form>t   noM      <input id="retag_tags" type="text" autocomplete="off" name="tags" size="30"/>u     e      addExtraCssClassesv    10t      textInputClassesw  &      tagAcx     d      AutoCompletery     .)n      get_tag_listz  ds      minChars{  YW      useCache|  x      matchInside}   $'      maxCacheLength~    1      _results  o      askbot.afterCreateRetagForm   z      retag-error   z$      askbot.afterSetupValidationRetagForm        getTagsAsString   _      tags_div  aPS)      links     x      .js-tag-name        tags_str        noopHandler    $      deactivateRetagLink   1U
      startRetag    a      #question-tags    E
      retag_form    X      setupClickAndEnterHandler     r_      #retag    U      VoteControls  /6      _postAuthorId     >+V      _postId   I	      setPostId     K(	      getPostId     c      setPostAuthorId         setSlug   M      slug  p      _slug     h      setPostType   2K	      _postType     W      getPostType   4
      clearVotes    /p      _upvoteButton     <d      _downvoteButton   Y      toggleButton  !
      toggleVote    i      setVoteCount  |}
      _voteCount    f      updateDisplay           getAnonymousMessage   g      userIsAuthenticated   B      voteMap   <      downvote  0      answer    <      legacyVoteType    Bo      upvoteButton  $      .upvote         downvoteButton    0"I	      .downvote     m      .vote-number  /      DeletePostLink    j      _post_id  <      getPostElement    
      isPostDeleted     i      _post_deleted     |      setPostDeleted    
      is_deleted    k      getDeleteHandler        delete_post   8yP      SimpleEditor  e      attrs     b8      _rows     Qn$      rows  g      _cols     %~      cols  6		      _minLines     o      minLines  W2
      _maxlength    {1      onFocus   /
=	      _textarea            putCursorAtEnd    K      getAutoResizeHandler  h      setHighlight  7      isHighlighted           setTextareaName   {}      _textareaName           getText   0bp      getHtml   "      <div class="transient-comment"><p>    IUq
      </p></div>    S      _text     w      mirror    ;      _mirror   !      setMirrorStyle    MQ"
      getKeyCode    g      
Z    B
      (\r|\n)$  .
      lineHeight    q      line-height   &      ceil  _	      mirrorCss     9      -999em    a	      word-wrap     Be
      word-break    c      overflow  	      fontProps     JP      getFontProps  dw      getTemplate   ;|      .js-simple-editor           .mirror         tinymceEditorDeselector         editorClasses     ?s-      change paste keyup keydown    eY      WMDExpanderToggle     k      getPreviewerElement   F&      _editor   Y      getEditorElement  MR      Preview: (hide)   &7H      Show preview  4D	      getEditor     sm      setPreviewerCollapsedClass    U      wmd-previewer-collapsed   $%      getSuperClass           wmd-previewer-toggle  O
5      askbot.WrappedElement.show askbot.WrappedElement.hide     }3      WMD   G      opts  r's      _enabled_buttons  O
R      _previewerEnabled     5V      setEnabledButtons     W/      setPreviewerEnabled   \      enabledStatus     AiN
      _previewer          _previewerToggle  c      getPreviewerEnabled   K6      wmd_container     ^F      wmd-container     >m      wmd_buttons   `	      wmd-panel     I:/      wmd-preview   L      .wmd-preview 	  x	      getIdSeed	     O      TinyMCE	   ~4      config	    U      defaultConfig	     5      parse	     A      tinyMCEConfigJson	     #      _config	   .%      _id	   d',
      onInitHook		    rL]      tinyMCE
	   ="      activeEditor	  Ca      spellchecker	        tinyMCEPlugins	    &(      controlManager	    9E	      setActive	     <b      execCommand	         mceSpellCheck	     B'      .mceStatusbar	     /+O      onChangeHook	  j      triggerSave	   58w	      extraOpts	     s      exact	           endId	     oR      DOM	   hs      uniqueId	  L a      dom	   \      getBody	   L      newNode	   
      span#	     &      editorId	  p      winH	  uf      winY 	  %      edY!	         edH"	   T      mceFocus#	  xR      isBelow$	   ?~      isAbove%	   :vD      setId&	     :y/	      editorBox'	     r<      EditCommentForm(	   }*      _commentsWidget)	   G7      _editorReady*	        getEditorType+	     	      commentsEditorType,	    	      rich-text-	     o
      plain-text.	    ^      startTinyMCEEditor/	    D      comment-editor0	    ]L'      content_css1	   \V{(      media/style/tinymce/comments-content.css2	  r      theme3	     R;      advanced4	  ,      theme_advanced_toolbar_location5	   kV$      theme_advanced_toolbar_align6	  e<      theme_advanced_buttons17	   8x*      bold, italic, |, link, |, numlist, bullist8	    9I      theme_advanced_buttons29	   ,      theme_advanced_path:	         plugins;	   (
      _editorBox<	    $      prepend=	   -      startWMDEditor>	    ?      bold italic link code ol ul?	   J      startSimpleEditor@	     R]      editorElementA	     Q|      limitLengthB	         getCommentTruncatorC	   J      updateCounterD	           getCounterUpdaterE	     +![_      escapeHandlerF	     T0j]      getCancelHandlerG	  sR      saveCommentOnEnterH	    xY      save_handlerI	        askbot.afterStartEditorJ	   S      getCommentsWidgetK	     2      attachToL	  =b      _typeM	           getContainerWidgetN	    0_      hideOpenEditorButtonO	  c_      _submit_btnP	   Q      add commentQ	   :Wf      _minorEditBoxR	     n       save commentS	  mU
      enableFormT	    	A      _cancel_btnU	    K#      askbot.afterEditCommentFormAttachedV	   JD      counterW	   kV9      _text_counterX	     H      maxCommentLengthY	        length1Z	   &9!      round[	     Nl      length2\	   
      color]	     u      maroon^	    _q      chars_	           minCommentBodyLength`	  3      feedbacka	  M@      enter at least %s charactersb	  0^!      enter at least %s more charactersc	           #f00d	  ]0      #f60e	        #999f	  Z      %s characters leftg	          maximum comment length reachedh	    -8	      maxLengthi	     1X	      canCancelj	      <%      ctextk	     QF~      confirmAbandonl	          widgetm	    x      handleDeletedCommentn	  vY      detacho	    r!      askbot.afterEditCommentFormCancelp	     '      showOpenEditorButtonq	  G-      isBlankr	         removeButtonEventHandlerss	     mm:      <form></form>t	     'Qk      post-commentsu	     &:      _controlsBoxv	        edit-comment-buttonsw	  `      <span></span>x	     BmP      <button></button>y	     1      primaryButtonClassesz	         <button class="cancel"></button>{	  4      cancelButtonClasses|	         enableEmailAlerts}	     Y      checkBox~	  F      suppress_email	    H1h      minor edit (don't send alerts)	          disableForm	   .1      Are you sure you don't want to post this comment?	     (      getSuppressEmail	  G      input[name="suppress_email"]	  aE      setSuppressEmail	  c      bool	  i      updateUserPostsData	   yM
      user_posts	    C      user_id	   Z      commentData	   GG      userName	  	>      comment_added_at	  ?      just now	  j      user_display_name	     5@      user_profile_url	  1      userProfileUrl	          user_avatar_url	   2O      userCommentAvatarUrl	  V      setDraftStatus	    cE      postCommentsWidget	    d-      canAddComment	     #`      commentsElement	   ;      askbot.beforeCommentSubmit	    e	      post_data	     WD      avatar_size	   3      commentAvatarSize	     y
      comment_id	          post_url	  \t      editComment	   +=9	      post_type	     nO      getParentType	     pA      getParentId	   Y:      postComments	        reRenderComments	         askbot.afterCommentSubmitSuccess	  M3      askbot.afterCommentSubmitError	    (      Comment	   /      _container_widget	     %      _data	     63      _is_convertible	         userIsAdminOrMod	  Y      convert_link	  sL      _delete_prompt	    6      delete this comment	         _editorForm	   `),      is_deletable	  
      _deletable	    Z      is_editable	   C	      _editable	           startEditing	        parent_type	   	      .comments	     >      parentPostType	          _contentBox	   X+?      .comment-content	  X       .timeago	  Jf      _dateElement	  =Ciq      userLink	  dQ      .author	   q(@      commentBody	         .comment-body	     U      _comment_body	     ~5
      delete_img	    2Z      .js-delete-icon	         _delete_icon	  -*
      DeleteIcon	    a      deletePrompt	  l	      edit_link	     E      .js-edit	  ;
      _edit_link	    (Q      EditLink	  h      getEditHandler	    d%      .convert-comment	  Y*      _convert_link	     8N      CommentConvertLink	    y      deleter	   e      .comment-delete	   j      _comment_delete	   n      _voteButton	   	      _userLink	     &`      askbot.afterCommentDecorate	   H      isDraft	         hasText	   !,T      data-post-id	  T      upvoted_by_user	   ~      post-	           -delete	   X=
      theComment	    <;      <div/>	          avatar	    x/      .js-avatar-box	    Bt
      .js-avatar	    XV
      decodeHtml	    &H      timeago	   uQ      votes	     nD4I	      .js-score	     !      comment-img-upvote-	         oldEditLink	   k      oldConvertLink	    6&      askbot.afterCommentConvertLinkInserted	    M9	      functions	     )      renderPostControls	    Uv      renderPostVoteButtons	     
      runMathJax	    (      askbot.afterCommentSetData	    ?
      _user_link	    _      _comment_added_at	     -      loadText	  0+      on_load_handler	   7
      getComment	    _	      exception	     d
/      del_icon	  Co      confirm delete comment	    dS      deleteComment	     6a      PostCommentsWidget	    G      _denied	   ]      parentPostId	  U3y
      _post_type	          _commentsReversed	     RH      commentsReversed	  8$      _loadCommentsButton	   >      .js-load-comments-btn	     r      getLoadCommentsHandler	    T5      getAllowEditHandler	   @      _openEditorButton	     &      .js-open-editor-btn	   <      getOpenEditorHandler	  ~      _isTruncated 
  gaP      _cbox
     [      .content
  4s      comments
  sN      .comment
  ve#	      _comments
     \'      .comment-title
    ub      getLoadCommentsButton
     1      getOpenEditorButton
   .      startNewComment	
   #      commentElem

         .js-comment
    =      askbot.beforeCommentStart
     !{      userCanPost
   ${!      reloadAllComments
     ?T      readOnlyModeEnabled
   2j      readOnlyMessage
   I+      please sign in or register to post comments
   bU      askbot.beforeReRenderComments
     <      askbot.afterReRenderComments
        socialSharing
     f;      SERVICE_DATA
  Tl      identica
  z:      http://identi.ca/notice/new?status_textarea={TEXT}%20{URL}
    '8NA      width=820, height=526,toolbar=1,status=1,resizable=1,scrollbars=1
     5j1      twitter
   :      http://twitter.com/share?url={URL}&ref=twitbtn&text={TEXT}
    9@      width=820,height=526,toolbar=1,status=1,resizable=1,scrollbars=1
  DvD      facebook
  #J?      http://www.facebook.com/sharer.php?u={URL}&ref=fbshare&t={TEXT}
   O8@      width=630,height=436,toolbar=1,status=1,resizable=1,scrollbars=1
        linkedin
  E      http://www.linkedin.com/shareArticle?mini=true&url={URL}&title={TEXT} 
     Z1H      URL!
   %
      share_page"
    k      service_name#
        {TEXT}$
    ]_      {URL}%
     W      sharing&
   |      urlBits'
   nP      h1 > a(
    ?7      hashtag)
   	w      sharingSuffixText*
     v      ... +
  Jc      a.facebook-share,
  f      a.twitter-share-
   l      a.linkedin-share.
        ica/
         a.identica-share0
        copyAltToTitle1
    2       TagWikiEditor2
           _content_backup3
   
Y      _is_editor_loaded4
           _enabled_editor_buttons5
   r0      backupContent6
     <      _content_box7
        contents8
        setEnabledEditorButtons9
   |      isEditorLoaded:
    	      _edit_btn;
     z	      _save_btn<
     !-      _cancel_sep=
   pI65      restoreContent>
    PE      content_box?
   '8i      getTagId@
        _tag_idA
         setEditorLoadedB
   \-:      startActivatingEditorC
     `B	      object_idD
     q
      model_nameE
    R      GroupF
     f'      load_object_descriptionG
   ]Yj      saveDataH
        save_object_descriptionI
   Q
      cancelEditJ
    5      edit_btnK
  o      .edit-descriptionL
     S?6      save_btnM
        saveN
  
      cancel_btnO
    o.E      <span> | </span>P
  dm}1      ImageChangerQ
  c#      _image_elementR
    L      _delete_buttonS
    ;	      _save_urlT
     h      _delete_urlU
   +      setImageElementV
   <`      image_elementW
     s      setDeleteButtonX
   d^      delete_buttonY
     H1w
      setSaveUrlZ
    &      setDeleteUrl[
  {      setAjaxData\
   .k
      _ajax_data]
    	      showImage^
     G	      image_url_
           deleteImage`
   	
      delete_urla
    f      saveImageUrlb
  ^zo      save_urlc
  /      startDialogd
   tK      change_image_texte
     F      change_imagef
  lGHl      change_image_buttong
   z	      <h3>h
  /_%      Enter the logo url or upload an imagei
     w      </h3>j
           showDeleteButtonk
  O0c      hideDeleteButtonl
  KAL      startDeletingm
     '      Do you really want to remove the image?n
   R	      add_imageo
     u?0      sepp
   7%      UserGroupProfileEditorq
    WP      toggleEmailModerationr
           _moderate_email_btns
         group_idt
  m      toggle_group_email_moderationu
     r      new_button_textv
   3G      bold italic link ol ulw
    N      change_logo_btnx
   x5M      .change-logoy
  vF      _change_logo_btnz
  qo      moderate_email_toggle{
     vo
      AjaxToggle|
    `	      setPostData}
   V      property_name~
     1      moderate_email
    n D      moderate_email_btn
    }      #moderate-email
   #"      moderate_publishing_replies_toggle
    9Z      moderate_answers_to_enquirers
     R      #moderate-answers-to-enquirers
    5<6
      vip_toggle
    W      is_vip
    w      #vip-toggle
   gg      readOnlyToggle
    \w-	      read_only
     5g      #read-only-toggle
     g&c      opennessSelector
        DropdownSelect
    9      selectorElement
   8p      #group-openness-selector
  ]Vb      openness
  X*      email_editor
  h;      TextPropertyEditor
    [\      #preapproved-emails
         domain_editor
     f      #preapproved-email-domains
    Z      logo_changer
  z%      .group-logo
   Y      save_group_logo_url
   !]U      delete_group_logo_url
     =      change logo
   R      add logo
  q      delete_logo_btn
   f^(      .delete-logo
  +np      GroupJoinButton
   }      getPostData
   l~	      _group_id
     CO      join_or_leave_group
   ^      membership_level
  Q\	      new_state
     e      groupId
   ~vY	      TagEditor
           _has_hot_backspace
    	      _settings
     
      tag_editor
    ^7      getSelectedTags
   3I=      _hidden_tags_input
    ,xI      setSelectedTags
   t<	      tag_names
           addSelectedTag
    ?      tag_name
  3Y
      .acResults
    [      isSelectedTagName
     S      removeSelectedTag
     g      splice
    Qd:o      getTagDeleteHandler
   'B      getName
   i      clearErrorMessage
     N?	      fixHeight
     Lu      cleanTag
  ME_X      reject_dupe
   ae      force_lowercase
   $)      force_lowercase_tags
  ~qH      tag "%s" was already added, no need to repeat (press "escape" to delete)
  V      max_tags
  r8      max_tags_per_post
     ha      a maximum of %s tag is allowed
    g       a maximum of %s tags are allowed
  AK      addTag
          setDeletable
        setDeleteHandler
  	'      _tags_container
   BY2      immediateClearErrorMessage
    ?/      _error_alert
  21.      setErrorMessage
   J      old_text
  G      getAddTagHandler
  O      clean_tag_name
    ^b      clearNewTagInput
  TR      getRawNewTagValue
     %_R      _visible_tags_input
   =      editLastTag
   ol      li:last
         last_tag
  ~W      setHotBackspace
   J;      is_hot
    ="      hasHotBackspace
   8k      completeTagInput
  P/>
      saveHeight
    #!      closeAutoCompleter
    PL      _autocompleter
    |4      finish
    B2      getTagInputKeyHandler
     -      cleanTagName
  ^      cleaned_tag_name
  Zb
      input[name="tags"]
    y      ul.tags
   `      .tag-editor-error-alert > span
    p.      visible_tags_input
    YrW      .new-tags-input
   >      tagsAc
    7T      onItemSelect
  ,Km      Category
  LU      SelectBoxItem
     #b      setCategoryTree
    m      tree
  2       _tree
     %O.y      getCategoryTree
   Lb6      getPath
   R      getPathToItem
     E6
      _input_box
          showContent
   
      hideEditor
    B!4      hideEditControls
        editable
  oa      showEditControls
  \      editing
   mZB      _prev_tree_state
  Q_      getState
  +(+      hideContent
   h;vC
      showEditor
    8      _edit_button
  f0      mouseenter mouseleave
     cJI      del
   w      showEditControlsNow
   jJ      _save_button
  Wx      _cancel_button
    &J`      getInput
  IUM      Delete category?
  ":k      path
  Y
      delete_tag
    n      setData
   ~	      tree_data
     (E
      selectPath     _^@      getCurrentPath    <7      to_name   ae	      from_name     ,      getOriginalName   au
      rename_tag           addControls   o7	      input_box     8      save_button   
      makeButton	    +=      cancel_button
     $e      edit_button   W      _original_name    'b:      CategoryAdder     o      setLevel  xh      _level    S      waiting   L      _input    X      _trigger  _r      cleanCategoryName           category name cannot be empty     /      getSelectBox  fT      startAdding   [}      existing_names           getNames  1$      already exists at the current level!  
      adder_path    2      new_category_name     bm      add_tag_category  vJ      new_path  FF      add category  Aj      add-category  u      add_category   L4      CategorySelectBox!     " 	      SelectBox"     +F      _item_class#   b=      _category_adder$   L?      _items%          names&           appendCategoryAdder'   e      adder(     )&V+      userIsAdmin)   \=      CategoryEditorToggle*  +      setCategorySelector+   9x      sel,   %Z      _category_selector-    N      getCategorySelector.   T      getDefaultHandler/           CategorySelector0  o      Widget1    [(p      _select_handler2   f      _current_path3     4G
      _selectors4    i4      findPathToItemInTree5  &`      node6        applyToDataItems7        attachCategory8    E*A      cat9   p       clearCategoryLevels:   *      detachAllItems;    ~}      getLeafItems<  >c      selection_path=    %      populateCategoryLevel>     `      source_path?   7Gm      category_name@     d      category_subtreeA        category_objectB         addItemObjectC     PC4      addCssClassD   4c      clearSelectionE    8      sel_boxF         categoryG  s      getItemByIndexH    
M.
      selectItemI          getSelectedPathJ   ~&	      selected_levelK    f      getSelectedItemL   -c      getItemIndexM        setSelectHandlerN  	y_      getSelectHandlerInternalO  ]      setCurrentPathP    u      getEditorToggleQ    l      _editor_toggleR    @Wa      getSelectHandlerS  	      item_dataT     8oI      current_pathU  } 	      selector0V     Fh
      .cat-col-0W    MW&	      selector1X     [s
      .cat-col-1Y    q	      selector2Z     0S
      .cat-col-2[    :      editor_toggle\     ?+I      toggle_element]          .category-editor-toggle^   ~       CategorySelectorLoader_     lFU
      _is_loaded`    Ab 	      setLoadeda     (y	      is_loadedb     Z	      setEditorc     s:&      closeEditord   >v      _editor_buttonse   kd      _display_tags_containerf   G3      _question_bodyg    8lb      _question_controlsh    XZ
      openEditori    n      addEditorButtonsj  hD      getOnLoadHandlerk  ^      </div>l    `@       initCategoryTreem  `s      startLoadingHTMLn  n      on_loado   H]      template_namep     I"      widgets/tag_category_selector.htmlq    N6      get_html_templater     aH      getRetagHandlers   
oY      tagsDivt   u      .question .post-bodyu  ,)8      #question-controlsv          _done_buttonw  M		      save tagsx     @A      retagger-buttonsy  OU	      AskButtonz     C#      userIsReadOnly{    {:       Sorry, you have only read access|  
      ready}     4      [id^="post-id-"]~  ?      .question-delete  JGG      publishBtns   >"      .answer-publish, .answer-unpublish    0-      answerId  *	      answer_id     k      publishAnswer     #|	      tagSource     (      category-tree           catSelectorLoader           proxyUserNameInput          #id_post_author_username  .I{      proxyUserEmailInput   w      #id_post_author_email     !#      userSelectHandler     _
      fakeUserAc    Ve      get_users_info    F      groupsInput   L]      #share_group_name     	      groupsAc  8N      getGroupsList     n
      promptText    p      Group name:   !
      usersInput    &      #share_user_name  )      usersAc   ^%      /get-users-info/  .      userNamePrompt     #       showSharedUsers   _      .see-related-users    
I
      usersPopup    s4       Shared with the following users:  !      showSharedGroups  dA-      .see-related-groups   {      groupsPopup   %(/:!      Shared with the following groups:     nB	      askButton     @
      #askButton    W      userIsThreadModerator     !      mergeBtn  / '      .question-merge   l      Editable        _isEditorLoaded   X      _enabledEditorButtons     `       _isPreviewerEnabled         _contentBackup    JE      _content  Z      _editBtn  e      _saveBtn  
      _cancelBtn    *,
      _hideables    y<      getObjectId   5F	      _objectId     #]      getAttributeName  91q      _attributeName    M      startEditingText  Pw]      _editorType   d	      paramName     *v      _saveTextParamName    R,JG      _getTextUrl   |      _getTextUrlParams     j      setError  f      _error    ^
      clearError    V      saveText  I
      editorText    -	      stripTags     `
      _validator    d      _saveTextUrlParams    D      validatedParamName    Bp      _validatedTextParamName   A      _saveTextUrl  (      parsed    +      id of .js-editable must have > 3 characters   L      js-   &      id of .js-editable must start with js-    X      .js-editable-content  47      editBtn   >\      js-edit-btn-  H`4`       edit button with id js-edit-btn-  20       is required  o      err   u	      .js-error     8L      js-error  N
      getTextUrl    ibb      parseUrl  $      saveTextUrl   B3      saveTextParamName           validatedTextParamName    9      _useCompactEditor           editorCompact     N0k      validatorPath     r      getObjectByPath   ;      previewerEnabled  ]u      tinyMCE-  *L      formControls  J<      .js-editable-controls     *      .js-editable-hide-    {      saveBtn   [+p	      cancelBtn     V&      .js-editable  >o      Form        _errors   ^      _errorElements    $      _validators   a      _inputs   >      fieldHasErrors    W	      fieldName     o      formHasErrors     HD      fields    _      _fieldNames   !      field     >      validateForm  K      validateField     ?      getFormValidationHandler  0U      setFieldError     %N      errorMsg  
L      clearFieldError         decorateField     L	      Validator     8      .js-  <      -error    ?      input[name="  Y      textarea[name="         select[name="     W
      fieldNames    %      validatedFields   +      FoldedEditor  Mh      getEditorInputId        onAfterOpenHandler          askbot.FoldedEditor.afterOpened    5      getOpenHandler    	      promptBox           _prompt   P      unfolded  }      .js-folded-editor-trigger     a      .editor-proper    1	      setIdSeed     d      wrong editor type "   v60      placeHolder	   TsV      .editor-placeholder
   E>e:      draftAnswer   f      openHandler   t>
      AnswerForm    F^      getAfterOpenHandler   Bv      .folded-editor    4       foldedEditor  [/L      onAfterOpen         <img class="ajax-loader" src="    NU      $.fn.TextAreaResizer  ,
G      $.fn.TextAreaResizer/<    w      jQuery.fn.typeWatch   7O"      jQuery.fn.typeWatch/watchElement/<    !V]      jQuery.fn.typeWatch/<     Q'      ajaxFileUpload/d/<    X      ajaxFileUpload/<"  ~      $.support.transition<#     G      $.support.transition<.end<$    p{`      show/<%    v      show/</<&  `      hideWithTransition/timeout<'   yj      hideWithTransition/<(  x      escape/<)  i3
      $.fn.modal*    -O      $.fn.modal/<+  ?U
      Dropdown/<,    /      $.fn.dropdown-     -      $.fn.dropdown/<.   &      refresh/this.targets</     6;      refresh/this.offsets<0     o/      $.fn.scrollspy1    n      $.fn.scrollspy/<3  '      $.fn.tab4  +
      $.fn.tab/<5          enter/<6   }      leave/<8   # !      hide/removeWithAnimation/timeout<9     vO      hide/removeWithAnimation/<:            $.fn.tooltip;  xO      $.fn.tooltip/<<    7      $.fn.popover=        $.fn.popover/<?    (T
      $.fn.alert@    C>      $.fn.alert/<A  
      setState/<B    )      $.fn.buttonC   ]      $.fn.button/<E     ?1      $.fn.collapseF     <j      $.fn.collapse/<G   ^&GR      to/<H  3      slide/<I   "5	      slide/</<J     d      $.fn.carouselK     [      $.fn.carousel/<L   lw      lookup/items<M     WF      highlighter/<N     U      render/items<O     $R      blur/<P    hd      $.fn.typeaheadQ    p      $.fn.typeahead/<R  :\      chain/this[hookname]S  \      Markdown.ConverterT    M_       Markdown.Converter/this.makeHtmlV  0.      Markdown.Converter/_StripLinkDefinitions/text<]    ;Q?      Markdown.Converter/_EscapeSpecialCharsWithinTagAttributes/text<d   Q#      Markdown.Converter/_DoHeaders/text<f   A!      Markdown.Converter/_DoLists/text<h     L,V.      Markdown.Converter/_ProcessListItems/list_str<j    &      Markdown.Converter/_DoCodeBlocks/text<m    V%      Markdown.Converter/_DoCodeSpans/text<q     (W'      Markdown.Converter/_DoBlockQuotes/text<r   0}+      Markdown.Converter/_DoBlockQuotes/text</bq<t   G9\u/      Markdown.Converter/_FormParagraphs/grafsOut[i]<x   NZ-      Markdown.Converter/handleTrailingParens/link<|     S~.      Markdown.Converter/_UnescapeSpecialChars/text<    w      Markdown.Converter/_Detab/<   *      Markdown.Converter/encodeProblemUrlChars/<    _      output.getSanitizingConverter     	>      balanceTags/html<     #V:      AskbotMarkdownConverter.prototype.scheduleMathJaxRendering    rT*      AskbotMarkdownConverter.prototype.makeHtml    f,      AskbotMarkdownConverter.prototype.makeHtml/<  &3      Attacklab.wmdBase     "a%      Attacklab.wmdBase/wmd.PanelCollection     <       Attacklab.wmdBase/util.isVisible  D$      Attacklab.wmdBase/util.addEvent   	"      Attacklab.wmdBase/util.removeEvent    "      Attacklab.wmdBase/util.fixEolChars    w#      Attacklab.wmdBase/util.extendRegExp   "      Attacklab.wmdBase/util.createImage    3O#      Attacklab.wmdBase/util.prompt     h&8      Attacklab.wmdBase/util.prompt/createDialog/form.onsubmit  )8;      Attacklab.wmdBase/util.prompt/createDialog/okButton.onclick   ?      Attacklab.wmdBase/util.prompt/createDialog/cancelButton.onclick   []>      Attacklab.wmdBase/util.prompt/<   l!      Attacklab.wmdBase/position.getTop     J'b$      Attacklab.wmdBase/position.getHeight  I#      Attacklab.wmdBase/position.getWidth   <&      Attacklab.wmdBase/position.getPageSize    'U\!      Attacklab.wmdBase/wmd.inputPoller     e+      Attacklab.wmdBase/wmd.inputPoller/this.tick   kn.      Attacklab.wmdBase/wmd.inputPoller/this.destroy    T!      Attacklab.wmdBase/wmd.undoManager     45)5      Attacklab.wmdBase/wmd.undoManager/this.setCommandMode     ,7.      Attacklab.wmdBase/wmd.undoManager/this.canUndo    ~.      Attacklab.wmdBase/wmd.undoManager/this.canRedo    b+      Attacklab.wmdBase/wmd.undoManager/this.undo    v+      Attacklab.wmdBase/wmd.undoManager/this.redo   E4      Attacklab.wmdBase/wmd.undoManager/setEventHandlers/<  _u.      Attacklab.wmdBase/wmd.undoManager/this.destroy    h      Attacklab.wmdBase/wmd.editor  TW;      Attacklab.wmdBase/wmd.editor/setupButton/button.onmouseover   A:      Attacklab.wmdBase/wmd.editor/setupButton/button.onmouseout    p#;      Attacklab.wmdBase/wmd.editor/setupButton/button.onmousedown   w7      Attacklab.wmdBase/wmd.editor/setupButton/button.onclick   qrkC      Attacklab.wmdBase/wmd.editor/makeSpritedButtonRow/linkButton.textOp   CeJD      Attacklab.wmdBase/wmd.editor/makeSpritedButtonRow/imageButton.textOp  ]gI      Attacklab.wmdBase/wmd.editor/makeSpritedButtonRow/attachmentButton.textOp     zAD      Attacklab.wmdBase/wmd.editor/makeSpritedButtonRow/olistButton.textOp  xUUaD      Attacklab.wmdBase/wmd.editor/makeSpritedButtonRow/ulistButton.textOp  D;D      Attacklab.wmdBase/wmd.editor/makeSpritedButtonRow/undoButton.execute  cnnD      Attacklab.wmdBase/wmd.editor/makeSpritedButtonRow/redoButton.execute  1      Attacklab.wmdBase/wmd.editor/setupEditor/undoMgr<     C*Q*      Attacklab.wmdBase/wmd.editor/setupEditor/<    OC?      Attacklab.wmdBase/wmd.editor/setupEditor/inputBox.form.onsubmit   >&      Attacklab.wmdBase/wmd.editor/this.undo    "(&      Attacklab.wmdBase/wmd.editor/this.redo    I)      Attacklab.wmdBase/wmd.editor/this.destroy     #      Attacklab.wmdBase/wmd.TextareaState   5,-      Attacklab.wmdBase/wmd.TextareaState/this.init     dDK>      Attacklab.wmdBase/wmd.TextareaState/this.setInputAreaSelection    -ZpDF      Attacklab.wmdBase/wmd.TextareaState/this.setInputAreaSelectionStartEnd    O--0      Attacklab.wmdBase/wmd.TextareaState/this.restore  /
)2      Attacklab.wmdBase/wmd.TextareaState/this.getChunks    #2      Attacklab.wmdBase/wmd.TextareaState/this.setChunks    
D      Attacklab.wmdBase/wmd.Chunks  g/      Attacklab.wmdBase/wmd.Chunks.prototype.findTags   Z<      Attacklab.wmdBase/wmd.Chunks.prototype.findTags/this.before<  ?      Attacklab.wmdBase/wmd.Chunks.prototype.findTags/this.selection<   /!{;      Attacklab.wmdBase/wmd.Chunks.prototype.findTags/this.after<   5      Attacklab.wmdBase/wmd.Chunks.prototype.trimWhitespace     a0      Attacklab.wmdBase/wmd.Chunks.prototype.skipLines  PI       Attacklab.wmdBase/command.unwrap  5      Attacklab.wmdBase/command.wrap    FPf/      Attacklab.wmdBase/command.wrap/chunk.selection<   Jk       Attacklab.wmdBase/command.doBold  R"      Attacklab.wmdBase/command.doItalic            Attacklab.wmdBase/command.doBorI  o'      Attacklab.wmdBase/command.stripLinkDefs   &V-      Attacklab.wmdBase/command.stripLinkDefs/text<     @$      Attacklab.wmdBase/command.addLinkDef  '      Attacklab.wmdBase/command.doLinkOrImage   \Uc      Attacklab.wmdBase/util.makeAPI    <w      Attacklab.wmdBase/util.makeId     Y}o"      Attacklab.wmdBase/util.startEditor    Z$      Attacklab.wmdBase/wmd.previewManager  |l1      Attacklab.wmdBase/wmd.previewManager/this.refresh     L)8      Attacklab.wmdBase/wmd.previewManager/this.processingTime  s0      Attacklab.wmdBase/wmd.previewManager/this.output  '?7      Attacklab.wmdBase/wmd.previewManager/this.setUpdateMode   @66      Attacklab.wmdBase/wmd.previewManager/pushPreviewHtml/<    ,!1      Attacklab.wmdBase/wmd.previewManager/this.destroy      &      Attacklab.wmdBase/command.doAutoindent    /-&      Attacklab.wmdBase/command.doBlockquote    $7      Attacklab.wmdBase/command.doBlockquote/chunk.selection<   4      Attacklab.wmdBase/command.doBlockquote/chunk.before<  mqF3      Attacklab.wmdBase/command.doBlockquote/chunk.after<   PJ      Attacklab.wmdBase/command.doBlockquote/replaceBlanksInTags/chunk.startTag<    eH      Attacklab.wmdBase/command.doBlockquote/replaceBlanksInTags/chunk.endTag<  2r       Attacklab.wmdBase/command.doCode	  %F%.      Attacklab.wmdBase/command.doCode/chunk.before<
    P       Attacklab.wmdBase/command.doList  YlG:      Attacklab.wmdBase/command.doList/getPrefixedItem/itemText<    qY.      Attacklab.wmdBase/command.doList/chunk.before<    uEs-      Attacklab.wmdBase/command.doList/chunk.after<     %#      Attacklab.wmdBase/command.doHeading   *      Attacklab.wmdBase/command.doHorizontalRule    I       Attacklab.wmd     /      Attacklab.wmd/Attacklab.loadEnv   .`
      validate/<    y      valid/<   h      removeAttrs/<     F'a      rules/<   ]      $.validator   L('      $.validator.format    
^      $.validator.format/<  M      init/<    Fu      init/</<   x&      showErrors/this.successList<!         findLastActive/<"  tv
      elements/<#    1      invalidElements/<$     L      errorsFor/<%         findByName/<&        classRules/<'  {b      normalizeRules/<(  iB      normalizeRule/<*   _      equalTo/target<+   V      $.ajax,          validateDelegate/<0    69-5      L/h/<2     |	      L/y/f[c]<5           x/<9   ?X      window.prettyPrintOne:     eBo      window.prettyPrint=          Toggle.prototype.resetStyles>        Toggle.prototype.resetStyles/<?    @      Toggle.prototype.isOn@     i0d      Toggle.prototype.isCheckBoxA   B      Toggle.prototype.setStateB     YK=      Toggle.prototype.toggleStateC  &i).      Toggle.prototype.setTextD        Toggle.prototype.setMessagesE  	i      Toggle.prototype.setMessageF   @      Toggle.prototype.createDomG          Toggle.prototype.decorateH     b      Toggle.prototype.decorate/<I   %      ExpanderToggle.prototype.setCollapsedJ     ,&      ExpanderToggle.prototype.setExpandableK    V&      ExpanderToggle.prototype.getExpandableL    L+      ExpanderToggle.prototype.getExpanderHandlerM   vc-      ExpanderToggle.prototype.getExpanderHandler/<N     |      highlightSyntax/<S     ::}      validateTagLength/<T   e3       askbot.validators.titleValidatorU  Px*      askbot.validators.questionDetailsValidatorV    <!      askbot.validators.answerValidatorW     $>R      CPValidator<X  *      ThreadUsersDialog.prototype.setHeadingTextY    %      ThreadUsersDialog.prototype.showUsersZ     L}-      ThreadUsersDialog.prototype.startShowingUsers\     $      ThreadUsersDialog.prototype.decorate]  ?&      ThreadUsersDialog.prototype.decorate/<^    #      MergeQuestionsDialog.prototype.show_   m5      MergeQuestionsDialog.prototype.getStartMergingHandler`     97      MergeQuestionsDialog.prototype.getStartMergingHandler/<b   `)      MergeQuestionsDialog.prototype.setPreviewc     q+      MergeQuestionsDialog.prototype.clearIdInputd   HK+      MergeQuestionsDialog.prototype.clearPreviewe   o(      MergeQuestionsDialog.prototype.getFromIdf  Ez&      MergeQuestionsDialog.prototype.getToIdg    *      MergeQuestionsDialog.prototype.getPrevToIdh    +qq+*      MergeQuestionsDialog.prototype.setPrevToIdi    J,4      MergeQuestionsDialog.prototype.getLoadPreviewHandlerj  S,jr6      MergeQuestionsDialog.prototype.getLoadPreviewHandler/<m    t5?/      MergeQuestionsDialog.prototype.setPreviewLoadedn   Dq.      MergeQuestionsDialog.prototype.isPreviewLoadedo    k/      MergeQuestionsDialog.prototype.getAcceptHandlerp   u1      MergeQuestionsDialog.prototype.getAcceptHandler/<q     !t/      MergeQuestionsDialog.prototype.getRejectHandlerr   l1      MergeQuestionsDialog.prototype.getRejectHandler/<s     &l=(      MergeQuestionsDialog.prototype.createDomt  s0nc      DraftPost.prototype.getUrlu    I9      DraftPost.prototype.shouldSavev    T      DraftPost.prototype.getDataw   l      DraftPost.prototype.backupDatax    $$      DraftPost.prototype.showNotificationy  )r"      DraftPost.prototype.getSaveHandlerz    IL6$      DraftPost.prototype.getSaveHandler/<|  x      DraftPost.prototype.decorate}  pz2      DraftPost.prototype.decorate/window.onbeforeunload~          DraftQuestion.prototype.getUrl    IQ"      DraftQuestion.prototype.shouldSave    i      DraftQuestion.prototype.getData   _'-      DraftQuestion.prototype.assignContentElements     d!      DraftAnswer.prototype.setThreadId     kH      DraftAnswer.prototype.getUrl  :i%       DraftAnswer.prototype.shouldSave        DraftAnswer.prototype.getData     @0++      DraftAnswer.prototype.assignContentElements   $      CommentVoteButton.prototype.setScore  :8I$      CommentVoteButton.prototype.setVoted  *      CommentVoteButton.prototype.getVoteHandler    ),      CommentVoteButton.prototype.getVoteHandler/<  d'7$      CommentVoteButton.prototype.decorate  I*&      CommentVoteButton.prototype.decorate/<    %/%      CommentVoteButton.prototype.createDom           Vote<     ]+      bindEvents/<  w      callback_offensive/<  ]O      callback_remove_offensive/<   u      callback_remove_all_offensive/<   M)      questionRetagger<     y_      drawNewTags/<     G!      setupInputEventHandlers/<           createRetagForm/<     Y*      getTagsAsString/<     HX      setupClickAndEnterHandler/<   xz       VoteControls.prototype.setPostId  *        VoteControls.prototype.getPostId  \U&      VoteControls.prototype.setPostAuthorId     m      VoteControls.prototype.setSlug    	xD"      VoteControls.prototype.setPostType    K"      VoteControls.prototype.getPostType    UD!      VoteControls.prototype.clearVotes     /#      VoteControls.prototype.toggleButton   !      VoteControls.prototype.toggleVote     #      VoteControls.prototype.setVoteCount   D^$      VoteControls.prototype.updateDisplay  gM*      VoteControls.prototype.getAnonymousMessage    Gd#%      VoteControls.prototype.getVoteHandler     5U7'      VoteControls.prototype.getVoteHandler/<   ~      VoteControls.prototype.decorate   I/"      DeletePostLink.prototype.setPostId    !"      DeletePostLink.prototype.getPostId    j-'      DeletePostLink.prototype.getPostElement   S1&      DeletePostLink.prototype.isPostDeleted    BL'      DeletePostLink.prototype.setPostDeleted   X)      DeletePostLink.prototype.getDeleteHandler     F+      DeletePostLink.prototype.getDeleteHandler/<   ,!      DeletePostLink.prototype.decorate     V      SimpleEditor.prototype.focus  
	-%      SimpleEditor.prototype.putCursorAtEnd     M      SimpleEditor.prototype.start  U#      SimpleEditor.prototype.setHighlight   L{&      SimpleEditor.prototype.setTextareaName    yr      SimpleEditor.prototype.getText          SimpleEditor.prototype.getHtml          SimpleEditor.prototype.setText    a%+      SimpleEditor.prototype.getAutoResizeHandler   5B-      SimpleEditor.prototype.getAutoResizeHandler/<     v%      SimpleEditor.prototype.setMirrorStyle            SimpleEditor.prototype.createDom  "e%      WMDExpanderToggle.prototype.getEditor     1)?6      WMDExpanderToggle.prototype.setPreviewerCollapsedClass    %      WMDExpanderToggle.prototype.createDom     M'      WMDExpanderToggle.prototype.createDom/<   )      WMD.prototype.setEnabledButtons   O	o!      WMD.prototype.setPreviewerEnabled     }!      WMD.prototype.getPreviewerEnabled     !      WMD.prototype.getPreviewerElement     8      WMD.prototype.getEditorElement    PR      WMD.prototype.createDom         WMD.prototype.decorate    '*      WMD.prototype.start   w!      TinyMCE.prototype.setTextareaName     X      TinyMCE.onInitHook    Z      TinyMCE.onInitHook/<  :      TinyMCE.onChangeHook  )#      TinyMCE.prototype.setEnabledButtons   7      TinyMCE.prototype.start   OO%      TinyMCE.prototype.setPreviewerEnabled     J      TinyMCE.prototype.setHighlight    D6       TinyMCE.prototype.putCursorAtEnd        TinyMCE.prototype.focus   8      TinyMCE.prototype.focus/<     KC	      TinyMCE.prototype.setId         TinyMCE.prototype.setText     Ao      TinyMCE.prototype.getText           TinyMCE.prototype.isLoaded    p4A7      TinyMCE.prototype.createDom   2      TinyMCE.prototype.decorate          EditCommentForm.prototype.hide    1      EditCommentForm.prototype.show    W#      EditCommentForm.prototype.getEditor   '      EditCommentForm.prototype.getEditorType   ,      EditCommentForm.prototype.startTinyMCEEditor  K#(      EditCommentForm.prototype.startWMDEditor  +      EditCommentForm.prototype.startSimpleEditor   H%      EditCommentForm.prototype.startEditor     #t
+      EditCommentForm.prototype.getCommentsWidget   [6"      EditCommentForm.prototype.attachTo    g+      EditCommentForm.prototype.getCounterUpdater   U-      EditCommentForm.prototype.getCommentTruncator     )k/      EditCommentForm.prototype.getCommentTruncator/<   ,n#      EditCommentForm.prototype.canCancel   Y*      EditCommentForm.prototype.getCancelHandler    ,      EditCommentForm.prototype.getCancelHandler/<  z|       EditCommentForm.prototype.detach  *#      EditCommentForm.prototype.createDom   #      EditCommentForm.prototype.isEnabled   *{$      EditCommentForm.prototype.enableForm  %      EditCommentForm.prototype.disableForm     nP      EditCommentForm.prototype.reset   /jV(      EditCommentForm.prototype.confirmAbandon  >*      EditCommentForm.prototype.getSuppressEmail    h*      EditCommentForm.prototype.setSuppressEmail    p2-      EditCommentForm.prototype.updateUserPostsData     g/      EditCommentForm.prototype.updateUserPostsData/<   R(      EditCommentForm.prototype.getSaveHandler  ^*      EditCommentForm.prototype.getSaveHandler/<           Comment.prototype.getData     	p:      Comment.prototype.startEditing    $      Comment.prototype.decorate    EAAe       Comment.prototype.setDraftStatus  ;S!      Comment.prototype.isBlank     -EU~      Comment.prototype.getId   T(      Comment.prototype.hasContent  R      Comment.prototype.hasText	     C$      Comment.prototype.getContainerWidget
  'K      Comment.prototype.getParentType   .      Comment.prototype.getParentId     D      Comment.prototype.setContent  K      Comment.prototype.dispose           Comment.prototype.getElement  eFj      Comment.prototype.loadText    %3      Comment.prototype.getText     :X       Comment.prototype.getEditHandler  w"      Comment.prototype.getEditHandler/<    2$      Comment.prototype.getEditHandler/</<  te"      Comment.prototype.getDeleteHandler    &o$      Comment.prototype.getDeleteHandler/<  +l%      PostCommentsWidget.prototype.decorate     <+m'      PostCommentsWidget.prototype.decorate/<   N1      PostCommentsWidget.prototype.handleDeletedComment     \)v(      PostCommentsWidget.prototype.getPostType  &      PostCommentsWidget.prototype.getPostId    K2      PostCommentsWidget.prototype.getLoadCommentsButton     6x0      PostCommentsWidget.prototype.getOpenEditorButton!  ]1      PostCommentsWidget.prototype.hideOpenEditorButton"     .1      PostCommentsWidget.prototype.showOpenEditorButton#     ,      PostCommentsWidget.prototype.startNewComment$  /.9*      PostCommentsWidget.prototype.canAddComment%    <(      PostCommentsWidget.prototype.userCanPost&  0      PostCommentsWidget.prototype.getAllowEditHandler'  Z2      PostCommentsWidget.prototype.getAllowEditHandler/<(    Ii4      PostCommentsWidget.prototype.getAllowEditHandler/</<)  1      PostCommentsWidget.prototype.getOpenEditorHandler*     =3      PostCommentsWidget.prototype.getOpenEditorHandler/<+   o@h3      PostCommentsWidget.prototype.getLoadCommentsHandler,   X"5      PostCommentsWidget.prototype.getLoadCommentsHandler/<-     ";7      PostCommentsWidget.prototype.getLoadCommentsHandler/</<.   Ba.      PostCommentsWidget.prototype.reloadAllComments0    -      PostCommentsWidget.prototype.reRenderComments1     ##/      PostCommentsWidget.prototype.reRenderComments/<2         socialSharing<3    8%      TagWikiEditor.prototype.backupContent4     \N/      TagWikiEditor.prototype.setEnabledEditorButtons5   q$+      TagWikiEditor.prototype.setPreviewerEnabled6   -"      TagWikiEditor.prototype.setContent7    )>       TagWikiEditor.prototype.setState8  g&      TagWikiEditor.prototype.restoreContent9    oe(      TagWikiEditor.prototype.restoreContent/<:  i       TagWikiEditor.prototype.getTagId;  O&      TagWikiEditor.prototype.isEditorLoaded<    _ne'      TagWikiEditor.prototype.setEditorLoaded=   	)-      TagWikiEditor.prototype.startActivatingEditor?     U       TagWikiEditor.prototype.saveDataA  z="      TagWikiEditor.prototype.cancelEditB    F       TagWikiEditor.prototype.decorateC  @"      TagWikiEditor.prototype.decorate/<D    -s&      ImageChanger.prototype.setImageElementE    [S"      ImageChanger.prototype.setMessagesF    |N&      ImageChanger.prototype.setDeleteButtonG    gt!      ImageChanger.prototype.setSaveUrlH     &#      ImageChanger.prototype.setDeleteUrlI   "      ImageChanger.prototype.setAjaxDataJ    >       ImageChanger.prototype.showImageK  <"      ImageChanger.prototype.deleteImageM    #      ImageChanger.prototype.saveImageUrlO   )DO"      ImageChanger.prototype.startDialogP    :$      ImageChanger.prototype.startDialog/<Q  /'      ImageChanger.prototype.showDeleteButtonR   y'      ImageChanger.prototype.hideDeleteButtonS   \vj$      ImageChanger.prototype.startDeletingT  _?W      ImageChanger.prototype.decorateU   !      ImageChanger.prototype.decorate/<V     MCa6      UserGroupProfileEditor.prototype.toggleEmailModerationX    $W)      UserGroupProfileEditor.prototype.decorateY     2[%      GroupJoinButton.prototype.getPostDataZ     8$      GroupJoinButton.prototype.getHandler[  1&      GroupJoinButton.prototype.getHandler/<]    ""      GroupJoinButton.prototype.decorate^    ?:#      TagEditor.prototype.getSelectedTags_   #      TagEditor.prototype.setSelectedTags`   ({"      TagEditor.prototype.addSelectedTaga    ~j%      TagEditor.prototype.isSelectedTagNameb     wg(%      TagEditor.prototype.removeSelectedTagc     "e["'      TagEditor.prototype.getTagDeleteHandlerd   z)      TagEditor.prototype.getTagDeleteHandler/<e     ?      TagEditor.prototype.cleanTagf  R      TagEditor.prototype.addTagg    k.      TagEditor.prototype.immediateClearErrorMessageh    )6%      TagEditor.prototype.clearErrorMessagei     w'      TagEditor.prototype.clearErrorMessage/<j   !1Y{#      TagEditor.prototype.setErrorMessagek   e(a$      TagEditor.prototype.getAddTagHandlerl  &      TagEditor.prototype.getAddTagHandler/<m    U(      TagEditor.prototype.getAddTagHandler/</<n  }%      TagEditor.prototype.getRawNewTagValueo     {<k$      TagEditor.prototype.clearNewTagInputp  }}{      TagEditor.prototype.editLastTagq   #      TagEditor.prototype.setHotBackspacer   +e#      TagEditor.prototype.hasHotBackspaces   2Ap$      TagEditor.prototype.completeTagInputt  ?      TagEditor.prototype.saveHeightu    e      TagEditor.prototype.fixHeightv     +kT&      TagEditor.prototype.closeAutoCompleterw    n)      TagEditor.prototype.getTagInputKeyHandlerx     !+      TagEditor.prototype.getTagInputKeyHandler/<z   >5      TagEditor.prototype.getTagInputKeyHandler/</success/<{     W      TagEditor.prototype.decorate|  1      TagEditor.prototype.decorate/<~    tr"      Category.prototype.setCategoryTree    }6Xy"      Category.prototype.getCategoryTree    h      Category.prototype.getName    ^ig      Category.prototype.getPath    ^      Category.prototype.setState   #      Category.prototype.hideEditControls   ufq#      Category.prototype.showEditControls   A%      Category.prototype.showEditControls/<     j&      Category.prototype.showEditControlsNow    \dF      Category.prototype.hideContent    S      Category.prototype.showContent    +9      Category.prototype.showEditor     L      Category.prototype.hideEditor     YO      Category.prototype.getInput   )q&#      Category.prototype.getDeleteHandler   ee%      Category.prototype.getDeleteHandler/<     J.!      Category.prototype.getSaveHandler     t#      Category.prototype.getSaveHandler/<   {      Category.prototype.addControls    y-      Category.prototype.addControls/cancel_button<     K+      Category.prototype.addControls/edit_button<   	@"      Category.prototype.getOriginalName    R      Category.prototype.createDom  
JI      Category.prototype.decorate   X_'      CategoryAdder.prototype.setCategoryTree   OA       CategoryAdder.prototype.setLevel  X       CategoryAdder.prototype.setState  ()      CategoryAdder.prototype.cleanCategoryName     )J      CategoryAdder.prototype.getPath   s'r$      CategoryAdder.prototype.getSelectBox  B6#      CategoryAdder.prototype.startAdding   !      CategoryAdder.prototype.createDom     I	#      CategoryAdder.prototype.createDom/<   q$      CategorySelectBox.prototype.setState  -Z&      CategorySelectBox.prototype.setState/<    #+      CategorySelectBox.prototype.setCategoryTree   
+      CategorySelectBox.prototype.getCategoryTree   \$      CategorySelectBox.prototype.setLevel  $      CategorySelectBox.prototype.getNames  ^?-&      CategorySelectBox.prototype.getNames/<    j1/      CategorySelectBox.prototype.appendCategoryAdder   yg*%      CategorySelectBox.prototype.createDom     {?E$      CategorySelectBox.prototype.decorate  i2      CategoryEditorToggle.prototype.setCategorySelector    2      CategoryEditorToggle.prototype.getCategorySelector    '      CategoryEditorToggle.prototype.decorate   %+0      CategoryEditorToggle.prototype.getDefaultHandler  }yt2      CategoryEditorToggle.prototype.getDefaultHandler/<    7I%      CategorySelector/this._select_handler     /M#      CategorySelector.prototype.setState   %      CategorySelector.prototype.setState/<     ;4(      CategorySelector.prototype.getPathToItem  F+      CategorySelector.prototype.applyToDataItems   Y>      CategorySelector.prototype.applyToDataItems/applyToDataItems/<     9"      CategorySelector.prototype.setData    B.      CategorySelector.prototype.clearCategoryLevels    H'      CategorySelector.prototype.getLeafItems   0      CategorySelector.prototype.populateCategoryLevel  }2      CategorySelector.prototype.populateCategoryLevel/<    =T%      CategorySelector.prototype.selectPath     '      CategorySelector.prototype.getSelectBox   Iw*      CategorySelector.prototype.getSelectedPath    +      CategorySelector.prototype.setSelectHandler   \'k3      CategorySelector.prototype.getSelectHandlerInternal   /c)      CategorySelector.prototype.setCurrentPath     0m)      CategorySelector.prototype.getCurrentPath     "MB*      CategorySelector.prototype.getEditorToggle    +      CategorySelector.prototype.getSelectHandler   l|-      CategorySelector.prototype.getSelectHandler/<     :Y#      CategorySelector.prototype.decorate   Os4      CategorySelectorLoader.prototype.setCategorySelector  ~6v*      CategorySelectorLoader.prototype.setLoaded    L-)      CategorySelectorLoader.prototype.isLoaded     ]*      CategorySelectorLoader.prototype.setEditor    {X,      CategorySelectorLoader.prototype.closeEditor  +      CategorySelectorLoader.prototype.openEditor   4&1      CategorySelectorLoader.prototype.addEditorButtons     :'1      CategorySelectorLoader.prototype.getOnLoadHandler     ^03      CategorySelectorLoader.prototype.getOnLoadHandler/<   ?s1      CategorySelectorLoader.prototype.startLoadingHTML     po0      CategorySelectorLoader.prototype.getRetagHandler  #u2      CategorySelectorLoader.prototype.getRetagHandler/<    U ,      CategorySelectorLoader.prototype.drawNewTags  L.      CategorySelectorLoader.prototype.drawNewTags/<    e6\/      CategorySelectorLoader.prototype.getSaveHandler   1      CategorySelectorLoader.prototype.getSaveHandler/<     $c1      CategorySelectorLoader.prototype.getCancelHandler     3      CategorySelectorLoader.prototype.getCancelHandler/<   @)      CategorySelectorLoader.prototype.decorate     ]      AskButton/this._handler   {@       Editable.prototype.backupContent  25@*      Editable.prototype.setEnabledEditorButtons    )u^&      Editable.prototype.setPreviewerEnabled    =!So      Editable.prototype.setContent           Editable.prototype.setState   e!      Editable.prototype.restoreContent     #      Editable.prototype.restoreContent/<   #j!      Editable.prototype.isEditorLoaded     2"      Editable.prototype.setEditorLoaded    9T      Editable.prototype.getObjectId    wC#      Editable.prototype.getAttributeName   a#      Editable.prototype.startEditingText   9(      Editable.prototype.startActivatingEditor  (1      Editable.prototype.setError   #r      Editable.prototype.clearError     k      Editable.prototype.cancelEdit     B      Editable.prototype.saveText   `      Editable.prototype.decorate   E_      Editable.prototype.decorate/<     p      Form.prototype.fieldHasErrors           Form.prototype.formHasErrors  ~      Form.prototype.validateForm   nt'      Form.prototype.getFormValidationHandler   n)      Form.prototype.getFormValidationHandler/<           Form.prototype.setFieldError  ~Y      Form.prototype.clearFieldError    	h      Form.prototype.validateField  Nc      Form.prototype.decorateField         Form.prototype.decorateField/<    %      Form.prototype.decorate   `       FoldedEditor.prototype.getEditor  o('      FoldedEditor.prototype.getEditorInputId   u])      FoldedEditor.prototype.onAfterOpenHandler     [N+      FoldedEditor.prototype.onAfterOpenHandler/<   v@%      FoldedEditor.prototype.getOpenHandler     Z%'      FoldedEditor.prototype.getOpenHandler/<   af)      FoldedEditor.prototype.decorate	   Yh`(      AnswerForm.prototype.getAfterOpenHandler
  =*      AnswerForm.prototype.getAfterOpenHandler/<    g      AnswerForm.prototype.decorate        ,      -      !  %,                                                                                                                                                       C                 D                 E                 F                 G                H                I                J                K                L                                                                                                                                                       	                                                                                                    
                                                                            $                %                %                %                 (                 $                 $                $                                                    .           !      /           "      0           #              	   $      2          +      3           ,      3           -      2           .      2           /      2           0      2          1      9           2      2           %      2           &      2          '      =           (      >           )      2           *      2          3      A           4      2           5      C           6                 7      E           ;      E          8      G           9      E           :      E          <      J           =      E           >                 ?      M           @      M           A      O           B      O           C      M           D      M           E      M          F      T           G      M           H      V           I                 J      X           K      X          L      Z           M      X          N      \           O      X          P      ^           Q      X           R      `           S                 T      b           U      b           V      b           W      b          X      f           Y      b          Z      h           [      b           \      b           ]      b          ^      l          _      m           `      m           a      b           b      b           c      b           d      b           e      b           f      b           g      b           h      b           i      b           j      b           k      b          l      z           m                 n      |           o      |           p      |           q      |           r      |           s      |          t                 u                 v                 w                x                 y                z                 {                 |                 }                 ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            	         
                
                
                              
                                                                                                                                            	               
                                                                                                                                                         "               "               "               "                                                                                                        ,               ,                ,          !     ,          "              #     1          $     1          %     1          &     1          '     1          (     1          )     1          *     1          +     1          ,     1          -     1          .     <          /     <          0     <          1     1          2     1          3              4     B          5     B          6     B         7     E          8     B          9     B         :     H          ;     H          <     H          =     H          >     H          ?     B          @     N          A     N          B     N          C     N          D     N          E     N          F     N          G     B         H     V          I     V          J     V          K     V          L     B         M     [          N     B          O     B          P     B          Q     B          R              S     a          T     a          U     a          V     a          W     a          X     a          Y               Z              [     i          \     i          ]     i          ^     i          _               `               a               b               c     q          d               e               f               g              h     v          i              j     x          k     x          l              m     {          n               o               p              q               r              s               t               u               v               w               x               y               z               {               |               }              ~                                                                                                                                                                                                                                         	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          	               
                                                                                                             !                               #              $               $               $               '               $               )               #      	        +               #               #              .               .                #          !     #      	   "     2          #     2         $     4          %     #          &     #          '     #          (     8               #          )     #      	   *     ;          +     ;          ,                 -                .     ?          /                 0                 1                 2                 3                 4                 5                 6                 7                8     I          9     I          :                 ;                 <                 =                 >                ?     P          @                A     R          B                M     T          N                 O                 P                 Q                 R                 S     Z          T     Z          U     Z          V     Z          W                 X                 Y                 Z                [     b          \                ]     d          ^     d          _                 `                 a                b     i          c     j          d                 e                 f                 g                 h                 i                 j                 k                l     s         m     t          n     t          o                 p                 q                r     y          s                t     {          u                 v                 w                 x                 y                 z                 {                 |                }              ~                                                                                                                                                                                                                                                                                                                                                                                                                                      ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               	                
                                                                                                                                                                                                                                                                                                                                                                  &                            !                 "                 #                 $                 %                 &                '     .          (                 )                 *                 +                 ,                 -                 .                 /                 0                 1                 2                 3                 4                 5                 6                 7                 8                9     @          :                ;     B          <                =     D          >                 ?                @     G          A                 B                 C                 D                 E                 F                 G                 H                 I                 J                K     R          L                M     T         N     U          O     U          P                 Q                 R                 S                 T                 U                 V                 W                 X                 Y                 Z                 [                 \                 ]                 ^                 _                `     g          a     g          b                 c                d     k          e     l          f                g     n          h     o          i     o          j                 k                l     s          m                 n                 o                 p                 q                 r                 s                 t                 u                 v                 w                x               y               z                {               |                }               ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                	                 
                                                                                                                                                                                                                                                            &                                (                               *                               ,                           !     .          "     /          #                $     1          %                 &                 '                (     5          )                 *                 +                 ,                 -                 .                 /                 0                 1                2     ?          3                 4                 5                 6                 7                 8                 9                 :                 ;                 <                =     J          >                ?     L          @                A     N          B                C     P          D                E     R          F     S          G     S          H                I     V          J                 K                 L     Y          M                N     [          O     [          P     [         Q     ^          R     _          S     [          T     [          U                 V                 W                 X                 Y                 Z                 [                \     i          ]                 ^                 _                 `                 a                b     o          c                d     q          e                 f                 g                 h                i     v               v          j                k     y          l     y          m     y          n                 o     }          p                 q                 r                 s                 t                u               v                 w                 x                 y                               z               {                 |                 }                 ~                                                                                                                                                                      Oc5   5   5     P^ P P P	 P  P  P	 P
 P< P
 PP
 P P ) P1
 P d   P P Pq ` P
 Pr P P[ P P P P P
 P  P P# P   Py P'	 P P P	 P P P P P Pp
 P P/ P            +      P  P  P              l                 l                 l                 l                     y                   e               n                                q               q              q             q    P P              n               n                y  n                       
            $ `   P  P  P  P    P  P  P  P             e              e                    e               e                l                   l                )  P            o  +  P1  P8  Pl               2  3  4              9  2  P>                l               ?  @  A  PC  l                                                  l               d  b  a  c              g  b  e  a  d  c  f  	            k `a  b `i  h `j  c `f `d `            l  p `m  n           o           o                           q                           g                               r ` `  P  `l  `             $ `                                                                 $ `  P  P  P  P  P~  `                Pw  Pl                                                 l               .        l                 l                   Pl                e                +  l                 l                   Pl                                               e    l                 Pl                     +  l                               e          l                $ `  P  P  P                            n     Pl                               e          l                 Pl                     l                                $ `  P            n   +        l                 l                   l                               (        i  l                 i  l                 Pl                     +  l                                   l                $ `  P            n   l                   P     P  l                               n  ` .  P P  P)                                Pl                     l                               e  l                $ ` P            n   +  l                 n   +    l               +  l               e   Pl                               e   Pl                                   ! " # $ % Y l                   l                     P4 l                  w  P                                               l                 l               ! l                 5  o  l                 l                 l                 l                 l                 l                 l                 Pl                     +  l                $ `@ P            n   +  l                   5   l                 l                    o  l                 l                 Pl                     +  l                $ `H PJ P             l               e        PK l                                 Pl                     l                                $ `N P            n   +  l                `d `  P  5  l                                   l                 Pl                     +  l                               e  Y              $ `\ P            n   +  l                 _ l                 ^ ` b d l                 ^ l                 ^ l                 g Ph P  P  l                                 l                 Pl                     +  l                               e          l                $ `k P            n   +  l                 l               " P r s   Pl                                 l                 l                 l   	             `)   Px Py z P{   Pl                                                 Pl                     +  l                               e        +  l                $ ` P            n   +  l                 5  l                 " l                 l               j    P q  l                              l                    l                l                 Y                 Pl                i               j  i  )  l               j  i  v l                 l               e  l               e  l               e    Pl                               e  l               e  l                 Pl                     +  l                               e    l                   P P P P             x               x                                                P Pl               7                    l                l                l                  l                l   ,               P Pz PK P P P P Pl   N P P P P P P P6 P P P P P P P P P Pr  PD Pp P P0 Pt  P Py P P P P P Pv P P P             7                                 7                               7                 7              7                              7                        
   5 s               7               7                        
   5 s               7                              !                 %             7  ) P+                - . s                  5 - . s              8 . ) P:  > P                 ? @ B              7                 I J              7               7                   c               7               7               7                               ` 	            7   d e f   i  h l P                            7               7  
             { | } ~  i   P                            7                               7                              7               7   P Pv `             Y  H                ` P             Y  H              7                                  7               t                  P P P P P P P                                
                 Y    P  P             Y                                               l                  l                               7  P Pl                   !              &  P P P P* P P" PR  P P P P P
 P P$  P P P P` P P P# P P P  ` P(  P P  P              l                9               9  j  ;              9  j  ;              7               ` A R                 E F 9              7  PJ PK PL PM PN P  `O P;  `Y g P             P             R 7                c               n q | ~   P  P                                +  l                 R                                             9   s               9               9                                  .  Pp P P P P P P P P l                                                                                 .  P P P P ` P P2  P P P P P P P P l                                                                                                                                             j   B               j  B                              j                                                                               P P-  P  Z P P P P P P P PF PO P l                               O              O  ` P                                              O   P  P              l                 l                                 l                                 ,       
       $ ' , 0 5 : = A                                                                                         @              @               , J N P                             B  K              B                   l                  7  P.                                                                                                Q P Pl                 l                                 U : V W  l                 l                               l                               a b c P l                Y               Y               Y               Y                l               h i j k l l                u                                {                               	                                  7   P               }  5 	               P P P  P                              }                 P P PK              }                                               P P                               P P Pw  P P P P P P P P P P P P P P l                 ;               s                7                                                                                                                          7   P  P                                                                            P                 7                                                             P                                                          P                                  P    P P P	 P  P  P                             
              _               
              
                " #                                               + /             ,               $ `            +  4 Pl                                 l               j  ;                               A P4 Pl                 l               C s `  Pl                     
             F n    G H PK P  Q l                                  a               a               a              +  q l                `W                      l                i  n              n   l               n   l               n   l               n   l                n   \ ]              n   \ ]                               `E P  l               j  4  l                 P                  $                                l                 i   l               n   s  l               |  `$  l                n                 l                 l                L   i                l                 l                 l                 l            e                d Pl                n                4 P Pl                 l                                l                 l                 l               n   l               n   E   s  l            e              n       l               $    m  l                 i                 n     l               n       l                l                 i  y   l                 l                 l                 l               n        l               n   $ `l                 l               n   l                n               $ `q Pl                   n                 n   l               Q n   l                Q n                Q n                Q n               n   l               n   l               n   A l               n   l               G E l               n   E P               l               n   E                 n                 n   E 4              E Pn  `             5                                l                 l                   P              l                $                    n   Q 5  l                `n  `Q  P4 P  l                A k |                   n   Q l                 n   Q l                 n   Q    l                 n   Q l                 n   Q l                 n   Q l                 n   l                 n   l                 n   l                 n   l                 n   l                 n   l                 n      n   l                 n   Q l                 n  `Q                                $ ` P P                 l                $ `              P  ` P            e  l                 l                 l               e     l                 P   Pl               j                     L `M `B `x `u  D `k  C `E `v  w  F  G  H  I  J  K  N `O  A `            a  m `e `h `y  t `s `l  p  d  g  r `n              a  f  b               a              a  f  b  o  c  i  j  d               a  f              a  f  b  d  c  i  j               a  	            a  m `e `h `y `t `s `l  p `            a  g               a  m  e  h               a `m `e `h `y `t `            a  l  p  d  g  r  n  z  f  b  o  c  i  j  k                e  l  p  d  g  r  n  k              a  m  e  h              a  m  e `h `k `t `s `l  p `d `g  r  n  z              a  b  d  c              a  b `e              a  d  e  f  g  h              a  m  e  h               a  m              a  m  e  h  k  t  s  l  p  d  g  r  n  z  f  b  o  c  i  j  u  v  x           w              a  m  e  h              a `m `e  h `k  t  s  l `p `d `g `              e  n  k  f  b  o  c  i                                l                 n  ` l                                 l                 n   l                 n    l                 l               7    l               J l                 7  l                 n   J l               n   J `l                                              l                l                l                 l                 `l                                  P              l                   P                                              7              7               7                                                                                                  l               7  l                 l                 `*   l                              n   M P8 `l                                                 l                 l                 `l                                                i   l                 l                 i  l                 l                 l                 l               Y l                 `l                 [ \ P                                           ` l                 l                 `l                                `l                                         / 5  g W  i j l                 l                                                                 l                 {               `l                 P                           n   `l                                l                                   l                 l                 l                 l                l                                 l                 l                 l                l                l                l                 ` Pl                  P                              n  ` l                                                 l               ?     L    <               P ( P P P P P P P P P  P P P P  Pp P P P P PC P P P
 P P P P PF P P P P P P P P P P P P  P$ P P  P3 P P P P P P6 P P P P= P P P                                                                                                                                                                                                                                                                                                   j               j               j               j               j              j  l               j  l               j  l               j  l               j  l               j  l               j  l               j  l               j  l                 ` P.  P                            % &                    0                                    :             j  l               j  l                    > :             j  l               j  l                    D             j  l               j  l                                  L M N O                                                                                               X                \ P] P^ P_ P` Pa Pe Pj Pp Pq P P P P P Pd P                                            f h                $   R                                             % n                              e               e              r Z w              e                 P                n                                                 r               n   .  P             e                                                l               p l                 l               O l                l               W l                 l                 l                O              l               L   l                  l                  l                P`l                                                                n     l                 l                l                 l                 l                 l                A l                 ` l                                              n   l                l                l                 l                 l                l               $  l                 l                 l               7  l                    P P P`l               ?  7                        l                     l               1 l                 l                 l                 1 `l               ?                                   l                l                l                 l                 l                 l                 h   1     l               n   l                 l               	 	 l               $  l                  `                             1                                 	 l                                                  	 	              P	 P	 P	 P 	 P!	 Pl                 #	 $	              l               7  l                                 l                 &	    l               n   l                 l                 l                 l                 l                                 	  1 l                 1 l                 l                 ) 1 @	 A	 C	 E	 H	 l                 l                  ` l                                 V	 P1 P l                 X	    Y	 [	 \	 ^	 `	               `l                 1 7  h	               j	 l                 `l               ?  l	               l                 Z }	    l                 l                 l                 l                 l                  l                 l               	 l                    P                             `1 Pl                 	   	 7  	 	 P	                             % n             l	   l                 l                 q l               n   	 	   	 	 	 	 	 	  l                	               l                 l                 l                 l                 l                 l                 l   
   	            	 	 	 E 	 	 	 l                 l                 l               	 P`l                               % n 	               l                 `l                                                  P	 Pl                                 n % l	              % n 	               l               n   
 P`l                  n                  l                 l                 l                 l                 l                 l                 l                  	
 l                 l                   l                 `l                                              O P`l                                 `l                                              .  P	 `l                                `l                i               i    	
                
 P 
 P:  P!
 P            "
   W               &
 (
  ` W .
                                                                               l                 l                l                 l                 l                 l                 >
 Pl                 n                 l                 l                 l                 1 P`  l                                `7    l                                l               n   J
 L
 N
 `1 l                                                                 l               V
 l               J l               X
 l                 l                 l                 l               ^
 l                 ``
   l                              ^
 `  b
 l                                `d
 Pf
 Pl                ^
               l                 l                 o
 l               n   `l                                                 l                 Z Ps
 l                              n   w
 z
 
 
 Z 
 
 
 
 
 
 
 
 l                 l                 l                 `l                                  
             9  l                 l                 l               
 l               
 
 l               
 
 l               
 
  l                P`l                 R             
 
 
 
 l               
  R l                 l                 `l                               7  
 l                 `l               
 
          y                                l                 l                 L  
 l               
 l                 l               
 
 l            y                                                l                 f `l               e   7  
                                         y           y              n   `
 P
 l                9                              e                l               
 l                 l                 l                 l                 l                 l                 
 P Pl                                                 l                 l                 l                 l                 l                 l                 `l                  
 P                             ` Pl                  P                          y                  `	 
 X
 l                                 
               l                 l               n   l                 l               
 l                l                 l               $  l                 
 l                 l                 $   `
 P l            y                               k      	 `l                                                                 l                 l                                             
 l                                l                 % Pl                                ' l                 l               n   l                 l               + l                 l               n   l                 `l                 1               l                                `l                                4 Pl               
  i  5 
              P6 Pl                
                              
 P7 l                8              i  l               <   i  l               >    P l                 ? @ A             
 i  E F l                l               J 
 i     l                l                 l               
 l                 l                 l                P`l               S 
 T             n   U W Y [ \ l                 l               + l               a l                 l               1 l                 l                 + l                 l                 `l                 1               n P`l                                `l                               f  P`l                  $  R                `l                 ]               f              %               `l                               n   l                 l                ?                    P           A P                n   
              n   	                Z P                                                                           l                 l                l                 l                 l                 l                 >
 Pl                 n                 l                 l                 l                 l               7  P` l                               ?  1 ` Pl                              7  l                 l                 l                 `     Pl            e                             n    1      &	 )  /    `l                ?                                                               
               l                l                  i   l                  i  l                 `l                                 y  l                y  l                   4 5  l            y               Pn   4 y     `l                               n    i   l                 l                 l                 l                 1 Pl                 l                 &	 P P`l                 n               n   ) 1   l                 l                 n  ``l                               n   &	   l   0                                         8     8                       ~                                 "                                                                          	                    >     <     "                  $    ,    /    1     4    /    *     9     A     C     E     *    H            *     O    P    Q    R    	    &     <     >     W    Y    [    \    *        ]    _    a    *            C    g     i     Q    g    m    n    o    q                    *                                                                                               B     C              C     G          ^    ^    ^    e     f     m     n     o     n     o     1     C                                                                             &     <                                                                                            ^                             ^                    ^                        ^         `      `                              E          7                        .     ^                                      !     D     D     D                           D                                          ,     
                                     E                #     %     (     ,     -     .     /     0     1     4     8    ;    =     @    A     B    C    E     G          K     Q     T     ^    a     i     c     e     f     g     h     i     j    l    n    p    =     w     x    z    |     }     ~                                                                     I$KE           h  g  {  x  y  	   -    1 E J ^ \ /  g  8                    
   x  y                  2  7    -          -  .  /  0           G  Y  d  z                                               G                                          
      G                   G                  H          G          
         
          Z    G         (    & , 2 ' : < = >              
   k               
              T  V  *    
   T  V     
    T  V     
    T  V     
    T  V             
   T  V     
    /      #    )    % k  5 9                  G   ( & B '                %   9    
   G   ;                 G   P         T            #    G   ^     e                            o X n )  v m    
    p n                    U      G   =           )  v                             
     T  V                                      
              
                                                                                                                  (     '        (    (          : A B E                               P         S T U            K        o J  `    N O M G L I      Z   J    E \ ] ^ @ _ ` r a b c i m  /  g                            U     P q s   v x   { }       !   )         q  n        A   @    |   e              h  j     l                                                       
     n                              
       O     
      n      
                             A   
   2   P s   v x     { }        P         s                   v         x                                     {         }                                                    U   P q     !   s   v x   { }                                        {    x                             
     #                             b  t  n  v  f  r     
    a  c     
    a  d                                  7 ) * " 2                7 ) * 5          7         7 ) * ' 5    
     7 *        7 ) "       7 ) "           7 ) " 2          7 ) " 2          7 * 2       7 ) *   2        g  i  h        g  h  i            P                                
                                                                          !           7  5       P       
      P     
    P          7  5       P       
      P     
    P                    7     
     P         7     
     P                        {    / x         .           / {      x     
    C E          / {    x  y     #      / {         x        5 7      
   7  .    
                 {    / x     K                         V         V         V         V    #       / {      y  x     
     p        ,    #          ! "             {    x  y                    z { | }         E J 8 \                   P                      P                 
     n     
         
         #      / {      y  x     
     p    
                 {    / x             (   R  T  i s /                   
                        
                    <       0	  2	 4	 5	 6	 8	 9	 :	 /                                7  	 	 	 	    
     	            {    x  y                               x  y                         x  y  {     
    	 	         	 	             x  {          
 
 
 
    
        W    
      W    
      W    
      W            
     C
 D
              / x          C
 D
 7          {      / x                  6	 8	 9	 :	            {      / x           {      / x           {  /     x         s
    
     s
 }
    
    s
 }
    
    s
 }
    
    s
 }
    
    s
 }
        s
    
     e
 n
        s
           {  /     x               {  / x         
    #       
 z { | }          {    /   x     
    
 
          
         {    /   x           {      / x     
    
     
    $             {      / x         o             {    x  y                    {      x              #       z { | }  
    #      z { | }     #      z { | }              / x            {      / x                  6	 8	 9	 :	                                                    &!!  3     3  s$                _          h    	   s h
    	   s 	   G   6   h   9   h   9   h   9   h   9   s h       G	   o h       G	   o h       G	   o h       G	   o h       G	   o h       G	   o h       G	   o h       G	   o h       G	   o h       G	   o h        G	   o h!       G	   o "   #      @   $   %   C      D   &   "   &      G   &   6'   &   J   h(    s  h)    s  *   h+   *   ,   h-   ,   ,   G.   h/   I0   ,   G.   h1   I2   3   3      Y   64   Z   3   3   h5   I6   3   67   I8   3   69   I:   3   7;   I<   =   G>   G?   @      j   3   GA   m   O   n   3   hB   IA   3   GA   s  3   G6   s  3   GC   GD   s  z   hE    	   s hF    	   s hG    	   s H   H      II   hJ    s  K   hL   K   M    K   N   s K   G.   hO   IP   K   G.   hQ   IR   K   G.   hS   IT   K   G.   hU   IV   K   G.   hW   IX   K   G.   hY   IZ   K   G.   h[   I\   K   G.   h]   I^   K   G.   h_   I`   K   G.   ha   Ib   c   hd   c   M    c   K   s c   G.   he   If   c   G.   hg   Ih   c   G.   hi   Ij   c   G.   hk   Il   m   6n   ho   9p   m   q   hr   q   s   ht   s   u   Gv   Gw   x   s   s u   Gv   Gw   y   q   s =   =   Gz         6{      Iz   =   Gz   h|   I}   =   Gz   h~   I   =   Gz   h   I      h    o        h      M       N   s    G.   h   I      G.   h   I      G.   h   I      G.   h   Ib      h      M          s    G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   I`      h      M          s    G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   Ib      h      M          s    G.   h   I      G.   h   I      G.   h   I      G.   h   I      h      M          s    G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   I      h      M       N   s    G.   h   I      G.   h   I      G.   h   I      G.   h   Ib      G.   h   I`      h         h    o        h    o        h      M          s    G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   Ib      h      M       N   s    G.   h   I      G.   h   I      G.   h   I      G.   h   I      G.   h   I     G.   h  I     G.   h  Ib     h    M         s   G.   h  I    G.   h	  I
    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  IZ     G.   h  I    G.   h  I    G.   h  I`     h    M      c   s   G.   h  I    G.   h  I     G.   h!  I`   "  h#  "  M    "    s "  G.   h$  I%  "  G.   h&  I'  "  G.   h(  I)  "  G.   h*  I+  "  G.   h,  I-  "  G.   h.  I`   "  G.   h/  Ib   "  G.   h0  I  1  h2  1  M    1     s 1  G.   h3  I  1  h4  I5  1  h6  I7  1  G.   h8  I%  1  G.   h9  I  1  G.   h:  I'  1  G.   h;  I  1  G.   h<  I
  1  G.   h=  I  1  G.   h>  I?  1  G.   h@  IZ   1  G.   hA  I  1  G.   1  G.   G  I  1  G.   hB  IC  1  G.   hD  I`   1  G.   hE  Ib   F  hG  F  M    F     s F  G.   hH  II  F  G.   hJ  I   F  G.   hK  I  F  G.   hL  IM  F  G.   hN  IO  F  G.   hP  IQ  F  G.   hR  IS  F  G.   hT  ID   F  G.   hU  IV  F  G.   hW  IX  F  G.   hY  IZ  F  G.   h[  I\  F  G.   h]  I^  F  G.   h_  I`  F  G.   ha  Ib  F  G.   hc  I`   F  G.   hd  Ie  F  G.   hf  Ig  F  G.   hh  Ii  F  G.   hj  Ik  F  G.   hl  Im  F  G.   hn  Io  F  G.   hp  Iq  F  G.   hr  Is  F  G.   ht  I   u  hv  u  M    u     s u  G.   hw  I   u  G.   hx  Iy  u  G.   hz  Ib   u  G.   h{  I|  u  G.   h}  I~  u  G.   h  I  u  G.   h  I  u  G.   h  I  u  G.   h  I  u  G.   h  I  u  G.   h  I  u  G.   h  I  u  G.   h  I  u  G.   h  I  u  G.   h  I  u  G.   h  I  u  G.   h  I  u  G.   h  I    h    M         s   G.   h  Ib     G.   h  I    G.   h  I     G.   h  I     G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    h   o      h    M         s   G.   h  I    G.   h  I    G.   h  I'    G.   h  I    G.   h  IV     G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  Ib     h    M         s   G.   h  I    G.   h  I\     G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  Ib     h    M        s   G.   h  I    G.   h  Ib     h    M        s   G.   h  I    G.   h  I    G.   h  Ib     h    M         s   G.   h  I    G.   h  I    G.   h  I     G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h	  I
    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I     G.   h!  I"    G.   h#  I$    G.   h%  I&    G.   h'  Ib   (  h)  (  M    (  *  s (  G.   h+  I,  (  G.   h-  I.  (  G.   h/  I0  (  G.   h1  I2  (  G.   h3  IV   (  G.   h4  I5  (  G.   h6  I7  (  G.   h8  I9  (  G.   h:  I;  (  G.   h<  I=  (  G.   h>  I?  (  G.   h@  IA  (  G.   hB  IC  (  G.   hD  I  (  G.   hE  I   (  G.   hF  IG  (  G.   hH  II  (  G.   hJ  I`   (  G.   hK  Ib   L  hM  L  M    L     s L  G.   hN  I,  L  G.   hO  IP  L  G.   hQ  IV   L  G.   hR  IS  L  G.   hT  I2  L  G.   hU  IV  L  G.   hW  IX  L  G.   hY  I`   Z  h[  Z  M    Z  \  s Z  G.   h]  IV   Z  G.   h^  I,  Z  G.   h_  I.  Z  G.   h`  IP  Z  G.   ha  Ib  Z  G.   hc  Id  Z  G.   he  I`   Z  G.   hf  Ib   g  hh  g  M    g    s g  G.   hi  Ij  g  G.   hk  Il  g  G.   hm  Ib   g  G.   hn  Io  p  hq  p  M    p  r  s p  G.   hs  IV   p  G.   ht  Iu  p  G.   hv  Iw  p  G.   hx  Iy  p  G.   hz  I{  p  G.   h|  I}  p  G.   h~  I  p  G.   h  I  p  G.   h  IV  p  G.   h  I  p  G.   h  I  p  G.   h  I  p  G.   h  I  p  G.   h  I  p  G.   h  I  p  G.   h  I  p  G.   h  Ib     h    M         s   G.   h  Ij    G.   h  I    G.   h  IC    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I     G.   h  I`    G.   h  Ib     h    M      N   s u      o G  h  s   h    M         s   G.   h  I    G.   h  I    G.   h  I'    G.   h  I    G.   h  IV     G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  Ib   h   s    h    M         s   G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  Ib     h    M         s   G.   h  I    G.   h  I    G.   h  I    G.   h  I    G.   h  Ib     h    M        s   G.   h  I    G.   h  Ib   E `P+  PD `P+ !PD `P * * |* *PDO@d`PF  *PE  `PF U*PE j`PF *PE `PF .*PE C`PF *PE `PF *PE `PF *PE 2`PF {*PE `PF *PE `PF i*PE ~`PF 
*PE `PF *P500 `P 0 `P00 `P@ N `PF  P40 `PF 
 P400%!`PK %`PK `P@ &`P@ 8%`P00`P@ `P0`P0`P00 `P 20 `P@  `P,
P4 `P,
P4 `P P9@  `P6% 4P$`P+ YP$`P+ P40%`P'`P< `PF < tP40%`PK H`P P40`P@ S`P0000`P@ \`P@ x`P@ `P@ `P0000`P0000`P@ `P@ %`PK `P P40`P@ `P0000`P0000`P@ %`PE  @ b%`PK l%`PK q`P P4`P P40`P00`P@ `P@ `P@ %`PF  PI %`P;000`P P40`P0000`P@ `P@ "`P@ 6%`PK ;`P P40`P@ B`P@ U`P@ e`P0000`P@ t`P0000`P0000`P0000`P0000`P@ `P0000`P0000`P@ `P@ `P@ %`P;00`P PD 
`P@ `P@ `P0000`P0000`P@ '`P@ =`P@ O%`P;00`P P40`P0000`P@ b`P@ j`P@ p%`P;00`P P40`P0000`P0000`P0000`P@ `P@ %`PK `P P4000`P@ `P@ `P@ `P@ `P@ %"`PK %`PF - P90%`PF  PI %`PK `P P40`P0000`P0000`P0000`P0000`P0000`P0000`P@ `P@ `P@ %`P0000`P@ 7`P@ >`P@ c`P@ n%`P;000`P P40`P0000`P0000`P0000`P0000`P@ `P@ `P@ %`PK `P P40`P@ `P0000`P0000`P@ `P@ `P0000`P0000`P@ `P@ `P@ `P@ 6%`PK ?`P P40`P0000`P@ N`P@ d%
`PK k`P P4000`P0000`P@ `P0000`P0000`P0000`P@ `P@ `P@ %`PK `P P40`P@ `P@ `P@ `P00`P@  `P0`P00`P@  `P@  1`P0000`P@  <`P0000`P00`P0000`P@  T`P@  `%`PK  h`P P40`P0000`P0000`P0000`P@  ~`P@  `P@  `P@  `P@  `P@  `P@  `P@ !(`P@ !8`P@ !I`P@ !W`P@ !k`P@ !`P0000`P@ !`P@ !`P@ !`P@ !`P0000`P0000`P@ !`P@ "'%`PK ";`P P40`P0000`P@ "M`P@ "`P@ "`P0000`P0000`P@ "`P0000`P0000`P0000`P@ "`P@ #
`P@ #$`P@ #,`P@ #@`P@ #I`P@ #T`P@ #p%`P;000`P P40`P@ #`P@ #`P0000`P0000`P0000`P0000`P@ #`P@ #`P@ #`P0000`P@ #`P@ #`P@ $`P@ $`P@ $&`P@ $9%`PF $ PI $%`PK $`P P40`P0000`P0000`P@ $`P@ $`P@ $`P@ $`P0000`P0000`P@ $`P@ $`P@ %	`P@ %`P@ %>%`PK %F`P P40`P0000`P0000`P0000`P0000`P0000`P0000`P@ %e`P@ %z`P@ %`P@ %`P@ %`P@ %`P@ %`P@ %%`P;00`P P40`P@ %`P@ &)%`P;00`P P40`P0000`P@ &J`P@ &O%`PK &T`P P40`P0000`P0000`P@ &d`P@ &i`P@ &r`P@ &`P@ &`P@ &`P@ &`P@ &`P@ &`P@ &`P0000`P0000`P@ &`P0000`P0000`P@ '`P@ '`P@ '`P0000`P@ 'm`P@ '%`PK '`P P40`P0000`P0000`P0000`P0000`P@ '`P@ '`P@ '`P@ '`P0000`P0000`P@ '`P@ '`P0000`P@ ( `P@ (D`P@ (u`P0000`P@ (`P@ (%`PK (`P P40`P0000`P0000`P@ (`P@ (`P@ (`P0000`P@ (`P@ )1%`PK )8`P P40`P@ )K`P0000`P000`P0000`P@ )^`P@ )f`P@ )m`P@ )y%`P;00`P P40`P0000`P0000`P0000`P@ )%`PK )`P PD )`P@ )`P@ )`P@ )`P@ )`P@ )`P@ )`P@ *`P@ *`P0000`P@ *+`P0000`P0000`P@ *8`P0000`P@ *I`P@ *``P@ *%`P;000`P P40`P0000`P0000`P0000`P0000`P@ *`P@ *`P0000`P@ *`P@ *`P@ *`P@ *`P@ +`P@ +`P@ +C%`PK +L`P P400`P+P/PD +%`PK +`P P40`P0000`P0000`P@ +`P@ +`P@ +`P@ ,`P0000`P0000`P0000`P0000`P@ ,$`P@ ,<`P0000`P0000`P@ ,I`P@ ,y`P@ - `PF - PD -%`PK -$`P P40`P0000`P@ -5`P@ -<`P@ -F`P@ -L`P@ -R`P@ -^`P@ -x`P@ -%`P;00`P P40`P0000`P0000`P@ -`P@ -`P@ -%`P;00`P P40`P@ -`P@ -P        Q                        h      h      h    	  h    
            G   h   I    0`P'`P(`P  P  L   L                                 G   h   o &`P P# cQ  \  \           	                       o G      o             o G      o G   o  G          o G   	   6
     9      o s              o G   o  o H      G      G         o HG   &   %I   &`P*	P/P)'`P*P/P*<P P 3.P#P$[`P P*P#P*$`P /P P                                     G   G   o       G   s   
     o G         G   o     &      G      
      ?s        o G	      o G
    	  s  `P 	P)`P,	P$`P)P.`P,P/`P 	P$`P+P/P/P$`P!Q                               
     o G            %                &              G        o      G        %s             	     s     `P)P-`P/`P  `P+`P*`P P(`P 	P$`P `P)P)`P!Q         s                  
              o G         o G       	  s    G      s    G   s            `P+P P  P$`P 	P$`P,	P$`P'`P'`P'P   p   p   A                         6     G      G   G   %9     G      G   G   %9	    `P% 0 /Q D   D                               G   h   I    	`P  P        m                	          h      h        G   6   9   h   9   9   9	     o       G
   h   o  `P (	*&*P) `P P#)Q    (   (                                                                     G   o G   o        G      G   "         G   o    G      -                G      G      3           G   o  I     G      s     `P.P*P(
`P *P L`P.P)`P.P)
P p  p                           G   G   o     #        G   G   o     	      
   6   9        o G   o  G   o  9	     G
   9     9     G   9        G   &           o G   h   s    h           o G      s     
`P/
P %P %`P%&)P*P*P(/( `P `P)P/P)0`P* `P)P.P)P  D   D                                 G   s  &`P+P$P                                    G           G   $        G   G   o           	         	   h           G   s   	         o I   &`P/`P'	`P P `P&`P,&`P*-`P P$`P P)%P    D   D                                     s  `P P$P   D   D                                    s &`P*P$P        C                "            %      G            G         %   %   %   %o    	           
   I   +                   I      ?         G      o        I        I        G      I     G      I     G      I      G   G     s    `P.`P `P 	P(7`P `P !`P `P `P 	P(`P.`P 	`P `P `P `P P$`P$Q        Z         	       +            %        %            %   %   %   %o           %o         o G   o          o G	   
     s       o G     s       o G     s       o G         s       o G         s       o G         s       o G      s    `P.`P.`P P(g`P/P(`P*P*P(`P*P P$`P*P.P$
`P*P.P$`P*P P$`P*P P$`P*P P$`P*P/P$`P$Q   p  P  H         
       Y      $   G   6      G      o       |  }  G   o        G         G   o       G	         G
   o         %         %     G   "         G   .'I      $         G   G      s !      6         G   =   $      G   G      c      d       d   s )   h         G   #   ,       h      G   s /            %o           o G         G   s        o G         s        o G         s    G       A      !   I       B      !   I"   C          o G#   s  8   G           G%           s J   &   G'   8   M   (   G)      o G'   *      s 4   R   (   G)      o G+   ,      s W   6-   h.   9/    `P 	P)'`P P(`P P)*`P P((`P `P/`P 
 `P P)`P'`P+`P 
`P !**P) `P+ `P `P 
P*7`P P)`P+P P$`P+P P$`P+P P$`P `P &`P  `P+P*P +`P P*`P `P 	P P.`P 	P P)!`P%*Q   p  `  $     +                             	       n      $   G     o       G              G   G   G   (   	      G   G   G   G            I        G   G   G   #         G   G   G            G   G      I            G	              G	   G   G   G         G	   G   G   G
      #      G   G   &      &   &   I        G	   G   G   #   +      G	   G   G      .      G	   G   0   I   1   8   1           G         s 4        5        6   s  7             9         9      9               ;      G       G   o     G   "   A     G        s C     G   =   E      G   G      c     d      d   s J   (   J      G          s M   E   M                 G            s P     G   =   R      G   G      c     d      d   s W     G      Y      G   .(I   _   $   `      G   G      s d     G   #   f     G        s h          o G   s      h   ds   n    
`P 	P*`P `P Z`P y`P `P y`P   +`P P*`P `P(`P $`P `P P( `P `P P)`P 
`P $**P #`P P +`P*
`P P*`P 
`P %**P)!`P 
 `P P)`P `P P)`P+P*P$	`P-
P$[`P,P             +      W  8                        8          q                        $       o G   s        o G   s  8                G          s    !`P+P*P$	`P+P*P +`P P*P             @   +              7   T   T   $                                          s     `P/`P+P)P (   (                                    t  t                                                                G            G                        G      s          $          	      %v          
   2             o G
      o G   s        .`P,`P 7`P `P P)`P `P `P `P+P/
P*P)`P%Q t  t                            G        G            G   o      G         G   h   o G   h	   s     
      %o G   h   o G   h   s    G   6      G   G   9   9      9      9   h   9   h   9   s @ `P= `P> `P.P9 `PN `P PO	 PD `P P/PO PD `P0 0 6 : : J0 J PD8 `P1Q  P   P                                     o G   s  6 `P*P*P4 P P   P                                     o G   s  6 `P*P*P4 P P   P                                     o G   s  6 `P*P*P4 P P   P                                     o G   s  6 `P*P*P4 P d  d                                o G      o G   o        G   g      o          o G      o G   o      	         
      s #         G         s              %o G      o G      s @ `P)P/P*PH `P P8 `P)P/P*P8 `P0 `P*P>0 `P 	PI `P P/P/P4 P       H                            =                %o G      o G      s    0 `PO `P P/P/PI P @   @                                h   s @ `P+PDP   P   P                                G   h    o  J   @@ `P@ PI P  (  (                              G            G            G       G      h   
     G      N        G      4        G	              G
                   6   h    o  9      0 `P0 `P> `PB `P0 F 	PM Q                        	                 G   G               Z         G   G               -         G   G      	         	      0 `P: `P0 `P0 `P0 `P0 `P0 `PO	 
`P4 Q   `  `                           h      h      h      h      h      h         6      9   h	   9
   h   9   h   9   J      G   h   J      G   G   6   9   9   9   J      G   G      J       h   s @@ `PK `PJ J J J5 @   `P@   `P0 6 6 <00 `P@   `P+PD  P         Z         
                     J            o G            G      G      o o J   6 `P= `P-P: CP#P9 P p   p   >                                 G                        Ho  6 `P ,P3 Q                                            G                   o G      s    J      G   G      s   G      r   G      h	   r 6 `PJ `P `PA F `P+P/	PD `P; `P PD
 `P P4 `P 	PD P      ?                %          G   G   $         G   G      o          G   G   o  G   )         G   G   	   G
   o       G   G   s              G   HG         G   G      s    <         G   G     G   G   G   h   s #   "      G   G      s %   0 `P &PM 
`P P !PI 
`P0 PD `P> `P@ 
`P PD 
`P> P= PI P   H   H                                G   G      s  `P P$P     '                                  G   o       G                    J          o G      s    G     r   G   G   	   o G   
   s    G   G   #        G   G      o    "         G     r          G     r    6 `P PI `P `PA F `P9 `PK `P+P/	PD
 `P PD `P0%P:%PD `P &P0 P= P9 P         U                                     h   o       G   G     G   G   G   h   s 6 `P: `PKC PI `P PD P  x   x   ?                             G   G     G   G   G   s   G      r 0 
`P P4 
`P 
P4 P  \   \   %                                 s   G      r 0 `P+P4 `P 
P4 P |   |   >                             G   G   o  G      s    G      r 6 `P0 P:%PD `P 	P4 P                    H                G   G      o                          G           G   G      M  	      G   G	                      
     %   %o G      G   o J     G   G      :        G   G      G     G     o s              G   HG   "     G   G      s   9   &     G   G      G   G	   G     s    ,      s  -     -     G      0     G   1      2     G   G      s    G   G	   #   8     G   G      o ;   N   <     G   G      G   G	   G      G        o s    D      G     r F      F        G      s  H   6 `P9 `P P@ `P0 `P@ `P P:*	PI
 
`P0 `P P#PI 
`P.`P@ `P PD `P> P=$P@ `P0 `P PD `P &P0 7P#P= P@ `P= `PM  P    \   \   &                              G   G   s     J   6 `P P4 `P; P                                             G            G   G      2            o G      h   s ;   	      G   (            o G      s    6 `P: `P0 `P+P PN `P0 `P+P/PI	 P    \   \   ,                           G            G   o     0 `P P9 P  L   L                                G   h   o 6 `P PC	 Q      $                              o       G      o     G   6     G   G   G      G   o                    o     7         G        |      }   s                     Hs  ,        G	           G	   s     6 `P*P8 `P P8 `P (P# P8 
`P.`P P'P9 
`P `P,P> `P `P+P9 P   \   \   )                                 o G         h   s 0 `P+P 	PD	 P x  x                                o           G      o E         G      o   #        G   g      o 	   o     G      o       	   :         G
   6     G   o     G   o  o        G   s    G     s 6 `P*P8 `P P %P P(P8 `P P 0P.P#PM `P*P4 `P/P4 P                          
       h            h         6      9   h   9   J      G	   h
   J      G	   G      J       h   s K@ `P; `PK `PJ J @3 `P@< `P@B `P+PDGP       T                               o G         G   o          o G      h   s 6 `P)P 
P9 `P+P 	PD P  T   T                                 G   o  G      s 0 
`P,P/	P4 P                	                      o       G      o     S         G      o     #        G   g      o 	     	         o     G            G   o         G	   
   o       s            G   
   o    6 `P*P8 `P PH 
`P> `P P8 `P  P@ `P*
P8 `P #PM `P PH `P: `P PI `P1 Q    `   `   )                                 o G   o  G      s 0 `P+P*	P/	P4 P    L   L                                G   h   o 6 `P PC Q                 
                      o       G      o     3         G        |    }   s          #   
        HG      r    6 `P*P8 `P P8 
`P.`P P'P9 
`P `P P9 P          V                                 o G         s        o G            G   G   s 0 `P+P 	P4 `P+P 	P4 P                              h         6      9   h   9   h   9   h   9	   J
      G   h   J      G   G      J      G   G   6   
9   J       h   s K@ `PJ J J& J5 @N `P@X `P@Z `P0 Mb `P+PDiP   0  0          
       )            G     G     o          o G      o              o    	         o 
          G   6      G   G	   G
    o J       G         o J       G   G   b            o G      o   #        G   g      o                   %J            o G        G      o J     G   s    G   s  6 `P P8 `P)P/
P P PM `P P9 `P P9 `P0)P/P P00 `P/P 
P9 `P+P4 `P+P4 P          c                                 G   G      G   o G   h   o J         G      G   h   o J   6 `P0)P? PI `P PI P         |                	                o G      o    g   G      o              o G         	         	   	   6 `P*P/P8 `P P P0 
Q  P   P                                  o G   o  G   0 
`P)P*P8 Q     t          
                  G   G   o    G   G   %     G       G       G       G     
     .(              Hr             HY          %H             %H   "        G	       Ho    ^   6 `P P0 `P> `P> `PN `P.fP0 
`P00 0 P@ P           e      P  P                               J     G   G     G   o G      o G      s   G   G     G   	   %  %
   %o G      o G      o       G      o -         G      o G      s    6@ `PM `P0)P/P:%PD	 `P0 P:%P:%PH `P P= 
`P P/PI P    L   L                                G   h   o 6 `P PC Q                                       o       G      o                         7         G        |      }   s 
                    Hs     6 `P*P8 `P P8 `P0 
`P.`P  P'P9 
`P `P,P9 P  T   T                                    o G   h   s 0 `P+P/PD P    t   t   6                                o       G      G   o  s 6 `P*P8 `P P#P4 P        x                         h         6      9   h   9   h   9   J      G	   h
   J      G	   G      J       h   s @@ `PK `PJ J J/ @W `P@` `P@f `P+PDmP  L   L                                      o J   6 `P-P9 P  <  <          	       #            G         G      o       G      o     T         G      o     #   	     G   g   	   o            G
      o G      o              G      o G   o  H      G   6      9      9   s      o     G      G
      o    s   G       G
   o  h   s 6 `P? `P P8 `P PH 
`P> `P P8 `P  P@ `P P/P-`PA F `P P*PK `P0 : J PD `P*
PH `P P'P4 `P P(PD P    d   d   *                             G   6      9      9   s 0 `P0 
: 
J PD P   $  $                          h       G      o       9        G   G            G      o          6   	      G     G   G   G	      s           s        G
      s : `P/
P9 `P00 PN `P? P=%PI  `P P4 P                                  G      o G      o G      s    G      s    1   	      HG      G      s          G      s       G	   
   o .         G      o G      s                 o     0 `P<%P:%P:%PD `P PD `P? 
`P= 
`P P>0 
`P PI `P P= 
`P P/PI `P P9 P  L   L                                G   h   o 6 `P PC Q                 
                      o       G      o     3         G        |    }   s             
        Hs     6 `P*P8 `P P8 
`P.`P P'P9 
`P `P,P9 P  \   \   )                                 o G         h   s 0 `P+P 	PD P l   l   2                            G   s         o G      s 6 `P*P4 `P*P/P4 P        S                 $       h         6      9   h   9   h   9   h   9	   h
   9   h   9   h   9   h   9   h   9   h   9   h   9   h   9   h   9   h   9   h   9   h    9!   h"   9#   h$   9%   J&      G'   h(   J)      G'   G)      J*      G'   G)   6+   9,   9-   9.   /   90   1   92   3   94   5   96   J7   @@ `PK `PJ J J$ J1 J@ JO J   J   J   J   :000 J   J   :000 J   :000 :000 :000 @   `P@   `P00 `P0 6 6 6 : : : 000P P   P   !                             G         s 6 `P P4 P p  p                 0             J          o J       G    o J     J     G   G             G   G            	         
           G   G                               G   G        G   G      G     G     o s   G   G       G   G      G     G     o s #     G   G   N   &        G   6     G   6      9      9   o J      .     G   s  0   6@ `P= `P-P9 `P P9 `PK	 
`P0 `P0 `P0 `P 3P#P4 `P 4P#PI `P0 6**P0+P9 P                                  G   6      G      G   HG        G   G   o  o     G           G   	      2        6
     G   9     G   9   J        6 `P HP#PG 
`P 0 `P8 
= 
@
 `P3 Q    8  8                                 G   o    G   H   G   o G      G   o       G   G             G   G   G               G   s  =            J	   
    h      G   G   G   s    6 `P.P P PI 
`P 0 `P,P>0 `P0 `PK@ PI P  h   h   0                             G               G   s     0 `P0 `P,PI P    8  8                                 G   o    G   H   G   o G      G   o       G   G             G   G   G               G   s  =            J	   
    h      G   G   G   s    6 `P.P P PI 
`P 0 `P,P>0 `P0 `PK@ PI P  h   h   0                             G               G   s     0 `P0 `P,PI P                       n            G   o          G      n       G   o       G   s    G   G            G      s      G   G	   
   <        G   G	   G        H  G   Hr         G   G	        g   G     o      G   o  G   6   9   9      9   o G        (     G      )      G   +   s   G     o      HG        HG       $   3     G      o H   6     6      B   7         8         9         :   7  :   6      G     G!   %9     G     G"   *%  *&9        F   6#     G     &9     G     G"   *%  *&9        Q   6$     G     G!   *%  *&9     G     &9     T   \   6%     G     G!   *%  *&9     G     G"   %9        h      G     o G     o G   &   s n   6@	 
`P+P0 `P+P8 `P+PD `P0 
`P PI `P 0 !P=@ `P PH `P; P:%&&	*P: PD `P/PH `P0 `P@! `P P00 `P% 0 `P:0 `P% 0 `P:0 `P% 20 `P:0 `P% 20 `PJ0 `P;$P:$P:%PI5 P       Z                
            G   o        G      o G     G   o  s    G      s 6 `P+P8 `P P !P#P4 `P P4 P                                 h            G   o        G      s   G   G   #        G   G   	   o 
            s           G
   s     0 `P9 `P+PI `P PD `P "P0%P=,P9 P       A                              h   o      G     G   G   G   h   s 0 `PKC  PI `P PD	 P   d   d   /                            G     G   G   G   o G   s  0 
`P P*P4 P    X   X                                     s   G   s  0 
`P+P4 
`P,P4 P                                     G         G      o %         G      o       U   	      G         G      o             o G      s    6 `P> 
`P P. 
P0 `P "P P/4PI P  D   D                                 G   o  6 `P+P3 Q                                    G   6            6   9   9            G   G   o  	   6      G   HG	   9
      G   HG   9   o 6 `P & P= 0 @ PC Q    ,  ,                              G       G       G      o Q        G      (   	     G   G     Hr         G                        G	   o  G
   g      o       60 `P> `PN `P P>  'P@ `P P PH
 `P4 Q    p   p   A                                 G   "             G   G   o    J   6 `P  P= Q       K                              G   HG   /         G   s     J      J      6 
`P0 `P+P4 `P; `P@ P  @   @                                 J   6 `P; P    @   @                                 J   6 `P; P    L   L                                    G   J   6 `P$0 P          R                                 G   o  G      o                      Hs  6 `P 
P/P !P4 P L   L                                G   h   o 6 `P PC Q                                       o       G      o                         7         G        |      }   s 
                    Hs     6 `P*P8 `P P8 `P0 
`P.`P P'P9 
`P `P,P9 P  |  |  
                         h            G   6      G   G   G   G   6      9	   h
   9   h   9   h   9   h   9   o J      G   h   J      G   G      J      G   G      G   6      G   G   G   6      9      9      9   o J   @@ `PK `P@ J J J J+ J PI8 `P@B `P@D `P0 : : JD PIJP   P   P   !                             G         s 6 `P P4 P t  t          	                   G   o       G   o      G   o       G      o    G     o                   	      H  s    G   
   o    G     o                   	      H  s    G      s 6 `P+P8 `P+P8 `P+PH `P P P -P4 `P P  P /PD `P P4 P  h   h   4                              G   o           G   o     6 `P+P P8 Q                                   G       G       G      o Q        G      (   	     G   G     Hr         G            G   o  G	   g
      o       60 `P> `PN `P P>  +P@ `P+P PH
 `P4 Q        J                              G   +                G   G   o J         G   6 
`P0 `P PN `P9 Q    L   L                                G   h   o 6 `P PC Q                                       o       G      o                         7         G        |      }   s 
                    Hs     6 `P*P8 `P P8 `P0 
`P.`P P'P9 
`P `P,P9 P        y                  
             h         6      9   h   9   J      G   h	   J
      G   G
      J       h   s @@ `P; `PK `PJ J @6 `P@? `P@E `P+PDIP    d   d   1                                o G            G   s 6 `P)P P4 P  |  |                 &         h          o       G      o     S         G      o     #        G   g      o 	     	        o       G   	   s           G
   o        G   N         G      o                   G   o              G   	   o G      s   G   G            G      o    6          G     G   G   G     s    %      s  &   0 `P*P8 `P PH 
`P> `P P8 `P  P@
 `P*
P9 `P PD `P PI `P #P "P@ `P<%	P:%	PD `P  P0 P=%P9 P T   T                                 G      o G   s  0 `P<%P: P4 P  L   L                                G   h   o 6 `P PC Q                 
                      o       G      o     3         G        |    }   s          #   
        HG      r    6 `P*P8 `P P8 
`P.`P P'P9 
`P `P P9 P    h   h   3                                 o G            G   G   s 0 `P+P 	P4 P                                   h         6      9   h   9   h   9   J      G	   h
   J      G	   G   6      9   J      G	   G      J       h   s @@ `PK `PJ J J# @3 `P@> `P0 @B `P@H `P+PDPP         R                	                   o J         G   6      G   G   G    o J   6 `P-P9 `P P9 P    x  x          	                        G         G   o        G      o                              %      G	   .   	      G   	        Ho  o         H      H        G
      H   s     h   s 6 `P; `P? `P,P8 `P P@ `P0 `P 0P#PI	 `P PD `PKA PD P       q                  
              7         G      o G         s -         G      o G      s 
   0 
`P0 P P= P/P9 P         t                            G   G      o       -         G      o G      o      G   G      s 6 `P PH `P0%P:%PI `P P4 P L   L                                G   h   o 6 `P PC	 Q  X  X                                 o       G      o                         7         G        |      }   s 
                 G   s  -                 G      s    6 `P*P8 `P P8 `P0 
`P.`P P'P9 
`P `P+P> `P/`P P9 P  \   \   )                                 o G         h   s 0 `P+P 	PD P       e                 	             G   o       G      o "         G      o          G      s 0 `P.P8 
`P P-`P P= `P P4 P    4  4                           h         6      9   h   9   h   9   h   9	   h
   9   h   9   h   9   J      G   h   J      G   G   6   9   J      G   G      J       h   s @@ `PK `PJ J J J* J1 J> JN @W `P@a `P0 Le `P@k `P+PDvP                                           o J         G   6      G   G   G    o J      G   G   +                G   G   o J	         G   G
            G
   o     6 `P-P9 `P PI `P0 `P PN `P P9 P         L                            G   G      o                            6 `P P8 `P0 Q        c        
       !            G   o        G   c      d       d   G      o o     G   #   	     G   G      o                G	      _        G
      o     G      s           G
      o         G      Hs   G            s   G      H  G   H  Hs 6 `P+P8 `P *
 P#P8 `P PM 
`P0 `P P8 `P P4 `P PN `P P4 `P P4 `P PD P          o                            G   o       G     G      Ho  s   G            s   G      Hs 6 `P+P8 `P #P#P4 `P P4 `P P4 P                                    G   o       G   G      o    H              o HG     G                          H   s   6 `P+PH `P0%	P4 P3H `P 0PD
 `P4 Q                                    h        G   G      o   H   s   G   G   #        G   G      o    :        G   G	     G   G   G
      s           s     6 `P: `PJ `P0%	P4*PD `P &P0 P=%P9 P          E                                         G   s        G   G      s 0 `P `P,P9 `P P4 
P          M                                 G   G      o                      Hs  6 `P P !P4 P L   L                                G   h   o 6 `P PC Q                                       o       G      o                         7         G        |      }   s 
                    Hs     6 `P*P8 `P P8 `P0 
`P.`P P'P9 
`P `P,P9 P  \   \   )                                 o G         h   s 0 `P+P 	PD	 P \  \           	                      o       G      o ]        G   o  E         G      o   #   
     G   g      o            o G   	   o       
            G   o             o G	     s 6 `P*P8 `P P>*P> P P= `P*P/	P $P= `P*P.	P4 P   <  <                           h         6   h   9   h   9   h   9   h	   9
   h   9   h   9   J      G   h   J      G   G   6   9      9   J      G   G      J       h   s @@ `PK `PJ J J, J2 J7 J< @k `P@w `P0 8 @| `P@   `P+PD  P    p  p                                    o J         G   6      G   G   G    o J      G   G   '         G      G   G   o       G   G	   
   j         G   G         G      G	      o o G         G      G      o o    6 `P-P9 `P P9 `P P9 `P0 P#P: P#P9 P          I                                     G      G      o    G   G   o J      6 `P P P9 `P4 Q     R                           G   G      o       G   o  G   o      G      o             G   &                        G   (        G   G	   
   h   o         #        G   o  G   o       G                                     Ho o 6 `P P8 `P+P*	P8 `P/	P8 `PJ 
`P (`PA F 
`P0 `P PC F 
`P0 `P+P*PC F `P 5P#P3 Q   H   H                                G      s 0 
`P P4 P    d   d   *                                  G   s    J      6 `P/P4 `P; `P4 Q   t   t   5                              G                G      o 6 
`P `PA F `P P3 Q  t   t   5                              G                G      o 6 
`P `PA F `P P3 Q                     @           G   G      o                 Ho          G               	         	      	                           	               J
              G   o        G            ,        G   G      o   Ho           G      o             G   G   #        G   G      o     v   !     G   G      s    G      s    G      s   J
     G   G      s    ,      G      s    HG      G      s    G      s   G   G      s   G   G     G   G   G   h   s =         >     G   o  @     6 `P P9 `P P> `P> `P0 `P0 `PJ `PK
 `P PI `P -P*PN 
`P P-`PA' F 
`P 'P0 `P P4 `P P4 `P P4 `P; `P P>0 `P P4 `P= `P P4 `P P4 `P P4 `P PI$ `P PI& `P4 Q                                      G   c      d       d   G      o o G      s    G   c      d       d   G      o s    J       h   s 0 
`P * P#P/)P4 
`P *
 P#P4 
`P< 
`P,
P4 P   H   H                                G   G      s  `P P$P L   L                                G   h   o 6 `P PC
 Q      -                              o       G      o                         7         G        |      }   s 
         #        G      s g                    G                    Hs          G   s     6 `P*P8 `P P8 `P0 
`P.`P P'P9 
`P `P P> `P 7`P,P> `P+P9 P \   \   )                                 o G         h   s 0 `P+P 	PD P l  l                                 o           G      o E         G      o   #        G   g      o 	   o     G      o ;         G	   6
     G   o     G   o  o        G     s   G   s  6 `P*P8 `P P %P P(P8 `P 	P &P.P#P= `P/P4 `P*P4 P        C                 "       h         6      9   h   9   h   9   h   9	   h
   9   h   9   h   9   h   9   h   9   h   9   h   9   h   9   h   9   h   9   h   9   h    9!   h"   9#   J$      G%   h&   J'      G%   G'   6(   c    9)   9*   +   9,   -   9.   J/      G%   G'      J0       h1   s @@ `PK `PJ J J J* J0 JH JL J[ Ja Jo Jz J   J   J   J   J   J   @   `P@   `P0 : 7 : 000 `P@   `P+PD  P        G               $                   o J         G   6      G   G   G    o J         G   G            G      J         G   G	            G	      J	         G   G
            G
      J
             G   G   o G      o J         G   G   J      J      G   s  6 `P-P9 `P P9 `P0 `P0 `P0 `P P/P9 `P0 `P; `P+P4 P        n                            G   G      o G      o      G   G      s   G   G   s    G	   o  6 `P P/P8 `P P4 `P P4 `P+P3 Q                	                    G   6     G   G   o  6     G   HG   9   o      G   G	   6
      G      G   %9      G   9   s   G   G   s    J     6 `P P8 @ PH `P0 0 N PD
 `P P4 `P; `P4 Q  d   d   +                              G   G   s     J      6 `P P4 `P; `P4 Q     7        	                         G   G   o  J     G   ?        G           G   o     
     
   
     G     G   h   o      G	      o       G
   ?        G           G   o                  G      G     G   G   o o G   o  6 `PJ `P PI 
`P0 `P P@ F `P 
PH `P/PH 
`P0 `P P@ F `P P#P*+P3 Q X   X   &                            G     o            0 `P/P-`P3 V p   p   3                            G   o  G      G   G   o  o 6 `P *P !P#P4 Q                	               c       c      c           G   o            G   o  G     G   G   o  o "         G     s \        G     G   o "        G     s         G     s    6      G       o 6 `P: `P: `PJ fP*P0 `P+P !P#P-#`P/P> `P P.`P/P> `P/P@ `P P3 Q           $      x   x   A                            G      |      G   %   %     } h   o 6 `P P(PC Q  <   <                                %   %0 `P? Q       i                
                     o G   h   o     G   o  G      s    G   G     s    6 `PJ `P)P/	PG	 `P*P/P4 `P P4 `P4 Q         d                               G   G   o G       o     G      o G      G    o s   H0 `P P P7 `P/P P#P4 `P5 Q                                    G   G      o G      o       G   o      G   2   	         G   G      o Ho        G	      s 6 `P P/P8 `P+PH 
`P0 `P P%PM `P P4 P                                  G   G      o G      o       G   o      G   1   	     G   G      o G	   o         G
      s 6 `P P/P8 `P+PH 
`P0 `P P*PM `P P4 P     i        	       '              G   G         G      G      o o G         G      G      o o G         G      G      o s    G   G            G   G	      ?         G   G   
      G      G      o s       G   G         G      G      o o G            G      G      o s 6 `P0 P#P: P#P: P#PD 
`P0 `P P#PI
 `P0 P#P: "P#P4 P                                    G   (G      &9      	5      '      L      u               G                G   s  L   
      G                G   s           G   s       G   s    G   s  6 `P000 
`PJ00 `P `PA F	 
`P+P4 
`PJ0 `P `PA F 
`P+P4 
`PJ0 
`P+PI `P*P4 `P*P4 P   p  p                               G               G   	G      9      +      &5      (N      k        G   s  S   
     G   s     G   s  ,        G   s     G   s          G   s  6 
`P `PA F `P0000 
`P*P4 
`PJ
0 
`P*P4 
`P+P4 
`PJ0 
`P*P4 
`P+P4 
`PJ `P*P4 P  X   X   #                                    h    s 6 `P: `P.
P4 P   @   @                                G   s   `P,P$P    p   p   2                            G   s    G   s     G   s  6 `P*P4 `P*P4 `P+P4 P       P                	             G   G      o G      s       G   o G      s 6 `P P/P4 `P.P/P4 P    L   L                                G   h   o 6 `P PC Q                                       o       G      o                         7         G        |      }   s 
                    Hs     6 `P*P8 `P P8 `P0 
`P.`P  P'P9 
`P `P,P9 P  \   \   )                                 o G         h   s 0 `P+P 	PD P       h                
               o       G      o             G   s     G      G   o  s 6 `P*P8 
`P P-`PA F `P*P4 `P P#P4 P                                h      h      h      h         6   h   9   h   9	   h
   9   h   9   I         I      6   h   9	   h   9   I      h   I   @ `PJ	 J J J @$ `P@. `P: J2 @7 `P@ OP    0   0                                `P#
Q   ,   ,                              `P!Q (   (                                                          	               H      !         |     %  }                       K           h   K	   6 `P> `P? `P PI `P0 `P@ `P@ P         Z                
            G   G   G     r          G      q K   G      q 6 `P P8 `P P5 `P P3 Q  |   |   A                               H!         |     %  }          K6 `P0 `P P9 `P< P  @   @                                     K6 `P> P @   @                                     K6 `P> P (   (                                    H   H                                     % K6 `P0 P    D   D                                     %H6 `P> Q                                  h    %  h      h      h      h    &  h      h    *  h      h	      h
    '  h      h       h      h      h      h    
  h      h      h      h      h      h    )  h    !  h      h      h      h      h      h      h      h           |  }  I          G!   "   s    G!   #   s    G!   $   s    G!   %   s    G!   &   s    G!   '   s    G!   (   s    G!   )   s    h*   I+   h,    	  6-   .   9/   0   91      2     3     4   |5     %6   %  %7   %8     }  (  4   |  9     }  "  g:    $  0 `P.PN `P PD `P PD
 `P PD `P P4 `P PD `P P4 `P PD `P PD00@$@& `PO + %`PK  `P%*@ g `P: `P: `P0 `P@  `PK  P                      !                   |     }      |  }       |  }     c     #        G     o     G   g      o     G   g      o     G   g	   
   o     G   g   
   o        %   %        o     G   g      o      G     o         o    %     o         o         o     G   g      o     G   g      o      G     o          #    @ `P? `P/PI `P*	P9 `P*P9 `P; `PG `P/PG `P PG `P PG" `P P7 `P PG& `P@) `P)PG/ `P PG1 `P/PG4 `P)PG7 `P)PG9 `P)PG; `P)PG> `P PGA `P PGC `P/PGE `P@G `P3 Q  X   X                               G   g   h   o     @ `P PG0 `P3 Q                                   G   o      G     )    o s         A       4         G     G   g      o s       0 `P*P7 `P P#P4 `PM `PC K `P= `P P#PI `P5 Q                         
                    G   g      o     G   g      o     G   g      o     G   g      o     G   g      o     @ `P: `PJ' `P PG; `P PGN `P PG_ `P PGt `P PGv `P3 Q          n                 	              G   g      o       G   g      o        #  G      o &%   %      0 `PH `P PH `P PH
 `P &P@ `P4 Q   <   <                                  o  `P)P#Q                                  G      	  o          o           G   g      o     G   g      o     G   g      o         o         o         o      G      	  o         o          o     @ `P PG `P)PG `P: `P P7 `P P7 `P PG `P)P7 `P)P7 `P)PG `P PG `P)P7 `P,PG `P3 Q                                   G     o         o         o    !     o         o    *     o         o     G   g      o    )     o         o     G   g      o      G     o     @ `P/PG `P)P7 `P)P7 `P)PG `P)P7 `P)PG `P)PG `P PG `P)P7 `P)PG `P PG `P/PG  `P3 Q    h   h   )                        g        G      h   o     @ `PJ `P PG `P3 Q          k                          G   g      o             G   o                         o       0 `P P8 `P 'P P8 `P4 Q        V                           G   g      o     G   g      o     G   g      o     @ `P PGG `P PGY `P PG[ `P3 Q @  @  G         
       0                             G   g      o    G   o                 	        1        G   o  G   g      o      	     %     G
     o    g         G
     o      G
     o    "         G
     o      C         G   g   o    "           "      "         o            o        %   %       M   (    '     o            o          %   %%  -          %   %%    0 `P `P> `P8 `P P8 `P*P8 `P8 `PH `P0 `P@ `P+P PM `PO `P P0 `P P8 `P 	P0 `P P@0 `P P@ `P00 `PD+ F `P*P8 `P/P8 `P@" `P0 `P*P8 `P/P8 `PK( `PF* `P4 Q  |   |   ;                           G   g      o     G   g      o     @ `P PG6 `P PG8 `P3 Q  |   |   A                           G   g      o G   g      o G   g      o @ `P P P P3 Q                        '               G   o                                          1        G   o  G   g      o           %     G     o    g         G     o      G     o    "         G     o                       '     o 	   o         
   o        %   %  %   %   '     o         
   o          %   %%       %    0 `P8 `P8 `P*P8 `P8 `PH `P.`PO	 `P0 `P@ `P+P PM `PO `P P0 `P P8 `P 	P0 `P P@0 `PD+ F `P P(P8 `P/P8 `P@# `P*P8 `P/P8 `PF( `PF* `P4 Q         V                           G   g   h   o     G   g   h   o     G   g   h   o     @	 `P PG `P PG$ `P PG+ `P3 Q H   H                                &    o %   % `P.P*!Q   H   H                                &    o %   % `P.P*!Q   t   t   =                         G            %   % &    o %   %   %   %0 "`P= `P P0 Q                                      %  g        )        G      h   o   .      g        G      h   o        G   g      o     @ `PE! `PJ# `P? `P P@20 `P: `P PL@ `P PGB `P3 Q                                    G   g   o                                   o     G   g      o        %	   %  %
   %  %   %    0 `P8 %`P/P@ !`P PH
 `P P8 `P0 `P4 Q                                          G   g   o                               o         %  %   %  %   %  %   %    0  `P8 `PH %`P/P0 !`P.P8 `P0 `P4 Q   4  4                            .'    G   g      o        %     H      |      %   %   %   %	     }        G     h
   o     G   g      o     .(    @ `PO `P PG" `PE= `P> `P0 1`P7 `P PGW `P PGY `P? `P3 Q               	                     g   G      o     !         G   g   o                    +               o o    d   
            o o       G   g      o             &      o                  %	   %0 `P8 (`P8 3`P P8 2`P !P@ `P0 `P P$P@	@ `P P$P8 `P P8 `P? `P*PM `P: `P0 Q          H                              %    G   g   h   o     G   g      o     @ `PE `P PG& `P PG( `P3 Q                                                o o           o       G   g      o       G   g      o          %   %         %   %  %0 $`P8 #`PH `P P#P8 `P*P8 `P P8 `P PH	 `P@ `P0 Q  x   x   =                           G   g      o       #  G     o &%   %0 `P P7 `P !P< Q    X   X                               G   g   h   o     @' `P PG2 `P3 Q                          
              G   g      o       G   g      o           o       G   g      o        %   %   %0 `P8 `P P8 `P P8 `P*P8 `P P8 `P0 Q        l                           G   g      o     G   g      o     G   g      o            o     @ `P PG `P P7 `P PG `P/PG `P3 Q         ;                           G   g      o     G   g      o     @ `P?E PG `P?E PG	 `P3 Q  X   X                               G   g   h   o     @ `P PG- `P3 Q   8  8                                 G   g      o       G   g      o       G   g      o           o       G   g      o       G   g	   h
   o     
         %   %o 0 `PH `P PH	 `P PH `P P8 `P*PH `P PH `P;J PH `P P3 Q        H                               G   g      o       G   g      o       0 &`PH `P 
P8 `P 
P8 `P4 Q  4                    (        G   g      o     G   g      o     G   g   o    c      g        G                 
        H    G	     o "        G
     s x      g   G	     o [      &     o     G   g      o        %    G
     s      .'               G              p               =                  HG   g   h   o K$     .'  &     G      o @ `P P7 `P PG
 `P/P8 `PJ `PJ `P>  `P&fP0 `PN `P/	P= `P/	PN `P P= `P*P8 `P 
P8 `P6 `P/	PI %`P@% `P= `P>  `P&fP0 #`P7 fP? `P7 `P PO' )`P@2 `P P3 Q   4         u               H               D   D                               #   H0 `P7 `P9 Q   |   |   ;                           G   g      o     G   g      o     @ `P PG `P PG
 `P3 Q  |   |   ;                           G   g      o     G   g      o     @ `P P7 `P P7 `P3 Q                 
       4                   G    G   &o              % %   %
    G   g   o                G              H   A                        .'             .(       .'  n   	        G      
   |     %   %  }    G     h   o  #      o   $    G    G   &o   "  G     o 6   +        %    G    G   &o  0       % %   %   %0 `P= `PC" F `P P0 `P@" F `P/P8 `P6  `P&fP0 `P0 `P0 `P@ `P@0 `P@ /`P@ `P; `P0 `P+ 8 `P PL `P? `P P8 `P P= `P0 `P PL! `P0 Q             y      @   @                                     0 `P9 `P5 Q       D                          G    (     o   h        G   g      o     @	 `P PG `P: `P PG% `P3 Q    X   X   *                             %   %   G    o %   % `P /P*Q  X   X                               G   g   h   o     @ `P PG
 `P3 Q   `   `   &                             o       G      o 0 ,`P)P8 `P P3 Q    |   |   ;                           G   g      o     G   g      o     @ `P PG `P PG `P3 Q        x                         g   G     o            c      d       d      d      d           G   g   h	   o 0 `P/P= `PC F `P%***0 `PG `P PC Q         Q                                     %            &+    %         H0 `P0 `P; `PC F `P0 `P; `P; Q       E                                           G         G   $  h   o 0 `P? `PE F `P@ `P PC Q                                                     X          &.      g   G      G    %o o                     G   o G	   o %0 `P0 `PE F `P0 `P (P#P0 `PE F `P P,P4 Q                        
           G   g      o %   %                %         |        }     G        o     @ `P PO `P= `P@	 `P0 `P PG `P3 Q    \   \   %                         G   o          %   %0 #`P+P8 `P0 Q    8  8                           h      h      h                           2                   o G	      (      
   G         G	            h   I   g      g      g      00 `P 0 `P: `P+P00 `P? `P@
 `PO `PK `PK `PKkP         T                            |  }        G   G         s    G   G         s    0 `P0 `P P4 `P P4 `P4 Q  H   H                              G   g      o 0 `P P3 Q       u                  	         G      o :        G      o         G      o       	        	      	   0 `P/P "P P0 `PC K `P5 V            
          4                       g        G   o  G      o           c       G                       c      c                              HG   g   	   o        H,        G
        %   %o                    H    g   G     o          %	     	    m   !     	  H%   $     	  H     %   %(      )   	       )   	  .'	  +         -         K     .       K/      .'   i1        2     2        G      h   o     @ `P0 `PE> F `PJ `P*P.PH `P0 `P0 `PC> F0 `P:0 `P: `P; `PF  `P'fP0 `P PH `P P0 `PJ `P? `PG! `P PM$  `P,
fP0 `P0 `P9 `PJ$ ;`P@, `P0 `P@/ `P@ ,`P@2 `P> `PC> F7 `P7 `P PG= `P3 Q             {  |               |   |   F                              H                          .'      0 `P0 `P? `P4 Q       }                               G         6      I      G   G         0   
      |  }        G      I         0 `P0 `P0 `P> `P*P8 `P@ `P4Q   `   `   .                                 G   |  }  I      I   6 `P P9 `P;P       V                            G               G   s    h               o I   6 `P0 `P/PI `PJ `P P9P x   x   >                             G   G   c      d       G   d      d   s 0 `P */*P4 P   T  T                               G   G         G   G                o             V         G   G	   G
   h   s    G   s         o G   o  .         G      s        o    6 `P0 `P0 `P+PCK `P0 `P PD
 `P+P4 `P+P*PCK0 `P P4 `P+PCV  `   `   (                                 o G          o s 0 `P+P P#P4 P 	  	                             G         G         G         G         6   I      6   I	      6
   I      6   I      G         G	    	     G         G         g   G      G   G   o  o I      g   G      G   G   o  o I      g   G      G   G   o  o .   &   g   G      G   G   o  o +   I         G      .      G   0   I      g   G      G   G   o  o I      g   G      G   G   o  o I          o    %           o !   %       "   o #   %       $   o %   % 
      &   o '   %       (   o )   %       *   o +   %       ,   o -   %       .   o /   %       0   o 1   %       2   o 3   %       4   o 5   %       6   o 7   %   8       9   o %:   %   8       ;   o %:   %   <       =   o %:   %   >      >      ?         d   @     A      B           hC   ID      E   IF      IG      IH      hI   IJ      hK   IL      hM   IN      hO   IP      hQ   IR      hS   IT      hU   IV    	  hW   IX    	  hY   IZ    	  h[   I\    	  h]   I^      h_   I`      ha   Ib      hc   Id      he   If      hg   Ih      Gh   Gi   hj   Ik      Gh   Gi   hl   Im      Gh   Gi   hn   Io      p   Iq      hr   Is      ht   Iu      hv   Iw      hx   Iy      hz   I{      h|   I}      h~   I      h   I      h   I      h   I      h   I      h   I      h   I      h   I      h   I      h   I      h   I      h   I   @ `P0 `P0 `P0 `P@	 `P0 `P0 `P0 `P@ `P0 `P0 `P0 `P@ `P .P#P9 `P (P#P9 `P /P#P AP#P> `P #0 `P ,P#P9 `P 4P#PI `P+P? !`P+P? "`P+P? #`P+P? `P+P? `P+P? #`P+P? !`P+P? !`P+P?  `P+P? #`P+P? `P+P? `P+PO3 `P  P0 `P  P0 `P P@8 `P; `PK< `PK? `P9 `PHC `P: `P: `P: `PGN `P@W `P@e `P< `PLj `P@y `P@   `P@   `P@   `P@   `P@  `P@  `P@  `P0000 `P0000 `P@  `P@ O `P@ D `P@ d `P@  `P@  `P@ / `P@ ? `P@ | `P000 `P@  `P@  `P0000 `P@  `P@  `P@  `P@  `P@ Q `P@ W `P@ ^ `P@  `P@ a `P@ x `P@  `P@ 	
 `P@ 	q `P@ 	 `P@ 	P                                        G      G      o o I         G      G      o o I         G      G      o o I         G      G   	   o o I
   6 `P )P#P9 `P 'P#P9 `P &P#P9 `P %P#P9 P          s                            G   8         G     o G      o    0   	     G           G   G         @ 	`P@ `P P/PI
 K `P@ `P@
 V       ^                           U        G   )        G       % s         G     s    0 `P= `P@ `P P>@ `P PI
 P          Q                           G   )        G       % s         G     s    0 `P@ `P PN@ `P PI	 P x   x   ;                           G   g      o     G   g      o     0 `P P7 `P P7 `P3 Q d  d                                                                	      
       
     G   o        G   g      o       G        G   g      o        % %      |       } @ `P00 `PN `P00 `PN `P*P8@ `P P8 `PO `P P8 `P@ `P P3 Q         J                             %      G      o        I        I     @ `PN `P P8 `P? `PN `P4 Q       j                                             h    	  h    
  h      h          s      h   s @00@ `P0 `P@ `PK `PK6 `PJ[ `PK   `P9000 `PK  A   PD  P          G                          G           G                   
   s    0 `P0 `P0 `P'PI P       |                !         G     G       	  s    G                          G         o       G      	   o       G   
      o       G      o B         G      o !         G   	   o    .                        %         G   G      s    G   G      s        s 0 `P P4 `PO `P= `P@@	 `P P8 `P P8 `P PH `P P "P !P0 `P@ `P@ `P P4 `P P4 `P*P4 `P1 Q   H  H                  -          G      o          I         G            I         I	      
   I     G               I   H        G               I               I      	  G   o           H   %I     G   C           G   G   I        G   G   I   *   &         I         I   *     G   G      s @ `P P9 `P0 `P0 `P0 `P@ `P@ `P0 `P0 `P0 `P00 `P@ `P,	P8 `P@ `P0 `P0 `P00 `P0 `P@! `P 	P4 P    	  	  N                          G      o        I     G      I     G      I	     G   
   I     G      I     G      o         I      G      I     G      s   G      o     h   I        G            I         I         I         I         I         I	     G     s   G      o           *        +   )   ,       G       o I!   /     "   I#           2     $   I$   3       I%        G         &   I'      (   I         )   I*   I+     G     s         C        D   {  E   ,    -   o   ,    .   o     G/   0   1   s   G/   !   1   s   G/   2   s ,    3   o       G/   !   4   s    G/   5   6    7   o s    G8   '   9   s h:        G;      s   G<     s   G<   ,    =   o s   G<      s   G8         s ,      o G<     s i     G      o     >   I#     h?   I@     A   I%        G         B   I      C   I'      D   I     G      o     >   I#     hE   I@     F   I%        G         B   I      C   I'      D   I   gG   GH     GI   GJ   o  o 5        G     s   G     s 0        G     s   G     s      GK     GL   M   	  s   G   N   IO     G   N   I     G   &   I'     GP   ]        G   Q   I	     G     GR   GS    %T   %IO     G   N   I        GL   G     s   G   	  GU     o *T   %IV     G   	  GW     o *T   %I+   ,    X   o GY   Z   c     d    s @ `P P9 `P0 `P0 `P0 `P0 `P@ `P P8 `P? `P0 `P PD `P P8 `P? `P0 `P0 `P0 `P0 `P0 `P0 `P0 `P PD `P P9 `P0 `P PN! `P0 `P0 `P0@& `P0 `P0 `P0 `P0 `P0 `P PD1 `P0 #`P+P8 `P+P8 `P P4 `P P4 `P PD8 `P+P9 `P P4 `P P#P4 `P PD= %`PKN `P PDP `P/P4 `P P#PDS `P PDU `P P4 `P*P.PIZ `P P8 `P? `POc `P? `P0 `P0 `P0 `P@j `P P8 `P? `P? `P? `P0 `P0 `P0 `P@t `P P#P= `P/P4 `P/PNx0 `P/P4 `P/PI} `P P4 `P0 `P0 `P0 `P0 `P0 `P0 `P00 `P 	P4000 `P* P0 `P* P00 `P+P 3*P4 P 8   8                             
   o  `P'P#Q       m                                o G   o    6      9      9         o 9      9      	       o 6 `P*P*PI `P5 : : +
P8 O `P*PC Q          W                 
              G         o G   o  o       	      	   
      o 0 `P6 `P P*	P#P0 `PK `P*P3 Q  8   8                             
   o  `P'P#Q                                 s     G         G               G         *   	      I         I            G   n         G   o      G   s   G	   
      s   G   
      s   G   s        G   s  0 `P: `P? `P0 `P< `P0 `P0 `P,P8 `P,P4 `P %P4 `P P4 `P+PI `P,P4 P          `                         G       E           G   -        G          G   %         0 `P= `P= fP0 `P< `P@ `P4 Q              ;   P   P   "                           G           G      0 `P0 Q   P   P   "                           G           G      0 `P0 Q       3         
       8           G            G      =         G   G         G      G   %           G   G      G   G   7         G   G         G   G     2         G   G         G   G           G   -         G	        G        "      G
      $      G
   G   &   7   '      G
   G        G
   G     F   +      G   2   -      G   G        G   G     1      G        o      G       o   c     d      d     d     d   @0@ `P0 `P0 `P0 `P0 `P0 `P00 `P0 `P@ `P@ `P? `P0 `P@ `P0 `P0 `P@ `P0 `P@ `P P8 `P P8 `P%)
))9 Q        b                                G   G        h   I   h    
  h        h   I       s  F `P: `P@00@
@ `PO% `PK2 `PJ7 `PO; `P9 P `  `                             G      o              G            G               G         G                         J                       G            G         @ `P P= `PA F `P0 `P? `P? `P0 `P: `PJ 	`P0 `P0 `PA F `P1 Q        N                            G      o              G   o            s     @ `P P= `PA
 F `P,
P= `PO
 P   L   L                                  
     o  	  @ `P P9 P   @   @                                  	  s 0 `P+P4 P                                     c                h      h        h   I     h   I     h   I	     h
   I     h   I   h      h      h      h      h        h   I       s  F `P: `P; `P7 `P;000@ `PK `PK# `PO) `PO- `PO5 `POM `PO^ `PKx `PK   `PK   `PK   `PJ   `PO   `P9 P                                      *                      s       G                  $   	          o  	         
     @ `P0 `P9 `P= `PO	 `P0 `P,P@0 `PL P p   p   4                            G   |  }   
     G   s      	  0 `P/P9 `P,P4 `P; P  d   d   +                                    s         o  	  0 `P; `P: `P,P9 P  4   4   	                             0 `P7 Q \   \   !                                %H         0 `P0 `PA F `P1 Q H  H                               G   o           &         G   s     ^              G   |  }  K      .(   HG   s               s             G   G   G   s      s  @ `P,P= `PO `P,
P4 `P@0 `P P5 `P PD 	`P? `PO `P; `P P4 `P: P                                    G   o  @            .'   HG   s        	       s  
           G   G   G   s      s  @ `P,PM `P PD `P? `PO `P; `P P4 `P: P     #                         
          G   |  }                          *                               W            &HG      G   $            .'      K               .'      K      %K             s     @ `P PM `P> `PA F `P0 `P? `PO `PA F `P? `P0 `P@ `PL `P0 `P? `P? `PO P     e                            G           G              G           G           G     o                  /      v         G	   s     V        G
            G   s           G	   s                 M        G           G   s               I          @ `PF `P@ `P0 `P PH
 `P@0 `P,P4 `P6 `PJ0 
`P0 `P,PN0 `P,PI `P6 `PJ `P> `P0 `P*PI! `P= `PO$ `PA& V   (  (                  $         G           G      x       G         !   	      (
   &                                   s          $         .                         s                       s                       s X                         !      ["      #          s $   @ `P @ `PM 	`P@	 `P+PN `P@ `P+PN `P@ `P+PN `P@ `P+PN `P@ `P+PI! P  l  l                            G     G   G      h   s h        G   |       }      G     G   G         s   G     G   G         s   G     G   G   	   h
   s   G   G      I     G   G      I   @ `P PD
 `PJ `P 	PI `P P4 `P PD `P PD `P0 `P0 P       o                           G           G      ,        G   Y        G   Z	      
     G   s     @ 	`P0 `P*PI P                                      G   :       
  *       
  G     G   G   G      >   	    	     )                s      s     0 `P0 	`P0 `P; `P: `PO P  @   @                                    s 0 `P+P4 P   T   T                                 s      s      s  0 `P: `P: `P: P \   \   %                                      G   s     0 `P? `P,PI P                                          h           G   G              h      h    	  h    
  h      h      h	      h
        h   I     h   I   h       h   I      s  F `P? `P@ `P@ `PF
 `PJ0@@@@ `PK `PKX  `PK_ `PK   `PK h `PK  `PK  `PO  `PO 
 `P:000 `PO  `P9 P    (   (                                          M                           G     G   G   o G   g   o       G        o 0 `P P/P8 `P 	P6 Q                               G   s    G                   G   s       G   |  }           
    
      G   o     h        G         o               s       G           G     s    @ `P,	PD `P@ `P? `P,PI
 `P@ `P? `PA: F `P,PI# `PJ/ `P PH1 `P> `PN7 `P0 `P/PI: P        T                            G   s              G      s       G   s     s  @ `P,	PD 	`P? `P PI `P,P4 `P: P                                                 G     G      o o    G   o  s        G     G      o o    G   o  s    0 `P? `P )P#P/8P#P4 `P )P#P/8P#PI P                                                          G     G      %   %I     h   I	     h
   I     G      
     h   I        G           h   I      I        G     G      %   %I         h   I   I   I	      @ `P; `P: `PK `P= `P0 `PN `PN `P0 `P@ `P00 `P@%0 `P0 `P@) P    X   X   +                              G      G      %   %I   6 `P0 P  X   X   +                              G      G      %   %I   6 `P0 P  `   `   ,                            I        G   G   o  I   0 `P< `P 'P9 P       >                              G            G   s     	      s 6 
`P0 `P+PI `P*P4 `P1 Q (   (                                        /                          G     G      o o          I                     G	   
   o        I       G      o I      G     o          o          G	      o        I       G      o I       I        I       G   I         s   G     s           o    !      G	      o        I       G      o I       I        I       G   I         s   G     s /          o d   1          o K   3          o 2   5          o    7          o 8   c   9      G	      o        I       G       o I     G     s B          o    D      G	      o     !   I       G   "   o I       I        I     h#   I         s   G     s Q          o    S      G	      o 	  	  $   I   	    G   %   o I   	  
  I   	  &   I   	    G'   I       	  s   G   	  s a          o    c      G	      o 
  
  (   I   
    G   )   o I   
    I   
  *   I   
    G+   I       
  s   G   
  s q          o    s      G	      o     ,   I       G   -   o I       I     .   I     h/   I         s   G     s           o          G	      o     0   I       G   1   o I       I     2   I     h3   I         s   G     s        4   o K          
   o 2          5   o           6   o    c         G	      o     7   I       G   8   o I     G     s        4   o          G	      o     9   I       G   :   o I       I     ;   I     h<   I         s   G     s        
   o          G	      o     =   I       G   >   o I       I     ?   I     h@   I         s   G     s        5   o          G	      o     A   I       G   B   o I       I     C   I       GD   I         s   G     s        6   o          G	      o     E   I       G   F   o I       I     G   I       GH   I         s   G     s        I   o          G	      o     J   I       G   K   o I     G     s    G	      o     L   I       G   M   o I       I     N   I     hO   IP         s   G     s    G	      o     Q   I       G   R   o I       I   gS   GT     GU   GV   o  o          I   (       W    X   o Y   %I   	    Z   I     h[   IP         s   G     s  
   s    0 `P P#P8 `P? `P: `P: `PJ `P 	P8 `P? `P P9 `P/PH `P+P= !`P 	P8 `P? `P P9 `P? `P? `P0 `P+P4 `P/
PI `P+P= #`P 	P8 `P? `P P9 `P? `P? `P0 `P+P4 `P/
PI"0 `P+P>+P>+P>+P>+P00 `P 	P8 `P? `P P9 `P/
PI/ `P+P= !`P 	P8 `P? `P P9 `P? `P? `PO8 `P+P4 `P/
PI< `P+P= "`P 	P8 `P? `P P9 `P? `P? `P0 `P+P4 `P/
PIG `P+P= !`P 	P8 `P? `P P9 `P? `P? `P0 `P+P4 `P/
PIR `P+P= "`P 	P8 `P? `P P9 `P? `P? `PO[ `P+P4 `P/
PI_ `P+P= '`P 	P8 `P? `P P9 `P? `P? `POh `P+P4 `P/
PIl0 `P+P>+P>+P>+P00 `P 	P8 `P? `P P9 `P/
PIx `P+P= "`P 	P8 `P? `P P9 `P? `P? `P?00 `P+P4 `P/
P900 `P+P= "`P 	P8 `P? `P P9 `P? `P? `P?00 `P+P4 `P/
P900 `P+P= $`P 	P8 `P? `P P9 `P? `P? `P0 `P+P4 `P/
P900 `P+P= `P 	P8 `P? `P P9 `P? `P? `P0 `P+P4 `P/
P900 `P+P= `P 	P8 `P? `P P9 `P/
P40 !`P 	P8 `P? `P P9 `P? `P? `P?00 `P+P4 `P/
P40 !`P 	P8 `P? `P P9 `P? `P P#P= `P0000 `P/P00 `P? `P?00 `P+P4 `P/
P4 `PO   P    L   L                              G         o 0 `P P3 Q  L   L                              G         o 0 `P P3 Q  L   L                              G         o 0 `P P3 Q  H   H                              G      s 0 `P P4 P  H   H                              G      s 0 `P P4 P  @   @                              G   s  0 `P*P4 P    @   @                              G   s  0 `P*P4 P    8  8                  "           G     G      o o       G                g   G     G   G	   o         I
        G
               o    '        G   |h     }         s         G                   G       h   s   G        h   s   G   4        G   G        G   h   I   "   @ `P P#P8 `P0 `PAz F `P P= `P@ `P P0 `P 
PN `PJ `P: `P0 `PO `P PDe `P PDq `P0 `P0 `P@z P   H   H                                s  
   s  0 `P: `P: P                 	       t         G           G             G           G            G      o G   o       .                        	          
                          	   <        b                                                 F        l          	      G     G      o o s   "   	      G     G      o o s   (   	      G     G      o o s I  .   	      G     G      o o s   4   	      G     G      o o s   :   	      G     G      o o s   @   	      G     G      o o s m  F   	      G     G      o o s 6  L   	      G     G       o o s    R   	      G     G   !   o o s    X   	      G     G   "   o o s    ^     G#   <   `   	      G     G   "   o o s 7   f   	      G     G   $   o o s l      l    l     G%      n     G%   s  p   &      r   &   I'   t   @ `P@ `P0 `P P*PH	 	`P0 `PO 	`P0 `PO `P00 `P %P#P#P4 `P:0 `P %P#P#P4 `P:0 `P %P#P#P4 `P:0 `P %P#P#P4 `P:0 `P %P#P#P4 `P:0 `P %P#P#P4 `P:0 `P %P#P#P4 `P:0 `P %P#P#P4 `P:0 `P %P#P#P4 `P:0 `P %P#P#P4 `P:0 `P %P#P#P4 `P:0 
`P0 `P %P#P#PN60 `P %P#P#PI9 `P:0 `PAG F? 	`P0 `P*PIC 	`P? `P@G P                                G   (        G           G      t        G      
     G            >         6           G   I	   	      s    0 `P  0 `P@ 	`P0 `P0 `P0 `P+PI
 P        C                                s     "         G        q    < `P: 	`P? `P PC V    $  $                             G             o          G      h     g   G     G   G   G	   o  o E         7           G
      o I         s    @ `P0 `P@ `P@ `PJ `P $P#P= `P> `P #PI `P+
PI `P1 Q  @   @                                  I   0 `P@ P   \   \   %                                      G   s     0 `P? `P,PI P    \   \   %                                      G   s     0 `P? `P,PI P    8   8                                 s  0 `P: P                                               G   s        G   $         G   G      s          	      G      I             s 0 `P? `P,PI `P0 `P PI `P? `P@
 `P+P4 P                       
                   G   G         h   I      h   I      h   I      h	   I
      h   I      h   I      G   s  F `P: `P@ `PO `PO3 `POf `POq `PO   `PO   `P+P4 P                                  G      o              G   s        G   I      G      
      G               G                  G   I      F `P P= `PA F `P+P4 `P0 `P0 `P@ P                      /          G      o              G              G   	   ^   
      G   s        G   I         G   I         G	   I	          G
           G           G                      G   s     G   o        G         G   G   s    G         G   G   s    G         G   s    G         G   s    G   s  /   @ `P P= `PA F `P *@ `P,
P4 `P0 `P0 `P@ `P@ `P0 `PA F `P,
P4 `P,
P8 `P  P4 `P  P4 `P P4 `P P4 `P+PI P                      D            G            G      9            G   I         G   I   R  	     G   >          G      G   o I     G	           G
      *        G
        I	   #        G   G   o          G      G   o            %  %       I     G      G   o      G        G   s      I        G     o I        G     o   G   &I      G   G     G      G   o G   &    ~   6      G        G   s :     .(  1   =        %     G   %I   A        I   B     G   s  D   F `P@ `P0 `P@ `P@	 `P PI0 `P0 `P? `P@0 `P PM `P P8 `P: `P0 `P> `P PH `P *P4 `PN  `P P9 `P P@# `P PN% `P> `P *P4 fP0 `P6 `P@+ `P@. `P+PI0 P            H  C                                       G                G      G                  G   I   
      G   s        G   I   F `P0 `P@ `P+P4 `P0 P   p  p                             G   |  }          G      G   G      G   o o I         I        G      G   G      G      G	   o o I
         I        G      G   G      G	   o o I         G   I      @ `P@ `P .P#P9 `P? `P 1P#P9 `P? `P -P#P9 `P@ `P4 Q     5               '              G     G   %I       G     G   %I     G   y   
       G   G   g      o I       G	   G   g
      o I	       G   G   g      o I           G   G   I        G   G     G	   G   %I        G     G	   %  G   %I        G   I   F `P0 `P@ `P0 `P P9 `P "P9 `P PN `P0 `P0 `P0 `P0 P  (   (                               0        Q                                       G           o        G   G      h   o I     G           o        G   G      h	   o I               G          o        G   G      h
   o I     G          o        G   G      h   o I      F `P:@ `PM `P PH	 `P PI `P PH `P  PN `PM `P PH `P  PI" `P PH$ `P PN* P  T   T                                   G     %I      0 `P0 `P5 Q    T   T                                   G     %I      0 `P0 `P5 Q    T   T                                     G   %I      0 `P0 `P5 Q    T   T                                     G   %I      0 `P0 `P5 Q                                        G   G   g      o I     %         G      G   %I   	         G   G   g      o I     (            G      G   %I      F `P  PI `P= `PL `P  PI
 `P= `P@ P   L  ,                 I                                        .'   .'    G            G   g   s        G   G   g   	   o I       G
      G   %I
       G   G   g   	   o I       G      G   %I       G
   G   g   	   o I
       G      G   %I       G   G   g   	   o I       G      G   %I     G      0   	        0     .(  -   3         %        %  5       6         6       G   G      |      %	     }   o I   <     G      >   	        >    .( -   A         %        %  C       D         D       G   G      |   	     }   o I   I   F `P0 `PJ `P0 `PJ
 `P; `PK0@ `P0 `P PI `P  P9 `P0 `P  P9 `P0 `P P9 `P0 `P P9 `P@ `P@ `PN! 
fP0 `P6 `P@& `P= `PO) `P "P'PN, `P@. `PN0 
fP0 `P6 `P@4 `P= `PO8 `P  P'PN: P  L           =          z  =         R                           |      G   %   %     }        G   G         o I   0 `P0 `P "P9 P                                   G     s    |    %   %     }        G   G      h   o I       G   G   g   	   o I   0 `P/P4 `P@ `P "PI `P "P9 P        M                            |      G   %     } G     o                %0 `P #P= `PC F `P9 Q  \   \   '                            G             o o 0 `P 0P#P3 Q \   \   &                            G             o o 0 `P 0P#P3 Q  |  |                  F         G   s      G   G   g      o I     G   G   g   s    G	        G
   G   g   s    G	        G      G     G   o      "                            G   G           %   %   o    o I       G
   G           %   %   o    o I
   A  '     G      *     *      +       G
   G   g      o I
       G   G   g      o I      G	         G     %  %I      8     G      ;     <      =      I   >       @         @      @         G     %I         G
   %I
   F    @ `P*P4 `P "PI `P P4 `PO
 `P P4 `PO `P PH `P0 `P $P(P9 `P "P(P@ `P@ `P P9 `P P9 `P? `P@@  `P 0 `P@% `P0 `P0 `P@* `P1 Q    X   X                               G   g   h   o     @ `P PG `P3 Q         c                               G   g      o K 3            G   g      o K  %      0 `P P5 `PM `P P5 `PG F `P5 Q                     +          6          G     G      o I       G     G      o I       G     G      o I         g      h      h	         G   G
        o I               s -          G   G
        o I               G   G
        o I     G   /          G   G
   g      o I   !     G   /   #       G   G
   g      o I   '     G         %%I     @ `P7 `PK `P P9 `P P9 `P PI	 `P; `PJ `PK `PJ `P PI `P= `P)PN!0 `P "PN% `PJ' `P PI) `P0 `P PN, `P0 `P "PN0 `PG2 `P4 Q          L                            .'     G   g         %   %o           %%   0 `P? `P 
P7 `P7 P         >                             H+              Hs     % %     @ `P0 `P/P4 `PM F `P3 Q   H  H                            G   s     G   g   g   s    G   G   ^            G   G   g	   
   o I      
   I     G      s      g   G      G   o "        G      s     h            2        G             s o            2        G     
         s -        G             s       @ `P,P4 `P PD `P@ `P  P9 `P0 `P PN@ `P P= `P P4 `PA@F `PJ4 `P@6 `P PN8 `P0 `P PN;0 `P PI> `PA@V                                :              I   I                                 I           %   %I      G	               (         
       o I	   w            D                 
       o    I	     #         
       o I	      <                                         s  @ `PO `P@ `P0 `P@ `P0 `P0 `P P@ `P0 `P )P> `P@0 `P P@0 `P0 `PA F `P: P         E                             6   I      G      G   I      G      G   I   0 `P0 `P0 `P0 P          ?                            G   G   &               G   G   o      0 `P0 `P PC F `P3 Q   ,  ,                            G    I     G   G           G   s          	     G    I      h                  s  (        G      	      s    @ `P@ `P0 `P,P4 `PA& F	 `P= `P@0@ `PJ! `P= `P00 `P PI& P                                       G   |  }  I     G   G               G   |  }        G        G   |     }       G   s @ `P P9 `P0 `PA F `P/P9  `PO
 `P PI `P-PD P                                      	      
  h      h      h      h      h      h        h   I	     h
   I     h   I     h   I      h      h        h   I       s  F `P:000000 `P9 `PK `PK `PK, `PKP `PKf `PKm `PKx `PO   `PO   `PO   `PO   `P70 `PK   `PJ   `PO   `P9 P                           
         G         s    I      I     G         s   G         s   G   |     }    @ `P P4 `P< `PL `P P4 `P PD	 `P 	P9 P                                       G                       G           G   G      #   	     G   G      2        G           G   G            @ `PF `P0 `P@ `P0 `P@ 	`P0 `P@ `P4 Q      L                          G   G           G   G                  G   G   G                                                 |  }  G   o                 o           "         G	      o          |  }  G   o        &          s       @ `P 0 `PA! F `P0 `P0 `PA! K0 `PO `P PH `P? `P&PN `P? `P PM `P P8 `PO `P*P4 `P: P                                   $             s           
     o          
                        	     
    	     
             o       @ `P? `P+P4 `P@ `P@	 `PF `P0 `PO `P0 `PO `P/
PN P  |   |   >                  	         G     G              G     G     G   &*0 `P0 `PA F `P0 Q   4  4                    "          G   G   a        G   G     G   G   G     G   G   G   &      G   G   o )I        G   G   a        G   G     G   G   G     G   G   G   &      G   G   o )I   "   @ `P0 `P ePO `P0 `P bPO	 P   |   |   <                           $                s            s     @ `P= `P; `P@0 `PO	 P  4   4                                 0 `P5 Q   4   4                                 0 `P5 Q   P   P                               
     G   s  0 `P9 `P,P4 P                        3       	  G     G   G   o    o  &     G   G      	     G   G   G      =        G   G     I     G   G   I   h        G   g	   
   o       G   g      o      G   G         %   %I        G   G   "   !     G   G     I   $      s       &      &   	  G     G   G   o    o  &     G      .       h   s     0             &s 3   @ `P 	P)PJ `P@ `P0 `P@
 `P@0 `P P8 `P P8 `P@ `P0 `P@ `PJ `P? `P7 `PA* F  `P 	P)PJ" `P0 `PK%A# PN'0 `P PI* P   H   H                                       &s 0 `P P4 P                                   G   G                   G   G      s     s    G   G       
     G   G   I        G   G            G   G   I      0 `P0 `PA F `P P4 `PJ `P0 `P@ `P0 `P@ P \   \   %                                      G   s     0 `P? `P,PI P        W                 $           G   G   g      o I       G   G   g      o I       G   G   g      o I   g   G     G   o 1         G	            G	     s    g
   G     G   o 1         G            G     s    g   G     G   o 1          G      "      G     s $   @ `P P9 `P P9 `P PI `P *P= `P0 `P/PI `P P= `P0 `P/PI `P P= `P0 `P/PI P                       X             G   G   g   h   o I         G   G   g   h   o I         G   G   g   	   o I         G         
      I      G   3            G   G   g      o I         G   3            G   G   g      o I            G   G   g   h   o I         G   G   g   h   o I   h      g   G      G   o y   '     G        G   G   &s       G   G   g      o I       s    G   s  %  3         G   G   g   	   o I     G      s     s g   G      G   o    ?      G   @   3   A         G   G   g    !   o I   E   g"   G      G   o    J      G#   K   3   L         G#   G   g$   !   o I#   P   g%   G      G   o 3   T         G   G   g&   h'   o I   X   @ `P "PI	 `P PI `P "P9 `P@ `P0 `P PN `P0 `P PN `P PI `P PI% `PJ7 `P P= `P P4 `P "P9 `P&P4 `P,PN=0 `P "P9 `P P4 `P&PDB `P P0 `P  PNF `P P0 `P PNK `P P= `P "PNR P   l   l   3                            G    %I          G   %I    0 `P7 `P0 `P3 Q   T   T                                    G   %I      0 `P0 `P5 Q    H   H                                 I      0 `P> `P5 Q    H   H                                 I      0 `P> `P5 Q                                                               G   3          G   G   g   h   o I        G   3   	       G   G   g   h	   o I      @ `P@ `P0 `P  PN
 `P0 `P PN P  T   T   %                             G   g      o %   %0 `P P: Q T   T   %                             G   g      o %   %0 `P P: Q P   P                               G    %I      0 `P7 `P5 Q    L  L  <         	       K       g   G      G   o    g   G      G   o              	   $   
   g   G      G   o               G   G   g	   h
   o I       g   G      G   o            g   G      G   o               G       s    G   8            I             o I      "   g   G      G   o 8   &         G   G   g      o I   3   *         G   G   g      o I   .   9  .      G   s     G   g   g   s    G      5      G   7   [   8            I   I      G   #   <             o I   ?      ?      G      A      G   C   ;   D      G      G   %I         I   $   I            I   I   K   @ `P 
P8 `P 
PH `P  P@	 `P PI `P6 `PF `P P= `PK `P P= `PK `P PD `P0 `P0 `P P@0 `P P= `P "P@#0 `P "P@(@+ `P,P4 `P PD. `P 0 `P0 `P0 `P P@4 `P 0 `P7 `P@80 `P@< P T   T                                     G   %I      0 `P0 `P5 Q                        H       g      g              h      h        G   g   s   G   F      g	   G
     G   o #   	   g   G
     G   o    0        G     G   %I        I        G         g   G
     G   o        I       G   G   g      o I     G     s   G   s    .   "       G   G        o I   &           (    (          G   G      h   o I     G   !   .            o I   1       o           G   G     h   o I     G   s   G         s     I     G   g      o     G       G   G     G    &s     G   G   g!        %o I   @ `P: `PJ
 `PK `PG `PK `PK- `P PD/ `P  P/ P0 `P7 `P@4 `P@6 `P 	P8 `P> `P "P9 `P/P4 `P*PD< `PN> `P PN@ `P0 `PAe FE `PGG `P PIP `P0 `P.PNT `PNV `PGX `P PI^ `P+P4 `P P4 `P= `P P8 `P P4 `P "PIe P         _                            4            %   %      .'                %   %         00 `P? `P0 `P@0 `P@	 `P4 Q          R                               "      g   G     o         G   g   h   o     @ `P0 `P/PN `P PG `P3 Q  <   <                                o  0 `P&P3 Q          r                         g   G     o         G         g   G     o                         o 0 `P/P= `P@ `P/P0 `P)P3 Q x   x   A                         g   G     o                         o 0 `P/P0 `P)P3 Q              	       =          G   G   g      o I       G   G   g      o I     G   ?   
        I     	    
   o I        I            G   g   g   s g   G     G   o          G   G                I   I     G   g   s g   G     G   o             g   G     G   o    #      #          I   I     G   s       )      )      &*          ,        .         .      .       G   G          G   G      4      G   G     6        I   7     .(  #   :     G     %I   =   @ `P "P9 `P "PI `P0 `P> `P.P9 `P> `PA9 F `PF `P P4 `P P= `P@ `P@ `P P4 `P P= `PK `P P= `PL# `P0 `P,PD) `P@+ `P@/ `P0 `P0 `P0 `P@4 `P> 	fP0 `P@9 P            Y  5   h   h   /                              I        I     G   s 0 `P> `P> `P.P4 P  X   X   !                             h   I      G   s  0 `P@ `P,
PD P                                 h             G   s        G   s        G   s    I           G	      G	   G
              I
   0 `PJ `P/P4 `P/P4 `P/P4 `PL `P: `P0 P         S                                     [   \],            G           HK   ^0 `P= `PA F `P 4 `P@ L P               4   x  x  X                           G      G   6   h   9   h   9   h   9	   h
   9   s    G      G   G   6   h   9   h   9   h   9   s    h   I      G   h   I      G      G   6   6   6   9   6   9   6   9       9!      9"   #   9$   9%       c    o 9&       c    o 9'   9(   c    9)   9*   h+   9,   h-   9.   h/   90   h1   92   h3   94   h5   96   97   h8   99   6:   ;   9<   =   9>   ?   9@   A   9B   C   9D   E   9F   G   9H   I   9J   K   9L   M   9N   O   9P      G   G   Q   o 9R      G   G   S   o 9T      G   G   U   o 9V      G   G   W   o 9X      G   G   Y   o 9Z      G   G   [   o 9\   9   9]   6^   h_   9`   ha   9b   hc   9d   he   9f   hg   9h   hi   9j   hk   9l   hm   9n   ho   9p   hq   9   hr   9s   ht   9%   hu   9v   hw   9x   hy   9z   h{   9|   h}   9~   h   9   h   9   h   9   h   9   h   9   h   9   h   9   h   9   h   9   h   9   h   9   h   9   h   9   h   9   h   9   h   9   h   9   h   9   h   9   6   h   9   h   9   h   9   9   h   9   h   9   h   9   h   9   9   6   6   9<   9<   6   9@   9@   6   9B   9B   6   9D   9D   6   9F   9F   6   9   9   6   9H   9H   6   9   9   6   9J   9J   6   9L   9L   9   h   9   h   9   h   9   h   9   h   9   h   9   h   9   h   9   6   h   9<   h   9>   h   9T   h   9R   h   9V   h   9\   h   9Z   h   9X   h   9@   h   9B   h   9D   h   9F   h   9H   h   9J   h   9L   h   9P   h   9N   9   s       G   G   I    `P * *  *  *lP$ 
x`P *.*0*P$  `P   `P  `P %
**
*	***&+P(+P(&*
&* *  *q*  *l/o*I%
*#* *,* *"*+*&*#*6*-*6 P(4 P(0 P(D P(4 P(: P->&%* Z*  *  * l* *  *E*O*<*)*/*  *  * *1*h*  *U*T:   *  *w** (* *  * *S*\* *  **I*  *  *z%*1*H/<*  *x* /  %%
+%+%+
%+%	+%+%+%
+%+% *  *  * *  *  * )*  *  %	* ?* *v*v*  *P*P*h* * *c*o*w*T* w*  O   QP4  4`P P  D  D                 )             G   \        G        G   4         G            G      o          G      H   o                     G   |     H  }      G      H      s    G	   G
            G      o G      o G   h   s    G	   G   <   !      G      o G      o G   h   s '      G   h   s )      &`P `P 0P)<`P! ]&`P P)`P/`P% &`P 
P)!`P P$'`P `P P/P/P$3`P "`P P/P/P)1`P P) `P%Q    8   8                                I    `P,P   @   @                                    I   &`P/P  L  L                          h         G   G           G   s        G            I       o  	      G   o  ?         G            I          o           G	   s     *`P `P*P) `P `P,`P%P#  &i`P,
P-`P `P,`P!K&`P%P#6+`P,
P$`P!V  P  P                              G   G            G   h            o G         G   G   o G      G   G   o G	      G
   o          G   G   G         G
   r    G            G   s         `P %`P #`P+P P )P "P-!`P !P$)`P `P+P)
`P!&`P!Q                                          Ho G      o (         G   o  G   o  O   	            HG   o G   o        G   h   s       &`P,P/
P-`P+P*P#  +`P'`P P*P)`P P$2`P%V T   T   &                                 G      o    &`P P'P       I                          6              G     G   g   o h   s    &`P+`P*`P P(P$s`P%Q d   d   0                                G    o K   G    s  `P P%`P/	P$P p  p                 >           H            G      G      o G       G       G   G      o                                G	        G   G
    o s      G      K G   H        G      G     G	     G      G   H G   o K   i                  G   O       6        G    G   g   o h   s    %     G   G     G	   6     G   G      o   G   G      o   G   G      o   G   G      o o    o     G   H   9     G       M     G	   6     9     o   >     &`P+`P-`P P-8`P.!`P P)`P `P #P#P$:`P +`P `P "P*:`P*`P-`P/!`P% &>`P+`P P(P$x`P% E&`P 3P #P  P $P#P'P(  `P `P.`P*`P -P-`P$Q    L   L                                    HK    O `P '`P*P P   P                                G        G   %o  `P  P$Q  T   T   !                            G        G   %o  `P   P%Q   8   8                              G    `P )Q         T                	                G   6      G   G     o I       I      G   s  &`P P)-`P-`P+P$P ,  ,                               G         h         G          G      	   ,   
     G      o G   o      G            c    d          G    h   s    &`P `P% a&`P /`P 	P+P,`P `P% 	`P P$T`P%Q       [                              G     o       G      s   G   G   G        q ,`P P(`P P$`P P#Q p   p   :                            G      |     %   %     }  o     `P P&P))P                                       I      G   G            G               G   G   F   
      G   G   G           G   G      G   G   r       G	     o G
   s     &
`P-`P  `P 5P)E`P.P*P)P       y                             G     o :        G      G   !         G     o             G     s    &`P.P 5.P `P.P)P        W                	            G      G   !           G               G     s 	   &`P ;`P.P)P       |                            G      G   !!         G     s B        G   G      G   !!         G     G   s    &`P `P.P.`P *`P P)P   \   \   (                               o G    o G    s   `P)P-
P-P$P   \   \   (                               o G    o G    s   `P)P-
P-P$P   P   P   #                            G      G   G     s  `P P$&P     	               8          h             G   G   o I       G   G           G         	        G   o    I          G   G   o G	     G   G   o I
     6   I     6   I     I     6   I     6   I     G   s    6   I        G     G   G   h   s   G   G        G      h   s      G   o G            o G            s   G   G    :   2        G   o G!   "     G   G    s 8    `P P)%`P CP.`P P  P)'`P/`P/`P+`P/`P/`P+P$`P `P P$}`P `P P$ `P/P P `P$J`P `P/P P);P   \   \   (                           G    G   g   o h   s  `P P(P$@P  <   <                                  K `P/P    P   P   "                                G   G    o K `P P%P                                   G     HG      o         G   G   g      o %     G	     H-         G	     HG
        Hr    &`P P()`P P)`P =P)P ,  ,                                G   s     G      G      G   s       G   6      G   o I      G   o  :             G   o G	   
   c      d    s       G   s     G   o  &`P+P$`P P$%`P P)`P+P-`P/P 2)P)&`P+P$`P+P#Q                                   G   s         G   o  I             H4        G        Hs    .'        G   o  &`P+P$ `P&`P/P-fP `P P$`P `P+P#Q           7   C   p  p                            G     o       I     G     s         o I     G     o       "   
     G     G   O        G     G   K     G   o  0          G	   G
     G   o I	        G   s     &
`P.P'`P-`P.P$`P-P)`P.P(`P.`P (`P $`P+P-`P P.`P+P$`P$Q      <        
       !                   G     G      s   c    I      [   \]U           G   G   6         H9     G      o H9   s    ^    G	     G
   h   o I
        G   G   =        G   G   G       G     G   r         G   s  !   &`P/`P P$`P/"`P $`P //P*P$,f`P P.L`P 2P -P)P           H   ]   <   <                              G      ! 
`P /Q                                     G   G   '             G   o G   s        6   I      G   s     G   s     G   o  G	      G
   G   s &`P `P/P*P)`P/`P+P$`P+P$`P+P P$&P  L   L                                 G      G   o &`P P#Q       ?                            [   \]!           .'      ^    `P&`P $`P-,`P$Q           
   )   \   \   )                              G      G   o G   s  &`P P*P$P    D   D                                 G   o  &`P+P%
Q @   @                                 G   G   &`P.Q  <                           $      G   G                G   o  I         G   G      	      G   HG            c       o G      o G	   o  G
      s               &`P  `P P P/NP*P/P  P   <  ,                               `                              G         ?        G      G   h   o G               &`P/`P P `Q   D   D                              G   G      G    `P 'Q                                        6         c    o G      G   G   o G      o G      o G      G	   G
   o G   h   o &`P*`P+`P+P P/P/P +P/P#  Q (  (                                G   R         G   G   8         G   #   	      G         o       G      !2         G         o G	   o  o                   G   K&`P >P))`P  P*P#P `P!4&`P `P!Q  <   <                                  o H `P)P%Q l   l   =                                  G   G      %   G   G   %   G   o &`P P#MQ         |                              c    I      c    I      6   I          c    o I          c    o I          c    o I   &`P/`P/`P/`P/P)`P/P)`P/P)P   x   x   A                              G   s        G   o  G      G   o I   &`P+P$`P/P 	P)P h   h   1                             G   s        G     o I   &
`P+P$`P P)P                       C      $    G     o     G     o &        G     G   o H  	         o G   o          [   \]           6      9         H9        G	   G
      HG       G   G   g      o     G   r           "       "          <   $       G   G     G     o o I    ^*     $   +     G       s ^-      -          G   G   W   0      G   B   3      G        G   %   %  G   %   %  o <     <   ><   ^     =    =     G       o !   @     G!   G"     s C   &
`P.P'`P.P-`P P.'`P)P*
P(`P&`P `P%* )`P 4P/P(F`P `P&`P*
`P&`P `P !P#P)`P1   H   '`P.	`P P$`P1   @   '+`P0@   'P9 +`PK   &< 8`P.`P!N&`P/P-`P P)`P!Q          |                      }                                     G               G   G   4            o G   o    G   G   H             o G   o           ,         G            G    H   &`P `P!  &{`P P*P P*P-`P 2Q       b                	           G   G     H      :         G                         H	   &`P `P .Q          p                                     G   D           H              H      .'   
      & `P&fP `P `P)&&`P 6`P%Q               X                  	                    G      G     G    o    G      o    G   G      
     G                     G	   G
    H     G   %   %o &`P P (P#" P#  Q              	                  G      G   o    g           1         G      G     r    Y   	     G      o =         G	      G
        o  G   o         G   G   6      9     9   s   G     G      K  G     G      K&`P P(-`P*`P `P P ,`P/	P-`P P+P-:`P )(P$(`P $`P %P          T                	             G   G   6        G     G      G   G   o o   	     &`P `P P#P,,`P#Q x  H          
       I                  G      H        G      H    G   G   L        G   G   G       G     G   G     G   G   r      G     G     G	   s    .'   A     G   G
   0          G   G     G   o I        G   G   ]   "      "     G      H9   %     G     G      Hs    .'   +     G   G      .        G   o    0        H^   2     G   G   G          H  G   G     G   G   r    .'   =       G   G     G   o I     G   s    G     G   o G   s  & `P&fP !`P `P 1P)K`P P$^`P   `P `P P.`P  `P&fP `P P$`P .`P  `P&`P+P(fP `P P$`P j`P P)`P+P$`P P*P$P    x                      6  M            m   \   \   )                              G   G      G   o  o &`P %P#P#Q X   X   )                                  G   o G   h   o &`P/P/P#&Q <   <                                 G   &`P)Q                      V           G     o       G   k         G   o  G     G   G   s    G      o          G	    o             
     G   G   %   %o G   6     G     o 9   9   o G     G   G   o G	       !      !   o      G   G   U   %      G   o  G   o  G   
     G   G   %   %o G   o     1     G   G      o G   f   6     G   G   2   9     G   G            o s    =      G     s ?   ?       A     G   G   C      D      G      s   G   G      +   K      G     G   G   s !   O     G   G      s R   R       G   G      o I   &`P.P(`P `P+P P$#`P P P `P P/-.P(&P 4P #P(`P `P+P*P P*%P-`P P `P @P#P 'P.`P !`P P$	`P -P .P.`P P)P   t   t   <                             G     o       G   o  G   h   o &`P.P)`P+P/	P#6Q   \   \   *                                 o G      o    &`P*P/P)Q          r                             G     G   HS         G     o         G   %        G      
     G      &
`P (P :Q H   H                            g   G     G   o  
`P P#Q         C                             G            G      o o G   h   o &`P/`P P#P/$P#\Q    x   x   M                          G      '       G                          `P =Q                                 G   G   o               +      l              o G         G    o 5   
      G    G	   o G
      o G        G   &`P/P `P.P(  &`P.P-`P P/P(/&`P(Q |   |   I                             G     H(         G     H   o          &`P) ,P Q  0   0                                `P#Q   P   P                                   G   o G    `P   P*Q   8   8                                o  `P'P#Q       Z                
             G   G   G   G         G     G   o   r    
      
   &
`P  *P&P @Q       R                             G     G   H4         G   .'I      G     G   K   &`P `P `P !P       Y               %             G   .(I      G            I         G     G   O C         G   -         G            G   o     7             G   o G   s     I          *         G            G      E             G   o G   	   c      d    s    I   %   &`P `P `P `P %`P 8P `P/P*P$	`P "`P 4`P/P 2)P$&`P P       r         
                    G        o N         G        6   9   9      G        o 9   o    &
`P 	P ?&	& P(P(bQ       Z                	            G               G      K%         G      G     s 	   &`P HP))P        n                 	       6           o G      o       2        G      G      o h   o 	       `P+`P)P/
P(`P P(P)  `P%Q         S                	                G   G   !3        G        G   G      Hs 	   &`P '`P P)3P    P  @                         6            o      G   G   [   \]U              G      o                   K      ^   G   #      g   G      G   o             M          `P*`P)P(`P `P 	P(`P.`P ,f`P (P `P/`P$Q   P        +   ]                                    G         6         G     G      o G   G         *   	         o G   o     H             o G   o      `P `P%&`P P -`P P*P P*P(Q                               6         G     G      o     G   G   O         G   G     G   G     G   Ho       6	                `P*`P P("`P `P P ;`P$Q   t  t                            G      h   s   G      h   s   G   c      d       d      d      d   h   s   G   c   	   d    
   d   h   s   G   G            G            G      N         c      G   d       G   d   I
      M      M         G            G      N         c      G   d       G   d   I	      M      M         G            M          `P P$ o`P P$h`P ***/P$j`P */P${`P !`P `P*/
 `P+`P `P "`P*/ `P+`P `P `P `P%Q        C                                   O     G          G                G          	      @   
   a   
       G      G   o G      0       G   G         r             I            G             G            K           O    `P/`P*`P! +&`P %`P&`P !`P 	  P/#`P*`P P(`P*
`P.
`P 7`P/P  x   x   E                                G    o            o           K `P P P P  p   p   >                                 H(                      Ho K   &`P `P P*P       d                                 HN            c             HHo d              HHo d   K   &`P `P.P(P/P         Y                              E      6        G     G   g   o h   s            
`P '`P+`P P(P$;`P.`P#Q    <   <                                    K&`P,P                                   G   G      K   G   G                         G   G     H   K G   9         G   G        G   G     o s     `P !`P T`P `P +P#P)5P  t  t                             G     o              G   G   o               O      |           o G   o                 G           G	    o !        G
      o       G     o G   &`P P-`P%  &,`P/P $`P)P*
P(`P   &`P.P-`P P%B&`P/	P*Q       6        
       <           G      o               G      o      G   G      G   H)   
     G   G      G   6   K        G   G      G   HG   I	     G   G      G   H   G
   I             6    9          !    !       G         $         I          G      s 6            G      K  G     G   6    9      9         G   %9      9      9   h   9    o s    .   7     G      G   H   ;      ;      G   &`P P-`P% &f`P P)`P &`P (`P E`P =`P   `P `P !`P*`P P$`P*`P `P (
* *)
-P#P$ `P%\+`P `P%'&`P*Q     }         	       !          G   G      G   H   G   I           l         G        G      s      I      G   G	      s    G
   s        6          $         G         o    I          G     G     o             o            K   G
     s          I      G         s  `P T`P*`P.`P/`P 
P$`P/"`P P$`P,
P.`P*`P %P "`P P P `P 
P)`P/`P 
P$P       P                             G    o 2         G      G     o  o     &`P.P $P&P,(Q         P                             G    o 2         G      G     o  o     &`P.P $P&P,(Q         p                           G      G     o  o      G    o *          H   
       H   &!`P P&P(!`P.P 8Q  `   `   0                             G    o             &`P.P  Q    `   `   0                             G    o             &`P.P  Q    t   t   F                             G    o (         H         H   &`P.P 6Q  p   p   ;                             G    o       g   G     o    &`P.P  P(Q   p   p   ;                             G    o       g   G     o    &`P.P  P(Q         I                             G    o +      g   G      |    } o    &`P.P. P#P)Q    l   l   ;                             G    o       g   G     o    &`P.P 5P(Q  l   l   ;                             G    o       g   G     o    &`P.P >P(Q  l   l   ;                             G    o       g   G     o    &`P.P P(Q      <        
                 G    o             g   G     o                   G   g      o     G   &  
             G	     o   
      
o     .        )  	        	&          %         .(  d      
+&`P.P-`P% 8&`P/P-`P! &`P&	`P&`P&`P P' `P/fP `P.P(`P,P(`P.`P `P+`P&`P *`P   `P)Q                                                       &       G   g      o                 G    o 9        G      |	    %
   %     } o    &`P  P "`P.P P#P('Q        H                            o G      o G      h   o         G   o   !`P)P/P P(>`P.P$Q   L   L                                   o G   s   `P+P*
P$P    d   d   ,                            G      6         h   I    `P `P+`P  $P   4  4                                G        G   6      G     o o     G        G      Z   
         H            HG   s              G       q K      G       q ,`P P#P'?`P-`P `P `P P)	`P "P$:&`P P#Q                                 G   G   G   5         G   G   G            G      8         G   6	      9
      9   h   s       G      G   6   h   9   s  `P  ;`P */P) `P *P$  P    x   x   E                         h        G   G      6   h   9   h   9   h	   9
   K+`P *@*F,  P P   P   !                              G         s &`P P$(P   P   P   !                              G         s &`P P$+P         ^                
                 G   G     o K   H   I     G   G   G        q ,`P P%`P `P P#Q       Q                            G   G     o        I     G   G   G        r &`P 
P'`P.`P P#Q   L   L                                G    h   o &`P P#xQ        W                              G   o       G      o "         G        q    &`P.P(`P P-`P P#V      	                        h      h      h      h      h      h      h     h      h	      c   
   d      c   c     d       d   d       d     c     d       d     c     d       d     c     d       d     c     d       d     c     d       d     c     d       d     c     d       d     g   	  g    	      6   c     d      d     d        %d     d     d   9   9   9   9   9   o 
  6    
     
  c      d    s        c    c
   c      d    g    d   d    c   !   d    g"   d   d   c   #   d    g$   d   d   c   %   d    g&   d   d   c   %   d    g'   d   d   c   (   d    g)   d   d   c   %   d    g*   d   d   c   +   d    g,   d   d   c   -   d    g.   d   d   c   /   d    g0   d   d	   o c   1   d    2   d   3   d   4   d   5   d   6   d   7   d   s        c   c      d    g8   d   9   d   :   d   d    c   ;   d    g<   d   9   d   =   d   d   c
   c   >   d    g?   d   d    c   @   d    gA   d   d   c   B   d    gC   d   d   c   (   d    gD   d   d   c   +   d    gE   d   d   c   +   d    gF   d   d   c   +   d    gG   d   d   c   -   d    gH   d   d   c   -   d    gI   d   d   c   -   d    gJ   d   d	   o c   K   d    s        c    c   c   ;   d    gL   d   d    o c   M   d    s        6N     9   9   9   	  9O   o c   P   d    Q   d   R   d   S   d   T   d   U   d   s        6V   W   9   o c   X   d    s        6Y     9   9   9   9Z   	  9O   o c   [   d    s        6\     9   9   o c   ]   d    s        6^     9   9   9   o c   _   d    `   d   a   d   s        6b     9   9   9   9c   o c   d   d    e   d   s        6f      9   9   9   9   o c   g   d    h   d   i   d   s        6j     9   9   9   9   o c   k   d    s        6l     9   9   9   o c   m   d    s        6n   o   9   9   9   9p   9c   9   o c   q   d    s        c    c   c   r   d    gs   d   d    o c   t   d    s u   hv   Iw   u   hx   Iy   u   6z      9{     9|      9}   @   9~   ;   9   #   9   !   9      9      9      9      9   (   9      9   r   9   >   9      9   I   @  6`P%/0`P%%)?/f`P%)/ `P%)? `P%)/ `P%)/P`P%)? `P%)/  `P%)/B`P*s`P+`P*%
)))5*).&&&F  qP8 R`P+`P.*P$`P %*/%*/%*/%*/%*/%*/%*/*%*
/2%*/0%*/P3%******J lP4 <`P %***/%*** 	%*/%%*/*%*/*%*/%*
/%*
/%*
/%*/%*/%:O >P3% J =P4 +`P %*/P(*P$(`P/)&&)P(;******P$]`P/*P(!*P$+`P/)&&&)P(N*P$V`P/)&P(#*P$-`P/)&&P(5***P$I`P/)&&&P3%*J  P4 `P/*  &&&P(  ***P$ 	`P/)&&&P(F*P$N`P/)&&P(4*P$<`P/:'&&&F  P3%`J  P4 k`P %*/P(*P$'`P   `P@  B`P**))*****:****** P   0    ;                -      h      h      h      h                  G                      H    G           R      g   G     G	   G
   g      o o                    .'  _   6   9   	9   
9   9   9   9      c          G                      H    G           G                     %o !     G            o %   %s   .'  c(         G      o      ,         ,      ,   o @  F `P'`P'`P&`P&`P-	fP `P-`P `P `P P#P-G`P'`P&`P*x`P   0`P%'''''-`P*`P&`P-	fP 
`P-
`P `P P)`P P*P$`P O`P P P#Q 0         R             O                                  G   o       \              G   o        H                          
           (            G   o o j                         )            G   o o         G   o     `P+P(`P `P$  &}`P+P(
`P +P%P 7P%P P(Q                                  D                               G   o %      G     o        <           (                   	                 %        `P `P P$^&`P/	P'`P $`P 	`P#Q t  D                          G     G   &o G   g   o    c      c         H                           G            $          H  g   G     o !        G     s            o     %        	        %H   4               %Ho     %                   G   c     d      d   s   A  %     z   '     Aj   )     ZX   +     G   c   
   G   A  o  d    
   G     Zo  d   o 6     aj   8     zX   :     G   c   
   G   a  o d    
   G     zo d   o E   E     .'  G     G   h   s c       c      d       d       M       G      P       H    H  H%0   V     
   G     H  Ho K    \      G       s ^     .'  i`   c      d           b     G      o d     G   G       q   g        G      j        H    G         Ho s   H  H[   s     H%  H   x     G   	   o z     G         Ho o ~     .'  =     G      s   G      o  	 `P P/P8`P)`P*`P `P `P.	fP `P.`P P-`P.P.`P*P(`P  P(
 
`P ))P$`P   P+ P+P),  P+ P+P.,`P  `P P$3`P*`P%*/	`P&fP `P. P P)`P =`P%/`P P)
`P P$`P&fP4 `P. P#P$  P)
 P#P)`P Q`P P$
`P 	P#Q   t            3                          T   T   (                           H H&       H  H&    `P Q   X                    b        G   G   g   o       G     c                            H          
     .'  h           G   o I        G   o   *                    K     .'  B            G   L          H              .'   K"     .'  $       $          &        H       D   )     .'      H   .        	   K/   u   /        G   o V   3     G   o   7   7       #   9               H%K<     .'  
>       >       d   @   
        H5   C   
        %H   G           KH     .'  J     G      L      L      M     M          O        H    G   o     G      U        V   %   W              o K?   Y        ,   [          G   g   h   o K^     .'  1`      G      o  	 `P 	P(r`P.`P*`P&`P&fP `P.`P P/,P `P Z`P&fP `P `P `P*fP `P. 	+) P? ,P@   `P0 0`P*fP `P `P +`P `P&fP `P.,P'
 P P*`P   `P 	P#Q X         @               `          }              s          ,     p   p   ;                  	         G   o         G        o %   % `P+P'`P P*Q      -                       h      g      c          c            G            G   G      N         G   :   	      G   G     	   o G
      o          "            G   o             s 6      G      o G   g      o 9      9   ; `P+`P+`P'`P+`P'`P \P/P-'`P P/`P)P$`P% P 	P(*Q                        *      %  G                    G     G   o              G            +             s    G      	     G                           S            	   K      "   .'   K      .'   "  K           G
         G            '         G   g   	   o "         G   g      o                 K      "   K      G   %         .'   "  K*   *    `P `P P-`P*
 `P-fP.`P*P$`P `P-`P `P 
  `P*`P-  P P-  
7 P                     U   5         V                  	        L      6    9     9         s  G   G      G   q 	    `P.%(,W$ P)P   x   x   7                         h      6      h    s     G         ;  `P+`P6   P$	`P 	`P%Q x  X                  W        G      c      d       d         G   G      o       c         6         G     	       |         H      H  	             
            G   o H    3        G     Ho 	    H        
     
     `         
  H    G     Ho 	          H         
  .'
  "   	     #        #   #     G   "   &   	     G
   o )   
  -   *   	     +   	  H   .   /      0   
       0   
     1         K2   2           G   %  
  1  5   	  H
    G   
  o     
  G   %  	  H8   <     G   	  HG   &    
  G   &  B     G
   o           %  G
     o      s         %  %
       
  o   s         %  %  G
     o      s &   Q     G        %  s T     .'  zV       I    	 `P-`P%)/	`P&`P P `P*`P&`P.	fP `P.`P.`P'`P5 	`P `P P)`P.`P P( `P&fP `P/ P `P+`P*`P -`P `P P / `P&/`P `P)`P&`P.`P+`P/P(`P `P   `P-P(`P P,P$`P 
P'P$`P 
P,P. `P PI   `P0  `P-P    x         <  p               (    n                           G      o    c      6          G                       H    H    V   
     G          .(  ,           G     o   K     H       %    G     o ,        G     s        K     .'       G   g	   s      o      `P P8 `P*`P*`P&`P.	fP `P.`P,`P. `P.	fP `P P `P+`P/`P/P./P$ `P `P P$`P*P)P    (            >          A          ]                e       c       c        G   J         G   c      d    g   d      d      d   s         G   J   
      G   c      d    g   d      d   	   d   s E         G   c      d    g
   d      d      d   s      G   <        G   c      d    g   d      d   o      G       )       G           J         G   c      d    g   d      d      d   s E   "      G   c      d    g   d      d      d   s &     G   c      d    g   d      d   o E   *      G   c      d    g   d      d      d   o .     G   n   0     G   c      d    g   d      d   s   G   c      d    g   d      d   o 8     G   2   :     G   c      d    g   d   o =     G     1   ?     G   c      d      d   o B        G   %G   g       o     G!   c   H     G   c   "   d    #    $     G   g%   &   o %'   %o d      d   o R      G   c   (   d    g)   d      d   *   d   s   G   c   +   d    g,   d      d   c      d    g-   d      d   c   (   d    g.   d      d   c   +   d    g/   d      d   0   d   c   (   d    g1   d      d   c   2   d    g3   d      d   s          o  `P*`P*`P **  **WP   *:*J   P= **?**P)U`P ***P)/`P-`P  **(**P D**c**P)w **G*P `*:*J  P9 	`P  ***P$  ***P)+`P **P) Q`P *)P)`P0E  P7 `P * P*P(/*P)?`P ****P$%`P **/**'/**/**K*/**/***P$ `P.P#Q                 
       D      h      h      g      g        G        G            G   G      N         G	   :         G
   G	        o G      o          "            G   o          G      o         G   &         G     G   s    c      d                 G   .               Hs   .'  !     $   $      HG       o '      G      o        I      G    &o    0   0          G     1          3        H             %
+%I      G   -   :      G      G      o o >     G      s   .'  bB     G     s @   `P+`P+`P.`P UP/P-'`P P/`P P(fP `P P. `P%/`P&fP `P P$`P `P0C  P9 	`P P(`P/ `P P `P&`P/	fP `P/  P#P)&/P$`P k`P.P$P             4          N  C          3                         -      %  G                    G     G   o                 G   J            s   G            G   G     o    G        G          (            s   G	                       G
         G      o              G     G   o       I
      G     G     HG   %o    8   "     G   G      G      o   G	   o (         s       *     G   G     o -   -    `P `P P-`P*	`P `P)P4 P `P,fP-`P)P$`P `P*`P/
`P-`P P(`P.
`P P(`P-`P P =P+P)0`P)P$`P P.P                           1   <                           h            G   0        G                          G   o        G         
      G                      G     s ; fP `P,.`P!U  `P/P'fP !`P `P/P$P  <            ?          e   D   T  D                                  G   o                 G                   o     G       G      s     	     9   
     G       G     s            `P P `P-`P.
`P+P(`P-`P/P$ `P)fP.`P./P$`P %`P$Q   T            C                                G            .(             H   
  G     o A   	      G   #         G        o           
      K   k     `P-	fP `P-`P P *P 5P                        z                  
                
  G     o    C      g   G    o    	         	      	     	    
    H 
`P//P `P/
P (`P)Q    @                    {      $  G            G   o     G         I       G   I     I            o    s g   G      G	   o   g
        G       G         G       G         G       G   	      	    K
         	            H    %HT        
  .'
      .'  HK  
  .'
      .'  HK   (     %  )   g)   
  	  
    )     	     +       H      %H    %  /     %	     2       %H  5      6     %  7     
  .'
    K  
  .'
    K    6=     
  I   >       2  @       %H   C     C         %H   F     F        G       o       %H    G   %   N     G       o   P   #  Q     &   R     G         o   T       I     G       G      o         %HI     G       G       s   G     s     Z   b       %  G     G       o o   K  G       G   o k   k              m     %  n          p     %  q   q      q               !]   t      G!        w     G"   x      y     G"      z     z   o {   {   0`P.`P.P(`P.`P-`P `P*`P.P'P$
`P P(`P*`P-`P.`P&`P-`P.`P&`P-`P.`P%`P.`P*fP `P   `P)`P*fP  `P.`P 	`P,fP `P `P 	`P 	`P `P.fP `P `P `P P(`P `P P `P P-`P4*`P.`P P(`P `P.`P P$`P/P$`P  P#P)! P.`P)`P+`P +`P P/P  @         z                        M                        A                     }                           G      o         I                  o        6    9    9      9   s    G    `P 	P(`P-`P P)`P+(()P$`P)Q         j                !      h      c      G      o d       G      o d      G      o d      c                 G                HG            8         G        H  Hs   .'       .'  r   	      
         G         6   h   9             g          s  K  `P% 	P( 	P( 	P-`P+`P&fP  `P&`P fP `P P$`P `P <`P*`P+`P  *`P'`P+!`P*P                G          q                          _          G   "         G   o   %                        G      
      G   o                   H    G       G      o        G	      o       S             G
                  G       4                           b        H       	  G     G   o    $        $     $      $     $       G     /%          '      '     '        (        G   *     *     '   +     G   G	      o   .        /     H  0       G     1        2     G      4   5     G         8     G      :   9   ;     G   %   =     G   G      o A      B        B     G     >C        D     G   G	   g   o   Q   H     H   J     HG   L      M     H   O   O      O   O        P          o Q   6     9     9     9            o V   V      .'   X         G       [           s #   ]         ^       o  _     `P $P fP P `P `P.`P P/"`P P(`P0 `P) `P'	`P.fP.`P.`P P `P O`P  `P P-
`P `P&	`P.fP.`P TP `P&`P*x`P   `P/ P 4 P)%))/[N   `P0  `P0C  P= P)P             
                        @   *  @   @                                |  }   `P *P$Q         \                                 I      6   I      c      d       d      d      d   I   6 `P? `P? `P9 : : : @	P          Q                            G        G         G      h   s   G      s 6 `P? `P> `P PD `P P4P   D   D                               G    s 0 `P/P4 P   P   P                                  G   G      o 6 `P P3Q    d   d   /                            G         G      o    6 `P> `P P9Q    @  @                 %           G        G         I      [       G   s     G     s      $   
      G      s 2                    G      s      G	   o  n           $         G
      s 2                    G
      s    &        G     G     Hs      G   G      6     9     9   s %   6 `P> `P> `P= `P> `P+P4 `P.P4 `P0 `P P> `P0 `P PI `P+P= `P0 `P P> `P0 `P P@0 `P PI `P05%)H PIP       V                              G   o  #         G      s          G      s    6 `P+P= `P P>0 `P PIP         j                           G   G      o       G                    G          G     s 6 `P P8 `P0 `P.P4P    P   P   #                             G      G     s 6 `P P4P D   D                                G      K6 `P0P       k               "            G      o         I     G         6            G                o 
   I       G	             
   o    I	      G        G   s    G        G	   s    G        G           G	      s    G        G           G      s   G      s F `P P8 `PN `P@ `P /P> `P 1PN
 `P P4 `P P4 `P P4 `P PD `P/P4P       I               6             I   6           G      o              o    I        G      o           	   o    I
        G      o          G
      I        G      o          G      I        I     G   o  b          G   ;        G      o    !         !   
   !   I   M   "       G      o    %         %     G   &   I   '     G     G   s   G   o  :   .          G   h   s   G   h   s 2           G   o  s 6 `PM `P: `P P P> `P  P P> `P  P0 `P !P0 `PN `P+P= `P &P00 `P P@ `P PD `P+P? `P: `P/PD `P/PI* `P 'P#P4P         ^                            G   o        $         G      s          G      s    0 `P,P8 `P> `P P>0 `P PI `P1 Q         ^                            G   o        $         G      s          G      s    0 `P,P8 `P> `P P>0 `P PI `P1 Q         E                             G      r    G     s       G   o  I   6 `P P4 `P.P4 `P/P9P         K                            #         G      s          G      s    6 `P= `P P>0 `P PIP @   @                                  I   6 `P=P    <   <                                 G   6 `P9Q   H   H                                     h   6 `P: `PEQ         y                            G   s     G   o        K         G   o           G   s     
      G   s     0 `P,P4 `P,P8 `P> `P,P= `P+P>0 `P+PI
 P         N                  	                  o G   o  G   h   s              s  	   0 `P7 `P+P*P/	PD	 `P? `PO P        V                	                  o G      o .             o G      s    	   6 `P*P/P= `P*P/P4 `PL P       Z                                   o      G             o %   %   %	   %   %
   %s 0 `P 
P9 `P?+P:666F PDP   L   L                                    o G   s  0 `P+P*P4P    X   X   &                           G      o G       s 0 `P/P P4P   <   <                                  s 0 `P*P4P  <   <                                  s 0 `P*P4P  h  h                               s    G   G                     %                 G   6   9	                 6
      9                 6      9      9         %9   h   9   h   9   h   9   h   9   s 0 `P)P4 `P0 `P0 `P? 6 0 0 : ? J J J/ J 	PD9P    `   `   ,                               o G      o G      s 0 `P)P/
P/P4 P       S                 
             o G      o       G      s    G      o G   s  0 `P)P/
P8 `P 
P4 `P 
P*P4 P    t  t                  ,        G      o G      o          #         G     s              x   
    G      o G      o     G	   !        G
     s          G     s         G   o  G      o     G	          G   o  G      o     G	   H   "    G      o            %   %o G     s *      *     G
     s ,   @ `P/P/P8 `P0 `P.P4 `PA K `P0 !`P/P/P8 `P0 `P.P>0 `P.PI `PA F `P*P/P8 `P0 `P*P/	P8 `P@ %`P/P8 `P P-$P@0 `P.PI P         P                                   o s                s         G   s     0 `P/P#PD `P? `P)P>0 `P*	PI P x   x   8                              o          G      h   s    0 `P)P8 `P7 `P PD `P5Q d   d   /                          G      G   G               0 `P0 `PL P    `   `   ,                              o       G      G   G   0 `P)P8 `P0Q                                     G     o     G      G   G   P   	           	   
      G   G   o 6      G   G   9   o    0 `P/	P7 `P0 `P6655O PC	%0A PIP                                  G     o      G   G                 G      	   9   
           	   
      o c      d    o    0 `P/	P7 `P0 `P@ `P6655D PC%I PIP  \  \            	                 G   G         G     o      G   G      ;               %	   %o G
   o  G             G                         :                       o 6      9   o    0 `P00 `P/	P7 `P0 `P P*P00 `P@	 `P0 `P6655D PC%9A
 PIP  h   h   /                          6   h   9   h   9   h   9   h   9	   0 `P5 J J5 J= JNQ                                 6   6      G   G   9   i9   9   9	   9
   6      G   G   9      G   G   9   9   6   9      G   G   9   9   0 `P5 5 0 7 6 K 5  
 0 @ 5 6 @ Q      ?          	       8        6   6             o %9      G   G	   9
      G   G   9      G   G   9   9   6             o %9                    G   G   o c      G   G   d    o 9   9   6             o %9                    G   G   o 6      G   G   9    o 9   9!   0 `P5 5  P9 0 0 @ 5  P9 6655O $PC%%@
 PM 5  P9 6655O $PC%%0A PM  Q d   d   +                          6   6   9      G   G   9   9   0 `P5 5 6 @ Q          t           	               6   6             o %9           	   
      G   G   o 6      G   G   9   o 9   9   0 `P5 5  P9 6655O $PC
%%0A PM Q    \   \   *                              G      r       I   6 `P P4 `P?P @   @                                  I   6 `P=P    h   h   2                             G   G     s    G   G   s  6 `P P4 `P P4P                                        G        G        G   6      9   6      9	   9
      9     9   9   h   9   s 6 `P: `P> `P> `P0 : %> : 9 6 J PDP          `                  
         G   '         G     G   s 0             G   o    G      s 
   0 `P0 `P P>0 `P P PI P      p               (             I      G   G   G       r     G      o I       G   	   o I
      |  }        G      s    G          o s    G     G   s    G   h   s    G   o            o G      o G         s        o G      s      I          G   h    s 6 `P= `P 'P4 `P P9 `P P9 `P0 `P P4 `P P#P4 `P P4 `P P4 `P,P8 `P*P/P P4 `P+P.	P4 `P? `P: `P PDP   @   @                                G   s   `P,P$P    @   @                                G   s  0 `P,P4 P  p   p   9                              G      r    c    I         I   6 `P P4 `P? `P?P p   p   9                              G   G   G      r    G   G   s  6 `P &P4 `P P4P  H   H                                     h   6 `P: `PEQ                                      G   6      9   9      9   	   G
   G   9      G   6      G   o  9      G   o  9   o 9   h   9   s 0 `P0 : 6 : 0 0 ,P8 ,
PH PH
 J 
PD P  H   H                               G   G   s  0 `P P4 P    $    c               +          G   G     G   s   G   G     G   s            G   G   5        G      HG   s     .'                 G	   G         
   |  }      G   s   G     G	      Hs   G   G     G   o  s   G   G     s    .'   Y(     G   G   s  6 `P P4 `P P4 	 `P&fP0 `P PD +`P@ 	`P&fP0 `P0 `P,P4 `P P4 `P P#P4 `P PD &`P@ `P P4P $         D   N                P   P                                  G   G      s 6 `P P4P    d  T                                       G   G   5        G      HG   s     .'   
     G   G      s   G   G      s   G   G      s   G	   
       o s   G   G   s  6 	 `P&fP0 `P PD +`P@ `P P4 `P P4 `P P4 `P P#P4 `P P4P d            N   <   <                                 G   6 `P9Q   H   H                                 G   G   o  6 `P P3Q <   <                                 G   6 `P9Q   @   @                                  I   6 `P=P    H   H                                     h   6 `P: `PEQ                                    G   o       G   o        m         G   6      9   9   	   9
      G   G      %   %9   h   9   h   9   s    0 `P,P8 `P,PI `PO `P0 : 6 : 0 J J PI P         Z                  
         G     s   G      s   G          o s   G   s 0 `P/P4 `P P4 `P P#P4 `P-P4 `P1 Q          B                            G   s    G          o s   G   s 0 `P,P4 `P P#P4 `P-P4 `P1 Q @   @                                  I   6 `P=P    <   <                                 G   6 `P9Q   H   H                                     h   6 `P: `PEQ         \                            G   o  #         G   o              G   o            s  00 `P,P= `P,P00 `P,PM `P9 `P1 Q H   H                                     h   6 `P: `PEQ         B                             G   s     G   s     G   s    G   s  0 `P,P4 `P,P4 `P-P4 `P,P4 P                    o        
  
  G      o    
  G      o     G         s   G       	   G
   G   o s    G     s 
  G      o     G         s   G         s    G     s 
    I   
  G      o      G     s 
    I     G   s  
  G      o     G     s 
    I   
  G      o     G      s 
  G   G     s 
    I   
  G      o     G      s 
  G   G     s 
  G      o     G      s 
  G   G     s 
    I   
  G   o          o 	    G   	  s   G     s 
  G       s 
  G!   "   s 
  G#       $   o s 
  G%       &   o s 
  G'   	   G
   G(   s 
  G)   
  G*   o  s 
  G+   
  G,   o  s -   G.   G/   G0   
  r 
  G1   G   s  
  2    3   o G4   5   o I6   2    7   o G8   9   c   
  d    s F `P P8 `P P8 `P P4 `P P#P4 `P/P4 `P P8 `P P4 `P P4 `P/P4 `PN `P P8 `P/P4 `P> `P+PD `P P8 `P/P4 `PN `P P8 `P P4 `P P4 `PN `P P8 `P P4 `P PD `P P8 `P P4 `P P4 `PN$ `P+P8 `P,P8 `P/P4 `P/PD) `P/PD+ `P P4 `P P#P4 `P P#P4 `P P4 `P P#P4 `P P#PD2 `P +P4 `P PD5 `P/P/PI7 `P+P A)P4P   H   H                                 G      r 6 `P P4P 0   0                                 0 `P6P 0   0                                 0 `P6P 0   0                                 0 `P6P L   L                                    G   o  I   6 `P/P9P        f                                o       G   s     G          o s    G   o  G   o G	   s  0 `P+P8 `P+P4 `P 
P#P4 `P+P-	P*P4P  H   H                                     h   6 `P: `PEQ                                    G   o           G   6      9   9      9	         
      
   
   9
     G   o  9     G   o  9   h   9   s    0 `P,P= `P0 : 6 : 0 ,P8 ,	P8 J PI P        N                           G                       G   s       G   s  0 `P 0 `P,PI `P,P4 P         g                               I      G   s     G   s         G   o  0us          h   I   6 `P= `P+P4 `P+P4 `P P&P4 `P: `P@P  X   X                               G   o         s 0 `P,P8 `P&PD P   H   H                                 G      r 6 `P 
P4P <   <                                G   G   0 `P?Q         }                            G   o       G        G     G   <         G     G            G     G      6 `P+P8 `P> `P000@Q         U                           6      G   G   o  9      G   G   o  9      G   G   o  9   6 `P5  P8  P8  #PHQ       O                	                     o I             o I             o I   6 `P/P9 `P/P9 `P/P9P  H   H                                 G      r 6 `P 
P4P @   @                                  I   6 `P=P    <   <                                G   G   0 `P?Q   X   X   *                              G   o  G      G   G   6 `P+P0Q  h   h   3                           6      G   G   o  9      G   9   6 `P5  P8 NQ  L   L                                        o I   6 `P/P9P        >                             G      r      I      I      I   6 `P PD `PM	 `PK `P;P                                         I      G   6         G   G                 s       G   G      c      d      d   s 6 `P= `P0 `P PI `P /)(P4P                                      I      G              (         G   G      s 6         G   #   	      G   G      s    6 `P= `P0 `P P> `P0 `P PIP   \   \   &                                    G      h   6 `P: `P? `PEQ                                  G                       G   G   o     6      9      9        G   6	   
   9     9      9      G   G   9   9   h   9   s 0 `P0 `P P8 `P5 : N `P0 : 9 : 0 6 J 
PD P       v                           G   =        G     G   s   G      s 0            G   o    G      s    0 `P0 `P P4 `P,&P>0 `P P PI P                                       I     G     G   o  s   G        G         G   G   h   s    G   G   h   s 6 `P? `P P#PD `P? `PN
 `P PD `P PDP   H   H                                G      s @ `P P4 P   H   H                                G      s 0 `P P4 P                                         G      o I      G   '         G   G      G   s 
      G   G      s    G   #         G   G   	   s       G
      G   s 6 `P P9 `P0 `P PI `P P4 `P0 `P PI	 `P P4P                 
                     o     G       #         G      s P                  o      G   	      c     d    o s    0 `P+P8 `P= `P0 `P P>0 `P P8 `P )P#PI	P                        5                  '      5                  $      2        	      
    !      /                                               )         o          G   G   %   %       o %   %         o   % &         o   % 3         o   % 
          o        !   o   % "      "   o  0      #   o    6$   9%   9&   9'   9(   9)   9*   
      @9+   
ffffff@9,   9-   
      !@9.   
333333!@9/   	90   
91   92   93      h4       h5      h6      h7      h8    ,  h9      h:    7  h;      h<    (  h=    6  h>      h?    -  h@      hA    %  hB      hC    	  hD    9  hE      hF    *  hG    +  hH      hI    .  hJ    4  hK    8  hL      hM      6N   hO   9P   hQ   9R   hS   9T   hU   9V   hW   9X   hY   9Z   h[   9\   @@@000 "`P; `P; `P; $`P; &`P; "`P; $`P; `P; (`P; .`P; 1`P; &`P; ,`P; /`P; `P: `P: #`P; #`P; #`PK !`P+PI `P 0PO" $`P+P> `P+PN% $`P+P> `P+P9 !`P+P> `P+P9 `P+PI+ `P5 6 6 7 7 7 7 > > 7 > > 7 7 7 M= "`PKA $`PKE !`PKI #`PKM  `PKQ "`PKV #`PK[ )`PK` ,`PKe "`PKj '`PKo *`PKt .`PKx .`PK|  `PK   `PK   `PK   `PK   `PK   `PK   `PK  `PK * `PK I $`PK k (`PK  `PK  `P5 J  J  J  J  J  J  J %Q  h   h   1                             '  %   %   %   %          o 0 #`P0 `P*P3 Q    h   h   1                             '  %   %   %   %          o 0 %`P0 `P*P3 Q    h   h   1                             '  %   % $  %   %          o 0 !`P0 `P*P3 Q    h   h   1                             '  %   % 2  %   %          o 0 #`P0 `P*P3 Q    l   l   5                            '  %   % $  %  %   %          o 0 !`P0 `P*P3 Q    l   l   5                            '  %   % 2  %  %   %          o 0 #`P0 `P*P3 Q    \   \   %                               %   %          o 0 $`P0 `P*P3 Q    \   \   %                             !  %   %          o 0 *`P0 `P*P3 Q    \   \   %                             /  %   %          o 0 -`P0 `P*P3 Q    \   \   %                               %   %          o 0 $`P0 `P*P3 Q    \   \   %                               %   %          o 0 (`P0 `P*P3 Q    \   \   %                               %   %          o 0 +`P0 `P*P3 Q    H   H                                       %o 0 `P P3 Q    H   H                                     )  %o 0 `P P3 Q    \   \   %                               %   %          o 0  `P0 `P*P3 Q        Y                #                           G      o "       G      s        G      s        	        G              G      S               o  o G      s         o  o G      s X           ,      o o G      s            o o G      s #   0 `P0 `P/P= `P/P>0 `P/PI `P= `P0 `P,P#P/P4 `P,P#P/P>0 `P P#P/ P4 `P P#P/"PI P         N                 
         G       '  %o G         %o           o G    s 0 `P P !P8 `P*P-P4 P t  t  {                K            '  %   % 5  %   %          o G      o G   h   s      o      G      o G   h   s     o      G      o G   h	   s     o      G      o G   h
   s     o      G      o G   h   s  7   o  G      o G   h   s     o  G      o G   h   s  (   o  G      o G   h   s  6   o  G      o G   h   s     o  G      o G   h   s  -   o  G      o G   h   s     o  G      o G   h   s  %   o  G      o G   h   s     o  G      o G   h   s @ `P0 `P*P/P/PD #`P> `P P/PD %`P> `P P/PD !`P> `P P/PD #`P> `P P/PD `P P/PD  `P !P/PD$ `P $P/PD( `P P/PD, `P P/PD0 `P "P/PD4 `P &P/PD? `P &P/PDI `P P/PDL P X   X   "                            G         G   o s 0 `P P#P4 P  d   d   ,                            G         G   o    G   s 0 `P 
P-P4 P    d   d   ,                            G         G   o    G   s 0 `P 
P-P4 P    d   d   ,                            G         G   o    G   s 0 `P 
P-P4 P    d   d   ,                            G         G   o    G   s 0 `P 
P-P4 P    T   T   %                             G         G   s 6 `P P4 P T   T   %                             G         G   s 6 `P P4 P T   T   %                             G         G   s 6 `P P4 P T   T   %                             G         G   s 6 `P P4 P T   T   %                             G         G   s 6 `P P4 P T   T   %                             G         G   s 6 `P P4 P (  (                               G   Y       %   o  G   6   9   s    G         G   o    G   s T       %   o  G   6	   9   s    G         G   o    G
   s    F `P0 `P ,&P4 `P 
P-P>0 `P ,&P4 `P 
P-PI	 P   (  (                               G   Y          o  G   6   9   s    G         G   o    G   s T          o  G   6	   9   s    G         G   o    G
   s    6 `P0 `P ,&P4 `P 
P-P>0 `P ,&P4 `P 
P-PI P    T   T   %                             G         G   s 6 `P P4 P       v                            G   6      9   9      9   	   G
   G   9   6      9     9   9   +  9   h   9   s @ `P0 : 6 : 0 %*? : J 
PD P  H   H                                        s 0 `P P4 P  D   D                                    %s 0 `P/P4 P                       7        G             G         !               s       G      V                 o 6	   
   G   G   9   o             s :      G      a                %   %o G      s   G      c     d     d   s    "    G         %         %   %        o G      s           %   %o G      s   G      c     d     d   s    4          G   s 7   @ `P0 `P.P> `P0 `P6+P3%0A %PH
 `P-P> `P0 `P P/)P4 `P )((P> `P0 `P0 `P*P/
P4 `P P/)P4 `P '((P>0 `P PI P     :                         G      &             G   s        G      H   	    	      s   G      c     d     d   s C       	      s   G   	   c     d     d   s     9      G
   s  G          G   G                   G   s        @ `P0 `P P4 `PA K0 `P0 `P-P4 `P #((P>0 `P-P4 `P !((PI `P P4 `P0 `P PI `PA V   `  `                  6        G      o      G   I            o G      o G       G   %	   %s 5            o G      o G   
   s          o G      o G          o s       o G      o          o G         G         o s     o  G      o G   h   s     o  G      o G   h   s /   1         o          G   s 6   @ `P0 `P0 `P)P/	P "P>0 `P)P/	P/"PI `P)P/	P P#P4 `P)P/	P8 `P)P P#PD `P !P/PD `P P/PN0 `P)	P7 `P PI P  T   T   %                             G         G   s 6 `P P4 P T   T   %                             G         G   s 6 `P P4 P              	       D        G            G   I            o G      o G       G   %	   %s             o G      o G   
   s       o G      o           o G      o G   s         o G   s  #         o G      o G          o s       o G      o         o G        G         o s  7   o  G      o G   h   s  6   o  G      o G   h   s /   ?         o          G   s D   @ `P0 `P0 `P)P/	P "P>0 `P)P/	P/"PD !`P)P/	P8 `P*P/P*P4 `P*P*PI `P)P/	P P#P4 `P)P/	P8 `P)P P#PD `P P/PD `P P/PN0 `P)	P7 `P PI  P  T   T   %                             G         G   s 6 `P P4 P T   T   %                             G         G   s 6 `P P4 P                     D        G            G   I            o G      o G       G   %	   %s 5            o G      o G   
   s          o G      o           o G      o G          o s        o G             o G      o G         o s       o G      o G   s        o G   s   7   o  G      o G   h   s  6   o  G      o G   h   s /   ?         o          G   s D   @ `P0 `P0 `P)P/	P "P>0 `P)P/	P/"PI `P)P/	P8 `P*P/P P#P4 `P*P P/P P#PD `P)P/	P*P4 `P)P*	PD `P P/PD `P P/PN0 `P)	P7 `P PI P  T   T   %                             G         G   s 6 `P P4 P T   T   %                             G         G   s 6 `P P4 P p  p                            G                  O         G      s    	    
   o I            s _         
   J         G      s    	       o I          0  s                 G   s    @ `P0 `P0 `P 	P4 `P P9 `P.P> `P0 `P 	P4 `P P9 `P.P@0 `P PI P t   t   5                            :    #          % 1      s  0 `P9 `P9 `P9 `P? `P: P       _                  	         G      o     G      o G    5  G   o     *        G      s 0 `P/P7 `P/P P9 `P P4 P                        /         G      o    1          1  G   o                  G             G      S       %   o  G      s     o  G      s 	       &  s M      	    
      o  3  G       :  o G       #  o s           G   ;   !     G      o G    $  G   o    c   &       G   ;   )     G      o G    2  G   o       .    :     .    *       .  s 0 `P/P7 `P  P0 `P0 `P &P4 `P &P4 `P.P>0 `P6)P3<5E
 -PJ5E PC PI `PA F `P0 `P/P P0 `P0 `P/P P00 `P@ `P P4 P    8  8                            1          1  G   o        O                o  
  G       :  o G       #  o s      G   G	     G   G
      o %o     *       4  s 0 `P  P0 `P6)P3<5E .PJ5E PC PD `PA F `P $P%P9 `P P4 P  8  8                            1          1  G   o        O                o  
  G       :  o G       #  o s      G   G	     G   G
      o %o     *       8  s 0 `P  P0 `P6)P3<5E .PJ5E PC PD `PA F `P $P%P9 `P P4 P  8  8                            1          1  G   o        O                o  
  G       :  o G       #  o s      G   G	     G   G
      o %o     *         s 0 `P  P0 `P6)P3<5E .PJ5E PC PD `PA F `P $P%P9 `P P4 P  \  \                  0        1          1  G   o        O                o  "  G       :  o G       #  o s         G	   G
      o       G   o           G   o                     %o               G      o %   &               -   (                   o    ,      (   -    *         o     s 0   0 `P  P0 `P6)P3<5E +PJ5E PC PD `PA F `P P9 `P,P9 `P PI `P6 `P P9 `P> `P 	P= `P0 `P00 `P0 `P+PM `P> `P/P+PI P  X  X                                           h      h      h      h    	  h    
  h      h      h	      h
      h      h      h      6   h   9   @ `P; `P7 `P7 `PG `PK `PK `PK# `PK? "`PKK `PK   `PK   `PK   `PK   `PK   $`PK   `P;000 `P5 J  Q  X   X   $                                 o G         s 0 `P+P P4 P         T                             G      s    G      s    G      s     s      s  0 `P 	P4 `P 	P4 `P 	P4 `P: `P: P        c                 	          G   s                   G   g   o            G     h   s 0 `P,	P4 `P0 `PA F `P/P7 `P: `P PD P       i                           |  }        G    s        o      G     s   G      G   o  s 0 `P0 `P.P4 `P+P8 `P 	P4 `P P#P4 P                                       G   6      9      G   G   9	   
   9   6          G   o  o G      o 9   9   h   9   h   9   s 0 `P0 : 0 : % P#P/P= J J 
PD `P1 Q 8  8                             G                  G   o                 s         G      o s   G   "      	   G
     G   s    +          s           G   s    0 `P0 `P P9 `P0 `P: `P P#P4 `P0 `P P@	0 `P: `P PI P   d   d   (                                       o s     s  0 `P P#P4 `P: P         h                           G   h   s        o G         o G      s   G      o G   h	   s 0 `P/PD `P+P P/P4 `P/P/PD
 P         k                           G           G      )        G           G   	      
       s     0 `P0 `PO P    @   @                              G   s  0 `P*P4 P    $  $  /         
       R              o           o              s    |6      G	   G
   9   9   9   9   d9   
9     }     G      s   G   G      h   s    G     s    G      s  
      s        o G      c      d    s    G   6   6   6      G   G    9!      G   G"      G   G#   )9$   9%   9&   9'   9(   6)   6*   +    ,   o 9!      G-   G.   9$      G-   G"   9%      G-   G#   9&   9'   9-    	  9/   0   91   s        o G   2   c      d    s    0 `P+P8 `P+P9 `P PD `P; 0 6 6 6 7 K H `P P4 `P PD `P/	P4 `P PD `P+PD `P+P 3)PD `P0 5 5 0 0 6 @' 5 5 +
P8 0 0 @/ : J PD3 `P+P <)PD5 `P4 Q @   @                              G   s  @ `P*P4 P         =                          G      o             G   h   s    0 `P/	P8 `P; `P PD `P5 Q        m                           0           o G      o    7                 o G      o %%      0 `PO `P)P/P00 `P P/PL P H   H                                G   s  0 `P,	P4 `P1 Q         I                             G      o G      s    G      o G      s 0 `P 
P/P4 `P 
P/P4 P  <  <                                  o       G   o            o           o      G      s    G     s    G      s    G   	   s    G
   s      s  0 `P+P9 `P,P9 `P+P8 `P*P8 `P 	P4 `P 	P4 `P 	P4 `P 	P4 `P,	P4 `P: `P1 Q         E                           G      o G      s   G      o G   h   s 0 `P/P/P4 `P/P/PD P         k                           G           G      )        G           G   	      
       s     0 `P0 `PO P    D   D                                       s 0 `P P4 P T   T                                    o        s  0 `P+P9 `P: P   p   p   9                              G      r       I         I   6 `P P4 `P? `P?P @   @                                  I   6 `P=P    <   <                                 G   6 `P9Q   @   @                                  I   6 `P=P    @   @                                  I   6 `P=P    @   @                                  I   6 `P=P    <   <                                 G   6 `P9Q   p   p   9                              G   G      s    G   G      s 6 `P P4 `P P4P        R                           G      o "        G      s         G      s    0 `P/P= `P/P>0 `P/PIP       Y                               '         G      G   s "         G      G   s    6 `P0 `P P>0 `P PIP  L   L                                G   G     s 6 `P P4P                                 G               G   s           G     s       G    G   s  G          G   G      %      	       G
    G   s    F `P0 `P+P>0 `P.PI `P P4 `P0 `P PIP                                         G   G   %   %       o %   %        %    G	   
     G   o     G	        G   o 6 `P 0P? `P5 `P P7 `P P3Q H   H                                    h   6 `P: `PE#Q       @         	       -           G   G   N         G          o o           G   o     s       6	   6
   9   9   9   6   9   9   9          G   o  H   H     G   6      9   9      9      G   G   9   6     9      G   o  9   9   h   9    h!   9"   s -   0 `P0 `P P#P8 `P P'P>@ `P5 %&< %'@
 !`P P? `P0 : 6 : 0 5 9 ,PM J J PI  P  `   `   (                                 G   o         o s 0 `P P.P#P4 P       [                  	         G   '         G        s +             G   o    G   s 	   0 `P0 `P P>0 `P P+PI P    (  (           	                    I     G      o         I            G      o s   G      o       I	           G   
   o s     G      o I   6 `P= `P/P8 `P> `P ,P#P4 `P/P8 `P> `P .P#P4 `P P9P   X   X   &                              G      r    I   6 `P P4 `P;P @   @                                  I   6 `P=P    <   <                                 G   6 `P9Q   X   X   %                                     G   o  %o 6 `P P$P3Q <   <                                 G   6 `P9Q   L  L                             G   o       U         G      s   I     G   o  G          o s _        P         G	      s   I     G   o  G       
   o s    6 `P+P8 `P? `P P4 `P; `P+P P#P> `P? `P P4 `P; `P+P P#PIP   d   d   *                                 G   o     h   6 `P: `P+P8 `PEQ                                   6      G   o  9      G   o                 9         G   6   	   9
      9      9      G   G   9   9   h   9   s 0 `P5 ,PH ,P@ `P0 : 9 : 0 6 J 
PD P          [                  
         G   '         G     G   s +             G   o    G   s 
   0 `P0 `P P>0 `P P+PI P          X                
               I         G   o  G      o I      G      G   o  s 6 `P= `P/P/P9 `P P#P4P                                   G      r         6             G         
   I        G      
   <
   I        G            I	        G
            I   6 `P P4 `P0 `P0 `P0 `P0 `P0P   p   p   5                             G   G   s             s     6 `P P4 `P= `PMP    H   H                                     G   s 6 `P/P4P   L   L                                 G   o   s  6 `P+P$P4P          W                            (         G   G      s #         G   G      s    6 `P? `P P>0 `P PIP @   @                                  I   6 `P=P    `   `   *                              G      G   G   o  o 6 `P P#P3Q    P   P   "                                 G   o  %   %6 `P 3P:Q        V                	               I      G   4         G   G     s    G   o   s  	   6 `P= `P0 `P P4 `P+P$PIP         D                              G         G         G            h   6 `P? `P? `P? `P: `PEQ         j         
       '          G   s     G   o               G                  o                %   ?      g   G     G	   G
   o             %         G      s    G   o           G      o o       
          G      G       *o    o )     G        %s 0 `P,P4 `P,P8 `P= `P P0 `P0 `P P= `PK
 `P P4 `P,P8 `P P#P0 `P $P(P9 `P 	P4 P      	                           G      6      9      9      G      o 9      G   	   o 9	      G   
   o 9
      G      o 9      G      o 9      G      o 9            o      G       o     G   G     s F `P> `P5 : :  P8  P8  P8  P8  P8  PM `P*P8 `P P8 `P P4P  0  0                 -                   o I     G   G      o      G   G      o        I       I   	   G
   G   (         G   	   G
   G   s              s   G   "         G     G   s       G   6     G   9     G   9     G   9   s   G   '   &      G        G   s )      G        G   o  s 6 `P/P9 `P P8 `P PH `P> `PN	 `P0 `P 	PI `P/P4 `P0 `P 	PI `P0 > > N PD `P0 `P 	PI `P /P#P4P                                     G        G   o  r      G   o  I         I      6   	    
   o 9   	       o 9   I   6 `P !P#P4 `P.P9 `P? `P9 +P8 +PNP    <   <                                 G   6 `P9Q         ^                           G   o       #         G      s          G      s    6 `P+P8 `P= `P P>0 `P PIP                                         o G   G     r   G   G      s   G   o            G   G	   
   h   s   G   G	      h   s 6 `P+P P4 `P P4 `P+PH `P: `P PD `P PDP         M                         G                                G     s 0 `P= `P0 `P P4 `P1 Q `   `   #                             G      G   o  s 0 `P,,P$P4 `P1 Q         G                             G        r       I         I      I   6 `P P4 `P? `PO `P;P @   @                                  I   6 `P=P                                         I      G   q        7         G   G   s     G   G   s  2   
      G   G   s     G   G   s     6 `P= `P0 `P= `P P4 `P P>0 `P P4 `P PIP    <   <                                 G   6 `P9Q   <   <                                 G   6 `P9Q   <   <                                 G   6 `P9Q       ?               X              G      o I     G      o G      o      G   G      s   G      o     G      s     I     G   G     s   G      o G	   
     G      o o G      o     G     s   G      o G	   
     G      o o            s   G   '   &     G	        G   s )     G     s     I     G      o G      o     G     s     I         o G        G   o  s   G   "   ;     G     G   s >     G      o G	   
     G      o o G      o       I    !   |    }       I"     G     G#   o  s   G     s   G$   -   S     G%   s    G"   G%   s  X   6 `P P9 `P P/P8 `P PD `P P8 `P P4 `PN	 `P PD `P P: )P#P:%P8 `P/PD `P P: )P#P8 `P/P4 `P0 `P PI `P/P4 `PN `P P/P8 `P/P4 `P> `P*P /P#PD  `P0 `P PI$ `P P: )P#P:%P8 `PN) `P0 `P> `P P#PD- `P/PD/ `P0 `P+
P4 `P PI3P                                         I        G      o I        G      o I        G      o I      G   G	   
      G   o  s 6 `P= `P P9 `P P9 `P P9 `P 5P#P4P         V                              G   G      G      G   o  s        o G   G	      r 6 `P =P#P4 `P+P P4P                                      G     r    G      G   G   o         G	              6
      o I        I   6 `P P4 `P P8 `P PI `P?P  @   @                                  I   6 `P=P          f                             G                G   G   o           h	   s 
   
       o G   s  @ `P@ `P P= `PKA PI
 `P+P*P4P  l   l   2                             G   G      s    G      s 0 `P P4 `P P4 P         F                            G   s         G     G   o G   o  o G   s  0 `P,P4 `P 
P*P#P*&P4P  (   (                                                                     G   6     G   o        6      9     G   9	        G        o    
   G      s   G   "        G     G   s    F `P P8 `P9 `P5 : @ `P 	P8 `P P4 `P0 `P PIP   (   (                                    (   (                                                    	                  G         G   G   o       G   G      G   o  	   6
     9      s    G   G        %o      G   G     Hs 0 `PO `P P8 `P P-.PD `P P8 `P P4P                                      G             o G   o            o G   o        G   G   o  G         G   G   o     	    h
   ds 6 `P? `P+P*	P9 `P+P*	P9 `P P> `P PI	 `PKB	 PDP                                    G         s       %      %                         :   	          o G         *&   *&s                 s     0 `P PD `P0 `P0 `P@
 `P+P 	PI `P? `PO P @   @                                  I   6 `P=P          W                
               I      G   o  0         G      G   o G     s 
   6 `P= `P+P= `P P-PIP    D   D                                G   G   o  0 `P P3Q  t   t   B                
                 )         G      G   o    
   6 `P  *P>Q    H  H                              G      o       G      s      I     G      o     G        G	   s   G   
   s   G   '        G        G   s      G   G     s 6 `P P8 `P 
P4 `P> `P P8 `P 	P4 `P 	P4 `P0 `P 	PI `P P4P   d   d   0                               I        G      o I   6 `P= `P P9P         V                              G      r    I      I      I      I         I   6 `P P4 `P; `P; `P; `P; `P?P H   H                                 G   G   s  6 `P P4P H   H                                 G   G   s  6 `P P4P <   <                                 G   6 `P9Q         E                             G   G               G   G               0 `P0 `POK0 `PEV       %                            G      o    6      9          o 9      9	   
   9      9      9      9      9   9      9      9      9        |    }     G      s   G     G   s   G   G     G    o  s   G!   s      I"   6 `P P8 `P5 : +P8 9 : : : : : 6 : : O `P0 `P/P4 `P P4 `P P#P4 `P+P4 `P>P                                    |6   9     }       G      s    G   s    G     G   s   G	   G
      G   o  s    G   s       I   6 `P+	+8 `P P4 `P,P4 `P P4 `P P#P4 `P+P4 `P>P         Q                                 |6   9     } I      G   G      G   G   o  s 6 `P/!+P9 `P %P#P4P                       7            G   o                    G   s   F                    G   s     
     G   s       G       G   G   o      G	   o      G
     s   G     s   G     s   G     s   G   o          G   o  o     G
     s   G     s   G     s   G     s    G   G   E   ,         G   o  o     G   o  G     s 4     G      c     d    s 6 `P+P8 `P0 `P+PD `PA%K `P0 `P+P>0 `P+PI `P> `P PH `P+P8 `P/P4 `P/P4 `P/P4 `P/PD `P+P8 `P P#PH `P/P4 `P/P4 `P/P4 `P/PD `P0 `P P#P8 `P+P.PI$ `P 2)P4P   <   <                                 G   6 `P9Q   p  p  [               K             I      I       G   o  I       G   o  I     G   o  G     G   o  s   G   o  G	   s    G   G
   s    G      ]        G   G          o s   G           G   G	   s  "   S   "     G   G          o s   G      )     G   G   s  ,     G   o  G   s    G   s    G   s    G   G     G   s   G      h        G   G      s       G     G   o  s       G     G   o  s   G   o  G      c     d     d   s 6 `P= `P= `P.P9 `P.P9 `P*P P#P4 `P*P*P4 `P PD	 `P0 `P P#P4 `P0 `P P@0 `P P#P4 `P0 `P PI `P+P*P4 `P+P4 `P+P4 `P P4 `P? `PJ `P P4 `P 0P#P4 `P 0P#PD! `P+P =)(P4P @   @                                G   s  0 `P,P4 P  p   p   4                            G        G      h         F `P? `P? `PJ. `P4Q   p  p  l                8           G   G         G   o  G        d&    ,   	      G   
ffffff?   )o         &    ,         G   
?   )o              G	   G
            9                 o c     d    o   "         >                  o c       &d    o      &          (        ;   (          *           *        *        &         9   -              o c     d    o      2          o   4      G     s    G        s 0 `P0 `P,P= `PL `P0 `P PM `P< `P0 `P PM `P: `P0 `P: `P0 `P P(*)P0 `P0 `P P(/.P00 `P0 `P0 `P0 `P00 `PO `P> `P: `P0 `P P( )P00 `P+PM& `P P4 `P P4 `P1 Q   H   H                                     h   6 `P: `PEQ                                     G   o        G   o       G   G       G     5   
     G     o      G     s    0 `P,P8 `P+P8 `P0 `P0 `P P8 `P/PI P P  P                              G              G                 G   G   o        G      o    G     G   o       $        G   o             G   G	   s  6 `P0 `PAF `P0 `PAF `P P8 `P P P> `PAK
 `P+P= `PAF `P P4 `P1Q   H   H                                     h   6 `P: `PEQ                                    G   o  x         G   o        G   s     G   s    G   s         o G   	   c      d    s    0 `P,P= `P,P8 `P+P4 `P,P4 `P*P4 `P+P 9*PI `P1 Q                    %              G                G   G   o  G   s     G   G   o  #         G   G   s  (         G   G   o  G   s        G   s        G	   G
   o  I	      G   G   s        I          G   s        G   s 6 `P0 `PAF `P P*P4 `P P= `P P>0 `P P*PI
 `P+P4 `P PI `P P4 `PO `P/P4 `P/P4P  \  \          	       \                   o I     G   G         s        o      G   G      s      I	       G
      o I     G   G      s    G     G   s          o G         o I     G   G     G   s          o I         G      s   G   G     G   s          o I         G      s   G   G          o s   G   G     G   s    G   G   >  <       G
      o I     G   G       s   G   G     G   s   G
   !   o     G   "       s   G   #   $   s   G   %   $   s   G   G     s   G
   &   o     G   '   $   s   G       (   o s   G   G     s \   6 `P/P9 `P PD `P+P8 `P PD `PN `P P9 `P P4 `P PD `P/P P9 `P PD `P/P9 `P P4 `P P4 `P/P9 `P P4 `P P#P4 `P PD `P0 `P P9 `P P4 `P P4 `P P8 `P 	P4 `P 	P4 `P 	P4 `P P4 `P P8 `P P4 `P P#P4 `P PI-P   T   T   &                              G   G      o    6 `P P9Q  t   t   ;                              G   G      s    G   G      s 6 `P P4 `P P4P    t   t   ;                              G   G      s    G   G      s 6 `P P4 `P P4P          I                              I         I      G   G      s    G   s  6 `P; `P? `P P4 `P+P4P                                   G   G   s    G   G   o  G   s    G   G   s            o o      G   G   s    6 `P P4 `P P*P4 `P P4 `P6+PC PH `P P4 `P4Q  `   `   /                              G   G      o G      o 6 `P P/%P3Q  x   x   A                             G   G      o G        o G      s 6 `P P %P/P4P    d   d   .                            G   G         G     h   s @ `P0 `P PDP        W                          G      G   G             G   H	      
       G   K   0 `P '0 `P@ P    \   \   &                                    G      h   6 `P: `P? `PEYQ                       x          G   o             G   s    G   o      G      G   G   ,        G   s    G	   s       G
   s    G   G   o  G   s    G   G   o        G                o         G   G   o  #   $      G   G        '      G     (     G   G   6     G   o  9     9     9     9      G   G   9      G   G   9   s   G   G   s   G   G    o      G!   o     C     G"   s  E     G   o        G#   $   s 6%     9&      G   G'   9(       G)   *   q   R       G   G+   o  I,   -      G.   G/   -       G0   o  I1     G2   s `   `       G   G3   o  I4       G   G5   o  I6   -      G.   G7   -   m   8   G9   6:   ;   9<   -   9=   >   9?     9   h@   9A   hB   9C   s 00 `P,P? `PAU F `P,PD `P,P8 `P0 `P,P4 `P,P4 `PAU F `P,P4 `P P*P4 `P P8 `P ,P= `P P= `P00 `P@ `P0 ,P8 9 9 9 0 @ PD! `P P4 !`P P8 `P+P= `P+PI& `P+P9 `P PD) `P5 9 @. `P0 `P #P9 `P0 `P P9 `P-P>0 `P "P9 `P  P9 `P@9 `P0 : : : 9 JK J9 
PDT `P1 Q  8  8                             G   G   s   G      Y        G   G   s    G     s   G   G   o  G     s "        G   G	     s      G
   s     G      s @ `P P4 `P0 `P P4 `P/P4 `P P-P>0 `P PI
 `P,P4 `P P4 P                                    G   G   o  G   s        G   G   o    G      s   G   G   s   G   s    G	   s     G
      s 0 `P P*P4 `P P P4 `P P4 `P,P4 `P,P4 `P P4 P       B                            G      r      I             6      I      I         G   G	   I
      I             o I         I           G      !          G   I            I              G      !          G   I            I      6 `P P4 `P= `P0 `P; `P0 `P; `P/P9 `P? `P0 `P00 `P@ `P0 `P00 `P@P  <   <                                 G   6 `P9Q                                     G            |  }             I     G   o  '         G        s "   
      G        s       G   s  6 `P P= `PN `P+P= `P P>0 `P PI	 `P+P4P        
               s       
  
        o I   
  G   G      o G      o    
  G   G      o               
  6	     9
   I   
  
  G   G      o I   
  G   G      o   
    I   
  G     G      o I   
  G   G      o   
  G     G   o  I   
  G   G      o     G      )   
    I   *   
  G   G      o     G   o   0   
  I   
     |
  G     } I   
  G   G   
  G    o  s 
  G   G!     s =   
  G   G   "   o     G   f   C   
  I#   
  $   |  }  I%   
  G%   G   
  G&   o  s 
  G%   G!     s O   
  G   G   '   o   
  G(   B   T   
  )   |    } I*   
  G*   G!     s    Z     G+   s  \   
  G   G   ,   o     G      b   
    I-   c   .   |
    } 	  	  G!   
  G   G   /   o s 
  	  I0   
  
  G   G      o I1   
  G   G2   3   c   
  d    s 6 `P-P9 `P P/P8 `P P0 `P)O `P !PI `P P8 `P> `P (P9 `P P8 `P (PI `P P8 `P0 `P@ `P P8 `P0 `P; `P P9 `P "P#P4 `P PI `P P8 `P0 `P; `P.P9 `P  P#P4 `P PI# `P P8 `P0 `P P9 `P P>0 `P+PI+ `P P8 `P0 `P@0 `P0 `P P#P4 `PN4 `P PI6 `P 6)P4P    0   0                              0 `PAQ    H   H                                 G   o     6 `P+P9Q h   h   =                              G            G   G               6 `P0Q  D   D                                    G   !6 `POQ    @   @                                    G   !6 `P?Q <   <                                 G   6 `P9Q   H   H                                 G   G   o  6 `P P3Q H   H                                 G   G   o  6 `P P3Q          	                        G     G     o I     G       G   G        G   s   G   G   	     G   s   G   G      
     G   %s   G         G     G   s    G     G   s   G   Y        G   G      o     G           G   G   o  %   %s &      G   G   o     |   ,          o     G     G   s   G   G   s    G   G     s   G     G   I   :   :     G   G   s    G   G     G   s A     G   G         G!   s   G   G     G"   s   G   G   #   o     G$   c   N     G         G!   s   G   %   o     G   &   '      G(   o s X     G)   G     G*   s   G)   G   +     G*   s   G)   G,   s    G   j   e     G   G   -   o     G     G   s   G      .     G   G   o  %s q     G/      s     G0       1   |  }  I0     G0   G2     G3   o  s   G4   o  G5     G0   G4   o  s   G6   s       G7           G8       9   |  G   G     } I8     G4   o  G5     G8   G4   o  s   G8   G4   o  G:   ;   c     G8   d    s   G6   s       G   ]      <   G=   G>     G   G   o  s <   G=   G?   @     G   G   o  s    <   GA   GB         C    s       G   G:   D   c     d      d   s 6 `P P9 `P= `P P4 `P P4 `P PD `P> `P P4 `P PD `P0 `P P8 `P %P*PI `P P0 `P+P8 `P PD `P P4 `P P4 `P00 `P P4 `P PI! `P P4 `P PD% `P P8 `P0 `P P4 `P P8 `P P#PI- `P P4 `P P4 `P PD2 `P0 `P P8 `P P4 `P 1P$PI9 `P0 `P> `P.P9 `P  P#P4 `P+P )P#P4 `P+PIA `P0 `P> `P P9 `P+P ,P#PDH `P P @.P4 `P+PIL `P0 `P 2P#P4 `P @P#PIP `P0 `POS `P 5)(P4P        d               )              G            G   G   s        G            G   G   s  
      G            G   G   s        G            G   G   s        G            G   G   s        G            G   G   s        G	             G	   G   s  #      I
      G   G   G      r 6 `P0 `P PI `P0 `P PI `P0 `P PI
 `P0 `P PI `P0 `P PI `P0 `P PI `P0 `P PI `P; `P P4P         y                              G   G   G      r    G   o           G   o  
            G   s        G   6 `P P4 `P+P P0 `P+PI `P9Q          u                                   G   6      9      G   G   9	   6
      G   G   9   9   h   9   h   9   s 6 `P: `P0 : 0 %0 J J PDP         j                           G   1         G     G   I       s  0             G   o    G      s    0 `P0 `P0 `P00 `P P PI P `   `   '                                G   o    G      s 0 `P P P4 P          R                              G   o  2            G   !         G   G         6 `P+P= `P0 `PNF `P5Q    H   H                                     h   6 `P: `PE	Q         N                             G   o           G   s           G   h   s    0 `P,P= `P,P>0 `P PI P  @   @                                G   s   `P,P$P    \   \   &                                    G      h   6 `P: `P? `PEQ                                            o o          G   6      9   	   G
   G   9   6      G   o  9   	   G   G   9   9   h   9   h   9      9   s    0 `P P#PM `P0 : 0 5 ,P8 @
 J J J PI P t   t   4                           G   o        G   s     G   s  0 !`P,P8 `P,P4 `P+P4 P   |   |   <                  	          G   o  G   s         G   o    G   s 0 `P,P*P4 `P P+P4 P X   X   &                              G      r    I   6 `P P4 `P;P                    7               I        G      o I        G      o I         G   G	   I
        G      o I      G   G   i         G
   0             G      G   o  s +             G      G   o  s         G      o I      G   G   4   #          G      G      G   o s )         G   G      o I        G      o I   c                G   G      o G   h   s       I   6 `P= `P P9 `P PI `P@	 `P #PI `P0 `P0 `P69+PC $PN0 `P69+PC $PI `P !P9 `P0 `P69 PC  PI! `P +PI# `P P9 `P; `P: `P P/PD+ `P?P  |   |   >                           |     }       G      s    G    s 0 `P0 `P 	P4 `P.P4 P                                      G   G      o G   `         G   -   	      G   G      o G	   s        G   G
      s    F `P P0 `P0 `P P*PI `P PI	P  <   <                                 G   6 `P9Q   <   <                                 G   6 `P9Q   <   <                                 G   6 `P9Q   <   <                                 G   6 `P9Q   l   l   4                              G   G   s     G   G      s 6 `P P4 `P P4P   l   l   4                              G   G   s     G   G      s 6 `P P4 `P P4P   H  H                               |    }           o     G   '        G   G     s "   	     G   G     s       G     s   G	   G
      s   G	   G      s    G   s  F `P0 `P+P8 `P0 `P P>0 `P PI	 `P/P4 `P P4 `P P4 `P+P4P    X   X   ,                              G            G      6 `P0Q         s                             G         G   M         G         .        G   o     G   !         6 `P? `P@ `P0 `PAK `P+P0 `PAF
 `P1Q  H   H                                     h   6 `P: `PE
Q   H   H                                G   h   s 0 `P PD P         >                            G     s    G   o  G   s     G   s  0 `P/PD `P,P*P4 `P,P4 P H   H                                    h   6 `P: `PEQ                                   G   G   ;         G   G                   s h   
      G   G	            G
   s  5             o                 s    @0 `P0 `P0 `P P> `P0 `P,P>0 `P6E	 PH `P PI P  H   H                                     h   6 `P: `PEQ   H   H                                G   h   s 0 `P PD P   h   h   .                            G     s    G   o  G   s  0 `P/P4 `P,P*P4 P                                 6     G   9     G   9      G   G   9	           
   G   6      9      G   G   9      9   h   9      9   s 6 `P5 > > @ `P: `P0 : 0 9 J J PDP    P   P                                  s    I   0 `P)P4 `P< P                                           G   G      c      d      d   s    G      G   h   s    c    I      G     h   s    G   G   	   c      d      d   s 6 `P: `P 3)(P4 `P PD `P? `P PD `P 2)(P4P @   @                             G   s  0 `P*P4 P                                     |     }           o      G   G     s    G     s    G    s    G   G	      s 0 `P0 `P+P8 `P 	P4 `P/P4 `P.P4 `P P4 P $  $                            6   6      9      9   9   6   	   9   
   9   9   6      9      9   9   6      9      9   9                  h      6   h   9   @ `PE 5 : O 5 : O 5 : O 5 : @ `P; `PK `PK8 `P5 JQQ                                   H           HG         G         o       G         o         HG        G           o          G	      I
         0 `P0 `P0 `P 
P8 `P 
P8 `P0 `P P= `P@	 `PA V                       5           G   G         G      o       G   o G      o    %       	    
   o G   o  o           G   G   o      G       G   &  G   &o          %  %   	       o   	       o   	       o   	       o         s       s       s       s       h   s       h   s       h   s       h   s 0 `P0 `P P8 `P.P/P? `P P*P#P9 `P6O ,PH `P P9 `P0 `P+P8 `P+P8 `P+P8 `P+P8 `P*P4 `P*P4 `P*P4 `P*P4 `P/P4 `P/P4 `P/P4 `P/P4 P <   <                                    s  `P+
P$P <   <                                    s  `P+
P$P <   <                                    s  `P+
P$P <   <                                    s  `P+
P$P       Z                              G      r       I         I      I      I      I	   6 `P P4 `P? `P? `P; `P; `P;P T   T   $                                 G   G   o  I   6 `P )P9P    @   @                                  I   6 `P=P          N                               I      G   o  '         G   G      G   s    6 `P= `P+P= `P PIP    h   h   2                             G   G   s     G   G     s 6 `P P4 `P P4P |  |                                 l           I      G   G   s     G   G   s     G   G   s     G   G   s  z        	   g           I      G   G   s     G   G   s     G   G   s     G   G   s     6 `P0 `P= `P P4 `P P4 `P P4 `P P> `P0 `P= `P P4 `P P4 `P P4 `P PIP          D                              G         G   s     G      G   h   s 6 `P? `P,P4 `P PDP  D   D                               G    s 0 `P/P4 P   <   <                                 G   6 `P9Q   <   <                                 G   6 `P9Q   D   D                                 I   6 `P; `P1Q                                     G           6      G   o  9      9         G   6	   
   9      G   G   9      9   9   h   9   s 6 `P? `P: `P5 ,P8 O `P0 : 0 9 6 J PDP                                      G   s     G     s    G      G   o  s    G      s    G   o  *         G   s     G	   s     0 `P,P4 `P/P4 `P P#P4 `P P4 `P,P? `P,P4 `P,PI	 P                                       G   G   o     6      G   o  9      9      9     	   G
   6      9      9      G   G   9     9   9   h   9   s 6 `P: `P P8 `P5 ,P8 : N `P0 : : 0 9 6 J PDP        p                           G   <         G      s    G     G   s +             G   o    G   s    0 `P0 `P P4 `P P>0 `P P+PI P  `   `   *                              G   s     G      s 6 `P+P4 `P P4P              
       L             I     G      o         I     G      o     G       	   o s    G
     s   G   s      I     G      o     G          o s   G
     s   G   s      I            o I     G     G   s   G   G   s      G      o I       G      o G      o G   o  I           G   G      -   2      |6    9!     }   E   6   "   |6#   $   9%   &   9'   9(   &   9)     }   =     G*   "   ?     G+     G*   s B     G,     G-   s     I.   /       h0   s /      h1   s /      h2   s F `P= `P/P8 `PN `P P8 `P P#P4 `P/	P4 `P+	P4 `PN `P P8 `P P#P4 `P/	P4 `P+P4 `PN `P/P9 `P P4 `P PD `P P9 `P P/P*PI `P:0 `P0 `P++P00 `P; : : 6 N PM& `P0 `P PI) `P P4 `P> `P/P4 `P/P4 `P/P4P @   @                                G   s   `P,P$P    @   @                                G   s   `P,P$P    @   @                                G   s   `P,P$P          f                              G      r       I         I         I         I         I   6 `P P4 `P? `P? `P? `P? `P?P @   @                                  I   6 `P=P    @   @                                  I   6 `P=P    @   @                                  I   6 `P=P    @   @                                  I   6 `P=P    @   @                                  I   6 `P=P    @   @                                  I   6 `P=P    p   p   7                             G   G        s    G   G   s  6 `P P4 `P P4P                                    G   G         s   G   G         s        G        G	     
   G   6      9      9      9     9   9   h   9   s 6 `P P4 `P PD `P: `P> `P> `P0 : : 9 9 6 J PDP |   |   >                           G   0             G   o    G      s    0 `P0 `P P PI P                                        G           I     G        G   6      9   	   9
     9      9   9   h   9   s 6 `P: `P> `P= `P> `P0 : : 9 9 6 J PDP  |   |   >                           G   0             G   o    G      s    0 `P0 `P P PI P        r                                    G   G         G         G   G          	   o %
   %   h      s F `P: `P0 `P? `P0 P:JE PDP        ^                  	         U         G     s    G     s    G      s    G   s  	   0 `P= `P/P4 `P/P4 `P P4 `P,PI P  t   t   9                              G   G   s     G   G   o  G   s  6 `P P4 `P P*P4P   t   t   9                              G   G   s     G   G   o  G   s  6 `P P4 `P P*P4P                                            o o         G   s    G   G     G   G   s   G	   s    G
   G   s    G
   G   o        G   s     6 `P P#P= `P+P4 `P P4 `P+P4 `P P4 `P P8 `P+PI	P        H                               I               h   s        G   h   s 6 `P= `P: `P6H PD	 `P6N	 PDP   @   @                                G   s  0 `P,P4 P  @   @                                G   s  0 `P,P4 P  H   H                                 G      r 6 `P P4P                                   G        G   o        G   6      9      9	   9
   6      9   9      G   G   9   h   9   s 6 `P? `P+P8 `P0 : : 6 %> 0 J PDP        Q                           G   '         G     G   s !               G   s    0 `P0 `P P>0 `P PI P                                  G      s   G   s    G   G   G       r   G   	   o         I
      |  }      G   6     G   o  9      9   s   G      o       I     G     s    |  }      G   6     G   o  9      9   s   G      o     G     s    |  }      G   6     G   o  9      9   s   G      o     G     s    |  }      G   6     G   o  9      9   s   G      o     G     s    |  }      G      o     G   6     G   o  9       9   s   G     s !   |  }  	  	  G     G   "   o s !   |  }  
  
  G     G   #   o s $   |  }      G%     G   &   o s   G'   6(     G   o  9   s   G)   *   G+   G,   s   G-   *   G+   G.   s   G/   60   1    2   o 93   1    4   o 95   s   G   6   o     G7     s   G      s 6 `P P4 `P,P4 `P ,P4 `P/P8 `PN  `P0 `P0 +P8 J PD `P/P8 `P> `P/PD -`P0 `P0 +P8 J 'PD `P/P8 `P/#PD `P0 `P0 +P8 J PD `P/P8 `P/PD  `P0 `P0 +P8 J! PD% `P/P8 `P/PD( `P0 `P/P8 `P0 +P8 J* PD. `P/PD0 `P0 `P P#PD3 `P0 `P P#PD6 `P0 `P %P#P4 `P0 +PH8 PD; `P P4 `P P4 `P0 +P8 +PH= PDA `P/P8 `P/P4 `P/P4P    H   H                                 G      r 6 `P P4P H   H                              6      G   9   6 `P%	>Q   H   H                                     h   6 `P: `PEQ         b                             G   6      9      9   9      G	   o  9
      G   G   9   h   9   s 0 `P0 : : 6 ,	P8 0 J 
PD P                                 G   w        G                                                 G     s +   	          G	   o    G
   s    0 `P0  `P= $`P: `P0 `PO `P P>0 `P P+PI P        J                	             G   G   G        r       G   G      o I   6 `P %P4 `P P9P       N                              G      r    I         G      G   G   o I	   6 `P P4 `P; `P P9P    p   p   9                              G      G   G   o  o G   g   o 6 `P &P#P/$P3Q  x   x   <                             G   G      G     G      o o s 6 `P -P#P#P4P          Z                           G   G   o       G   G         %  %s        o G   s  6 `P P8 `P P4 `P+P*P4P  l   l   4                           G   o        G        o 6 `P+P8 `P 	P6Q          r                           G   o        G        o              G     s 	     G      s 6 `P+P8 `P P8 `P0 `P 
PI `P/P4P  H   H                                    h   6 `P: `PEQ                                   G      G   o  s    G   s     G   o  G   o        G   s     G   s      	   o G
   s     G   s  0 `P P#P4 `P,P4 `P,P*P8 `P,P4 `P+P4 `P+P*P4 `P,P4 P        H        
       #            G     o     G   g      o     G   G                 G   o    
            G	     o    /      
           o c     d    o      G   G       G   o  G   %  9      
                o c     d    o             G   o 6 `P/P7 `P PG `P0 `P> `P*PL	 `P P0 `P6+P3%H
 PI `P0 `P+P0 `P6655D PC%I PI `P P3Q   H  H                              |  }        G     s    G   s    G   s    G     G      o s   G      o     G	   G
     s   G
      G   o  s   G     s 6 `P0 `P.P4 `P,P4 `P,P4 `P P#P4 `P P8 `P P4 `P P#P4 `P.P4P    l   l   4                              G   G      s    G   G   s  6 `P P4 `P PDP        U                            2               G   G   h   s          G   s     6 `P= `P: `P PN0 `P+PI	P  @   @                                G   s  0 `P,P4 P        y                           G   G   o       G   G     s       4        G   G   s    G   G   ds    6 `P P8 `P P4 `P0 `P P4 `P PIP H   H                                     h   6 `P: `PEQ   h  H                         $   G     o              G      G     o o       G      s    G   s     G   s  ?              G	     s 
    h   s    0 `P/P= `PA F1 !`P P#P8 `P P4 `P,P4 `P,P0 ; `P P4 `PKC PJ P   h  X        2           $   _   @   @                                G   s 0 `P-P4 P H   H                                 G   G   o  6 `P  P3Q P   P                                  G   G      o 6 `P  P3Q                                      G         G      o G   s    G   o      G   o      G     s   G   G	     s 
      G   s F `P> `P P*PD `P+P8 `P+P8 `P/PD	 `P P4 `P/P4P @   @                                  I   6 `P=P    <   <                                 G   6 `P9Q                               $     G     G   G   o  o      G        o      G      s   G   s  ,             G	     s    6 `P  P#P81 `P P8 `P/P4 `P+P0 ; `P/PJ	P           w              .   A   0   0                               0 `PAQ    0   0                               0 `PAQ    H   H                                 G   G   s  6 `P P4P \   \   %                            G           h   6 `P> `P: `PEPQ    x  8           	       M      $  G                G   s    G           G            G   o                             G     o     G            G	     o      G
   6      9      G   G   9   6     9   9      9   9   h   9   s -   $           G     s &   &        /   (      G   s     G   s  \   ,      G	     s    G   s  -   0           G     s 2         4     G   6   a   7      G    o  0   ;      G!   s     G"   s    ?      G"   s A      *   C      G#   s     G   s  G         I      G"   s K      G$   s  0 `P0 `PAL F `P,P4 `P0 `P,PH	 `P0 `P P8 `P01 `P P8 `P0 : 0 %> : 6 J P@!  ; `P PJ% `PAL F( `P0 `P,P4 `P,P>0A0 `P P4 `P,P0 ; `P PJ8 `P0 `P,P? `P,P4 `P-P>0 `P-PIB `P0 `P,P4 `P,PIG `P0 `P-PIJ `P,P4 `P1 Q  x  X     >                          ~             )                                    G   G         G     G   s    G   s     G   s  F   	     G   4         G     G   s     h	   s    0  `P0  `P P4  `P,P4  `P,P> '`P0  `P P4  `PK	C *PI P  @   @                                G   s 0 $`P-P4  P $  $  o               *             I       G      o I       G      o I            o I	          G   G
   o  G   h   s   G      o         I     G   s     |6      G   G   9   h   9   9   9   9   d9   
9     }       G      s      I      G     G    o  s   G!   h"   s 6 `P= `P "P9 `P P9 `P/PI `P: `P P/PD `P/P9 `P? `P+PD `P; 0 J 6 6 6 7 K H" `P P4 `P> `P P#PD& `P/PD*P        p                           |  }        G   s    G   s    G        o s    G      G      o s 0 `P0 `P,P4 `P,P4 `P P#P4 `P P#P4 P         S                  	          G     G   o          G   s           G   s  	   0 `P P? `P,P>0 `P,PI P H   H                               G   s  0 `P,P4 `P1 Q         R                              G      r       I         G      G   G	   o I
   6 `P P4 `P? `P P9P    @   @                                  I   6 `P=P    <   <                                 G   6 `P9Q   P   P                                  G   o  G   o  6 `P+P*P3Q  L   L                                 G   G      o 6 `P P3Q H  H                 +               I      G                G   G      s      <         G   s     G   s     G	   s          
   P         G   
   I      G   s     G   s     G   s                         G   G   o  I      G      I      G   G      G   o  s    G   s     G   s     G	   s  +   6 `P= `P0 `PAF `P P4 `P0 `P+P4 `P+P4 `P+P> `P0 `P0 `P+P4 `P+P4 `P+P> `P0 `P #P9 `P0 `P P#P4 `P+P4 `P+P4 `P+PIP         H                	              G   G   s     G   G   s     G   G      s 6 `P P4 `P P4 `P P4P  |   |   C                              G         G         G   G   h   h   s 6 `P? `P? `P PDP  X   X   !                             G   s     G   s  0 `P,P4 `P,P4 P  X   X   !                             G   s     G   s  0 `P,P4 `P,P4 P  h   h   /                              G   G   s     G   G   s  6 `P P4 `P P4P    \   \   *                              G   o  G   o  G   s  6 `P+P*P*P4P \   \   *                              G   o  G   o  G   s  6 `P+P*P*P4P       W                              G   G   s     G   G   s     G   G   s     G   G   s  6 `P P4 `P P4 `P P4 `P P4P        C                	              G   G   s     G   G   s     G   G   s  6 `P P4 `P P4 `P P4P   H   H                                 G   G   o  6 `P P3Q H   H                                     h   6 `P: `PEQ   @  @                                       o o         G   o        G   6      9	   
   9      G   6     G   o  9     G   o  9   o 9   9      G   G   9   h   9   s    0 `P P#P= `P,P9 `P0 : : 0 ,P8 ,	PH PH
 6 0 J PI `P1 Q                                  G   [         G     G   s    G      G   o  s    G      s             G	   s    0 `P@ `P PD `P P#P4 `P P>0 `P.PI
 P    \   \   &                                    G      h   6 `P: `PO `PE"Q                              $  G   o              o    6     G   o  9      9     G   o  9      	   G
   6      9      9      G      o 9   9      G   G   9   h   9   s '                 s    0 `P,P91 `P 
P9 `P5 ,P8 : ,	PM	 `P0 : :  P8 6 0 J	 P@ ; `P*PJ `P1 Q                                     n                           G   I        G      s   G      s   G   s              G   s    0 `P0 `P P4 `P P4 `P,P>0 `P.PI P   \  \                 (            G      o       G         s      I     G   G      s   G	   
       o   G   o  o       I     G   G     s        G	      h   o       I     G   G     s   G	   
       o h   o       I     G   G     s   G	        G   o  o       I     G   G     s 6 `P P8 `P 
P4 `P> `P PD `P;+P3+PC PH
 `P> `P PD `P: `P;J PH `P> `P PD `P;+PH PH' `P> `P PD* `P; PC* PH- `P> `P P4P  d   d   (                             G      s    G   s  0 `P P4 `P,P4 `P1 Q       J                            G   o        G      G   o  s    G      s @ `P,P8 `P P#P4 `P P4 `P1 Q   <   <                                 G   6 `P9Q         `                              G   G   G      r    G   s     G      s       G   o  I	   6 `P P4 `P+P4 `P P4 `P/P9P         c                             G   G   G        r    G   s     G      s       G   o  I	   6 `P P4 `P+P4 `P P4 `P/P9P          a                              G      r       I         I         G   	   G
   G   o I   6 `P P4 `P? `P? `P P9P    @   @                                  I   6 `P=P    @   @                                  I   6 `P=P                       6               I      G                           G   G   s     G   G      s    G   G   s     G	   G   s     G
   G   s     G   G   s                     G   G   s     G   G   s     G   G      s    G   G   s     G	   G   s     G
   G   s     G   G   s  T   .        A   0      G      s       I      G   G   s  6   6 `P= `P0 `PAF `P0 `P P4 `P P4 `P P4 `P P4 `P P4 `P P> `P0 `P P4 `P P4 `P P4 `P P4 `P P4 `P P4 `P P> `P0 `P P4 `P? `P PIP        Z                
             G     o                     o             G   o 6 `P/	P7 `P0 `P+PI `P P3Q         m                            G   G   o        G     G   %*         G     G   %o             6 `P P8 `P0 `P PCK0 `PDV  T   T   $                              G   G      G   o 6 `P P3Q    \  ,  k               *       $    G   G   o       G      o    +                 s       G   o  G   o       G	        o $          
       o s            G        G   o       G   6      9      9      G   6     9      9   o 9      G   G   9   9   h   9    s 601 `P P8 `P/P0 ; `P*P4 `PA*I `P+P*P8 `P P0 `P P#P4 `PA*F `P: `P? `P+PH `P0 : : 0 9 I PH 0 6 J PD*P    \  L     C          _                     4                                    G   i         G     G   s    G     G   s    G      s    G      s       	      G
   s    0 `P@ `P P4 `P P4 `P P4 `P P>0 `P.PI
 P                
       5              G      o I     G      o         I      G          o s   G   G	      s   G   
   o       I     G      s   G   6      9      9   s   G   G	     s   G      o       I     G          o s   G   G	     s   G      o       I     G      s   G   G	     s   G     G   s             h   s       h   s       h   s 6 `P PI `P P8 `P> `P P#P4 `P PD `P P8 `P> `P P4 `P0 : J 
PD `P PD `P P8 `P> `P P#P4 `P PD `P P8 `P> `P P4 `P PD `P PD `P: `P6I PD" `P6I" PD) `P6I) PD1P D   D                                G      s  `P P$P  H   H                                G   s  0 `P,P4 `P1 Q   L   L                                G      s 0 `P P4 `P1 Q       W                              G      r       I         I         I         I   6 `P 
P4 `P? `P? `P? `P?P 4  4                                 I        ^         G   #         G   G      s       G      G   h	   s T        
   A         G   G      s    G      G   h   s    6 `P= `P0 `P0 `P PI `P PN	 `P0 `P P4 `P PIP    D   D                             G      s 0 `P/P4 P   D   D                             G      s 0 `P/P4 P   @   @                                  I   6 `P=P    $   $                               0 @   @                                  I   6 `P=P    p   p   6                           c          G      G   h   s    6 `P; `P PD `P5Q   T   T                               G    G   o  s 0 `P P#P4 P        y                             |  }        G     G   s    G     G   s      I     G   G      G	   o  s 6 `P0 `P P4 `P P4 `P> `P P#P4P          R                              G   G   G      r    G   G      	      G   s     6 `P (P4 `P0 `P+PIP         m                             G   G   G        r    G      G   s    G   G	            G
   s     6 `P 'P4 `P P4 `P0 `P+PIP   H   H                                 G      r 6 `P P4P @   @                                  I   6 `P=P    <   <                                 G   6 `P9Q   X   X   (                             G   G   G        r 6 `P *P4P    H   H                                     h   6 `P: `PEQ                                     G   o        G   o  8         G      s    G      s 3   	      G      s    G      s    0 `P,P8 `P,P= `P P4 `P P>0 `P P4 `P PI	 P        J                              G      r    I      h   I      c   d    I   6 `P P4 `P; `P? `P)<P (   (                                          P                                I                      G      G   h   s 6 `P? `P0 `PAF `P PDP    D   D                             G      s 0 `P/	P4 P   X   X   (                          h             G     o @ `P P3Q  L  <                                     G              H    H       c      d             H o     G   "        G      s         .'   W   c    0  `P&fP0 `P= `P0 `P%I F `P/P8 `P0 `P/P4 `PD F )`P@ `P5 Q    L               t   t   =                          h         G                G   s    @ `P0 `P/PI
P   L   L                               G     h   s 0 `P PD P    T   T                                 s      Hs 0 `P)P4 `P+P4 P  t   t   ;                         h          I          G      s 0 `P= `PJ	 `P/P4P        F                           |  }        G     Hs    G      s      K0 `P0 `P P4 `P P4 `P; P          V                                    5        G      HG   s     .'      6 	 `P(fP0 `P PD `P@P               B         l                          G   H            G   0         H    HH     .'  
      HF `P0 	 `P&fP0 `P@ /`P@ `P6Q                C                                  G   &                  G      s   G      H     G     o      G     h   s   G     G	   s    G
   s  6 `P? `P0 `PAF `P/PD	 `P0 `P.PH `P PD `P PD `P,	P4P        b                 
        H    H   H     G     s   G           G      s 
   0 `P: `P: `P; `P 	P4 `P0 `P PI P t  T           
                           G   =        G     G      o s    .'   	      	        G   _        G      &H    G        Ho     G     s    .'      60 	`P&fP0 `P  P#PD "`P@ 	`P&fP0 `P0 `P P8 `P/PD !`P@
P   t            P          g   r   @   @                                G     H6 `P=Q   @  0           
               c   d                %        G     H    G   o      0   	      G     G     o s               .'  p      6 `P%K 	 `P&fP0 `P0 `P+	P8 `P> `P P#P>0 `PDF ,`P@ `P4Q  @               @   @                                  I   6 `P=P    <   <                                 G   6 `P9Q   D   D                                  I   6 `P= `P1Q <   <                                 G   6 `P9Q   <   <                                 G   6 `P9Q   H   H                                    h   6 `P: `PEQ   @  @                             G   o                 G         G   o     "   	      G   o      s       K         G      o      G     s    G     s    0 `P,P0 `PA F `P= `P,P@
 `P,P(PI `P0 `P P8 `P P4 `P PI P       i               H             I     c    I      |  }        G   s    G     s    G     G      o s    G	     G
   o s   G   G      s    |  }      G   s   G     s   G     G      o s   G	     G
   o s   G   G     s    |  }      G   s   G     s   G     G      o s   G	     G
   o s   G   G     s    G   G   r   :      |  }      G     s        o     G   s    G     s     I   E     G   c   d    s 6 `P= `PO `P0 `P,
P4 `P/
P4 `P P#P4 `P  P#P4 `P PD `P0 `P,
P4 `P/
P4 `P P#P4 `P  P#P4 `P PD `P0 `P-
P4 `P/
P4 `P P#P4 `P  P#P4 `P PD `P0 `P0 `P/P4 `P+P8 `P+P4 `P/P4 `P@" `P &P4P  X   X   &                              G      r    I   6 `P P4 `P;P @   @                                  I   6 `P=P    @   @                                  I   6 `P=P    <   <                                 G   6 `P9Q   @   @                                  I   6 `P=P          k                              G   G   s     G   G   s     G   G   s     G   G   s     G   G   s  6 `P P4 `P P4 `P P4 `P P4 `P P4P                                 G   G   s    G   G   s    G   G   s    G   G   s    G   G   s    G         G	   
   s    G   o  G	      s 6 `P P4 `P P4 `P P4 `P P4 `P P4 `P> `P P4 `P+P/P4P    T   T   $                              G   G      G   s 6 `P P4P    H   H                                     h   6 `P: `PEQ                                    G   s          %   %o       G      s        o G      s    G	   G
   o       G     s    G   s     G   s  0 `P-PD `P P8 `P P4 `P+P.PD `P P8 `P PD `P,P4 `P,PD P         r                                   G   6      9      9   6   	   9
   9      G   G   9   9   h   9   s 6 `P: `P0 : : %? 0 6 J PDP       U                  	         G   !            G   s +             G   o    G   s 	   0 `P0 `P.P>0 `P P+PI P   H   H                                     h   6 `P: `PE
Q         \                  
           G   o  .         G      G   o  s          G   s  
   0 `P,P? `P P#P>0 `P,PI `P1 Q       }                
             G         G      s                  G   g   o            G     h   s 6 `P? `P 
P4 `P0 `PAF `P/P7 `P: `P PDP       o                           G      o       G      s    |  }      G    s    G     G   o  s 0 `P P8 `P 
P4 `P0 `P.P4 `P P#P4 P H   H                                     h   6 `P: `PEQ                   	                      o       G   6      9      G   G	   9
      9   6          G   o  o G      o 9   9   h   9   h   9   s 0 `P+P8 `P0 : 0 : % P#P/P= J J 
PD `P1 Q                                 G   h            G   o                G   s     G      G   	   o s ;         G   s  
       G   o    G   s    0 `P0 #`P.P8 `P0 `P,P4 `P P#P>0 `P,P4 `P P+PI
 P   T   T                                      s     s  0 `P P4 `P: P  H   H                                     h   6 `P: `PEQ   @   @                                G   s  0 `P,P4 P                     ;               I             o I             o I             o I         G	   
   o I         G	      o I      G   G          o s    G   G      G   s       G	      o I      G   G          o s    G   G      G   s    G   G      o G      s    G   G      s        G      G   o  s        G      G   o  s          G   o  s 6 `P= `P/P9 `P/P9 `P/PI `P P9 `P P9 `P P#P4 `P PD `P P9 `P P#P4 `P P4 `P P/P4 `P PD `P69+PC PD `P69+PC PD `P63+PC PD!P  `   `   *                              G      r    h   I   6 `P P4 `POP          M                            G   G   6         G          o s   G   s     0 `P0 `P P#P4 `P*PI P          N                               o G   h   s        o G   h   s        o       G   h   s 	   G
   G      >         |  }      G          o s          G   s        G   s         o          o      G   {   $   h        |6   	   G   G   9   9   9   9   d9   
9      9!     }     G     s 3       "   o     G   {   8      |6#   	   G   G$   9   %    &   o 9'   9   9   9   d9   
9      }     G     s I       (   o     G   r   N      |6)   *   9   	   G+   G,   9'   9   9   9   d9   
9      }     G     s ]       -   o 	  	  G   L   a   .   |  }  
  
  G/   %    0   o s 
  G   	  s i       1   o     G   L   m   .   |  }      G/   %    2   o s   G     s u   3   |  }      G       4   o s 	   G5   G6   k      7   |  }         8   o G9      G:   o  s     ;   o   <      h=   s    0 `P+P/PD `P+P/PD `P+P8 `P PD! `P0  `P0 `P P#P>0 `P,PI' `P,PD) `P+P8 `P+P9 `P@-  `PJ1 `P; 0 6 6 6 7 7 M1 H: `P/PI= `P+P8 `P0 `P; 0 +P8 6 6 6 7 K? HH `P/	PIJ `P+P8 `P0 `P; : 0 6 6 6 7 KL HU `P/PIX `P+P8 `P0 `P0 `P P#P4 `P/PI^ `P+P8 `P0 `P0 `P P#P4 `P/PIe `P0 `P P#PDh `P0 `P0 `P+P P#P4 `P+P8 `P/PIpP   l   l   .                           |  }        G        o s 0 `P0 `P P#P4 P          v                           |  }      G   G      o G   o       G     s    G        o G	   
   o s 0 `P@ `P P*P8 `P/P4 `P P/P#P4 P    T   T                                       o h   s 0 `P P(PD P       }                                o G      o       G   6      9      9	   6
      9   9      G   G   9   h   9   s 0 `P+P/P8 `P0 : : %> 0 J PD P       X                           G   %         G   G   s *                 o   G   s    0 `P0 `P P>0 `P P+PI P   L   L                               G     G   Hs 0 `P P4 P   @   @                                G   s  0 `P,P4 P        K                              G      r       I      I      I      I   6 `P P4 `P? `P; `P; `P;P T   T   $                                 G   G   o  I   6 `P 'P9P    @   @                                  I   6 `P=P          H                               I      G   o  !         G   G     s    6 `P= `P+P= `P PIP        Z                             G   G   s     G   G     s    G   G      
       s     6 `P P4 `P P4 `P0 `POP     9               )                          I      G   G   s     G   G   s     G   G   s     G   G   s     G	   G   s     G
   G   s                      G   G   s     G   G   s     G   G   s     G   G   s     G	   G   s     G
   G   s  )   6 `P0 `P= `P P4 `P P4 `P P4 `P P4 `P P4 `P P> `P0 `P P4 `P P4 `P P4 `P P4 `P P4 `P PIP        D                              G         G   s     G      G   h   s 6 `P? `P,P4 `P PDP  D   D                               G    s 0 `P/P4 P   <   <                                 G   6 `P9Q   <   <                                 I   6 `P:Q  <   <                                 G   6 `P9Q   <   <                                 G   6 `P9Q                                    G        G      s   G   o  )         G   s    G   s     h         G      s 6 `P? `P P4 `P+P? `P,P4 `P+PI `PJ `P P4P `   `   &                             G      s    G   s  0 `P P4 `P,P4 P    H  H                             G   s    G        G      .        G     G   G   o  s           G      	   G
   6      9     G   9     G   9   9   h   9   s 6 `P*P4 `PN `P0 `P $P#P4 `PAF	 `P: `PO `P0 : > > 6 J PD `P1Q    L   L                               G        Hs 0 `P P4 P    L   L                                G   G     s 6 `P P4P  P   P                                  G   G      s 6 `P P4P    `   `   *                              G      s    G   s  6 `P P4 `P+P4P              	       -       $         G   G   o       G                   o         G   ]   
     G      s   G   s  0             G	     s       G   
   /          o      G      o         G      s   G      s   G       G   G   o         G      K  G         G   6      9      9     G   9     9   9   h   9   s 6 `P: `P PH `P0 `P*PM `P01 `P/P4 `P+P0 ; `P/P4 `PA.I `P0 `P> `P/PM `P/P4 `P PD `P> `P P8 `P0 `PO `P0 : : > 9 6 J PD.P              #                         l   '         q                           G   (         G        Hs @         G      s        G   o    G   s    0 `P0 `P P>0 `P P4 `P P+PI P 	  	                              I     G      o             G                    G   o                    G   o I	       G
      o I          G        G	   %o o                 G	   %   %       I     G
      o     G   N   #     G      o     G      s   G   G     s *       I     G      o     O   .         G      o o         HI        HI   (   6         I         I   :         G   !   o o         HI"        HI#       G   $   o I%       G   &   o    H     G%   I   I'       G   (   o I)     G   *   o     !   P     +      o I,   S     G      o     G   G-     s     I.     G   /   o    \   0   G1   G/   _       G   2   o    b   b   	      I3     4      e   5   |66   	  92     }     G)      k     G7   8   s m     G   9   o 
    G:   
  s    q     ;      s     G)   J   u   <   |6=   >   9?   @   9A   9B   @   9C     }      |   <   |  }    ~     GD   E     G	   %s *      F   |6G   	  92     }          IH     GI     GJ   o  s   GK   s    G
   L   o     G   I        G      o     G   L   s   GI     s          M     G	   %o IN     G   O   o     GP   Q    R   o s   GI     s     IS     G   O   o     GP   Q    T   o s   GI     s     IU     GV   W   s      X      hY   s X      hZ   s X      h[   s F"0 `PM% `P/P8 	`P0 `PK) 	`P.P0 `PK, `P P9 `P PI/ `P P#P8 	`P> `P@3 `PN5 `P/P8 `P0 `P P8 `P P4 `P PI; `PN> `P/P8 `P> `P P#P8 `P0 `P00 `P? `P@H `P P#P8 `P0 `P@L `P "P9 `P 'P@O `P !PIQ `P/P8 `P> `P.PNW `P P8 `P P4 `PN\ `P/P0 `P/P0 `P> `P0 `P+-P8 `P0 `P PId `P/P8 `P/P> `P0 `P0 `P; : : 6 Nh P@n0 `P*	PMq `P P>0 `P+-PMu `P> `P P#P4 `P+
PDz `P/P8 `P0 `P P8 `P P4 `P/
P900 `P P90 `P P80 `P P#P4 `P/P4 `P>0 `P P8 `P P#P40 `P/P4 `P>0 `P P40 `P: `P/P4 `P/P4 `P/P4P @   @                               G     s  `P/P$P @   @                                G   s   `P,P$P    @   @                                G   s   `P,P$P    d   d   -                                o       G      h   s 0 `P+P8 `P PDP  l   l   .                           |  }        G        o s 0 `P0 `P P#P4 P          W                              G      r    6   I      6   I      6   I      6	   I
   6 `P PD `P? `P? `P? `P?P    @   @                                G     H6 `P=Q                         
           G                G   M           H    G     o            .'  
   6 `P> 	 `P&fP0 `P> `P/P= `PA	F #`P@ `P1Q                 a         h                	           G                G   4        G        Hs   .'  	   6 `P> 	 `P&fP0 `P PD #`P@P                H   H   H                                     h   6 `P: `PEQ   p   p   1                             G   s     G   o           0 `P,P4 `P,P= `PA V    t   t   :                           G     H      G    s   G     K6 `P0 `P.P4 `P?P    t   t   <                           G     H      G      s   G     K6 `P0 `P P4 `P?P               	             $    G     H     G     H     G   o         s   G     s /   	          G       s    6 `P0 `P0 `P+P81 `P)	P4 `P.P0 ; `P PJ
P           j   "           >   $         l        	       &               G   o       G         %o         o     G        K   G         %	   %o     G
        K   G         %   %o     G   .         G         %   %o        G   .         G         %   %o   "     G        K       G   h   s F `P/P8 `P P8 `P*P8 `P@ `P P8 `P@
 `P P8 `P0 `P PM `P0 `P PM `P@ `P: `P PDP L   L                                G      s 0 `P P4 `P1 Q                                 I         o G      o       G      o G      o      
        G   Z         G        Ho          K  G	     s   .'          I
     G     G   o  s 6 `PM `P)P/
P8 `P P/PH 	 `P&fP0 `P P8 `P> `P/PD '`P@ `PN `P P#P4P           `   n   H   H                                 G      r 6 `P P4P <   <                                 G   6 `P9Q   `   `   /                              G   G      o G      o 6 `P P/P3Q        T                              G   o        /         G   s     G   h   s    6 `P+P9 `P? `P,P4 `P PI	P        C                              G   s         o G      c      d    s 6 `P,P4 `P+P 7)P4 P   p   p   5                              G         G            h   6 `P? `P? `P: `PEQ   D  D                              G   G   -         G          o s    
      G   s     G   s     G	   o        G
      s    G      s    G      s    G   s     0 `P0 `P P#P>0 `P,
P4 `P,
P4 `P,P8 `P PD `P P4 `P PD `P,PI P              
       -             I       G      o I       G      o I      G   G	         
   5         |  }      G      s k            A         |6   
9     }     G      s             %   %     G      s     I     G      o     G     G      o s   G     G   o  s   G   o      G      s   G!     s 6 `P= `P P9 `P PI `P0@ `P0 `P*	P8 `P P> `P0 `P++P8 `P P>0 `P@ `P P4 `PN `P/P8 `P P#P4 `P P#PD `P+P8 `P.P4 `P.P4P   H   H                                 G      r 6 `P P4P \   \   &                              G            h   F `P? `P: `PEQ  \   \   )                                 o G   G         r 0 `P+P P4 P                                     I     G      o       G   d         |  }      G      s   G   o        	   o G
        s    6 `PM `P/P8 `P0 `P0 `P/P4 `P+P8 `P+P PI
P 3  `$      `$      `$      `$      `$       7  Z     P y  q     `    #  "      `$  #  "      `    $      l    p}    p#    p  pd     @        h  g    {    px    py    `  V        N  	  `$     
  `    `  Q   `   `   `$          `$                `                  ] )  
  `   $       ` $      `        q   :   @1   @E   @J  ^  \ I p/  J pg K pL p8   `     y                `y  
  !    a   `  "          #    `  @$    %  &  x  '  (  y    `      	  
            @       a     `m     p  `  p  p  p  p   p    ` 5     0  6  7     `=    `  `-  B    6  :    pD  2  E    `  6  :  ;  <    @2  5  7  .    -  /  #    p  pF     `!  `  `  p  p,    @-  
  p.  /  0  m     p  ` 	  p*  "  `H  I  J    K  L  M  N     P  O    Q   $    S  R  U  T  V  W  X  #  `Z  [  $  \  ]  ^  #  _  `   a  b    R  S  T  c  V  W  (  `$    )  `)  v  %  `  n  o  W  q  p  s  r  t  u  &  `)  v  w  x  y  z  {     j  k  |  '  `}  i  ~    "  E    p*  `w  ,  `$  `)  ,  	  @e  	  f  Y  g  G  h  H  Z     i  j  k  l  
  @m    pw  E    p$  #  `                    +  `v  I      n          @  p    -  `  r  p  {  )                 1  `                0  `  W  %                  @#  p  /  `  "  p  .  `!  p4  `          /   5  `D  /   3  `E  ,  p  I        -  p6  `    k    /   7  `      q     +          N  b    W        a         I      /   8  `    :  `    9  `  +         2  p  ;  `+        a      <  `      ?  `  k    >  `          
     b    W         I    )  pk    =  `  W        k    /   (  p@  `    W      /     k             B  `    ,    @         A  `m   4  pD  ``      Z    Pq         ,    @  C  `W       6  p2  `+  p.  p/  p0  p1  p%  p  @G   &  p  '  p  *  p  `   3  p    @        5  pF  `
      H  `
      G  `       9  pI  ``      Z    Pq      
        K  `      /   J  `m   =  pL  `     W  `    E  `;  p  8  p  @G   :  p  `   <  p    >  pN  `a     W  I  ,    @     +         `    Z    Pq             P  ``      P     Q  `R  T  O  `         B  p  C  p  R  `  (  +  H             S  `         
      i      R         U  `        T  `m   G  pW  `    V  `  m   I  pM  `@  p  @G   A  p  D  p  E  p  `   F  p      @H    H  pY  `n   [  `k    @     Z  `n       `      Z    Pq   
  R   i       k    @       M  p]  `  i             
        \  `O  p            I       _  `  	   ^  `m   Q  pa  `  	   `  `W   
  S  pX  `K  p  @G   L  p  N  p  `   P  p	   R  pc  `  d  `     +   k     #        a    ,    @  @q     e  `,    @              @    g  `    f  `      +       E  Y  pi  `    h  `      +       E  [  pj  `&  ' ( +  )     %   /       P        @T  V  + * b    W  ,   - ^     . 0   @  /   @   @!  @ k  `'    1   2   3 n  `          o  `D    m  `E  `  pI        a  pl  `_  p'                p  `  `  5 6   q   7 q  `2 r  `,  "  @#  @T  V    H  $  @  / -   s  `  +  `  6 5   /   q     Z    Pt  `  +  9 u  `  ;   +  v  ` w  ` x  ` y  `'        {  `       z  `m   m  pb  `U  p  @G   V  p W  p X  p Z  p \  p  ]  p( ^  p  b  p c  p& d  p, e  p2 f  p' g  p: h  p< i  p= j  p> k  p  `   l  p   %  @)    T  %  k  q   5 ? 9   }  ` A ~  `' 2 B    C         D   E   `2 B   `  +  `  F     /     Z    Pq     `  +  9   `  A       `m   u  p|  `o  p,  &  @    `  '  @G   p  p( q  p& r  pB s  p' t  pA (  @  )  @0 % q     G 9   `   ;     `k  L     `y  p`      Z  	  Pq   k  ;            
                `      /     `m   {  p  `W   M `  ;     `I w  p*  @G   x  p;   `   z  p    |  p  `  ,  +  @ O   +    `T   `    7   `Q         5    R S +  E    p  `  
  U        i      `  O     P   `m     p  `    Z   [ O     `W   W X   p  `~  p,  @G     pP   p  `     pO -  @V T       p  `  ,  .  @ ]   +  
        `    /     `^ a `    -       c      ]               `^ e             `^     ] f       `  e   k    `  p  k         ] I      `           `  ]       `m     p  ``        Z  
  Pq     ]     `W   i j   p  `  p/  @G     p^   p    p    pe   p    p  `     p] 0  @      p  `  ,  1  @ l   +  m n    a   o   `q a  )  +  p   `X   `       
  r       t I  u   pn o m )  v   `w p   `t m )    `t m v   `  k  u   `          i  t E    p  `       p )  V  0 |  t n    }   i      m k      u   I      po   `  l     X   m o   `m     p  ``      Z    Pq       ,  4  @l     `W   ~    p  `  p2  @  po   pX   pn   p)    pv   pm `     pl 3  @p        p  `  ,  5  @    +      b  W          `      `     5        `,  7  @  H  8  @-      9  @T  V        `       `   `  5            p      +       `     `        `    `Z    (   )     p  `+   `      a       `    p|   i       `        i  )     R     `        i  v    R      `     a         F      R   `B    =          `  B    v )     `    `E    p  `   =    `        i       `         `m     p  `       `W       p  `  p6  @G     p=    p    p    p   p   p   p   p   p)    pv   p   p   p   p    p    p `     p :  @             p  `  `  `  `  `  `   /        `     p  `     `  `  `?   `?   `   Z    P q     `Z    P  p  `  Z    P  P  P  P  P  `Z    Pq     P     `  Z    P  P  P   ` Z    P    P    `Z  "  P   !      `!  PZ    p  `Z  #  P$  P%  P  `  q   Z  &  P  '  P   #     [  (  P  "   >     `Z  )  P*  P  `Z  +  P ,  P -  P   ` q   Z  .  P   #           "      `    `" #   `   & >  ' (   `Z  /  P  p0  P  p1  P  p  `[  3  P  Z  4  Pq   <  >  2 3   `[  6  P  <  3 2   `* 2  PZ    p5  P  p7  Pq     `9  P  [  :  PZ  ;  Pq   F G   `Z  8  P
  *   ; < =    p<  Pq     `Z  >  Pq   ?  PL M    `* Z  =  P  p@  Pq     `Z  A  Pq        `Z  C  Pq   D  PE  P S T   `Z  B  P  p  `Z  F  PU G  P H  P V   `Z  I  PX J  PZ   `Z  Q  P* R  Pq     `Z  L  P* M  Pq   N  PO  P^ P  P  pb c   `Z  K  P  p  `  `Z  S  Pq   T  P^  U  PV  P      W  PX  Pj k Y  P  p      `Z  Z  PU [  P   `Z  \  P]  P  `q     `     )  <  >  Y  ^  P(  q       Z    p     `      `Z    p_  P  `Q       `Z  `  P  p `Z  a  P* b  Pq    `
   `c  P        Z  d  P  p `  :  f  P    %      `q      Z    p ` Z  g  P     g   `  E   `    Z    P   P   P
    P   Pq      P   P~   	 `  `  p  p  p  p  p  p  p  p  p  p  p  p  p  p  p  p  p  p  p  p  p  p  p  p  p  p  p  p  p  p  p            p   p>  @7  /  s u   w *  x  i  e  P  `  p  p  p  p<  @  p   p    p   p `    =  @  p  p     p  `Z  h  P `Y  q    `q    `q   l  P Y      Z  m  P [  <  >  n  P  2  p `   
 `  p  p  p        I     p i  Pj  Pk  P `   ?  @   `     `      ` D   pE   `$      `             p $         `n  - . ,  / 0  1     `I  6 7 * 8 9  `      `=  >  `Z  u  P
  v  P `  q     Z  w  P x  P `K  E H G O   `Q B    `< W  F    Z  S  T U V W  } ; X ! `K  Z [ G   S  R  0  T  ] \  _ ^  a ` b   d a   %  &  V  e / f W  X  # `$ `$  5  E  @         d  % `$   5  q   & `" `K  Z h G   j i k R  l / m \ o p X  q  pr 0  s V  t f v u w     x - y  7    Q   + * z f   { $  }  `  $       O      8  p     O  p      p y  P    : W  F   T   S  %  (  a      k   ' `     7       ]    =  #   `  q    p p p pE   p( `  ) `-  * `   + `   W    -    %   e 
  !  - `5     . `5  / `q 0 `w , `2     p   p! p" p 2 `  E  3 `    4 ` E  5 `6 `7 `   8 2    #  8 `  8 2    #  9 `  7  : `  Q B     y  z        ; `  B     ~    = `  B    > ` 7  2         ? ` < `: 2     / p0 p F    1 p  @ `A ` 1 `8 $ p% p& p ' p ( p ) p * p + p, p- p. p2 p3 p C `D `$     ^  z  P F `#    E `#      8 p G `  n  -     I `       J `       K `4     3 L ` M `H `          ; p < p  = p  > p ? pO ` } P `  Q ` x R `+ S `+ T ` U ` N `  n  - . G    K      X   R   5        } 	 P       A p        H   B p! " # C p  [ % & ( ) * D p- . / E p1 2 3 4 6 7 8 9  ; < >  ? F p B  {  P      D E G pW `X `  Q B      q   .  b  i  l  k  g  o  u  h  r  y  z    n  -       ) . 2 7      j   Y `   Q B  L F  @M  Z `   V `  n  - . G |  P  H   I   I pF    : J p K pq r L p\ `  [ `P    N p}  P      E  ] ` ^ ` _ `` ` ; X   q    w B `5 p2    6 p7 p9 p: p@ pH pM pO p P p Q pR p b `5 R (  7     c `5     #       (   T          =  d `       ?   7  4 3          X 
  S e `7      S (  f `Y ? 7  Z   a  q   [    \ ] (  g `a  [ \ ]  Z  ~  P_    P  P       7  (  a `2    T p U pS V pR W p X p Y p h `j `[ q   k `[ q   l `\ q   m `\ q   i `@ q   $  a  Z  \ p^   ] p^ p] _ pn ` Z    Pq   a     P] o `   X  Y    P Z    Pq   [    P\   Pa    P] p 
  q $  p `v r w g   Z  x r `^  r q     
  q `t y z   Z  d p  Pq   s `|  } t `|  ~ u `d  Z    P
  a  [    P ]   P
        q    }    P  P*   w `Z    Pq     Pv `Z    Pi py `Z    P  
  z `x `G  @ a   ] q     Pk pl pZ    P  P | `q   \ [   [   )     x   { `d `   P  P\    [ Z    Pq      P   n p I x } } `H  @ 1  ~ `    `+ 2       1  `     r p: I     `:       F    `I    %  (  W   `2 /       	  f     `D      E   `  (   `2 /   (    `q    ` ` `   `  ` 2          Z    PU   P L  o /  E   p  `2    / (    `  ` t pu pv pw px py pz p  { p | p } p ~ p p p  `a  Z    P   P  P  P  +   P   P  `a  ]  ` q    `[ q    `\ q    `
  Z    P `
  Z    P ` q   [ Z    P p\   P p `[ q    ` Z    P pa    P p  Pq      P
  ]   P  P p  P p p  P        P g   Pt   P[   P   P\   P  P  P p ` q    `  P  a    P]   P Z    P p  P  Pg  [     P  P  Pq   d `   P  P\ `   `     ` `    P  Z    P p `  P     P `  P   `  P  P-   p p`   Pa    P    P[ q     P Z    P
  t g ]  p   pd   P            P ` Z    P     Pq    [    \ `   P  P  P        P  P  Pg -  =    
   `$ [ q    g  `       A  @ B  @ C  @ D  @ o  P     p  P q  Pr  P  s  P t  P      }              	           k  j   ! % ' ) 	 p+   2 3 4 
 p5  p:  p<  p?  p@  pD  pI  p  p  p  pd  p # p 4 p1 S p Z pY `  [ p` ` pd a pg s r b pt c p  e p f p g p| h p j p m p o p p p- q p s p  pM  p  p  p+  p4  p9  `   ` p & % I  - . 0    `  p*  `7  `:  ` 8 : < `  $  5    b  = /      ` p 1   7 q > ? @  `   1 I   2 3   4  r    5 ` 6    p8 9  p   p `n    ` q : m    p ``  7  `M  @m   ^    P p ` `  q 4  E G      ,  I $  J N  @m   ^    P pL O  @M N O P P  @ ` q      ` q      `V  `,  R  @4    =   `X Y 4        `Z    Z [ g   `    pG     X  m    p `d  e f g /   \ ] h    `j $  k l n    `$  k n n    `$  k n   ;  `     `     `,  4    `  q 4    Z    Pq    /    ` `m   ^    P p `4 I  ` p `     =  _     Z  @k [  @ > \  @S  ]  @ e ^  @   m    pE  p           ` ,  k  _  @ A =     `    A  ` n     $          `$   `,     `  @   n      p  /     `  = a  @k       \  `   ` `     `   `     ` @      n   `  #  k    ` `n   $   `d    p    `$   1 I   y    E  `b  @   =  `     a  p ` ` ^ .  \   `  c  @     `e |         `e h   ` j  $  E   d  @O  4  /     Z    Pq    S    h   ` 1 I            `    J  ` J G      `      `  $    b 5   4 J    `     P  /   O    )     Z     e  @  n    $  k  `     
   `  /  /   n   \ ]            x   g         `    `n    `    p `h         \ `     <  ^  f  @    q          
       x  7         ``      ` |   `  p `   $  j   `  P     `q $   `=       p `;   =         j  $  `   `  ` `q     ` `4  P /        `S  $  >  `> S  $  ? q =      `   h  @ A  q    `G      ,   `4  ,   `t  @`  9   m   ^      p `u  @4    `     P   ` v  @  q 4     `w  @  q 4  E I $  x  @ `Q      q    /       `  `   `   `m    p p   !   p   p4  J  ` `  y  @m   ^    P p `4  J       I  `  ;   =     5     j    ` J $   q ?       @    A   `l    J $  {  @q      |  @    }  @ ,  ~  @      :    {     px  S  A 	 `l   
 `l    `  l  `l  `l  `l  `l   P   `l   P   `l   P  	   `l   P   `l   P   `l   P   `l    P  Z    Pq        Q   `  Z    P|   l Y      i   `A  `"        p5   `,   L  @ p:  pA  pB  pE R :  Q  @ pS  pT  pU  p4  p   S  @T  @U  @J V  @   W  @y  \ ]    ^ @ _ ` r a b  pc  pi  pm  p  p/   pg    po X  @p P r q t s u   w v y x z   | { ~ }              !     Y  @ p  pq  p  pn    p  p  p  p  p  p p   p p  p  p  p|    pe  p  p  p  p  p  p  p  p  p  p  p  p  p  ph  p  pj  p  p  p g  @ p    p   p    pl  p  p  p `  i  @j  @k  @l  @m  @n  @o  @ p  @q  @ r  @s  @  p  pN  pO  pM  pG  pL  pI  p z  @ p p p p p p p p p  p p p p p p p p  `,    @e             `   @
 p `j       ; /    `   `>   `j       ;     ` pj     @ p  p  p " `      ! `   p `)  j         m     @#     p,     @ p % `   0  7  Q  Z u  x  & ` 	      \  -  [  ]  ( `' `Z    Y    P^    P   -  
  !     p&  [     ]     q   * ` [     ]  ) `  Y    P   (  \    Z  ^  q      [  Z    P p   $ ` p p p p        P    Z    Pq     @b  t  n  v  f  r     "      )       |   g  , `   G   ;  u	  
      Z    P  P   + ` p  P9  I  6    q  7  ` Z   @   q   Z    Pa  c  - `  @a  d      e  / `d   a  Y    @        Z O    e  0 `   @     q       q    P. ` p  @  p   1 `  h   Pq  ! "   P$   P& '   P) * +   P#    P  P  P  P  P2 3   P5 6 q   7 Z    P   9   :   P|  <    P> ?  P P P PD  PF  P3 `   G u	 ;  ; X    Y  Z       H I 5 `J ;  X  4 `% p ;   2 `# p$ p P PL 9  I  6  q  7  ` Z K    X     M    N G 
  !  L  I O 6 `      I   2 P 7 `   	 P  R S 8 `g  h  a  c  d  
 P     P   e  
    Z Z     L K  U G ; V X  I H  9 ` I     : `  K   o   @g  i  h  < `I          G   Y          ; ` P  & P  @g  h  i  E  = `	  ; `+ p   ` P      q  	     @, p' P# ` p p p p! p" p& p' p( pW X Y Z [ \ ] ^ _ `  P P  @b 7 ) * " 2   @S   Pd  P+  P  P PF  P Pk  Pm  Po  PR q   r s   t  Pq  u v  P&   Py  P{  P P P P  P! P" P# P $ P   @5 c      m    @     @'    @   @     @  b   @ U V   @   @   @   h % P I  ) p * p   @       9  ?      O     6   > `    @     @ `  ? `  $  m   / p q   A `    B ` `     C `           `  V   k     @  D ` P   E `          F `$  ,   G ` H ` Z     @    Q          J ` P   K ` P   I `   @       Q            P  9 p : p  L ` /      M `P   N ` O ` Q `       P `@ pS `$       R `$   
  m   B p U `       T ` $  m   N pV `        W `$         
       @X `$              Y `    $   )  j k 7           @[ `  @  @    P       @  7    @
 5 \ `  @  @     P   J          @        7    @   
   @   5 ] `  @  @P      7  ^ `  @  @    " P           @    7  Z `  @T p U p V p  W p! _ ` /   % $ ` `$ a `( (   c `x  '   0 1   ] b `+ , $     @-     @.     {    / \ px  e `  f `) d ` # 2  /     * +   , 3 4 q   5  6 & $ 7 ^ p1 $     9   : v W    ( ; _ pg `3 /   =   > h `< 2   /   ? #  k `I  H G j `$     @    /   {      A     B   @D C F E   d px  i `c pl `I   5 J K =    L  M N O P   1  Q R m `? 5  q   n `=    L I   q   J P 5  U Q   o `V p `? 5  q `> r `> u `H X 5  ^ _ v `T 5  U _ t `W F $     @-   /   {      ] /    n px  o py  s `m pw `a x `a z `b @ Z y `s p| `T S _   { `u p} ` Z    `     e      J f        7  $  ? Q   C I    P h W  J Z k F    ( l m 4  5 U & A n d 7 c < 2  /    $  o   p V   k  q ~ `s /    `u  `u  `u  `w y  `$  |      } R  ~  `x  z x  `v $     @    /   {     t   w    px   `~ p `  `  x q  I   p  `r /    `      `w y 5 7    `  @ 5  5  7     `$         `r /    `+  `      `w 7  y  `  @ 5  7  + .  `$     ` /       `    q   k    `        `x     0 1   ]  `     @  $     @        {         /  px   `  p `    `    ` ;     p  p ` Z            `$    7  q        `    $   `    $   `    $   `    $   `    $   `    $   `	   $   `	   $   `	   $   `	   $   `	   $   `	   $   `$  #   `$  #   `   $   `         $   `
      $  7   `  $     `  $      `  $      `  $      `  $      `     ` !   ` "   `     ` !   ` "   `V `    @  $       @  `V `    @  $       @  `     `    $  "     p p p p p p p p p p p p p p ` `$     @    /   {      #     @p   y   px   `  '  `) 0  x  0 *   +   @  J - ,   1  $  #    . k  / 1     2    `x  0  0     1  k  4 5 L       ` !   ` !   `x  1  L   $  r 7 7  (  )  q      8    9 `   Z  ; < "     p p0    `     `     `x  1  L   $  r 7 7  (  )  q   ? @ )  A      8    B `   Z  < ; "     p p0    `     `     `x  1  L   $  r 7 7  (  )  q   ? E    8    B `   Z  < ; )  A   "     p p0    `x  1  G ]   H   I J  K o 0      `q    `  P `   Z      `  Q 6  R   7 V 0 $  Z  S T  `   Z      `6  R 0 $  Z  S T   X -   `6  R 0 $  Z  S T   X -   `6  R 0 $  Z  S T   X -   `6  R 0 $  Z  S T U  ^  -  V W  H Y J   I G K ]   Z  `                                       @                p p p p p p p p p p p p p p p p p p p p p p p p p p  @ p  p  p  p   p!  p"  p   `$    "     `    b   c  `M O $  i   1  `g q   ^  ( P$  m    p `x  f  l q           m   0  `0  o  `$     @        k     {    @ 5            px   py   `  B   `  `F   p$    "      q  p `  `$  s t u v x   @    y   z { | }   ~     p5      k   :   @  @  @  P       E   @  @  J  8  \   `$         `    q   m    p `#   `"      `$     q       c   b #   `  B   `"      p ` `$    `q    p p p p p p p p p p p p  @ p  `s /        `  `  `  `  `  `  `      `        `     `    `  1     L        0   `          Z  S  T   `0 1  o  `x   0 1    `        0 1   @  @  n   @  $     @    /   {    #     @ p  py   px   ` p `               ` /     `   `  `$  Y   `  `   I  1    K   ]    `x    0 1    `  @    $     @        {         /  px   `  p `    I  ;   `s /     @        	 ` #  
 `   `  `   /     `  `$    5   `    `  5    `    F    ) P       7    Q     
  !    `    p `   @S  R   T    i s /     $  ,    `                  u   5  `    @       $      ` /          @      `  `       `     `   `   /           p  p ` /      0    `  `        `  `   ` ! ` Z    h     `   - .     1 u   $   `   $      5       1    " `               # `     	     /   $ `s /     	    	 $  ,    @	 1 	 % ` ' `	 	 	 		 	 	 & `		 
	  	    	 E    p$  	   ( `		 	 $      1   ) `* `$  ,    @	   @	   	  		    + `, `- `		 
	  	 	 	    	    @ q   =  	  / `		 	 "	 $  I  (  . `	 $  I    (   H  T  E  ( p0 `	 1 ` `     	 ( 2 `		 
	 B 3 `      	 4 ` Z        `   	 1  $    5 ` `   	 6 `s /    (	  )	 q    7 `   8 `   9 ` : `   +	 ,	 ) -	 ; `- /	   @	    1	 0	  3	 2	 T  4	 V  5	 7	 6	 q   8	 9	 :	 f /    	 %	   ;	 <	 1    < `   @  >	    ;	 <	 1    = `   @  ;	 <	 1 > `*	  .	  =	 ?	  1 B	   #   D	 k F	    G	  F  k  I	 ? `(	 A ` @ ` L	 M	 (	   1 ]   N	    O	    P	 Q	 R	   S	    : p#    T	 F	 k  U	 C `    X	     
  Z	 ]	  _	 q     a	 b	 c	 d	 e	 f	 g	     \	 B `W	  < pE `      X	      D `> pF `     $    k	 #  H `i	 J	 m	 n	   $    k  o	 G `A pI ` M	 p	 q	 L 1   e  n	    r	 O	 T	 J `$  s	  `  9   t	 }   ;	  Z u	   v	 w	 V	 W	 x	 O	 u y	 z	 T	 {	    4      |	 Q	       $  ~	        	 K `O	 `  Q L `O	 `  Q T	 M `O	 `  Q T	 N ` q      S	 O ` #  1 (   Z  	 P `    	   Q `    	  V k    S `	     O  R `    	 $  m   L pV ` 	 L	    L 	 M	 	 ( n	 k  	 W ` 1   0 p  ] 	 n	 S	 k  	 U ` 	        _	 #  S	    1   w 	  	 q	   	 	 (   @   7  	 	 	 	 	 M	 	 p	 k  	   @ 	 	 L	   	 	   	 	 ~	 	 	 	 	  	 $     @        {  O px  P py  T ` N pX `s /   	   @	      	 	 	  	 	   	 	 	 	 	 Y `	 Z `	 '	 q	 K	       [ `$     	   	 p     @ 	    	 	 	 	 `  5 	 	   	 	    	 	 	 	 	 	 ;   	 	 	 	 	 	 	 	 	   	 	   	 	 k  	 \ `] `   ^ `	    _ ` 	 ` `7  	 a `	 b `	  c `	  d `$  ,  	    p  `  	  	  	      	 	   	 '	 `  *	  	   	 g   7  	   	 	 	    	 O  	 	 	 	 5 	 	 	 	 	 	 ; 	 1  L 	 	 	 k  	   	 	 	    	 	 e `	   	 	 	 	 L 	 	 	 	 2 /   f `	 2 1 /   q	 & (  h `x  	 7  0 1   ] i `0 1 p  ] g `$     @-       	     @	    a px  b py  j `q	 7  	 q   m `	 l `	 	 	 f pk `e pp `M	 L m	 q `1   0 p  o `Z  	 $     @        	     @ 	  	 	   i px  j py    {  n `	 h pr `s /   	 t `	   s `   	  	 	    	 	    	 	     	 	 	 	 	     	 
  
 r 
 m   m p
 u ` 
 r 
    	  ? 
     g v `	 w ` x `	 y `	 z `	       { `	       | `	  

 	  
 <	       g k  
 	 } `	 	 ~ `     	  	  `	 
   p	  `
 z p `y p `   
 J 
 0 ]    
  
  `| p `	 
    `
  p `~ p `	  `  @  	 	    	 	 $     @-     	      px    {   `L  `	  

  
    ( 
   ` 
 k  
 $  m   
  p p
  `  Z  #
 $
 W I    %
 H    `
  `
  `
  `
  `I  H   ^  /      t   $  '
 7     )
     *
 +
 ,
 -
 /
 0
   p p p p `  @  @
   
 W 
   @
 
 
   @
 
 
   @
 
 q    p  @ p  `s /   *  q   2
 3
 4
   `6
 7
 2
  `4
  ` 9
    `6
 g    `  :
   T	   ;
 <
 *  `   `6
 g $  m   2
  p `@
  `3
  `3
  `5
  ( 1 P  9
   A
  `   @?
 C
 E
 D
 $     @-       F
     /  px   `x  P * (   0 1    `    @?
 C
 E
 D
 7  $     @      {      H
     /  px   `=
 P *  `B
  `I
  `G
  `    K
 :
  a     M
 ]   ;
 4   T	 $  O
 <
 a  
 6
 `   ^  -  V @
    )     @ 	   @7	 6	 q   8	 9	 :	 4
       p p p `s /     Q
 R
 S
 T
   `Q
  `  `R
  `S
  `T
  `\
  `Q
 `  O     `x  0 1   ]  `Q
 `  O  q     * 8 T
 \
 $     @      {      /  px   `x  0 1   ]  `\
 ^
 S
 $     @      {      /  px   `a
 ]
   j
  ` e
    I g
  h
 i
   p  `R
   v  `R
   v  `Z  m
 _
     n
 k
 R
   v  `c
  `l
  `   pR
  p `1
 /    `x    u
 0    `r
 ?
 $     @      {  /   @s
       t
    px   `8
 v
  p
 2  /      x
 y
 {
 |
   @?
 s
 ~
 }
 
 r
   @
 
   @
 
   @
 
 
 
   @
 
 
 
 P
 U
 
 [
   @Y
     
 Z
 
   @ 
 e
 
 n
 
 W
  `{
 /    ` @
 s
  `x  
  . S   P 0 1    `$    @      {  / 
       
    px   ` p `
 2  /      
 
  `s /   
   	    
 
  `$   
 5  ^  * P `
 5  $          `
 5     $  
    `
 $    `
 $   
 
  `
 
 
 1 
  L   $  
   
  ` p `$   Z  + P   
 
  
   
 
 
     
 
 
  `M O 
 N 
 
  R 
   1 
  `
   q      `
  `
 ~  p
  `
   q     R  `
  `
 
 $   
 
 
  `
 E   p ` p `
 5   `
 5  q    `
    
   
 V 
 
 5    `
  `
  `$   
 5  
 
 
  `
  ` ` `
 
  `
  `x  
 
 
 
   
 E   p ` 
   B  
 $      
   @        
    @
     {  /  px   `
 q   
 
  `
 
 
 
 
  `
  p `M 
 N  $  
 
  `
   
 
  `#   `    
 
 
 
 $  
 
 r m    p
 
 
 x  @    y    p
 z { | }   
  
    p `
 /   *    	    
 
  `
  `
  `B  `
 
  `  
 5  q   * 
 
 
 
 
 
 
 
 
 
 
 
  `R
   
  "  
  `   `   `R
 
    p p `R
   
  `B 1    `B 1    `
   #  
 
  `
   
 
  `
 5   `x  
 
 
   P 
      `Z  
 
 $    @      {    B  @
 
 
 
   /     
    px   ` p  `x  O P 
 
      `
 
 	 @   
 
 $   
 @      {    B   /         px   `   `
  p `P 
 
  `
 
 
 P 
  `    `    7  
      M
  
 x   p
   p
  R
  `  `
 2  /    P * 
   `
 2  /    P * 
   `s /   Q    
   	    
 
 	 `
 
 `  `      5  q     
 
  
 #  Q P  `$   q     
 
  `
         `
    `x  
 
 
  P 
       ` 5    `    $     
 
   @      {    B  @
           /  px   `P 
  `  `P   ` R  a                `   @ $  7    O 
 M
 
 x  P    p p p `! /   
 "   # 
   `P *  `P 
  ` =  # P Q $  m   $  p
   p `
  ` `  ` 
  `$  m   $  p `   
 
 #    1   `  2  /       ( & ! `  2  /   P      ( & " `{
 /   # `, $ `, % `) 2  /   ' `-  P  =   
 & ` p) `( `0 /   	  p1 2 + `P * ` 
 $  m   3  p- `   Y , `  p	 0 `/ `$  m   # p. `" p	 2 `
 O 
 1 `% p	 6 3 `3 : 4 `	    6 `B    C 
 5 `   9 3 ; $  m   ) pP  D 7 `   =  3 G H 8 `3 9 `3 K  L : `1 ; `1 < `2 = `2 > `Q @ `
 
 5 =  N I O = ? `3 pA ` 3    
     V M R  X Z     	 ) * $  ]   Q = B `s /   _ C `, D `_ E `_ F ` G `   d e   f g H `   d e   f g , P =  P  I ` ] d K `` $    k b  ]   	 l * i h J `> pM `x    0 1   L `$    @-     {   @p o       q   / @ px  O `` m j h N `B pQ ` R   M O 1 P `e   q   ^  , P$  m   D pT `x   f l q   c e       0 1   U `0 s o a S `$  
   @        k     {   @ 5           G px  H py  R `F pW `c V `J pX ` $   e t f u g  Z d O v    w   
 4          x   F	 r Z `    z m    {   Y ` /   M p \ `	  $  ] `  ^  -  V   $     ~ ` `x  I  H G 0 $    _ `$       @      {   @        S px  ^ ` $  R pa `5    b `  [ `$  	 m   O p} P p Q p     ^   [  
      T px  @     z { | }  
   @      @ J   # &    y     < W    1   U pc `s /   *     d `	 7
  e ` f ` 9
   g ` g       	 h `  ;	          * j `  i `	 g $  m    ] pk ` l ` m ` n ` p `  o ` P  9
   A
 c p#  r ` q `          $    @-         / e px  s `   t `   q   u `P *  x `x  ( P  0 1   v `       w `    ( P *    $    @      {       / j px  z `B
 { `I
 | ` y ` `          	      $    n        Z    <	                   4   ] ;	 )         @ >	    	  @7	 6	 q   8	 9	 :	 %	    @   1      O    M
  4    P *  l pm pn p~ `  $  } `$   m   p p `s /    @  @  @  @  `  `      `      `   `v p `     `   q     `  5    `  `  `$                         { p ` $      ^  ,           `s /    `  `       `    ` $    k    `   #   p `    z m    {   1    "    #    `;	   p `       ;	    )  	 %	 1     @  q    "   7   	    
   1     #   ` /    `   /    `  p `          $         `  pC pD pE pF pG pH p  p)    p,    @  pG    pY    pd    pz     pI  $  p7  p?  pJ  pT  pn  pv  p}  p  p  p  p       ;  @  p  p  p  p`   p  p  @  @ p I  @ J  @% K  @&    )    p   p	 p pq    p - p  . p 0 p 1 p 2 pP 3 p 4 p 5 p 6 p 7 p 8 p  ; p< p = p > p ? p    @A p   M p O p$  4       @P p	 Q p R p  S p# X pY p& Z p' [ p) ] p< ` p3 a p  b p@ e pH f pS g pT h pD i pF j pW k pX l pZ p p_ q pb r pc t pd v pr w ps x pt y pv z pw { px | pz } p  p  p p p p p   p p  p p p p  p p  p  p  p p  p  p[  p  p p  p  p  p  p  p  p  p  p  p  p  p  p p  p p p p  p  p  p   p  p p#   p  p   p  p  p  p 	 p
 p  p  p  p p  p  p  p p  p  p  p  p  p p p	  p p p	 ! p	 " p# p$ p% p& p' p) p%	 * p+ p, p` - p. p'	 / p0 p  1 p2 p3 p*	 4 p.	 5 p=	 6 p?	 7 p8 pJ	 9 pK	 ; pD	 = pB	 ? pi	 @ pF	 B pn	 C pD p E pS	 F p	 G pe H pk	 I p	 J p	 K p	 M p	 Q pR pS p	 T pU p	 V pq	 W p X p& Y p	 Z pM	 [ p	 \ p	 ] p( ^ pL _ p1 ` p	 c pd p	 g p	 k pl pn pm	 o pp pq p
 r p
 s pN	 t pp	 u p
 v p	 w p
 x p	 { p	 } p	  p
  p	 
  p1
  p p5
  p8
  p p p p=
  p?
  p9
  pA
  pB
  pG
  pI
  pP
  p pU
  p pW
  pY
  pZ
  p[
  p]
  p_
  pa
  pc
  pj
  pk
  pl
  pp
  p pq
  p
  p{
  p
  p  p
  p p
  p
  p
  p
  p
  p
  p
  p
  p
  p
  p
  p
  p
  p
  p
  p
  p
  p
  p
  p
  p
  p
  p
  p
  p
  p
  p
  p
  p p
  p
  p
  p
  p
  p
  p
  p
  p p p  p  p p  p p p  p  p  p p  p  p  	 p! 
 p p p p p  p&  p p)  p p*  p-  p p. /  p0  p p
 ! p6 $ p
 & p9 ' p; ( p= * p
 + p, pI - pM . pN / pO 0 p  1 pP 2 pR 4 p^ 5 p6 p7 p` 8 p9 pb : pc ; ph < pi = pj ? pm A pr C pe E pI pK py L p  | N p V pW pX pY pZ p[ p\ p^ p_ p` p a p b p d pf p g p h pi p k po p q pr p s p t p u p w p x p y p z p | p } p~ p p  p  p   p  p p  pX)                                                                                                   
                                           .      
       1              8                       
   >      
       C      
                  G      
 $     Y      
 `  0   d      
 >     d      
 8           ]           _             
      z      
 !      d                                             	                  x      
       y      
                                  "        	   #      Z                         
            
 !  
         
      $      	     %      +           
   	                &           '                                               	   ~              (      D     )      :  
   *      T              G                            {           
 w     +                 
 s                  ,           -                                                 	         
      .           /        
         
            
      0           1                                  \                         
            
      $      ?           
 2     )        O     3      K     4      V              R              =  8            j          
 m          
           
           
      5                
      6        '         
      (     
            
      4            8           9                
      &     
      ,     
      2     
       '     
 $     :     
 )     <     
 +     =     
 -     >     
 /           
 :     :      5     ;                    u     @     
 x     (     
      &     
      B     
      '     
      <           =                         J     
      ;       
      K            ?           @                    1                   N     
      P     
      A        	         
       B           C      +              #                            C     \     
 N     ^     
 S           
 e           
 m     e     
 z           
 u           
            
      E           F                                  8                   k     
      o     
      X     
      G           n     
      )      
      v     
      m     
   	   H           I      "     J        	   K      2              %                2            Q          
 c  
   =      
 m           
 |           
           
      L                
           
           
      M                
   	   N        
   )      
      v     
           
           
           
            
      O                 
           
      P           Q      	                            	              A            B            C            K          
 E     R      O           
 R          
 S          
 D            T           
 V            
   ;   S           T      _            X     V      c  	          l                      
 t            |                             ]                                                                                   d           d           d        	               f           f           0         
   h                       j           N       +            "  	   m      /  	   K       8            Q            D     q      >     r      V            U     t      i            o            u     z       s     x                            
                  |           D         
                                   
           	               p       J	              F	           -	            0	            5	            3	           [	          
 a	          
 l	           f	          
 u	           q	                      	           	           	           	           	           	           	           a
  	         	     O     
 	     ;       
 	     Y     
 	  [   g     
 	           	  
         
 	           	           S
           j
           m
           p
           s
           
  	         
           
          
 
          
 
           
           
          
 
          
 
           
           
           
           
           
          
 
          
 
  	        
 
          
 
           
          
 
           
          
 
                                
           
           
           
           
 2          
            $           )           /           1           V  \        
 E           H           K           N           P           R           T                F     
              (           
                         O     
      .      
                                 
                       ,           3           F           Z           `           n                                                                               	                                 
                                                                                                
           
 ,                K     
 @           E           P  
         I          
            Z          
 b          
 i  
        
 s          
 y          
 }          
                                                       
                      
                          (                                                       
        
                                                  	      F  "   
      3          
 7     	     
 6           >           C           h                      /           $           !     +     
 d              N     :     
 3           5           D  
         7     ;       f     A     
 d           o     B     
 l           v     E     
 u                S     
      T     
      U     
              	                                    c     
      i     
      m     
           
      /      
      g     
      o     
   #        
                                                    q     
           
 $     n       
 3          
 1            C          
 O          
 R          
 S          
 W     A     
 Y           
 \     @     
 l          
 i     !      |          
 r  
   "                
      |       
      e     
           
           
   #        
           
           
           
           
           
           
           
           
           
      #                
 :     h     
 7     $      ?          
 D     j     
 K          
 H     %      Q          
 ]          
 _            
 `           
 c           
 d     l     
 l          
 p  
        
 z  	        
           
      N     
      &        	   O     
      M     
   
   G     
      L     
   	   '           '           '           '           I     
      (                
      P     
      q     
      x      
           
           
 !          
 %          
 '     !      
 )          
 +     s     
 /           
 3     v     
 8     x     
 <           
 @     {     
 D     }     
 O          
 ]          
 [     *      S              K     +      y              g              ]          
 _          
 a          
 W            v          
 r     ,      	                   L          	   m          
   e             h             0           y             2           M             m             B        0     x             e        &  
   5      5  4   u             D        i     e             h        z     b             k             C          #   E          	   9           :           m                  
   	        
      =           >           ?           @           A           B           C           D           E           F           G           H           H                
      I           J           K      '     L      !     M      .          
 )     N      <             G             K             P             R             z             T      /      
 Z   	   g     
 c           
 v      8     
 :           
 5     S      ?          
 E     T      Q     U      \     V        
   W      m          
   "        
   	         
      !     
      #     
      X           Y           Z           x      
   !   \           ]           ]           <     
      ^      7     _            `           x      
 9     b      L     c      P     d      ^     e      `     f      c     g      e     h           i      t     j      g     x      
 n     y      
      m           n           o           p           q           r        :   s           r     
      t           u           v           w        
   x            y           z           x      
   	   |           }                
      ~                   	         #           +          
 .           0           4           8           ?           C          
 I           P           u           _           V  	   x      
 ~  	         x           {                        
        
 h  ]                   
           
            
           
           
           
           
      
     
           
           
           
           
           
           
           
           
           
 9          
                                                                                                                                     *           5           O           
 N     x      
 b     $     
 e     (     
      3     
      6     
                             =     
                             C     
                            F     
           
           
           
 ,           
 8     !     
 D     "     
 P           
 r                `     
      a     
      e     
                 j     
      x      
      y      
   
   p     
            	             3   q     
            O          
 J           U          
 W          
 [          
 i          
 f           n     d     
 o          
           
                                                                                                                                                  #              y      
      x      
                      
                                  	                      2                           x      
 5           =          
 I           L           O           Q           V           X           ]           a           y           f           ~                                
                                                                  
                                                          &                    !  
         +     	     
 9           B           ;           O           W           X           f           g           h                      x                                                                               	   '	     
                                               #                                                                           
 R           :          
 _           V  	         a  
         u           k  
         w             )                                                       	                                                     F             D              x      
      y      
 I     	     
 ^           `           h  4                                                                     	           
                   E                       	                           x      
       y      
 -            9            4            2            ^            D            ;      x      
 ?      y      
 a      	     
 i            e                                                                               !            "            #            $            %            &            '            (            )            *            +            ,            -            .            x      
 !  
   0            1         
   1      ?!     2      !     !
     
 #!          
 !           !           !           !!           W!  
   1
     
 a!     3      e!     4      g!     5      l!     6      p!  
   7      |!     8      z!     9      !     :      !     ;      !     <      !     =      !  
   x      
 !     ?      !  	   x      
 !     A      !  3   B      !     C      !     C      !     C      "  	   P
     
 "     D      "     E      "     F      "     G      "     H      "     I      "     J      %"     K      "     x      
 A"     M      ;"     x      
 V"     O      Q"     P      d"     Q      h"     R      l"     S      }"     T      y"     U      {"     U      "     p
     
 "     V      "     x      
 "  8   X      "     
     
 "     Y      "     Z      "     [      "     x      
 "  	   ]      #  
   
     
 #     ^      #     _      #     `      %#     a      )#     b      ;#     c      /#     d      =#     e      Q#     f      ^#     g      e#     h      c#     i      j#     j      ~#     k      r#     l      p#     m      #     n      #     o      #     p      #     q      #     r      #  
   s      #     t      #     u      #     v      #     w      #  %   x      #  
   x      
 #     z      #  #   {      #     |      #     
     
 #     |      $     
     
 $     ~      $           $           $           $           2$           =$           9$           ;$           D$           H$           L$           P$           V$           [$           $           h$           ^$  
   x      
 $           $           $     x      
 $           $           $           $           $  
         $  
         $          
 $           $           $           %           %           %            %  !         %     x      
 I%           A%           D%           F%           h%  	         
 w%           q%           t%           %           %           %           %           %           %  
         %  	         %           %     )     
 %           %           %           %           %           %     /     
 %           %           %           %           %     4       %           %     6       %           %           %     7       %           %           %           %           &           	&           &           &           &           &           &           &           #&           &  	         %&           =&     ^     
 A&           C&           E&           G&           I&           Q&           ^&           p&           b&           x&           r&     x      
 &           &           &  	         &           &           &           &     x      
 &     y      
 &           &           &           &     y     
 &  	         .'  >            &               '              %'              '              '     x      
 )'          
 ,'              l'          
 t'           x'           z'           '           '           '           '           '           '           '           '           '  	         '          
 '           '     x      
 '           '           '           '            '     x      
  (  \         '           '           '           `(              \(              e(          
 p(           r(           v(           }(           z(           (           (           (           (           (            (           (          
 (           (           (           (           (           (           (  "         (          
 )     	       )     
      )           H      D     D                i     a                     @     @     o               >     >                  S  )  A  )                =  I  )  I                Y    I                                        
    
                 	    	     0            P  T  H  T     i               i  x  i                 
  j  
               o	  	  g	  	               	  
  	  
                >
  b
  6
  b
     W           
    
                  P    H       ,              G    G              _    W       ;           D    D                  6    6                 h    `       D	                       
          3    +                                                               >    >                          &   -              >    >  (                !  H    H  2               b    Y    G             #  &  	#  &  e   	            '#  &  #  &  g                #  &  #  &  n   %             \%  &  S%  &  t               _*  <  W*  <     	           *  w+  *  w+                +  ,  +  ,                 ,  I/  ,  I/                  -  @/  ,  @/     %             .  /  .  /     A            `/  
1  W/  
1                g1  2  L1  2                  1  	2  1  	2     &             J2  2  A2  2     9            2  3  2  3                3  6  
3  6                6  17  6  17                 D7  O8  57  O8  %               7  7  7  7  (  5           8  -:  8  -:  4             8  (:  8  (:  5               :  <  :  <  K              3;  }<  *;  }<  L  K           @  F  
@  F  k  	           @  A  @  A  s              =A  vA  4A  vA  u  9            A  C  A  C  ~              C  D  C  D                eD  dE  \D  dE               D  _E  D  _E                 E  F  E  F                J  T  J  T    
           J  L  uJ  L               M  nN  M  nN                wM  M  nM  M                 /N  eN  &N  eN    4           N  NP  N  NP                iP  R  `P  R               R  S  }R  S               R  S  R  S                 ]T  T  TT  T  (              T  T  T  T  )  +            QX  a  IX  a  D  	           X  X  X  X  K             #Y  $\  Y  $\  S               [  \  [  \  k  8            =\  _  4\  _  s              ]  _  ]  _  y              _  `  _  `               `  `  `  `                 a  a  a  a                a  a  wa  a    ]           e  ~  |e  ~    	           f  Gf  e  Gf               f  ai  f  ai               |i  j  si  j               j  -l  j  -l                k  l  k  l                Cl  m  :l  m                5m  m  -m  m                m  s  m  s                s  vt  s  vt  L              t  yv  t  yv  R              u  v  t  v  X  "             2u  vu  )u  vu  Y  *             u  u  u  u  ]  4            v  hw  v  hw  h              w  w  zw  w  o              w  x  w  x  s             x  y  x  y  z              y  $z  y  $z                =z  z  4z  z                z  {  z  {                {  >{  {  >{                \{  {  S{  {                {  {  {  {                F|  y}  =|  y}               q|  t}  h|  t}                %          	           V    M                 ~    u                    ;    ;                V  y  M  y                                      [    R                     }                  T  a  L  a  3  	             %    %  ;             j  ^  a  ^  C              {    e    X                      i                     j                 ]    ]  x                ^    ^    	           b    Y                 (  9    9                  -    -                R  /  I  /                                                              Z  x  Z                   U    U    L                     	                                f    ]                                                                      %                     2              <    3    4                      B              ^    U    K                     L               5    ,    _                      `  O           Y  e  Q  e    	                                E    <                                          "    "    2              :    :                O    F                                                                        =                                   y    p                                          a    a                  \    \    E                     	           &        #             &        3                      :                N    N  I              e  C  \  C  O              F    =    Z  +           [    R    g               k    k  k               )  ~  )  z                "    "  {  M           @  u  7  u                    |      $             i    i               ~  ^  u  ^               u  +  l  +                A    8                                                                                  2    )                                      w    n                                                                        T                O  
                     Q                ,    ,  R              K  Q  4  Q  T                     X                      `  *             S    S  f             p    g    k                     n              K  Q  :  Q  |                  |    ~                                 D   ;     "               e    e    !              r     &              W   W                   )                                       .            + P"  P"               r" o' \" o'              ' w+ {' w+   7            ) N+ ) N+ 	  0            + 9 + 9 	              9 @ 9 @ j	              @ H @ H 	              I ]J H ]J 	               J _P iJ _P 	             ~P 'V kP 'V 
              Q Q Q Q 
              CR R :R R 
              7U U .U U *
            DV ^b 3V ^b 3
              f\ a_ ]\ a_ W
  9            :` a 1` a g
  9          b t b t z
  "            jo s ao s 
             t { t { 
              :x |z 1x |z 
              ){ { { {              {  {                S V J V /               G  G <              m  S  Z  "            |  | f             X G O G v                    !           t  t                q  h    P             m  m   %              y    (          Z Y = Y   %            |  s    1              m                 j  a  #  $           J  ,  >  &                C                  K                [                  c  4              u  &            n  e  {  :                    !            P  .    *          # <  <   
              l  l   -               r                q  ]               : n :                     )                  )             >  >   &            n ~ n   F              :  : !                 '  6                -                 ;                                                   M  E                                  7  /                
                   f  f              
  
                J  J               	 g  g $              > F 6 F B  #            4  4 g                   y                     -             X 
 P 
   #             K d C d   '              
  
                r E j E               g  ^                                   !    $              C  ;  J                  W                q  q o                D  D |               `  X               4 &, , &,                                                    /  '                                      *  *                p 	 h 	                7  /                 ? ! 7 !                =! # 5! #               1$ ' )$ ' +  !           ' o+ ' o+ N  !             ( ( ( ( P  7            ( ) ( ) X               * + * + h  8             + + + + o               + , + , u             , fq , fq               - - , -   $             ]. . U. .   #          '/ r4 / r4               +3 3 #3 3   !             4 s5 4 s5   (           5 9 5 9              6 6 6 6   !            6 N7 6 N7                 '8 8 8 8   #            8 H9 8 H9                9 9 9 9   F            ': >` : >` 	  %             <C C 4C C >  ,            I 0J I 0J a  -            ]L L UL L n  2            P P P P   -            R ^S R ^S   -            AZ Z 9Z Z   -            w] ] o] ]   -          ]` l U` l                a @b a @b   *             b j b j   -            j 	l j 	l L  ,           {l l sl l Z  %           qm =o im =o d               n In m In k               Wo o Oo o {               o o o o                Mp fp Ep fp                p Wq zp Wq              q  q                Nr Zs Fr Zs                s v s v   '            v | v |   /            T| ?} L| ?}                } ( } (                                 ? E 7 E 5              Y  Y :  )                D              k  c  L              H  @  W               P  P _                 j  /           / < ' < z  *            3  +                6  6               }  u    ;            S  K                 B  B                               2  *    !                                              
    !               6  6 '            5  -  J  !            N   F   _  #                               .  &                                  |               =  5                 y  q                 6   6                 Y Q Q Q                                        '               /  / .  #             K  C  9                  D                C ] ; ] I                   N            '    U                =  = x                                                                      & a  a                 +  +               n  f                >  6                 #  #             K 9 C 9   $             Z  Z                .  .                X 	 X              ~ 5 v 5                6  6             R  J  E              ]  U  U              N  F  b               c  [  k               2 { 2                e  e                                       $             y                 v  v                 :  :              E  E   	                -            < \ 4 \                    4                 k           ?  0               j  j   !           6 Y . Y              , w ,                    D         ;  3               r  j               5 T - T   
           d  \    
                            3  3   :         O  G                }                                      F           S  S   O          d  \               k  k   K           ~  v                E  E   b           [  S             Q  I               2   2    Y             /    /               g    _                  r   r   )                !            $  $   	           5  -              "  "                x              5  -                     h            3 l + l               x                     -              	   	   U            	 	 	 	              	 v
 	 v
   T!            1
 ]
 )
 ]
   !         
 ! 
 !   !           =  5    "            0 R ( R   #          b  Z    #            C  C   ?$           X  P    $                 &%           K  K   q%          f  ^                3  +                                  * : " :    y          P  H                q  q    M           B  B               Y  Q                                        %	                  S	                e          d  \                                   T  T    m         h  `                                 $         s                     n                                   !   !    (           #! J! ! J!    r          ]! ! U! !              ! D" ! D"    1          Y" # Q" #              # $ # $    A          % & % &             %& & & &    t          & & & &                ' ( ' (    f           (( (  ( (    w           ( ) ( )    %         ) - ) -               ) ++ ) ++                B+ + :+ +              + , + ,               *, {, ", {,    y          - d. - d.    #          (. C.  . C.    w            w. U/ o. U/              p/ 0 h/ 0             0 5 0 5               3 :5 3 :5    h"          5 6 5 6    %          *6 6 "6 6    y%          6 .7 6 .7    %          ;7 ~7 37 ~7    &          7 7 7 7    &          7 68 7 68    ,'          E8 < =8 <    '          < @ < @    j+          A `A A `A    Z0          qA A iA A    0          A FB A FB    .1          VB B NB B    1          B D B D    1          !D D D D    p3         D zE D zE    )4           EE \E =E \E    4          E F E F    4          E F E F    85         G I G I    b6         G I G I    6          G 	H G 	H    '7           H OH H OH    j7           `H H XH H    7          H I H I    $8         FI I >I I    8           |I I tI I    8         WJ  NJ  #  
           eJ R [J R #              tJ ,K jJ ,K #  '            6K K ,K K #             K N K N #  {           M M M M $  A          N Q N Q %              2Q wQ )Q wQ &            S rU R rU '              S ZT 	S ZT '              |U U rU U (  2         U !Y U !Y (  q           U !X U !X (             6X Y -X Y )              +Y &` !Y &` *            0` e &` e -             A` a 7` a -           a #c a #c .  Y           b b a b .  h           e %f e %f 0              /f f %f f 0             f i f i 0             y ;z y ;z :            Xz `~ Oz `~ :  8           gz +} ]z +} :  G            ~ ,~ ~ ,~ <               W  W ?              V  V K  (              <  < N             z  q  T  !             (  ( X  '            P q G q ]  %               y  (            :  1    $            +  +   '           T  L    &            #  #   &           K  B    %                  #                   "             |  |               P  P   1             |    1                 1           H r ? r   7             t o k o                                       -              
  
               ! J  J                l  L                                    5 h  h $             . j . (              |  s  2                  5               '  ' :  !            I $ @ $ W             Q O H O c  !             3  3 f              q  h  m                   w  ,                  6            6  -    -            E  E                 M  M   '             y  p    *              p  p   %              <  <   (              {     !            O x F x   6               
  1          .  %    9             '                '    #  0                ,  %                 2               s  s 7  $             )  ) >  /           m ! d ! C  A                E                   O             Y  P  V  5           J k A k f  7                j  7                u  4            A g 8 g y  2                }  6              +  +   6          n  e    @                                    "                                 4  4   :           p  h    9                 :                               ,  $    :             W  O                      4            B g 9 g                      &             > a 5 a   *                   '             ,  ,   *             _  V  !  0           #    (  .           O } F } *               ]  ] 3  "           c  c >  (             `  ` D  %                P                >  > U  *            o 7 f 7 Y  .            e  \  c  +            B  9  k  9                q              U v L v v  -                z  (             <  < ~  ,            h  _    )            	 5   5   7                  !                 0                  0                6           k  b                                 L  C    0             Z  Z   )               }    )                  1             V h M h   +           G  G 	                }  } F  +              S  S J  -               v  N  *             H  ?  R  ,                 V  )                Z  +             D  D _  ,             y   p   d  2             O    F    i  5             $    n  +              y  y s  0              P  P x  3                 }  7               <  <   7             h  _    )                                 I  I   !           j & a &                %	 b	 	 b	   :            	 P
 	 P
   <            
 * 
 *   >                  :            t  k    <            _  _   B            	  	   H           X  O    K            Q  Q   A                 F           D  ;    I                 M                 M                 ?          C  :                  |                  B  B                     #                  !            #  # 3  &           H" " ?" " D  L           " `# " `# H  J           "$ 
* $ 
* R  -           ( ( v( ( f  F           !) x) ) x) j  E           >* / 5* / t  1           . k. 	. k.   F           . / . /   E            / Q2 / Q2   #            x2 m3 o2 m3               3 4 3 4               4 L: 4 L:               : = z: =               P= ? G= ?   #            @ B ? B   '            B G B G             G {_ G {_ 0  !             RH H IH H 7  (             H jI H jI ;              I (K I (K C              XJ  K OJ  K J  "           FK N =K N S               L 
N L 
N Y              (N N N N g             O xP O xP o  +            =O O 4O O p              @P pP 7P pP v  -           P X P X {  #            &S S S S   ,          X hZ X hZ   #            1Y GZ (Y GZ               Z Z Z Z                Z j[ Z j[   '             [ V] [ V]              ] ^ }] ^   -            ^ ^ ] ^   5            ^ ^ ^ ^                 #_ r_ _ r_               _ >` _ >`               ` ` ` `   ,           ` 
a ` 
a   ,            ?a la 6a la   2           a a a a   *           a b a b 	  .           Ib jb @b jb   .            b b b b   -             (c c c c   /           c {d c {d   -           d d d d &  /           e Xf e Xf *  0           f g f g 8  6          g l g l ?  1           h l g l A               /k k &k k U                k l k l X  "           m n m n d  +           n o n o o              uo o lo o u  .           o o o o y  .            p Pp p Pp }  3            p p |p p   2            p Xr p Xr   3          r Lu r Lu   5            r Iu r Iu                Zt 7u Qt 7u              |u v su v   -           qv Sw hv Sw              w w w w   (           /x Yx &x Yx   1            x x {x x   (            x y x y   /           y y y y   2           z Az 	z Az   *            nz z ez z   *            z |{ z |{   *          { ~ { ~   6             E| ~ =| ~              ~ D ~ D   0                  ,             -  - 7  !               B  1                F  B           H  H O  1                 U  ;             D  D [  W             p  p e              9  9 p  +           i  `  t  -                 -            & H  H   -            u  l    *                  #                  "           (                                    < 
 <   -                             f  ]                 <  3                       /             h  h   #                    1                    *               !  !    ,           G  >     #                                   2   #           B  9  6   %                =   %            q  h  C   &                G   '                U   &           C  :  a               I i @ i k   *                o   *                s   /             =  4  w   3                   8            /  &     4             +  +    7            _ Q V Q    1                   7                  .                              )        7                                   )!  9                 +!                }  9!  /            |  | J!  6             K y B y L!                 X!  ,             b  b l!  /                !  /            ,  #  !  0             "  " !  1            P  G  !  +                !  4            :  1  !  6             1  1 !  6          l f d f !  8             b  b !                !  4               !               f t ] t "                  "             7  .  ("                 >"  %                B"  *            9  0  N"  &                "  ,               "  %            - f $ f "  #                "  (            / X & X "  %                "  0                "  +            E z < z "  )                "  (           ) r    r  #  %              <   < %#  (           e  \  -#  &                3#                	  ;#              9  9 A#  %           h 4 _ 4 J#  ,             1  1 L#                   P#  !           e  	 \  	 U#  .             	  	 X#               J  A  b#  "            0  '  g#              E	 	 <	 	 q#  "           	  	  w#  1             ~  ~ #  2            )  ) #  =            `  W  #  4                #  2             C  C #  >              y  #  <             C  C #  =              z  #  =                #  8              H  H #  6              v  #  4               #  <                #               C  :  #  &          W  N  #  =                #                 	$  ?                $               ;  2  $  &              $  :            " u  u $             !  ! '$  9            Z  Q  *$  $                  .$            $! . ! . :$                % * $ * R$             +* |. "* |. s$               Y- w- P- w- $  2             - - - - $  2             - . - . $  2             R. p. I. p. $  3            . / . / $              @0 0 70 0 $  1            0 0 0 0 $  ;           01 1 '1 1 $  7           1 L2 1 L2 $  .           {2 4 r2 4 $  ,          =4 4 44 4 $  2             4 4 4 4 $  *           5 ;5 5 ;5 $  ,            p5 5 g5 5 $  2            5 	6 5 	6 $  3           6 8 6 8 $  9             7 8 7 8 $            9 r; 9 r; $  ,             : h; |: h; $             ; ; ; ; 
%  .           < jB < jB %  ,            A A A A :%  0             	B B  B B ;%  2             RB fB IB fB <%  0            B ZC B ZC ?%              C C C C I%  2           $D QD D QD M%  .           D D }D D Q%  2           D E D E U%  -           GE lE >E lE Y%  /           E E E E ]%  .           E QF E QF a%  ,          F dH yF dH f%  .             G ZH G ZH s%            H BJ H BJ {%  /            I 8J I 8J %            sJ L jJ L %  .             K L K L %             L ;M L ;M %  3            qM M hM M %  3            M O M O %  0           O P O P %  +            P @P P @P %               P P P P %              P Q P Q %  &           Q gS Q gS %  B             R ]S R ]S %             S b] S b] %  5           ] ] {] ] *&               ^ /^ ] /^ /&  1           b^ Aa Y^ Aa 3&  0            ^ >a ^ >a 5&               j_ ,a a_ ,a <&             qa a ha a K&  .           b b a b P&              b )c b )c W&  /            [c c Rc c [&  /           c d c d _&  .           d 5e d 5e e&  1           ie 4f `e 4f j&  1          jf g af g s&  3            f g f g u&              g Pk g Pk &  (           yk l pk l &  &           l m l m &  :           m n m n &  1            n Un n Un &  +            n o n o &  /          p q o q &  0            /p q &p q &              q q q q &               *r mr !r mr &  1            r r r r &  0            s gt r gt &  +            t t t t &  /           t 'u t 'u &  /            Zu jv Qu jv &  0            v v v v '  *             *w +y !w +y 	'  )            `y y Wy y '  2           y  y  '  5            z  z  '             |  |  3'  *            v~ ~ m~ ~ :'  4               n'  (            
    u'  2                '                  '             o  f  '              A b 8 b '  .               '  .             
  
 '  &            3 d * d '  &             <  < '  '           n  e  '  /            %  % '  /                 '                   '              Z  Q  '  2                '  *            ) Z   Z '  *              }  '  )            /  &  '  )                '  '             
  (  /           ?  6  (                   (  "           (  ( !(  -            %  % %(                   4(  "          U  L  E(  *               s  s U(                   `(                  v(  .            -  $  z(  (                (  '            e  e (                  (  3            8  8 (  ,           g 2 ^ 2 (  ,           j  a  (  5               (  +             #  # (  0           U  L  (  /             G  >  (             N  N (  -                 )               	 d   d )                   %)               n  n 2)  !               ;)  0                A)  %            R  I  F)  %               L)  7            / 5 & 5 P)  7            h  _  S)  0           F  F W)  0              0  0 Y)  !            G { G _)  ;            {  r  g)  1            9  0  n)  0           V w M w z)  $                )  >           Q { H { )  >                )  3          @ w 7 w )  <             l t c t )              L  L )                    )  $               )  /            t  k  )  %              )  4                )  !              )  7           !    )              H  ?  )                  )  .            k  T  )                 )  :           T > K > )  3           b  b )  <                )                 	*  1             .  . *  3           g R ^ R *  6               ,*  7           * Q ! Q 0*  ?                4*  5                 9*  5            Y  P  =*  6               J*  7                L*                 a*  /           C  :  *  &             &  & *  @           _  V  *  6               *  5            " I  I *  6            1 { 1 *  8            k  b  *  7                  *  =           @  7  *  =             l  c  *            8  /  *  =            5  ,  *            3  *  *  <             _  V  *             T  K  *  8            4  +  *            -  $  *  ;            Y  P  *               _  V  +                  +             L  L +  =             % I  I +                {   +  5              D+                   F+                  P+                m  m Q+  !                U+  (          B  9  ^+               x  _+  2              v  v f+  "            ^  U  }+  )             	   	  +  4                  +               #  # +  +            [  S  +  5            L  L +  1           w  o  +  (           0  (  +  &          @  8  +  ,                 +  (            @  @ ,  ,            p  h  ,  -                ,  )             A  A ,  .           s 	 j 	 ,  /            1	 r	 (	 r	 ,             
  
  %,  4                6,             > d 5 d =,  '               A,  )                E,  )           A  8  J,  '                 o,            ( V*   V* z,  &            ) ) ) ) -  .            ) * ) * -  0             ?* R* 7* R* -  .            c* + Z* + -  
             * + * + -             ]+ , T+ , -              `, , W, , '-  )           , - , - +-  (            - ?. - ?. 6-  '           u. / l. / =-  3             . / . / ?-              :/ / 1/ / G-  (           / f0 / f0 M-  *           0 1 0 1 S-  (          1 4 1 4 _-  (            y4 4 p4 4 s-              4 6 4 6 y-  #           7 7 7 7 -              =8 \8 48 \8 -  ,            8 8 8 8 -  3           9 9 8 9 -  5            u9 9 m9 9 -             0: )= ': )= -  1             : &= : &= -              W= @ N= @ -  +           @ @ @ @ -             HA ?B ?A ?B -  4             A <B A <B -              kB  D bB  D -  )          53f6VOW      bh6bh8Cb*_   X    O^partitionKey=%28https%2Cros.org%29,:https://answers.ros.org/m/CACHE/js/2ec153a4cd31.js necko:classified 1 strongly-framed 1 security-info FnhllAKWRHGAlo+ESXykKAAAAAAAAAAAwAAAAAAAAEaphjojH6pBabDSgSnsfLHeAAAAAgAAAAAAAAAAAAAAAAAAAAEANwFmCjImkVxP+7sgiYWmMt8FvcOXmlQiTNWFiWlrbpbqgwAAAAAAAAUnMIIFIzCCBAugAwIBAgISBI6s+5L1EFQQyvLGDc31AwsuMA0GCSqGSIb3DQEBCwUAMDIxCzAJBgNVBAYTAlVTMRYwFAYDVQQKEw1MZXQncyBFbmNyeXB0MQswCQYDVQQDEwJSMzAeFw0yMTEyMTYyMTIyNTVaFw0yMjAzMTYyMTIyNTRaMBoxGDAWBgNVBAMTD2Fuc3dlcnMucm9zLm9yZzCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAM7FrxyZq7AXkgANMNO6l4GgUcLefv84WdvjQ8/MVeXwua2+4sii6qJ+v3YrWQpOzf5t0qNaHVzUUYMM+ww/FK5+kcF4L1x3b236oGMi2wR6GGt4ycEp9AQKPnLYZe/db2lYWxAb3QybTXxr6gN+Z6Ju0EPTyq4S6riyhDFun8h5MN8rhIB/9t0c33GcBXKTFvcac68cKvOUlvJaasgrC9EIsxJ8mdwS5S9CAJNhmjn0yGpzTSEsNQZhPbyn3yE/VLbNHCAujqMoBMffDTXFYcjpZLazWogNkAtzUc+pj9W3ZQwqzcJHP3XYigREmv4VTjR84WB6rzHMqFY+YrEr7vUCAwEAAaOCAkkwggJFMA4GA1UdDwEB/wQEAwIFoDAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwDAYDVR0TAQH/BAIwADAdBgNVHQ4EFgQUdwPEwDCC0ecPFTvzCaqm1VuI1/0wHwYDVR0jBBgwFoAUFC6zF7dYVsuuUAlA5h+vnYsUwsYwVQYIKwYBBQUHAQEESTBHMCEGCCsGAQUFBzABhhVodHRwOi8vcjMuby5sZW5jci5vcmcwIgYIKwYBBQUHMAKGFmh0dHA6Ly9yMy5pLmxlbmNyLm9yZy8wGgYDVR0RBBMwEYIPYW5zd2Vycy5yb3Mub3JnMEwGA1UdIARFMEMwCAYGZ4EMAQIBMDcGCysGAQQBgt8TAQEBMCgwJgYIKwYBBQUHAgEWGmh0dHA6Ly9jcHMubGV0c2VuY3J5cHQub3JnMIIBAwYKKwYBBAHWeQIEAgSB9ASB8QDvAHUARqVV63X6kSAwtaKJafTzfREsQXS+/Um4havy/HD+bUcAAAF9xVdXfwAABAMARjBEAiBy1n3HlkEGC9bPRIlCLjrbTVTjmI5A5dKUVStZEdLKnAIgA29SHmOfheQylXNIXHBcFLmkTZv1zk0sjWDH+t95tYwAdgBByMqx3yJGShDGoToJQodeTjGLGwPr60vHaPCQYpYG9gAAAX3FV1klAAAEAwBHMEUCIDOXLS4SZTfBDcZcDiKyns7JVE3HebHi91DljPwHcuChAiEA8jGs6VAyxcDp2DSQS60KWx55RoSfgwydsTDRDDf7ju4wDQYJKoZIhvcNAQELBQADggEBABA7aY74Hub6o4Wttkc8quYL0kfOrWSrf5eIbKTrEhIgHYLO3qHpvEit/29YB8hNlykSYMin3+Zi20zqAmb01v8r7PQd+FeASc2gfSaWPLfuhQhYOHGKRtrbi2XYtR5wfeyN6oHWeCcyso7D2JPMEUvX5bjObm8D2c4Ol3xrrjAEZ/X1H0l/xHYX90CbxlipAWudAGfReZOxeVam0BDfOU28GayUE0tORYnvc7vpMWNaxF3f0k0gGN2VhkUXgmnllVpGFihcdf7iV0msadPP9p5FsN7yoPaSnrg+HVJa/Vg2G+sMLyNxQy8E3+8To4JLcxsnweVxzqF8wKJkE04xJNjALwADAAAAAAEBAAAAAAAABG5vbmUAAAAQUlNBLVBLQ1MxLVNIQTI1NgADZgoyJpFcT/u7IImFpjLfBb3Dl5pUIkzVhYlpa26W6oMAAAAAAAAFJzCCBSMwggQLoAMCAQICEgSOrPuS9RBUEMryxg3N9QMLLjANBgkqhkiG9w0BAQsFADAyMQswCQYDVQQGEwJVUzEWMBQGA1UEChMNTGV0J3MgRW5jcnlwdDELMAkGA1UEAxMCUjMwHhcNMjExMjE2MjEyMjU1WhcNMjIwMzE2MjEyMjU0WjAaMRgwFgYDVQQDEw9hbnN3ZXJzLnJvcy5vcmcwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDOxa8cmauwF5IADTDTupeBoFHC3n7/OFnb40PPzFXl8LmtvuLIouqifr92K1kKTs3+bdKjWh1c1FGDDPsMPxSufpHBeC9cd29t+qBjItsEehhreMnBKfQECj5y2GXv3W9pWFsQG90Mm018a+oDfmeibtBD08quEuq4soQxbp/IeTDfK4SAf/bdHN9xnAVykxb3GnOvHCrzlJbyWmrIKwvRCLMSfJncEuUvQgCTYZo59Mhqc00hLDUGYT28p98hP1S2zRwgLo6jKATH3w01xWHI6WS2s1qIDZALc1HPqY/Vt2UMKs3CRz912IoERJr+FU40fOFgeq8xzKhWPmKxK+71AgMBAAGjggJJMIICRTAOBgNVHQ8BAf8EBAMCBaAwHQYDVR0lBBYwFAYIKwYBBQUHAwEGCCsGAQUFBwMCMAwGA1UdEwEB/wQCMAAwHQYDVR0OBBYEFHcDxMAwgtHnDxU78wmqptVbiNf9MB8GA1UdIwQYMBaAFBQusxe3WFbLrlAJQOYfr52LFMLGMFUGCCsGAQUFBwEBBEkwRzAhBggrBgEFBQcwAYYVaHR0cDovL3IzLm8ubGVuY3Iub3JnMCIGCCsGAQUFBzAChhZodHRwOi8vcjMuaS5sZW5jci5vcmcvMBoGA1UdEQQTMBGCD2Fuc3dlcnMucm9zLm9yZzBMBgNVHSAERTBDMAgGBmeBDAECATA3BgsrBgEEAYLfEwEBATAoMCYGCCsGAQUFBwIBFhpodHRwOi8vY3BzLmxldHNlbmNyeXB0Lm9yZzCCAQMGCisGAQQB1nkCBAIEgfQEgfEA7wB1AEalVet1+pEgMLWiiWn0830RLEF0vv1JuIWr8vxw/m1HAAABfcVXV38AAAQDAEYwRAIgctZ9x5ZBBgvWz0SJQi46201U45iOQOXSlFUrWRHSypwCIANvUh5jn4XkMpVzSFxwXBS5pE2b9c5NLI1gx/rfebWMAHYAQcjKsd8iRkoQxqE6CUKHXk4xixsD6+tLx2jwkGKWBvYAAAF9xVdZJQAABAMARzBFAiAzly0uEmU3wQ3GXA4isp7OyVRNx3mx4vdQ5Yz8B3LgoQIhAPIxrOlQMsXA6dg0kEutClseeUaEn4MMnbEw0Qw3+47uMA0GCSqGSIb3DQEBCwUAA4IBAQAQO2mO+B7m+qOFrbZHPKrmC9JHzq1kq3+XiGyk6xISIB2Czt6h6bxIrf9vWAfITZcpEmDIp9/mYttM6gJm9Nb/K+z0HfhXgEnNoH0mljy37oUIWDhxikba24tl2LUecH3sjeqB1ngnMrKOw9iTzBFL1+W4zm5vA9nODpd8a64wBGf19R9Jf8R2F/dAm8ZYqQFrnQBn0XmTsXlWptAQ3zlNvBmslBNLTkWJ73O76TFjWsRd39JNIBjdlYZFF4Jp5ZVaRhYoXHX+4ldJrGnTz/aeRbDe8qD2kp64Ph1SWv1YNhvrDC8jcUMvBN/vE6OCS3MbJ8Hlcc6hfMCiZBNOMSTYZgoyJpFcT/u7IImFpjLfBb3Dl5pUIkzVhYlpa26W6oMAAAAAAAAFGjCCBRYwggL+oAMCAQICEQCRKwhKzwwYp1P21i4lp19aMA0GCSqGSIb3DQEBCwUAME8xCzAJBgNVBAYTAlVTMSkwJwYDVQQKEyBJbnRlcm5ldCBTZWN1cml0eSBSZXNlYXJjaCBHcm91cDEVMBMGA1UEAxMMSVNSRyBSb290IFgxMB4XDTIwMDkwNDAwMDAwMFoXDTI1MDkxNTE2MDAwMFowMjELMAkGA1UEBhMCVVMxFjAUBgNVBAoTDUxldCdzIEVuY3J5cHQxCzAJBgNVBAMTAlIzMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuwIVKMz2oJTTDxLsjVWSw/iC8ZmmekKIp10mqrUrucVMsa+Oa/l1yKPXD0eUFFU1V4yeqKI5GfWCPEKpTm71O8Mu243AsFzzWTjn7c9p8FoLG77AlCQlh/o3cbMT5xys4Zvv2+Q7RVJFlqnBU840yFLuta7tj95gcOKlVKu2bQ6XpUA0ayvTvGbrZjR8+muLj1cpmfgwF126cm/7gcWt0oZYPRfH5wm78Sv3htzB2nFd1EbjzK0lwYi8YGd1ZrPxGPeiXOZT/zqItkel/xMY6pgJdz+dU/nPAeX1pnAXFK9jpP+Zs5Od3FOnBv5IhR2haa4ldbsTzFID9e1RoYvbFQIDAQABo4IBCDCCAQQwDgYDVR0PAQH/BAQDAgGGMB0GA1UdJQQWMBQGCCsGAQUFBwMCBggrBgEFBQcDATASBgNVHRMBAf8ECDAGAQH/AgEAMB0GA1UdDgQWBBQULrMXt1hWy65QCUDmH6+dixTCxjAfBgNVHSMEGDAWgBR5tFnme7bl5AFzgAiIyBpY9umbbjAyBggrBgEFBQcBAQQmMCQwIgYIKwYBBQUHMAKGFmh0dHA6Ly94MS5pLmxlbmNyLm9yZy8wJwYDVR0fBCAwHjAcoBqgGIYWaHR0cDovL3gxLmMubGVuY3Iub3JnLzAiBgNVHSAEGzAZMAgGBmeBDAECATANBgsrBgEEAYLfEwEBATANBgkqhkiG9w0BAQsFAAOCAgEAhcpORz6j94VEhbzVZ3iymGOtdU0elj0zZXJULYGg6sPt+CC/X8y3cAC3bjv2XpTe5CCfpu+LsgPnorUWPJHOtO05Aud8JYpH5mVuP0b02fDOlCvuVM4SvIwnS7jBmC+ir81xkUoIt8i4I3sELQj5CFc+g9kEMwpHIXgJgifDKsibuc5c8mTIwL55wE+ObUQMXpK7LveLEOHoHUQp21kg7WO5IfgSJpSTV6AdZQTBCiKuEA1Dl6EYH37g4IY3tVqxvTC/h24rKv8hThsFw/UYl/BerMOluGrwLrw7M7nuS97M/OSvhAuGP8BVQzb2aOE2F2qOmdH/pUCnNLfA0GM5NTl1bvK6dsiTAumpS2wXzgwC2b2B+5+3aNQGZbOCPXdT+I55A60KMQd1KkPYVZdyxCkO98RdTsiuRoQw1/KFXxihebvnXnCLB+GGk8O5j9xhcSUqr9/tJVBSaIuS3OXWtePafdCHbIQhMa6C9fu5q8iJFz3hTOU4Dva9K72WgRTr1ds9IKd+WdPi+Fj5W7hIzf5cTxYp/h5VI6/IEbCN6nyTkBcv/ayiCUdGP/DpsLf/KE1oMtZnXh5po5O49Z2LLwvSUkOmbzJXZU0ygd84U4Vdfl1mKeq43eSVtc21VhJCzcROxiU4RFBt7M4AVRj+6Ulk1E7Kl5y0W8BzqKu4R8JmCjImkVxP+7sgiYWmMt8FvcOXmlQiTNWFiWlrbpbqgwAAAAAAAAVvMIIFazCCA1OgAwIBAgIRAIIQz7DSQONZRGPgu2OCiwAwDQYJKoZIhvcNAQELBQAwTzELMAkGA1UEBhMCVVMxKTAnBgNVBAoTIEludGVybmV0IFNlY3VyaXR5IFJlc2VhcmNoIEdyb3VwMRUwEwYDVQQDEwxJU1JHIFJvb3QgWDEwHhcNMTUwNjA0MTEwNDM4WhcNMzUwNjA0MTEwNDM4WjBPMQswCQYDVQQGEwJVUzEpMCcGA1UEChMgSW50ZXJuZXQgU2VjdXJpdHkgUmVzZWFyY2ggR3JvdXAxFTATBgNVBAMTDElTUkcgUm9vdCBYMTCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBAK3oJHP0FDfzm54rVygch77ct984kIxuPOZXoHj3dcKi/vVqbvYATyjb3miGbESTtrFj/RQSa78f0uoxmyF+0TM8ukj13Xnfs7j/EvEhmkvBioZxaUpmZmyPfjxwv60pIgbz5MDmgK7iS4+3mX6UA5/TR5d8mUgjU+g4rk8Kb4Mu0UlXjIB0ttov0DiNewNwIRt18jA8+o+u3dpjq+sWT8KOEUt+zwvo/7V3LvSye0rgTBIlDHCNAymg4VMk7BPZ7hm/ELNKjD+Jo2FR3qyHB5T0Y3HsLuJvW5iB4YlcNHlsdu87kGJ55tukmi8mxdAQ4Q7e2RCOFvu396j3x+UCB5iPNgiV5+I3lg02dZ77DnKxHZu8A/lJBdiB3QW0KtZB6awBdpUKD9jf1b0SHzUvKBds0pjBqAlkd25HN7rOrFleaJ1/ctaJxQZBKT5ZPt0m9STJEadao0xAH0ahmbWnOlFuhjuefXKnEgV4We0+UXgVCwOPjdAvBbI+e0ocS3MFEvzG6uBQE3xDk3SzynTnjh8BCNAw1FtxNrQHusEwMFxIt4I7mKZ9YIqioymCzLq9gwQbooMDQaHWBfEbwrbwqHyGO0aoSCqI3Haadr8faqU9GY/rOPNk3sgrDQoo//fb4hVC1CLQJ13hef4Y53CIrU7m2Ys6xt0nUW7/vGT1M0NPAgMBAAGjQjBAMA4GA1UdDwEB/wQEAwIBBjAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQWBBR5tFnme7bl5AFzgAiIyBpY9umbbjANBgkqhkiG9w0BAQsFAAOCAgEAVR9YqbyyqFDQDLHYGmkgJykIrGF1XIpu+ILlaS/V9lZLubhzEFnTIZd+50xx+7LSYK05qAvqFyFWhfFQDlnrzuBZ6brJFe+GnY+EgPbk6ZGQ3BebYhtF8GaV0nxvwuo77x/Py9auJ/GpsMiu/X1+mvoiBOv/2X/qkSsisRcOj/KKNFtY2PwByVS5uCbMiogziUwthDyC3+6WVwW6LLv3xLfHTjuCvjHIInNzktHCgKQ5ORAzI4JMPJ+GslWYHb4phowim57iaztXOoJwTdwJx4nLCgdNbOhdjsnvzqvHu7UrTkXWStAmzOVyyghqpZXjFaH3pO3JLF+l+/+sKAIuvtd7u+Nxe5AW0wdeRlN8NwdCjNPElpzVmbUq4JUagEiuTDkHzsxHpFKVK7q4+63SM1N95R1NbdWhscdCb+ZAJzVcoyi3B43njTOQ5yOf+1CceWxG1bQVs5ZufpsMljq4Ui0/1lvh+wjChP4kqKOJ2qxq4RgqsahDYVvTH9w7jXbyLeiNdd8XM2w9U/t7y0Ff/9yi0GE44Za4rF2LN9d11TPAmRGunUHBcnWEvgJBQl9nJEiU0Zsnvgc/ubhPgXRR4Xq37Z0j4r7g1SgEEzwxA57demyPxgcYxn/eR44/KJ4EBs+lVDR3veyJm+kXQ99b21/+jh5Xos1AnX5iItreGCcAAAABAAAACGh0dHAvMS4xAQEAAAAAAA== request-method GET response-head HTTP/1.1 200 OK
Server: nginx/1.15.12
Date: Wed, 09 Feb 2022 06:42:40 GMT
Content-Type: application/javascript
Content-Length: 410626
Last-Modified: Mon, 03 Jun 2019 02:27:27 GMT
ETag: "5cf4858f-64402"
Expires: Fri, 11 Mar 2022 06:42:40 GMT
Cache-Control: max-age=2592000
Accept-Ranges: bytes
 original-response-headers Server: nginx/1.15.12
Date: Wed, 09 Feb 2022 06:42:40 GMT
Content-Type: application/javascript
Content-Length: 410626
Last-Modified: Mon, 03 Jun 2019 02:27:27 GMT
Connection: keep-alive
ETag: "5cf4858f-64402"
Expires: Fri, 11 Mar 2022 06:42:40 GMT
Cache-Control: max-age=2592000
Accept-Ranges: bytes
 ctid 2 uncompressed-len 0 net-response-time-onstart 735 net-response-time-onstop 1351 alt-data 1;410626,javascript/moz-bytecode-20220106144528-8l alt-data-from-child 1  